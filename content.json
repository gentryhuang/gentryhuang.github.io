{"meta":{"title":"gentryhuangâ€˜s blog","subtitle":"blog","description":"åšå®¢","author":"gentryhuang","url":"https://gentryhuang.com","root":"/"},"pages":[{"title":"å…³äºæˆ‘","date":"2020-08-09T08:58:11.880Z","updated":"2020-08-09T08:58:11.880Z","comments":false,"path":"about/index.html","permalink":"https://gentryhuang.com/about/index.html","excerpt":"","text":"123456789101112131415161718&#x2F;**** * â”â”“ â”â”“ * â”ƒ â”ƒ + +* â”ƒ â” â”ƒ ++ + + +* â–ˆâ–ˆâ–ˆâ–ˆâ”â–ˆâ–ˆâ–ˆâ–ˆâ”ƒ ğŸš‚ğŸš‚ğŸš‚-&lt;-&lt; æ¬¢è¿è®¿é—®æˆ‘çš„åšå®¢* â”ƒ â”ƒ + * â”ƒ â”» â”ƒ + + * â”ƒ â”ƒ * â”—â”â”“ â”â”â”›Code is far away from bug with the animal protecting * â”ƒ â”ƒ ç¥å…½æŠ¤ä½“ï¼Œæ°¸æ— bug * â”ƒ â”ƒ +* â”ƒ â”—â”â”â”â”“+* â”ƒ â”£â”“ ğŸ“¬ è”ç³»æˆ‘ï¼šgentryhuang.xw@gmail.com* â”ƒ â”â”› + + * â”—â”“â”“â”â”â”³â”“â”â”› +* â”ƒâ”«â”« â”ƒâ”«â”« * â”—â”»â”› â”—â”»â”› *&#x2F;"},{"title":"åˆ†ç±»","date":"2020-07-03T15:03:26.305Z","updated":"2020-07-03T15:03:26.305Z","comments":false,"path":"categories/index.html","permalink":"https://gentryhuang.com/categories/index.html","excerpt":"","text":""},{"title":"å‹æƒ…é“¾æ¥","date":"2020-07-05T10:07:05.047Z","updated":"2020-07-03T15:03:37.362Z","comments":true,"path":"links/index.html","permalink":"https://gentryhuang.com/links/index.html","excerpt":"","text":""},{"title":"é¡¹ç›®","date":"2020-07-06T16:29:08.229Z","updated":"2020-07-06T16:29:08.229Z","comments":false,"path":"repository/index.html","permalink":"https://gentryhuang.com/repository/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2020-07-03T15:03:56.993Z","updated":"2020-07-03T15:03:56.993Z","comments":false,"path":"tags/index.html","permalink":"https://gentryhuang.com/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"RedisåŸç† - é“¾è¡¨","slug":"redis_theory/data_structure/é“¾è¡¨","date":"2020-07-08T11:33:59.000Z","updated":"2020-08-14T08:57:43.413Z","comments":false,"path":"posts/2362a8ea/","link":"","permalink":"https://gentryhuang.com/posts/2362a8ea/","excerpt":"","text":"é“¾è¡¨ redisä¸­çš„é“¾è¡¨ é“¾è¡¨ä½œä¸ºä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œå†…ç½®åœ¨å¾ˆå¤šé«˜çº§ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå› ä¸ºredisä½¿ç”¨cè¯­è¨€å¹¶æ²¡æœ‰å†…ç½®è¿™ä¸­æ•°æ®ç»“æ„ï¼Œæ‰€ä»¥redisæ„å»ºäº†è‡ªå·±çš„é“¾è¡¨å®ç°ã€‚ redisé“¾è¡¨èŠ‚ç‚¹çš„ç»“æ„ 12345678typedef struct listNode&#123; // å‰ç½®èŠ‚ç‚¹ struct listNode *prev; // åç½®èŠ‚ç‚¹ struct listNode *next; // èŠ‚ç‚¹çš„å€¼ (å¯ç”¨äºä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼) void *value&#125;listNode; redisé“¾è¡¨ç»“æ„ 123456789101112131415161718192021typedef struct list &#123; // è¡¨å¤´èŠ‚ç‚¹ listNode *head; // è¡¨å°¾èŠ‚ç‚¹ listNode *tail; // èŠ‚ç‚¹å€¼å¤åˆ¶å‡½æ•°ï¼Œç”¨äºå¤åˆ¶é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼ void *(*dup)(void *ptr); // èŠ‚ç‚¹å€¼é‡Šæ”¾å‡½æ•°ï¼Œç”¨äºé‡Šæ”¾é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼ void (*free)(void *ptr); // èŠ‚ç‚¹å€¼å¯¹æ¯”å‡½æ•°ï¼Œç”¨äºå¯¹æ¯”é“¾è¡¨èŠ‚ç‚¹æ‰€ä¿å­˜çš„å€¼å’Œå…¶ä»–å€¼æ˜¯å¦ç›¸ç­‰ int (*match)(void *ptr, void *key); // é“¾è¡¨æ‰€åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ unsigned long len;&#125; list; redisé“¾è¡¨çš„ç‰¹ç‚¹ 12345- åŒç«¯ï¼šé“¾è¡¨èŠ‚ç‚¹å¸¦æœ‰prevå’ŒnextæŒ‡é’ˆï¼Œè·å–æŸä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹å’Œåç½®èŠ‚ç‚¹çš„å¤æ‚åº¦éƒ½æ˜¯O(1)- æ— ç¯ï¼šè¡¨å¤´èŠ‚ç‚¹çš„prevæŒ‡é’ˆå’Œè¡¨å°¾èŠ‚ç‚¹çš„nextæŒ‡é’ˆéƒ½æŒ‡å‘NULLï¼Œå¯¹é“¾è¡¨çš„è®¿é—®ä»¥NULLä¸ºç»ˆç‚¹- å¸¦è¡¨å¤´å’Œè¡¨å°¾æŒ‡é’ˆï¼šä½¿ç”¨listç»“æ„çš„headæŒ‡é’ˆå’ŒtailæŒ‡é’ˆï¼Œç¨‹åºè·å–é“¾è¡¨çš„è¡¨å¤´èŠ‚ç‚¹å’Œè¡¨å°¾èŠ‚ç‚¹çš„å¤æ‚åº¦ä¸ºO(1)- å¸¦é“¾è¡¨é•¿åº¦è®¡æ•°å™¨ï¼šç¨‹åºä½¿ç”¨listç»“æ„çš„lenå±æ€§æ ‡è®°é“¾è¡¨ä¸­èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œç¨‹åºè·å–é“¾è¡¨ä¸­èŠ‚ç‚¹ä¸ªæ•°çš„å¤æ‚åº¦ä¸ºO(1)- å¤šæ€ï¼šé“¾è¡¨å¯ä»¥ä¿å­˜å„ç§ä¸åŒç±»å‹çš„å€¼ é“¾è¡¨åœ¨redisä¸­çš„åº”ç”¨ é“¾è¡¨è¢«å¹¿æ³›ç”¨äºå®ç°redisçš„å„ç§åŠŸèƒ½ï¼Œå¦‚ï¼šåˆ—è¡¨é”®ã€å‘å¸ƒä¸è®¢é˜…ã€æ…¢æŸ¥è¯¢ã€ç›‘è§†å™¨ï¼ŒredisæœåŠ¡å™¨æœ¬èº«è¿˜ä½¿ç”¨é“¾è¡¨æ¥ä¿å­˜å¤šä¸ªå®¢æˆ·ç«¯çš„çŠ¶æ€ä¿¡æ¯ï¼Œä»¥åŠä½¿ç”¨é“¾è¡¨æ¥æ„å»ºå®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"https://gentryhuang.com/categories/Redis/"}],"tags":[{"name":"Redisæ•°æ®ç»“æ„","slug":"Redisæ•°æ®ç»“æ„","permalink":"https://gentryhuang.com/tags/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}]},{"title":"RedisåŸç† - ç®€å•åŠ¨æ€å­—ç¬¦ä¸²","slug":"redis_theory/data_structure/ç®€å•åŠ¨æ€å­—ç¬¦ä¸²","date":"2020-07-08T11:00:50.000Z","updated":"2020-08-14T08:57:43.411Z","comments":false,"path":"posts/aa1d8127/","link":"","permalink":"https://gentryhuang.com/posts/aa1d8127/","excerpt":"","text":"ç®€å•åŠ¨æ€å­—ç¬¦ä¸² åˆè¯†åŠ¨æ€å­—ç¬¦ä¸² redisæ²¡æœ‰ç›´æ¥ä½¿ç”¨Cè¯­è¨€ä¼ ç»Ÿçš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼ˆä»¥ç©ºå­—ç¬¦ç»“å°¾çš„å­—ç¬¦æ•°ç»„ï¼‰ï¼Œè€Œæ˜¯è‡ªå·±æ„å»ºäº†ä¸€ç§åä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆsimple dynamic stringï¼ŒSDSï¼‰çš„æŠ½è±¡ç±»å‹ï¼Œå¹¶å°†SDSä½œä¸ºredisçš„é»˜è®¤å­—ç¬¦ä¸²è¡¨ç¤ºã€‚ åœ¨redisä¸­ï¼Œcå­—ç¬¦ä¸²åªä¼šä½œä¸ºå­—ç¬¦ä¸²å­—é¢é‡ç”¨åœ¨ä¸€äº›æ— é¡»å¯¹å­—ç¬¦ä¸²å€¼è¿›è¡Œä¿®æ”¹çš„åœ°æ–¹ï¼Œæ¯”å¦‚æ—¥å¿—ã€‚å½“Rediséœ€è¦çš„ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡ï¼Œè€Œæ˜¯ä¸€ä¸ªå¯ä»¥è¢«ä¿®æ”¹çš„å­—ç¬¦ä¸²å€¼æ—¶ï¼Œrediså°±ä¼šä½¿ç”¨SDSæ¥è¡¨ç¤ºå­—ç¬¦ä¸²å€¼ã€‚ å€¼çš„æ³¨æ„çš„æ˜¯ï¼Œå¯¹äºredisä¸­çš„keyéƒ½æ˜¯ä½¿ç”¨SDSæ¥å®ç°çš„ã€‚æ­¤å¤–ï¼ŒSDSé™¤äº†ç”¨æ¥ä¿å­˜Redisæ•°æ®åº“ä¸­çš„å­—ç¬¦ä¸²å€¼ä¹‹å¤–ï¼ŒSDSè¿˜è¢«ç”¨ä½œç¼“å†²åŒºï¼ˆbufferï¼‰: AOFæ¨¡å—ä¸­çš„AOFç¼“å†²åŒºï¼Œä»¥åŠå®¢æˆ·ç«¯çŠ¶æ€ä¸­çš„è¾“å…¥ç¼“å†²åŒºã€‚ sdsçš„ç»“æ„ 12345678struct sdshdr&#123; // è®°å½•bufæ•°ç»„ä¸­å·²ä½¿ç”¨å­—èŠ‚çš„æ•°é‡ç­‰ä»·äºsdsæ‰€ä¿å­˜å­—ç¬¦ä¸²çš„é•¿åº¦ int len; // è®°å½•bufæ•°ç»„ä¸­æœªä½¿ç”¨å­—èŠ‚çš„æ•°é‡ int free; // å­—èŠ‚æ•°ç»„ï¼Œç”¨äºä¿å­˜å­—ç¬¦ä¸² char buf[];&#125; æ³¨æ„ï¼š sdséµå¾ªcå­—ç¬¦ä¸²ä»¥ç©ºå­—ç¬¦ç»“å°¾çš„æƒ¯ä¾‹ï¼Œä¿å­˜ç©ºå­—ç¬¦çš„1å­—èŠ‚ç©ºé—´ä¸è®¡ç®—åœ¨sdsçš„lenå±æ€§ä¸­ï¼Œå¹¶ä¸”ä¸ºç©ºå­—ç¬¦åˆ†é…é¢å¤–çš„1å­—èŠ‚ç©ºé—´ï¼Œä»¥åŠæ·»åŠ ç©ºå­—ç¬¦åˆ°å­—ç¬¦ä¸²æœ«å°¾ç­‰æ“ä½œï¼Œéƒ½æ˜¯ç”±sdså‡½æ•°è‡ªåŠ¨å®Œæˆçš„ã€‚éµå¾ªç©ºå­—ç¬¦ç»“å°¾çš„å¥½å¤„æ˜¯ï¼Œsdså¯ä»¥ç›´æ¥ä½¿ç”¨ä¸€éƒ¨åˆ†Cå­—ç¬¦ä¸²å‡½æ•°åº“é‡Œé¢çš„å‡½æ•°ã€‚ sdsä¸cå­—ç¬¦ä¸²çš„åŒºåˆ« cè¯­è¨€ä½¿ç”¨çš„ç®€å•å­—ç¬¦ä¸²è¡¨ç¤ºæ–¹å¼ï¼Œå¹¶ä¸èƒ½æ»¡è¶³rediså¯¹å­—ç¬¦ä¸²åœ¨å®‰å…¨æ€§ã€æ•ˆç‡ä»¥åŠåŠŸèƒ½æ–¹é¢çš„è¦æ±‚ã€‚ 3.1 å¸¸æ•°å¤æ‚åº¦è·å–å­—ç¬¦ä¸²é•¿åº¦ å› ä¸ºcå­—ç¬¦ä¸²å¹¶ä¸è®°å½•è‡ªèº«çš„é•¿åº¦ä¿¡æ¯ï¼Œæ‰€ä»¥è¦è·å–é•¿åº¦å°±å¿…é¡»éå†æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œæ•…è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦ä¸ºO(N)ã€‚è€Œredisçš„sdsç»“æ„ä¸­é€šè¿‡lenå±æ€§è®°å½•äº†sdsçš„é•¿åº¦ï¼Œæ•…è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦ä¸ºO(1)ã€‚æ³¨æ„ï¼Œè®¾ç½®å’Œæ›´æ–°sdsé•¿åº¦çš„å·¥ä½œæ˜¯ç”±sdsçš„APIåœ¨æ‰§è¡Œæ—¶è‡ªåŠ¨å®Œæˆçš„ï¼Œä½¿ç”¨sdsæ— é¡»è¿›è¡Œä»»ä½•æ‰‹åŠ¨ä¿®æ”¹é•¿åº¦çš„æ“ä½œã€‚ 3.2 é¿å…ç¼“å†²åŒºæº¢å‡º cå­—ç¬¦ä¸²ä¸è®°å½•è‡ªèº«é•¿åº¦ï¼Œå¾ˆå®¹æ˜“é€ æˆç¼“å†²åŒºæº¢å‡ºã€‚ä¸cå­—ç¬¦ä¸²ä¸åŒï¼Œsdsçš„ç©ºé—´åˆ†é…ç­–ç•¥å®Œå…¨æœç»äº†å‘ç”Ÿç¼“å†²åŒºæº¢å‡ºçš„å¯èƒ½æ€§ï¼Œå½“sds apiéœ€è¦å¯¹sdsè¿›è¡Œä¿®æ”¹æ—¶ï¼Œapiä¼šå…ˆæ£€æŸ¥sdsçš„ç©ºé—´æ˜¯å¦æ»¡è¶³éœ€è¦ï¼Œå¦‚æœä¸æ»¡è¶³çš„è¯ï¼Œapiä¼šè‡ªåŠ¨å°†sdsçš„ç©ºé—´æ‰©å±•è‡³æ‰§è¡Œæ‰€éœ€çš„å¤§å°ï¼Œç„¶åæ‰æ‰§è¡Œå®é™…çš„ä¿®æ”¹æ“ä½œï¼Œå› æ­¤ä½¿ç”¨sdsæ—¢ä¸éœ€è¦æ‰‹åŠ¨ä¿®æ”¹sdsçš„ç©ºé—´å¤§å°ï¼Œä¹Ÿä¸ä¼šå‡ºç°cå­—ç¬¦ä¸²ä¸­å¯èƒ½å‡ºç°çš„ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ã€‚ 1234567891011121314151617sds sdscatlen(sds s, const void *t, size_t len) &#123; size_t curlen = sdslen(s); //è¿½åŠ æ—¶å…ˆè¿›è¡Œæ‰©å®¹ï¼Œåé¢è¯¦ç»†è¯´æ˜ s = sdsMakeRoomFor(s,len); if (s == NULL) return NULL; //æ‹¼æ¥å­—ç¬¦ä¸² memcpy(s+curlen, t, len); sdssetlen(s, curlen+len); s[curlen+len] = '\\0'; return s;&#125;// s:åŸæ•°ç»„ //strlen(t) éœ€æ‹¼æ¥çš„ç›®æ ‡æ•°ç»„çš„é•¿åº¦sds sdscat(sds s, const char *t) &#123; return sdscatlen(s, t, strlen(t));&#125;â€‹ 3.3 å†…å­˜åˆ†é…ä¸é‡Šæ”¾ å› ä¸ºcå­—ç¬¦ä¸²çš„é•¿åº¦å’Œåº•å±‚æ•°ç»„çš„é•¿åº¦ä¹‹é—´å­˜åœ¨ç€å…³è”æ€§ï¼Œæ‰€ä»¥æ¯æ¬¡å¢åŠ æˆ–è€…ç¼©çŸ­ä¸€ä¸ªcå­—ç¬¦ä¸²ï¼Œç¨‹åºéƒ½æ€»è¦å¯¹ä¿å­˜è¿™ä¸ªcå­—ç¬¦ä¸²çš„æ•°å­—è¿›è¡Œä¸€æ¬¡åˆ†é…æ“ä½œï¼Œä½†æ˜¯å†…å­˜åˆ†é…æ“ä½œæ¶‰åŠåˆ°å¤æ‚çš„ç®—æ³•ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œæ‰€ä»¥é€šå¸¸æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—æ—¶çš„æ“ä½œã€‚redisä½œä¸ºæ•°æ®åº“ï¼Œç»å¸¸è¢«ç”¨äºé€Ÿåº¦è¦æ±‚ä¸¥è‹›ã€æ•°æ®è¢«é¢‘ç¹ä¿®æ”¹çš„åœºåˆï¼Œä¸ºäº†é¿å…cå­—ç¬¦ä¸²çš„è¿™ç§ç¼ºé™·ï¼Œsdsé€šè¿‡æœªä½¿ç”¨ç©ºé—´è§£é™¤äº†å­—ç¬¦ä¸²é•¿åº¦å’Œåº•å±‚æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³è”ï¼Œé€šè¿‡æœªä½¿ç”¨ç©ºé—´ï¼Œsdså®ç°äº†ç©ºé—´é¢„åˆ†é…å’Œæƒ°æ€§ç©ºé—´é‡Šæ”¾ä¸¤ç§ä¼˜åŒ–ç­–ç•¥ã€‚ ç©ºé—´é¢„åˆ†é… ç©ºé—´é¢„åˆ†é…ç”¨äºä¼˜åŒ–sdsçš„å­—ç¬¦ä¸²å¢é•¿æ“ä½œï¼šå½“sdsçš„apiå¯¹ä¸€ä¸ªsdsè¿›è¡Œä¿®æ”¹ï¼Œå¹¶ä¸”éœ€è¦å¯¹sdsè¿›è¡Œç©ºé—´æ‰©å±•çš„æ—¶å€™ï¼Œç¨‹åºä¸ä»…ä¼šä¸ºsdsåˆ†é…ä¿®æ”¹æ‰€å¿…é¡»è¦çš„ç©ºé—´ï¼Œè¿˜ä¼šä¸ºsdsåˆ†é…é¢å¤–çš„æœªä½¿ç”¨ç©ºé—´ã€‚é€šè¿‡ç©ºé—´é¢„åˆ†é…ç­–ç•¥ï¼Œrediså¯ä»¥å‡å°‘è¿ç»­æ‰§è¡Œå­—ç¬¦ä¸²å¢é•¿æ“ä½œæ‰€éœ€çš„å†…å­˜é‡æ–°åˆ†é…æ¬¡æ•°ï¼Œåœ¨æ‰©å±•sdsç©ºé—´ä¹‹å‰ï¼Œsds api ä¼šå…ˆæ£€æŸ¥æœªä½¿ç”¨ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼Œå¦‚æœè¶³å¤Ÿå°±ç›´æ¥ä½¿ç”¨æœªä½¿ç”¨ç©ºé—´ï¼Œè€Œä¸éœ€è¦æ‰§è¡Œå†…å­˜é‡æ–°åˆ†é…ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152// redis æ‰©å®¹æºç /* * å¯¹ sds ä¸­ buf çš„é•¿åº¦è¿›è¡Œæ‰©å±•ï¼Œç¡®ä¿åœ¨å‡½æ•°æ‰§è¡Œä¹‹åï¼Œ * buf è‡³å°‘ä¼šæœ‰ addlen + 1 é•¿åº¦çš„ç©ºä½™ç©ºé—´ * ï¼ˆé¢å¤–çš„ 1 å­—èŠ‚æ˜¯ä¸º \\0 å‡†å¤‡çš„ï¼‰ * * è¿”å›å€¼ * sds ï¼šæ‰©å±•æˆåŠŸè¿”å›æ‰©å±•åçš„ sds * æ‰©å±•å¤±è´¥è¿”å› NULL * * å¤æ‚åº¦ * T = O(N) */sds sdsMakeRoomFor(sds s, size_t addlen) &#123; struct sdshdr *sh, *newsh; // è·å– s ç›®å‰çš„ç©ºä½™ç©ºé—´é•¿åº¦ size_t free = sdsavail(s); size_t len, newlen; // s ç›®å‰çš„ç©ºä½™ç©ºé—´å·²ç»è¶³å¤Ÿï¼Œæ— é¡»å†è¿›è¡Œæ‰©å±•ï¼Œç›´æ¥è¿”å› if (free &gt;= addlen) return s; // è·å– s ç›®å‰å·²å ç”¨ç©ºé—´çš„é•¿åº¦ len = sdslen(s); sh = (void*) (s-(sizeof(struct sdshdr))); // s æœ€å°‘éœ€è¦çš„é•¿åº¦ newlen = (len+addlen); // æ ¹æ®æ–°é•¿åº¦ï¼Œä¸º s åˆ†é…æ–°ç©ºé—´æ‰€éœ€çš„å¤§å° if (newlen &lt; SDS_MAX_PREALLOC) // å¦‚æœæ–°é•¿åº¦å°äº SDS_MAX_PREALLOC // é‚£ä¹ˆä¸ºå®ƒåˆ†é…ä¸¤å€äºæ‰€éœ€é•¿åº¦çš„ç©ºé—´ newlen *= 2; else // å¦åˆ™ï¼Œåˆ†é…é•¿åº¦ä¸ºç›®å‰é•¿åº¦åŠ ä¸Š SDS_MAX_PREALLOC newlen += SDS_MAX_PREALLOC; // T = O(N) newsh = zrealloc(sh, sizeof(struct sdshdr)+newlen+1); // å†…å­˜ä¸è¶³ï¼Œåˆ†é…å¤±è´¥ï¼Œè¿”å› if (newsh == NULL) return NULL; // æ›´æ–° sds çš„ç©ºä½™é•¿åº¦ newsh-&gt;free = newlen - len; // è¿”å› sds return newsh-&gt;buf;&#125; é¢å¤–åˆ†é…æœªä½¿ç”¨ç©ºé—´æ•°é‡çš„è®¡ç®—ç­–ç•¥ï¼š å¯¹sdsä¿®æ”¹åï¼Œsdsçš„é•¿åº¦ï¼ˆå³lenå±æ€§çš„å€¼ï¼‰å°äº1MBï¼Œé‚£ä¹ˆç¨‹åºåˆ†é…å’Œlenå±æ€§åŒæ ·å¤§å°çš„æœªä½¿ç”¨ç©ºé—´ï¼Œè¿™æ—¶sdsçš„lenå±æ€§çš„å€¼å°†å’Œfreeå±æ€§çš„å€¼ç›¸åŒã€‚ä¾‹å¦‚ï¼šä¿®æ”¹åsdsçš„lenå˜æˆ10å­—èŠ‚ï¼Œé‚£ä¹ˆç¨‹åºä¹Ÿä¼šåˆ†é…10å­—èŠ‚çš„æœªä½¿ç”¨ç©ºé—´ï¼Œsdsçš„bufæ•°ç»„çš„å®é™…é•¿åº¦ï¼š10 + 10 + 1 = 21å­—èŠ‚ å¯¹sdsä¿®æ”¹åï¼Œsdsçš„é•¿åº¦å¤§äºç­‰äº1MBï¼Œé‚£ä¹ˆç¨‹åºä¼šåˆ†é…1MBçš„æœªä½¿ç”¨ç©ºé—´ã€‚ä¾‹å¦‚ï¼šä¿®æ”¹åsdsçš„lenå˜æˆ30MBï¼Œé‚£ä¹ˆç¨‹åºä¼šåˆ†é…1MBçš„æœªä½¿ç”¨ç©ºé—´ï¼Œsdsçš„bufæ•°ç»„çš„æ—¶é—´é•¿åº¦ï¼š30MB + 1MB + 1byte æƒ°æ€§ç©ºé—´é‡Šæ”¾ æƒ°æ€§ç©ºé—´é‡Šæ”¾ç”¨äºä¼˜åŒ–sdsçš„å­—ç¬¦ä¸²ç¼©çŸ­æ“ä½œï¼šå½“sdsçš„apiéœ€è¦ç¼©çŸ­sdsä¿å­˜çš„å­—ç¬¦ä¸²æ—¶ï¼Œç¨‹åºå¹¶ä¸ç«‹å³ä½¿ç”¨å†…å­˜é‡åˆ†é…æ¥å›æ”¶ç¼©çŸ­åå¤šæ¥çš„å­—èŠ‚ï¼Œè€Œæ˜¯ä½¿ç”¨freeå±æ€§å°†è¿™äº›å­—èŠ‚çš„æ•°é‡çºªå½•èµ·æ¥ï¼Œç”¨äºå°†æ¥å¯¹sdsè¿›è¡Œå¢é•¿æ“ä½œæ—¶ï¼Œè¿™äº›æœªä½¿ç”¨ç©ºé—´å¯èƒ½å°±æ´¾ä¸Šç”¨åœºäº†ã€‚æ³¨æ„ï¼Œsdsä¹Ÿæä¾›äº†ç›¸åº”çš„apiï¼Œå¯ä»¥çœŸæ­£åœ°é‡Šæ”¾sdsçš„æœªä½¿ç”¨ç©ºé—´ï¼Œæ‰€ä»¥ä¸ç”¨æ‹…å¿ƒæƒ°æ€§ç©ºé—´é‡Šæ”¾ç­–ç•¥ä¼šé€ æˆå†…å­˜æµªè´¹ã€‚ 3.4 äºŒè¿›åˆ¶å®‰å…¨ cå­—ç¬¦ä¸²ä¸­çš„å­—ç¬¦å¿…é¡»ç¬¦åˆæŸç§ç¼–ç ï¼Œå¹¶ä¸”é™¤äº†å­—ç¬¦ä¸²çš„æœ«å°¾ä¹‹å¤–ï¼Œå­—ç¬¦ä¸²é‡Œä¸èƒ½åŒ…å«ç©ºå­—ç¬¦ï¼Œå¦åˆ™åœ¨è¯»å–çš„æ—¶å€™ä¼šè¢«é»˜è®¤ä¸ºç»“æŸå­—ç¬¦ï¼Œè¿™äº›é™åˆ¶ä½¿å¾—cå­—ç¬¦ä¸²åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œä¸èƒ½ä¿å­˜å›¾ç‰‡ã€éŸ³è§†é¢‘ã€å‹ç¼©æ–‡ä»¶è¿™ç±»çš„äºŒè¿›åˆ¶æ•°æ®ã€‚sdsçš„apiéƒ½æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œæ‰€æœ‰çš„sds apiéƒ½ä¼šä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å¤„ç†sdså­˜æ”¾åœ¨bufæ•°ç»„é‡Œçš„æ•°æ®,ç¨‹åºä¸ä¼šå¯¹å…¶ä¸­çš„æ•°æ®åšä»»ä½•é™åˆ¶ã€è¿‡æ»¤ï¼Œæ•°æ®å†™å…¥æ—¶æ˜¯ä»€ä¹ˆæ ·ï¼Œå®ƒè¢«è¯»å–æ—¶å°±æ˜¯ä»€ä¹ˆæ ·ã€‚è¿™ä¹Ÿæ˜¯å°†sdsçš„bufå±æ€§ç§°ä¸ºå­—èŠ‚æ•°ç»„çš„åŸå› ï¼Œredisä¸æ˜¯ç”¨è¿™ä¸ªæ•°ç»„æ¥ä¿å­˜å­—ç¬¦ï¼Œè€Œæ˜¯ç”¨å®ƒæ¥ä¿å­˜ä¸€ç³»åˆ—äºŒè¿›åˆ¶æ•°æ®ã€‚ cå­—ç¬¦ä¸²å’Œsdsä¹‹é—´çš„åŒºåˆ« 123456 Cå­—ç¬¦ä¸² SDS- è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦ä¸ºOï¼ˆnï¼‰ è·å–å­—ç¬¦ä¸²é•¿åº¦çš„å¤æ‚åº¦Oï¼ˆ1ï¼‰- APIæ˜¯ä¸å®‰å…¨çš„ï¼Œå¯èƒ½é€ æˆç¼“å†²åŒºæº¢å‡º APIæ˜¯å®‰å…¨çš„- ä¿®æ”¹å­—ç¬¦ä¸²é•¿åº¦Næ¬¡ï¼Œå¿…ç„¶è¦æ‰§è¡ŒNæ¬¡å†…å­˜é‡åˆ†é… ä¿®æ”¹å­—ç¬¦é•¿åº¦Næ¬¡ï¼Œæœ€å¤šæ‰§è¡ŒNæ¬¡å†…å­˜é‡åˆ†é…- åªèƒ½ä¿å­˜æ–‡æœ¬æ•°æ® å¯ä»¥ä¿å­˜æ–‡æœ¬æˆ–è€…äºŒè¿›åˆ¶æ•°æ®- å¯ä½¿ç”¨&lt;string.h&gt;åº“ä¸­çš„å‡½æ•° å¯ä½¿ç”¨ä¸€éƒ¨åˆ†&lt;string.h&gt;åº“ä¸­çš„å‡½æ•° sdsæ›´å¤šçš„apiå¯å‚è€ƒæºç ","categories":[{"name":"Redis","slug":"Redis","permalink":"https://gentryhuang.com/categories/Redis/"}],"tags":[{"name":"Redisæ•°æ®ç»“æ„","slug":"Redisæ•°æ®ç»“æ„","permalink":"https://gentryhuang.com/tags/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"}]},{"title":"Dubboæºç åˆ†æ - ä¼˜é›…åœæœº","slug":"rpc/ä¼˜é›…åœæœº","date":"2020-05-09T16:00:00.000Z","updated":"2020-09-03T01:23:40.728Z","comments":false,"path":"posts/ef4cfe7a/","link":"","permalink":"https://gentryhuang.com/posts/ef4cfe7a/","excerpt":"","text":"æ¦‚è¿°ä¼˜é›…åœæœºä»…å­˜åœ¨äºæœåŠ¡é‡å¯ã€ä¸‹çº¿è¿™æ ·çš„éƒ¨ç½²é˜¶æ®µï¼Œä¼˜é›…åœæœºæ˜¯ä¸€ä¸ªåº”ç”¨ç”Ÿå‘½å‘¨æœŸçš„ä¸€éƒ¨åˆ†ï¼Œå®ƒä¿éšœäº†åº”ç”¨çš„å¥å£®æ€§ã€‚dubboæ˜¯é€šè¿‡jdkçš„ShutdownHookæ¥å®Œæˆä¼˜é›…åœæœºçš„ï¼Œæ‰€ä»¥å¦‚æœç”¨æˆ·ä½¿ç”¨ kill -9 pid ç­‰å¼ºåˆ¶å…³é—­æŒ‡ä»¤ï¼Œæ˜¯ä¸ä¼šæ‰§è¡Œä¼˜é›…åœæœºçš„ï¼Œåªæœ‰é€šè¿‡ kill pid å³æ­£å¸¸é€€å‡ºè¿›ç¨‹ï¼Œæ‰ä¼šæ‰§è¡Œã€‚ åŸºæœ¬è¦æ±‚ ä¼˜é›…åœæœºçš„æœåŠ¡ç«¯æœ‰æ­£åœ¨å¤„ç†ä¸­çš„è¯·æ±‚ï¼Œä¸èƒ½è¢«åœæœºæŒ‡ä»¤ä¸­æ–­ï¼Œé™¤éè¶…æ—¶ ä¼˜é›…åœæœºçš„æ¶ˆè´¹ç«¯ä¸åº”è¯¥å†å‘èµ·æ–°çš„è¯·æ±‚ æ¶ˆè´¹ç«¯ä¸åº”è¯¥è¯·æ±‚å·²ç»ä¸‹çº¿çš„æœåŠ¡æä¾›è€… æ„ä¹‰åº”ç”¨çš„é‡æ–°å¯åŠ¨ã€åœæœºç­‰æ“ä½œï¼Œé¿å…äº†å¯¹ä¸šåŠ¡çš„è¿ç»­æ€§é€ æˆå½±å“ï¼Œå¦‚ï¼šé›†ç¾¤ä¸­çš„æŸä¸ªåº”ç”¨å­˜åœ¨é€»è¾‘ä¸Šçš„bugï¼Œéœ€è¦ä¿®æ”¹ç¨‹åºï¼Œè¿™æ—¶å€™å°±å¯ä»¥ä½¿ç”¨ä¼˜é›…åœæœºå¹³æ»‘ä¸‹çº¿ï¼Œä¸ä¼šé€ æˆè°ƒç”¨æ–¹å¼‚å¸¸é—®é¢˜ã€‚ åŸç† dubboä¸­å®ç°ä¼˜é›…åœæœºä¸»è¦åŒ…å«ä»¥ä¸‹æ­¥éª¤ æ”¶åˆ°kill 9 è¿›ç¨‹é€€å‡ºä¿¡å·æ—¶ï¼Œspringå®¹å™¨ä¼šè§¦å‘å®¹å™¨é”€æ¯äº‹ä»¶ (å…¶å®æ˜¯springæ³¨å†Œçš„jvmé’©å­ç¨‹åºæ‰§è¡Œçš„ï¼Œåé¢ä¼šçœ‹åˆ°) providerç«¯ä¼šå–æ¶ˆæ³¨å†ŒæœåŠ¡å…ƒæ•°æ®ä¿¡æ¯ consumerç«¯ä¼šæ”¶åˆ°æœ€æ–°åœ°å€åˆ—è¡¨ï¼ˆå‡†å¤‡åœæœºåœ°å€ä¸åœ¨è¯¥åœ°å€åˆ—è¡¨ä¸­ï¼‰ dubboåè®®ä¼šå‘é€readonlyäº‹ä»¶æŠ¥æ–‡é€šçŸ¥consumeræœåŠ¡ä¸å¯ç”¨ æœåŠ¡ç«¯ç­‰å¾…å·²ç»æ‰§è¡Œçš„ä»»åŠ¡ç»“æŸå¹¶ä¸å†å¤„ç†æ–°çš„è¯·æ±‚ è¯´æ˜ ä¸Šå›¾ä¸­çš„æµç¨‹æ˜¯ä½¿ç”¨springæ„å»ºçš„dubboåº”ç”¨ ä¸Šå›¾ä¸­çš„æµç¨‹æ²¡æœ‰ä½“ç°å‡ºä¼˜é›…åœæœºçš„æ¶ˆè´¹ç«¯è§’è‰²ï¼Œè¯¥è§’è‰²åšçš„å·¥ä½œç›¸å¯¹ç®€å•ï¼Œä¸»è¦æ˜¯ä¸å†å‘èµ·æ–°çš„è°ƒç”¨è¯·æ±‚å’Œç­‰å¾…å“åº”è¿”å›ï¼Œè¶…æ—¶æ‰ä¼šå¼ºåˆ¶å…³é—­ æ³¨å†Œä¸­å¿ƒå·²ç»é€šçŸ¥äº†æœ€æ–°æœåŠ¡åˆ—è¡¨ï¼Œå‘é€readonlyäº‹ä»¶ä¸»è¦è€ƒè™‘åˆ°æ³¨å†Œä¸­å¿ƒæ¨é€æœåŠ¡æœ‰ç½‘ç»œå»¶è¿Ÿä»¥åŠå®¢æˆ·ç«¯è®¡ç®—æœåŠ¡åˆ—è¡¨ä¹Ÿéœ€è¦æ—¶é—´ã€‚æ¶ˆè´¹ç«¯æ”¶åˆ°åä¼šè®¾ç½®å¯¹åº”çš„providerä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œä¸‹æ¬¡è´Ÿè½½å‡è¡¡å°±ä¸ä¼šè°ƒç”¨è¿™ä¸ªä¸‹çº¿çš„æœåŠ¡ æ–¹æ¡ˆdubboå¯¹ä¼˜é›…åœæœºçš„å®ç°åœ¨ä¸åŒçš„ç‰ˆæœ¬ä¸­æœ‰æ‰€å·®å¼‚ï¼Œä¸‹é¢ä»2.5.xã€2.6.xä»¥åŠ2.7.xè¿™ä¸‰ä¸ªç‰ˆæœ¬åˆ†åˆ«åˆ†æã€‚ 2.5.xçš„ä¼˜é›…åœæœºæ³¨å†Œshutdown hook 12345678910111213141516171819public abstract class AbstractConfig implements Serializable &#123; // çœç•¥å…¶å®ƒä»£ç  static &#123; Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() &#123; public void run() &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Run shutdown hook now.\"); &#125; /** * é”€æ¯èµ„æº * 1 æ³¨å†Œä¸­å¿ƒæ•°æ®é”€æ¯ï¼š åˆ é™¤æ³¨å†Œä¸­å¿ƒä¸­æœ¬èŠ‚ç‚¹å¯¹åº”çš„æä¾›è€…åœ°å€ä»¥åŠè®¢é˜…æ•°æ® * 2 åè®®æµç¨‹æ•°æ®é”€æ¯ï¼š å–æ¶ˆè¯¥åè®®æ‰€æœ‰å·²ç»æš´éœ²å’Œå¼•ç”¨çš„æœåŠ¡ï¼Œé‡Šæ”¾åè®®æ‰€å ç”¨çš„æ‰€æœ‰èµ„æºï¼Œæ¯”å¦‚è¿æ¥å’Œç«¯å£ */ ProtocolConfig.destroyAll(); &#125; &#125;, \"DubboShutdownHook\")); &#125; è¯´æ˜ ProtocolConfig.destroyAll()æ–¹æ³•æ˜¯ç”¨æ¥é‡Šæ”¾èµ„æºçš„ï¼Œç”±äºdubboæ”¯æŒå¤šæ³¨å†Œä¸­å¿ƒå’Œå¤šåè®®ï¼Œå› æ­¤å…·ä½“é”€æ¯å®ç°ç»†èŠ‚å–å†³äºå…·ä½“çš„æ³¨å†Œä¸­å¿ƒå’Œå…·ä½“çš„åè®®ï¼Œè¿™é‡Œä¸å†å±•å¼€è¯´æ˜ã€‚ 2.6.xçš„ä¼˜é›…åœæœº springä¹Ÿä¾èµ–shutdown hookå®Œæˆä¼˜é›…åœæœºï¼Œå…¶æ³¨å†Œjvmé’©å­çš„æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425/** * Register a shutdown hook with the JVM runtime, closing this context * on JVM shutdown unless it has already been closed at that time. * &lt;p&gt;Delegates to &#123;@code doClose()&#125; for the actual closing procedure. * @see Runtime#addShutdownHook * @see #close() * @see #doClose() */@Overridepublic void registerShutdownHook() &#123; if (this.shutdownHook == null) &#123; // No shutdown hook registered yet. this.shutdownHook = new Thread() &#123; @Override public void run() &#123; synchronized (startupShutdownMonitor) &#123; doClose(); &#125; &#125; &#125;; // æ³¨å†Œjvmé’©å­ Runtime.getRuntime().addShutdownHook(this.shutdownHook); &#125;&#125; springçš„shutdownhookå…·ä½“ä»»åŠ¡å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** * Actually performs context closing: publishes a ContextClosedEvent and * destroys the singletons in the bean factory of this application context. * &lt;p&gt;Called by both &#123;@code close()&#125; and a JVM shutdown hook, if any. * @see org.springframework.context.event.ContextClosedEvent * @see #destroyBeans() * @see #close() * @see #registerShutdownHook() */protected void doClose() &#123; if (this.active.get() &amp;&amp; this.closed.compareAndSet(false, true)) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Closing \" + this); &#125; LiveBeansView.unregisterApplicationContext(this); try &#123; // Publish shutdown event // æ³¨æ„å®¹å™¨å…³ç³»äº‹ä»¶çš„å‘å¸ƒ publishEvent(new ContextClosedEvent(this)); &#125; catch (Throwable ex) &#123; logger.warn(\"Exception thrown from ApplicationListener handling ContextClosedEvent\", ex); &#125; // Stop all Lifecycle beans, to avoid delays during individual destruction. if (this.lifecycleProcessor != null) &#123; try &#123; this.lifecycleProcessor.onClose(); &#125; catch (Throwable ex) &#123; logger.warn(\"Exception thrown from LifecycleProcessor on context close\", ex); &#125; &#125; // Destroy all cached singletons in the context's BeanFactory. destroyBeans(); // Close the state of this context itself. closeBeanFactory(); // Let subclasses do some final clean-up if they wish... onClose(); this.active.set(false); &#125; &#125; dubbo2.6.xæ”¯æŒä½¿ç”¨springæ„å»ºdubboåº”ç”¨æ—¶ï¼Œèƒ½å¤Ÿå®‰å…¨ä½¿ç”¨ä¼˜é›…åœæœºã€‚ç”±äºdubboæ³¨å†Œäº†jvmåœæ­¢çš„é’©å­ï¼Œ springå¯èƒ½ ä¹Ÿæ³¨å†Œäº†jvmåœæœºçš„é’©å­ï¼Œè¿™ç§æƒ…å†µä¸‹ä¸¤ä¸ªå¹¶å‘æ‰§è¡Œçš„çº¿ç¨‹å¯èƒ½å¼•ç”¨å·²ç»é”€æ¯çš„èµ„æºï¼Œå¯¼è‡´ä¼˜é›…åœæœºå¤±æ•ˆã€‚æ¯”å¦‚ï¼Œdubboæ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡éœ€è¦å¼•ç”¨springä¸­çš„beanï¼Œä½†æ­¤æ—¶springé’©å­å·²ç»å…³é—­springä¸Šä¸‹æ–‡ï¼Œå¯¼è‡´è®¿é—®springèµ„æºéƒ½ä¼šæŠ¥é”™ã€‚å› æ­¤å¯¹äºè¿™ç§æƒ…å†µï¼Œdubboåœ¨2.6.3ä¸­æ–°å¢ShutdownHookListener ç±»ç”¨æ¥è§£å†³å¹¶å‘é—®é¢˜ï¼Œè¯¥ç±»å®ç°äº†ApplicationListeneræ¥å£ï¼Œå½“è¿›ç¨‹é€€å‡ºæ—¶jvmé’©å­ä¼šè¢«è§¦å‘ï¼Œæ­¤æ—¶springå’Œdubboæ³¨å†Œçš„jvmé’©å­éƒ½ä¼šè¢«å›è°ƒï¼Œspringæ³¨å†Œçš„jvmé’©å­ç¨‹åºä¸­springå‘å‡ºå®¹å™¨å…³é—­äº‹ä»¶ï¼ŒShutdownHookListeneræ¥æ”¶åˆ°å…³é—­äº‹ä»¶åæ‰§è¡Œdubboçš„jvmé’©å­ç¨‹åºè¿›è¡Œèµ„æºçš„é‡Šæ”¾ï¼Œè¿™æ ·å°±é¿å…ä½¿ç”¨æ— æ•ˆspring beançš„é—®é¢˜ï¼Œä»è€Œå®Œæˆä¼˜é›…åœæœºã€‚ ShutdownHookListener 1234567891011private static class ShutdownHookListener implements ApplicationListener &#123; @Override public void onApplicationEvent(ApplicationEvent event) &#123; if (event instanceof ContextClosedEvent) &#123; // ä½¿ç”¨springæ¡†æ¶æ—¶ä¹Ÿä¸åº”è¯¥åˆ é™¤dubbo shutdown hookï¼Œå› ä¸ºspringå¯èƒ½æ²¡æœ‰æ³¨å†ŒContextClosed äº‹ä»¶ DubboShutdownHook shutdownHook = DubboShutdownHook.getDubboShutdownHook(); shutdownHook.destroyAll(); &#125; &#125;&#125; AbstractConfigä¸­ä¾ç„¶ä¿ç•™JVMåœæ­¢é’©å­ 12345678910111213141516171819202122232425public abstract class AbstractConfig implements Serializable &#123; // çœç•¥æ— å…³ä»£ç ... static &#123; legacyProperties.put(\"dubbo.protocol.name\", \"dubbo.service.protocol\"); legacyProperties.put(\"dubbo.protocol.host\", \"dubbo.service.server.host\"); legacyProperties.put(\"dubbo.protocol.port\", \"dubbo.service.server.port\"); legacyProperties.put(\"dubbo.protocol.threads\", \"dubbo.service.max.thread.pool.size\"); legacyProperties.put(\"dubbo.consumer.timeout\", \"dubbo.service.invoke.timeout\"); legacyProperties.put(\"dubbo.consumer.retries\", \"dubbo.service.max.retry.providers\"); legacyProperties.put(\"dubbo.consumer.check\", \"dubbo.service.allow.no.provider\"); legacyProperties.put(\"dubbo.service.url\", \"dubbo.service.address\"); // this is only for compatibility /** * Dubbo çš„ä¼˜é›…åœæœº ShutdownHook åœ¨ AstractConfig çš„é™æ€ä»£ç å—ä¸­ï¼Œè¿™ä¿è¯äº†ShutdownHookèƒ½å¤Ÿç»™è¢«åˆå§‹åŒ–ã€‚ * è¯´æ˜ï¼š * 1 Dubbo æ˜¯ é€šè¿‡ JDKçš„ShutdownHookæ¥å®Œæˆä¼˜é›…åœæœºçš„ * 2 ShutdownHookæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡ä½“åœ¨å¯¹åº”çš„runæ–¹æ³•ä¸­ */ Runtime.getRuntime().addShutdownHook(DubboShutdownHook.getDubboShutdownHook()); &#125; &#125; DubboShutdownHook 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class DubboShutdownHook extends Thread &#123; private static final Logger logger = LoggerFactory.getLogger(DubboShutdownHook.class); /** * ShutdownHook,ç±»å±æ€§ */ private static final DubboShutdownHook dubboShutdownHook = new DubboShutdownHook(\"DubboShutdownHook\"); public static DubboShutdownHook getDubboShutdownHook() &#123; return dubboShutdownHook; &#125; /** * Has it already been destroyed or not? * &lt;p&gt; * æ˜¯å¦å·²ç»è¢«é”€æ¯æ ‡è¯† */ private final AtomicBoolean destroyed; private DubboShutdownHook(String name) &#123; super(name); this.destroyed = new AtomicBoolean(false); &#125; /** * ShutdownHookçš„ä»»åŠ¡ä½“ */ @Override public void run() &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Run shutdown hook now.\"); &#125; destroyAll(); &#125; /** * Destroy all the resources, including registries and protocols. * &lt;p&gt; * é”€æ¯æ‰€æœ‰çš„èµ„æºï¼ŒåŒ…æ‹¬ Registryç›¸å…³ å’Œ Protocolç›¸å…³ */ public void destroyAll() &#123; //å¦‚æœå·²ç»é”€æ¯åˆ™å¿½ç•¥ if (!destroyed.compareAndSet(false, true)) &#123; return; &#125; // é”€æ¯æ‰€æœ‰çš„ Registry,å–æ¶ˆåº”ç”¨ç¨‹åºä¸­çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„è®¢é˜…ä¸æ³¨å†Œ AbstractRegistryFactory.destroyAll(); /** * é”€æ¯æ‰€æœ‰çš„ Protocol * * è¯´æ˜ï¼š * è¿™é‡Œçš„Protocolæ¯”è¾ƒå¤šï¼Œå¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸¤ç±»ï¼š * 1 å’ŒRegistryç›¸å…³çš„Protocolï¼ŒRegistryProtocolå…³æ³¨æœåŠ¡çš„æ³¨å†Œ * 2 å…·ä½“åè®®ï¼Œå¦‚ DubboProtocolã€httpProtocolç­‰,å…³æ³¨æœåŠ¡çš„æš´éœ²å’Œå¼•ç”¨ */ ExtensionLoader&lt;Protocol&gt; loader = ExtensionLoader.getExtensionLoader(Protocol.class); for (String protocolName : loader.getLoadedExtensions()) &#123; try &#123; Protocol protocol = loader.getLoadedExtension(protocolName); if (protocol != null) &#123; protocol.destroy(); &#125; &#125; catch (Throwable t) &#123; logger.warn(t.getMessage(), t); &#125; &#125; &#125;&#125; DubboShutdownHookä¸protocolã€registryçš„å…³ç³»å›¾ å›¾è§£(ä»¥dubboåè®®å’Œzookeeperæ³¨å†Œä¸­å¿ƒä¸ºä¾‹) Registryç›¸å…³ AbstractRegistryFactory#destroyAllæ–¹æ³•ï¼Œéå†æ‰€æœ‰çš„Registryå¹¶è°ƒç”¨Registry#destroyæ–¹æ³•ã€‚ç„¶åæ¸…ç©ºRegistryç¼“å­˜é›†åˆã€‚ AbstractRegistry å®ç°äº†å…¬ç”¨çš„é”€æ¯é€»è¾‘ï¼šå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ã€‚æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…éƒ½ä¼šæ‰§è¡Œæ³¨å†Œå’Œè®¢é˜…ï¼Œå› æ­¤éƒ½éœ€è¦è¿›è¡Œå–æ¶ˆã€‚ FailbackRegistryå®ç°é”€æ¯å…¬ç”¨çš„é‡è¯•ä»»åŠ¡ ZookeeperRegistryé”€æ¯å…¶å¯¹åº”çš„å®¢æˆ·ç«¯è¿æ¥ Protocolç›¸å…³ AbstractProtocol#destroyæ–¹æ³•ï¼Œé”€æ¯åè®®å¯¹åº”çš„æœåŠ¡æ¶ˆè´¹è€…æ‹¥æœ‰çš„Invokerï¼Œ é”€æ¯åè®®å¯¹åº”çš„æœåŠ¡æä¾›è€…çš„æ‰€æœ‰Exporterã€‚ DubboProtocolé”€æ¯æ‰€æœ‰é€šä¿¡ ExchangeClient å’Œ ExchangeServer å°ç»“ dubbo2.6.3åœ¨springç¯å¢ƒä¸­æ³¨å†Œä¸¤ä¸ªé’©å­çš„æƒ…å†µï¼ŒShutdownHookListenerè§£å†³äº†å¹¶å‘æ‰§è¡Œé—®é¢˜ ä½¿ç”¨ShutdownHookListenerä¹Ÿä¸èƒ½ç§»é™¤è°ƒdubboæ³¨å†Œçš„jvmé’©å­ï¼Œå› ä¸ºä¸èƒ½ä¿è¯åº”ç”¨ä¸­ä¸€å®šä¼šæ³¨å†Œspringçš„shutdown hook 2.7.xä¼˜é›…åœæœºä»dubboçš„2.6.3ç‰ˆæœ¬å¼€å§‹ï¼Œè§£å†³äº†ä½¿ç”¨springæ„å»ºçš„dubboå¯èƒ½å‘ç”Ÿä¼˜é›…åœæœºå¹¶å‘æ‰§è¡Œshutdown hookçš„é—®é¢˜ã€‚ä½†æ˜¯è¿˜æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚æœåœ¨springç¯å¢ƒä¸‹æ²¡æœ‰æ³¨å†Œspringçš„jvmé’©å­ï¼Œè™½ç„¶æ²¡æœ‰å¤§é—®é¢˜ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸å®Œæ•´çš„ã€‚dubbo2.7.xè¿›è¡Œæ˜¾ç¤ºåœ°æ³¨å†Œspringçš„jvmé’©å­ï¼Œå¹¶ä¸”ç§»é™¤dubboçš„jvmé’©å­ï¼Œè§£å†³äº†å½“å‰é—®é¢˜ã€‚ 12345678910111213141516171819202122232425262728293031public class SpringExtensionFactory implements ExtensionFactory &#123; // çœç•¥å…¶å®ƒä»£ç ... private static final Set&lt;ApplicationContext&gt; CONTEXTS = new ConcurrentHashSet&lt;ApplicationContext&gt;(); private static final ApplicationListener SHUTDOWN_HOOK_LISTENER = new ShutdownHookListener(); public static void addApplicationContext(ApplicationContext context) &#123; CONTEXTS.add(context); if (context instanceof ConfigurableApplicationContext) &#123; // æ˜¾ç¤ºæ³¨å†Œspringçš„jvmé’©å­ ((ConfigurableApplicationContext) context).registerShutdownHook(); // æ˜¾ç¤ºç§»é™¤dubboçš„jvmé’©å­ DubboShutdownHook.getDubboShutdownHook().unregister(); &#125; BeanFactoryUtils.addApplicationListener(context, SHUTDOWN_HOOK_LISTENER); &#125; private static class ShutdownHookListener implements ApplicationListener &#123; @Override public void onApplicationEvent(ApplicationEvent event) &#123; if (event instanceof ContextClosedEvent) &#123; DubboShutdownHook shutdownHook = DubboShutdownHook.getDubboShutdownHook(); shutdownHook.doDestroy(); &#125; &#125; &#125;&#125; è¯´æ˜ dubbo2.7.xä¼˜é›…åœæœºçš„å®ç°ï¼Œè§£å†³äº†springç¯å¢ƒä¸‹ä¸¤ä¸ªé’©å­å¹¶å‘çš„é—®é¢˜ï¼Œå¹¶ä¸”æ˜¾ç¤ºæ³¨å†Œspringçš„jvmé’©å­ã€‚ æ€»ç»“ä¼˜é›…åœæœºå¹¶ä¸æ˜¯javaä¸­çš„æ¦‚å¿µï¼Œä¹Ÿä¸æ˜¯åªæœ‰dubboæ¡†æ¶è¿›è¡Œäº†æ‰©å±•å®ç°ï¼Œspringbootã€dockerç­‰éƒ½æœ‰æ¶‰åŠåˆ°ä¼˜é›…åœæœºã€‚dubboä¸­çš„ä¼˜é›…åœæœºæ˜¯ä¸æ–­ä¼˜åŒ–çš„ï¼Œ2.5.xä¸­çš„å­˜åœ¨ä¸€å®šçš„é—®é¢˜ï¼Œ2.6.xåœ¨ä¸€èˆ¬åœºæ™¯ä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œ2.7.xæ˜¯å¯¹ä¹‹å‰ç‰ˆæœ¬çš„å®Œå–„å’Œä¼˜åŒ–ã€‚å¦‚æœ ShutdownHook ä¸èƒ½ç”Ÿæ•ˆï¼Œå¯ä»¥åœ¨éœ€è¦çš„æ—¶æœºè‡ªè¡Œè°ƒç”¨DubboShutdownHook.destroyAll()ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"JDK","slug":"JDK","permalink":"https://gentryhuang.com/tags/JDK/"},{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"Spring","slug":"Spring","permalink":"https://gentryhuang.com/tags/Spring/"}]},{"title":"Dubboæºç åˆ†æ - Zookeeperå®¢æˆ·ç«¯","slug":"rpc/æ³¨å†Œä¸­å¿ƒä¹‹Zookeeperå®¢æˆ·ç«¯","date":"2020-04-19T16:00:00.000Z","updated":"2020-09-09T15:10:14.787Z","comments":false,"path":"posts/817d6a19/","link":"","permalink":"https://gentryhuang.com/posts/817d6a19/","excerpt":"","text":"å‰è¨€åœ¨ Dubboæºç åˆ†æ - Zookeeperæ³¨å†Œä¸­å¿ƒ ä¸­ä»‹ç»çš„æ˜¯ Dubbo çš„ Zookeeper æ³¨å†Œä¸­å¿ƒå®ç°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰æ¶‰åŠåˆ° Zookeeper å®¢æˆ·ç«¯çš„æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬ä»‹ç» Zookeeper åœ¨ Dubbo æ¡†æ¶ä¸­å…·ä½“å®ç°ã€‚ æ¦‚è¿° ä¸Šå›¾çš„ UML æè¿°äº† Dubbo å°è£…çš„ Zookeeper æ³¨å†Œä¸­å¿ƒå’Œ Zookeeper ç›¸å…³å®ç°çš„å…³ç³»ã€‚ Dubbo å¯¹ Zookeeper å®¢æˆ·ç«¯çš„å°è£…æ˜¯åœ¨ dubbo-remoting-zookeeper æ¨¡å—ä¸­ï¼Œè¯¥æ¨¡å—å¯¹ Zookeeper å®¢æˆ·ç«¯æ¥å£è¿›è¡Œäº†æŠ½è±¡ã€‚ ç›®å‰æ”¯æŒ ZkClient å’Œ Curator ä¸¤ç§ Zookeeper å®¢æˆ·ç«¯å®ç°ï¼š Curator å®ç° 1&lt;dubbo:registry ... client=\"curator\" /&gt; ZkClient å®ç° 1&lt;dubbo:registry ... client=\"zkclient\" /&gt; æ³¨æ„: åœ¨2.7.xçš„ç‰ˆæœ¬ä¸­å·²ç»ç§»é™¤äº†zkclientçš„å®ç°,å¦‚æœè¦ä½¿ç”¨zkclientå®¢æˆ·ç«¯,éœ€è¦æ˜¾ç¤ºé…ç½®ã€‚ä¸‹é¢åˆ†æä¸Šå›¾çš„ UML ä¸­æ¶‰åŠçš„æ¥å£å’Œå®ç°ç±»ã€‚ ZookeeperTransporter12345678910111213@SPI(\"curator\")public interface ZookeeperTransporter &#123; /** * è¿æ¥åˆ›å»º ZookeeperClient å¯¹è±¡ * * @param url æ³¨å†Œä¸­å¿ƒåœ°å€ * @return ZookeeperClient å¯¹è±¡ */ @Adaptive(&#123;Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY&#125;) ZookeeperClient connect(URL url);&#125; è¯¥æ¥å£æ˜¯ Dubbo çš„æ‰©å±•ç‚¹ï¼Œæ˜¯ Zookeeper å®¢æˆ·ç«¯å·¥å‚ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨ CuratorZookeeperTransporter åˆ›å»º ZookeeperClient ï¼Œåé¢ä¼šè¯¦ç»†åˆ†æ ZookeeperClient ç»§æ‰¿ä½“ç³»ã€‚ StateListener123456789101112131415161718192021public interface StateListener &#123; /** * å·²æ–­å¼€ */ int DISCONNECTED = 0; /** * å·²è¿æ¥ */ int CONNECTED = 1; /** * å·²é‡è¿ */ int RECONNECTED = 2; /** * çŠ¶æ€å˜æ›´å›è°ƒæ–¹æ³• * * @param connected çŠ¶æ€ */ void stateChanged(int connected);&#125; è¯¥æ¥å£ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç›‘å¬å™¨ï¼Œå®ƒçš„å®ç°æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œåœ¨ ZookeeperRegistry çš„æ„é€ æ–¹æ³•ä¸­ï¼Œä½œä¸º ZookeeperClient çš„çŠ¶æ€å˜åŒ–ï¼ˆä¼šè¯ï¼‰çš„å›è°ƒï¼Œå…·ä½“è°ƒç”¨å…¥å£æ˜¯ AbstractZookeeperClient#stateChanged(int) ã€‚ 12345678910111213141516171819202122public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) &#123; // åˆ›å»º Zookeeper å®¢æˆ·ç«¯ï¼Œé»˜è®¤ä¸º CuratorZookeeperTransporterï¼Œç”±SPIç¡®å®šå…·ä½“çš„å®ä¾‹ã€‚åˆ›å»ºå¥½Zookeeperå®¢æˆ·ç«¯ï¼Œæ„å‘³ç€æ³¨å†Œä¸­å¿ƒçš„åˆ›å»ºå®Œæˆã€ZookeeperæœåŠ¡ç«¯å¿…éœ€å…ˆå¯åŠ¨ï¼ŒDubboåº”ç”¨ä½œä¸ºZookeeperçš„å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œç„¶åæ“ä½œZookeeperã€‘ zkClient = zookeeperTransporter.connect(url); /** * æ·»åŠ  StateListener çŠ¶æ€ç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨åœ¨é‡è¿æ—¶ï¼Œè°ƒç”¨æ¢å¤æ–¹æ³• recover()ï¼Œé‡æ–°å‘èµ·æ³¨å†Œå’Œè®¢é˜…ã€å°†ä¹‹å‰å·²ç»æ³¨å†Œå’Œè®¢é˜…çš„æ•°æ®è¿›è¡Œé‡è¯•ã€‘ * æ³¨æ„ï¼š * StateListener ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç›‘å¬å™¨ï¼Œè¿™é‡Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå¯¹è±¡ï¼Œå…¶ä¸­çš„ #stateChanged æ–¹æ³•è§¦å‘éœ€è¦ä¸»åŠ¨è°ƒç”¨è¯¥åŒ¿åå¯¹è±¡çš„è¯¥æ–¹æ³• &#123;@link AbstractZookeeperClient#stateChanged(int)&#125; */ zkClient.addStateListener(new StateListener() &#123; @Override public void stateChanged(int state) &#123; if (state == RECONNECTED) &#123; try &#123; recover(); &#125; catch (Exception e) &#123; logger.error(e.getMessage(), e); &#125; &#125; &#125; &#125;); &#125; ChildListener1234567891011public interface ChildListener &#123; /** * å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„å›è°ƒ * * @param path èŠ‚ç‚¹ * @param children æœ€æ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨ */ void childChanged(String path, List&lt;String&gt; children);&#125; è¯¥æ¥å£åªæ˜¯ä¸€ä¸ªæ™®é€šçš„æ¥å£ï¼Œå…·ä½“å®ç°æ˜¯ä¸€ä¸ªåŒ¿åå†…éƒ¨ç±»ï¼Œå…¥å£åœ¨ ZookeeperRegistry å®ç°ç±»çš„ doSubscribe æ–¹æ³•ä¸­ï¼Œè¯¥æ¥å£çš„å¯¹è±¡æœ€ç»ˆä¼šç”¨äº Zookeeper å®¢æˆ·ç«¯çš„æŸä¸ªèŠ‚ç‚¹ä¸‹å­èŠ‚ç‚¹å˜åŒ–çš„å›è°ƒæ–¹æ³•ä¸­ï¼Œä¸‹é¢æˆ‘ä»¬å†åˆ†æä¸¤ç§å®¢æˆ·ç«¯çš„ä¸åŒå®ç°ã€‚ ZookeeperClient123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869public interface ZookeeperClient &#123; /** * åˆ›å»ºèŠ‚ç‚¹ * * @param path èŠ‚ç‚¹è·¯å¾„ * @param ephemeral æ˜¯å¦ä¸´æ—¶èŠ‚ç‚¹ */ void create(String path, boolean ephemeral); /** * åˆ é™¤èŠ‚ç‚¹ * * @param path èŠ‚ç‚¹è·¯å¾„ */ void delete(String path); /** * è·å–å­èŠ‚ç‚¹è·¯å¾„ * @param path * @return */ List&lt;String&gt; getChildren(String path); /** * æ·»åŠ  ChildListener * * @param path èŠ‚ç‚¹è·¯å¾„ * @param listener ç›‘å¬å™¨ * @return å­èŠ‚ç‚¹åˆ—è¡¨ */ List&lt;String&gt; addChildListener(String path, ChildListener listener); /** * ç§»é™¤ ChildListener * * @param path èŠ‚ç‚¹è·¯å¾„ * @param listener ç›‘å¬å™¨ */ void removeChildListener(String path, ChildListener listener); /** * æ·»åŠ  StateListener * * @param listener ç›‘å¬å™¨ */ void addStateListener(StateListener listener); /** * ç§»é™¤ StateListener * * @param listener ç›‘å¬å™¨ */ void removeStateListener(StateListener listener); /** * @return æ˜¯å¦è¿æ¥ */ boolean isConnected(); /** * å…³é—­ */ void close(); /** * @return è·å¾—æ³¨å†Œä¸­å¿ƒ URL */ URL getUrl();&#125; ZookeeperClient æ¥å£æ˜¯å¯¹ Zookeeper å®¢æˆ·ç«¯æ¥å£çš„æŠ½è±¡ï¼Œå®šä¹‰äº†ä¸€ç³»åˆ—çš„æ“ä½œæ–¹æ³•ï¼Œå®ƒçš„å…·ä½“å­ç±»ä¸­å°è£…äº† Zookeeper çš„å®¢æˆ·ç«¯å¯¹è±¡ã€‚ AbstractZookeeperClientZookeeperClient æ¥å£çš„æŠ½è±¡ç±»ï¼Œä¸»è¦å®ç°äº†é€šç”¨çš„é€»è¾‘ï¼Œå¦‚ï¼Œåˆ›å»ºèŠ‚ç‚¹ 12345678910111213141516171819202122232425262728293031323334353637383940/** * å®ç° ZookeeperClient æ¥å£ï¼ŒZookeeper å®¢æˆ·ç«¯æŠ½è±¡ç±»ï¼Œå®ç°é€šç”¨çš„é€»è¾‘ã€‚ * * @param &lt;TargetChildListener&gt; æ³›å‹ */public abstract class AbstractZookeeperClient&lt;TargetChildListener&gt; implements ZookeeperClient &#123; protected static final Logger logger = LoggerFactory.getLogger(AbstractZookeeperClient.class); /** * æ³¨å†Œä¸­å¿ƒ URL */ private final URL url; /** * StateListener çŠ¶æ€ç›‘å¬å™¨é›†åˆ */ private final Set&lt;StateListener&gt; stateListeners = new CopyOnWriteArraySet&lt;StateListener&gt;(); /** * ChildListener é›†åˆ * &lt;p&gt; * key1ï¼šèŠ‚ç‚¹è·¯å¾„ * key2ï¼šChildListener å¯¹è±¡ * value ï¼šç›‘å¬å™¨å…·ä½“å¯¹è±¡ï¼Œä¸åŒ Zookeeper å®¢æˆ·ç«¯ï¼Œå®ç°ä¼šä¸åŒã€‚CuratorZookeeperClientçš„æ˜¯CuratorWatcher;ZkclientZookeeperClient çš„æ˜¯ IZkChildListener */ private final ConcurrentMap&lt;String, ConcurrentMap&lt;ChildListener, TargetChildListener&gt;&gt; childListeners = new ConcurrentHashMap&lt;String, ConcurrentMap&lt;ChildListener, TargetChildListener&gt;&gt;(); /** * æ˜¯å¦å…³é—­ */ private volatile boolean closed = false; public AbstractZookeeperClient(URL url) &#123; this.url = url; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è¯¥æŠ½è±¡ç±»ä¸­çš„å±æ€§ä¸»è¦å››ä¸ªï¼Œå…¶ä¸­ stateListeners å±æ€§æ˜¯å½“ Zookeeperçš„çŠ¶æ€å˜åŒ–æ—¶è¦é€šçŸ¥çš„å¯¹è±¡ï¼ŒchildListeners å±æ€§æ¯”è¾ƒå…³é”®ï¼Œæ˜¯èŠ‚ç‚¹è·¯å¾„åˆ°å…¶å­èŠ‚ç‚¹ç›‘å¬å™¨çš„æ˜ å°„ã€‚ create åˆ›å»ºèŠ‚ç‚¹1234567891011121314151617181920212223242526272829public abstract class AbstractZookeeperClient&lt;TargetChildListener&gt; implements ZookeeperClient &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; @Override public void create(String path, boolean ephemeral) &#123; if (!ephemeral) &#123; // å¦‚æœè¦åˆ›å»ºçš„èŠ‚ç‚¹ç±»å‹éä¸´æ—¶èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™é‡Œè¦æ£€æµ‹èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚ä¸´æ—¶èŠ‚ç‚¹æœ‰åºå·ï¼Œä¸éœ€è¦è€ƒè™‘è¦†ç›–é—®é¢˜ if (checkExists(path)) &#123; return; &#125; &#125; int i = path.lastIndexOf('/'); if (i &gt; 0) &#123; // é€’å½’åˆ›å»ºä¸Šä¸€çº§è·¯å¾„ create(path.substring(0, i), false); &#125; // æ ¹æ® ephemeral çš„å€¼åˆ›å»ºä¸´æ—¶æˆ–æŒä¹…èŠ‚ç‚¹ if (ephemeral) &#123; createEphemeral(path); &#125; else &#123; createPersistent(path); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; StateListener æ“ä½œæ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637383940414243444546public abstract class AbstractZookeeperClient&lt;TargetChildListener&gt; implements ZookeeperClient &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * åŠ å…¥ StateListener åˆ°ç¼“å­˜ * * @param listener StateListener */ @Override public void addStateListener(StateListener listener) &#123; stateListeners.add(listener); &#125; /** * ç§»é™¤ç¼“å­˜ä¸­çš„ StateListener * * @param listener ç›‘å¬å™¨ */ @Override public void removeStateListener(StateListener listener) &#123; stateListeners.remove(listener); &#125; /** * è·å–ç¼“å­˜ä¸­çš„ StateListener * @return */ public Set&lt;StateListener&gt; getSessionListeners() &#123; return stateListeners; &#125; /** * éå†StateListener æ•°ç»„ï¼Œå›è°ƒ * * @param state çŠ¶æ€ */ protected void stateChanged(int state) &#123; for (StateListener sessionListener : getSessionListeners()) &#123; sessionListener.stateChanged(state); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; StateListener æ“ä½œæ–¹æ³•å¾ˆç®€å•ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ addStateListener å’Œ stateChanged æ–¹æ³•ï¼Œå‰è€…æ˜¯åœ¨ ZookeeperRegistry æ„é€ æ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œå‰æ–‡å·²ç»è¯´æ˜ã€‚åè€…æ˜¯å½“ Zookeeper å®¢æˆ·ç«¯çš„ä¼šè¯å˜åŒ–æ—¶ä¼šä¸»åŠ¨è°ƒç”¨ï¼Œä¸‹æ–‡ä¼šè¯´æ˜ã€‚ addChildListener12345678910111213141516171819202122232425262728293031323334353637383940public abstract class AbstractZookeeperClient&lt;TargetChildListener&gt; implements ZookeeperClient &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * * @param path è®¢é˜…url æ˜ å°„çš„ç›®å½•ï¼Œå¦‚ .../providers * @param listener è®¢é˜…url æ˜ å°„çš„ç›®å½•ä¸‹å­èŠ‚ç‚¹å˜åŒ–æ—¶æ‰§è¡Œå›è°ƒçš„å¯¹è±¡ */ @Override public List&lt;String&gt; addChildListener(String path, final ChildListener listener) &#123; // 1 è·å–/åˆ›å»ºï¼šConcurrentMap&lt;categorypath, ConcurrentMap&lt;ZookeeperRegistryçš„å†…éƒ¨ç±»ChildListenerå®ä¾‹, TargetChildListener&gt;&gt; childListenersï¼Œè¿™é‡Œä¸»è¦æ˜¯åˆ›å»ºTargetChildListener ConcurrentMap&lt;ChildListener, TargetChildListener&gt; listeners = childListeners.get(path); if (listeners == null) &#123; childListeners.putIfAbsent(path, new ConcurrentHashMap&lt;ChildListener, TargetChildListener&gt;()); listeners = childListeners.get(path); &#125; // è·å¾—æ˜¯å¦å·²ç»æœ‰è¯¥ç›‘å¬å™¨ TargetChildListener targetListener = listeners.get(listener); // zkç›‘å¬å™¨å¯¹è±¡ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º if (targetListener == null) &#123; /** * 1 åˆ›å»ºä¸€ä¸ªç›‘å¬pathä¸‹å­èŠ‚ç‚¹çš„watcherã€CuratorZookeeperClientå®ç°ã€‘æˆ– IZkChildListener ã€ZkclientZookeeperClientå®ç°ã€‘ * 2 å½“pathä¸‹æœ‰å­èŠ‚ç‚¹å˜åŒ–æ—¶ï¼Œè°ƒç”¨listenerï¼ˆå³ä¼ å…¥çš„ZookeeperRegistryçš„å†…éƒ¨ç±»ChildListenerå®ä¾‹çš„childChanged(String parentPath, List&lt;String&gt; currentChilds)æ–¹æ³•ï¼‰ */ listeners.putIfAbsent(listener, createTargetChildListener(path, listener)); targetListener = listeners.get(listener); &#125; // å‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·è®¢é˜…ï¼Œå³ä¸º pathæ·»åŠ TargetChildListenerç›‘å¬å™¨å®ä¾‹ return addTargetChildListener(path, targetListener); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è¯¥æ–¹æ³•çš„æ ¸å¿ƒå°±æ˜¯ä¸ºè®¢é˜… URL æ˜ å°„çš„èŠ‚ç‚¹ç»‘å®šä¸€ä¸ªå­èŠ‚ç‚¹ç›‘å¬å™¨ï¼Œå­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ä¼šè¢«å­èŠ‚ç‚¹ç›‘å¬å™¨æ•æ‰åˆ°ï¼Œç„¶åå°†å˜åŒ–çš„æ•°æ®ä¿¡æ¯é€šè¿‡ ChildListener åŒ¿åå¯¹è±¡çš„æ–¹æ³•ä¼ é€’å‡ºå»ï¼Œä¸‹é¢ä¼šç»“åˆå…·ä½“çš„ Zookeeper å®¢æˆ·ç«¯è¯´æ˜ã€‚ removeChildListener12345678910111213141516171819public abstract class AbstractZookeeperClient&lt;TargetChildListener&gt; implements ZookeeperClient &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; @Override public void removeChildListener(String path, ChildListener listener) &#123; ConcurrentMap&lt;ChildListener, TargetChildListener&gt; listeners = childListeners.get(path); if (listeners != null) &#123; TargetChildListener targetListener = listeners.remove(listener); if (targetListener != null) &#123; // å‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·å–æ¶ˆè®¢é˜… removeTargetChildListener(path, targetListener); &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è¯¥æ–¹æ³•ç”¨äºè§£é™¤ path ç›®å½•çš„å­èŠ‚ç‚¹å˜åŒ–ç›‘å¬å™¨ã€‚ ç›®å½•çš„å­èŠ‚ç‚¹å˜åŒ–ç›‘å¬å™¨æ“ä½œ123456789101112131415161718192021222324252627282930313233public abstract class AbstractZookeeperClient&lt;TargetChildListener&gt; implements ZookeeperClient &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * æŠ½è±¡æ–¹æ³•ï¼Œåˆ›å»ºçœŸæ­£çš„ ChildListener å¯¹è±¡ã€‚å› ä¸ºï¼Œæ¯ä¸ª Zookeeper çš„åº“ï¼Œå®ç°ä¸åŒã€‚ * * @param path * @param listener * @return */ protected abstract TargetChildListener createTargetChildListener(String path, ChildListener listener); /** * å‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·è®¢é˜… * * @param path * @param listener * @return */ protected abstract List&lt;String&gt; addTargetChildListener(String path, TargetChildListener listener); /** * å‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·å–æ¶ˆè®¢é˜… * * @param path * @param listener */ protected abstract void removeTargetChildListener(String path, TargetChildListener listener); // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢ä¸‰ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å¯¹ path ç›®å½•ä¸‹çš„å­èŠ‚ç‚¹çš„ç›‘å¬å™¨è¿›è¡Œæ“ä½œçš„ï¼Œå…·ä½“é€»è¾‘äº¤ç»™å­ç±»å®ç°ã€‚ä¸‹é¢æˆ‘ä»¬è¯¦ç»†åˆ†æ AbstractZookeeperClient çš„ä¸¤ä¸ªå…·ä½“å®ç°ç±»ã€‚ CuratorZookeeperClientå±æ€§123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657public class CuratorZookeeperClient extends AbstractZookeeperClient&lt;CuratorWatcher&gt; &#123; /** * Zookeeper çš„ Curator å®¢æˆ·ç«¯å¯¹è±¡ */ private final CuratorFramework client; /** * CuratorZookeeperClient æ„é€ æ–¹æ³•ä¸»è¦ç”¨äºåˆ›å»ºå’Œå¯åŠ¨ CuratorFramework å®ä¾‹ * * @param url */ public CuratorZookeeperClient(URL url) &#123; super(url); try &#123; // åˆ›å»º CuratorFramework æ„é€ å™¨ CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder() // è¿æ¥åœ°å€ .connectString(url.getBackupAddress()) // é‡è¯•ç­–ç•¥: é‡è¯•æ¬¡æ•°ï¼š1ï¼Œæ¯æ¬¡é‡è¯•é—´éš”ï¼š 1000 ms .retryPolicy(new RetryNTimes(1, 1000)) // è¿æ¥è¶…æ—¶æ—¶é—´ .connectionTimeoutMs(5000); String authority = url.getAuthority(); if (authority != null &amp;&amp; authority.length() &gt; 0) &#123; builder = builder.authorization(\"digest\", authority.getBytes()); &#125; // æ„å»º CuratorFramework å®ä¾‹ client = builder.build(); // æ·»åŠ è¿æ¥ç›‘å¬å™¨ã€‚åœ¨è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨#stateChange(state)æ–¹æ³•ï¼Œè¿›è¡ŒStateListenerçš„å›è°ƒ client.getConnectionStateListenable().addListener(new ConnectionStateListener() &#123; /** * åœ¨è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨ #stateChange(state) æ–¹æ³•ï¼Œè¿›è¡Œ StateListener çš„å›è°ƒã€‚ * @param client * @param state */ @Override public void stateChanged(CuratorFramework client, ConnectionState state) &#123; if (state == ConnectionState.LOST) &#123; CuratorZookeeperClient.this.stateChanged(StateListener.DISCONNECTED); &#125; else if (state == ConnectionState.CONNECTED) &#123; CuratorZookeeperClient.this.stateChanged(StateListener.CONNECTED); &#125; else if (state == ConnectionState.RECONNECTED) &#123; CuratorZookeeperClient.this.stateChanged(StateListener.RECONNECTED); &#125; &#125; &#125;); // å¯åŠ¨å®¢æˆ·ç«¯ (å½“è¿æ¥ä¸ä¸ŠzkæœåŠ¡æ—¶ï¼Œé»˜è®¤å°†ä¸€ç›´é‡è¯•) client.start(); &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä» CuratorZookeeperClient çš„å±æ€§ä¸­ï¼Œå¯ä»¥å¾—åˆ°ä¸Šæ–‡ä¸­çš„ä¸€ä¸ªç­”æ¡ˆï¼ŒstateChanged æ–¹æ³•è°ƒç”¨çš„å…¥å£ï¼ŒCuratorZookeeperClient æ„é€ æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼ŒZookeeper çš„ Curator å®¢æˆ·ç«¯è¿æ¥åˆ›å»ºå®Œæ¯•ã€‚ æ“ä½œèŠ‚ç‚¹æ–¹æ³•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104public class CuratorZookeeperClient extends AbstractZookeeperClient&lt;CuratorWatcher&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * åˆ›å»º path æŒä¹…èŠ‚ç‚¹ * * @param path */ @Override public void createPersistent(String path) &#123; try &#123; client.create().forPath(path); &#125; catch (NodeExistsException e) &#123; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; /** * åˆ›å»º path ä¸´æ—¶èŠ‚ç‚¹ * * @param path */ @Override public void createEphemeral(String path) &#123; try &#123; client.create().withMode(CreateMode.EPHEMERAL).forPath(path); &#125; catch (NodeExistsException e) &#123; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; /** * åˆ é™¤ path èŠ‚ç‚¹ * * @param path èŠ‚ç‚¹è·¯å¾„ */ @Override public void delete(String path) &#123; try &#123; client.delete().forPath(path); &#125; catch (NoNodeException e) &#123; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; /** * è·å– path èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨ * * @param path * @return */ @Override public List&lt;String&gt; getChildren(String path) &#123; try &#123; return client.getChildren().forPath(path); &#125; catch (NoNodeException e) &#123; return null; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; /** * æ£€æŸ¥ path èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ * * @param path * @return */ @Override public boolean checkExists(String path) &#123; try &#123; if (client.checkExists().forPath(path) != null) &#123; return true; &#125; &#125; catch (Exception e) &#123; &#125; return false; &#125; /** * è¿æ¥æ˜¯å¦å·²ç»å…³é—­ * * @return */ @Override public boolean isConnected() &#123; return client.getZookeeperClient().isConnected(); &#125; /** * å…³é—­è¿æ¥ */ @Override public void doClose() &#123; client.close(); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; CuratorZookeeperClient ä¸­çš„æ“ä½œèŠ‚ç‚¹çš„æ–¹æ³•å¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨ Curator çš„ API å³å¯ã€‚ å­èŠ‚ç‚¹ç›‘å¬å™¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990public class CuratorZookeeperClient extends AbstractZookeeperClient&lt;CuratorWatcher&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * åˆ›å»ºä¸€ä¸ªç›‘å¬pathå­èŠ‚ç‚¹çš„watcher æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯åˆ›å»ºä¸€ä¸ªCuratorWatcherç›‘å¬å™¨ï¼Œå¹¶æ²¡æœ‰å¯¹èŠ‚ç‚¹è¿›è¡Œç»‘å®š * * @param path * @param listener * @return */ @Override public CuratorWatcher createTargetChildListener(String path, ChildListener listener) &#123; return new CuratorWatcherImpl(listener); &#125; /** * ä¸ºpathèŠ‚ç‚¹ç»‘å®šCuratorWatcherç›‘å¬å™¨ï¼Œå¹¶è¿”å›pathçš„å­è·¯å¾„åˆ—è¡¨ * * @param path * @param listener * @return */ @Override public List&lt;String&gt; addTargetChildListener(String path, CuratorWatcher listener) &#123; try &#123; return client.getChildren().usingWatcher(listener).forPath(path); &#125; catch (NoNodeException e) &#123; return null; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; /** * ç§»é™¤ç›‘å¬å™¨ * * @param path * @param listener */ @Override public void removeTargetChildListener(String path, CuratorWatcher listener) &#123; ((CuratorWatcherImpl) listener).unwatch(); &#125; /** * å®ç°CuratorWatcheræ¥å£ï¼Œå®ç°ç›‘å¬å™¨åŠŸèƒ½ */ private class CuratorWatcherImpl implements CuratorWatcher &#123; /** * ChildListener åŒ¿åå¯¹è±¡ */ private volatile ChildListener listener; public CuratorWatcherImpl(ChildListener listener) &#123; this.listener = listener; &#125; public void unwatch() &#123; this.listener = null; &#125; /** * 1 å½“pathèŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆè°ƒç”¨TargetChildListenerçš„process(WatchedEvent event)æ–¹æ³•ï¼Œ * 2 åœ¨è¯¥æ–¹æ³•ä¸­åˆä¼šè°ƒç”¨ChildListenerå®ä¾‹çš„childChanged(String parentPath, List&lt;String&gt; currentChilds)æ–¹æ³• * * @param event * @throws Exception */ @Override public void process(WatchedEvent event) throws Exception &#123; if (listener != null) &#123; String path = event.getPath() == null ? \"\" : event.getPath(); // ä¸»åŠ¨è°ƒç”¨ChildListener åŒ¿åå¯¹è±¡çš„æ–¹æ³• listener.childChanged(path, // if path is null, curator using watcher will throw NullPointerException. // if client connect or disconnect to server, zookeeper will queue // watched event(Watcher.Event.EventType.None, .., path = null). StringUtils.isNotEmpty(path) ? client.getChildren().usingWatcher(this).forPath(path) // é‡æ–°å‘èµ·è¿æ¥ï¼Œå¹¶ä¼ å…¥æœ€æ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨ : Collections.&lt;String&gt;emptyList()); &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; å­èŠ‚ç‚¹ç›‘å¬å™¨ï¼Œæ ¸å¿ƒæ˜¯å®ç° CuratorWatcher æ¥å£ï¼Œå®ç°ç›‘å¬å™¨åŠŸèƒ½ï¼Œå½“ç›‘å¬çš„èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šåœ¨ç›‘å¬å™¨çš„å›è°ƒæ–¹æ³•ä¸­ä¸»åŠ¨è°ƒç”¨ ChildListener åŒ¿åå¯¹è±¡çš„ childChanged æ–¹æ³•ï¼Œè¿™æ˜¯ Dubbo ä¸­è®¢é˜…çš„æ ¸å¿ƒç‚¹ã€‚ ZkclientZookeeperClientZkclientZookeeperClient å¹¶æ²¡æœ‰ç›´æ¥å°è£… ZkClient å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡ ZkClientWrapper å°è£…äº† ZkClient å¯¹è±¡ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æ ZkClientWrapperã€‚ ZkClientWrapper123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177public class ZkClientWrapper &#123; Logger logger = LoggerFactory.getLogger(ZkClientWrapper.class); /** * è¶…æ—¶æ—¶é—´ */ private long timeout; /** * Zookeeper çš„ ZkClient å®¢æˆ·ç«¯ */ private ZkClient client; /** * çŠ¶æ€ */ private volatile KeeperState state; /** * FutureTask */ private ListenableFutureTask&lt;ZkClient&gt; listenableFutureTask; /** * æ˜¯å¦å¼€å§‹ */ private volatile boolean started = false; /** * @param serverAddr Zookeeper æœåŠ¡ç«¯åœ°å€ * @param timeout è¶…æ—¶æ—¶é—´ */ public ZkClientWrapper(final String serverAddr, long timeout) &#123; this.timeout = timeout; listenableFutureTask = ListenableFutureTask.create(new Callable&lt;ZkClient&gt;() &#123; /** * é€šè¿‡å›è°ƒåˆ›å»º Zookeeper çš„ ZkClient å®¢æˆ·ç«¯ * @return * @throws Exception */ @Override public ZkClient call() throws Exception &#123; return new ZkClient(serverAddr, Integer.MAX_VALUE); &#125; &#125;); &#125; /** * åˆ›å»ºZ ookeeper çš„ ZkClient å®¢æˆ·ç«¯ */ public void start() &#123; if (!started) &#123; Thread connectThread = new Thread(listenableFutureTask); connectThread.setName(\"DubboZkclientConnector\"); connectThread.setDaemon(true); connectThread.start(); try &#123; client = listenableFutureTask.get(timeout, TimeUnit.MILLISECONDS); &#125; catch (Throwable t) &#123; logger.error(\"Timeout! zookeeper server can not be connected in : \" + timeout + \"ms!\", t); &#125; started = true; &#125; else &#123; logger.warn(\"Zkclient has already been started!\"); &#125; &#125; /** * è®¾ç½®å®¢æˆ·ç«¯ç›‘å¬å™¨ * * @param listener */ public void addListener(final IZkStateListener listener) &#123; listenableFutureTask.addListener(new Runnable() &#123; @Override public void run() &#123; try &#123; client = listenableFutureTask.get(); client.subscribeStateChanges(listener); &#125; catch (InterruptedException e) &#123; logger.warn(Thread.currentThread().getName() + \" was interrupted unexpectedly, which may cause unpredictable exception!\"); &#125; catch (ExecutionException e) &#123; logger.error(\"Got an exception when trying to create zkclient instance, can not connect to zookeeper server, please check!\", e); &#125; &#125; &#125;); &#125; /** * ZkClient æ˜¯å¦å¤„ç†è¿æ¥çŠ¶æ€ * * @return */ public boolean isConnected() &#123; return client != null &amp;&amp; state == KeeperState.SyncConnected; &#125; /** * ä½¿ç”¨ ZkClient AIP åˆ›å»ºæŒä¹…èŠ‚ç‚¹ * * @param path */ public void createPersistent(String path) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); client.createPersistent(path, true); &#125; /** * ä½¿ç”¨ ZkClient AIP åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ * * @param path */ public void createEphemeral(String path) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); client.createEphemeral(path); &#125; /** * ä½¿ç”¨ ZkClient AIP åˆ é™¤èŠ‚ç‚¹ * * @param path */ public void delete(String path) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); client.delete(path); &#125; /** * ä½¿ç”¨ ZkClient AIP è·å– path èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹åˆ—è¡¨ * * @param path * @return */ public List&lt;String&gt; getChildren(String path) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); return client.getChildren(path); &#125; /** * ä½¿ç”¨ ZkClient AIP åˆ¤æ–­æ˜¯å¦å­˜åœ¨ path èŠ‚ç‚¹ * * @param path * @return */ public boolean exists(String path) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); return client.exists(path); &#125; /** * æ–­å¼€ Zookeeper è¿æ¥ */ public void close() &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); client.close(); &#125; /** * ä¸º path èŠ‚ç‚¹ç»‘å®šå…¶å­èŠ‚ç‚¹çš„ç›‘å¬å™¨ï¼Œç”¨äºç›‘å¬ path èŠ‚ç‚¹ä¸‹å­èŠ‚ç‚¹çš„å˜åŒ– * * @param path * @param listener * @return */ public List&lt;String&gt; subscribeChildChanges(String path, final IZkChildListener listener) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); return client.subscribeChildChanges(path, listener); &#125; /** * åˆ é™¤ path èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ç›‘å¬å™¨ * * @param path * @param listener */ public void unsubscribeChildChanges(String path, IZkChildListener listener) &#123; Assert.notNull(client, new IllegalStateException(\"Zookeeper is not connected yet!\")); client.unsubscribeChildChanges(path, listener); &#125;&#125; ZkClientWrapper ç”¨æ¥åˆ›å»º Zookeeper çš„ ZkClient å®¢æˆ·ç«¯ï¼Œå¹¶è°ƒç”¨ ZkClient API æ“ä½œèŠ‚ç‚¹ä»¥åŠç»‘å®šç›‘å¬å™¨ï¼Œä»£ç å·²ç»è¯¦ç»†æ³¨é‡Šã€‚ä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹ ZkclientZookeeperClient å®ç°ç±»ã€‚ å±æ€§123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960public class ZkclientZookeeperClient extends AbstractZookeeperClient&lt;IZkChildListener&gt; &#123; /** * å°è£…äº† Zookeeper çš„ ZkClient å¯¹è±¡ */ private final ZkClientWrapper client; /** * çŠ¶æ€å¯¹è±¡ */ private volatile KeeperState state = KeeperState.SyncConnected; /** * ZkclientZookeeperClient æ„é€ æ–¹æ³•ä¸»è¦ç”¨äºåˆ›å»ºå’Œå¯åŠ¨ ZkClient å®ä¾‹ * * @param url */ public ZkclientZookeeperClient(URL url) &#123; super(url); // åˆ›å»º ZkClientWrapper ã€åŒ…è£…äº†ZkClient,å®ç°ç›‘å¬ã€‘ client = new ZkClientWrapper(url.getBackupAddress(), 30000); // æ·»åŠ ç›‘å¬å™¨åˆ° ZkClient å¯¹è±¡ client.addListener(new IZkStateListener() &#123; /** * å¤„ç†çŠ¶æ€å˜åŒ– * @param state * @throws Exception */ @Override public void handleStateChanged(KeeperState state) throws Exception &#123; ZkclientZookeeperClient.this.state = state; /** * çŠ¶æ€å˜æ›´è¿›è¡Œå›è°ƒ &#123;@link StateListener#stateChanged(int)&#125; */ if (state == KeeperState.Disconnected) &#123; stateChanged(StateListener.DISCONNECTED); &#125; else if (state == KeeperState.SyncConnected) &#123; stateChanged(StateListener.CONNECTED); &#125; &#125; /** * å¤„ç†æ–°ä¼šè¯ ï¼ˆå¤„ç†å¤±è´¥é‡è¿ï¼‰ï¼Œæœ€ç»ˆä¼šå›è°ƒ&#123;@link StateListener#stateChanged(int)&#125; * @throws Exception */ @Override public void handleNewSession() throws Exception &#123; stateChanged(StateListener.RECONNECTED); &#125; &#125;); // åˆ›å»ºå®¢æˆ·ç«¯ client.start(); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; client å±æ€§å¯¹åº”çš„ ZkClientWrapper ä¸­å°è£…äº† ZkClient å®¢æˆ·ç«¯å¯¹è±¡ï¼Œæ„é€ æ–¹æ³•ä¸»è¦åšäº†ä¸¤ä»¶äº‹ï¼Œåˆ›å»º ZkClient å¹¶ä¸ºå…¶ç»‘å®šçŠ¶æ€ç›‘å¬å™¨ã€‚ æ“ä½œèŠ‚ç‚¹æ–¹æ³•1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465public class ZkclientZookeeperClient extends AbstractZookeeperClient&lt;IZkChildListener&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * è°ƒç”¨ ZkClientWrapper çš„ createPersistent æ–¹æ³•ï¼Œä»¥ä¸‹åŒç† * * @param path */ @Override public void createPersistent(String path) &#123; try &#123; client.createPersistent(path); &#125; catch (ZkNodeExistsException e) &#123; &#125; &#125; @Override public void createEphemeral(String path) &#123; try &#123; client.createEphemeral(path); &#125; catch (ZkNodeExistsException e) &#123; &#125; &#125; @Override public void delete(String path) &#123; try &#123; client.delete(path); &#125; catch (ZkNoNodeException e) &#123; &#125; &#125; @Override public List&lt;String&gt; getChildren(String path) &#123; try &#123; return client.getChildren(path); &#125; catch (ZkNoNodeException e) &#123; return null; &#125; &#125; @Override public boolean checkExists(String path) &#123; try &#123; return client.exists(path); &#125; catch (Throwable t) &#123; &#125; return false; &#125; @Override public boolean isConnected() &#123; return state == KeeperState.SyncConnected; &#125; @Override public void doClose() &#123; client.close(); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; å­èŠ‚ç‚¹ç›‘å¬å™¨12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public class ZkclientZookeeperClient extends AbstractZookeeperClient&lt;IZkChildListener&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * åˆ›å»ºèŠ‚ç‚¹ç›‘å¬å™¨ * * @param path * @param listener * @return */ @Override public IZkChildListener createTargetChildListener(String path, final ChildListener listener) &#123; return new IZkChildListener() &#123; /** * ç›‘å¬çš„å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œæ–¹æ³•ä¸»åŠ¨è°ƒç”¨ ChildListenerçš„åŒ¿åå¯¹è±¡çš„æ–¹æ³• * @param parentPath çˆ¶èŠ‚ç‚¹ * @param currentChilds å­èŠ‚ç‚¹åˆ—è¡¨ * @throws Exception */ @Override public void handleChildChange(String parentPath, List&lt;String&gt; currentChilds) throws Exception &#123; listener.childChanged(parentPath, currentChilds); &#125; &#125;; &#125; /** * ä¸º path èŠ‚ç‚¹ç»‘å®šå­èŠ‚ç‚¹ç›‘å¬å™¨ * * @param path * @param listener pathçš„å­èŠ‚ç‚¹ç›‘å¬å™¨ * @return */ @Override public List&lt;String&gt; addTargetChildListener(String path, final IZkChildListener listener) &#123; return client.subscribeChildChanges(path, listener); &#125; /** * ç§»é™¤ path èŠ‚ç‚¹ç»‘å®šçš„å­èŠ‚ç‚¹ç›‘å¬å™¨ * * @param path * @param listener pathçš„å­èŠ‚ç‚¹ç›‘å¬å™¨ */ @Override public void removeTargetChildListener(String path, IZkChildListener listener) &#123; client.unsubscribeChildChanges(path, listener); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; å®ç°ä¸Šå’Œ Curator å®¢æˆ·ç«¯æœ‰æ‰€å·®åˆ«ï¼Œä½†æœ¬è´¨ä¸Šæ˜¯ç›¸åŒçš„ã€‚ å°ç»“Dubbo ä¸­çš„ Zookeeper å®¢æˆ·ç«¯ä¸»è¦ä¸¤éƒ¨åˆ†æ“ä½œï¼ŒèŠ‚ç‚¹çš„æ“ä½œå’ŒèŠ‚ç‚¹ç›‘å¬å™¨çš„æ“ä½œï¼ŒèŠ‚ç‚¹çš„æ“ä½œä¸»è¦æ˜¯æ³¨å†ŒæœåŠ¡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼ŒèŠ‚ç‚¹ç›‘å¬å™¨çš„æ“ä½œä¸»è¦æ˜¯ç”¨äºè®¢é˜…é€šçŸ¥ï¼Œè®¢é˜…é€šçŸ¥ä¾èµ–æœåŠ¡èŠ‚ç‚¹çš„å…ƒæ•°æ®å˜åŒ–ä¿¡æ¯ï¼Œè¿™æ­£æ˜¯ç›‘å¬å™¨æ¥å®Œæˆçš„ã€‚","categories":[],"tags":[]},{"title":"Dubboæºç åˆ†æ - Zookeeperæ³¨å†Œä¸­å¿ƒ","slug":"rpc/æ³¨å†Œä¸­å¿ƒä¹‹Zookeeper","date":"2020-04-16T16:00:00.000Z","updated":"2020-09-09T15:01:57.349Z","comments":false,"path":"posts/f70c2f2e/","link":"","permalink":"https://gentryhuang.com/posts/f70c2f2e/","excerpt":"","text":"å‰è¨€æ³¨å†Œä¸­å¿ƒæ€»è§ˆ ä¸­ä»‹ç»äº† Dubbo çš„æ³¨å†Œä¸­å¿ƒæŠ½è±¡å±‚ï¼ŒåŒ…æ‹¬æ³¨å†Œä¸­å¿ƒåŠå…¶å·¥å‚ã€‚æœ¬ç¯‡æ–‡ç« å°†ä»‹ç» Dubbo çš„ Zookeeper æ³¨å†Œä¸­å¿ƒåŠå…¶å·¥å‚ã€‚ UML å›¾ä¸­ ZookeeperRegistryFactory ä¸­æœ‰ä¸ª ZookeeperTransporter å±æ€§ï¼Œè¯¥å±æ€§å°±æ˜¯åˆ›å»º Zookeeper å®¢æˆ·ç«¯çš„å…³é”®å¯¹è±¡ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè¯¦ç»†ä»‹ç» Dubbo å¯¹ Zookeeper å®¢æˆ·ç«¯çš„å°è£…ã€‚ Dubbo ä¸­çš„ ZookeeperZookeeper æ˜¯ Apache Hadoop çš„å­é¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªæ ‘å‹çš„ç›®å½•æœåŠ¡ï¼Œæ”¯æŒå˜æ›´æ¨é€ï¼Œé€‚åˆä½œä¸º Dubbo æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œå·¥ä¸šå¼ºåº¦è¾ƒé«˜ï¼Œå¯ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œå¹¶æ¨èä½¿ç”¨ã€‚ä¸‹å›¾æ˜¯ Dubbo ä½¿ç”¨ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„å…ƒæ•°æ®ä¿¡æ¯ï¼š èŠ‚ç‚¹è·¯å¾„è¯´æ˜ Root å±‚ï¼šZookeeperçš„æ ¹ç›®å½•ï¼Œé»˜è®¤æ˜¯ dubbo ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè®¾ç½® Service å±‚ï¼šæœåŠ¡æ¥å£çš„å…¨è·¯å¾„å Type å±‚ï¼šç›®å½•ï¼Œå¯¹äº Dubbo è€Œè¨€å°±æ˜¯åˆ†ç±»ï¼Œç›®å‰ Dubbo æœ‰ 4 ä¸ªåˆ†ç±»ï¼ŒæœåŠ¡æä¾›è€…åˆ—è¡¨ï¼ˆprovidersï¼‰ã€æœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ï¼ˆconsumersï¼‰ã€è·¯ç”±è§„åˆ™åˆ—è¡¨ï¼ˆroutersï¼‰å’Œ é…ç½®è§„åˆ™åˆ—è¡¨(configurators) URL å±‚ï¼šå¯ä»¥æ˜¯æœåŠ¡æä¾›è€… URLã€æœåŠ¡æ¶ˆè´¹è€… URLã€è·¯ç”±è§„åˆ™ URLã€ä»¥åŠé…ç½®è§„åˆ™ URLï¼Œå…·ä½“å“ªç±»ï¼Œçœ‹åœ¨å“ªä¸ª Type å±‚ä¸‹ æµç¨‹ç®€å•è¯´æ˜ï¼š æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶: å‘ /dubbo/com.foo.BarService/providers ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€ æœåŠ¡æ¶ˆè´¹è€…å¯åŠ¨æ—¶: è®¢é˜… /dubbo/com.foo.BarService/providers ç›®å½•ä¸‹çš„æä¾›è€… URL åœ°å€ã€‚å¹¶å‘ /dubbo/com.foo.BarService/consumers ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€ ç›‘æ§ä¸­å¿ƒå¯åŠ¨æ—¶: è®¢é˜… /dubbo/com.foo.BarService ç›®å½•ä¸‹çš„æ‰€æœ‰æä¾›è€…å’Œæ¶ˆè´¹è€… URL åœ°å€ æ³¨æ„ï¼Œä¸Šé¢æè¿°çš„å¹¶ä¸æ˜¯å®Œæ•´çš„æµç¨‹ï¼Œåªæ˜¯æ ¹æ®å›¾è¿›è¡Œç®€å•è¯´æ˜ï¼Œæ¯”å¦‚ï¼ŒæœåŠ¡æä¾›è€…ä¸ä»…å†™å…¥äº†è‡ªå·±çš„ URL åœ°å€ï¼Œè¿˜è®¢é˜…äº† configurators ç›®å½•ä¸‹çš„ URL åœ°å€ï¼Œæ¶ˆè´¹è€…é™¤äº†è®¢é˜… providers ç›®å½•ä¸‹çš„ URL åœ°å€ï¼Œè¿˜è®¢é˜…äº† routers å’Œ configurators ç›®å½•ä¸‹çš„ URL åœ°å€ã€‚ æ”¯æŒä½†ä¸é™äºä»¥ä¸‹åŠŸèƒ½ï¼š å½“æä¾›è€…å‡ºç°æ–­ç”µç­‰å¼‚å¸¸åœæœºæ—¶ï¼Œæ³¨å†Œä¸­å¿ƒèƒ½è‡ªåŠ¨åˆ é™¤æä¾›è€…ä¿¡æ¯ å½“æ³¨å†Œä¸­å¿ƒé‡å¯æ—¶ï¼Œèƒ½è‡ªåŠ¨æ¢å¤æ³¨å†Œæ•°æ®ï¼Œä»¥åŠè®¢é˜…è¯·æ±‚ å½“ä¼šè¯è¿‡æœŸæ—¶ï¼Œèƒ½è‡ªåŠ¨æ¢å¤æ³¨å†Œæ•°æ®ï¼Œä»¥åŠè®¢é˜…è¯·æ±‚ å½“è®¾ç½® &lt;dubbo:registry check=â€falseâ€ /&gt; æ—¶ï¼Œè®°å½•å¤±è´¥æ³¨å†Œå’Œè®¢é˜…è¯·æ±‚ï¼Œåå°å®šæ—¶é‡è¯• å¯é€šè¿‡ &lt;dubbo:registry username=â€adminâ€ password=â€1234â€ /&gt; è®¾ç½® zookeeper ç™»å½•ä¿¡æ¯ å¯é€šè¿‡ &lt;dubbo:registry group=â€dubboâ€ /&gt; è®¾ç½® zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œä¸é…ç½®å°†ä½¿ç”¨é»˜è®¤çš„æ ¹èŠ‚ç‚¹ã€‚ æ”¯æŒ * å·é€šé…ç¬¦ &lt;dubbo:reference group=â€*â€ version=â€*â€ /&gt;ï¼Œå¯è®¢é˜…æœåŠ¡çš„æ‰€æœ‰åˆ†ç»„å’Œæ‰€æœ‰ç‰ˆæœ¬çš„æä¾›è€… ZookeeperRegistryFactoryå®ç° AbstractRegistryFactory æŠ½è±¡ç±»ï¼ŒZookeeperRegistry çš„å·¥å‚ã€‚ 12345678910111213141516171819202122public class ZookeeperRegistryFactory extends AbstractRegistryFactory &#123; /** * zookeeperTransporter ç”± SPI åœ¨è¿è¡Œæ—¶æ³¨å…¥ï¼Œç±»å‹ä¸º ZookeeperTransporter$Adaptiveã€‚ æ˜¯Zookeeperçš„å®¢æˆ·ç«¯å·¥å‚ */ private ZookeeperTransporter zookeeperTransporter; /** * è®¾ç½®Zookeeperå®¢æˆ·ç«¯ å·¥å‚ï¼Œè¯¥æ–¹æ³•é€šè¿‡Dubbo IOC æ³¨å…¥ * * @param zookeeperTransporter */ public void setZookeeperTransporter(ZookeeperTransporter zookeeperTransporter) &#123; this.zookeeperTransporter = zookeeperTransporter; &#125; @Override public Registry createRegistry(URL url) &#123; // åˆ›å»º ZookeeperRegistry return new ZookeeperRegistry(url, zookeeperTransporter); &#125;&#125; ZookeeperRegistryFactory å°±æ˜¯ç”¨æ¥åˆ›å»º ZookeeperRegistry å¯¹è±¡çš„ï¼Œè€Œ ZookeeperRegistry å¯¹è±¡éœ€è¦ä¾èµ–åˆ›å»º Zookeeper å®¢æˆ·ç«¯çš„ ZookeeperTransporter å¯¹è±¡ï¼Œè¯¥å¯¹è±¡æ˜¯é€šè¿‡ Dubbo IOC æ³¨å…¥çš„ï¼Œè¯¦ç»†å¯å‚è€ƒ Dubbo SPI ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ ZookeeperRegistry çš„å®ç°ã€‚ ZookeeperRegistryè¯¥ç±»ç»§æ‰¿æŠ½è±¡ç±» FailbackRegistry ï¼Œå…·æœ‰é‡è¯•åŠŸèƒ½ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879/** * ZookeeperRegistry */public class ZookeeperRegistry extends FailbackRegistry &#123; private final static Logger logger = LoggerFactory.getLogger(ZookeeperRegistry.class); /** * Zookeeper é»˜è®¤ç«¯å£ */ private final static int DEFAULT_ZOOKEEPER_PORT = 2181; /** * Dubbo å…ƒæ•°æ®å†™å…¥Zookeeperä¸Šçš„æ ¹èŠ‚ç‚¹ï¼Œé»˜è®¤å€¼æ˜¯ dubbo */ private final static String DEFAULT_ROOT = \"dubbo\"; /** * Zookeeper æ ¹èŠ‚ç‚¹ */ private final String root; /** * Service æ¥å£å…¨åé›†åˆã€‚è¯¥å±æ€§é€‚åˆç”¨äºç›‘æ§ä¸­å¿ƒï¼Œè®¢é˜…æ•´ä¸ªServiceå±‚ï¼Œå› ä¸ºServiceå±‚æ˜¯åŠ¨æ€çš„ */ private final Set&lt;String&gt; anyServices = new ConcurrentHashSet&lt;String&gt;(); /** * ç›‘å¬å™¨é›†åˆï¼Œå»ºç«‹NotifyListenerå’ŒChildListenerçš„æ˜ å°„å…³ç³»ï¼Œk1ä¸ºè®¢é˜…URL,k2ä¸ºç›‘å¬å™¨,valueä¸ºChildListenerã€çœŸæ­£èµ·ä½œç”¨çš„å¯¹è±¡ã€‘ */ private final ConcurrentMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt; zkListeners = new ConcurrentHashMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt;(); /** * Zookeeper å®¢æˆ·ç«¯ */ private final ZookeeperClient zkClient; public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter) &#123; super(url); if (url.isAnyHost()) &#123; throw new IllegalStateException(\"registry address == null\"); &#125; // è·å–ç»„åï¼Œé»˜è®¤ä¸º 'dubbo'ï¼Œurl.parameters.group å‚æ•°å€¼ï¼Œå³Zookeeperçš„æ ¹èŠ‚ç‚¹ String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT); if (!group.startsWith(Constants.PATH_SEPARATOR)) &#123; // è®¢æ­£è·¯å¾„ï¼š group = \"/\" + group; group = Constants.PATH_SEPARATOR + group; &#125; // ç¡®å®šæ ¹è·¯å¾„ï¼Œä»¥ç»„åä½œä¸ºæ ¹è·¯å¾„ this.root = group; // åˆ›å»º Zookeeper å®¢æˆ·ç«¯ï¼Œé»˜è®¤ä¸º CuratorZookeeperTransporterï¼Œç”±SPIç¡®å®šå…·ä½“çš„å®ä¾‹ã€‚åˆ›å»ºå¥½Zookeeperå®¢æˆ·ç«¯ï¼Œæ„å‘³ç€æ³¨å†Œä¸­å¿ƒçš„åˆ›å»ºå®Œæˆã€ZookeeperæœåŠ¡ç«¯å¿…éœ€å…ˆå¯åŠ¨ï¼ŒDubboåº”ç”¨ä½œä¸ºZookeeperçš„å®¢æˆ·ç«¯è¿›è¡Œè¿æ¥ï¼Œç„¶åæ“ä½œZookeeperã€‘ zkClient = zookeeperTransporter.connect(url); /** * æ·»åŠ  StateListener çŠ¶æ€ç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨åœ¨é‡è¿æ—¶ï¼Œè°ƒç”¨æ¢å¤æ–¹æ³• recover()ï¼Œé‡æ–°å‘èµ·æ³¨å†Œå’Œè®¢é˜…ã€å°†ä¹‹å‰å·²ç»æ³¨å†Œå’Œè®¢é˜…çš„æ•°æ®è¿›è¡Œé‡è¯•ã€‘ * æ³¨æ„ï¼š * StateListener ä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ç›‘å¬å™¨ï¼Œè¿™é‡Œå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ªåŒ¿åå¯¹è±¡ï¼Œå…¶ä¸­çš„ #stateChanged æ–¹æ³•è§¦å‘éœ€è¦ä¸»åŠ¨è°ƒç”¨è¯¥åŒ¿åå¯¹è±¡çš„è¯¥æ–¹æ³• &#123;@link AbstractZookeeperClient#stateChanged(int)&#125; */ zkClient.addStateListener(new StateListener() &#123; @Override public void stateChanged(int state) &#123; if (state == RECONNECTED) &#123; try &#123; recover(); &#125; catch (Exception e) &#123; logger.error(e.getMessage(), e); &#125; &#125; &#125; &#125;); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; doRegister æ³¨å†Œ12345678910111213141516171819202122232425262728/** * ZookeeperRegistry */public class ZookeeperRegistry extends FailbackRegistry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * è°ƒç”¨Zookeeperå®¢æˆ·ç«¯åˆ›å»ºæœåŠ¡èŠ‚ç‚¹ * * @param url */ @Override protected void doRegister(URL url) &#123; try &#123; /** * 1 é€šè¿‡ Zookeeper å®¢æˆ·ç«¯åˆ›å»ºèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹è·¯å¾„ç”± toUrlPath æ–¹æ³•ç”Ÿæˆï¼Œè·¯å¾„æ ¼å¼å¦‚ä¸‹: /$&#123;group&#125;/$&#123;serviceInterface&#125;/&#123;Type&#125;/$&#123;url&#125; * æ¯”å¦‚ï¼š /dubbo/com.alibaba.dubbo.demo.DemoService/providers/dubbo%3A%2F%2F127.0.0.1...... * 2 url.parameters.dynamic ,æ˜¯å¦åŠ¨æ€æ•°æ®ã€‚è‹¥ä¸ºfalseï¼Œè¯¥æ•°æ®ä¸ºæŒä¹…æ•°æ®ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œæ•°æ®ä»ç„¶ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒ */ zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true)); &#125; catch (Throwable e) &#123; throw new RpcException(\"Failed to register \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; è¯¥æ–¹æ³•æ˜¯å®ç°äº†å…¶çˆ¶ç±» FailbackRegistry çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œä½¿ç”¨ Zookeeper å®¢æˆ·ç«¯è¿›è¡ŒèŠ‚ç‚¹çš„åˆ›å»ºã€‚ doUnregister å–æ¶ˆæ³¨å†Œ12345678910111213141516171819202122/** * ZookeeperRegistry */public class ZookeeperRegistry extends FailbackRegistry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * å–æ¶ˆæ³¨å†Œï¼Œåˆ é™¤èŠ‚ç‚¹ * * @param url */ @Override protected void doUnregister(URL url) &#123; try &#123; zkClient.delete(toUrlPath(url)); &#125; catch (Throwable e) &#123; throw new RpcException(\"Failed to unregister \" + url + \" to zookeeper \" + getUrl() + \", cause: \" + e.getMessage(), e); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; è¯¥æ–¹æ³•æ˜¯å®ç°äº†å…¶çˆ¶ç±» FailbackRegistry çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œä½¿ç”¨ Zookeeper å®¢æˆ·ç«¯è¿›è¡ŒèŠ‚ç‚¹çš„åˆ é™¤ã€‚ doSubscribe è®¢é˜…è®¢é˜…æœ‰ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æ˜¯è®¢é˜…æ ¹èŠ‚ç‚¹ä¸‹çš„Serviceå±‚æ•°æ®ï¼Œå¦‚ç›‘æ§ä¸­å¿ƒè®¢é˜…ï¼Œç¬¬äºŒç§æ˜¯è®¢é˜…Serviceå±‚çš„æŸä¸ªæ•°æ®ã€‚ è®¢é˜…æ‰€æœ‰Serviceå±‚èŠ‚ç‚¹12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879public class ZookeeperRegistry extends FailbackRegistry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; @Override protected void doSubscribe(final URL url, final NotifyListener listener) &#123; try &#123; // ----------------- è®¢é˜…æ‰€æœ‰Serviceå±‚çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜… if (Constants.ANY_VALUE.equals(url.getServiceInterface())) &#123; // service å±‚æ˜¯ * // æ ¹æ®èŠ‚ç‚¹ String root = toRootPath(); // è·çš„è®¢é˜…çš„url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url); // ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º if (listeners == null) &#123; zkListeners.putIfAbsent(url, new ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;()); listeners = zkListeners.get(url); &#125; ChildListener zkListener = listeners.get(listener); // ä¸å­˜åœ¨ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»ºChildListenerå¯¹è±¡ if (zkListener == null) &#123; listeners.putIfAbsent(listener, new ChildListener() &#123; /** * èŠ‚ç‚¹å˜åŒ–å›è°ƒï¼Œè¿™é‡Œæ˜¯æ ¹èŠ‚ç‚¹ä¸‹çš„å­èŠ‚ç‚¹æœ‰å˜åŒ–å°±å›è°ƒ * @param parentPath æ ¹èŠ‚ç‚¹ * @param currentChilds æ ¹èŠ‚ç‚¹ä¸‹çš„ service å±‚èŠ‚ç‚¹åˆ—è¡¨ */ @Override public void childChanged(String parentPath, List&lt;String&gt; currentChilds) &#123; // éå† service å±‚èŠ‚ç‚¹åˆ—è¡¨ for (String child : currentChilds) &#123; // è§£ç  child = URL.decode(child); // æ–°å¢Serviceæ¥å£ï¼Œå³æ–°å¢æœåŠ¡ï¼Œåˆ™å‘èµ·è¯¥Serviceå±‚çš„è®¢é˜…ï¼Œèµ°å¦ä¸€ä¸ªåˆ†æ”¯ if (!anyServices.contains(child)) &#123; anyServices.add(child); // å¤„ç† service è®¢é˜… subscribe(url.setPath(child).addParameters(Constants.INTERFACE_KEY, child, Constants.CHECK_KEY, String.valueOf(false)), listener); &#125; &#125; &#125; &#125;); zkListener = listeners.get(listener); &#125; // åˆ›å»ºService èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹ä¸ºæŒä¹…åŒ–èŠ‚ç‚¹ zkClient.create(root, false); // å‘Zookeeper serviceèŠ‚ç‚¹å‘èµ·è®¢é˜… List&lt;String&gt; services = zkClient.addChildListener(root, zkListener); // é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œå¾ªç¯Serviceæ¥å£å…¨åæ•°ç»„ï¼Œå‘èµ·è¯¥Service å±‚çš„è®¢é˜…ï¼Œè°ƒç”¨subscribe(url,listener) if (services != null &amp;&amp; !services.isEmpty()) &#123; for (String service : services) &#123; service = URL.decode(service); anyServices.add(service); subscribe(url.setPath(service).addParameters(Constants.INTERFACE_KEY, service, Constants.CHECK_KEY, String.valueOf(false)), listener); &#125; &#125; &#125; else &#123; // $&#123;æŸä¸ªService å±‚è®¢é˜…&#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; &#125; è¯¥åˆ†æ”¯æ˜¯è®¢é˜…æ ¹èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰Serviceå±‚æ•°æ®ï¼Œå½“Serviceå±‚å‘ç”Ÿå˜æ›´æ—¶ï¼Œè‹¥å˜æ›´çš„æœ‰æ–°å¢Serviceæ¥å£ï¼Œå³æ–°å¢æœåŠ¡ï¼Œåˆ™è°ƒç”¨subscribe(url,listener)æ–¹æ³•å‘èµ·è®¢é˜…ï¼Œèµ°å¤„ç†æŒ‡å®šServiceå±‚èŠ‚ç‚¹çš„é€»è¾‘ã€‚ è®¢é˜…æŒ‡å®šServiceå±‚èŠ‚ç‚¹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475public class ZookeeperRegistry extends FailbackRegistry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; @Override protected void doSubscribe(final URL url, final NotifyListener listener) &#123; try &#123; //----------------- è®¢é˜…æ‰€æœ‰Serviceå±‚çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜… if (Constants.ANY_VALUE.equals(url.getServiceInterface())) &#123; // service å±‚æ˜¯ * // $&#123;æ‰€æœ‰Service å±‚è®¢é˜…&#125; &#125; else &#123; /** * ConcurrentMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt; zkListeners * 1 æ ¹æ®urlè·å–ConcurrentMap&lt;NotifyListener, ChildListener&gt;ï¼Œæ²¡æœ‰å°±åˆ›å»º * 2 æ ¹æ®listenerä»ConcurrentMap&lt;NotifyListener, ChildListener&gt;è·å–ChildListenerï¼Œæ²¡æœ‰å°±åˆ›å»º * 3 åˆ›å»ºpathæŒä¹…åŒ–èŠ‚ç‚¹ * 4 åˆ›å»ºpathå­èŠ‚ç‚¹ç›‘å¬å™¨ */ // å­èŠ‚ç‚¹æ•°æ®æ•°ç»„ List&lt;URL&gt; urls = new ArrayList&lt;URL&gt;(); // å¾ªç¯åˆ†ç±»æ•°ç»„ï¼Œå…¶ä¸­ï¼Œè°ƒç”¨toCategoriesPath(url)æ–¹æ³•ï¼Œè§£æè®¢é˜…urlè·å¾—åˆ†ç±»æ•°ç»„ï¼Œå¦‚ï¼š/dubbo/com.alibaba.dubbo.demo.DemoService/configurators for (String path : toCategoriesPath(url)) &#123; // è·å¾—åˆ†ç±»è·¯å¾„ï¼ˆç”±è®¢é˜…çš„urlå¾—åˆ°çš„ï¼‰ å¯¹åº”çš„ç›‘å¬å™¨æ˜ å°„ ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url); // ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º if (listeners == null) &#123; zkListeners.putIfAbsent(url, new ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;()); listeners = zkListeners.get(url); &#125; /** * è·å¾—listener(NotifyListener)å¯¹åº”çš„ChildListenerå¯¹è±¡ï¼Œæ²¡æœ‰å°±ä¼šåˆ›å»ºã€‚æ³¨æ„ï¼šChildListenerçš„childChangedæ–¹æ³•å®é™…ä¸Šå°±æ˜¯ * å½“parentPath[å³toCategoriesPathæ–¹æ³•å¤„ç†åçš„path]ä¸‹çš„currentChildså‘ç”Ÿå˜åŒ–æ—¶å›è°ƒçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨åˆä¼šå›è°ƒNotifyListener#notifyæ–¹æ³• */ ChildListener zkListener = listeners.get(listener); if (zkListener == null) &#123; listeners.putIfAbsent(listener, new ChildListener() &#123; @Override public void childChanged(String parentPath, List&lt;String&gt; currentChilds) &#123; // å˜æ›´æ—¶ï¼Œè°ƒç”¨ notityæ–¹æ³•ï¼Œå›è°ƒ NotifyListener ZookeeperRegistry.this.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds)); &#125; &#125;); zkListener = listeners.get(listener); &#125; // åˆ›å»º Type èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ï¼Œå¦‚ï¼š /dubbo/com.alibaba.dubbo.demo.DemoService/configurators zkClient.create(path, false); /** * å‘Zookeeper pathèŠ‚ç‚¹å‘èµ·è®¢é˜…ï¼Œ */ List&lt;String&gt; children = zkClient.addChildListener(path, zkListener); // æ·»åŠ åˆ°urls ä¸­ if (children != null) &#123; urls.addAll(toUrlsWithEmpty(url, path, children)); &#125; &#125; /** * é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨NofityListener#notify(url,listener,currentChilds)æ–¹æ³•ï¼Œå›è°ƒNotifyListenerçš„é€»è¾‘ */ notify(url, listener, urls); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; &#125; è®¢é˜…æ—¶æ¶‰åŠåˆ°çš„ç»‘å®šç›‘å¬å™¨ä»¥åŠ ChildListener åŒ¿åå¯¹è±¡æ–¹æ³•å›è°ƒï¼Œä¼šåœ¨ä¸‹ä¸€ç« èŠ‚ Zookeeper å®¢æˆ·ç«¯è¯¦ç»†è¯´æ˜ã€‚è®¢é˜…çš„æ ¸å¿ƒæ˜¯ä¸ºæŒ‡å®šçš„ç±»ç›®ç»‘å®šç›‘å¬å™¨ï¼Œè¯¥ç›‘å¬å™¨ç”¨äºç›‘å¬ç±»ç›®ä¸‹çš„å­èŠ‚ç‚¹å˜åŒ–ï¼Œå‘ç”Ÿå˜åŒ–åˆ™ä¼šè°ƒç”¨ ChildListener åŒ¿åå¯¹è±¡æ–¹æ³•ï¼Œä¼ é€’ç±»ç›®ä¸‹å˜æ›´åçš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œæœ‰ä¸ªè¿™ä¸ªæ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨ï¼Œå°±å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡ŒæœåŠ¡çš„é‡æ–°æš´éœ²ã€æœåŠ¡ç›®å½•é‡æ–°ç”Ÿæˆç­‰ã€‚ doUnsubscribe å–æ¶ˆè®¢é˜…1234567891011121314151617181920212223242526272829303132/** * ZookeeperRegistry */public class ZookeeperRegistry extends FailbackRegistry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * çœŸæ­£å–æ¶ˆè®¢é˜…çš„é€»è¾‘ï¼Œåˆ é™¤å¯¹åº”çš„ç›‘å¬å™¨ * * @param url * @param listener */ @Override protected void doUnsubscribe(URL url, NotifyListener listener) &#123; ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url); if (listeners != null) &#123; ChildListener zkListener = listeners.get(listener); if (zkListener != null) &#123; if (Constants.ANY_VALUE.equals(url.getServiceInterface())) &#123; String root = toRootPath(); zkClient.removeChildListener(root, zkListener); &#125; else &#123; for (String path : toCategoriesPath(url)) &#123; zkClient.removeChildListener(path, zkListener); &#125; &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; è¯¥æ–¹æ³•æ˜¯å®ç°äº†å…¶çˆ¶ç±» FailbackRegistry çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œä½¿ç”¨ Zookeeper å®¢æˆ·ç«¯åˆ é™¤è®¢é˜… URL å¯¹åº”çš„ç›‘å¬å™¨ã€‚ è®¢é˜…æ—¶è¾…åŠ©æ–¹æ³•è·å–Rootå±‚è·¯å¾„123456789101112131415161718192021/** * è·å¾—æ ¹ç›®å½• * root * * @return */ private String toRootDir() &#123; if (root.equals(Constants.PATH_SEPARATOR)) &#123; return root; &#125; return root + Constants.PATH_SEPARATOR; &#125; /** * Root * * @return æ ¹è·¯å¾„ */ private String toRootPath() &#123; return root; &#125; è·å–Serviceå±‚è·¯å¾„12345678910111213/** * è·å¾—æœåŠ¡è·¯å¾„ ï¼Œ Root + service * * @param url * @return */ private String toServicePath(URL url) &#123; String name = url.getServiceInterface(); if (Constants.ANY_VALUE.equals(name)) &#123; return toRootPath(); &#125; return toRootDir() + URL.encode(name); &#125; è·å¾—åˆ†ç±»è·¯å¾„123456789/** * è·å¾—åˆ†ç±»è·¯å¾„ å¦‚ï¼š åˆ° providers/consumers/routes/configurations çš„è·¯å¾„ * * @param url URL * @return åˆ†ç±»è·¯å¾„ */private String toCategoryPath(URL url) &#123; return toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);&#125; è·å¾—URLè·¯å¾„12345678910111213/** * è·å¾—URL è·¯å¾„ï¼Œå³ è¦æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¸Šçš„å®Œæ•´è·¯å¾„ * &lt;p&gt; * Root + Service + Type + URL * &lt;p&gt; * è¢« &#123;@link #doRegister(URL)&#125; å’Œ &#123;@link #doUnregister(URL)&#125; è°ƒç”¨ * * @param url URL * @return è·¯å¾„ */ private String toUrlPath(URL url) &#123; return toCategoryPath(url) + Constants.PATH_SEPARATOR + URL.encode(url.toFullString()); &#125; URLåŒ¹é…12345678910111213141516171819202122232425262728293031/** * è·å¾—providers ä¸­ï¼Œå’Œconsumer åŒ¹é…çš„URLæ•°ç»„ * * @param consumer è®¢é˜…URL å¦‚ï¼šprovider://10.1.22.101:20880/com.alibaba.dubbo.demo.DemoService?key=value&amp;... * @param providers è®¢é˜…URLæ˜ å°„çš„è·¯å¾„çš„å­è·¯å¾„é›†åˆ * @return åŒ¹é…çš„URLæ•°ç»„ */ private List&lt;URL&gt; toUrlsWithoutEmpty(URL consumer, List&lt;String&gt; providers) &#123; List&lt;URL&gt; urls = new ArrayList&lt;URL&gt;(); if (providers != null &amp;&amp; !providers.isEmpty()) &#123; // éå†å­è·¯å¾„ for (String provider : providers) &#123; // è§£ç  provider = URL.decode(provider); // æ˜¯URLçš„è·¯å¾„æ‰ä¼šå¤„ç† if (provider.contains(\"://\")) &#123; // å°†å­—ç¬¦ä¸²è½¬ä¸ºURL URL url = URL.valueOf(provider); // å­è·¯å¾„URLæ˜¯å¦åŒ¹é…è®¢é˜…URLï¼Œä»¥å…³é”®å±æ€§è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŠ¡æ¥å£åã€ç±»ç›®ã€æœåŠ¡groupã€æœåŠ¡versionç­‰ if (UrlUtils.isMatch(consumer, url)) &#123; urls.add(url); &#125; &#125; &#125; &#125; return urls; &#125; ç­›é€‰URL12345678910111213141516171819202122232425/** * 1 ä»providersä¸­ç­›é€‰å’ŒconsumeråŒ¹é…çš„URLé›†åˆ * 2 å¦‚æœURLé›†åˆä¸ä¸ºç©ºï¼Œç›´æ¥è¿”å›è¿™ä¸ªé›†åˆ * 3 å¦‚æœURLé›†åˆä¸ºç©ºï¼Œé¦–å…ˆä»pathä¸­è·å–categoryçš„å€¼ï¼Œç„¶åå°†consumerçš„åè®®æ¢æˆemptyå¹¶æ·»åŠ å‚æ•°category=pathä¸­çš„categoryçš„å€¼ã€‚ * å½¢å¼ï¼š'empty://' çš„URLè¿”å›ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¯ä»¥å¤„ç†ç±»ä¼¼æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µ * * @param consumer è®¢é˜…URL å¦‚ï¼šprovider://10.1.22.101:20880/com.alibaba.dubbo.demo.DemoService?key=value&amp;... * @param path è®¢é˜…URLæ˜ å°„çš„è·¯å¾„ å¦‚ï¼š/dubbo/com.alibaba.dubbo.demo.DemoService/configurators * @param providers è®¢é˜…URLæ˜ å°„çš„è·¯å¾„çš„å­è·¯å¾„é›†åˆ * @return */ private List&lt;URL&gt; toUrlsWithEmpty(URL consumer, String path, List&lt;String&gt; providers) &#123; // ä»providersä¸­ç­›é€‰å’Œconsumer åŒ¹é…çš„URLæ•°ç»„ List&lt;URL&gt; urls = toUrlsWithoutEmpty(consumer, providers); // å¦‚æœä¸å­˜åœ¨åŒ¹é…çš„ï¼Œåˆ™åˆ›å»º 'empty://' çš„URLè¿”å› if (urls == null || urls.isEmpty()) &#123; int i = path.lastIndexOf('/'); String category = i &lt; 0 ? path : path.substring(i + 1); URL empty = consumer.setProtocol(Constants.EMPTY_PROTOCOL).addParameter(Constants.CATEGORY_KEY, category); urls.add(empty); &#125; return urls; &#125; è·å¾—Typeå±‚è·¯å¾„1234567891011121314151617181920212223242526272829303132333435/** * è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„ * Root + Service + Type * * @param url è®¢é˜…URL * @return åˆ†ç±»è·¯å¾„æ•°ç»„ */ private String[] toCategoriesPath(URL url) &#123; String[] categories; // å¦‚æœcategoryçš„å€¼ä¸º * ï¼Œè¡¨ç¤ºåˆ†åˆ«è®¢é˜…ï¼šproviders,consumers,routers,configurators if (Constants.ANY_VALUE.equals(url.getParameter(Constants.CATEGORY_KEY))) &#123; categories = new String[]&#123; Constants.PROVIDERS_CATEGORY, Constants.CONSUMERS_CATEGORY, Constants.ROUTERS_CATEGORY, Constants.CONFIGURATORS_CATEGORY &#125;; &#125; else &#123; // å¦‚æœcategoryçš„å€¼ä¸ä¸º * ï¼Œå°±å–å‡º categoryçš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å€¼ï¼Œå°±æŠŠprovidersä½œä¸ºé»˜è®¤å€¼ã€‚æ³¨æ„ï¼Œå½“categoryçš„å€¼ä¸ä¸ºç©ºæ—¶ä¼šä½¿ç”¨ ',' åˆ†å‰²categoryçš„å€¼ï¼Œä¸ºæ•°ç»„ categories = url.getParameter(Constants.CATEGORY_KEY, new String[]&#123;Constants.DEFAULT_CATEGORY&#125;); &#125; // è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„ String[] paths = new String[categories.length]; for (int i = 0; i &lt; categories.length; i++) &#123; // æ„å»ºåˆ†ç±»è·¯å¾„ paths[i] = toServicePath(url) + Constants.PATH_SEPARATOR + categories[i]; &#125; return paths; &#125; é”€æ¯æ–¹æ³•12345678910111213141516171819/** * ZookeeperRegistry */public class ZookeeperRegistry extends FailbackRegistry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; @Override public void destroy() &#123; super.destroy(); try &#123; // å…³é—­ Zookeeper å®¢æˆ·ç«¯è¿æ¥ zkClient.close(); &#125; catch (Exception e) &#123; logger.warn(\"Failed to close zookeeper client \" + getUrl() + \", cause: \" + e.getMessage(), e); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; é‡å†™äº†çˆ¶ç±» FailbackRegistry çš„é”€æ¯æ–¹æ³•ï¼Œä½¿ç”¨ Zookeeper å®¢æˆ·ç«¯å…³é—­ä¼šè¯ï¼Œè¯¥æ–¹æ³•ä¼šå…ˆè°ƒç”¨çˆ¶ç±»çš„é”€æ¯æ–¹æ³•ã€‚ å°ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº† Dubbo å°è£…çš„ ZookeeperRegistryï¼Œè¯¥æ³¨å†Œä¸­å¿ƒç±»å°†å…·ä½“æ“ä½œä»»åŠ¡äº¤ç»™å†…éƒ¨å°è£…çš„ Zookeeper å®¢æˆ·ç«¯å»å®Œæˆï¼Œè‡ªå·±æœ¬èº«åªæ˜¯å¤„ç† Zookeeper å®¢æˆ·ç«¯æ“ä½œå‰çš„é€»è¾‘ï¼Œå¦‚è°ƒç”¨çˆ¶ç±»æ–¹æ³•ã€è§£æURLçš„æ‰€å±ç±»ç›®ç­‰ï¼Œå…¶ä¸­åˆ›å»º Zookeeper å®¢æˆ·ç«¯çš„ç›´æ¥å…¥å£å°±åœ¨è¯¥ç±»çš„æ„é€ æ–¹æ³•ä¸­ã€‚æ­¤å¤–ï¼Œè¯¥ç±»ä¸­çš„ä¸€äº›æ–¹æ³•æ²¡æœ‰åˆ†æåˆ°ï¼Œå®ƒä»¬å’Œè®¢é˜…ä¸é€šçŸ¥ç›¸å…³ï¼Œä¼šå’Œè®¢é˜…é€šçŸ¥ä¸€èµ·åˆ†æã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"Zookeeper","slug":"Zookeeper","permalink":"https://gentryhuang.com/tags/Zookeeper/"}]},{"title":"Dubboæºç åˆ†æ - æ³¨å†Œä¸­å¿ƒæ€»è§ˆ","slug":"rpc/æ³¨å†Œä¸­å¿ƒæ€»è§ˆ","date":"2020-04-12T16:00:00.000Z","updated":"2020-09-08T04:40:46.418Z","comments":false,"path":"posts/dafcd048/","link":"","permalink":"https://gentryhuang.com/posts/dafcd048/","excerpt":"","text":"å‰è¨€åœ¨ Dubbo ä½“ç³»ä¸­ï¼Œæ³¨å†Œä¸­å¿ƒæ˜¯æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ã€‚Dubbo é€šè¿‡æ³¨å†Œä¸­å¿ƒå®ç°äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸­å„æœåŠ¡ä¹‹é—´çš„æ³¨å†Œä¸å‘ç°ï¼Œæ˜¯å„ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ä¹‹é—´çš„çº½å¸¦ã€‚ä¸»è¦ä½œç”¨å¦‚ä¸‹ï¼š åŠ¨æ€åŠ å…¥ã€‚æœåŠ¡æä¾›æ–¹é€šè¿‡æ³¨å†Œä¸­å¿ƒè®°å½•è‡ªå·±çš„ä¿¡æ¯å¹¶åŠ¨æ€åœ°æŠŠè‡ªå·±æš´éœ²ç»™å…¶ä»–æ¶ˆè´¹è€…ã€‚ åŠ¨æ€å‘ç°ã€‚ä¸€ä¸ªæ¶ˆè´¹è€…å¯ä»¥åŠ¨æ€åœ°æ„ŸçŸ¥æ–°çš„é…ç½®ã€è·¯ç”±è§„åˆ™ã€æ–°çš„æœåŠ¡ï¼Œæ— éœ€é‡æ–°å¯åŠ¨æœåŠ¡ã€‚ åŠ¨æ€è°ƒæ•´ã€‚æ³¨å†Œä¸­å¿ƒæ”¯æŒå‚æ•°çš„åŠ¨æ€è°ƒæ•´ï¼Œæ–°å‚æ•°è‡ªåŠ¨æ›´æ–°åˆ°ç›¸å…³æœåŠ¡èŠ‚ç‚¹ã€‚ å·¥ä½œæµç¨‹ æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶ï¼Œä¼šå‘æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¹¶è®¢é˜…é…ç½®å…ƒæ•°æ®ä¿¡æ¯ã€‚ æ¶ˆè´¹è€…å¯åŠ¨æ—¶ï¼Œä¹Ÿä¼šå‘æ³¨å†Œä¸­å¿ƒå†™å…¥è‡ªå·±çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œå¹¶è®¢é˜…æœåŠ¡æä¾›è€…ã€è·¯ç”±ä¼šé…ç½®å…ƒæ•°æ®ä¿¡æ¯ã€‚ æœåŠ¡æ²»ç†ä¸­å¿ƒ(dubbo-admin)å¯åŠ¨æ—¶ï¼Œä¼šåŒæ—¶è®¢é˜…æ‰€æœ‰æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ã€è·¯ç”±å’Œé…ç½®å…ƒæ•°æ®ä¿¡æ¯ã€‚ æœåŠ¡æä¾›è€…ä¸‹çº¿æˆ–æ–°çš„æœåŠ¡æä¾›è€…åŠ å…¥æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒæœåŠ¡æä¾›è€…ç›®å½•ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå˜åŒ–ä¿¡æ¯ä¼šåŠ¨æ€é€šçŸ¥ç»™æ¶ˆè´¹è€…ã€æœåŠ¡æ²»ç†ä¸­å¿ƒã€‚ æ¶ˆè´¹æ–¹å‘èµ·æœåŠ¡è°ƒç”¨æ—¶ï¼Œä¼šå¼‚æ­¥å°†è°ƒç”¨ã€ç»Ÿè®¡ä¿¡æ¯ç­‰ä¸ŠæŠ¥ç»™ç›‘æ§ä¸­å¿ƒã€‚ æ³¨å†Œä¸­å¿ƒæŠ½è±¡APIDubboæœåŠ¡æš´éœ²ã€æœåŠ¡å¼•ç”¨ä»¥åŠæœåŠ¡è°ƒç”¨ç­‰å‡ ä¹éƒ½ä¼šä½¿ç”¨åˆ°æ³¨å†Œä¸­å¿ƒï¼Œè¿™ç¯‡æ–‡ç« å¯¹Dubbo çš„æ³¨å†Œä¸­å¿ƒæŠ½è±¡APIè¿›è¡Œè¯´æ˜ã€‚ ä¸Šå›¾æ˜¯Dubboçš„æ³¨å†Œä¸­å¿ƒæŠ½è±¡APIä»£ç ç»“æ„å›¾ï¼Œçº¢æ¡†ä¸­çš„ä»£ç éƒ½æ˜¯æŠ½è±¡APIçš„åŸºç¡€ä»£ç ï¼Œé»„æ¡†æ˜¯å…·ä½“çš„æ³¨å†Œä¸­å¿ƒæŠ½è±¡APIã€‚ æ³¨å†Œä¸­å¿ƒæ ¸å¿ƒæŠ½è±¡APIçš„UML UMLå›¾éå¸¸æ¸…æ¥šï¼Œæ³¨å†Œä¸­å¿ƒæ ¸å¿ƒæŠ½è±¡APIä¸­ä¸»è¦æœ‰ä¸‰ä¸ªè§’è‰²ï¼Œæ³¨å†Œä¸­å¿ƒã€æ³¨å†Œä¸­å¿ƒå·¥å‚ã€æ³¨å†Œä¸­å¿ƒçš„ç›‘å¬å™¨ã€‚å®ƒä»¬ä¹‹é—´é‡‡ç”¨ç»§æ‰¿ã€ç»„åˆã€ä»¥åŠå·¥å‚çš„æ–¹å¼è”ç³»åœ¨ä¸€èµ·ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¯¥å›¾ä¸­çš„ ZookeeperRegistry æ³¨å†Œä¸­å¿ƒå®ç°æ²¡æœ‰æ¶‰åŠåˆ°å…·ä½“çš„å®¢æˆ·ç«¯ï¼Œå…³äº Dubbo çš„ Zookeeper å®¢æˆ·ç«¯ä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚ä»UMLå›¾å¯ä»¥çœ‹å‡ºå½“å‰ Dubbo ç‰ˆæœ¬æ”¯æŒå››ç§æ³¨å†Œä¸­å¿ƒçš„å®ç°ã€‚Zookeeper æ˜¯å®˜æ–¹æ¨èçš„æ³¨å†Œä¸­å¿ƒï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æœ‰è¿‡å®é™…ä½¿ç”¨ã€‚Redis æ³¨å†Œä¸­å¿ƒå¹¶æ²¡æœ‰ç»è¿‡é•¿æ—¶é—´è¿è¡Œçš„å¯é æ€§éªŒè¯ï¼Œå…¶ç¨³å®šæ€§ä¾èµ– Redis æœ¬èº«ã€‚Simple æ³¨å†Œä¸­å¿ƒæ˜¯ä¸€ä¸ªç®€å•çš„åŸºäºå†…å­˜çš„æ³¨å†Œä¸­å¿ƒå®ç°ï¼Œå®ƒæœ¬èº«å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„PRCæœåŠ¡ï¼Œä¸æ”¯æŒé›†ç¾¤ã€‚Multicast æ¨¡å—åˆ™ä¸éœ€è¦å¯åŠ¨ä»»ä½•æ³¨å†Œä¸­å¿ƒï¼Œåªè¦é€šè¿‡å¹¿æ’­åœ°å€ï¼Œå°±å¯ä»¥äº’ç›¸å‘ç°ï¼Œä¸æ¨èç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ä¸‹é¢åˆ†åˆ«ä»‹ç»è¯¥UMLå›¾ä¸­æ¶‰åŠåˆ°çš„ç»„ä»¶ã€‚ Node12345678910111213141516171819202122public interface Node &#123; /** * è·å–URL * * @return url. */ URL getUrl(); /** * æ˜¯å¦å¯ç”¨ * * @return available. */ boolean isAvailable(); /** * é”€æ¯ */ void destroy();&#125; Node æ¥å£æ˜¯ä¸€ä¸ªé¡¶çº§æ¥å£ï¼ŒDubbo ä¸­çš„æ ¸å¿ƒç»„ä»¶å‡ ä¹éƒ½ç»§æ‰¿è¯¥æ¥å£ï¼Œåªå°è£…äº†ä¸‰ä¸ªå’ŒèŠ‚ç‚¹ç›¸å…³çš„æ–¹æ³•ã€‚ RegistryService123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public interface RegistryService &#123; /** * æ³¨å†Œæ•°æ®ï¼Œå¦‚ï¼šæä¾›è€…åœ°å€ï¼Œæ¶ˆè´¹è€…åœ°å€ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™ç­‰æ•°æ® * * @param url Registration information , is not allowed to be empty, e.g: dubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin */ void register(URL url); /** * å–æ¶ˆæ³¨å†Œæ•°æ® * * @param url Registration information , is not allowed to be empty, e.g: dubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin */ void unregister(URL url); /** * è®¢é˜…ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œå½“æœ‰æ³¨å†Œæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ¨é€ã€‚åœ¨ URLçš„category å±æ€§ä¸Šï¼Œè¡¨ç¤ºè®¢é˜…çš„æ•°æ®åˆ†ç±»ã€‚ç›®å‰æœ‰å››ç§ç±»å‹ï¼š * 1 consumers æœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ * 2 providers æœåŠ¡æä¾›è€…åˆ—è¡¨ * 3 routers è·¯ç”±è§„åˆ™åˆ—è¡¨ * 4 configurations é…ç½®è§„åˆ™åˆ—è¡¨ * * @param url Subscription condition, not allowed to be empty, e.g. consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin * @param listener A listener of the change event, not allowed to be empty * */ void subscribe(URL url, NotifyListener listener); /** * å–æ¶ˆè®¢é˜… * * @param url Subscription condition, not allowed to be empty, e.g. consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin * @param listener A listener of the change event, not allowed to be empty * */ void unsubscribe(URL url, NotifyListener listener); /** * æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ® * * @param url Query condition, is not allowed to be empty, e.g. consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin * @return The registered information list, which may be empty, the meaning is the same as the parameters of &#123;@link com.alibaba.dubbo.registry.NotifyListener#notify(List&lt;URL&gt;)&#125;. * @see com.alibaba.dubbo.registry.NotifyListener#notify(List) */ List&lt;URL&gt; lookup(URL url);&#125; RegistryService æ¥å£ä¹Ÿæ˜¯ä¸€ä¸ªé¡¶çº§æ¥å£ï¼Œæ˜¯æ³¨å†Œä¸­å¿ƒæœåŠ¡æ¥å£ï¼Œå®šä¹‰äº†èŠ‚ç‚¹çš„æ³¨å†Œ/åæ³¨å†Œã€è®¢é˜…/åè®¢é˜…ä»¥åŠæŸ¥è¯¢ä¸‰ç§æ“ä½œæ–¹æ³•ã€‚ Registry12345678/** * Registry. (SPI, Prototype, ThreadSafe) * * @see com.alibaba.dubbo.registry.RegistryFactory#getRegistry(com.alibaba.dubbo.common.URL) * @see com.alibaba.dubbo.registry.support.AbstractRegistry */public interface Registry extends Node, RegistryService &#123;&#125; æ³¨å†Œä¸­å¿ƒæ¥å£ï¼Œè¯¥æ¥å£ä¸­æ²¡æœ‰å®šä¹‰æ–¹æ³•åªæ˜¯ç»§æ‰¿äº† Node å’Œ RegistryService æ¥å£ï¼Œå› æ­¤å…·å¤‡äº†æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ç­‰æ“ä½œï¼Œæ³¨å†Œä¸­å¿ƒå…·ä½“å®ç°éƒ½è¦ç»§æ‰¿è¯¥æ¥å£ã€‚ AbstractRegistryRegistry çš„æŠ½è±¡ç±»ï¼Œå®ç°äº†é€šç”¨çš„æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ä»¥åŠé€šçŸ¥ç­‰æ–¹æ³•ã€‚å…¶ä¸­ï¼Œå®ç°äº†æ³¨å†Œæ•°æ®æŒä¹…åŒ–åˆ°æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶ä¸»è¦ç”¨äºå½“æ¶ˆè´¹è€…æ— æ³•ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡æä¾›è€…åˆ—è¡¨ä¿¡æ¯æ—¶å°±ä»è¯¥æ–‡ä»¶ä¸­è·å–ï¼Œæ”¯æŒäº†å³ä½¿æ³¨å†Œä¸­å¿ƒå®•æœºæ¶ˆè´¹è€…ä»ç„¶å¯ä»¥å’Œæä¾›è€…é€šä¿¡ã€‚ å±æ€§123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103public abstract class AbstractRegistry implements Registry &#123; // Log output protected final Logger logger = LoggerFactory.getLogger(getClass()); // URLåœ°å€åˆ†å‰²ç¬¦ï¼Œç”¨äºæ–‡ä»¶ç¼“å­˜ä¸­ï¼Œåˆ†å‰²URL private static final char URL_SEPARATOR = ' '; // URLåœ°å€åˆ†éš”æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºè§£ææ–‡ä»¶ç¼“å­˜ä¸­URLåˆ—è¡¨ private static final String URL_SPLIT = \"\\\\s+\"; /** * æœ¬åœ°ç£ç›˜ç¼“å­˜ * 1 å…¶ä¸­ç‰¹æ®Šçš„ keyå€¼ .registries è®°å½•æ³¨å†Œä¸­å¿ƒåˆ—è¡¨ï¼Œ å…¶ä»–çš„å‡ä¸º&#123;@link #notified&#125; æœåŠ¡æä¾›è€…åˆ—è¡¨ * 2 æ•°æ®æµå‘ï¼š åˆ›å»ºæ³¨å†Œä¸­å¿ƒå®ä¾‹æ—¶ä»fileè¯»å–æ•°æ®åˆ° propertiesä¸­ï¼›ç›‘å¬åˆ°æ³¨å†Œä¸­å¿ƒæ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œä¿®æ”¹propertieså¯¹åº”çš„å€¼ï¼Œå¹¶å†™å…¥file * 3 æ•°æ®çš„é”®-å€¼å¯¹ * ï¼ˆ1ï¼‰å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”®ä¸ºè®¢é˜…è€…çš„æœåŠ¡é”® &#123;@link URL#getServiceKey()&#125;,å€¼ä¸ºæœåŠ¡æä¾›è€…åˆ—è¡¨/è·¯ç”±è§„åˆ™åˆ—è¡¨/é…ç½®è§„åˆ™åˆ—è¡¨ * ï¼ˆ2ï¼‰ç‰¹æ®Šæƒ…å†µä¸‹æ˜¯ .registries */ // Local disk cache, where the special key value.registies records the list of registry centers, and the others are the list of notified service providers private final Properties properties = new Properties(); /** * æ³¨å†Œä¸­å¿ƒæ•°æ®ç¼“å­˜çº¿ç¨‹æ±  */ private final ExecutorService registryCacheExecutor = Executors.newFixedThreadPool(1, new NamedThreadFactory(\"DubboSaveRegistryCache\", true)); /** * propertieså‘ç”Ÿå˜æ›´æ—¶ï¼Œæ˜¯å¦åŒæ­¥å†™å…¥æ–‡ä»¶ */ private final boolean syncSaveFile; /** * æ•°æ®ç‰ˆæœ¬å· &#123;@link #properties&#125;ï¼Œç”¨äºå¹¶å‘å¤„ç† */ private final AtomicLong lastCacheChanged = new AtomicLong(); /** * å·²æ³¨å†Œ URL é›†åˆ */ private final Set&lt;URL&gt; registered = new ConcurrentHashSet&lt;URL&gt;(); /** * è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ */ private final ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = new ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(); /** * é€šçŸ¥çš„URLåˆ°ç›‘å¬å™¨ç›‘å¬åˆ°æ•°æ®å˜åŒ–åçš„ ç»“æœURLé›†åˆ * key1: è®¢é˜…çš„URLï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„URLï¼Œå’Œ &#123;@link #subscribed&#125; çš„é”®ä¸€è‡´ * key2: åˆ†ç±»ï¼Œå¦‚ï¼š providers,consumers,routes,configuratorsã€‚ã€ä¸€èˆ¬æ˜¯æ— consumers,å› ä¸ºæ¶ˆè´¹è€…ä¸ä¼šå»è®¢é˜…å¦å¤–çš„æ¶ˆè´¹è€…çš„åˆ—è¡¨ * value: æ–°çš„URLé›†åˆ */ private final ConcurrentMap&lt;URL, Map&lt;String, List&lt;URL&gt;&gt;&gt; notified = new ConcurrentHashMap&lt;URL, Map&lt;String, List&lt;URL&gt;&gt;&gt;(); /** * æ³¨å†Œä¸­å¿ƒ URL */ private URL registryUrl; /** * ç¼“å­˜æ•°æ®çš„ç£ç›˜æ–‡ä»¶ */ private File file; /** * æ„é€ æ–¹æ³•ï¼Œæ¯æ¬¡åˆ›å»ºæ³¨å†Œä¸­å¿ƒéƒ½ä¼šåŒæ­¥ç£ç›˜æ–‡ä»¶æ•°æ®åˆ°ç¼“å­˜ä¸­ * @param url */ public AbstractRegistry(URL url) &#123; setUrl(url); /** * å¯ä»¥æŒ‡å®šæ³¨å†Œä¸­å¿ƒç£ç›˜ç¼“å­˜æ–‡ä»¶ï¼Œé…ç½®æ–¹å¼ï¼š * 1 ä½¿ç”¨fileå±æ€§æŒ‡å®š &lt;dubbo:registry address=\"xxx\" file=\"/opt/xxx\"/&gt; * 2 ä½¿ç”¨save.fileå±æ€§æŒ‡å®š &lt;dubbo:registry address=\"xxx\" save.file=\"/opt/xxx\"/&gt; * 3 ä¸æ˜¾ç¤ºæŒ‡å®šçš„è¯ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼šSystem.getProperty(\"user.home\") + \"/.dubbo/dubbo-registry-\" + åº”ç”¨å + \"-\" + url.getAddress() + \".cache\" */ // Start file save timer syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false); // è·å¾— file String filename = url.getParameter(Constants.FILE_KEY, System.getProperty(\"user.home\") + \"/.dubbo/dubbo-registry-\" + url.getParameter(Constants.APPLICATION_KEY) + \"-\" + url.getAddress() + \".cache\"); File file = null; if (ConfigUtils.isNotEmpty(filename)) &#123; file = new File(filename); if (!file.exists() &amp;&amp; file.getParentFile() != null &amp;&amp; !file.getParentFile().exists()) &#123; if (!file.getParentFile().mkdirs()) &#123; throw new IllegalArgumentException(\"Invalid registry store file \" + file + \", cause: Failed to create directory \" + file.getParentFile() + \"!\"); &#125; &#125; &#125; this.file = file; // åŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜ï¼Œå³ properties.load(in)ï¼Œåˆ°propertieså±æ€§ä¸­ loadProperties(); // é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœ ã€‚ ä¸ºä»€ä¹ˆæ„é€ æ–¹æ³•è¦é€šçŸ¥ï¼Œzkè¿æ¥éƒ½æ²¡æœ‰å»ºç«‹ï¼Œç›‘å¬å™¨æ›´æ²¡æœ‰æ³¨å†Œï¼Œå³ subscribed é‡Œé¢è¿˜æ²¡æœ‰å€¼ notify(url.getBackupUrls()); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; AbstractRegistry æŠ½è±¡ç±»ä¸­çš„å±æ€§å¤§è‡´æœ‰å››ç±»ï¼Œæ³¨å†Œçš„URLã€ç¼“å­˜æ•°æ®ç›¸å…³çš„ã€è®¢é˜…URLçš„ç›‘å¬å™¨ã€é€šçŸ¥URLå¯¹åº”çš„å˜æ›´URLã€‚å…¶ä¸­æ„é€ æ–¹æ³•ä¼šåŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ä¸­ã€‚ æ³¨å†Œ/åæ³¨å†Œ123456789101112131415161718192021222324252627282930313233343536373839public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * å…ˆæ·»åŠ åˆ° registered ç¼“å­˜ä¸­ï¼Œè¿›è¡ŒçŠ¶æ€çš„ç»´æŠ¤ã€‚å†ç”±å­ç±» FailbackRegistryç±» çœŸæ­£æ³¨å†Œ * * @param url Registration information , is not allowed to be empty, e.g: dubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin */ @Override public void register(URL url) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"register url == null\"); &#125; if (logger.isInfoEnabled()) &#123; logger.info(\"Register: \" + url); &#125; registered.add(url); &#125; /** * å…ˆä» registered ç¼“å­˜ä¸­ç§»é™¤ï¼Œå†ç”±å­ç±» FailbackRegistry çœŸæ­£å–æ¶ˆæ³¨å†Œ * * @param url Registration information , is not allowed to be empty, e.g: dubbo://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin */ @Override public void unregister(URL url) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"unregister url == null\"); &#125; if (logger.isInfoEnabled()) &#123; logger.info(\"Unregister: \" + url); &#125; registered.remove(url); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; AbstractRegistry æŠ½è±¡ç±»ä¸­çš„æ³¨å†Œå’Œåæ³¨å†Œæ–¹æ³•åªæ˜¯æ“ä½œç¼“å­˜ï¼ŒçœŸæ­£çš„å®ç°äº¤ç»™å­ç±» FailbackRegistry å®Œæˆã€‚ è®¢é˜…/åè®¢é˜…1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * å…ˆç¼“å­˜åˆ° subscribed ä¸­ï¼Œå†é€šè¿‡å­ç±» FailbackRegistry å…·ä½“æ‰§è¡Œè®¢é˜…é€»è¾‘ * * @param url è®¢é˜…æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.10.10.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin * @param listener å˜æ›´äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸å…è®¸ä¸ºç©º */ @Override public void subscribe(URL url, NotifyListener listener) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"subscribe url == null\"); &#125; if (listener == null) &#123; throw new IllegalArgumentException(\"subscribe listener == null\"); &#125; if (logger.isInfoEnabled()) &#123; logger.info(\"Subscribe: \" + url); &#125; /** * 1 ä»ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribedä¸­è·å–keyä¸ºurlçš„é›†åˆSet&lt;NotifyListener&gt; * 2 å¦‚æœè¯¥é›†åˆå­˜åœ¨ï¼Œç›´æ¥å°†å½“å‰çš„NotifyListenerå®ä¾‹å­˜å…¥è¯¥é›†åˆ,å¦‚æœé›†åˆä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºï¼Œä¹‹åæ”¾å…¥subscribedä¸­ï¼Œå¹¶å°†å½“å‰çš„NotifyListenerå®ä¾‹å­˜å…¥åˆšåˆšåˆ›å»ºçš„é›†åˆ */ Set&lt;NotifyListener&gt; listeners = subscribed.get(url); if (listeners == null) &#123; subscribed.putIfAbsent(url, new ConcurrentHashSet&lt;NotifyListener&gt;()); listeners = subscribed.get(url); &#125; listeners.add(listener); &#125; /** * å…ˆä»ç¼“å­˜ä¸­ç§»é™¤ï¼Œå†é€šè¿‡å­ç±» FailbackRegistry å…·ä½“æ‰§è¡Œå–æ¶ˆè®¢é˜…çš„é€»è¾‘ * * @param url Subscription condition, not allowed to be empty, e.g. consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin * @param listener A listener of the change event, not allowed to be empty */ @Override public void unsubscribe(URL url, NotifyListener listener) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"unsubscribe url == null\"); &#125; if (listener == null) &#123; throw new IllegalArgumentException(\"unsubscribe listener == null\"); &#125; if (logger.isInfoEnabled()) &#123; logger.info(\"Unsubscribe: \" + url); &#125; Set&lt;NotifyListener&gt; listeners = subscribed.get(url); if (listeners != null) &#123; listeners.remove(listener); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; AbstractRegistry æŠ½è±¡ç±»ä¸­çš„è®¢é˜…å’Œåè®¢é˜…æ–¹æ³•åªæ˜¯æ“ä½œç¼“å­˜ï¼ŒçœŸæ­£çš„å®ç°äº¤ç»™å­ç±» FailbackRegistry å®Œæˆã€‚ æ–­çº¿é‡è¿12345678910111213141516171819202122232425262728293031323334353637public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * å’Œæ³¨å†Œä¸­å¿ƒæ–­å¼€ï¼Œé‡è¿æˆåŠŸä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ¢å¤æ³¨å†Œå’Œè®¢é˜… * * @throws Exception */ protected void recover() throws Exception &#123; // register Set&lt;URL&gt; recoverRegistered = new HashSet&lt;URL&gt;(getRegistered()); if (!recoverRegistered.isEmpty()) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Recover register url \" + recoverRegistered); &#125; for (URL url : recoverRegistered) &#123; // æ”¾å…¥ç¼“å­˜ register(url); &#125; &#125; // subscribe Map&lt;URL, Set&lt;NotifyListener&gt;&gt; recoverSubscribed = new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(getSubscribed()); if (!recoverSubscribed.isEmpty()) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Recover subscribe url \" + recoverSubscribed.keySet()); &#125; for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : recoverSubscribed.entrySet()) &#123; URL url = entry.getKey(); for (NotifyListener listener : entry.getValue()) &#123; subscribe(url, listener); &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; AbstractRegistry æŠ½è±¡ç±»ä¸­çš„æ–­çº¿é‡è¿é€»è¾‘æ˜¯ï¼Œä¸æ³¨å†Œä¸­å¿ƒæ–­å¼€åé‡æ–°è¿æ¥æ—¶ä¼šä»ç¼“å­˜ä¸­å–å‡ºå·²ç»æ³¨å†Œçš„URLé›†åˆï¼Œç„¶åæ”¾å…¥ç¼“å­˜ï¼Œè®¢é˜…åŒç†ã€‚ é€šçŸ¥1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /* * è®¢é˜…URLæ˜ å°„çš„èŠ‚ç‚¹å¯¹åº”çš„å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé€šçŸ¥ç›‘å¬å™¨ * @param url è®¢é˜…URL * @param listener ç›‘å¬å™¨ * @param urls è®¢é˜…URLæ˜ å°„çš„è·¯å¾„ä¸‹çš„å­è·¯å¾„é›†åˆï¼ˆå…¨é‡æ•°æ®ï¼‰ */ protected void notify(URL url, NotifyListener listener, List&lt;URL&gt; urls) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"notify url == null\"); &#125; if (listener == null) &#123; throw new IllegalArgumentException(\"notify listener == null\"); &#125; if ((urls == null || urls.isEmpty()) &amp;&amp; !Constants.ANY_VALUE.equals(url.getServiceInterface())) &#123; logger.warn(\"Ignore empty notify urls for subscribe url \" + url); return; &#125; if (logger.isInfoEnabled()) &#123; logger.info(\"Notify urls for subscribe url \" + url + \", urls: \" + urls); &#125; // 1 å°† `urls` æŒ‰ç…§ URLä¸­çš„ 'category` å‚æ•°è¿›è¡Œåˆ†ç±»ï¼Œæ·»åŠ åˆ°Mapé›†åˆresultä¸­ Map&lt;String, List&lt;URL&gt;&gt; result = new HashMap&lt;String, List&lt;URL&gt;&gt;(); // éå† for (URL u : urls) &#123; // å­è·¯å¾„URLæ˜¯å¦åŒ¹é…è®¢é˜…URL if (UrlUtils.isMatch(url, u)) &#123; // è·å–åˆ†ç±»ï¼Œé»˜è®¤ä¸º providers String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY); // åŠ å…¥åˆ°ç»“æœé›† List&lt;URL&gt; categoryList = result.get(category); if (categoryList == null) &#123; categoryList = new ArrayList&lt;URL&gt;(); result.put(category, categoryList); &#125; categoryList.add(u); &#125; &#125; if (result.size() == 0) &#123; return; &#125; // è·å¾—è®¢é˜…URLå¯¹åº”çš„ç¼“å­˜`notified`,å³é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ï¼Œä¼šæŠŠresultä¸­çš„å€¼æ”¾å…¥åˆ° categoryNotifiedä¸­ Map&lt;String, List&lt;URL&gt;&gt; categoryNotified = notified.get(url); if (categoryNotified == null) &#123; notified.putIfAbsent(url, new ConcurrentHashMap&lt;String, List&lt;URL&gt;&gt;()); categoryNotified = notified.get(url); &#125; // å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ï¼Œå³æŒ‰ç…§åˆ†ç±»ï¼Œå¾ªç¯å¤„ç†é€šçŸ¥çš„URLå˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ for (Map.Entry&lt;String, List&lt;URL&gt;&gt; entry : result.entrySet()) &#123; // è·å¾—åˆ†ç±»å String category = entry.getKey(); // è·å¾—åˆ†ç±»åå¯¹åº”çš„é€šçŸ¥ULRåˆ—è¡¨ List&lt;URL&gt; categoryList = entry.getValue(); // 1 å°†result è¦†ç›–åˆ° `notified`ç¼“å­˜ã€æ›´æ–°notifiedé›†åˆä¸­çš„é€šçŸ¥ULRåˆ—è¡¨ã€‘ï¼Œéœ€è¦æ³¨æ„ï¼šå½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰URLï¼Œå¦‚ empty://...` ï¼Œé€šè¿‡è¿™ç§æ–¹å¼ç»Ÿä¸€å¤„ç†æ‰€æœ‰è®¢é˜…URLå¯¹åº”çš„æ•°æ®ä¸ºç©ºçš„æƒ…å†µã€‚ categoryNotified.put(category, categoryList); // 2 ä¿å­˜è®¢é˜…urlå¯¹åº”çš„è¢«é€šçŸ¥çš„URLåˆ° propertieså’Œæ–‡ä»¶ ä¸­ // åœ¨å¾ªç¯ä¸­çš„ä¿å­˜çš„åŸå› æ˜¯ï¼Œè®¢é˜…urlå¯¹åº”çš„é€šçŸ¥urlå¯èƒ½æ˜¯å˜åŠ¨çš„ï¼Œä¸Šä¸€æ­¥çš„æ“ä½œä¼šæ›´æ–°notifiedé›†åˆï¼Œä¸ºäº†è®© propertieså’Œæ–‡ä»¶ä¸­çš„ è®¢é˜…-é€šçŸ¥å…³ç³»æ­£ç¡®å°±éœ€è¦ä¸æ–­æ›´æ–°ã€‚ saveProperties(url); // 3 è°ƒç”¨ä¼ å…¥çš„listenerçš„notify()æ–¹æ³• listener.notify(categoryList); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·è®¢é˜…åï¼Œä¼šè·å–åˆ°è®¢é˜…URLæ‰€å¯¹åº”çš„å…¨é‡æ•°æ®ï¼Œæ¥ç€è°ƒç”¨è¯¥ä¸Šè¿°æ–¹æ³•ï¼›å½“æ³¨å†Œä¸­å¿ƒç›‘æ§çš„æ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œä¼šè°ƒç”¨ä¸Šè¿°æ–¹æ³•ï¼Œè™½ç„¶å˜åŒ–çš„æ˜¯å¢é‡çš„ï¼Œä½†æ˜¯ä»æ³¨å†Œä¸­å¿ƒæ‹‰å–çš„æ˜¯å…¨é‡çš„æ•°æ®ï¼Œå³æœ€æ–°çš„æ•°æ®ã€‚è¯¥æ–¹æ³•çš„ä½¿ç”¨ä¸»è¦åœ¨æœåŠ¡æš´éœ²è¿‡ç¨‹ä¸­æœåŠ¡æä¾›è€…è®¢é˜…é…ç½®ä¿¡æ¯ï¼Œä¾¿äºé…ç½®å‘ç”Ÿæ”¹å˜æ—¶é€šè¿‡ç›‘å¬å™¨è¿›è¡Œæ•æ‰ç„¶åå›è°ƒè¯¥æ–¹æ³•ï¼Œæœ€ç»ˆå®ŒæˆæœåŠ¡é‡æ–°æš´éœ²ã€‚åœ¨æœåŠ¡å¼•ç”¨è¿‡ç¨‹ä¸­æ¶ˆè´¹è€…è®¢é˜…æœåŠ¡ä¿¡æ¯ã€é…ç½®ä¿¡æ¯ç­‰æœ€ç»ˆå®ŒæˆæœåŠ¡å¼•ç”¨ã€‚è¯¥æ–¹æ³•åœ¨ Dubbo æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…å‘æŒ¥é‡è¦çš„ä½œç”¨ï¼Œåœ¨åˆ†æå®ŒæœåŠ¡æš´éœ²å’ŒæœåŠ¡å¼•ç”¨åä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è¯¦ç»†è¯´æ˜ã€‚ é”€æ¯12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; @Override public void destroy() &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Destroy registry:\" + getUrl()); &#125; // å–æ¶ˆæ³¨å†Œé€»è¾‘ Set&lt;URL&gt; destroyRegistered = new HashSet&lt;URL&gt;(getRegistered()); if (!destroyRegistered.isEmpty()) &#123; for (URL url : new HashSet&lt;URL&gt;(getRegistered())) &#123; if (url.getParameter(Constants.DYNAMIC_KEY, true)) &#123; try &#123; // å–æ¶ˆæ³¨å†Œï¼Œæ“ä½œç¼“å­˜ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±» unregister(url); if (logger.isInfoEnabled()) &#123; logger.info(\"Destroy unregister url \" + url); &#125; &#125; catch (Throwable t) &#123; logger.warn(\"Failed to unregister url \" + url + \" to registry \" + getUrl() + \" on destroy, cause: \" + t.getMessage(), t); &#125; &#125; &#125; &#125; // å–æ¶ˆè®¢é˜…ï¼Œæ“ä½œç¼“å­˜ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±» Map&lt;URL, Set&lt;NotifyListener&gt;&gt; destroySubscribed = new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(getSubscribed()); if (!destroySubscribed.isEmpty()) &#123; for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : destroySubscribed.entrySet()) &#123; // è®¢é˜…URL URL url = entry.getKey(); // è®¢é˜…URLå¯¹åº”çš„ç›‘å¬å™¨åˆ—è¡¨ for (NotifyListener listener : entry.getValue()) &#123; try &#123; // å–æ¶ˆè®¢é˜… unsubscribe(url, listener); if (logger.isInfoEnabled()) &#123; logger.info(\"Destroy unsubscribe url \" + url); &#125; &#125; catch (Throwable t) &#123; logger.warn(\"Failed to unsubscribe url \" + url + \" to registry \" + getUrl() + \" on destroy, cause: \" + t.getMessage(), t); &#125; &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; ä¸»è¦æ˜¯å–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºæ˜¯æœåŠ¡æä¾›è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œéƒ½ä¼šå‘Registryå‘èµ·æ³¨å†Œå’Œè®¢é˜…ï¼Œæ‰€ä»¥åœ¨JVMå…³é—­ç¤ºï¼Œéƒ½è¦è¿›è¡Œå–æ¶ˆã€‚ ä¿å­˜è®¢é˜…å˜æ›´æ•°æ®123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * * @param url è®¢é˜…URL */ private void saveProperties(URL url) &#123; if (file == null) &#123; return; &#125; try &#123; StringBuilder buf = new StringBuilder(); // notified ç¼“å­˜çš„å€¼ï¼š è®¢é˜…URL å¯¹åº”çš„æ˜ å°„é›†åˆï¼Œåªè¦è®¢é˜…URLå…³è”çš„è·¯å¾„ä¸‹æœ‰èŠ‚ç‚¹å˜åŒ–ï¼Œå°±ä¼šä¸æ–­åˆ·æ–°ï¼Œæœ€æ–°æœ€å…¨æ•°æ®ã€‚ Map&lt;String, List&lt;URL&gt;&gt; categoryNotified = notified.get(url); if (categoryNotified != null) &#123; for (List&lt;URL&gt; us : categoryNotified.values()) &#123; for (URL u : us) &#123; if (buf.length() &gt; 0) &#123; buf.append(URL_SEPARATOR); &#125; buf.append(u.toFullString()); &#125; &#125; &#125; properties.setProperty(url.getServiceKey(), buf.toString()); // ç‰ˆæœ¬å·ï¼Œä½¿ç”¨CAS long version = lastCacheChanged.incrementAndGet(); // ä¿å­˜å˜æ›´æ•°æ®åˆ°ç£ç›˜æ–‡ä»¶ if (syncSaveFile) &#123; doSaveProperties(version); &#125; else &#123; registryCacheExecutor.execute(new SaveProperties(version)); &#125; &#125; catch (Throwable t) &#123; logger.warn(t.getMessage(), t); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; è¯¥æ–¹æ³•ç”¨äºä¿å­˜è®¢é˜…URLå¯¹åº”çš„å˜æ›´æ•°æ®å…ˆåˆ°å†…å­˜ä¸­çš„ Properties ä¸­ï¼Œç„¶ååœ¨åŒæ­¥æˆ–å¼‚æ­¥ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼ŒåŒæ­¥æˆ–å¼‚æ­¥æ ¹æ® syncSaveFile å‚æ•°å€¼ã€‚æ¥ç€åˆ†æä¿å­˜å˜æ›´æ•°æ®åˆ°ç£ç›˜æ–‡ä»¶ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * @param version ç‰ˆæœ¬å· */ public void doSaveProperties(long version) &#123; /** * å®‰å…¨æªæ–½ï¼š * 1 CASåˆ¤æ–­ï¼š * åœ¨saveProperties(URL url)æ–¹æ³•ä¸­æ‰§è¡Œäº†long version = lastCacheChanged.incrementAndGet(); * è¿™é‡Œè¿›è¡Œif (version &lt; lastCacheChanged.get())åˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹åœ¨è¿›è¡ŒdoSaveProperties(long version)æ—¶ï¼Œ * å·²ç»æœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº†saveProperties(URL url)ï¼Œé©¬ä¸Šå°±è¦æ‰§è¡ŒdoSaveProperties(long version)ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹æ”¾å¼ƒæ“ä½œï¼Œè®©åè¾¹çš„è¿™ä¸ªçº¿ç¨‹æ¥åšä¿å­˜æ“ä½œã€‚ * 2 æ–‡ä»¶é” FileLockï¼š * FileLock æ˜¯è¿›ç¨‹æ–‡ä»¶é”ï¼Œç”¨äºè¿›ç¨‹é—´å¹¶å‘ï¼Œæ§åˆ¶ä¸åŒç¨‹åºï¼ˆJVMï¼‰å¯¹åŒä¸€æ–‡ä»¶çš„å¹¶å‘è®¿é—®ï¼Œæ–‡ä»¶é”å¯ä»¥è§£å†³å¤šä¸ªè¿›ç¨‹å¹¶å‘è®¿é—®ã€å¯ä»¥é€šè¿‡å¯¹ä¸€ä¸ªå¯å†™æ–‡ä»¶åŠ é”ï¼Œä¿è¯åŒæ—¶åªæœ‰ä¸€ä¸ªè¿›ç¨‹å¯ä»¥æ‹¿åˆ°æ–‡ä»¶é”ï¼Œè¿™ä¸ªè¿›ç¨‹ä»è€Œå¯ä»¥å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œï¼Œ * è€Œå…¶å®ƒæ‹¿ä¸åˆ°é”çš„è¿›ç¨‹è¦ä¹ˆè¢«æŒ‚èµ·ç­‰å¾…ï¼Œè¦ä¹ˆå¯ä»¥å»åšä¸€äº›å…¶å®ƒäº‹æƒ…ï¼Œè¿™ç§æœºåˆ¶ä¿è¯äº†è¿›ç¨‹é—´æ–‡ä»¶çš„å¹¶å‘å®‰å…¨æ“ä½œã€‚ä¿®æ”¹åŒä¸€ä¸ªæ–‡ä»¶çš„é—®é¢˜ï¼Œä½†ä¸èƒ½è§£å†³å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ã€ä¿®æ”¹åŒä¸€æ–‡ä»¶çš„é—®é¢˜ã€‚FileLock æ–‡ä»¶é”çš„æ•ˆæœæ˜¯ä¸æ“ä½œç³»ç»Ÿç›¸å…³çš„ï¼Œæ˜¯ç”±æ“ä½œç³»ç»Ÿåº•å±‚æ¥å®ç°ã€‚ */ if (version &lt; lastCacheChanged.get()) &#123; return; &#125; if (file == null) &#123; return; &#125; // Save try &#123; File lockfile = new File(file.getAbsolutePath() + \".lock\"); if (!lockfile.exists()) &#123; lockfile.createNewFile(); &#125; RandomAccessFile raf = new RandomAccessFile(lockfile, \"rw\"); try &#123; FileChannel channel = raf.getChannel(); try &#123; // å¯¹æ–‡ä»¶åŠ é”ï¼Œé»˜è®¤ä¸ºæ’å®ƒé”ï¼Œæ²¡æœ‰è·å–åˆ°é”çš„è¿›ç¨‹é˜»å¡ç­‰å¾… FileLock lock = channel.tryLock(); if (lock == null) &#123; throw new IOException(\"Can not lock the registry cache file \" + file.getAbsolutePath() + \", ignore and retry later, maybe multi java process use the file, please config: dubbo.registry.file=xxx.properties\"); &#125; // Save try &#123; if (!file.exists()) &#123; file.createNewFile(); &#125; FileOutputStream outputFile = new FileOutputStream(file); try &#123; properties.store(outputFile, \"Dubbo Registry Cache\"); &#125; finally &#123; outputFile.close(); &#125; // é‡Šæ”¾æ–‡ä»¶é” &#125; finally &#123; lock.release(); &#125; &#125; finally &#123; channel.close(); &#125; &#125; finally &#123; raf.close(); &#125; &#125; catch (Throwable e) &#123; if (version &lt; lastCacheChanged.get()) &#123; return; &#125; else &#123; registryCacheExecutor.execute(new SaveProperties(lastCacheChanged.incrementAndGet())); &#125; logger.warn(\"Failed to save registry store file, cause: \" + e.getMessage(), e); &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; è¯¥æ–¹æ³•ç”¨äºå°† Properties æ–‡ä»¶ä¸­çš„å˜æ›´æ•°æ®ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œåœ¨ä¿å­˜çš„æ—¶å€™åšäº†å¹¶å‘å¤„ç†æ“ä½œï¼Œè¯¦ç»†è§ä»£ç æ³¨é‡Šã€‚ åŠ è½½å˜æ›´æ•°æ®åˆ°å†…å­˜12345678910111213141516171819202122232425262728public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; private void loadProperties() &#123; if (file != null &amp;&amp; file.exists()) &#123; InputStream in = null; try &#123; in = new FileInputStream(file); properties.load(in); if (logger.isInfoEnabled()) &#123; logger.info(\"Load registry store file \" + file + \", data: \" + properties); &#125; &#125; catch (Throwable e) &#123; logger.warn(\"Failed to load registry store file \" + file, e); &#125; finally &#123; if (in != null) &#123; try &#123; in.close(); &#125; catch (IOException e) &#123; logger.warn(e.getMessage(), e); &#125; &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; è¯¥æ–¹æ³•ç”¨äºå°†ç£ç›˜æ–‡ä»¶ä¸­çš„å˜æ›´æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­çš„ Properties ä¸­ã€‚ è·å–è®¢é˜…URLå¯¹åº”çš„å˜æ›´URLåˆ—è¡¨1234567891011121314151617181920212223242526272829303132public abstract class AbstractRegistry implements Registry &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * @param url è®¢é˜…URL * @return */ public List&lt;URL&gt; getCacheUrls(URL url) &#123; for (Map.Entry&lt;Object, Object&gt; entry : properties.entrySet()) &#123; // æ˜ å°„URL String key = (String) entry.getKey(); // æ˜ å°„URL å¯¹åº”çš„ é€šçŸ¥URLä¸² String value = (String) entry.getValue(); if (key != null &amp;&amp; key.length() &gt; 0 &amp;&amp; key.equals(url.getServiceKey()) &amp;&amp; (Character.isLetter(key.charAt(0)) || key.charAt(0) == '_') &amp;&amp; value != null &amp;&amp; value.length() &gt; 0) &#123; // å¯¹é€šçŸ¥çš„URLä¸² ä»¥ 'ç©ºæ ¼' è¿›è¡Œåˆ†å‰²æˆå­—ç¬¦ä¸² String[] arr = value.trim().split(URL_SPLIT); List&lt;URL&gt; urls = new ArrayList&lt;URL&gt;(); for (String u : arr) &#123; // è§£æURLä¸² urls.add(URL.valueOf(u)); &#125; return urls; &#125; &#125; return null; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; FailbackRegistryç»§æ‰¿äº† AbstractRegistry æŠ½é—²ç±»ï¼Œæ”¯æŒå¤±è´¥é‡è¯•çš„ Registry æŠ½è±¡ç±»ã€‚AbstractRegistry ä¸­çš„æ³¨å†Œã€è®¢é˜…æ“ä½œæ›´å¤šçš„æ˜¯æ“ä½œç¼“å­˜ï¼Œå¹¶æ²¡æœ‰å’Œæ³¨å†Œä¸­å¿ƒäº¤äº’ã€‚FailbackRegistry åœ¨ AbstractRegistry çš„åŸºç¡€ä¸Šæä¾›äº†æ³¨å†Œå’Œè®¢é˜…çš„æ¨¡ç‰ˆæ–¹æ³•ç”±å…·ä½“å­ç±»å»å®ç°é€»è¾‘ï¼Œå¹¶æ”¯æŒå¤±è´¥é‡è¯•æ“ä½œã€‚ å±æ€§123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337public abstract class FailbackRegistry extends AbstractRegistry &#123; /** * å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨ */ private final ScheduledExecutorService retryExecutor = Executors.newScheduledThreadPool(1, new NamedThreadFactory(\"DubboRegistryFailedRetryTimer\", true)); /** * å¤±è´¥é‡è¯•ScheduledFutureï¼Œå®šæ—¶æ£€æŸ¥æ˜¯å¦æœ‰è¯·æ±‚å¤±è´¥ï¼Œå¦‚æœ‰ï¼Œæ— é™æ¬¡é‡è¯• */ private final ScheduledFuture&lt;?&gt; retryFuture; /** * æ³¨å†Œå¤±è´¥çš„URLé›†åˆ */ private final Set&lt;URL&gt; failedRegistered = new ConcurrentHashSet&lt;URL&gt;(); /** * å–æ¶ˆæ³¨å†Œå¤±è´¥çš„URLé›†åˆ */ private final Set&lt;URL&gt; failedUnregistered = new ConcurrentHashSet&lt;URL&gt;(); /** * è®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ key: è®¢é˜…URL value: ç›‘å¬å™¨ */ private final ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedSubscribed = new ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(); /** * å–æ¶ˆè®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ key: è®¢é˜…URL value: ç›‘å¬å™¨ */ private final ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedUnsubscribed = new ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(); /** * é€šçŸ¥å¤±è´¥çš„URLé›†åˆ key1: è®¢é˜…URL key2: ç›‘å¬å™¨ value: è®¢é˜…URLå¯¹åº”çš„å˜æ›´æ•°æ® */ private final ConcurrentMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt; failedNotified = new ConcurrentHashMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt;(); /** * The time in milliseconds the retryExecutor will wait // é‡è¯•é¢‘ç‡ */ private final int retryPeriod; public FailbackRegistry(URL url) &#123; /** * æ‰§è¡Œçˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œ åŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜ï¼Œå³ properties.load(in)ï¼Œåˆ°propertieså±æ€§ä¸­ã€‚ * è¯´æ˜ï¼š * è¿™ä¸ªå¾ˆé‡è¦ï¼Œæ³¨å†Œä¸­å¿ƒå®•æœºçš„æƒ…å†µä¸‹ï¼Œä¾èµ–ç¼“å­˜æ–‡ä»¶ä¸­çš„ä¿¡æ¯å¯ä»¥æ„å»ºInvokerï¼Œä¸å½±å“æœåŠ¡çš„è°ƒç”¨ï¼Œåªæ˜¯ä¸èƒ½è°ƒç”¨æ–°çš„æœåŠ¡äº†ã€‚ */ super(url); // é‡è¯•é¢‘ç‡ï¼Œå•ä½ æ¯«ç§’ this.retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD); // åˆ›å»ºå¤±è´¥é‡è¯•å®šæ—¶å™¨ã€å°±æ˜¯å°†ä¸€å †å¤±è´¥è®°å½•è¿›è¡Œå¯¹åº”çš„é‡è¯•æ“ä½œã€‘ this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() &#123; @Override public void run() &#123; // Check and connect to the registry try &#123; // æ‰§è¡Œé‡è¯•æ“ä½œ retry(); &#125; catch (Throwable t) &#123; // Defensive fault tolerance logger.error(\"Unexpected error occur at failed retry, cause: \" + t.getMessage(), t); &#125; &#125; &#125;, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS); &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; // ==== Template method ==== protected abstract void doRegister(URL url); protected abstract void doUnregister(URL url); protected abstract void doSubscribe(URL url, NotifyListener listener); protected abstract void doUnsubscribe(URL url, NotifyListener listener);&#125;``` è¯¥æŠ½è±¡ç±»ä¸»è¦ç»´æŠ¤äº†æ³¨å†Œ/å–æ¶ˆæ³¨å†Œå¤±è´¥ã€è®¢é˜…/å–æ¶ˆè®¢é˜…å¤±è´¥ã€é€šçŸ¥å¤±è´¥çš„ç¼“å­˜ï¼Œä»¥åŠæä¾›è€…äº†æ³¨å†Œ/å–æ¶ˆæ³¨å†Œã€è®¢é˜…/å–æ¶ˆè®¢é˜…çš„æ¨¡ç‰ˆæ–¹æ³•ã€‚è¿›è¡Œæ³¨å†Œæˆ–è®¢é˜…æ“ä½œæ—¶ï¼Œä¼šå…ˆè°ƒç”¨å…¶çˆ¶ç±» AbstractRegistry ä¸­çš„æ–¹æ³•è¿›è¡Œç¼“å­˜æ“ä½œï¼Œç„¶åå†è°ƒç”¨å…¶å…·ä½“å­ç±»çš„æ–¹æ³•ã€‚### register```java public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; @Override public void register(URL url) &#123; // è°ƒç”¨çˆ¶ç±»æ“ä½œç¼“å­˜çš„æ–¹æ³• super.register(url); failedRegistered.remove(url); failedUnregistered.remove(url); try &#123; // å‘èµ·æ³¨å†Œè¯·æ±‚åˆ°æ³¨å†Œä¸­å¿ƒæœåŠ¡å™¨ï¼Œå…·ä½“ç”±å­ç±»å®ç°ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯ doRegister(url); &#125; catch (Exception e) &#123; Throwable t = e; // å¦‚æœå¼€å¯äº†å¯åŠ¨æ—¶æ£€æµ‹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) &amp;&amp; url.getParameter(Constants.CHECK_KEY, true) &amp;&amp; !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol()); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) &#123; if (skipFailback) &#123; t = t.getCause(); &#125; throw new IllegalStateException(\"Failed to register \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t); &#125; else &#123; logger.error(\"Failed to register \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); &#125; // è®°å½•æ³¨å†Œå¤±è´¥çš„URLåˆ°æ³¨å†Œå¤±è´¥çš„åˆ—è¡¨ä¸­ï¼Œä¸ºäº†ä»¥åå®šæ—¶é‡è¯• failedRegistered.add(url); &#125; &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125;``` ### unregister```java public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; @Override public void unregister(URL url) &#123; // è°ƒç”¨çˆ¶ç±»æ“ä½œç¼“å­˜çš„æ–¹æ³• super.unregister(url); failedRegistered.remove(url); failedUnregistered.remove(url); try &#123; // å‘èµ·å–æ¶ˆæ³¨å†Œè¯·æ±‚åˆ°æ³¨å†Œä¸­å¿ƒæœåŠ¡å™¨ï¼Œå…·ä½“ç”±å­ç±»å®ç°ï¼Œé€šè¿‡æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡ç«¯ doUnregister(url); &#125; catch (Exception e) &#123; Throwable t = e; // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) &amp;&amp; url.getParameter(Constants.CHECK_KEY, true) &amp;&amp; !Constants.CONSUMER_PROTOCOL.equals(url.getProtocol()); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) &#123; if (skipFailback) &#123; t = t.getCause(); &#125; throw new IllegalStateException(\"Failed to unregister \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t); &#125; else &#123; logger.error(\"Failed to uregister \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); &#125; // Record a failed registration request to a failed list, retry regularly failedUnregistered.add(url); &#125; &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125;``` ### subscribe```java public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; @Override public void subscribe(URL url, NotifyListener listener) &#123; /** è°ƒç”¨çˆ¶ç±» å°†listenerå®ä¾‹åŠ å…¥åˆ°urlæ‰€å¯¹åº”çš„ç›‘å¬å™¨é›†åˆä¸­ &#123;@link #subscribed &#125; ä¸­ */ super.subscribe(url, listener); // å°†listenerä»failedSubscribed/failedUnsubscribedä¸­åˆ é™¤ ï¼Œæ¥ç€ä»failedNotifiedè·å–å½“å‰urlçš„é€šçŸ¥å¤±è´¥Map&lt;NotifyListener, List&lt;URL&gt;&gt;ï¼Œç„¶åä»ä¸­ åˆ é™¤æ‰listener åˆ° éœ€è¦é€šçŸ¥çš„æ‰€æœ‰url çš„æ˜ å°„ removeFailedSubscribed(url, listener); try &#123; // å‘æœåŠ¡ç«¯å‘é€è®¢é˜…è¯·æ±‚,å…·ä½“è¯·æ±‚å¤„ç†ç”±å­ç±»å®ç° doSubscribe(url, listener); /** å¦‚æœåœ¨è®¢é˜…çš„è¿‡ç¨‹æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£ä¹ˆå°è¯•è·å–ç¼“å­˜urlï¼Œå¦‚æœæœ‰ç¼“å­˜urlï¼Œåˆ™è¿›è¡Œå¤±è´¥é€šçŸ¥ã€‚ä¹‹åâ€œå°†å¤±è´¥çš„è®¢é˜…è¯·æ±‚è®°å½•åˆ°å¤±è´¥åˆ—è¡¨ï¼Œå®šæ—¶é‡è¯•â€ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜urlï¼Œ * è‹¥å¼€å¯äº†å¯åŠ¨æ—¶æ£€æµ‹æˆ–è€…ç›´æ¥æŠ›å‡ºçš„å¼‚å¸¸æ˜¯SkipFailbackWrapperExceptionï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šâ€œå°†å¤±è´¥çš„è®¢é˜…è¯·æ±‚è®°å½•åˆ°å¤±è´¥åˆ—è¡¨ï¼Œå®šæ—¶é‡è¯•â€ */ &#125; catch (Exception e) &#123; Throwable t = e; /** * * ä»Propertiesç¼“å­˜æ–‡ä»¶ä¸­å–å‡ºé€šçŸ¥URLé›†åˆ * ã€æ³¨æ„ï¼šè¿™äº›URLæ˜¯ç”±æ³¨å†Œä¸­å¿ƒç»´æŠ¤çš„ï¼Œæ¯æ¬¡è®¢é˜…æ–¹è¯·æ±‚è®¢é˜…æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒéƒ½ä¼šæŠŠå¯¹åº”çš„è¦é€šçŸ¥çš„URLåˆ—è¡¨è®°å½•åˆ°propertiesæ–‡ä»¶ä¸­ï¼Œç„¶åå†™å…¥ç£ç›˜ï¼Œæ³¨æ„ empty://çš„æƒ…å†µã€‘ */ List&lt;URL&gt; urls = getCacheUrls(url); if (urls != null &amp;&amp; !urls.isEmpty()) &#123; notify(url, listener, urls); logger.error(\"Failed to subscribe \" + url + \", Using cached list: \" + urls + \" from cache file: \" + getUrl().getParameter(Constants.FILE_KEY, System.getProperty(\"user.home\") + \"/dubbo-registry-\" + url.getHost() + \".cache\") + \", cause: \" + t.getMessage(), t); &#125; else &#123; // å¦‚æœå¼€å¯äº†å¯åŠ¨æ—¶æ£€æµ‹check=true,åˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) &amp;&amp; url.getParameter(Constants.CHECK_KEY, true); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) &#123; if (skipFailback) &#123; t = t.getCause(); &#125; throw new IllegalStateException(\"Failed to subscribe \" + url + \", cause: \" + t.getMessage(), t); &#125; else &#123; logger.error(\"Failed to subscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); &#125; &#125; // å°†å¤±è´¥çš„è®¢é˜…è¯·æ±‚è®°å½•åˆ°å¤±è´¥åˆ—è¡¨ï¼Œå®šæ—¶é‡è¯• addFailedSubscribed(url, listener); &#125; &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125;``` è¯¥æ–¹æ³•ä¸­å‘æœåŠ¡ç«¯å‘é€è®¢é˜…è¯·æ±‚ä¼šäº¤ç»™å­ç±»å¤„ç†ï¼Œå¤±è´¥æ—¶ä¼šè¿›å…¥åˆ° `catch` å—ä¸­çš„é€»è¾‘ï¼Œæ³¨å†Œä¸­å¿ƒç»´æŠ¤çš„é€šçŸ¥URLåˆ—è¡¨ç”¨åœ¨äº†è¿™é‡Œï¼Œå³å½“è®¢é˜…å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šå–å‡ºç¼“å­˜ä¸­çš„é€šçŸ¥ULRåˆ—è¡¨ï¼Œè°ƒç”¨ notify æ–¹æ³•è¿›è¡Œé€šçŸ¥ã€‚è¯¥é€»è¾‘ä¹Ÿè§£é‡Šäº†å³ä½¿æ³¨å†Œä¸­å¿ƒå®•æœºäº†ï¼Œæ— è®ºæ˜¯æ¶ˆè´¹æ–¹åœ¨æ³¨å†Œä¸­å¿ƒå®•æœºå‰å¯åŠ¨å®Œæˆè¿˜æ˜¯å®•æœºåå¯åŠ¨ï¼Œåªè¦æ¶ˆè´¹æ–¹ç¼“å­˜ä¸­çš„æœåŠ¡æä¾›è€…å¯ç”¨ï¼Œå°±å¯ä»¥å®ç°æœåŠ¡è°ƒç”¨ã€‚### unsubscribe```java public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; /** * å–æ¶ˆè®¢é˜…ï¼Œç§»é™¤ç›¸å…³çš„ç¼“å­˜ã€‚çœŸæ­£çš„å–æ¶ˆè®¢é˜…ç”±å­ç±»æ‰§è¡Œ * * @param url Subscription condition, not allowed to be empty, e.g. consumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin * @param listener A listener of the change event, not allowed to be empty */ @Override public void unsubscribe(URL url, NotifyListener listener) &#123; // è°ƒç”¨çˆ¶ç±»æ–¹æ³•ï¼Œç§»é™¤urlå¯¹åº”çš„listenerå®ä¾‹ super.unsubscribe(url, listener); // ç§»é™¤ç›¸å…³çš„ è®¢é˜…/å–æ¶ˆè®¢é˜…å¤±è´¥ç¼“å­˜ï¼Œä»¥åŠå¤±è´¥é€šçŸ¥ç¼“å­˜ removeFailedSubscribed(url, listener); try &#123; // å‘æœåŠ¡ç«¯å‘é€å–æ¶ˆè®¢é˜…è¯·æ±‚,å…·ä½“è¯·æ±‚å¤„ç†ç”±å­ç±»å®ç° doUnsubscribe(url, listener); &#125; catch (Exception e) &#123; Throwable t = e; // If the startup detection is opened, the Exception is thrown directly. boolean check = getUrl().getParameter(Constants.CHECK_KEY, true) &amp;&amp; url.getParameter(Constants.CHECK_KEY, true); boolean skipFailback = t instanceof SkipFailbackWrapperException; if (check || skipFailback) &#123; if (skipFailback) &#123; t = t.getCause(); &#125; throw new IllegalStateException(\"Failed to unsubscribe \" + url + \" to registry \" + getUrl().getAddress() + \", cause: \" + t.getMessage(), t); &#125; else &#123; logger.error(\"Failed to unsubscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); &#125; // è®°å½•å–æ¶ˆè®¢é˜…ï¼Œä¾¿äºé‡è¯• Set&lt;NotifyListener&gt; listeners = failedUnsubscribed.get(url); if (listeners == null) &#123; failedUnsubscribed.putIfAbsent(url, new ConcurrentHashSet&lt;NotifyListener&gt;()); listeners = failedUnsubscribed.get(url); &#125; listeners.add(listener); &#125; &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125;``` ### notify```java public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; /** * @param url è®¢é˜…URL * @param listener ç›‘å¬å™¨ * @param urls é€šçŸ¥çš„URLå˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ã€æ³¨æ„ï¼šå…¨é‡æŒ‡çš„æ˜¯è‡³å°‘è¦æ˜¯ä¸€ä¸ªåˆ†ç±»çš„å…¨é‡[åŠ¨æ€ç±»å‹çš„]ï¼Œè€Œä¸ä¸€å®šæ˜¯å…¨éƒ¨æ•°æ®ã€‘ */ @Override protected void notify(URL url, NotifyListener listener, List&lt;URL&gt; urls) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"notify url == null\"); &#125; if (listener == null) &#123; throw new IllegalArgumentException(\"notify listener == null\"); &#125; try &#123; // è¿›è¡Œé€šçŸ¥ doNotify(url, listener, urls); &#125; catch (Exception t) &#123; // å°†å¤±è´¥çš„é€šçŸ¥è¯·æ±‚è®°å½•åˆ°å¤±è´¥åˆ—è¡¨ä¸­ï¼Œå®šæ—¶é‡è¯• Map&lt;NotifyListener, List&lt;URL&gt;&gt; listeners = failedNotified.get(url); if (listeners == null) &#123; failedNotified.putIfAbsent(url, new ConcurrentHashMap&lt;NotifyListener, List&lt;URL&gt;&gt;()); listeners = failedNotified.get(url); &#125; listeners.put(listener, urls); logger.error(\"Failed to notify for subscribe \" + url + \", waiting for retry, cause: \" + t.getMessage(), t); &#125; &#125; /** * ä¼šè°ƒç”¨çˆ¶ç±»çš„é€šçŸ¥æ–¹æ³• * * @param url è®¢é˜…URL * @param listener ç›‘å¬å™¨ * @param urls è®¢é˜…URLæ˜ å°„è·¯å¾„ ä¸‹çš„å­è·¯å¾„é›†åˆ */ protected void doNotify(URL url, NotifyListener listener, List&lt;URL&gt; urls) &#123; super.notify(url, listener, urls); &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125; FailbackRegistry ä¸­çš„ notifyæ–¹æ³• æœ¬è´¨ä¸Šè¿˜æ˜¯è°ƒç”¨ AbstractRegistry ä¸­çš„ notify æ–¹æ³•ï¼ŒåŒºåˆ«åœ¨äº FailbackRegistry ä¼šæ”¶é›†å¤±è´¥é€šçŸ¥è¯·æ±‚å¹¶è®°å½•åˆ°ç¼“å­˜ä¸­ï¼Œä¾¿äºé‡è¯•ã€‚ æ–­çº¿é‡è¿1234567891011121314151617181920212223242526272829303132333435363738public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; /** * * @throws Exception */ @Override protected void recover() throws Exception &#123; // register Set&lt;URL&gt; recoverRegistered = new HashSet&lt;URL&gt;(getRegistered()); if (!recoverRegistered.isEmpty()) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Recover register url \" + recoverRegistered); &#125; for (URL url : recoverRegistered) &#123; failedRegistered.add(url); &#125; &#125; // subscribe Map&lt;URL, Set&lt;NotifyListener&gt;&gt; recoverSubscribed = new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(getSubscribed()); if (!recoverSubscribed.isEmpty()) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Recover subscribe url \" + recoverSubscribed.keySet()); &#125; for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : recoverSubscribed.entrySet()) &#123; URL url = entry.getKey(); for (NotifyListener listener : entry.getValue()) &#123; addFailedSubscribed(url, listener); &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125; FailbackRegistry å®Œå…¨è¦†å†™çˆ¶ç±»æ–¹æ³•(å³ä¸åƒå‰å‡ ä¸ªæ–¹æ³•ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•)ï¼Œå°†å·²æ³¨å†Œå’Œè®¢é˜…çš„URLæ·»åŠ åˆ° {@link #failedRegistered} ,{@link #failedSubscribed} å±æ€§ä¸­ï¼Œè¿™æ ·åœ¨{@link #retry()}æ–¹æ³•ä¸­ä¼šè¿›è¡Œé‡è¯•ã€‚ é‡è¯•123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; protected void retry() &#123; //é‡æ–°æ³¨å†Œæ²¡æœ‰æ³¨å†ŒæˆåŠŸçš„URLé›†åˆ if (!failedRegistered.isEmpty()) &#123; Set&lt;URL&gt; failed = new HashSet&lt;URL&gt;(failedRegistered); if (failed.size() &gt; 0) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Retry register \" + failed); &#125; try &#123; for (URL url : failed) &#123; try &#123; doRegister(url); failedRegistered.remove(url); &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry register \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry register \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; // é‡æ–°å–æ¶ˆæ³¨å†Œæ²¡æœ‰å–æ¶ˆæ³¨å†ŒæˆåŠŸçš„URLé›†åˆ if (!failedUnregistered.isEmpty()) &#123; Set&lt;URL&gt; failed = new HashSet&lt;URL&gt;(failedUnregistered); if (!failed.isEmpty()) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Retry unregister \" + failed); &#125; try &#123; for (URL url : failed) &#123; try &#123; doUnregister(url); failedUnregistered.remove(url); &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry unregister \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry unregister \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; /** * * é‡æ–°è®¢é˜… ä¹‹å‰è®¢é˜…å¤±è´¥çš„URL *1 æŠŠè¦è®¢é˜…çš„URLæ˜ å°„çš„è·¯å¾„ä¸ç›‘å¬å™¨ç»‘å®š *2 åˆ›å»ºè¯¥ç›‘å¬å™¨å…³è”çš„ChildListenerï¼Œåº•å±‚åˆä¼šä½¿ç”¨TargetChildListenerå»åŒ…è£¹ChildListenerï¼Œæ³¨æ„ï¼ŒTargetChildListenerçš„å®ç°ä¼šæœ‰ä¸åŒ *3 TargetChildListenerç›´æ¥ç›‘å¬è®¢é˜…çš„URLæ˜ å°„è·¯å¾„çš„å­è·¯å¾„ï¼Œå½“å­è·¯å¾„æœ‰å˜åŒ–ï¼Œå…ˆè§¦å‘TargetChildListenerçš„æ–¹æ³•ï¼Œç„¶åè¯¥æ–¹æ³•ä¼šè°ƒç”¨ChildListenerçš„childChangedæ–¹æ³•ï¼Œæ¥ç€è°ƒç”¨ç›‘å¬çš„notifyæ–¹æ³• * * TargetChildListener */ if (!failedSubscribed.isEmpty()) &#123; Map&lt;URL, Set&lt;NotifyListener&gt;&gt; failed = new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(failedSubscribed); for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(failed).entrySet()) &#123; if (entry.getValue() == null || entry.getValue().size() == 0) &#123; failed.remove(entry.getKey()); &#125; &#125; if (failed.size() &gt; 0) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Retry subscribe \" + failed); &#125; try &#123; for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : failed.entrySet()) &#123; URL url = entry.getKey(); Set&lt;NotifyListener&gt; listeners = entry.getValue(); for (NotifyListener listener : listeners) &#123; try &#123; doSubscribe(url, listener); listeners.remove(listener); &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry subscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry subscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; // é‡æ–°ç§»é™¤URLæ˜ å°„è·¯å¾„ä¸‹çš„å­è·¯å¾„å…³è”çš„ç›‘å¬å™¨ if (!failedUnsubscribed.isEmpty()) &#123; Map&lt;URL, Set&lt;NotifyListener&gt;&gt; failed = new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(failedUnsubscribed); for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : new HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(failed).entrySet()) &#123; if (entry.getValue() == null || entry.getValue().isEmpty()) &#123; failed.remove(entry.getKey()); &#125; &#125; if (failed.size() &gt; 0) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Retry unsubscribe \" + failed); &#125; try &#123; for (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : failed.entrySet()) &#123; URL url = entry.getKey(); Set&lt;NotifyListener&gt; listeners = entry.getValue(); for (NotifyListener listener : listeners) &#123; try &#123; doUnsubscribe(url, listener); listeners.remove(listener); &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry unsubscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry unsubscribe \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; // é‡æ–°é€šçŸ¥ã€çœ‹é€šçŸ¥çš„URLåˆ—è¡¨ï¼ˆå‘ç”Ÿæ”¹å˜çš„URLåˆ—è¡¨ï¼‰å’ŒåŸå§‹çš„URLåˆ—è¡¨å¯¹æ¯”ï¼Œçœ‹æ˜¯å¦æ”¹å˜ï¼Œæ”¹å˜äº†å°±éœ€è¦é‡æ–°æš´éœ²æœåŠ¡ã€‘ if (!failedNotified.isEmpty()) &#123; Map&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt; failed = new HashMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt;(failedNotified); for (Map.Entry&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt; entry : new HashMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt;(failed).entrySet()) &#123; if (entry.getValue() == null || entry.getValue().size() == 0) &#123; failed.remove(entry.getKey()); &#125; &#125; if (failed.size() &gt; 0) &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Retry notify \" + failed); &#125; try &#123; for (Map&lt;NotifyListener, List&lt;URL&gt;&gt; values : failed.values()) &#123; for (Map.Entry&lt;NotifyListener, List&lt;URL&gt;&gt; entry : values.entrySet()) &#123; try &#123; NotifyListener listener = entry.getKey(); List&lt;URL&gt; urls = entry.getValue(); listener.notify(urls); values.remove(listener); &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry notify \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; &#125; catch (Throwable t) &#123; // Ignore all the exceptions and wait for the next retry logger.warn(\"Failed to retry notify \" + failed + \", waiting for again, cause: \" + t.getMessage(), t); &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125; é‡è¯•æ–¹æ³•å°±æ˜¯éå†ç¼“å­˜ä¸­äº”ä¸ª failedXxxå±æ€§ï¼Œé‡è¯•å¯¹åº”çš„æ“ä½œï¼Œå¾ˆæ¸…æ™°ã€‚ é”€æ¯12345678910111213141516171819202122public abstract class FailbackRegistry extends AbstractRegistry &#123; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125; @Override public void destroy() &#123; // è°ƒç”¨çˆ¶æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜… super.destroy(); try &#123; // å–æ¶ˆé‡è¯•ä»»åŠ¡ retryFuture.cancel(true); &#125; catch (Throwable t) &#123; logger.warn(t.getMessage(), t); &#125; // ä¼˜é›…å…³é—­çº¿ç¨‹æ±  ExecutorUtil.gracefulShutdown(retryExecutor, retryPeriod); &#125; // $&#123;çœç•¥å…¶å®ƒä»£ç &#125;&#125; å–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ï¼Œå¹¶å…³é—­é‡è¯•ä»»åŠ¡ã€‚å–æ¶ˆæ³¨å†Œå’Œè®¢é˜…è¿˜æ˜¯è°ƒç”¨å…¶çˆ¶ç±» AbstractRegistry çš„ destroy çš„æ–¹æ³•ï¼Œåœ¨çˆ¶ç±»åŸºç¡€ä¸Šå¢åŠ äº†å¯¹ä»»åŠ¡å–æ¶ˆæ“ä½œä»¥åŠå…³é—­é‡è¯•çº¿ç¨‹æ± ã€‚ RegistryFactory1234567891011121314151617/** * RegistryFactory. (SPI, Singleton, ThreadSafe) æ³¨å†Œä¸­å¿ƒå·¥å‚æ¥å£ï¼Œåˆ›å»ºçš„æ³¨å†Œä¸­å¿ƒï¼ŒåŒ…å«æ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯ã€‚æ³¨æ„å’Œæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯å·¥å‚çš„åŒºåˆ«ã€‚ * * @see com.alibaba.dubbo.registry.support.AbstractRegistryFactory */@SPI(\"dubbo\")public interface RegistryFactory &#123; /** * è·å–æ³¨å†Œä¸­å¿ƒ * * @param url æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¸å…è®¸ä¸ºç©º * @return æ³¨å†Œä¸­å¿ƒå¼•ç”¨ï¼Œæ€»ä¸è¿”å›ç©º */ @Adaptive(&#123;\"protocol\"&#125;) Registry getRegistry(URL url);&#125; æ³¨å†Œä¸­å¿ƒå·¥å‚ï¼Œå®ƒæ˜¯ä¸€ä¸ª Dubbo çš„æ‰©å±•ç‚¹ï¼Œé»˜è®¤æ‰©å±•åæ˜¯ dubbo ï¼Œå³é»˜è®¤çš„æ‰©å±•å®ç°æ˜¯ DubboRegistryFactory ã€‚ AbstractRegistryFactory1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495/** * AbstractRegistryFactory. (SPI, Singleton, ThreadSafe) * * @see com.alibaba.dubbo.registry.RegistryFactory */public abstract class AbstractRegistryFactory implements RegistryFactory &#123; // Log output private static final Logger LOGGER = LoggerFactory.getLogger(AbstractRegistryFactory.class); /** * LOCK é”ï¼Œç”¨äº #destroyAll() å’Œ #getRegistry(url) æ–¹æ³•ï¼Œå¤„ç†å¯¹ REGISTRIES å±æ€§è®¿é—®çš„ç«äº‰ã€‚ */ private static final ReentrantLock LOCK = new ReentrantLock(); /** * Registry é›†åˆ */ private static final Map&lt;String, Registry&gt; REGISTRIES = new ConcurrentHashMap&lt;String, Registry&gt;(); /** * Get all registries * * @return all registries */ public static Collection&lt;Registry&gt; getRegistries() &#123; return Collections.unmodifiableCollection(REGISTRIES.values()); &#125; /** * é”€æ¯æ‰€æœ‰çš„Registryå¯¹è±¡ */ public static void destroyAll() &#123; if (LOGGER.isInfoEnabled()) &#123; LOGGER.info(\"Close all registries \" + getRegistries()); &#125; // è·å¾—é” // Lock up the registry shutdown process LOCK.lock(); try &#123; // å¾ªç¯è°ƒç”¨ destroy() æ–¹æ³• for (Registry registry : getRegistries()) &#123; try &#123; // AbstractRegistry å®ç°äº†å…¬ç”¨çš„é”€æ¯é€»è¾‘ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜… registry.destroy(); &#125; catch (Throwable e) &#123; LOGGER.error(e.getMessage(), e); &#125; &#125; // æ¸…ç©ºç¼“å­˜ REGISTRIES.clear(); &#125; finally &#123; // Release the lock LOCK.unlock(); &#125; &#125; @Override public Registry getRegistry(URL url) &#123; url = url.setPath(RegistryService.class.getName()) .addParameter(Constants.INTERFACE_KEY, RegistryService.class.getName()) // è®¾ç½®interface å±æ€§åœ¨åæ¥çš„è®¢é˜…é€šçŸ¥å¾ˆæœ‰ç”¨ .removeParameters(Constants.EXPORT_KEY, Constants.REFER_KEY); String key = url.toServiceString(); // Lock the registry access process to ensure a single instance of the registry LOCK.lock(); try &#123; // è®¿é—®ç¼“å­˜ Registry registry = REGISTRIES.get(key); if (registry != null) &#123; return registry; &#125; // ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ›å»ºRegistry å®ä¾‹ï¼Œäº¤ç»™å…·ä½“å­ç±»å®ç° registry = createRegistry(url); if (registry == null) &#123; throw new IllegalStateException(\"Can not create registry \" + url); &#125; // å†™å…¥ç¼“å­˜ REGISTRIES.put(key, registry); return registry; &#125; finally &#123; // Release the lock LOCK.unlock(); &#125; &#125; /** * åˆ›å»ºæ³¨å†Œä¸­å¿ƒçš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œç”±å…·ä½“å­ç±»å®ç°ï¼Œè¿‡ç¨‹åŒ…æ‹¬ï¼š * 1 åˆ›å»ºæ³¨å†Œä¸­å¿ƒå®¢æˆ·ç«¯ * 2 å¯åŠ¨å®¢æˆ·ç«¯ * * @param url æ³¨å†Œä¸­å¿ƒåœ°å€ * @return Registry å¯¹è±¡ */ protected abstract Registry createRegistry(URL url);&#125; å®ç° RegistryFactory æ¥å£ï¼Œæ˜¯RegistryFactory æŠ½è±¡ç±»ï¼Œä¸»è¦ä¸¤ä¸ªå·¥ä½œï¼Œå°†è·å–çš„æ³¨å†Œä¸­å¿ƒæ”¾å…¥åˆ°ç¼“å­˜å’Œå®ç°äº†å®ç°äº†å…¬ç”¨çš„é”€æ¯é€»è¾‘ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ã€‚ NotifyListener1234567891011121314/** * NotifyListener. (API, Prototype, ThreadSafe) é€šçŸ¥ç›‘å¬å™¨ * * @see com.alibaba.dubbo.registry.RegistryService#subscribe(URL, NotifyListener) */public interface NotifyListener &#123; /** * å½“æ”¶åˆ°è®¢é˜…URLå¯¹åº”çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œé€šçŸ¥è§¦å‘ * * @param urls å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œæ€»ä¸ä¸ºç©º */ void notify(List&lt;URL&gt; urls);&#125; è¯¥æ¥å£çš„å®ç°ç±»ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼ŒRegistryDirectory å’Œ åŒ¿åç±»å†…éƒ¨ç±»ï¼Œå…·ä½“çš„ä½œç”¨åœ¨è®¢é˜…é€šçŸ¥ç« èŠ‚è¯´æ˜ã€‚ å°ç»“æœ¬ç« ä¸»è¦ä»‹ç»äº†æ³¨å†Œçš„æŠ½è±¡å±‚ï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« ä¼šåˆ†æ Zookeeper å’Œ Redis çš„å®ç°ï¼Œå…¶ä»–ä¸¤ç§ä¸åšåˆ†æã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"}]},{"title":"Dubboæºç åˆ†æ - æœåŠ¡å®¹å™¨","slug":"rpc/æœåŠ¡å®¹å™¨","date":"2020-04-09T16:00:00.000Z","updated":"2020-09-04T07:39:03.454Z","comments":false,"path":"posts/714ea63d/","link":"","permalink":"https://gentryhuang.com/posts/714ea63d/","excerpt":"","text":"å‰è¨€å‰é¢çš„ Dubbo SPIã€Dubboé…ç½®ç­‰æ–‡ç« æè¿°çš„å‡ ä¹éƒ½åªæ˜¯æœåŠ¡æš´éœ²ã€æœåŠ¡å¼•ç”¨ã€æœåŠ¡è°ƒç”¨ä¹‹å‰çš„å‡†å¤‡å·¥ä½œï¼Œæœ‰äº†è¿™äº›å‡†å¤‡å·¥ä½œåï¼Œä¸‹é¢ä»‹ç»Dubboçš„æœåŠ¡å®¹å™¨ï¼Œé€šè¿‡DubboæœåŠ¡å®¹å™¨å¯ä»¥éå¸¸æ–¹ä¾¿å¯åŠ¨ä¸€ä¸ªDubboæœåŠ¡ã€‚ DubboæœåŠ¡å®¹å™¨Dubboçš„æœåŠ¡å®¹å™¨åªæ˜¯ä¸€ä¸ªç®€å•çš„Mainï¼Œç±»ä¼¼SpringBoot,è´Ÿè´£åˆå§‹åŒ–å’Œå¯åŠ¨ä¸åŒåŠŸèƒ½çš„ Container ï¼Œå¦‚æœè¯´dubboçš„æœåŠ¡å®¹å™¨æ˜¯ä¸€ä¸ªç®€å•çš„Mainæ–¹æ³•ï¼Œé‚£ä¹ˆæ‰¿è½½ä¸åŒåŠŸèƒ½çš„Containerå°±æ˜¯æœåŠ¡å®¹å™¨çš„å…·ä½“å®ç°ï¼Œå¯ä»¥æœ‰ä¸åŒçš„ç±»å‹ã€‚umlå…³ç³»å›¾å¦‚ä¸‹ï¼š å®¹å™¨æ‰©å±•ç‚¹123456789101112131415161718/** * Container. (SPI, Singleton, ThreadSafe) * * æœåŠ¡å®¹å™¨æ¥å£ï¼ŒDubboçš„æ‰©å±•ç‚¹ï¼Œé»˜è®¤ä¸º spring */@SPI(\"spring\")public interface Container &#123; /** * start. å¯åŠ¨å®¹å™¨ */ void start(); /** * stop. ä½“åˆ¶å®¹å™¨ */ void stop();&#125; å¯åŠ¨å™¨Main123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106public class Main &#123; private static final Logger logger = LoggerFactory.getLogger(Main.class); /** * Containerçš„é…ç½®é¡¹ï¼Œå¦‚ dubbo.container=spring,log4j */ public static final String CONTAINER_KEY = \"dubbo.container\"; /** * Dubbo ä¼˜é›…åœæœºé…ç½®é¡¹ï¼Œå¦‚ dubbo.shutdown.hook=true */ public static final String SHUTDOWN_HOOK_KEY = \"dubbo.shutdown.hook\"; /** * Containeræ‰©å±•ç‚¹çš„åŠ è½½å™¨ */ private static final ExtensionLoader&lt;Container&gt; loader = ExtensionLoader.getExtensionLoader(Container.class); /** * é” */ private static final ReentrantLock LOCK = new ReentrantLock(); /** * é”çš„æ¡ä»¶ */ private static final Condition STOP = LOCK.newCondition(); /** * @param args å¯åŠ¨å‚æ•°ï¼Œå¯ä»¥åœ¨å¯åŠ¨æ—¶æŒ‡å®šè¦åŠ è½½çš„å®¹å™¨ï¼Œå¦‚ java com.alibaba.dubbo.container.Main spring log4j */ public static void main(String[] args) &#123; try &#123; // å¦‚æœ main æ–¹æ³•çš„å‚æ•°æ²¡æœ‰ä¼ å…¥å€¼ï¼Œåˆ™ä»é…ç½®ä¸­åŠ è½½ã€‚å¦‚æœè·å–ä¸åˆ°å°±ä½¿ç”¨Container é»˜è®¤æ‰©å±• spring if (args == null || args.length == 0) &#123; String config = ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName()); args = Constants.COMMA_SPLIT_PATTERN.split(config); &#125; final List&lt;Container&gt; containers = new ArrayList&lt;Container&gt;(); for (int i = 0; i &lt; args.length; i++) &#123; // ä½¿ç”¨Dubbo SPI åŠ è½½ Container ,å¹¶æŠŠåŠ è½½çš„Container æ”¾å…¥åˆ°Listä¸­ containers.add(loader.getExtension(args[i])); &#125; logger.info(\"Use container type(\" + Arrays.toString(args) + \") to run dubbo serivce.\"); // å½“é…ç½®JVMå¯åŠ¨å‚æ•°å¸¦æœ‰ -Ddubbo.shutdown.hook=trueæ—¶ï¼Œæ·»åŠ å…³é—­çš„ShutdownHook if (\"true\".equals(System.getProperty(SHUTDOWN_HOOK_KEY))) &#123; // ä¼˜é›…åœæœº Runtime.getRuntime().addShutdownHook(new Thread(\"dubbo-container-shutdown-hook\") &#123; @Override public void run() &#123; for (Container container : containers) &#123; try &#123; // å…³é—­å®¹å™¨ container.stop(); logger.info(\"Dubbo \" + container.getClass().getSimpleName() + \" stopped!\"); &#125; catch (Throwable t) &#123; logger.error(t.getMessage(), t); &#125; try &#123; // è·å¾— ReentrantLock LOCK.lock(); // å”¤é†’ Main ä¸»çº¿ç¨‹çš„ç­‰å¾… STOP.signal(); &#125; finally &#123; // é‡Šæ”¾ LOCK LOCK.unlock(); &#125; &#125; &#125; &#125;); &#125; // å¯åŠ¨å®¹å™¨ for (Container container : containers) &#123; container.start(); logger.info(\"Dubbo \" + container.getClass().getSimpleName() + \" started!\"); &#125; System.out.println(new SimpleDateFormat(\"[yyyy-MM-dd HH:mm:ss]\").format(new Date()) + \" Dubbo service server started!\"); // å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå¹¶JVMé€€å‡º &#125; catch (RuntimeException e) &#123; e.printStackTrace(); logger.error(e.getMessage(), e); System.exit(1); &#125; try &#123; // è·å¾— LOCK é” LOCK.lock(); /** * é‡Šæ”¾é”ï¼Œè¿›å…¥ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’ * ä½œç”¨ï¼šçº¿ç¨‹ä¸ç»“æŸï¼Œä¸è§¦å‘JVMé€€å‡ºï¼Œè¿™æ ·Dubboå°±ä¸ä¼šé€€å‡ºã€‚å¦‚æœä¸ç­‰å¾…ï¼Œmainæ–¹æ³•æ‰§è¡Œå®Œæˆï¼Œå°±ä¼šè§¦å‘JVMé€€å‡ºï¼Œå¯¼è‡´DubboæœåŠ¡é€€å‡º */ STOP.await(); &#125; catch (InterruptedException e) &#123; logger.warn(\"Dubbo service server stopped, interrupted by other thread!\", e); &#125; finally &#123; // é‡Šæ”¾ LOCK LOCK.unlock(); &#125; &#125;&#125; è¯´æ˜ dubboæœåŠ¡å®¹å™¨åªæ˜¯ä¸€ä¸ªç®€å•Main æ–¹æ³•ï¼Œé»˜è®¤æƒ…å†µä¸‹åªä¼šåŠ è½½ä¸€ä¸ªç®€å•çš„Springå®¹å™¨ï¼Œç”¨äºæš´éœ²æœåŠ¡ã€‚DubboæœåŠ¡å®¹å™¨çš„åŠ è½½å†…å®¹å¯ä»¥æ‰©å±•ï¼Œå³å¯é€šè¿‡å®¹å™¨æ‰©å±•ç‚¹è¿›è¡Œæ‰©å±•ï¼Œå¦‚ï¼šspringã€logbackç­‰ã€‚ dubboæœåŠ¡å®¹å™¨æ˜¯dubboæœåŠ¡çš„å¯åŠ¨å™¨ï¼Œå®ƒçš„æœ¬è´¨æ˜¯å¯åŠ¨æ—¶åŠ è½½dubboçš„ç›¸å…³å†…å®¹ã€é€šè¿‡springé…ç½®ï¼Œlog4jé…ç½®ç­‰ä½“ç°ã€‘ç„¶åå¯åŠ¨Containerã€‚ä½†æ˜¯ å®é™…ç”Ÿäº§ä¸­ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨dubboçš„æœåŠ¡å®¹å™¨ï¼Œæ›´å¤šä¸»æµçš„æ˜¯ä½¿ç”¨Springæˆ–è€…SpringBoot SpringContainer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869/** * SpringContainer. (SPI, Singleton, ThreadSafe) * å®ç°Containeræ¥å£ï¼ŒSpringå®¹å™¨å®ç°ç±» */public class SpringContainer implements Container &#123; private static final Logger logger = LoggerFactory.getLogger(SpringContainer.class); /** * Spring é…ç½®å±æ€§ */ public static final String SPRING_CONFIG = \"dubbo.spring.config\"; /** * é»˜è®¤é…ç½®æ–‡ä»¶åœ°å€ */ public static final String DEFAULT_SPRING_CONFIG = \"classpath*:META-INF/spring/*.xml\"; /** * Spring ä¸Šä¸‹æ–‡ ï¼Œé™æ€å±æ€§ï¼Œå…¨å±€å”¯ä¸€ */ static ClassPathXmlApplicationContext context; public static ClassPathXmlApplicationContext getContext() &#123; return context; &#125; @Override public void start() &#123; // è·å¾—Spring é…ç½®æ–‡ä»¶çš„åœ°å€ã€å…ˆä¼˜å…ˆä»JVMå‚æ•°ä¸­å–ï¼Œæ²¡æœ‰å†ä»dubbo.propertiesæ–‡ä»¶ä¸­å–ã€‘ String configPath = ConfigUtils.getProperty(SPRING_CONFIG); // å¦‚æœæ²¡æœ‰é…ç½®å°±ä½¿ç”¨é»˜è®¤è·¯å¾„ä¸‹çš„é…ç½®æ–‡ä»¶ if (configPath == null || configPath.length() == 0) &#123; configPath = DEFAULT_SPRING_CONFIG; &#125; // åˆ›å»ºSpring ä¸Šä¸‹æ–‡ context = new ClassPathXmlApplicationContext(configPath.split(\"[,\\\\s]+\"), false); // æ·»åŠ ç›‘å¬å™¨ [dubboæœåŠ¡æš´éœ²ã€æœåŠ¡é”€æ¯ä»¥åŠä¼˜é›…åœæœºçš„å…³é”®] context.addApplicationListener(new DubboApplicationListener()); // ç›‘å¬å®¹å™¨å…³é—­ [æ³¨å†Œä¼˜é›…åœæœºé’©å­] context.registerShutdownHook(); // åˆ·æ–°Springå®¹å™¨ context.refresh(); // å¯åŠ¨Springå®¹å™¨ï¼ŒåŠ è½½Dubboçš„é…ç½®ï¼Œä»è€Œå¯åŠ¨Dubbo æœåŠ¡ context.start(); &#125; @Override public void stop() &#123; try &#123; if (context != null) &#123; // åœæ­¢ä¸Šä¸‹æ–‡ï¼Œä¼šè§¦å‘ ContextStoppedEvent äº‹ä»¶ context.stop(); // å…³é—­ä¸Šä¸‹æ–‡ï¼Œä¼šè§¦å‘ ContextClosedEvent äº‹ä»¶ context.close(); // ç½®ç©ºï¼Œä¾¿äºè¢«å›æ”¶ context = null; &#125; &#125; catch (Throwable e) &#123; logger.error(e.getMessage(), e); &#125; &#125;&#125; è¯´æ˜ DubboApplicationListenerå®ç°äº†ApplicationListeneræ¥å£ï¼Œç”¨äºç›‘å¬Springå®¹å™¨çš„èµ·åœï¼Œåœ¨å¯åŠ¨å’Œé”€æ¯çš„æ—¶å€™åˆ†åˆ«æ‰§è¡ŒæœåŠ¡æš´éœ²å’Œå–æ¶ˆæœåŠ¡æš´éœ²ä»¥åŠæ‰§è¡Œä¼˜é›…åœæœº åˆ›å»ºDubboApplicationListenerå¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½ä¼šåˆ›å»ºDubboBootstrapå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸»è¦å®ŒæˆæœåŠ¡æš´éœ²ã€å–æ¶ˆæœåŠ¡æš´éœ²ã€æ³¨å†Œä¸ç§»é™¤jdk shutdownhook åœ¨åˆ›å»ºDubboBootstrapå¯¹è±¡æ—¶ï¼Œä¼šä¸ºè¯¥ç±»æ³¨å…¥DubboShutdownHookå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç»§æ‰¿äº†Threadï¼Œå°†é‡Šæ”¾èµ„æºçš„æ–¹æ³•ä½œä¸ºä»»åŠ¡ä½“ï¼Œè¯¥å¯¹è±¡æ˜¯çœŸæ­£è¦æ³¨å†Œåˆ°ç³»ç»Ÿä¸­çš„é’©å­ï¼Œå½“JVMé€€å‡ºæ—¶è¯¥é’©å­ä¼šå›è°ƒå®ƒçš„ä»»åŠ¡ä½“ å…³ç³»å›¾å¦‚ä¸‹ DubboApplicationListener1234567891011121314151617181920212223242526272829303132333435/** * An application listener that listens the ContextClosedEvent. * Upon the event, this listener will do the necessary clean up to avoid memory leak. */public class DubboApplicationListener implements ApplicationListener&lt;ApplicationEvent&gt; &#123; /** * Dubboå¼•å¯¼ç¨‹åº */ private DubboBootstrap dubboBootstrap; public DubboApplicationListener() &#123; // åˆ›å»ºDubboBootstrap dubboBootstrap = new DubboBootstrap(false); &#125; public DubboApplicationListener(DubboBootstrap dubboBootstrap) &#123; this.dubboBootstrap = dubboBootstrap; &#125; /** * ç›‘å¬springäº‹ä»¶ * @param applicationEvent */ @Override public void onApplicationEvent(ApplicationEvent applicationEvent) &#123; // springå®¹å™¨åˆ·æ–°å®Œæˆ if (applicationEvent instanceof ContextRefreshedEvent) &#123; dubboBootstrap.start(); // springå®¹å™¨é”€æ¯ &#125; else if (applicationEvent instanceof ContextClosedEvent) &#123; dubboBootstrap.stop(); &#125; &#125;&#125; DubboBootstrap123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103/** * A bootstrap class to easily start and stop Dubbo via programmatic API. * The bootstrap class will be responsible to cleanup the resources during stop. */public class DubboBootstrap &#123; /** * æœåŠ¡é…ç½®å¯¹è±¡åˆ—è¡¨ */ private List&lt;ServiceConfig&gt; serviceConfigList; /** * å¯åŠ¨æœŸé—´æ˜¯å¦æ³¨å†Œ é’©å­ */ private final boolean registerShutdownHookOnStart; /** * åœ¨åµŒå…¥å¼ç¯å¢ƒä¸‹[Mainæ–¹æ³•]è¿è¡ŒDubboæ—¶ä½¿ç”¨çš„ é’©å­ */ private DubboShutdownHook shutdownHook; public DubboBootstrap() &#123; // è·å–DubboShutdownHookï¼Œå¹¶æ³¨å…¥åˆ°è¯¥ç±»ä¸­ this(true, DubboShutdownHook.getDubboShutdownHook()); &#125; public DubboBootstrap(boolean registerShutdownHookOnStart) &#123; // è·å–DubboShutdownHookï¼Œå¹¶æ³¨å…¥åˆ°è¯¥ç±»ä¸­ this(registerShutdownHookOnStart, DubboShutdownHook.getDubboShutdownHook()); &#125; public DubboBootstrap(boolean registerShutdownHookOnStart, DubboShutdownHook shutdownHook) &#123; this.serviceConfigList = new ArrayList&lt;ServiceConfig&gt;(); this.shutdownHook = shutdownHook; this.registerShutdownHookOnStart = registerShutdownHookOnStart; &#125; /** * Register service config to bootstrap, which will be called during &#123;@link DubboBootstrap#stop()&#125; * @param serviceConfig the service * @return the bootstrap instance */ public DubboBootstrap registerServiceConfig(ServiceConfig serviceConfig) &#123; serviceConfigList.add(serviceConfig); return this; &#125; /** * dubboå¼•å¯¼ç¨‹åº - start * 1 æ˜¯å¦æ³¨å†Œshutdown hook * 2 æœåŠ¡æš´éœ² */ public void start() &#123; // å¯åŠ¨æœŸé—´æ˜¯å¦æ³¨å†Œè¿‡shutdown hook if (registerShutdownHookOnStart) &#123; registerShutdownHook(); &#125; else &#123; // å¦‚æœDubboShutdown hook å·²ç»æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ï¼Œéœ€è¦ç§»é™¤æ‰ removeShutdownHook(); &#125; // å¾ªç¯æœåŠ¡é…ç½®å¯¹è±¡ï¼Œä¾æ¬¡è¿›è¡ŒæœåŠ¡æš´éœ² for (ServiceConfig serviceConfig: serviceConfigList) &#123; serviceConfig.export(); &#125; &#125; /** * dubboå¼•å¯¼ç¨‹åº - stop * 1 å–æ¶ˆæœåŠ¡æš´éœ² * 2 */ public void stop() &#123; for (ServiceConfig serviceConfig: serviceConfigList) &#123; serviceConfig.unexport(); &#125; // æ‰§è¡Œ shutdown hook é‡Šæ”¾èµ„æº shutdownHook.destroyAll(); // å¦‚æœå¯åŠ¨æœŸå·²ç»æ³¨å†Œè¿‡ï¼Œåˆ™ä»ç³»ç»Ÿä¸­ç§»é™¤ todo ??? ä¸ºä»€ä¹ˆè¿˜è¦æ³¨å†Œåˆ°ç³»ç»Ÿï¼Œç›´æ¥æ ¹æ®springé”€æ¯äº‹ä»¶ç„¶åæ‰§è¡Œé‡Šæ”¾ä»»åŠ¡ä¸å°±å¯ä»¥äº†å—ï¼Ÿ if (registerShutdownHookOnStart) &#123; removeShutdownHook(); &#125; &#125; /** * æ³¨å†Œ shutdown hook */ public void registerShutdownHook() &#123; Runtime.getRuntime().addShutdownHook(shutdownHook); &#125; /** * ç§»é™¤ shutdown hook */ public void removeShutdownHook() &#123; try &#123; Runtime.getRuntime().removeShutdownHook(shutdownHook); &#125; catch (IllegalStateException ex) &#123; // ignore - VM is already shutting down &#125; &#125;&#125; DubboShutdownHook123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778/** * The shutdown hook thread to do the clean up stuff. * This is a singleton in order to ensure there is only one shutdown hook registered. * Because &#123;@link ApplicationShutdownHooks&#125; use &#123;@link java.util.IdentityHashMap&#125; * to store the shutdown hooks. */public class DubboShutdownHook extends Thread &#123; private static final Logger logger = LoggerFactory.getLogger(DubboShutdownHook.class); /** * ShutdownHook,ç±»å±æ€§ */ private static final DubboShutdownHook dubboShutdownHook = new DubboShutdownHook(\"DubboShutdownHook\"); public static DubboShutdownHook getDubboShutdownHook() &#123; return dubboShutdownHook; &#125; /** * Has it already been destroyed or not? * &lt;p&gt; * æ˜¯å¦å·²ç»è¢«é”€æ¯æ ‡è¯† */ private final AtomicBoolean destroyed; private DubboShutdownHook(String name) &#123; super(name); this.destroyed = new AtomicBoolean(false); &#125; /** * ShutdownHookçš„ä»»åŠ¡ä½“ */ @Override public void run() &#123; if (logger.isInfoEnabled()) &#123; logger.info(\"Run shutdown hook now.\"); &#125; destroyAll(); &#125; /** * Destroy all the resources, including registries and protocols. * &lt;p&gt; * é”€æ¯æ‰€æœ‰çš„èµ„æºï¼ŒåŒ…æ‹¬ Registryç›¸å…³ å’Œ Protocolç›¸å…³ */ public void destroyAll() &#123; //å¦‚æœå·²ç»é”€æ¯åˆ™å¿½ç•¥ if (!destroyed.compareAndSet(false, true)) &#123; return; &#125; // é”€æ¯æ‰€æœ‰çš„ Registry,å–æ¶ˆåº”ç”¨ç¨‹åºä¸­çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„è®¢é˜…ä¸æ³¨å†Œ AbstractRegistryFactory.destroyAll(); /** * é”€æ¯æ‰€æœ‰çš„ Protocol * * è¯´æ˜ï¼š * è¿™é‡Œçš„Protocolæ¯”è¾ƒå¤šï¼Œå¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸¤ç±»ï¼š * 1 å’ŒRegistryç›¸å…³çš„Protocolï¼ŒRegistryProtocolå…³æ³¨æœåŠ¡çš„æ³¨å†Œ * 2 å…·ä½“åè®®ï¼Œå¦‚ DubboProtocolã€httpProtocolç­‰,å…³æ³¨æœåŠ¡çš„æš´éœ²å’Œå¼•ç”¨ */ ExtensionLoader&lt;Protocol&gt; loader = ExtensionLoader.getExtensionLoader(Protocol.class); for (String protocolName : loader.getLoadedExtensions()) &#123; try &#123; Protocol protocol = loader.getLoadedExtension(protocolName); if (protocol != null) &#123; protocol.destroy(); &#125; &#125; catch (Throwable t) &#123; logger.warn(t.getMessage(), t); &#125; &#125; &#125;&#125; LogbackContainer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596/** * LogbackContainer. (SPI, Singleton, ThreadSafe) * å®ç° Container æ¥å£ï¼ŒLogback å®¹å™¨å®ç°ç±» */public class LogbackContainer implements Container &#123; /** * æ—¥å¿—æ–‡ä»¶è·¯å¾„ */ public static final String LOGBACK_FILE = \"dubbo.logback.file\"; /** * æ—¥å¿—æ–‡ä»¶çº§åˆ« */ public static final String LOGBACK_LEVEL = \"dubbo.logback.level\"; /** * æ—¥å¿—ä¿ç•™å¤©æ•° */ public static final String LOGBACK_MAX_HISTORY = \"dubbo.logback.maxhistory\"; /** * é»˜è®¤æ—¥å¿—çº§åˆ« */ public static final String DEFAULT_LOGBACK_LEVEL = \"ERROR\"; @Override public void start() &#123; // è·å¾— logback é…ç½®çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ String file = ConfigUtils.getProperty(LOGBACK_FILE); if (file != null &amp;&amp; file.length() &gt; 0) &#123; // è·å¾—æ—¥å¿—çº§åˆ« String level = ConfigUtils.getProperty(LOGBACK_LEVEL); if (level == null || level.length() == 0) &#123; level = DEFAULT_LOGBACK_LEVEL; &#125; // è·å¾—æ—¥å¿—ä¿ç•™å¤©æ•°ï¼Œå¦‚æœæ˜¯0åˆ™æ°¸ä¹…ä¿ç•™ int maxHistory = StringUtils.parseInteger(ConfigUtils.getProperty(LOGBACK_MAX_HISTORY)); // åˆå§‹åŒ– logback doInitializer(file, level, maxHistory); &#125; &#125; /** * åœæ­¢ä¸ºç©ºï¼Œå› ä¸ºä¸éœ€è¦å…³é—­ */ @Override public void stop() &#123; &#125; /** * åˆå§‹åŒ– logback * * @param file æ—¥å¿—æ–‡ä»¶è·¯å¾„ * @param level æ—¥å¿—çº§åˆ« * @param maxHistory æ—¥å¿—ä¿ç•™å¤©æ•° */ private void doInitializer(String file, String level, int maxHistory) &#123; // è·å–æ—¥å¿—å·¥å‚ LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory(); // é€šè¿‡å·¥å‚è·å–Logger Logger rootLogger = loggerContext.getLogger(Logger.ROOT_LOGGER_NAME); rootLogger.detachAndStopAllAppenders(); // åˆ›å»ºæ—¥å¿—è¿½åŠ å™¨ RollingFileAppender&lt;ILoggingEvent&gt; fileAppender = new RollingFileAppender&lt;ILoggingEvent&gt;(); fileAppender.setContext(loggerContext); fileAppender.setName(\"application\"); fileAppender.setFile(file); fileAppender.setAppend(true); // åˆ›å»ºæ»šåŠ¨ç­–ç•¥ TimeBasedRollingPolicy&lt;ILoggingEvent&gt; policy = new TimeBasedRollingPolicy&lt;ILoggingEvent&gt;(); policy.setContext(loggerContext); policy.setMaxHistory(maxHistory); policy.setFileNamePattern(file + \".%d&#123;yyyy-MM-dd&#125;\"); policy.setParent(fileAppender); policy.start(); fileAppender.setRollingPolicy(policy); // æ ¼å¼ PatternLayoutEncoder encoder = new PatternLayoutEncoder(); encoder.setContext(loggerContext); encoder.setPattern(\"%date [%thread] %-5level %logger (%file:%line\\\\) - %msg%n\"); encoder.start(); fileAppender.setEncoder(encoder); fileAppender.start(); rootLogger.addAppender(fileAppender); rootLogger.setLevel(Level.toLevel(level)); rootLogger.setAdditive(false); &#125;&#125; Log4jContainer123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899/** * Log4jContainer. (SPI, Singleton, ThreadSafe) * å®ç°Containeræ¥å£ï¼ŒLog4jå®¹å™¨å®ç°ç±» */public class Log4jContainer implements Container &#123; /** * æ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½®ï¼Œå¦‚ dubbo.log4j.file=/opt/log/access.log */ public static final String LOG4J_FILE = \"dubbo.log4j.file\"; /** * æ—¥å¿—çº§åˆ« å¦‚ï¼š dubbo.log4j.level=WARN */ public static final String LOG4J_LEVEL = \"dubbo.log4j.level\"; /** * æ—¥å¿—å­è·¯å¾„é…ç½® */ public static final String LOG4J_SUBDIRECTORY = \"dubbo.log4j.subdirectory\"; /** * é»˜è®¤æ—¥å¿—çº§åˆ« */ public static final String DEFAULT_LOG4J_LEVEL = \"ERROR\"; /** * è‡ªåŠ¨é…ç½®log4j */ @Override @SuppressWarnings(\"unchecked\") public void start() &#123; // è·å¾— log4j é…ç½®çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„ String file = ConfigUtils.getProperty(LOG4J_FILE); // è·å–æ—¥å¿—çº§åˆ« if (file != null &amp;&amp; file.length() &gt; 0) &#123; String level = ConfigUtils.getProperty(LOG4J_LEVEL); if (level == null || level.length() == 0) &#123; level = DEFAULT_LOG4J_LEVEL; &#125; // åˆ›å»ºPropertyConfiguratoræ‰€éœ€çš„ Properties å¯¹è±¡ï¼Œ Properties properties = new Properties(); properties.setProperty(\"log4j.rootLogger\", level + \",application\"); properties.setProperty(\"log4j.appender.application\", \"org.apache.log4j.DailyRollingFileAppender\"); properties.setProperty(\"log4j.appender.application.File\", file); properties.setProperty(\"log4j.appender.application.Append\", \"true\"); properties.setProperty(\"log4j.appender.application.DatePattern\", \"'.'yyyy-MM-dd\"); properties.setProperty(\"log4j.appender.application.layout\", \"org.apache.log4j.PatternLayout\"); properties.setProperty(\"log4j.appender.application.layout.ConversionPattern\", \"%d [%t] %-5p %C&#123;6&#125; (%F:%L) - %m%n\"); PropertyConfigurator.configure(properties); &#125; // è·å¾—æ—¥å¿—å­ç›®å½•ï¼Œç”¨äºå¤šè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œé¿å…å†²çª String subdirectory = ConfigUtils.getProperty(LOG4J_SUBDIRECTORY); if (subdirectory != null &amp;&amp; subdirectory.length() &gt; 0) &#123; // è·å– Logger åˆ—è¡¨ Enumeration&lt;org.apache.log4j.Logger&gt; ls = LogManager.getCurrentLoggers(); while (ls.hasMoreElements()) &#123; org.apache.log4j.Logger l = ls.nextElement(); if (l != null) &#123; // æ‹¿åˆ°å½“å‰Logger çš„è¿½åŠ å™¨ Enumeration&lt;Appender&gt; as = l.getAllAppenders(); while (as.hasMoreElements()) &#123; Appender a = as.nextElement(); if (a instanceof FileAppender) &#123; FileAppender fa = (FileAppender) a; String f = fa.getFile(); if (f != null &amp;&amp; f.length() &gt; 0) &#123; int i = f.replace('\\\\', '/').lastIndexOf('/'); String path; if (i == -1) &#123; path = subdirectory; &#125; else &#123; path = f.substring(0, i); if (!path.endsWith(subdirectory)) &#123; path = path + \"/\" + subdirectory; &#125; f = f.substring(i + 1); &#125; // è®¾ç½®æ–°çš„æ–‡ä»¶å fa.setFile(path + \"/\" + f); // ç”Ÿæ•ˆé…ç½® fa.activateOptions(); &#125; &#125; &#125; &#125; &#125; &#125; &#125; /** * ç©ºæ–¹æ³•ï¼Œæ— éœ€å…³é—­ */ @Override public void stop() &#123; &#125;&#125; å®¹å™¨å¯åŠ¨ é€šè¿‡åŠ è½½propertiesé…ç½®æ–‡ä»¶åŠ è½½ç›®æ ‡å®¹å™¨ 1dubbo.container&#x3D;spring,logback,log4j ç¼ºçœåªåŠ è½½springå®¹å™¨ 1java org.apache.dubbo.container.Main é€šè¿‡mainæ–¹æ³•å‚æ•°ä¼ å…¥è¦åŠ è½½çš„å®¹å™¨ 1java org.apache.dubbo.container.Main spring logback log4j é€šè¿‡ JVM å¯åŠ¨å‚æ•°ä¼ å…¥è¦åŠ è½½çš„å®¹å™¨ 1java org.apache.dubbo.container.Main -Ddubbo.container&#x3D;spring,jetty,log4j å°ç»“è™½ç„¶å®é™…ç”Ÿäº§ä¸­ä¸€èˆ¬ä¸ä¼šç›´æ¥ä½¿ç”¨dubboçš„æœåŠ¡å®¹å™¨ï¼Œä½†æ˜¯å®ƒçš„å®ç°æœºåˆ¶æˆ‘ä»¬å¯ä»¥å­¦ä¹ ä¸‹ã€‚äº†è§£äº†DubboæœåŠ¡å®¹å™¨åï¼Œæˆ‘ä»¬ä»æºç å±‚é¢ä¸Šé‡æ–°è®¤è¯†äº†Dubboçš„å¯åœæµç¨‹ï¼Œä»ä¸‹ä¸€ç¯‡æ–‡ç« å¼€å§‹æ­£å¼è¿›å…¥åˆ°Dubboçš„æ ¸å¿ƒæ¨¡å—æºç åˆ†æé˜¶æ®µã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"Spring","slug":"Spring","permalink":"https://gentryhuang.com/tags/Spring/"}]},{"title":"Dubboæºç åˆ†æ - æ³¨è§£é…ç½®","slug":"rpc/æ³¨è§£é…ç½®","date":"2020-04-01T16:00:00.000Z","updated":"2020-09-04T07:15:55.737Z","comments":false,"path":"posts/1a889dcd/","link":"","permalink":"https://gentryhuang.com/posts/1a889dcd/","excerpt":"","text":"å‰è¨€åœ¨ Dubboæºç åˆ†æ - XMLé…ç½® ä¸­ï¼Œè¯¦ç»†ä»‹ç»äº†Dubboçš„XMLé…ç½®æ–¹å¼ï¼Œæœ¬ç¯‡æ–‡ç« ä»‹ç»Dubboæ³¨è§£é…ç½®æ–¹å¼ï¼Œä½¿ç”¨ç¤ºä¾‹è§ Dubboç¤ºä¾‹ - æ³¨è§£é…ç½®ã€‚ ç¤ºä¾‹è¯´æ˜1234567891011121314151617181920212223242526272829/** * AnnotationProvider * * Java Config + æ³¨è§£çš„æ–¹å¼ */public class AnnotationProvider &#123; public static void main(String[] args) throws Exception &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ProviderConfiguration.class); context.start(); System.in.read(); &#125; @Configuration @EnableDubbo(scanBasePackages = \"com.alibaba.dubbo.examples.annotation.impl\") @PropertySource(\"classpath:/com/alibaba/dubbo/examples/annotation/dubbo-provider.properties\") static public class ProviderConfiguration &#123; /** * è¿™é‡Œé€šè¿‡Java Configæ˜¾ç¤ºç»„è£…Beanï¼Œä¼šæ³¨å…¥ç»™DubboæœåŠ¡ï¼Œå³æ ‡æ³¨æœ‰@Serviceçš„ç±»ã€‚å¦‚æœä¸æ˜¾ç¤ºè£…é…ï¼ŒDubboä¼šé»˜è®¤åˆ›å»ºå†…ç½®çš„é…ç½®ç±»å®šä¹‰ï¼Œåˆ›å»ºå†…ç½®çš„é…ç½®ç±»å®šä¹‰çš„å‰ææ˜¯é…ç½®äº†ç›¸å…³çš„å±æ€§ï¼Œå¦åˆ™ä¸ä¼šåˆ›å»ºã€‚å…¶ä»–é…ç½®ç±»ä¼¼ã€‚ */ @Bean public ProviderConfig providerConfig() &#123; ProviderConfig providerConfig = new ProviderConfig(); providerConfig.setTimeout(5000); return providerConfig; &#125; &#125;&#125; è¿™é‡Œä½¿ç”¨ Dubboç¤ºä¾‹ - æ³¨è§£é…ç½® ä¸­çš„æä¾›è€…é…ç½®è¿›è¡Œè¯´æ˜ã€‚å½“Springå¯åŠ¨åï¼Œä¼šå…ˆè·å–é…ç½®ç±»ä¸Šçš„ @PropertySource æ³¨è§£ï¼ŒæŠŠå¤–éƒ¨é…ç½®è¿›è¡Œè§£æç„¶åæ”¾å…¥Springç¯å¢ƒä¸­ï¼Œä¸ºä¹‹åæµç¨‹ä¸­çš„Dubboé…ç½®ç±»çš„å¯¹è±¡è¿›è¡Œå±æ€§èµ‹å€¼ã€‚Springä¼šé€’å½’è·å–é…ç½®ç±»çš„ @Import æ³¨è§£ï¼Œå³æœé›†é…ç½®ç›¸å…³çš„æ‰€æœ‰@Importæ³¨è§£ï¼Œä»¥è·å–ä½¿ç”¨è¯¥æ³¨è§£å¼•å…¥çš„Selectoræˆ–Registrarç±»ï¼Œè¿™äº›ç±»æ˜¯ç”¨æ¥ç»™Springå®¹å™¨å¯¼å…¥ç»„ä»¶çš„ã€‚Dubboçš„æ³¨è§£å®ç°åŒ…æ‹¬ä¸¤å¤§éƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯å¤–éƒ¨åŒ–é…ç½®ï¼Œå¦ä¸€ä¸ªæ˜¯æ³¨è§£é©±åŠ¨ï¼Œå®ƒä»¬çš„èƒ½åŠ›æ˜¯ç”±Selectoræˆ–Registrarç±»å¯¼å…¥æ‰€éœ€ç»„ä»¶å®ç°çš„ï¼Œç¬”è€…è°ƒè¯•è¿™å—èŠ±äº†å¾ˆå¤šæ—¶é—´ï¼Œç»†èŠ‚ç‚¹è¿˜æ˜¯æŒºå¤šçš„ï¼Œç”±äºè¿™äº›éƒ½æ˜¯Springæºç çš„çŸ¥è¯†ç‚¹å°±ä¸è¿›è¡Œåˆ†æäº†ã€‚ æ³¨è§£é…ç½®ä»£ç ç»“æ„ åœ¨ Dubbo 2.5.7ä¹‹å‰çš„ç‰ˆæœ¬ ï¼ŒDubbo æä¾›äº†ä¸¤ä¸ªæ ¸å¿ƒæ³¨è§£ @Service ä»¥åŠ @Referenceï¼Œåˆ†åˆ«ç”¨äºDubbo æœåŠ¡æä¾›å’Œ Dubbo æœåŠ¡å¼•ç”¨ã€‚@Service ä½œä¸º XMLé…ç½®&lt;dubbo:service&gt;çš„æ›¿ä»£ï¼Œä¸ Spring Framework @Service ç±»ä¼¼ï¼Œç”¨äºæœåŠ¡æš´éœ²ã€‚@Reference åˆ™æ˜¯æ›¿ä»£&lt;dubbo:reference &gt; ï¼Œç±»ä¼¼äº Spring ä¸­çš„ @Autowiredï¼Œå¼•ç”¨æœåŠ¡ã€‚ä½†2.5.7ä¹‹å‰Dubboæ³¨è§£æ˜¯åŸºäºAnnotationBeanå®ç°çš„ï¼Œä¸»è¦å­˜åœ¨ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š æ³¨è§£æ”¯æŒä¸å……åˆ†ï¼Œéœ€è¦XMLé…ç½®&lt;dubbo:annotation&gt; @Service ä¸æ”¯æŒSpring AOP @Reference ä¸æ”¯æŒå­—æ®µç»§æ‰¿æ€§ åŸºäºåŸæ¥å®ç°æ€è·¯çš„åŸºç¡€ä¸Šæ— æ³•è§£å†³å†å²é—ç•™é—®é¢˜ï¼Œä»2.5.7å¼€å§‹Dubboçš„æ³¨è§£å®ç°å·²ç»å®Œå…¨é‡å†™ï¼ŒAnnotationBeanå·²ç»è¢«åºŸå¼ƒã€‚ è®¾è®¡åŸåˆ™Spring Framework 3.1 å¼•å…¥äº† @ComponentScan å®Œå…¨æ›¿ä»£äº† XML å…ƒç´  &lt;context:component-scan&gt; ã€‚åŒæ ·åœ°ï¼Œ @DubboComponentScan ä½œä¸º Dubbo 2.5.7 æ–°å¢çš„ Annotationï¼Œä¹Ÿæ˜¯XML å…ƒç´  &lt;dubbo:annotation&gt; çš„æ›¿ä»£æ–¹æ¡ˆï¼Œä¸æ³¨è§£é©±åŠ¨ç›¸å…³ã€‚ @DubboComponentScan ç›¸å¯¹æ¯”è¾ƒç¹é‡ï¼ŒåŸå› åœ¨äºå¤„ç†Dubbo @Service æ ‡æ³¨çš„ç±»æš´éœ²DubboæœåŠ¡å¤–ï¼Œè¿˜è¦æ”¯æŒSpring Beançš„ @Reference å­—æ®µæˆ–æ–¹æ³•æ³¨å…¥DubboæœåŠ¡ä»£ç†ï¼Œå³ @DubboComponentScan é™¤äº†æ‰«æ Dubbo @Service ç»„ä»¶ä»¥å¤–ï¼Œè¿˜éœ€è¦å¤„ç† @Referenceæ³¨å…¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœ @Reference å­—æ®µæˆ–æ–¹æ³•æ‰€åœ¨çš„ç±»ä¸æ˜¯ Spring Bean çš„è¯ï¼Œ @DubboComponentScan ä¸ä¼šå¤„ç† @Reference æ³¨å…¥ï¼Œå…¶åŸç†ä¸ Spring @Autowired ä¸€è‡´ã€‚@EnableDubboConfig ç”¨äºæ”¯æŒDubboçš„å¤–éƒ¨åŒ–é…ç½®ï¼Œå¸¸ç”¨äºæ˜¾ç¤ºæŒ‡å®šDubboçš„é…ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯Dubboæ¡†æ¶ä¸­çš„dubbo.propertiesä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´æ˜¯ç‰¹æ®Šçš„Dubboçš„å¤–éƒ¨åŒ–é…ç½®ï¼Œæ¡†æ¶é»˜è®¤æƒ…å†µä¸‹ä¼šåŠ è½½ç±»è·¯å¾„ä¸‹çš„è¯¥é…ç½®æ–‡ä»¶ï¼Œè¯¦ç»†å‚è§ å±æ€§é…ç½®ã€‚ æ³¨è§£ä»‹ç»@Service æ³¨è§£@Service ç”¨æ¥é…ç½®Dubboçš„æœåŠ¡æä¾›æ–¹ï¼Œé€šè¿‡ @Service ä¸Šæä¾›çš„å±æ€§ï¼Œå¯ä»¥è¿›ä¸€æ­¥çš„å®šåˆ¶åŒ– Dubbo çš„æœåŠ¡æä¾›è€…ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE&#125;)@Inheritedpublic @interface Service &#123; Class&lt;?&gt; interfaceClass() default void.class; String interfaceName() default \"\"; String version() default \"\"; String group() default \"\"; String path() default \"\"; boolean export() default false; String token() default \"\"; boolean deprecated() default false; boolean dynamic() default false; String accesslog() default \"\"; int executes() default 0; boolean register() default true; int weight() default 0; String document() default \"\"; int delay() default 0; String local() default \"\"; String stub() default \"\"; String cluster() default \"\"; String proxy() default \"\"; int connections() default 0; int callbacks() default 0; String onconnect() default \"\"; String ondisconnect() default \"\"; String owner() default \"\"; String layer() default \"\"; int retries() default 0; String loadbalance() default \"\"; boolean async() default false; int actives() default 0; boolean sent() default false; String mock() default \"\"; String validation() default \"\"; int timeout() default 0; String cache() default \"\"; String[] filter() default &#123;&#125;; String[] listener() default &#123;&#125;; String[] parameters() default &#123;&#125;; String application() default \"\"; String module() default \"\"; String provider() default \"\"; String[] protocol() default &#123;&#125;; String monitor() default \"\"; String[] registry() default &#123;&#125;;&#125; @Serviceå®šä¹‰åœ¨ä¸€ä¸ªç±»ä¸Šï¼Œè¡¨ç¤ºä¸€ä¸ªæœåŠ¡çš„å…·ä½“å®ç°ï¼Œæ¯”è¾ƒé‡è¦çš„å±æ€§ï¼š interfaceClassï¼šæŒ‡å®šæœåŠ¡æä¾›æ–¹å®ç°çš„ interface çš„ç±» interfaceNameï¼šæŒ‡å®šæœåŠ¡æä¾›æ–¹å®ç°çš„ interface çš„ç±»å versionï¼šæŒ‡å®šæœåŠ¡çš„ç‰ˆæœ¬å· groupï¼šæŒ‡å®šæœåŠ¡çš„åˆ†ç»„ exportï¼šæ˜¯å¦æš´éœ²æœåŠ¡ registryï¼šæ˜¯å¦å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ applicationï¼šåº”ç”¨é…ç½® moduleï¼šæ¨¡å—é…ç½® providerï¼šæœåŠ¡æä¾›æ–¹é…ç½® protocolï¼šåè®®é…ç½® monitorï¼šç›‘æ§ä¸­å¿ƒé…ç½® registryï¼šæ³¨å†Œä¸­å¿ƒé…ç½® å…¶ä¸­ï¼Œapplicationã€moduleã€providerã€protocolã€monitorã€registryå±æ€§éœ€è¦æä¾›çš„æ˜¯å¯¹åº”çš„Spring Beançš„åå­—ï¼ŒBeanç»„è£…æ–¹å¼å¯ä»¥é€šè¿‡XMLé…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Java Configé…ç½®ã€‚ @Reference æ³¨è§£@Reference ç”¨æ¥é…ç½®Dubboçš„æœåŠ¡æ¶ˆè´¹æ–¹ï¼Œé€šè¿‡ @Reference ä¸Šæä¾›çš„å±æ€§ï¼Œå¯ä»¥è¿›ä¸€æ­¥çš„å®šåˆ¶åŒ– Dubbo çš„æœåŠ¡æ¶ˆè´¹æ–¹ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * Reference * * @export */@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.ANNOTATION_TYPE&#125;)public @interface Reference &#123; Class&lt;?&gt; interfaceClass() default void.class; String interfaceName() default \"\"; String version() default \"\"; String group() default \"\"; String url() default \"\"; String client() default \"\"; boolean generic() default false; boolean injvm() default false; boolean check() default true; boolean init() default false; boolean lazy() default false; boolean stubevent() default false; String reconnect() default \"\"; boolean sticky() default false; String proxy() default \"\"; String stub() default \"\"; String cluster() default \"\"; int connections() default 0; int callbacks() default 0; String onconnect() default \"\"; String ondisconnect() default \"\"; String owner() default \"\"; String layer() default \"\"; int retries() default 2; String loadbalance() default \"\"; boolean async() default false; int actives() default 0; boolean sent() default false; String mock() default \"\"; String validation() default \"\"; int timeout() default 0; String cache() default \"\"; String[] filter() default &#123;&#125;; String[] listener() default &#123;&#125;; String[] parameters() default &#123;&#125;; String application() default \"\"; String module() default \"\"; String consumer() default \"\"; String monitor() default \"\"; String[] registry() default &#123;&#125;;&#125; @Reference å¯ä»¥å®šä¹‰åœ¨ç±»ä¸­çš„ä¸€ä¸ªå­—æ®µä¸Šï¼Œä¹Ÿå¯ä»¥å®šä¹‰åœ¨ä¸€ä¸ªæ–¹æ³•ä¸Šï¼Œç”šè‡³å¯ä»¥ç”¨æ¥ä¿®é¥°å¦ä¸€ä¸ª annotationï¼Œè¡¨ç¤ºä¸€ä¸ªæœåŠ¡å¼•ç”¨ã€‚ä¸€èˆ¬å¤šæŠŠ@Reference å®šä¹‰åœ¨ä¸€ä¸ªå­—æ®µä¸Šï¼Œè¯¥æ³¨è§£æœ‰ä»¥ä¸‹é‡è¦å±æ€§ï¼š interfaceClassï¼šæŒ‡å®šæœåŠ¡çš„ interface çš„ç±» interfaceNameï¼šæŒ‡å®šæœåŠ¡çš„ interface çš„ç±»å versionï¼šæŒ‡å®šæœåŠ¡çš„ç‰ˆæœ¬å· groupï¼šæŒ‡å®šæœåŠ¡çš„åˆ†ç»„ urlï¼šé€šè¿‡æŒ‡å®šæœåŠ¡æä¾›æ–¹çš„ URL åœ°å€ç›´æ¥ç»•è¿‡æ³¨å†Œä¸­å¿ƒå‘èµ·è°ƒç”¨ applicationï¼šåº”ç”¨é…ç½® moduleï¼šæ¨¡å—é…ç½® consumerï¼šæœåŠ¡æ¶ˆè´¹æ–¹é…ç½® protocolï¼šåè®®é…ç½® monitorï¼šç›‘æ§ä¸­å¿ƒé…ç½® registryï¼šæ³¨å†Œä¸­å¿ƒé…ç½® å…¶ä¸­ï¼Œapplicationã€moduleã€consumerã€protocolã€monitorã€registryå±æ€§éœ€è¦æä¾›çš„æ˜¯å¯¹åº”çš„Spring Beançš„åå­—ï¼ŒBeanç»„è£…æ–¹å¼å¯ä»¥é€šè¿‡XMLé…ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Java Configé…ç½®ã€‚ @EnableDubbo æ³¨è§£@EnableDubbo æ³¨è§£æ˜¯ @EnableDubboConfig å’Œ @DubboComponentScan ä¸¤è€…ç»„åˆçš„ä¾¿æ·è¡¨è¾¾æ–¹å¼ã€‚ä¸æ³¨è§£é©±åŠ¨ç›¸å…³çš„æ˜¯ @DubboComponentScanï¼Œä¸å¤–éƒ¨åŒ–é…ç½®ç›¸å…³çš„æ˜¯ @EnableDubboConfig ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Inherited@Documented@EnableDubboConfig // å¼€å¯Dubbo Config ã€DubboConfigå¯¹è±¡çš„åˆ›å»ºå’ŒDubboConfigä¸­çš„å±æ€§è®¾ç½®ã€‘@DubboComponentScan // æ‰«æDubbo çš„@Service å’Œ @Reference æ³¨è§£çš„åŒ…æˆ–è€…ç±»ï¼Œä»è€Œåˆ›å»ºBeanå¯¹è±¡public @interface EnableDubbo &#123; /** * * é…ç½®@DubboComponentScan æ³¨è§£ æ‰«æçš„åŒ… * * Base packages to scan for annotated @Service classes. * &lt;p&gt; * Use &#123;@link #scanBasePackageClasses()&#125; for a type-safe alternative to String-based * package names. * * @return the base packages to scan * @see DubboComponentScan#basePackages() */ @AliasFor(annotation = DubboComponentScan.class, attribute = \"basePackages\") String[] scanBasePackages() default &#123;&#125;; /** * * é…ç½® @DubboComponentScan æ³¨è§£ æ‰«æçš„ç±» * * Type-safe alternative to &#123;@link #scanBasePackages()&#125; for specifying the packages to * scan for annotated @Service classes. The package of each class specified will be * scanned. * * @return classes from the base packages to scan * @see DubboComponentScan#basePackageClasses */ @AliasFor(annotation = DubboComponentScan.class, attribute = \"basePackageClasses\") Class&lt;?&gt;[] scanBasePackageClasses() default &#123;&#125;; /** * é…ç½® @EnableDubboConfig æ³¨è§£ï¼Œæ˜¯å¦å°†é…ç½®å±æ€§ç»‘å®šåˆ°å¤šä¸ªSpring Bean ä¸Š * * It indicates whether &#123;@link AbstractConfig&#125; binding to multiple Spring Beans. * * @return the default value is &lt;code&gt;false&lt;/code&gt; * @see EnableDubboConfig#multiple() */ @AliasFor(annotation = EnableDubboConfig.class, attribute = \"multiple\") boolean multipleConfig() default false;&#125; @EnableDubbo å¯ä»¥é€šè¿‡ scanBasePackageså±æ€§ æŒ‡å®šè¦æ‰«æçš„åŒ…ï¼Œé€šè¿‡ scanBasePackageClasseså±æ€§ æŒ‡å®šè¦æ‰«æçš„ç±»[æœ€åè¿˜æ˜¯ä¼šè½¬ä¸ºæ‰«æåŒ…çš„æ–¹å¼]ï¼Œè¿›è€Œæ‰«æDubbo çš„æœåŠ¡æä¾›è€…ï¼ˆä»¥ @Service æ ‡æ³¨ï¼‰ä»¥åŠ Dubbo çš„æœåŠ¡æ¶ˆè´¹è€…ï¼ˆä»¥ Reference æ ‡æ³¨ï¼‰ã€‚æ‰«æåˆ° Dubbo çš„æœåŠ¡æä¾›æ–¹å’Œæ¶ˆè´¹è€…ä¹‹åï¼Œå¯¹å…¶åšç›¸åº”çš„ç»„è£…å¹¶åˆå§‹åŒ–ï¼Œå¹¶æœ€ç»ˆå®ŒæˆæœåŠ¡æš´éœ²æˆ–è€…å¼•ç”¨çš„å·¥ä½œã€‚å¦‚æœä¸ä½¿ç”¨å¤–éƒ¨åŒ–é…ç½®çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ @DubboComponentScanã€‚ @EnableDubboConfig æ³¨è§£è¯¥æ³¨è§£ç”¨äºå¼€å¯Dubboé…ç½®ï¼Œæ”¯æŒå¤–éƒ¨åŒ–é…ç½®ã€‚ 1234567891011121314151617181920212223242526272829/** * As a convenient and multiple &#123;@link EnableDubboConfigBinding&#125; * * @see EnableDubboConfigBinding * @see DubboConfigConfiguration * @see DubboConfigConfigurationSelector * @since 2.5.8 * * å¼€å¯Dubboé…ç½® * */@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Inherited@Documented@Import(DubboConfigConfigurationSelector.class) public @interface EnableDubboConfig &#123; /** * é…ç½®æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ªSpring Beanä¸Šï¼Œå³è¡¨ç¤ºæ˜¯å¦æ”¯æŒå¤šDubboé…ç½®Beançš„ç»‘å®šï¼Œé»˜è®¤å€¼ä¸ºfalseï¼Œå³å•Dubbo é…ç½®Beançš„ç»‘å®šã€‚ * * It indicates whether binding to multiple Spring Beans. * * @return the default value is &lt;code&gt;false&lt;/code&gt; * @revised 2.5.9 */ boolean multiple() default false;&#125; è¯¥æ³¨è§£æœ‰ä¸€ä¸ªæ ¸å¿ƒçš„å±æ€§ï¼Œmultiple å±æ€§ç”¨äºæ”¯æŒå¤šDubboé…ç½®Beançš„æ•°æ®ç»‘å®šã€‚@Import çš„valueå±æ€§å€¼ DubboConfigConfigurationSelector ç”¨äºç»™Springå®¹å™¨å¯¼å…¥ç»„ä»¶ï¼Œå¯¼å…¥çš„ç»„ä»¶æ˜¯ DubboConfigConfiguration.Single æˆ– DubboConfigConfiguration.Multipleï¼Œå…·ä½“å¯¼å…¥å“ªä¸ªç»„ä»¶å–å†³äº multiple çš„å€¼ã€‚ DubboConfigConfigurationSelector1234567891011121314151617181920212223242526272829303132public class DubboConfigConfigurationSelector implements ImportSelector, Ordered &#123; /** * @param importingClassMetadata @Import(DubboConfigConfigurationSelector.class) æ‰€æ ‡æ³¨çš„æ³¨è§£ä¿¡æ¯ * @return */ @Override public String[] selectImports(AnnotationMetadata importingClassMetadata) &#123; // è·å¾— @EnableDubboConfigæ³¨è§£çš„å±æ€§ AnnotationAttributes attributes = AnnotationAttributes.fromMap( importingClassMetadata.getAnnotationAttributes(EnableDubboConfig.class.getName())); //è·å¾—multipleå±æ€§ boolean multiple = attributes.getBoolean(\"multiple\"); // å¦‚æœä¸ºtrueï¼Œåˆ™æ³¨å†Œ DubboConfigConfiguration.Multiple Beanå¯¹è±¡ if (multiple) &#123; return of(DubboConfigConfiguration.Multiple.class.getName()); &#125; else &#123; // å¦‚æœä¸ºfalseï¼Œåˆ™æ³¨å†Œ DubboConfigConfiguration.Single Beanå¯¹è±¡ return of(DubboConfigConfiguration.Single.class.getName()); &#125; &#125; private static &lt;T&gt; T[] of(T... values) &#123; return values; &#125; @Override public int getOrder() &#123; return HIGHEST_PRECEDENCE; &#125;&#125; è¯¥ç±»å®ç°äº†Springçš„ImportSelectoræ¥å£ï¼ŒåŠŸèƒ½å¦‚ä¸‹ï¼š åˆ©ç”¨ImportSelectorè¦å¯¼å…¥å“ªäº›ç»„ä»¶ï¼Œåªéœ€è¦è¿”å›è¦å¯¼å…¥ç»„ä»¶çš„å…¨é™å®šç±»åï¼Œå³ selectImportsæ–¹æ³•è¿”å›å€¼ã€‚ å¦‚æœselectImportsæ–¹æ³•è¿”å›å€¼å¯¹åº”çš„ç±»ï¼Œå®ƒé‡Œé¢æœ‰ä½¿ç”¨@Beanæ³¨è§£çš„æ–¹æ³•ï¼Œé‚£ä¹ˆæ­¤æ—¶ç»™å®¹å™¨ä¸­å¯¼å…¥çš„ä¸åªæœ‰å½“å‰è¿”å›å€¼å¯¹åº”ç±»çš„å®ä¾‹ï¼Œè¿˜æœ‰è¯¥ç±»å‹ä¸­åŠ äº†@Beanå¯¹åº”çš„å®ä¾‹ã€‚ ç»™å®¹å™¨å¯¼å…¥çš„ä¸æ˜¯ DubboConfigConfigurationSelectorï¼Œå› ä¸ºå®ƒå®ç°äº†ImportSelectoræ¥å£ï¼Œå¯¼å…¥çš„æ˜¯è¯¥ç±»çš„selectImportsæ–¹æ³•ä¸­è¿”å›çš„å€¼å¯¹åº”çš„ç±»ã€‚ é€šè¿‡ä»¥ä¸Šè§„åˆ™å¯ä»¥çŸ¥é“ï¼Œè¯¥ç±»å°±æ˜¯ç»™Springå®¹å™¨å¯¼å…¥ DubboConfigConfiguration.Single æˆ– DubboConfigConfiguration.Multiple ç»„ä»¶ã€‚å¯ä»¥çœ‹å‡ºå®ƒä»¬éƒ½æ˜¯ DubboConfigConfiguration ç±»çš„å†…éƒ¨ç±»ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹è¯¥ç±»çš„å…·ä½“ä¿¡æ¯ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/** * Dubbo &#123;@link AbstractConfig Config&#125; &#123;@link Configuration&#125; * * @see Configuration * @see EnableDubboConfigBindings * @see EnableDubboConfigBinding * @see ApplicationConfig * @see ModuleConfig * @see RegistryConfig * @see ProtocolConfig * @see MonitorConfig * @see ProviderConfig * @see ConsumerConfig * @since 2.5.8 */public class DubboConfigConfiguration &#123; /** * Single Dubbo &#123;@link AbstractConfig Config&#125; Bean Binding * @EnableDubboConfigBinding æ³¨è§£ prefix éƒ½æ˜¯å•æ•° */ @EnableDubboConfigBindings(&#123; @EnableDubboConfigBinding(prefix = \"dubbo.application\", type = ApplicationConfig.class), @EnableDubboConfigBinding(prefix = \"dubbo.module\", type = ModuleConfig.class), @EnableDubboConfigBinding(prefix = \"dubbo.registry\", type = RegistryConfig.class), @EnableDubboConfigBinding(prefix = \"dubbo.protocol\", type = ProtocolConfig.class), @EnableDubboConfigBinding(prefix = \"dubbo.monitor\", type = MonitorConfig.class), @EnableDubboConfigBinding(prefix = \"dubbo.provider\", type = ProviderConfig.class), @EnableDubboConfigBinding(prefix = \"dubbo.consumer\", type = ConsumerConfig.class) &#125;) public static class Single &#123; &#125; /** * Multiple Dubbo &#123;@link AbstractConfig Config&#125; Bean Binding * @EnableDubboConfigBinding æ³¨è§£ prefix éƒ½æ˜¯å¤æ•° */ @EnableDubboConfigBindings(&#123; @EnableDubboConfigBinding(prefix = \"dubbo.applications\", type = ApplicationConfig.class, multiple = true), @EnableDubboConfigBinding(prefix = \"dubbo.modules\", type = ModuleConfig.class, multiple = true), @EnableDubboConfigBinding(prefix = \"dubbo.registries\", type = RegistryConfig.class, multiple = true), @EnableDubboConfigBinding(prefix = \"dubbo.protocols\", type = ProtocolConfig.class, multiple = true), @EnableDubboConfigBinding(prefix = \"dubbo.monitors\", type = MonitorConfig.class, multiple = true), @EnableDubboConfigBinding(prefix = \"dubbo.providers\", type = ProviderConfig.class, multiple = true), @EnableDubboConfigBinding(prefix = \"dubbo.consumers\", type = ConsumerConfig.class, multiple = true) &#125;) public static class Multiple &#123; &#125;&#125; DubboConfigConfiguration ç±»ä¸­æ²¡æœ‰å±æ€§å’Œæ–¹æ³•ï¼Œåªæœ‰ä¸¤ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œå…·ä½“å¯¼å…¥å“ªä¸ªç±»ä¸Šé¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ä»‹ç»ä¸‹ @EnableDubboConfigBindings å’Œ @EnableDubboConfigBinding æ³¨è§£ã€‚ @EnableDubboConfigBindings æ³¨è§£12345678910111213141516171819/** * Multiple &#123;@link EnableDubboConfigBinding&#125; &#123;@link Annotation&#125; * * @since 2.5.8 * @see EnableDubboConfigBinding */@Target(&#123;ElementType.TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documented@Import(DubboConfigBindingsRegistrar.class) public @interface EnableDubboConfigBindings &#123; /** * The value of &#123;@link EnableDubboConfigBindings&#125; * * @return non-null */ EnableDubboConfigBinding[] value();&#125; è¯¥æ³¨è§£æœ‰ä¸€ä¸ªvalueå±æ€§ï¼Œç±»å‹æ˜¯ EnableDubboConfigBinding[] ï¼Œå³ @EnableDubboConfigBinding æ•°ç»„ã€‚è¯¥æ³¨è§£ä¸Šä½¿ç”¨ @Import æ³¨è§£ï¼Œä½¿ç”¨DubboConfigBindingsRegistrar ç±»ç»™Springå®¹å™¨å¯¼å…¥ç»„ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­è·Ÿè¿›ï¼Œçœ‹ä¸‹å…·ä½“å¯¼å…¥å“ªäº›ç»„ä»¶ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243/** * &#123;@link AbstractConfig Dubbo Config&#125; binding Bean registrar for &#123;@link EnableDubboConfigBindings&#125; * * @see EnableDubboConfigBindings * @see DubboConfigBindingRegistrar * @since 2.5.8 */public class DubboConfigBindingsRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware &#123; private ConfigurableEnvironment environment; /** * * @param importingClassMetadata æ ‡æ³¨ç±»æ³¨è§£ä¿¡æ¯ * @param registry Beanå®šä¹‰æ³¨å†Œè¡¨ */ @Override public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; /** * è·å¾— EnableDubboConfigBindings æ³¨è§£ */ AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBindings.class.getName())); // è·å¾—EnableDubboConfigBindings æ³¨è§£çš„value å±æ€§å€¼ï¼ˆè¿™é‡Œæ˜¯ EnableDubboConfigBinding æ³¨è§£æ•°ç»„ï¼‰ AnnotationAttributes[] annotationAttributes = attributes.getAnnotationArray(\"value\"); // åˆ›å»ºDubboConfigBindignRegistrar å¯¹è±¡ï¼Œå¹¶è®¾ç½®ç¯å¢ƒå˜é‡ DubboConfigBindingRegistrar registrar = new DubboConfigBindingRegistrar(); registrar.setEnvironment(environment); // ä¾æ¬¡éå† EnableDubboConfigBinding æ³¨è§£é›†åˆï¼Œè°ƒç”¨ DubboConfigBindingRegistrarçš„æ³¨å†ŒBeanæ–¹æ³•è¿›è¡Œç»„ä»¶æ³¨å†Œ for (AnnotationAttributes element : annotationAttributes) &#123; // æ ¹æ® EnableDubboConfigBinding æ³¨è§£ä¿¡æ¯ï¼Œè¿›è¡Œå¯¹åº”ç»„ä»¶çš„æ³¨å†Œ registrar.registerBeanDefinitions(element, registry); &#125; &#125; @Override public void setEnvironment(Environment environment) &#123; Assert.isInstanceOf(ConfigurableEnvironment.class, environment); this.environment = (ConfigurableEnvironment) environment; &#125;&#125; ä¸Šé¢çš„ç±»ä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š è·å– @EnableDubboConfigBindings æ³¨è§£ä¿¡æ¯ï¼Œå¹¶è·å–è¯¥æ³¨è§£çš„valueå±æ€§å€¼ï¼Œå³è·å–çš„æ˜¯ @EnableDubboConfigBinding æ³¨è§£æ•°ç»„ã€‚ åˆ›å»º DubboConfigBindingRegistrarå¯¹è±¡ã€‚ éå†@EnableDubboConfigBinding æ³¨è§£æ•°ç»„ï¼Œè°ƒç”¨DubboConfigBindingRegistrarå¯¹è±¡çš„ registerBeanDefinitionsæ–¹æ³•ã€‚ æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œ@EnableDubboConfigBindingsåˆ©ç”¨DubboConfigBindingsRegistrarå¯¼å…¥ç»„ä»¶é€»è¾‘å¾ˆç®€å•ï¼Œå› ä¸ºæ•´ä¸ªå¯¼å…¥é€»è¾‘éƒ½å°è£…åœ¨äº†DubboConfigBindingRegistrarå¯¹è±¡çš„ registerBeanDefinitionsæ–¹æ³•ä¸­ã€‚æˆ‘ä»¬æ¥ç€åˆ†æDubboConfigBindingsRegistrarç±»ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯@EnableDubboConfigBindingæ³¨è§£å°±æ˜¯é€šè¿‡@Importæ³¨è§£ä½¿ç”¨è¯¥ç±»ã€‚ 1234567891011121314151617181920212223public class DubboConfigBindingRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware &#123; // $&#123;å…¶ä»–ä»£ç &#125; /** * @param attributes @EnableDubboConfigBindingæ³¨è§£ä¿¡æ¯ * @param registry Beanå®šä¹‰æ³¨å†Œè¡¨ */ protected void registerBeanDefinitions(AnnotationAttributes attributes, BeanDefinitionRegistry registry) &#123; // è·å¾—prefix å±æ€§ï¼ˆå› ä¸ºæœ‰å¯èƒ½æœ‰å ä½ç¬¦ï¼Œéœ€è¦è¦è§£æï¼‰ String prefix = environment.resolvePlaceholders(attributes.getString(\"prefix\")); // è·å¾—typeå±æ€§ï¼Œå³AbstractConfigçš„å®ç°ç±»ï¼Œè¿™å°±æ˜¯è¦å¯¼å…¥çš„ç»„ä»¶ã€‚éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œä½¿ç”¨æ³¨è§£æ–¹å¼åˆ›å»ºDubboçš„é…ç½®Beanï¼ŒDubbo Config éƒ½æ˜¯å›ºå®šå†™åœ¨@EnableDubboConfigBindingæ³¨è§£å±æ€§ä¸­ã€‚ Class&lt;? extends AbstractConfig&gt; configClass = attributes.getClass(\"type\"); // è·çš„multipleå±æ€§ï¼Œå†³å®šé…ç½®æ˜¯å¦ç”¨äºå¤šBeanDefinition boolean multiple = attributes.getBoolean(\"multiple\"); // æ³¨å†ŒDubbo Config Bean registerDubboConfigBeans(prefix, configClass, multiple, registry); &#125; // $&#123;å…¶ä»–ä»£ç &#125;&#125; ç”±ä»£ç å¯ä»¥çœ‹å‡ºDubboConfigBindingsRegistrarå°±æ˜¯ä½¿ç”¨ DubboConfigBindingRegistrar å¯¹è±¡è§£æ@EnableDubboConfigBinding æ³¨è§£ä¿¡æ¯ï¼Œå³é…ç½®å±æ€§çš„å‰ç¼€å’Œé…ç½®å±æ€§å¯¹åº”çš„Dubbo Configç±»ï¼Œæ¥ç€è°ƒç”¨registerDubboConfigBeans æ–¹æ³•æ‰§è¡Œæ³¨å†ŒBeanå®šä¹‰é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105public class DubboConfigBindingRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * æ³¨å†Œdubbo Config Beanå¯¹è±¡ * * @param prefix é…ç½®å±æ€§å‰ç¼€ * @param configClass é…ç½®ç±» * @param multiple æ˜¯å¦æ”¯æŒå¤šBeané…ç½® * @param registry Springæ³¨å†Œè¡¨ */ private void registerDubboConfigBeans(String prefix, Class&lt;? extends AbstractConfig&gt; configClass, boolean multiple, BeanDefinitionRegistry registry) &#123; // è·å¾—prefix å¼€å¤´çš„é…ç½®å±æ€§ï¼Œä»¥mapå½¢å¼è¿”å› ã€environment.getPropertySources() è·å¾—æ˜¯ç³»ç»Ÿå±æ€§ã€ç³»ç»Ÿå˜é‡å’Œ@ResourcePropertyæ³¨è§£å¯¼å…¥çš„propertisé…ç½®å±æ€§ã€‘ Map&lt;String, Object&gt; properties = getSubProperties(environment.getPropertySources(), prefix); // é…ç½®ç±»æ²¡æœ‰é…ç½®ç›¸å…³å±æ€§ï¼Œåˆ™ä¸åˆ›å»ºå¯¹åº”çš„BeanDefinition if (CollectionUtils.isEmpty(properties)) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"There is no property for binding to dubbo config class [\" + configClass.getName() + \"] within prefix [\" + prefix + \"]\"); &#125; return; &#125; // è·å¾—é…ç½®ç±»çš„Beanåç§°ï¼ŒBeanåç§°ç”Ÿæˆè§„åˆ™å–å†³ä¸ multiple çš„å€¼ Set&lt;String&gt; beanNames = multiple ? resolveMultipleBeanNames(properties) : Collections.singleton(resolveSingleBeanName(properties, configClass, registry)); // éå†Beanåå­—é›†åˆ for (String beanName : beanNames) &#123; // 1. æ³¨å†ŒDubbo Configçš„Bean å¯¹è±¡ã€æ²¡æœ‰è®¾ç½®å±æ€§å€¼ã€‘ registerDubboConfigBean(beanName, configClass, registry); // 2. æ³¨å†ŒDubbo Configçš„Beanå¯¹è±¡å¯¹åº”çš„DubboConfigBindingBeanPostProcessorå¯¹è±¡ï¼Œå³Dubboé…ç½®å±æ€§ç»‘å®šçš„åç½®å¤„ç†å™¨ã€æ³¨æ„ï¼Œæ¯ä¸€ä¸ªDubbo Configçš„Beanå¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ªç»‘å®šé…ç½®çš„åç½®å¤„ç†å™¨ã€‘ registerDubboConfigBindingBeanPostProcessor(prefix, beanName, multiple, registry); &#125; &#125; /** * æ³¨å†ŒDubbo ConfigBeanå¯¹è±¡ * * @param beanName Beançš„åç§° * @param configClass é…ç½®ç±» * @param registry æ³¨å†Œè¡¨ */ private void registerDubboConfigBean(String beanName, Class&lt;? extends AbstractConfig&gt; configClass, BeanDefinitionRegistry registry) &#123; // åˆ›å»º configClasså¯¹åº”çš„Beanå®šä¹‰Builder [è¯¥è¿‡ç¨‹Beanå®šä¹‰å·²ç»åˆ›å»º] BeanDefinitionBuilder builder = rootBeanDefinition(configClass); // ç”± Beanå®šä¹‰Builder è·å–Beanå®šä¹‰ AbstractBeanDefinition beanDefinition = builder.getBeanDefinition(); // æ³¨å†Œåˆ° Spring çš„æ³¨å†Œè¡¨ä¸­ registry.registerBeanDefinition(beanName, beanDefinition); if (log.isInfoEnabled()) &#123; log.info(\"The dubbo config bean definition [name : \" + beanName + \", class : \" + configClass.getName() + \"] has been registered.\"); &#125; &#125; /** * åˆ›å»ºçš„Dubbo Configçš„Beanå¯¹è±¡çš„DubboConfigBindingBeanPostProcessorå¯¹è±¡ ã€ç›®çš„ï¼šå®ç°å¯¹Dubbo Configçš„Beanå¯¹è±¡çš„é…ç½®å±æ€§è®¾ç½®ã€‘ * * @param prefix é…ç½®å±æ€§å‰ç¼€ * @param beanName Beançš„åç§° * @param multiple æ˜¯å¦æ”¯æŒå¤šBean * @param registry Springæ³¨å†Œè¡¨ */ private void registerDubboConfigBindingBeanPostProcessor(String prefix, String beanName, boolean multiple, BeanDefinitionRegistry registry) &#123; // åˆ›å»ºDubboé…ç½®ç»‘å®š Beanåç½®å¤„ç†å™¨å¯¹åº”çš„BeanDefinitionBuilderå¯¹è±¡ Class&lt;?&gt; processorClass = DubboConfigBindingBeanPostProcessor.class; BeanDefinitionBuilder builder = rootBeanDefinition(processorClass); /** * æ„é€ æ–¹æ³•çš„å‚æ•°ä¸º actualPrefix å’Œ beanNameï¼Œå³åˆ›å»ºDubboConfigBindingBeanPostProcessorå¯¹è±¡éœ€è¦è¿™ä¸¤ä¸ªå‚æ•°ï¼Œåé¢å±æ€§ç»‘å®šä¼šç”¨åˆ°è¿™ä¸¤ä¸ªå±æ€§ã€‚ * @see DubboConfigBindingBeanPostProcessor#DubboConfigBindingBeanPostProcessor(java.lang.String, java.lang.String) */ String actualPrefix = multiple ? normalizePrefix(prefix) + beanName : prefix; builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName); // è·å¾— DubboConfigBindingBeanPostProcessor çš„ BeanDefinition å¯¹è±¡ AbstractBeanDefinition beanDefinition = builder.getBeanDefinition(); // è®¾ç½®rolå±æ€§ beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); // æ³¨å†Œåˆ°æ³¨å†Œè¡¨ registerWithGeneratedName(beanDefinition, registry); if (log.isInfoEnabled()) &#123; log.info(\"The BeanPostProcessor bean definition [\" + processorClass.getName() + \"] for dubbo config bean [name : \" + beanName + \"] has been registered.\"); &#125; &#125; // $&#123;çœç•¥ä»£ç &#125; &#125; registerDubboConfigBeans æ–¹æ³•ä¸»è¦å®Œæˆäº†ä¸¤ä¸ªæ ¸å¿ƒçš„å·¥ä½œï¼Œåˆ›å»ºDubbo Configçš„Beanå®šä¹‰å’ŒDubbo Configçš„å±æ€§ç»‘å®šåç½®å¤„ç†å™¨ã€‚Dubbo Configæ˜¯çº¦å®šå¥½çš„é…ç½®ç±»ï¼Œå…·ä½“çº¦å®šçš„é…ç½®ç±»å¯ä»¥å‚è§ DubboConfigConfigurationï¼Œå¹¶ä¸”æŒ‡å®šäº†è¿™äº›é…ç½®ç±»çš„å¤–éƒ¨é…ç½®å±æ€§çš„å‰ç¼€ã€‚è¿™ä¸ªè¿‡ç¨‹è¿˜æ¶‰åŠåˆ°Dubbo Configçš„Beanå®šä¹‰çš„åç§°ç”Ÿæˆï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253public class DubboConfigBindingRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * è·å¾—é…ç½®ç±»å¯¹åº”çš„Bean åç§°çš„é›†åˆã€‚é…ç½®ç”¨äºå¤šä¸ªBeançš„æƒ…å†µ * &lt;p&gt; * ä¾‹å¦‚ï¼š dubbo.application.$&#123;beanName&#125;.name=dubbo-demo-annotation-providerï¼Œ$&#123;beanName&#125;å°±æ˜¯é…ç½®ç±»å¯¹åº”çš„Beançš„åç§° * * @param properties é…ç½®å±æ€§é›†åˆ * @return */ private Set&lt;String&gt; resolveMultipleBeanNames(Map&lt;String, Object&gt; properties) &#123; Set&lt;String&gt; beanNames = new LinkedHashSet&lt;String&gt;(); for (String propertyName : properties.keySet()) &#123; // è·å–$&#123;beanName&#125; å­—ç¬¦ä¸² int index = propertyName.indexOf(\".\"); if (index &gt; 0) &#123; String beanName = propertyName.substring(0, index); beanNames.add(beanName); &#125; &#125; return beanNames; &#125; /** * è·å¾—é…ç½®ç±»å¯¹åº”çš„Bean åç§° * ä¾‹å¦‚ï¼š dubbo.application.name=dubbo-demo-annotation-provider * * @param properties * @param configClass * @param registry * @return */ private String resolveSingleBeanName(Map&lt;String, Object&gt; properties, Class&lt;? extends AbstractConfig&gt; configClass, BeanDefinitionRegistry registry) &#123; // è·å¾—Beançš„åç§° String beanName = (String) properties.get(\"id\"); // æ²¡æœ‰æ²¡æœ‰å®šä¹‰ï¼Œå°±åŸºäºSpringæä¾›çš„æœºåˆ¶ç”Ÿæˆå¯¹åº”çš„Beançš„åå­—ã€‚ å¦‚ï¼š org.apache.dubbo.config.ApplicationConfig#0 if (!StringUtils.hasText(beanName)) &#123; BeanDefinitionBuilder builder = rootBeanDefinition(configClass); beanName = BeanDefinitionReaderUtils.generateBeanName(builder.getRawBeanDefinition(), registry); &#125; return beanName; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ç”±ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé…ç½®ç”¨äºå¤šä¸ªBeançš„æ—¶å€™Beançš„åç§°ç›´æ¥ä»é…ç½®å±æ€§å€¼ä¸­è·å–ï¼Œå³è·å–${beanName} çš„å€¼ä½œä¸ºBeanåç§°ï¼ŒBeançš„åç§°å¯èƒ½ä¼šæœ‰å¤šä¸ªã€‚é…ç½®ç”¨äºå•ä¸ªBeançš„æ—¶å€™Beançš„åç§°å…ˆå°è¯•ä½¿ç”¨idå±æ€§å€¼ï¼Œæ²¡æœ‰é…ç½®idå±æ€§å°±è‡ªåŠ¨ç”Ÿæˆã€‚è¿™ä¸¤ç§æƒ…å†µå¯èƒ½ä¸€ä¸‹å­ä¸å¥½ç†è§£ï¼Œä¸‹æ–‡è¿˜ä¼šè¯¦ç»†è¯´æ˜ã€‚ä¸Šé¢çš„è¿‡ç¨‹ä¸­Beanå®šä¹‰æ˜¯æ³¨å†Œåˆ°äº†æ³¨å†Œè¡¨ä¸­ï¼Œä½†æ˜¯Beançš„å±æ€§è¿˜æ²¡æœ‰è®¾ç½®ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æ DubboConfigBindingBeanPostProcessor æ˜¯å¦‚ä½•è¿›è¡Œå±æ€§ç»‘å®šçš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159/** * Dubbo Config Binding &#123;@link BeanPostProcessor&#125; * * @see EnableDubboConfigBinding * @see DubboConfigBindingRegistrar * @since 2.5.8 * &lt;p&gt; * å¤„ç†Dubbo AbstractConfig Beançš„é…ç½®å±æ€§æ³¨å…¥ */public class DubboConfigBindingBeanPostProcessor implements BeanPostProcessor, ApplicationContextAware, InitializingBean &#123; private final Log log = LogFactory.getLog(getClass()); /** * å±æ€§é…ç½®å‰ç¼€ */ private final String prefix; /** * Binding Bean Name // Beançš„åå­—ï¼Œæ¯ä¸ªé…ç½®ç±»çš„Beanéƒ½æœ‰è‡ªå·±çš„åç§° */ private final String beanName; /** * Dubbo é…ç½®å±æ€§ç»‘å®šå™¨ ï¼Œç”¨æ¥ç»‘å®šé…ç½®å±æ€§åˆ°Dubbo Configä¸­ ï¼ˆå†…éƒ¨ä½¿ç”¨Spring DataBinderå®Œæˆå±æ€§ç»‘å®šï¼‰ */ private DubboConfigBinder dubboConfigBinder; /** * åº”ç”¨ä¸Šä¸‹æ–‡ */ private ApplicationContext applicationContext; /** * æ˜¯å¦å¿½ç•¥æœªçŸ¥çš„å±æ€§ */ private boolean ignoreUnknownFields = true; /** * æ˜¯å¦å¿½ç•¥ç±»å‹ä¸å¯¹çš„å±æ€§ */ private boolean ignoreInvalidFields = true; /** * æ„é€ æ–¹æ³•ï¼Œå±æ€§å‰ç¼€å’Œé…ç½®ç±»çš„Beanæ˜¯é€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥è¿›æ¥çš„ã€‚ * * @param prefix the prefix of Configuration Properties * @param beanName the binding Bean Name */ public DubboConfigBindingBeanPostProcessor(String prefix, String beanName) &#123; Assert.notNull(prefix, \"The prefix of Configuration Properties must not be null\"); Assert.notNull(beanName, \"The name of bean must not be null\"); this.prefix = prefix; this.beanName = beanName; &#125; /** * Beanåå¤„ç†å™¨çš„ å‰ç½®å¤„ç†æ–¹æ³•ã€‚å°†é…ç½®å±æ€§ç»‘å®šåˆ°Dubbo Configä¸­ * * @param bean * @param beanName * @return * @throws BeansException */ @Override public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException &#123; // é€‰æ‹©beançš„åç§°æ˜¯ this.beanNameã€é’ˆå¯¹æ³¨è§£æœºåˆ¶åˆ›å»ºBeanå®šä¹‰ï¼Œå…¶ä»–æ–¹å¼åˆ›å»ºçš„Beanå®šä¹‰ä¸ç¬¦åˆæ¡ä»¶ã€‘ï¼Œå¹¶ä¸”æ˜¯AbstractConfigç±»å‹çš„ Beanå®šä¹‰ if (beanName.equals(this.beanName) &amp;&amp; bean instanceof AbstractConfig) &#123; AbstractConfig dubboConfig = (AbstractConfig) bean; // è®¾ç½®prefixå¼€å¤´çš„é…ç½®å±æ€§åˆ° DubboConfigä¸­ dubboConfigBinder.bind(prefix, dubboConfig); if (log.isInfoEnabled()) &#123; log.info(\"The properties of bean [name : \" + beanName + \"] have been binding by prefix of \" + \"configuration properties : \" + prefix); &#125; &#125; return bean; &#125; /** * Beanåå¤„ç†å™¨çš„åç½®å¤„ç†æ–¹æ³•ï¼Œè¿™é‡Œç›´æ¥è¿”å›Dubbo Configçš„Beanå¯¹è±¡ï¼Œä¸åšå…¶ä»–çš„å¤„ç† * * @param bean * @param beanName * @return * @throws BeansException */ @Override public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException &#123; return bean; &#125; @Override public void setApplicationContext(ApplicationContext applicationContext) throws BeansException &#123; this.applicationContext = applicationContext; &#125; /** * è®¾ç½® Dubbo é…ç½®å±æ€§ç»‘å®šå™¨ï¼Œæ³¨æ„å®ƒçš„è§¦å‘æ—¶æœºã€‚ * * @throws Exception */ @Override public void afterPropertiesSet() throws Exception &#123; // è·å¾—DubboConfigBinderå¯¹è±¡ if (dubboConfigBinder == null) &#123; try &#123; dubboConfigBinder = applicationContext.getBean(DubboConfigBinder.class); &#125; catch (BeansException ignored) &#123; if (log.isDebugEnabled()) &#123; log.debug(\"DubboConfigBinder Bean can't be found in ApplicationContext.\"); &#125; // Use Default implementation // åˆ›å»ºé»˜è®¤çš„é…ç½®ç»‘å®šå™¨ dubboConfigBinder = createDubboConfigBinder(applicationContext.getEnvironment()); &#125; &#125; // è®¾ç½® æ˜¯å¦å¿½ç•¥æœªçŸ¥/æ— æ•ˆçš„å±æ€§ dubboConfigBinder.setIgnoreUnknownFields(ignoreUnknownFields); dubboConfigBinder.setIgnoreInvalidFields(ignoreInvalidFields); &#125; /** * Create &#123;@link DubboConfigBinder&#125; instance. * * @param environment * @return &#123;@link DefaultDubboConfigBinder&#125; */ protected DubboConfigBinder createDubboConfigBinder(Environment environment) &#123; // åˆ›å»ºDefaultDubboConfigBinderå¯¹è±¡ DefaultDubboConfigBinder defaultDubboConfigBinder = new DefaultDubboConfigBinder(); // è®¾ç½®environmentå±æ€§ defaultDubboConfigBinder.setEnvironment(environment); return defaultDubboConfigBinder; &#125; public boolean isIgnoreUnknownFields() &#123; return ignoreUnknownFields; &#125; public void setIgnoreUnknownFields(boolean ignoreUnknownFields) &#123; this.ignoreUnknownFields = ignoreUnknownFields; &#125; public boolean isIgnoreInvalidFields() &#123; return ignoreInvalidFields; &#125; public void setIgnoreInvalidFields(boolean ignoreInvalidFields) &#123; this.ignoreInvalidFields = ignoreInvalidFields; &#125; public DubboConfigBinder getDubboConfigBinder() &#123; return dubboConfigBinder; &#125; public void setDubboConfigBinder(DubboConfigBinder dubboConfigBinder) &#123; this.dubboConfigBinder = dubboConfigBinder; &#125;&#125; Dubbo Configçš„å±æ€§ç»‘å®šåç½®å¤„ç†å™¨é€»è¾‘ä¸ç®—å¤æ‚ï¼Œå°±æ˜¯ä»Springç¯å¢ƒä¸­è·å–é…ç½®å±æ€§ï¼Œç„¶ååˆ©ç”¨Springçš„æ•°æ®ç»‘å®šå™¨DataBinderå®ŒæˆDubbo Configçš„Beanå±æ€§çš„ç»‘å®šï¼Œé€»è¾‘å¦‚ä¸‹ï¼š 12345678910111213141516171819202122/** * Default &#123;@link DubboConfigBinder&#125; implementation based on Spring &#123;@link DataBinder&#125; * &lt;p&gt; * ä½¿ç”¨Spring DataBinderï¼Œå°†é…ç½®å±æ€§è®¾ç½®åˆ°Dubbo Configå¯¹è±¡ä¸­ */public class DefaultDubboConfigBinder extends AbstractDubboConfigBinder &#123; @Override public &lt;C extends AbstractConfig&gt; void bind(String prefix, C dubboConfig) &#123; // å°†Dubbo ConfigåŒ…è£…æˆ DataBinderå¯¹è±¡ DataBinder dataBinder = new DataBinder(dubboConfig); // æ˜¯å¦å¿½ç•¥æ— æ•ˆå’ŒæœªçŸ¥å±æ€§ dataBinder.setIgnoreInvalidFields(isIgnoreInvalidFields()); dataBinder.setIgnoreUnknownFields(isIgnoreUnknownFields()); // ä»PropertySourcesä¸­è·å–prefixå¼€å¤´çš„é…ç½®å±æ€§ [getPropertySources() : ç³»ç»Ÿå±æ€§ï¼Œç³»ç»Ÿç¯å¢ƒå’Œ@ProperSourcesçš„å±æ€§k-v] Map&lt;String, Object&gt; properties = getSubProperties(getPropertySources(), prefix); // æ ¹æ®é…ç½®å±æ€§é›†åˆ åˆ›å»º MutablePropertyValueså¯¹è±¡ MutablePropertyValues propertyValues = new MutablePropertyValues(properties); // ç»‘å®šé…ç½®å±æ€§åˆ° Dubboçš„é…ç½®å¯¹è±¡ä¸­ dataBinder.bind(propertyValues); &#125;&#125; åœ¨Springçš„åç½®å¤„ç†å™¨çš„æ–¹æ³•ä¸­ä¼šè°ƒç”¨ DefaultDubboConfigBinder#bindæ–¹æ³•è¿›è¡ŒDubbo Configçš„Beançš„å±æ€§è®¾ç½®ï¼Œæœ¬è´¨æ˜¯ä½¿ç”¨Springçš„DataBinderå®Œæˆå±æ€§è®¾ç½®ã€‚è‡³æ­¤ï¼Œ@EnableDubboConfigBindingsæ¶‰åŠçš„å¤„ç†é€»è¾‘åˆ†æå®Œæ¯•ï¼Œè¿™ä¸ªè¿‡ç¨‹åˆ›å»ºäº†Dubbo Configçš„Beanï¼Œå¹¶ä¸”åˆ›å»ºäº†è¯¥Beanå¯¹åº”çš„å±æ€§ç»‘å®šBeanåç½®å¤„ç†å™¨ï¼Œåœ¨Springçš„ç”Ÿå‘½å‘¨æœŸä¸­è¯¥Beanåç½®å¤„ç†å™¨ä¼šå›è°ƒå¯¹åº”çš„æ–¹æ³•ä»¥å®Œæˆå±æ€§çš„ç»‘å®šã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†æ¥åˆ†æ @EnableDubboConfigBinding æ³¨è§£ï¼Œè¯¥æ³¨è§£æ˜¯ @EnableDubboConfigBindings æ³¨è§£çš„å±æ€§æ•°ç»„çš„ç±»å‹ï¼Œ @EnableDubboConfigBindings æ³¨è§£çš„é€»è¾‘å¤„ç†åŸºæœ¬å°±æ˜¯ @EnableDubboConfigBinding æ³¨è§£çš„é€»è¾‘å¤„ç†ã€‚ @EnableDubboConfigBinding æ³¨è§£123456789101112131415161718192021222324252627282930313233343536373839404142434445464748/** * Enables Spring's annotation-driven &#123;@link AbstractConfig Dubbo Config&#125; from &#123;@link PropertySources properties&#125;. * &lt;p&gt; * Default , &#123;@link #prefix()&#125; associates with a prefix of &#123;@link PropertySources properties&#125;, e,g. \"dubbo.application.\" * or \"dubbo.application\" * &lt;pre class=\"code\"&gt; * &lt;/pre&gt; * * @see DubboConfigBindingRegistrar * @see DubboConfigBindingBeanPostProcessor * @see EnableDubboConfigBindings * @since 2.5.8 */@Target(&#123;ElementType.TYPE, ElementType.ANNOTATION_TYPE&#125;)@Retention(RetentionPolicy.RUNTIME)@Documented@Import(DubboConfigBindingRegistrar.class)public @interface EnableDubboConfigBinding &#123; /** * é…ç½®å±æ€§çš„å‰ç¼€ï¼Œç”¨äºæ˜ å°„åˆ° AbstractConfig ä¸­çš„å±æ€§ * &lt;p&gt; * The name prefix of the properties that are valid to bind to &#123;@link AbstractConfig Dubbo Config&#125;. * * @return the name prefix of the properties to bind */ String prefix(); /** * Dubbo Config é…ç½®ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªçº¦å®šï¼ŒDubbo Configé…ç½®ç±»æœ‰å“ªäº›æ˜¯å›ºå®šçš„ï¼Œè¿™ä¸ªé…ç½®å¿…é¡»æ˜¯AbstractConfigçš„å®ç°å­ç±»ã€‚ * * @return The binding type of &#123;@link AbstractConfig Dubbo Config&#125;. * @see AbstractConfig * @see ApplicationConfig * @see ModuleConfig * @see RegistryConfig */ Class&lt;? extends AbstractConfig&gt; type(); /** * æ˜¯å¦æ”¯æŒé…ç½®ç”¨äºå¤šä¸ªBean * * It indicates whether &#123;@link #prefix()&#125; binding to multiple Spring Beans. * * @return the default value is &lt;code&gt;false&lt;/code&gt; */ boolean multiple() default false;&#125; è¯¥æ³¨è§£æœ‰ä¸‰ä¸ªå±æ€§ï¼Œæ¯ä¸ªå±æ€§çš„ä½œç”¨å·²ç»æ³¨é‡Šè¿‡äº†ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹ @Import(DubboConfigBindingRegistrar.class)ï¼ŒDubboConfigBindingRegistrarçš„ä¸»è¦é€»è¾‘å·²ç»åœ¨ä¸Šé¢åˆ†æè¿‡äº†ï¼Œæˆ‘ä»¬åœ¨ç®€å•çœ‹ä¸‹æ²¡æœ‰åˆ†æåˆ°çš„ä»£ç ã€‚ 12345678910111213141516171819202122232425262728/** * &#123;@link AbstractConfig Dubbo Config&#125; binding Bean registrar * * @see EnableDubboConfigBinding * @see DubboConfigBindingBeanPostProcessor * @since 2.5.8 * &lt;p&gt; * å¤„ç† @EnableDubboConfigBinding æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ°Spring å®¹å™¨ */public class DubboConfigBindingRegistrar implements ImportBeanDefinitionRegistrar, EnvironmentAware &#123; private final Log log = LogFactory.getLog(getClass()); private ConfigurableEnvironment environment; @Override public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; // è·å¾— @EnableDubboConfigBindingæ³¨è§£ä¿¡æ¯ AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBinding.class.getName())); // æ ¹æ® @EnableDubboConfigBindingæ³¨è§£ä¿¡æ¯ æ³¨å†Œé…ç½®å¯¹åº”çš„ BeanDefinition å¯¹è±¡ registerBeanDefinitions(attributes, registry); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è‡³æ­¤ï¼Œ@EnableDubboConfig æ³¨è§£å·²ç»åˆ†æå®Œäº†ï¼Œè¯¥æ³¨è§£å°±æ˜¯ç”¨äºå¼€å¯Dubboçš„é…ç½®ï¼Œåˆ›å»ºDubboæ¡†æ¶å†…ç½®çš„é…ç½®ç±»çš„Beanï¼Œå¹¶ä¸”åˆ›å»ºé…ç½®ç±»çš„Beanå¯¹åº”çš„å±æ€§ç»‘å®šBeanåç½®å¤„ç†å™¨ï¼ŒSpringåº”ç”¨ä¸Šä¸‹æ–‡å¯åŠ¨åï¼Œå°±å¯ä»¥å®ç°é…ç½®å¯¹è±¡çš„åˆ›å»ºä¸åˆå§‹åŒ–ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯æŒ‡å®šäº†é…ç½®ç±»å°±ä¼šåˆ›å»ºå¯¹åº”çš„Beanï¼Œåªæœ‰å½“è§„çº¦çš„å¤–éƒ¨é…ç½®å­˜åœ¨æ—¶ï¼Œé…ç½®ç±»æ‰ä¼šæå‡ä¸ºSpring Beanã€‚ Dubboé…ç½®Beanç»‘å®šåŠè‡ªå®šä¹‰é…ç½®Beanç»‘å®šè¿™å—å†…å®¹è¿˜æ˜¯ä¸å°‘çš„ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†è¯´æ˜äº†ã€‚æˆ‘ä»¬ç›´æ¥çœ‹ Dubbo PMC çš„æ–‡ç«  Dubbo æ–°ç¼–ç¨‹æ¨¡å‹ä¹‹å¤–éƒ¨åŒ–é…ç½®ï¼Œé‡Œé¢è¯¦ç»†ä»‹ç»äº†å¤šé…ç½®Beançš„å±æ€§ç»‘å®šä»¥åŠè‡ªå®šä¹‰Beançš„å±æ€§ç»‘å®šã€‚ @DubboComponentScan æ³¨è§£è¯¥æ³¨è§£ç”¨äºé…ç½®è¦æ‰«æ @Service å’Œ @Reference æ³¨è§£çš„åŒ…æˆ–ç±»ï¼Œè¿›è€Œåˆ›å»ºå¯¹åº”çš„Beanå¯¹è±¡ã€‚æ³¨è§£æ‰«ææ˜¯å§”æ‰˜ç»™Springçš„ï¼Œæœ¬è´¨ä¸Šä½¿ç”¨ASMåº“è¿›è¡Œå­—èŠ‚ç æ‰«ææ³¨è§£å…ƒæ•°æ®ã€‚å½“ç”¨æˆ·ä½¿ç”¨æ³¨è§£ @DubboComponentScan æ—¶ï¼Œä¼šæ¿€æ´» DubboComponentScanRegistrarï¼Œè¿™ä¸ªç±»å°±æ˜¯å®ç°æœåŠ¡æä¾›è€…é€šè¿‡æ³¨è§£ @Service è¿›è¡ŒæœåŠ¡æš´éœ²çš„ï¼Œå¯¹æ¶ˆè´¹è€…é€šè¿‡æ³¨è§£ @Reference è¿›è¡ŒæœåŠ¡å¼•ç”¨çš„ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152/** * Dubbo Component Scan &#123;@link Annotation&#125;,scans the classpath for annotated components that will be auto-registered as * Spring beans. Dubbo-provided &#123;@link Service&#125; and &#123;@link Reference&#125;. * * @see Service * @see Reference * @since 2.5.7 */@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)@Documented@Import(DubboComponentScanRegistrar.class)public @interface DubboComponentScan &#123; /** * Alias for the &#123;@link #basePackages()&#125; attribute. Allows for more concise annotation * declarations e.g.: &#123;@code @DubboComponentScan(\"org.my.pkg\")&#125; instead of * &#123;@code @DubboComponentScan(basePackages=\"org.my.pkg\")&#125;. * * @return the base packages to scan * * å’Œ basePackages ç­‰ä»· * */ String[] value() default &#123;&#125;; /** * Base packages to scan for annotated @Service classes. &#123;@link #value()&#125; is an * alias for (and mutually exclusive with) this attribute. * &lt;p&gt; * Use &#123;@link #basePackageClasses()&#125; for a type-safe alternative to String-based * package names. * * @return the base packages to scan * * è¦æ‰«æåŒ…çš„æ•°ç»„ * */ String[] basePackages() default &#123;&#125;; /** * Type-safe alternative to &#123;@link #basePackages()&#125; for specifying the packages to * scan for annotated @Service classes. The package of each class specified will be * scanned. * * @return classes from the base packages to scan * * è¦æ‰«æçš„ç±»çš„æ•°ç»„ * */ Class&lt;?&gt;[] basePackageClasses() default &#123;&#125;;&#125; è¯¥æ³¨è§£çš„å±æ€§ä½œç”¨å·²ç»æ³¨é‡Šï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹@Importçš„valueå±æ€§å€¼ DubboComponentScanRegistrar ï¼Œå®ƒç”¨äºå¤„ç†DubboComponentScanæ³¨è§£ï¼Œä¸ºSpringå®¹å™¨æ³¨å†ŒServiceAnnotationå’ŒReferenceAnnotationçš„Beanåç½®å¤„ç†å™¨ï¼Œè¿›è€Œåˆ›å»ºServiceBeanå’ŒReferenceBeanå¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä»¬å°±æ¥è¯¦ç»†åˆ†æDubboæ³¨è§£å®ç°çš„è¿™ä¸ªæ ¸å¿ƒç±»ã€‚ DubboComponentScanRegistrar1234567891011121314151617181920212223242526272829303132333435/** * Dubbo &#123;@link DubboComponentScan&#125; Bean Registrar * * @see Service * @see DubboComponentScan * @see ImportBeanDefinitionRegistrar * @see ServiceAnnotationBeanPostProcessor * @see ReferenceAnnotationBeanPostProcessor * @since 2.5.7 * */public class DubboComponentScanRegistrar implements ImportBeanDefinitionRegistrar &#123; /** * @param importingClassMetadata @DubboComponentScan æ³¨è§£çš„ä¿¡æ¯ * @param registry Beanå®šä¹‰æ³¨å†Œè¡¨ */ @Override public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; /** * 1. è·å¾—è¦æ‰«æçš„åŒ… */ Set&lt;String&gt; packagesToScan = getPackagesToScan(importingClassMetadata); /** * 2. åˆ›å»º ServiceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Service` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Service Bean å¯¹è±¡ */ registerServiceAnnotationBeanPostProcessor(packagesToScan, registry); /** * 3. åˆ›å»º ReferenceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Reference` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Reference Bean å¯¹è±¡ */ registerReferenceAnnotationBeanPostProcessor(registry); &#125; // $&#123;çœç•¥å…¶ä»–çš„ä»£ç &#125;&#125; DubboComponentScanRegistrar å®ç° ImportBeanDefinitionRegistraræ¥å£ï¼Œç”¨æ¥å¤„ç† @DubboComponentScanæ³¨è§£ï¼Œæ³¨å†Œ ServiceAnnotationBeanPostProcessor å’Œ ReferenceAnnotationBeanPostProcessor åˆ°Springå®¹å™¨ï¼ŒSpringåº”ç”¨ä¸Šä¸‹æ–‡å¯åŠ¨åï¼Œå°±å¯ä»¥å®ç°Service Beanå¯¹è±¡å’ŒReference Beanå¯¹è±¡çš„åˆ›å»ºã€‚ä¸‹é¢æˆ‘ä»¬ä¾æ¬¡åˆ†æä»¥ä¸Šä¸‰ä¸ªæ­¥éª¤çš„å…·ä½“é€»è¾‘ã€‚ è·å–è¦æ‰«æçš„åŒ…123456789101112131415161718192021222324252627282930313233343536373839public class DubboComponentScanRegistrar implements ImportBeanDefinitionRegistrar &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * è·å¾— DubboComponentScanæ³¨è§£æ‰«æçš„åŒ… * * @param metadata * @return */ private Set&lt;String&gt; getPackagesToScan(AnnotationMetadata metadata) &#123; // è·å¾— @DubboComponentScan æ³¨è§£ AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(DubboComponentScan.class.getName())); // è·å¾—basePackages å±æ€§å€¼ String[] basePackages = attributes.getStringArray(\"basePackages\"); // è·å¾—basePackageClasseså±æ€§å€¼ Class&lt;?&gt;[] basePackageClasses = attributes.getClassArray(\"basePackageClasses\"); // è·å¾—é»˜è®¤å±æ€§ï¼ˆbasePackagesçš„é»˜è®¤å±æ€§ï¼‰ String[] value = attributes.getStringArray(\"value\"); // å°†å±æ€§æ·»åŠ åˆ° packagesToScan é›†åˆä¸­ Set&lt;String&gt; packagesToScan = new LinkedHashSet&lt;String&gt;(Arrays.asList(value)); packagesToScan.addAll(Arrays.asList(basePackages)); // å¤„ç† æ‰«æçš„ç±»çš„æ•°ç»„ ï¼Œå¾—åˆ°æ¯ä¸ªç±»çš„åŒ…åï¼Œç„¶åæ·»åŠ åˆ° åŒ…è·¯å¾„æ•°ç»„ä¸­ for (Class&lt;?&gt; basePackageClass : basePackageClasses) &#123; packagesToScan.add(ClassUtils.getPackageName(basePackageClass)); &#125; // packagesToScan ä¸ºç©ºçš„è¯ï¼Œåˆ™é»˜è®¤ä½¿ç”¨DubboComponentScanæ³¨è§£ç±»æ‰€åœ¨çš„åŒ…åšä¸ºæ‰«æåŒ… if (packagesToScan.isEmpty()) &#123; return Collections.singleton(ClassUtils.getPackageName(metadata.getClassName())); &#125; return packagesToScan; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è·å–è¦æ‰«æçš„åŒ…é€»è¾‘è¿˜æ˜¯å¾ˆç›´è§‚çš„ï¼Œå°†é…ç½®çš„æ‰«æåŒ…è·¯å¾„å’Œé…ç½®çš„æ‰«æç±»å¯¹åº”çš„åŒ…è·¯å¾„èšåˆåœ¨ä¸€èµ·ä½œä¸ºç›®æ ‡åŒ…è·¯å¾„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å½“é…ç½®æ‰«æç±»æ—¶éœ€è¦è·å–æ‰«æç±»çš„åŒ…åï¼Œå³è¿˜æ˜¯ä¼šè½¬ä¸ºåŒ…æ‰«æã€‚å¦‚æœæ²¡æœ‰é…ç½®æ‰«æåŒ…åŠæ‰«æç±»ï¼Œé‚£ä¹ˆå°±æ˜¯ä½¿ç”¨DubboComponentScanæ³¨è§£ç±»æ‰€åœ¨çš„åŒ…åšä¸ºæ‰«æåŒ…ã€‚ åˆ›å»ºæ‰«æ @Service æ³¨è§£çš„åç½®å¤„ç†å™¨1234567891011121314151617181920212223242526272829public class DubboComponentScanRegistrar implements ImportBeanDefinitionRegistrar &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * Registers &#123;@link ServiceAnnotationBeanPostProcessor&#125; * * @param packagesToScan packages to scan without resolving placeholders * @param registry &#123;@link BeanDefinitionRegistry&#125; * @since 2.5.8 * &lt;p&gt; * åˆ›å»º ServiceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ @Service æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Service Bean å¯¹è±¡ */ private void registerServiceAnnotationBeanPostProcessor(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry) &#123; // åˆ›å»ºServiceAnnotationBeanPostProcessorçš„BeanDefinitionBuilder å¯¹è±¡ BeanDefinitionBuilder builder = rootBeanDefinition(ServiceAnnotationBeanPostProcessor.class); // è®¾ç½®æ„é€ æ–¹æ³•å‚æ•°ä¸º packagesToScan builder.addConstructorArgValue(packagesToScan); // è®¾ç½® role å±æ€§ builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE); // è·å¾— AbstractBeanDefinition å¯¹è±¡ AbstractBeanDefinition beanDefinition = builder.getBeanDefinition(); // æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; åˆ›å»ºæ‰«æ @Service æ³¨è§£çš„ç±»çš„åç½®å¤„ç†å™¨é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªBeanå®šä¹‰ç„¶åæ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬é‡ç‚¹åˆ†æè¿™ä¸ªåç½®å¤„ç†çš„é€»è¾‘ï¼Œçœ‹å®ƒæ˜¯å¦‚ä½•å°† @Service æ ‡æ³¨çš„ç±»æå‡ä¸ºSpring Beançš„ã€‚ ServiceAnnotationBeanPostProcessor12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364/** * &#123;@link Service&#125; Annotation * &#123;@link BeanDefinitionRegistryPostProcessor Bean Definition Registry Post Processor&#125; * * @since 2.5.8 */public class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware, ResourceLoaderAware, BeanClassLoaderAware &#123; private final Logger logger = LoggerFactory.getLogger(getClass()); /** * è¦æ‰«æçš„åŒ…çš„é›†åˆï¼Œé€šè¿‡æ„é€ æ–¹æ³•è¿›è¡Œè®¾ç½® */ private final Set&lt;String&gt; packagesToScan; /** * ç¯å¢ƒ */ private Environment environment; /** * èµ„æºåŠ è½½å™¨ */ private ResourceLoader resourceLoader; /** * ç±»åŠ è½½å™¨ */ private ClassLoader classLoader; public ServiceAnnotationBeanPostProcessor(String... packagesToScan) &#123; this(Arrays.asList(packagesToScan)); &#125; public ServiceAnnotationBeanPostProcessor(Collection&lt;String&gt; packagesToScan) &#123; this(new LinkedHashSet&lt;String&gt;(packagesToScan)); &#125; public ServiceAnnotationBeanPostProcessor(Set&lt;String&gt; packagesToScan) &#123; this.packagesToScan = packagesToScan; &#125; // $&#123;çœç•¥å…¶ä»–é€»è¾‘ä»£ç &#125; @Override public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException &#123; &#125; @Override public void setEnvironment(Environment environment) &#123; this.environment = environment; &#125; @Override public void setResourceLoader(ResourceLoader resourceLoader) &#123; this.resourceLoader = resourceLoader; &#125; @Override public void setBeanClassLoader(ClassLoader classLoader) &#123; this.classLoader = classLoader; &#125; ServiceAnnotationBeanPostProcessor å®ç° BeanDefinitionRegistryPostProcessorã€EnvironmentAwareã€ResourceLoaderAwareã€BeanClassLoaderAware æ¥å£ï¼Œå…·å¤‡äº†Springçš„ç‰¹å®šåŠŸèƒ½ï¼Œå¦‚Springå®¹å™¨ä¸­æ‰€æœ‰Beanæ³¨å†Œä¹‹åå›è°ƒ postProcessBeanDefinitionRegistry æ–¹æ³•ã€‚è¯¥ç±»ä¸»è¦æ˜¯å°† @Service æ ‡æ³¨çš„ç±»æå‡ä¸ºSpring Beanï¼Œä¸»è¦çš„é€»è¾‘å¦‚ä¸‹ï¼š è§£ææ‰«æåŒ…é›†åˆï¼Œå¤„ç†å­˜åœ¨å ä½ç¬¦çš„åŒ…åã€‚ åˆ›å»ºDubboClassPathBeanDefinitionScannerå¯¹è±¡ï¼Œç”¨äºæ‰«ææŒ‡å®šåŒ…ä¸‹çš„ @Service æ ‡æ³¨çš„ç±»å¹¶æ³¨å†Œè¯¥ç±»çš„Beanå®šä¹‰åˆ°æ³¨å†Œè¡¨ã€‚ ä¸ºæ¯ä¸ª@Serviceæ ‡æ³¨çš„ç±»åˆ›å»ºå¯¹åº”çš„ ServiceBeanï¼Œå¹¶æ³¨å†Œåˆ°æ³¨å†Œè¡¨ã€‚ è§£ææ‰«æåŒ…é›†åˆ 123456789101112131415161718192021222324252627public class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware, ResourceLoaderAware, BeanClassLoaderAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * * @param registry æ³¨å†Œè¡¨ * @throws BeansException */ @Override public void postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry) throws BeansException &#123; // è§£æ packagesToScané›†åˆï¼ŒåŒ…åå¯èƒ½å­˜åœ¨å ä½ç¬¦çš„æƒ…å†µ Set&lt;String&gt; resolvedPackagesToScan = resolvePackagesToScan(packagesToScan); if (!CollectionUtils.isEmpty(resolvedPackagesToScan)) &#123; // æ‰«æ packagesToScan åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œè§¦å‘ Dubbo ServiceBean å®šä¹‰å’Œæ³¨å†Œ registerServiceBeans(resolvedPackagesToScan, registry); &#125; else &#123; if (logger.isWarnEnabled()) &#123; logger.warn(\"packagesToScan is empty , ServiceBean registry will be ignored!\"); &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢çš„ä»£ç ä¸»è¦å¤„ç†åŒ…åå­˜åœ¨å ä½ç¬¦çš„æƒ…å†µï¼ŒåŒæ—¶ä¸Šé¢çš„æ–¹æ³•ä¹Ÿæ˜¯Springçš„Beanåå¤„ç†å™¨çš„å›è°ƒæ–¹æ³•ï¼Œåœ¨Springçš„ç”Ÿå‘½å‘¨æœŸå†…è¿›è¡Œå›è°ƒã€‚æ¥ä¸‹æˆ‘ä»¬çœ‹æ‰«æDubboçš„ @Service æ³¨è§£çš„é€»è¾‘ã€‚ æ‰«æDubboçš„ @Service æ³¨è§£ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657public class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware, ResourceLoaderAware, BeanClassLoaderAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * æ‰«æ packagesToScan åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ * &lt;p&gt; * Registers Beans whose classes was annotated &#123;@link Service&#125; * * @param packagesToScan è¦æ‰«æçš„åŒ…é›†åˆ * @param registry æ³¨å†Œè¡¨ */ private void registerServiceBeans(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry) &#123; // åˆ›å»º Dubboçš„ç±»è·¯å¾„Beanå®šä¹‰æ‰«æå¯¹è±¡ï¼Œè¯¥ç±»ç»§æ‰¿äº†Springçš„ ClassPathBeanDefinitionScannerï¼Œå³ç”¨äºæ‰«ææŒ‡å®šåŒ…ä¸‹ç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„ç±»åˆ›å»ºå¯¹åº”çš„BeanDefinitionå¯¹è±¡ DubboClassPathBeanDefinitionScanner scanner = new DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader); // è·å¾— BeanNameGenerator å¯¹è±¡ï¼Œå¹¶è®¾ç½® beanNameGenerator åˆ° scanner ä¸­ BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry); scanner.setBeanNameGenerator(beanNameGenerator); // æŒ‡å®šæ‰«æå™¨æ‰«æå¸¦æœ‰Dubboçš„@Serviceæ³¨è§£çš„ç±»ï¼Œä¸ä¼šæ‰«æSpringçš„@Serviceæ³¨è§£ scanner.addIncludeFilter(new AnnotationTypeFilter(Service.class)); // éå†æ‰«æçš„åŒ…é›†åˆ for (String packageToScan : packagesToScan) &#123; // æ‰§è¡Œæ‰«æï¼Œå¹¶æ³¨å†Œç›®æ ‡ç±»çš„Beanå®šä¹‰åˆ°æ³¨å†Œè¡¨ï¼Œä½¿ç”¨beanNameGeneratorç”ŸæˆBeançš„åç§° scanner.scan(packageToScan); // åˆ›å»ºæ¯ä¸ªè¢«æ‰«æçš„ç±»çš„BeanDefinitionHolderå¯¹è±¡ï¼Œè¿”å›BeanDefinitionHolderé›†åˆï¼Œç”¨äºç”ŸæˆServiceBeanå®šä¹‰ã€æ³¨æ„ï¼Œè¿™é‡Œä¹Ÿä¼šåˆ›å»ºæ‰«æçš„ç±»çš„Beanå®šä¹‰ï¼Œä¹Ÿæ˜¯ä½¿ç”¨ beanNameGenerator ç”Ÿæˆåç§°ï¼Œä½†æ²¡æœ‰æ³¨å†Œåˆ°æ³¨å†Œè¡¨ã€‘ Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders = findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator); // ä¸ºæ¯ä¸ª@Serviceæ ‡æ³¨çš„ç±»åˆ›å»ºå¯¹åº”çš„ ServiceBeanï¼Œå¹¶æ³¨å†Œåˆ°æ³¨å†Œè¡¨ã€‚ if (!CollectionUtils.isEmpty(beanDefinitionHolders)) &#123; for (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) &#123; registerServiceBean(beanDefinitionHolder, registry, scanner); &#125; if (logger.isInfoEnabled()) &#123; logger.info(beanDefinitionHolders.size() + \" annotated Dubbo's @Service Components &#123; \" + beanDefinitionHolders + \" &#125; were scanned under package[\" + packageToScan + \"]\"); &#125; &#125; else &#123; if (logger.isWarnEnabled()) &#123; logger.warn(\"No Spring Bean annotating Dubbo's @Service was found under package[\" + packageToScan + \"]\"); &#125; &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢ä»£ç ä¸»è¦åšäº†å››ä»¶äº‹æƒ…ï¼Œå¦‚ä¸‹ï¼š åˆ›å»ºç±»è·¯å¾„æ‰«æå™¨ DubboClassPathBeanDefinitionScannerï¼ŒæŒ‡å®šæ‰«æçš„æ³¨è§£åŒ…å«Dubboçš„@Serviceæ³¨è§£ã€‚ è·å–BeanNameGeneratorå¯¹è±¡ï¼Œç”¨äº @Service æ ‡æ³¨ç±»çš„Beanå®šä¹‰åç§°ã€‚ ä½¿ç”¨æ‰«æå™¨æ‰«æåŒ…ï¼Œæå‡@Serviceæ ‡æ³¨çš„ç±»ä¸ºSpring Beanï¼Œå¹¶æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ã€‚ è·å–ç¬¬3æ­¥çš„Spring Beançš„BeanDefinitionHolderé›†åˆï¼Œå°†ç”¨äºåˆ›å»ºDubboçš„ServiceBeanå¯¹è±¡ã€‚ ä»£ç ä¸­çš„ä¸»è¦é€»è¾‘å·²ç»è¯¦ç»†æ ‡æ³¨ï¼Œèƒ–å‹è‡ªå·±ç…ç…ï¼Œä¸‹é¢æˆ‘ä»¬ç®€å•åˆ†æä¸‹æ‰«æå™¨çš„åŸç†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105ClassPathBeanDefinitionScanner#scan(String... basePackages) &#123; int beanCountAtScanStart = this.registry.getBeanDefinitionCount(); // æ‰«æé€»è¾‘ doScan(basePackages); // Register annotation config processors, if necessary. if (this.includeAnnotationConfig) &#123; AnnotationConfigUtils.registerAnnotationConfigProcessors(this.registry); &#125; return (this.registry.getBeanDefinitionCount() - beanCountAtScanStart); &#125; // æ‰«æåŒ…é€»è¾‘ protected Set&lt;BeanDefinitionHolder&gt; doScan(String... basePackages) &#123; Assert.notEmpty(basePackages, \"At least one base package must be specified\"); Set&lt;BeanDefinitionHolder&gt; beanDefinitions = new LinkedHashSet&lt;BeanDefinitionHolder&gt;(); for (String basePackage : basePackages) &#123; // ä»åŒ…ä¸­è·å–å€™é€‰BeanDefinition Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage); for (BeanDefinition candidate : candidates) &#123; ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(candidate); candidate.setScope(scopeMetadata.getScopeName()); // ä½¿ç”¨beanNameGenerator ç”ŸæˆBeanDefinitionçš„åç§° String beanName = this.beanNameGenerator.generateBeanName(candidate, this.registry); if (candidate instanceof AbstractBeanDefinition) &#123; postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName); &#125; if (candidate instanceof AnnotatedBeanDefinition) &#123; AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate); &#125; // æ˜¯å¦æ˜¯å€™é€‰BeanDefinition if (checkCandidate(beanName, candidate)) &#123; BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(candidate, beanName); definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry); beanDefinitions.add(definitionHolder); // æ³¨å†Œåˆ°æ³¨å†Œè¡¨ registerBeanDefinition(definitionHolder, this.registry); &#125; &#125; &#125; return beanDefinitions; &#125; /** * ä»åŒ…ä¸­è·å–BeanDefinitioné›†åˆ * * Scan the class path for candidate components. * @param basePackage the package to check for annotated classes * @return a corresponding Set of autodetected bean definitions */ public Set&lt;BeanDefinition&gt; findCandidateComponents(String basePackage) &#123; Set&lt;BeanDefinition&gt; candidates = new LinkedHashSet&lt;BeanDefinition&gt;(); try &#123; // ç±»è·¯å¾„ä¸‹çš„æŒ‡å®šåŒ…ä¸‹çš„æ‰€æœ‰.classæ–‡ä»¶ ï¼ˆå¦‚ï¼šclasspath*:com/code/resource/reading/consumer/annotation/consumer/**/*.classï¼‰ String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX + resolveBasePackage(basePackage) + '/' + this.resourcePattern; Resource[] resources = this.resourcePatternResolver.getResources(packageSearchPath); boolean traceEnabled = logger.isTraceEnabled(); boolean debugEnabled = logger.isDebugEnabled(); for (Resource resource : resources) &#123; if (traceEnabled) &#123; logger.trace(\"Scanning \" + resource); &#125; if (resource.isReadable()) &#123; try &#123; MetadataReader metadataReader = this.metadataReaderFactory.getMetadataReader(resource); // æ˜¯å¦æ˜¯å€™é€‰ BeanDefinition if (isCandidateComponent(metadataReader)) &#123; // åˆ›å»º BeanDefinition ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader); sbd.setResource(resource); sbd.setSource(resource); if (isCandidateComponent(sbd)) &#123; if (debugEnabled) &#123; logger.debug(\"Identified candidate component class: \" + resource); &#125; candidates.add(sbd); &#125; else &#123; if (debugEnabled) &#123; logger.debug(\"Ignored because not a concrete top-level class: \" + resource); &#125; &#125; &#125; else &#123; if (traceEnabled) &#123; logger.trace(\"Ignored because not matching any filter: \" + resource); &#125; &#125; &#125; catch (Throwable ex) &#123; throw new BeanDefinitionStoreException( \"Failed to read candidate component class: \" + resource, ex); &#125; &#125; else &#123; if (traceEnabled) &#123; logger.trace(\"Ignored because not readable: \" + resource); &#125; &#125; &#125; &#125; catch (IOException ex) &#123; throw new BeanDefinitionStoreException(\"I/O failure during classpath scanning\", ex); &#125; return candidates; &#125; æˆ‘ä»¬åªè¦å¤§è‡´äº†è§£ä¸‹æ‰«æå™¨æ˜¯æ€ä¹ˆæŠŠæŒ‡å®šåŒ…ä¸‹çš„æ³¨è§£æ ‡æ³¨çš„ç±»æå‡ä¸ºSpring Beanå°±å¯ä»¥äº†ã€‚æœ‰äº†ç›®æ ‡ç±»çš„Beanå®šä¹‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æDubboæ˜¯å¦‚ä½•åˆ›å»ºè¯¥ç›®æ ‡ç±»å¯¹åº”çš„ServiceBeanå¯¹è±¡çš„ã€‚ åˆ›å»ºServiceBeanå¹¶æ³¨å†Œåˆ°æ³¨å†Œè¡¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware, ResourceLoaderAware, BeanClassLoaderAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;/** * Registers &#123;@link ServiceBean&#125; from new annotated &#123;@link Service&#125; &#123;@link BeanDefinition&#125; * * @param beanDefinitionHolder @Serviceæ ‡æ³¨çš„ç±»çš„BeanDefinitionHolder * @param registry æ³¨å†Œè¡¨ * @param scanner æ‰«æå™¨ * @see ServiceBean * @see BeanDefinition */ private void registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry, DubboClassPathBeanDefinitionScanner scanner) &#123; // ä»holderä¸­å–å‡ºBeanDefinitionï¼Œå¹¶è§£æå‡ºå¯¹åº”çš„ç±» Class&lt;?&gt; beanClass = resolveClass(beanDefinitionHolder); // è·å¾—@Service æ³¨è§£ Service service = findAnnotation(beanClass, Service.class); // è·å¾—æ³¨è§£æ ‡æ³¨ç±»çš„æ¥å£ Class&lt;?&gt; interfaceClass = resolveServiceInterfaceClass(beanClass, service); // è·å¾—Beançš„åå­— String annotatedServiceBeanName = beanDefinitionHolder.getBeanName(); // åˆ›å»ºAbstractBeanDefinition å¯¹è±¡ ï¼Œè¿™é‡ŒçœŸæ­£åˆ›å»ºServiceBean AbstractBeanDefinition serviceBeanDefinition = buildServiceBeanDefinition(service, interfaceClass, annotatedServiceBeanName); // é‡æ–°ç”ŸæˆBean çš„åå­— ã€æ ¼å¼ï¼šServiceBean:$&#123;interfaceClassName&#125;:$&#123;version&#125;:$&#123;group&#125;ã€‘ï¼Œé‡æ–°åˆ›å»ºçš„ServiceBeanåç§°æ˜¯æŠŠä¸Šé¢çš„BeanDefinitionæ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ï¼Œéœ€è¦ä¸€ä¸ªåç§° String beanName = generateServiceBeanName(service, interfaceClass, annotatedServiceBeanName); // æ ¡éªŒåœ¨ æ³¨å†Œè¡¨ ä¸­æ˜¯å¦å·²ç»å­˜åœ¨beanNameï¼Œè‹¥ä¸å­˜åœ¨åˆ™è¿›è¡Œæ³¨å†Œ if (scanner.checkCandidate(beanName, serviceBeanDefinition)) &#123; // æ³¨å†Œ registry.registerBeanDefinition(beanName, serviceBeanDefinition); if (logger.isInfoEnabled()) &#123; logger.warn(\"The BeanDefinition[\" + serviceBeanDefinition + \"] of ServiceBean has been registered with name : \" + beanName); &#125; &#125; else &#123; if (logger.isWarnEnabled()) &#123; logger.warn(\"The Duplicated BeanDefinition[\" + serviceBeanDefinition + \"] of ServiceBean[ bean name : \" + beanName + \"] was be found , Did @DubboComponentScan scan to same package in many times?\"); &#125; &#125; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢çš„æ–¹æ³•ä¸»è¦æ˜¯ä¸ºåˆ›å»ºServiceBeanæä¾›æ¡ä»¶ï¼Œå¦‚ï¼šè·å–Dubboçš„@Serviceæ ‡æ³¨ç±»çš„ClassåŠæ¥å£ã€è·å–@Serviceä¿¡æ¯ã€è·å–Dubboçš„@Serviceæ ‡æ³¨ç±»çš„Beanå®šä¹‰çš„åç§°ã€‚æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œå°±å¯ä»¥åˆ›å»ºç›®æ ‡æœåŠ¡ç±»ï¼ˆDubboçš„@Serviceæ ‡æ³¨çš„ç±»ï¼‰çš„ServiceBeanã€‚åœ¨åˆ†æåˆ›å»ºServiceBeanä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ç›®æ ‡æœåŠ¡ç±»çš„æ¥å£è·å–é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware, ResourceLoaderAware, BeanClassLoaderAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * è·å¾—@Service æ³¨è§£çš„ç±»çš„æ¥å£ * * @param annotatedServiceBeanClass * @param service * @return */ private Class&lt;?&gt; resolveServiceInterfaceClass(Class&lt;?&gt; annotatedServiceBeanClass, Service service) &#123; // ä»æ³¨è§£å±æ€§ä¸­è·å– Class&lt;?&gt; interfaceClass = service.interfaceClass(); if (void.class.equals(interfaceClass)) &#123; interfaceClass = null; // è·å¾—@Service æ³¨è§£çš„interfaceName å±æ€§ String interfaceClassName = service.interfaceName(); // å¦‚æœå­˜åœ¨ï¼Œè·å¾—å…¶å¯¹åº”çš„ç±» if (StringUtils.hasText(interfaceClassName)) &#123; if (ClassUtils.isPresent(interfaceClassName, classLoader)) &#123; interfaceClass = resolveClassName(interfaceClassName, classLoader); &#125; &#125; &#125; //ä»æ³¨è§£å±æ€§ä¸­è·å¾—ä¸åˆ°ï¼Œåˆ™ä»è¢«æ³¨è§£çš„ç±»ä¸Šè·å¾—å…¶å®ç°çš„ç¬¬ä¸€ä¸ªæ¥å£ if (interfaceClass == null) &#123; // è·å–æ¥å£åˆ—è¡¨ Class&lt;?&gt;[] allInterfaces = annotatedServiceBeanClass.getInterfaces(); // å­˜åœ¨çš„è¯å–ç¬¬ä¸€ä¸ªæ¥å£ if (allInterfaces.length &gt; 0) &#123; interfaceClass = allInterfaces[0]; &#125; &#125; Assert.notNull(interfaceClass,\"@Service interfaceClass() or interfaceName() or interface class must be present!\"); Assert.isTrue(interfaceClass.isInterface(),\"The type that was annotated @Service is not an interface!\"); return interfaceClass; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è·å–ç›®æ ‡æœåŠ¡ç±»çš„æ¥å£è§„åˆ™æ˜¯å…ˆä»@Serviceæ³¨è§£å±æ€§ä¸­å–ï¼Œæ²¡æœ‰è®¾ç½®å†è·å–ç›®æ ‡æœåŠ¡ç±»çš„ç¬¬ä¸€ä¸ªå®ç°æ¥å£ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹ServiceBeançš„å®šä¹‰å¦‚ä½•ç”Ÿæˆï¼Œå¯ä»¥å¯¹æ¯”ä¸‹XMLé…ç½®çš„ç”Ÿæˆè§„åˆ™ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182public class ServiceAnnotationBeanPostProcessor implements BeanDefinitionRegistryPostProcessor, EnvironmentAware, ResourceLoaderAware, BeanClassLoaderAware &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;/** * åˆ›å»ºAbstraceBeanDefinitionå¯¹è±¡ * * @param service @Service æ³¨è§£ * @param interfaceClass ç›®æ ‡æœåŠ¡ç±»çš„æ¥å£ * @param annotatedServiceBeanName ç›®æ ‡æœåŠ¡ç±»çš„Beanå®šä¹‰çš„åç§° * @return */ private AbstractBeanDefinition buildServiceBeanDefinition(Service service, Class&lt;?&gt; interfaceClass, String annotatedServiceBeanName) &#123; // åˆ›å»ºServiceBeançš„BeanDefinitionBuilderå¯¹è±¡ BeanDefinitionBuilder builder = rootBeanDefinition(ServiceBean.class); // è·å¾—ServiceBeançš„AbstractBeanDefinition å¯¹è±¡ AbstractBeanDefinition beanDefinition = builder.getBeanDefinition(); // è·å¾— MutablePropertyValueså¯¹è±¡ï¼Œåç»­å¯ä»¥é€šè¿‡å®ƒä¸ºServiceBeanæ·»åŠ å±æ€§ MutablePropertyValues propertyValues = beanDefinition.getPropertyValues(); // åˆ›å»ºAnnotationPropertyValuesAdapter å¯¹è±¡ï¼Œæ·»åŠ åˆ°propertyValuesä¸­ã€‚æ³¨æ„æ˜¯å°†æ³¨è§£ä¸Šçš„å±æ€§è®¾ç½®åˆ°PropertyValuesä¸­ï¼Œå¹¶ä¸”æŒ‡å®šå“ªäº›å±æ€§è¦å¿½ç•¥ã€‚è¢«å¿½ç•¥çš„å±æ€§ä¼šå•ç‹¬è®¾ç½®ã€‚ String[] ignoreAttributeNames = of(\"provider\", \"monitor\", \"application\", \"module\", \"registry\", \"protocol\", \"interface\"); propertyValues.addPropertyValues(new AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames)); // è®¾ç½®ServiceBean ref å±æ€§ï¼Œå³@Serviceæ ‡æ³¨çš„ç±»çš„Beanå®šä¹‰åç§° addPropertyReference(builder, \"ref\", annotatedServiceBeanName); // è®¾ç½®ServiceBeançš„ interface å±æ€§ builder.addPropertyValue(\"interface\", interfaceClass.getName()); // æ·»åŠ ServiceBeançš„ provider å±æ€§ String providerConfigBeanName = service.provider(); if (StringUtils.hasText(providerConfigBeanName)) &#123; addPropertyReference(builder, \"provider\", providerConfigBeanName); &#125; // æ·»åŠ ServiceBeançš„monitorå±æ€§ String monitorConfigBeanName = service.monitor(); if (StringUtils.hasText(monitorConfigBeanName)) &#123; addPropertyReference(builder, \"monitor\", monitorConfigBeanName); &#125; // æ·»åŠ ServiceBean çš„ application å±æ€§ String applicationConfigBeanName = service.application(); if (StringUtils.hasText(applicationConfigBeanName)) &#123; addPropertyReference(builder, \"application\", applicationConfigBeanName); &#125; // æ·»åŠ ServiceBeançš„ module å±æ€§å¯¹åº”çš„ ModuleConfig Bean å¯¹è±¡ String moduleConfigBeanName = service.module(); if (StringUtils.hasText(moduleConfigBeanName)) &#123; addPropertyReference(builder, \"module\", moduleConfigBeanName); &#125; //-------------- ä¸‹é¢ä¸¤ä¸ªå±æ€§å’Œä¸Šé¢çš„ä¸ä¸€æ ·ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰å¤šä¸ª ï¼Œå³å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®çš„æƒ…å†µ-------------------/ // æ·»åŠ ServiceBeançš„ registries å±æ€§ String[] registryConfigBeanNames = service.registry(); List&lt;RuntimeBeanReference&gt; registryRuntimeBeanReferences = toRuntimeBeanReferences(registryConfigBeanNames); if (!registryRuntimeBeanReferences.isEmpty()) &#123; builder.addPropertyValue(\"registries\", registryRuntimeBeanReferences); &#125; // æ·»åŠ ServiceBeançš„ protocols å±æ€§ String[] protocolConfigBeanNames = service.protocol(); List&lt;RuntimeBeanReference&gt; protocolRuntimeBeanReferences = toRuntimeBeanReferences(protocolConfigBeanNames); if (!protocolRuntimeBeanReferences.isEmpty()) &#123; builder.addPropertyValue(\"protocols\", protocolRuntimeBeanReferences); &#125; return builder.getBeanDefinition(); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢çš„ä»£ç å°±æ˜¯ä¸ºServiceBeanè®¾ç½®ç®€å•å±æ€§å€¼å’Œå¼•ç”¨ç±»å‹çš„å€¼ï¼Œå½“ServiceBeançš„å±æ€§æ˜¯å¼•ç”¨ç±»å‹æ—¶ï¼Œè§£æå™¨ä¼šä¾æ®ä¾èµ–beançš„nameåˆ›å»ºä¸€ä¸ªRuntimeBeanReferenceå¯¹åƒï¼Œå°†è¿™ä¸ªå¯¹åƒæ”¾å…¥ServiceBeançš„BeanDefinitionçš„MutablePropertyValuesä¸­ã€‚ServiceBeançš„Beanå®šä¹‰åˆ›å»ºå®Œæˆåï¼Œæ¥ç€å°±æŠŠè¯¥Beanå®šä¹‰æ³¨å†Œåˆ°æ³¨å†Œè¡¨ä¸­ã€‚è‡³æ­¤ï¼Œæ‰«æ @Service æ³¨è§£çš„Beanåç½®å¤„ç†å™¨é€»è¾‘å·²ç»åˆ†æå®Œæ¯•ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹åˆ†ææ‰«æ @Reference æ³¨è§£çš„åç½®å¤„ç†å™¨ã€‚ åˆ›å»ºæ‰«æ @Reference æ³¨è§£çš„åç½®å¤„ç†å™¨123456789101112131415161718public class DubboComponentScanRegistrar implements ImportBeanDefinitionRegistrar &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * Registers &#123;@link ReferenceAnnotationBeanPostProcessor&#125; into &#123;@link BeanFactory&#125; * * @param registry &#123;@link BeanDefinitionRegistry&#125; */ private void registerReferenceAnnotationBeanPostProcessor(BeanDefinitionRegistry registry) &#123; // Register @Reference Annotation Bean Processor BeanRegistrar.registerInfrastructureBean(registry, ReferenceAnnotationBeanPostProcessor.BEAN_NAME, ReferenceAnnotationBeanPostProcessor.class); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; åˆ›å»ºæ‰«æ @Reference æ³¨è§£çš„åç½®å¤„ç†å™¨éœ€è¦æ³¨æ„è¯¥Beanå®šä¹‰çš„åç§°æ˜¯ referenceAnnotationBeanPostProcessorï¼Œæ˜¯å¸¸é‡ç»´æŠ¤çš„ã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹åˆ†æReferenceAnnotationBeanPostProcessorçš„é€»è¾‘ï¼Œçœ‹å®ƒåˆæ˜¯å¦‚ä½•ä¸º @Reference æ³¨è§£çš„å±æ€§æˆ–æ–¹æ³•å¼•å…¥ä»£ç†å¯¹è±¡ã€‚ ReferenceAnnotationBeanPostProcessor12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576/** * &#123;@link org.springframework.beans.factory.config.BeanPostProcessor&#125; implementation * that Consumer service &#123;@link Reference&#125; annotated fields * @since 2.5.7 */public class ReferenceAnnotationBeanPostProcessor extends AnnotationInjectedBeanPostProcessor&lt;Reference&gt; implements ApplicationContextAware, ApplicationListener &#123; /** * The bean name of &#123;@link ReferenceAnnotationBeanPostProcessor&#125; */ public static final String BEAN_NAME = \"referenceAnnotationBeanPostProcessor\"; /** * Cache size */ private static final int CACHE_SIZE = Integer.getInteger(BEAN_NAME + \".cache.size\", 32); /** * ReferenceBean ç¼“å­˜ Map,key:Reference Bean çš„åå­— */ private final ConcurrentMap&lt;String, ReferenceBean&lt;?&gt;&gt; referenceBeanCache = new ConcurrentHashMap&lt;String, ReferenceBean&lt;?&gt;&gt;(CACHE_SIZE); /** * ReferenceBeanInvocationHandler ç¼“å­˜ Mapï¼Œkeyï¼šReference Beançš„åå­— */ private final ConcurrentHashMap&lt;String, ReferenceBeanInvocationHandler&gt; localReferenceBeanInvocationHandlerCache = new ConcurrentHashMap&lt;String, ReferenceBeanInvocationHandler&gt;(CACHE_SIZE); /** * ä½¿ç”¨å±æ€§è¿›è¡Œæ³¨å…¥çš„ @Reference Bean çš„ç¼“å­˜ Mapã€‚ï¼ˆè¿™ç§æ–¹å¼ä½¿ç”¨çš„è¾ƒå¤šï¼‰ */ private final ConcurrentMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; injectedFieldReferenceBeanCache = new ConcurrentHashMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt;(CACHE_SIZE); /** * ä½¿ç”¨æ–¹æ³•è¿›è¡Œæ³¨å…¥çš„ @Reference Bean çš„ç¼“å­˜ Map */ private final ConcurrentMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; injectedMethodReferenceBeanCache = new ConcurrentHashMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt;(CACHE_SIZE); /** * åº”ç”¨ä¸Šä¸‹æ–‡ */ private ApplicationContext applicationContext; /** * Gets all beans of &#123;@link ReferenceBean&#125; * * @return non-null read-only &#123;@link Collection&#125; * @since 2.5.9 */ public Collection&lt;ReferenceBean&lt;?&gt;&gt; getReferenceBeans() &#123; return referenceBeanCache.values(); &#125; /** * Get &#123;@link ReferenceBean&#125; &#123;@link Map&#125; in injected field. * * @return non-null &#123;@link Map&#125; * @since 2.5.11 */ public Map&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; getInjectedFieldReferenceBeanMap() &#123; return Collections.unmodifiableMap(injectedFieldReferenceBeanCache); &#125; /** * Get &#123;@link ReferenceBean&#125; &#123;@link Map&#125; in injected method. * * @return non-null &#123;@link Map&#125; * @since 2.5.11 */ public Map&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; getInjectedMethodReferenceBeanMap() &#123; return Collections.unmodifiableMap(injectedMethodReferenceBeanCache); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢ä»£ç æ˜¯æ‰«æ @Reference æ³¨è§£çš„åç½®å¤„ç†å™¨çš„å±æ€§ä¿¡æ¯ï¼Œè¯¥ç±»ç»§æ‰¿äº†AnnotationInjectedBeanPostProcessoræŠ½è±¡ç±»ï¼Œè¯¥ç±»ä¸­æœ‰å‡ ä¸ªå¾ˆé‡è¦çš„æ–¹æ³•å’Œç±»ï¼Œå®ƒä»¬å±äºSpringæºç çš„çŸ¥è¯†ç‚¹ï¼Œä¸ºäº†ä½¿æ•´ä¸ªé€»è¾‘å®Œæ•´æˆ‘ä»¬è¿˜æ˜¯ä¸€èµ·æ¥çœ‹çœ‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147public abstract class AnnotationInjectedBeanPostProcessor&lt;A extends Annotation&gt; extends InstantiationAwareBeanPostProcessorAdapter implements MergedBeanDefinitionPostProcessor, PriorityOrdered, BeanFactoryAware, BeanClassLoaderAware, EnvironmentAware, DisposableBean &#123; // $&#123;çœç•¥å…¶ä»–çš„ä»£ç &#125; // 1. Beanåç½®å¤„ç†å™¨çš„å›è°ƒæ–¹æ³• @Override public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName) &#123; if (beanType != null) &#123; // è·å–BeanTypeä¸­çš„å­—æ®µå’Œæ–¹æ³•ä¸Šçš„æ³¨è§£ï¼Œå³å¯¹äºDubboæ¡†æ¶æ¥è¯´å°±æ˜¯æŸ¥æ‰¾Beanæ‰€æœ‰æ ‡æ³¨äº†@Referenceçš„å­—æ®µå’Œæ–¹æ³•ã€‚ InjectionMetadata metadata = findInjectionMetadata(beanName, beanType, null); metadata.checkConfigMembers(beanDefinition); &#125; &#125; // 5. åˆ›å»ºBeanå¯¹è±¡çš„è¿‡ç¨‹ä¸­éœ€è¦å¡«å……Beanå¯¹è±¡çš„å±æ€§å€¼ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚å³åœ¨Springçš„Beanåˆå§‹åŒ–å‰ä¼šè§¦å‘è¯¥æ–¹æ³•ã€‚ @Override public PropertyValues postProcessPropertyValues( PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeanCreationException &#123; // è·å–Beanå¯¹è±¡çš„ç±»ä¸­çš„å­—æ®µå’Œæ–¹æ³•çš„æ³¨è§£å¯¹è±¡ - AnnotatedInjectionMetadataï¼Œå³å¯¹äºDubboæ¡†æ¶æ¥è¯´å°±æ˜¯æŸ¥æ‰¾Beanæ‰€æœ‰æ ‡æ³¨äº†@Referenceçš„å­—æ®µå’Œæ–¹æ³•ã€‚ InjectionMetadata metadata = findInjectionMetadata(beanName, bean.getClass(), pvs); try &#123; // è°ƒç”¨AnnotatedInjectionMetadataçš„injectæ–¹æ³•ï¼Œå¯¹å­—æ®µæˆ–æ–¹æ³•è¿›è¡Œåå°„ç»‘å®š metadata.inject(bean, beanName, pvs); &#125; catch (BeanCreationException ex) &#123; throw ex; &#125; catch (Throwable ex) &#123; throw new BeanCreationException(beanName, \"Injection of @\" + getAnnotationType().getName() + \" dependencies is failed\", ex); &#125; return pvs; &#125; /** * 4. å±æ€§å’Œæ–¹æ³•æ³¨è§£åŒ…è£…å¯¹è±¡ * &#123;@link A&#125; &#123;@link InjectionMetadata&#125; implementation */ private class AnnotatedInjectionMetadata extends InjectionMetadata &#123; // å­—æ®µæ³¨è§£å¯¹è±¡é›†åˆ private final Collection&lt;AnnotatedFieldElement&gt; fieldElements; // æ–¹æ³•æ³¨è§£å¯¹è±¡é›†åˆ private final Collection&lt;AnnotatedMethodElement&gt; methodElements; public AnnotatedInjectionMetadata(Class&lt;?&gt; targetClass, Collection&lt;AnnotatedFieldElement&gt; fieldElements, Collection&lt;AnnotatedMethodElement&gt; methodElements) &#123; super(targetClass, combine(fieldElements, methodElements)); this.fieldElements = fieldElements; this.methodElements = methodElements; &#125; public Collection&lt;AnnotatedFieldElement&gt; getFieldElements() &#123; return fieldElements; &#125; public Collection&lt;AnnotatedMethodElement&gt; getMethodElements() &#123; return methodElements; &#125; &#125; /** * 3. æ–¹æ³•æ³¨è§£ * &#123;@link A&#125; &#123;@link Method&#125; &#123;@link InjectionMetadata.InjectedElement&#125; */ private class AnnotatedMethodElement extends InjectionMetadata.InjectedElement &#123; // æ–¹æ³•å¯¹è±¡ private final Method method; // æ³¨è§£ private final A annotation; private volatile Object object; protected AnnotatedMethodElement(Method method, PropertyDescriptor pd, A annotation) &#123; super(method, pd); this.method = method; this.annotation = annotation; &#125; @Override protected void inject(Object bean, String beanName, PropertyValues pvs) throws Throwable &#123; // è·å–å±æ€§ç±»å‹ Class&lt;?&gt; injectedType = pd.getPropertyType(); // Hå¶å»ä¾èµ– Object injectedObject = getInjectedObject(annotation, bean, beanName, injectedType, this); // è®¾ç½®å¯è®¿é—® ReflectionUtils.makeAccessible(method); // åå°„æ³¨å…¥ä¾èµ– method.invoke(bean, injectedObject); &#125; &#125; /** * 2. å±æ€§æ³¨è§£ * &#123;@link A&#125; &#123;@link Field&#125; &#123;@link InjectionMetadata.InjectedElement&#125; */ public class AnnotatedFieldElement extends InjectionMetadata.InjectedElement &#123; // å±æ€§å¯¹è±¡ private final Field field; // æ³¨è§£ private final A annotation; private volatile Object bean; protected AnnotatedFieldElement(Field field, A annotation) &#123; super(field, null); this.field = field; this.annotation = annotation; &#125; @Override protected void inject(Object bean, String beanName, PropertyValues pvs) throws Throwable &#123; // è·å–å±æ€§ç±»å‹ Class&lt;?&gt; injectedType = field.getType(); // è·å–ä¾èµ– Object injectedObject = getInjectedObject(annotation, bean, beanName, injectedType, this); // è®¾ç½®å¯è®¿é—® ReflectionUtils.makeAccessible(field); // åå°„è®¾ç½®å€¼ field.set(bean, injectedObject); &#125; &#125;&#125;public class InjectionMetadata &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; // 3. éå†æ³¨å…¥å…ƒç´ å¯¹è±¡ï¼ˆå¯èƒ½æ˜¯å­—æ®µï¼Œä¹Ÿå¯èƒ½æ˜¯æ–¹æ³•ï¼‰ï¼Œå®Œæˆæ³¨å…¥ public void inject(Object target, String beanName, PropertyValues pvs) throws Throwable &#123; // Collection&lt;InjectedElement&gt; elementsToIterate = (this.checkedElements != null ? this.checkedElements : this.injectedElements); if (!elementsToIterate.isEmpty()) &#123; boolean debug = logger.isDebugEnabled(); for (InjectedElement element : elementsToIterate) &#123; if (debug) &#123; logger.debug(\"Processing injected element of bean '\" + beanName + \"': \" + element); &#125; element.inject(target, beanName, pvs); &#125; &#125; &#125;&#125; ä¸Šé¢çš„ä»£ç æ‰§è¡Œçš„é¡ºåºå·²ç»æ ‡æ³¨ï¼Œæ‰§è¡Œé¡ºåºæ¯”è¾ƒç²—ç•¥ï¼Œå…ˆæŸ¥æ‰¾æœåŠ¡å¼•ç”¨çš„å­—æ®µæˆ–æ–¹æ³•ï¼Œç„¶åè§¦å‘å­—æ®µæˆ–æ–¹æ³•å€¼çš„åå°„æ³¨å…¥ã€‚ä½†æ˜¯ç›®çš„å·²ç»è¾¾åˆ°äº†ï¼Œä»ä»£ç ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ³¨è§£ä¿¡æ¯å·²ç»æ”¶é›†å®Œæ¯•ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è·å–ä¾èµ–å¯¹è±¡äº†ï¼Œæ‰¾åˆ°ä¾èµ–å¯¹è±¡å°±å¯ä»¥é€šè¿‡åå°„æ³¨å…¥ï¼Œå¯¹äº@Referenceæ³¨è§£è€Œè¨€ï¼Œè·å–ä¾èµ–çš„æ–¹æ³•å°±æ˜¯ ReferenceAnnotationBeanPostProcessor#doGetInjectedBeanã€‚ä¸‹é¢æˆ‘ä»¬å¼€å§‹åˆ†æ ReferenceAnnotationBeanPostProcessor ä¸­çš„é€»è¾‘ã€‚ è·å–è¦æ³¨å…¥çš„ä¾èµ–Bean 123456789101112131415161718192021222324252627282930313233343536373839public class ReferenceAnnotationBeanPostProcessor extends AnnotationInjectedBeanPostProcessor&lt;Reference&gt; implements ApplicationContextAware, ApplicationListener &#123; // $&#123;çœç•¥ä»£ç &#125; /** * è·å¾—è¦æ³¨å…¥çš„ ä¾èµ– * * @param reference @Referenceæ³¨è§£ * @param bean @Referenceæ³¨è§£æ ‡æ³¨å±æ€§æˆ–æ–¹æ³•æ‰€åœ¨çš„ç±»çš„å¯¹è±¡ * @param beanName @Referenceæ³¨è§£æ ‡æ³¨å±æ€§æˆ–æ–¹æ³•æ‰€åœ¨çš„ç±»çš„å¯¹è±¡åç§° * @param injectedType è¦æ³¨å…¥ä¾èµ–çš„ç±»å‹ * @param injectedElement æ³¨å…¥å…ƒä¿¡æ¯ * @return * @throws Exception */ @Override protected Object doGetInjectedBean(Reference reference, Object bean, String beanName, Class&lt;?&gt; injectedType, InjectionMetadata.InjectedElement injectedElement) throws Exception &#123; // 1 è·å¾—è¦æ³¨å…¥ä¾èµ–çš„åå­— String referencedBeanName = buildReferencedBeanName(reference, injectedType); // 2 åˆ›å»ºReferenceBean å¯¹è±¡ [æ¯”è¾ƒå¤æ‚] ReferenceBean referenceBean = buildReferenceBeanIfAbsent(referencedBeanName, reference, injectedType, getClassLoader()); // 3 ç¼“å­˜åˆ° injectedFieldReferenceBeanCache æˆ– injectedMethodReferenceBeanCache cacheInjectedReferenceBean(referenceBean, injectedElement); // 4 åˆ›å»º Proxy ä»£ç† Object proxy = buildProxy(referencedBeanName, referenceBean, injectedType); return proxy; &#125;// $&#123;çœç•¥ä»£ç &#125;&#125; doGetInjectedBean æ–¹æ³•ä¸»è¦å®Œæˆä»¥ä¸Š4ä¸ªæµç¨‹ï¼Œæˆ‘ä»¬é‡ç‚¹åˆ†æåˆ›å»ºReferenceBeanå’ŒProxyä»£ç†æµç¨‹ã€‚ åˆ›å»ºReferenceBeanå¯¹è±¡ 123456789101112131415161718192021222324252627282930313233343536public class ReferenceAnnotationBeanPostProcessor extends AnnotationInjectedBeanPostProcessor&lt;Reference&gt; implements ApplicationContextAware, ApplicationListener &#123; // $&#123;çœç•¥ä»£ç &#125;/** * è·å¾— ReferenceBean å¯¹è±¡ * * @param referencedBeanName * @param reference * @param referencedType * @param classLoader * @return * @throws Exception */ private ReferenceBean buildReferenceBeanIfAbsent(String referencedBeanName, Reference reference, Class&lt;?&gt; referencedType, ClassLoader classLoader) throws Exception &#123; // å…ˆä»ç¼“å­˜ä¸­è·å¾—referencedBeanName å¯¹åº”çš„ ReferenceBean å¯¹è±¡ ReferenceBean&lt;?&gt; referenceBean = referenceBeanCache.get(referencedBeanName); // å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»ºï¼Œç„¶åæ·»åŠ åˆ°ç¼“å­˜ä¸­ if (referenceBean == null) &#123; ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder .create(reference, classLoader, applicationContext) // å¼•ç”¨ç±»å‹ä½œä¸ºæ¥å£ç±»å‹ .interfaceClass(referencedType); // åˆ›å»ºReferenceBeanã€1. åˆ›å»ºReferenceBeanå¯¹è±¡ 2.ReferenceBean é…ç½®ã€‘ referenceBean = beanBuilder.build(); referenceBeanCache.put(referencedBeanName, referenceBean); &#125; return referenceBean; &#125;// $&#123;çœç•¥ä»£ç &#125;&#125; buildReferenceBeanIfAbsent æ–¹æ³•åŸºæœ¬æ²¡æœ‰æ ¸å¿ƒé€»è¾‘ï¼Œæ‰€æœ‰çš„é€»è¾‘éƒ½å°è£…åœ¨äº† ReferenceBeanBuilder ä¸­ï¼Œå®ƒæ˜¯ReferenceBeançš„æ„å»ºå™¨ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›è¯¥ç±»ã€‚ ReferenceBeanå¯¹è±¡çš„æ„å»ºå™¨ 12345678910111213141516171819202122232425262728class ReferenceBeanBuilder extends AbstractAnnotationConfigBeanBuilder&lt;Reference, ReferenceBean&gt; &#123; /** * å°†æ³¨è§£çš„å±æ€§è®¾ç½®åˆ°ReferenceBeanï¼Œå¿½ç•¥ä»¥ä¸‹å±æ€§ï¼Œè¿™äº›å±æ€§ä¼šå•ç‹¬å¤„ç† */ static final String[] IGNORE_FIELD_NAMES = of(\"application\", \"module\", \"consumer\", \"monitor\", \"registry\"); private ReferenceBeanBuilder(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext) &#123; super(annotation, classLoader, applicationContext); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * åˆ›å»ºReferenceBeanBuilder * * @param annotation * @param classLoader * @param applicationContext * @return */ public static ReferenceBeanBuilder create(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext) &#123; // åˆ›å»º ReferenceBean çš„æ„å»ºå™¨ return new ReferenceBeanBuilder(annotation, classLoader, applicationContext); &#125;&#125;` ç”±äºå¾ˆå¤šå±æ€§éƒ½åœ¨å…¶çˆ¶ç±» AbstractAnnotationConfigBeanBuilder ä¸­ï¼Œå¦‚ä¸Šé¢çš„interfaceClassï¼Œä»¥åŠå¾ˆé‡è¦çš„buildæ–¹æ³•ã€‚æˆ‘ä»¬å†åˆ†æä¸‹è¯¥ç±»ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950abstract class AbstractAnnotationConfigBeanBuilder&lt;A extends Annotation, B extends AbstractInterfaceConfig&gt; &#123; protected final Log logger = LogFactory.getLog(getClass()); /** * æ³¨è§£ */ protected final A annotation; /** * åº”ç”¨ä¸Šä¸‹æ–‡ */ protected final ApplicationContext applicationContext; /** * ç±»åŠ è½½å™¨ */ protected final ClassLoader classLoader; /** * Bean å¯¹è±¡ */ protected Object bean; /** * æ¥å£ */ protected Class&lt;?&gt; interfaceClass; // æ„é€ æ–¹æ³• protected AbstractAnnotationConfigBeanBuilder(A annotation, ClassLoader classLoader, ApplicationContext applicationContext) &#123; Assert.notNull(annotation, \"The Annotation must not be null!\"); Assert.notNull(classLoader, \"The ClassLoader must not be null!\"); Assert.notNull(applicationContext, \"The ApplicationContext must not be null!\"); this.annotation = annotation; this.applicationContext = applicationContext; this.classLoader = classLoader; &#125; public &lt;T extends AbstractAnnotationConfigBeanBuilder&lt;A, B&gt;&gt; T bean(Object bean) &#123; this.bean = bean; return (T) this; &#125; // è®¾ç½®æ¥å£ public &lt;T extends AbstractAnnotationConfigBeanBuilder&lt;A, B&gt;&gt; T interfaceClass(Class&lt;?&gt; interfaceClass) &#123; this.interfaceClass = interfaceClass; return (T) this; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; &#125; ä»¥ä¸Šä»£ç æ¯”è¾ƒç®€å•ï¼Œåªéœ€æ³¨æ„è®¾ç½®çš„æ¥å£å³å¯ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æåˆ›å»ºReferenceBeançš„buildæ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233abstract class AbstractAnnotationConfigBeanBuilder&lt;A extends Annotation, B extends AbstractInterfaceConfig&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * Build &#123;@link B&#125; æ„é€ æ³›å‹Bå¯¹è±¡ï¼Œæ­¤å¤„å°±æ˜¯æ„é€ ReferenceBeanå¯¹è±¡ * * @return non-null * @throws Exception */ public final B build() throws Exception &#123; /** * 1. æ ¡éªŒä¾èµ–ï¼Œç›®å‰æ˜¯ä¸ªç©ºæ–¹æ³• */ checkDependencies(); // 2. åˆ›å»º Bean å¯¹è±¡ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±» B bean = doBuild(); // 3. é…ç½®Bean å¯¹è±¡ configureBean(bean); if (logger.isInfoEnabled()) &#123; logger.info(\"The bean[type:\" + bean.getClass().getSimpleName() + \"] has been built.\"); &#125; return bean; &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä»¥ä¸Šä»£ç ä½¿ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼ï¼Œæˆ‘ä»¬å…ˆçœ‹doBuild()æ–¹æ³•çš„å…·ä½“å®ç°ï¼Œç„¶åå†åˆ†æé…ç½®Beanå¯¹è±¡çš„é€»è¾‘ã€‚ 123456789101112131415161718class ReferenceBeanBuilder extends AbstractAnnotationConfigBeanBuilder&lt;Reference, ReferenceBean&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * ReferenceBeanBuilder#buildçš„æ–¹æ³•è°ƒç”¨ï¼Œç”¨æ¥åˆ›å»ºReferenceå¯¹è±¡ã€‚ã€å¯¹çˆ¶ç±»æ–¹æ³•çš„é‡å†™ã€‘ * * @return */ @Override protected ReferenceBean doBuild() &#123; // åˆ›å»º ReferenceBeanå¯¹è±¡ return new ReferenceBean&lt;Object&gt;(); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸€è¡Œä»£ç å°±æå®šäº†ï¼Œç›´æ¥åˆ›å»ºReferenceBeanå¯¹è±¡ï¼Œæˆ‘ä»¬æ¥ç€åˆ†æé…ç½®Beané€»è¾‘ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243abstract class AbstractAnnotationConfigBeanBuilder&lt;A extends Annotation, B extends AbstractInterfaceConfig&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * é…ç½®ReferenceBeanå¯¹è±¡ * @param bean * @throws Exception */ protected void configureBean(B bean) throws Exception &#123; /** * å‰ç½®é…ç½®Beané€»è¾‘ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±» */ preConfigureBean(annotation, bean); /** * å°è¯•ä»Springä¸­è·å–@Referenceæ³¨è§£ä¸­é…ç½®çš„registryå±æ€§å€¼å¯¹åº”çš„RegistryConfigå¯¹è±¡é›†åˆï¼Œç„¶åè®¾ç½®åˆ°çš„ReferenceBeanå¯¹è±¡çš„registrieså±æ€§ä¸­ */ configureRegistryConfigs(bean); /** * è®¾ç½®ReferenceBeançš„monitorå±æ€§ï¼ŒåŸç†åŒä¸Š */ configureMonitorConfig(bean); /** * è®¾ç½®ReferenceBeançš„applicationå±æ€§ï¼ŒåŸç†åŒä¸Š */ configureApplicationConfig(bean); /** * è®¾ç½® ReferenceBeançš„moduleå±æ€§ï¼ŒåŸç†åŒä¸Š */ configureModuleConfig(bean); /** * åç½®é…ç½®Beané€»è¾‘ï¼Œå…·ä½“å®ç°äº¤ç»™å­ç±» */ postConfigureBean(annotation, bean); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; ä¸Šé¢ä»£ç ä¹Ÿæ˜¯ä½¿ç”¨æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼ï¼Œå…¶ä¸­ReferenceBeançš„registriesã€monitorã€applicationã€moduleå±æ€§çš„å€¼æ˜¯é€šè¿‡è¯¥æ–¹æ³•è¿›è¡Œè®¾ç½®çš„ï¼Œå‰ç½®é…ç½®Beanå’Œåç½®é…ç½®Beançš„é€»è¾‘æ˜¯ç”±å­ç±»å®ç°çš„ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¿›å»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566class ReferenceBeanBuilder extends AbstractAnnotationConfigBeanBuilder&lt;Reference, ReferenceBean&gt; &#123; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125; /** * ReferenceBean çš„å‰ç½®é…ç½® * @param reference * @param referenceBean */ @Override protected void preConfigureBean(Reference reference, ReferenceBean referenceBean) &#123; Assert.notNull(interfaceClass, \"The interface class must set first!\"); // åˆ›å»ºDataBinderå¯¹è±¡,å°†ReferenceBeanåŒ…è£…æˆDataBinder,è¿›è¡Œå±æ€§ç»‘å®šï¼Œç»‘å®šåˆ°çš„å¯¹è±¡å°±æ˜¯ReferenceBean DataBinder dataBinder = new DataBinder(referenceBean); // Register CustomEditors for special fields // æ³¨å†ŒæŒ‡å®šå±æ€§çš„è‡ªå®šä¹‰Editor dataBinder.registerCustomEditor(String.class, \"filter\", new StringTrimmerEditor(true)); dataBinder.registerCustomEditor(String.class, \"listener\", new StringTrimmerEditor(true)); dataBinder.registerCustomEditor(Map.class, \"parameters\", new PropertyEditorSupport() &#123; public void setAsText(String text) throws java.lang.IllegalArgumentException &#123; // Trim all whitespace String content = StringUtils.trimAllWhitespace(text); if (!StringUtils.hasText(content)) &#123; // No content , ignore directly return; &#125; // replace \"=\" to \",\" content = StringUtils.replace(content, \"=\", \",\"); // replace \":\" to \",\" content = StringUtils.replace(content, \":\", \",\"); // String[] to Map Map&lt;String, String&gt; parameters = CollectionUtils.toStringMap(commaDelimitedListToStringArray(content)); setValue(parameters); &#125; &#125;); /** Bind annotation attributes å°†æ³¨è§£çš„å±æ€§è®¾ç½®åˆ°ReferenceBeanä¸­ï¼Œæ’é™¤ &#123;@link IGNORE_FIELD_NAMES&#125; å±æ€§ï¼Œè¿™äº›å±æ€§åç»­å•ç‹¬å¤„ç† &#123;@link AbstractAnnotationConfigBeanBuilder#configureBean(com.alibaba.dubbo.config.AbstractInterfaceConfig) */ dataBinder.bind(new AnnotationPropertyValuesAdapter(reference, applicationContext.getEnvironment(), IGNORE_FIELD_NAMES)); &#125; /** * ReferenceBean çš„åç½®é…ç½® * * @param annotation * @param bean * @throws Exception */ @Override protected void postConfigureBean(Reference annotation, ReferenceBean bean) throws Exception &#123; // è®¾ç½® Spring ä¸Šä¸‹æ–‡åˆ° ReferenceBean ä¸­ï¼Œå¹¶ä¸” å°† Dubbo å’Œ Springå®¹å™¨æ‰“é€šï¼Œå³ è®¾ç½®SpringExtensionFactoryä¸­çš„ä¸Šä¸‹æ–‡ bean.setApplicationContext(applicationContext); // é…ç½®æœåŠ¡æ¥å£ configureInterface(annotation, bean); // å°è¯•ä»Springä¸­è·å–@Referenceæ³¨è§£ä¸­é…ç½®çš„consumerå±æ€§å€¼å¯¹åº”çš„ConsumerConfigå¯¹è±¡ï¼Œç„¶åè®¾ç½®åˆ°çš„ReferenceBeanå¯¹è±¡çš„consumerå±æ€§ä¸­ configureConsumerConfig(annotation, bean); // ä¸»åŠ¨è§¦å‘ ReferenceBean çš„ afterPropertiesSet æ–¹æ³• bean.afterPropertiesSet(); &#125; // $&#123;çœç•¥å…¶ä»–ä»£ç &#125;&#125; è‡³æ­¤ï¼Œåˆ›å»ºReferenceBeanå¯¹è±¡åˆ†æå®Œæ¯•ï¼Œæˆ‘ä»¬å†å›è¿‡å¤´åˆ†æ ReferenceAnnotationBeanPostProcessor#doGetInjectedBean æ–¹æ³•ä¸­çš„åˆ›å»º Proxy å¯¹è±¡çš„é€»è¾‘ã€‚ åˆ›å»ºProxyå¯¹è±¡ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public class ReferenceAnnotationBeanPostProcessor extends AnnotationInjectedBeanPostProcessor&lt;Reference&gt; implements ApplicationContextAware, ApplicationListener &#123; // $&#123;çœç•¥ä»£ç &#125; /** * åˆ›å»ºProxyä»£ç†å¯¹è±¡ * * @param referencedBeanName * @param referenceBean * @param injectedType * @return */ private Object buildProxy(String referencedBeanName, ReferenceBean referenceBean, Class&lt;?&gt; injectedType) &#123; // 1. åˆ›å»ºReferenceBeanInvocationHandlerå¯¹è±¡ InvocationHandler handler = buildInvocationHandler(referencedBeanName, referenceBean); // 2. ä½¿ç”¨JDKçš„åŠ¨æ€ä»£ç†åˆ›å»ºæœåŠ¡æ¥å£çš„ä»£ç†å¯¹è±¡ Object proxy = Proxy.newProxyInstance(getClassLoader(), new Class[]&#123;injectedType&#125;, handler); return proxy; &#125; /** * åˆ›å»ºReferenceBeanInvocationHandlerå¯¹è±¡ * * @param referencedBeanName æ³¨å…¥ä¾èµ–çš„åå­—ï¼Œå³æœåŠ¡çš„åç§° * @param referenceBean ReferenceBeanå¯¹è±¡ * @return */ private InvocationHandler buildInvocationHandler(String referencedBeanName, ReferenceBean referenceBean) &#123; // ä»ç¼“å­˜ä¸­è·å–å¯¹åº”çš„ handlerå¯¹è±¡ ReferenceBeanInvocationHandler handler = localReferenceBeanInvocationHandlerCache.get(referencedBeanName); // ä¸å­˜åœ¨åˆ™åˆ›å»ºReferenceBeançš„ InvocationHandler å¯¹è±¡ if (handler == null) &#123; handler = new ReferenceBeanInvocationHandler(referenceBean); &#125; // å¦‚æœåº”ç”¨ä¸Šä¸‹æ–‡ä¸­å·²ç»åˆå§‹åŒ–äº†ï¼Œè¯´æ˜å¼•å…¥çš„æœåŠ¡æ˜¯æœ¬åœ°çš„@Service Bean ï¼Œåˆ™å°†å¼•å…¥çš„DubboæœåŠ¡çš„InvocationHandleræ·»åŠ åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œä¸è¿›è¡Œåˆå§‹åŒ–ï¼ˆè¦æƒ³åˆå§‹åŒ–ï¼Œå¼•å…¥çš„æœåŠ¡å¿…é¡»æ˜¯å·²ç»æš´éœ²çš„çŠ¶æ€ï¼‰ if (applicationContext.containsBean(referencedBeanName)) &#123; // ReferenceBeanInvocationHandler's initialization has to wait for current local @Service Bean has been exported. localReferenceBeanInvocationHandlerCache.put(referencedBeanName, handler); &#125; else &#123; // å¦‚æœåº”ç”¨ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰ï¼Œåˆ™è¯´æ˜æ˜¯å¼•å…¥çš„æ˜¯è¿œç¨‹çš„æœåŠ¡å¯¹è±¡ï¼Œåˆ™ç«‹å³åˆå§‹åŒ– handler.init(); &#125; return handler; &#125;// $&#123;çœç•¥ä»£ç &#125;&#125; ä»¥ä¸Šä»£ç åªåšäº†ä¸€ä»¶äº‹æƒ…ï¼Œä¸ºæœåŠ¡æ¥å£åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œåˆ›å»ºä»£ç†å¯¹è±¡æ˜¯ä½¿ç”¨JDKçš„åŠ¨æ€ä»£ç†ã€‚å…¶ä¸­ä»£ç†å¯¹è±¡çš„æ‰§è¡Œé€»è¾‘å°è£…åœ¨ReferenceBeanInvocationHandlerå¯¹è±¡ä¸­ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥è¯¦ç»†åˆ†æè¯¥Handlerã€‚ ReferenceBeanInvocationHandler 1234567891011121314151617181920212223242526272829303132/** * å®ç°äº† Dubbo çš„ InvocationHandleræ¥å£ */ private static class ReferenceBeanInvocationHandler implements InvocationHandler &#123; /** * ReferenceBeanå¯¹è±¡ */ private final ReferenceBean referenceBean; /** * Bean å¯¹è±¡(å¼•ç”¨çš„æœåŠ¡) */ private Object bean; private ReferenceBeanInvocationHandler(ReferenceBean referenceBean) &#123; this.referenceBean = referenceBean; &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; // è°ƒç”¨ Bean çš„å¯¹åº”çš„æ–¹æ³• return method.invoke(bean, args); &#125; /** * 1 é€šè¿‡åˆå§‹åŒ–æ–¹æ³•ï¼Œè·å¾— ReferenceBean.ref (å¼•ç”¨çš„æœåŠ¡)ï¼Œå³ä»£ç†å¯¹è±¡ * 2 è°ƒç”¨ReferenceBean#get()æ–¹æ³•ï¼Œè¿›è¡Œå¼•ç”¨çš„Beançš„åˆå§‹åŒ–ï¼Œæœ€åè¿”å›æœåŠ¡æ¥å£ä»£ç†å¯¹è±¡ */ private void init() &#123; this.bean = referenceBean.get(); &#125; &#125; ReferenceBeanInvocationHandleræ˜¯ReferenceAnnotationBeanPostProcessorçš„é™æ€å†…éƒ¨ç±»ï¼Œå®ç°äº†InvocationHanderæ¥å£ã€‚å…¶ä¸­referenceBeanå±æ€§å€¼æ˜¯é€šè¿‡æ„é€ æ–¹æ³•è®¾ç½®çš„ï¼Œbeanå±æ€§çš„å€¼å°±æ˜¯å¼•ç”¨çš„æœåŠ¡ï¼Œå³æœåŠ¡æ¥å£ä»£ç†å¯¹è±¡ã€‚invokeæ–¹æ³•æ˜¯å›è°ƒæ–¹æ³•ï¼Œå½“æ¶ˆè´¹æ–¹é€šè¿‡åˆ›å»ºçš„proxyè°ƒç”¨æœåŠ¡æ–¹æ³•å°±ä¼šå›è°ƒã€‚è‡³æ­¤ï¼Œ@Reference æ‰€éœ€è¦çš„ä¾èµ–å·²ç»åˆ›å»ºå®Œæ¯•ï¼Œé€šè¿‡åå°„è®¾ç½®åˆ°æ‰€éœ€ç»„ä»¶ä¸­å³å¯ã€‚ Dubboæ³¨è§£é…ç½®æµç¨‹æ€»ç»“ å‰é¢å·²ç»è¯¦ç»†åˆ†æDubboæ³¨è§£é…ç½®çš„æµç¨‹ï¼Œè¿™é‡Œè¿›è¡Œå°ç»“ã€‚Dubboçš„æ³¨è§£è§£ææœºåˆ¶ä¸»è¦ä¾èµ–ä¸Šå›¾ä¸­çš„æ ¸å¿ƒç»„ä»¶ã€‚å¦‚æœç”¨æˆ·ä½¿ç”¨äº†é…ç½®æ–‡ä»¶ï¼Œåˆ™Dubboæ¡†æ¶æŒ‰éœ€ç”Ÿæˆå¯¹åº”çš„Beanã€‚Dubboæ¡†æ¶ä¼šå°†æ‰€æœ‰ä½¿ç”¨Dubboçš„æ³¨è§£@Serviceæ ‡æ³¨çš„ç±»æå‡ä¸ºBeanï¼Œä¸ºä½¿ç”¨@Referenceæ³¨è§£çš„å­—æ®µæˆ–æ–¹æ³•æ³¨å…¥ä»£ç†å¯¹è±¡ã€‚ æ€»ç»“ä»£ç é‡è¿œæ¯”é¢„è®¡å¾—å¤šï¼Œå†™çš„è¿˜æ˜¯æœ‰ç‚¹æ··ä¹±çš„ã€‚ä»ä»£ç æ•´ä¸ªæµç¨‹å¯ä»¥çœ‹å‡ºï¼Œè™½ç„¶æ³¨è§£ä½¿ç”¨æ›´åŠ ç®€æ´ã€æ–¹ä¾¿ï¼Œä½†æ˜¯èƒŒåçš„å·¥ä½œä¸€ç‚¹éƒ½æ²¡æœ‰å°‘ï¼Œç”šè‡³æ›´å¤šæ›´å¤æ‚ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"}]},{"title":"Dubboæºç åˆ†æ - XMLé…ç½®","slug":"rpc/xmlé…ç½®","date":"2020-03-28T16:00:00.000Z","updated":"2020-09-03T03:12:53.638Z","comments":false,"path":"posts/a8d76a91/","link":"","permalink":"https://gentryhuang.com/posts/a8d76a91/","excerpt":"","text":"å‰è¨€åœ¨ Dubboæºç åˆ†æ - APIå’Œå±æ€§é…ç½® ä¸­ä»‹ç»äº†Dubboçš„é…ç½®æ‰¿è½½å¯¹è±¡ï¼Œåˆ†æäº†æ ¸å¿ƒçš„é…ç½®ç±»åŠæ–¹æ³•ã€‚äº†è§£äº†APIé…ç½®åXMLé…ç½®å°±å®¹æ˜“å¤šäº†ï¼ŒXMLé…ç½®ç›¸æ¯”è¾ƒAPIé…ç½®çš„åŒºåˆ«åœ¨é…ç½®å¯¹è±¡åˆ›å»ºåŠå…¶å±æ€§çš„è®¾ç½®æ˜¯ç”±Springç®¡ç†çš„ï¼ŒDubboå’ŒSpring XMLèåˆæ˜¯å…³é”®ã€‚ Dubboå’ŒSpringèåˆDubboæ¡†æ¶ç›´æ¥é›†æˆäº†Springçš„èƒ½åŠ›ï¼Œåˆ©ç”¨Springé…ç½®æ–‡ä»¶æ‰©å±•å‡ºè‡ªå®šä¹‰çš„è§£ææ–¹å¼ï¼Œå³ä½¿ç”¨Springçš„è‡ªå®šæ ‡ç­¾ã€‚å…³äºSpringè‡ªå®šæ ‡ç­¾çš„ç¤ºä¾‹ï¼Œåœ¨Springè‡ªå®šä¹‰æ ‡ç­¾ ä¸­æœ‰è¯¦ç»†ä»‹ç»ï¼ŒDubboåŸºäºschemaçš„è®¾è®¡ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥åˆ†æä¸‹Dubboæ˜¯æ€ä¹ˆå’ŒSpringèåˆçš„ã€‚ Dubboçš„é…ç½®å¯¹è±¡æ¨¡å‹Dubboçš„é…ç½®å¯¹è±¡æ¨¡å‹å·²ç»åœ¨ [Dubboæºç åˆ†æ - APIå’Œå±æ€§é…ç½®] ä¸­è¯¦ç»†ä»‹ç»è¿‡äº†ï¼Œåœ¨Dubboçš„å‘½åç©ºé—´å¤„ç†å™¨ä¸­ä¹Ÿå¯ä»¥å…·ä½“çœ‹åˆ°å“ªäº›é…ç½®ç±»å’ŒSpringè¿›è¡Œäº¤äº’ï¼Œè¿™é‡Œå°±ä¸å†ä»‹ç»ã€‚ Dubboçš„xsdæ–‡ä»¶dubbo.xsdæ–‡ä»¶æ˜¯ç”¨æ¥çº¦æŸä½¿ç”¨XMLé…ç½®æ—¶çš„æ ‡ç­¾å’Œå¯¹åº”çš„å±æ€§ï¼Œå¦‚Dubboä¸­çš„&lt;dubbo:service&gt;æ ‡ç­¾ç­‰ã€‚ç”±äºå½“å‰åˆ†æçš„dubboç‰ˆæœ¬æ˜¯2.6.5ï¼ŒDubboå·²ç»æç»™äº†Apacheç»„ç»‡ï¼Œä¸ºäº†éµå¾ªApacheæ ‡å‡†å’Œå…¼å®¹DubboåŸæ¥çš„ç‰ˆæœ¬ï¼Œä¼šå‡ºç°ä¸¤ä¸ªxsdæ–‡ä»¶ï¼Œè¿™ç¯‡æ–‡ç« è¿˜æ˜¯æŒ‰ç…§DubboåŸæ¥çš„ç‰ˆæœ¬è¿›è¡Œç›¸å…³æè¿°ã€‚ dubbo.xsdæ€»è§ˆ Dubboè®¾è®¡çš„ç²’åº¦å¾ˆå¤šéƒ½æ˜¯é’ˆå¯¹æ–¹æ³•çº§åˆ«çš„ï¼Œå¦‚æ–¹æ³•çº§åˆ«çš„timeoutã€retriesç­‰ç‰¹æ€§ã€‚å…·ä½“çš„æ¯ä¸ªå¤æ‚ç±»å‹çš„è¯¦ç»†ä½¿ç”¨å¯ä»¥å‚è€ƒ:å®˜æ–¹æ–‡æ¡£ dubbo.xsdä¸­çš„ç±»å‹å…³ç³» ä¸Šå›¾çš„ç±»å‹ç»§æ‰¿å…³ç³»å’ŒDubboçš„é…ç½®ç±»ä¹‹é—´çš„å…³ç³»å‡ ä¹ä¿æŒä¸€è‡´ï¼Œå› ä¸ºè¿™é‡Œå®šä¹‰çš„å¤æ‚ç±»å‹å°±æ˜¯è¦æ˜ å°„åˆ°é…ç½®ç±»çš„å±æ€§ä¸Šï¼Œå³schemaä¸­çš„å­—æ®µå¯¹åº”Configç±»ä¸­çš„å±æ€§å’Œget/setæ–¹æ³•ã€‚ Dubboçš„spring.schemasæ–‡ä»¶12http\\:&#x2F;&#x2F;dubbo.apache.org&#x2F;schema&#x2F;dubbo&#x2F;dubbo.xsd&#x3D;META-INF&#x2F;dubbo.xsdhttp\\:&#x2F;&#x2F;code.alibabatech.com&#x2F;schema&#x2F;dubbo&#x2F;dubbo.xsd&#x3D;META-INF&#x2F;compat&#x2F;dubbo.xsd spring.schemasæ–‡ä»¶ç”¨æ¥æŒ‡æ˜çº¦æŸæ–‡ä»¶çš„å…·ä½“è·¯å¾„ã€‚ Dubboçš„spring.handlers12http\\:&#x2F;&#x2F;dubbo.apache.org&#x2F;schema&#x2F;dubbo&#x3D;com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandlerhttp\\:&#x2F;&#x2F;code.alibabatech.com&#x2F;schema&#x2F;dubbo&#x3D;com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler spring.handlersæ–‡ä»¶ç”¨æ¥æŒ‡æ˜Dubboçš„XMLå‘½åç©ºé—´å¤„ç†å™¨ï¼Œå³ä½¿ç”¨DubboNamespaceHandleræ¥è§£æDubboè‡ªå®šä¹‰çš„æ ‡ç­¾ã€‚ Dubboçš„DubboNamespaceHandler123456789101112131415161718192021222324public class DubboNamespaceHandler extends NamespaceHandlerSupport &#123; static &#123; Version.checkDuplicate(DubboNamespaceHandler.class); &#125; /** * æ–¹æ³•ä¸­å®šä¹‰äº†æ¯ä¸ª&lt;xsd:element/&gt;å¯¹åº”çš„BeanDefinitionParser ã€Dubbo Beanå®šä¹‰è§£æå™¨ã€‘ */ @Override public void init() &#123; registerBeanDefinitionParser(\"application\", new DubboBeanDefinitionParser(ApplicationConfig.class, true)); registerBeanDefinitionParser(\"module\", new DubboBeanDefinitionParser(ModuleConfig.class, true)); registerBeanDefinitionParser(\"registry\", new DubboBeanDefinitionParser(RegistryConfig.class, true)); registerBeanDefinitionParser(\"monitor\", new DubboBeanDefinitionParser(MonitorConfig.class, true)); registerBeanDefinitionParser(\"provider\", new DubboBeanDefinitionParser(ProviderConfig.class, true)); registerBeanDefinitionParser(\"consumer\", new DubboBeanDefinitionParser(ConsumerConfig.class, true)); registerBeanDefinitionParser(\"protocol\", new DubboBeanDefinitionParser(ProtocolConfig.class, true)); registerBeanDefinitionParser(\"service\", new DubboBeanDefinitionParser(ServiceBean.class, true)); registerBeanDefinitionParser(\"reference\", new DubboBeanDefinitionParser(ReferenceBean.class, false)); // æ³¨è§£å·²ç»é‡å†™ï¼ŒAnnotationBeanDefinitionParser å·²ç»åºŸå¼ƒï¼Œå³@DubboComponentScan ä½œä¸º Dubbo 2.5.7 æ–°å¢çš„ Annotationï¼Œæ˜¯XML å…ƒç´  &lt;dubbo:annotation&gt; çš„æ›¿ä»£æ–¹æ¡ˆã€‚ registerBeanDefinitionParser(\"annotation\", new AnnotationBeanDefinitionParser()); &#125;&#125; Dubboè§£æé…ç½®çš„å…¥å£æ˜¯åœ¨ DubboNamespaceHandlerç±»ä¸­å®Œæˆçš„ï¼Œè¯¥ç±»ä¸»è¦æŠŠä¸åŒçš„æ ‡ç­¾å…³è”åˆ°è§£æå®ç°ç±»ä¸­ï¼ŒregisterBeanDefinitionParseræ–¹æ³•çº¦å®šåœ¨é‡åˆ°Dubboè‡ªå®šçš„æ ‡ç­¾å¦‚applicationã€registryã€protocolç­‰éƒ½ä¼šå§”æ‰˜ç»™Dubboçš„å‘½åç©ºé—´å¤„ç†å™¨DubboNamespaceHandlerå¤„ç†ï¼Œè¯¥å¤„ç†å™¨åˆä¼šæŠŠè§£æä»»åŠ¡äº¤ç»™DubboBeanDefinitionParseræ¥å¤„ç†ã€‚ Dubboçš„DubboBeanDefinitionParserå®ç°äº†Springçš„BeanDefinitionParseræ¥å£ï¼Œæ˜¯çœŸæ­£ç”¨æ¥è§£æè‡ªå®šçš„Dubboæ ‡ç­¾ï¼Œå°†æ ‡ç­¾è§£ææˆå¯¹åº”çš„Beanå®šä¹‰å¹¶æ³¨å†Œåˆ°Springä¸Šä¸‹æ–‡ä¸­ã€‚ ä½¿ç”¨Dubboæ ‡ç­¾123456789101112131415161718192021222324&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:dubbo=\"http://dubbo.apache.org/schema/dubbo\" xmlns=\"http://www.springframework.org/schema/beans\" xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd\"&gt; &lt;!-- provider's application name, used for tracing dependency relationship --&gt; &lt;dubbo:application name=\"demo-provider\" owner=\"gentryhuang\"/&gt; &lt;!-- use multicast registry center to export service --&gt; &lt;!--&lt;dubbo:registry address=\"multicast://224.5.6.7:1234\" protocol=\"test\"/&gt; --&gt; &lt;dubbo:registry address=\"zookeeper://127.0.0.1:2181\"/&gt; &lt;!-- use dubbo protocol to export service on port 20880 --&gt; &lt;dubbo:protocol name=\"dubbo\" port=\"20880\"/&gt; &lt;!-- service implementation, as same as regular local bean --&gt; &lt;bean id=\"demoService\" class=\"com.alibaba.dubbo.demo.provider.DemoServiceImpl\"/&gt; &lt;!-- declare the service interface to be exported --&gt; &lt;dubbo:service interface=\"com.alibaba.dubbo.demo.DemoService\" ref=\"demoService\"/&gt;&lt;/beans&gt; å°ç»“ä»¥ä¸Šå°±æ˜¯Dubboå’ŒSpringçš„XMLé…ç½®è¿›è¡Œèåˆçš„è¿‡ç¨‹ï¼Œä¸ Springè‡ªå®šä¹‰æ ‡ç­¾ æ–‡ç« ä¸­çš„æµç¨‹æ˜¯ä¸€æ ·çš„ã€‚æ€»çš„æ¥è¯´ï¼ŒDubboæ¡†æ¶å…ˆä»¥æµçš„å½¢å¼è£…è½½Springçš„XMLé…ç½®æ–‡ä»¶ï¼Œåœ¨å°†æµè§£ææˆDOMçš„è¿‡ç¨‹ä¸­ä¼šåŠ è½½spring.schemasæ–‡ä»¶ï¼Œç„¶åè¯»å–è¯¥æ–‡ä»¶ä¸­æŒ‡å®šçš„çš„xsdçº¦æŸæ–‡ä»¶ï¼Œæ¥ç€ä½¿ç”¨xsdä¸­çš„çº¦æŸè§„åˆ™å¯¹æ¯ä¸ªæ ‡ç­¾åŠå…¶å±æ€§è¿›è¡Œæ ¡éªŒï¼Œä¸åˆæ³•åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œæ•´ä¸ªé…ç½®æ–‡ä»¶ç¬¦åˆçº¦æŸè§„åˆ™åˆ™ç”ŸæˆDOMå¯¹è±¡ã€‚å’Œspring.handlersæ–‡ä»¶ã€‚spring.schemaæ–‡ä»¶æŒ‡å®šäº†é…ç½®çº¦æŸæ–‡ä»¶çš„ä½ç½®ï¼ŒåŠ è½½spring.schemasæ–‡ä»¶çš„ç›®çš„å°±æ˜¯ç”¨æ¥æ ¡éªŒSpringçš„XMLé…ç½®æ–‡ä»¶å†…å®¹æ˜¯å¦åˆæ³•ã€‚åŠ è½½spring.handlersæ–‡ä»¶çš„ç›®çš„æ˜¯ï¼Œå½“è§£æSpringçš„XMLé…ç½®æ–‡ä»¶ä¸­çš„æ ‡ç­¾æ—¶,ä¼šæŸ¥æ‰¾è¯¥æ–‡ä»¶ä¸­æŒ‡å®šçš„DubboNamespaceHandlerç±»æ¥è¿›è¡Œè‡ªå®šä¹‰æ ‡ç­¾çš„åˆå§‹åŒ–å’Œè§£æã€‚ è§£æå‡†å¤‡åŠ è½½ spring.schemas æ–‡ä»¶12345678910111213141516AbstractXmlApplicationContext#loadBeanDefinitions(org.springframework.beans.factory.support.DefaultListableBeanFactory)&#123; // Create a new XmlBeanDefinitionReader for the given BeanFactory. XmlBeanDefinitionReader beanDefinitionReader = new XmlBeanDefinitionReader(beanFactory); // Configure the bean definition reader with this context's // resource loading environment. beanDefinitionReader.setEnvironment(this.getEnvironment()); beanDefinitionReader.setResourceLoader(this); // è®¾ç½® 'META-INF/spring.schemas' åˆ° ResourceEntityResolver beanDefinitionReader.setEntityResolver(new ResourceEntityResolver(this)); // Allow a subclass to provide custom initialization of the reader, // then proceed with actually loading the bean definitions. initBeanDefinitionReader(beanDefinitionReader); loadBeanDefinitions(beanDefinitionReader);&#125; ä¸Šé¢ä»£ç å°±è®¾ç½® spring.schemas æ–‡ä»¶è·¯å¾„ï¼Œä¸ºæ¥ä¸‹æ¥åŠ è½½ spring.schemas æ–‡ä»¶åšå‡†å¤‡ã€‚ 123456789XmlBeanDefinitionReader#doLoadBeanDefinitions(InputSource inputSource, Resource resource)&#123; try &#123; // åŠ è½½ META-INF/spring.schemas ä¸­xsdæ–‡ä»¶ï¼Œåœ¨æ„å»ºDomæ—¶è¿›è¡Œæ ¡éªŒXMLé…ç½®å†…å®¹æ˜¯å¦æ­£ç¡® Document doc = doLoadDocument(inputSource, resource); // åŠ è½½ META-INF/spring.handlers ä¸­çš„å‘½åç©ºé—´å¤„ç†å™¨ï¼Œåˆå§‹åŒ–å¹¶æ”¾å…¥ç¼“å­˜ return registerBeanDefinitions(doc, resource); &#125; // çœç•¥æ— å…³ä»£ç &#125; ä¸Šé¢çš„ä»£ç æ˜¯æ³¨å†ŒXMLä¸­çš„Beançš„å¤§æµç¨‹å…¥å£ï¼Œåˆ†åˆ«æ˜¯åŠ è½½ META-INF/spring.schemas ä¸­xsdæ–‡ä»¶ï¼Œç”¨äºæ„å»ºDOMæ—¶æ ¡éªŒXMLé…ç½®å†…å®¹æ˜¯å¦æ­£ç¡®ï¼ŒåŠ è½½ META-INF/spring.handlers ä¸­çš„å‘½åç©ºé—´å¤„ç†å™¨ï¼Œç”¨äºå¤„ç†æ ‡ç­¾å’ŒBeanDefinitionParserçš„æ˜ å°„å…³ç³»ä»¥åŠè§£ææ ‡ç­¾ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹Springæ˜¯å¦‚ä½•åŠ è½½spring.schemasæ–‡ä»¶å†…å®¹çš„ã€‚ 12345678910111213141516171819202122232425PluggableSchemaResolver#getSchemaMappings()&#123; if (this.schemaMappings == null) &#123; synchronized (this) &#123; if (this.schemaMappings == null) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Loading schema mappings from [\" + this.schemaMappingsLocation + \"]\"); &#125; try &#123; // ä» META-INF/spring.schemas ä¸­è¯»å–xsdæ–‡ä»¶è·¯å¾„ Properties mappings = PropertiesLoaderUtils.loadAllProperties(this.schemaMappingsLocation, this.classLoader); if (logger.isDebugEnabled()) &#123; logger.debug(\"Loaded schema mappings: \" + mappings); &#125; Map&lt;String, String&gt; schemaMappings = new ConcurrentHashMap&lt;String, String&gt;(mappings.size()); // æ”¾å…¥ç¼“å­˜ä¸­ CollectionUtils.mergePropertiesIntoMap(mappings, schemaMappings); this.schemaMappings = schemaMappings; &#125;catch (IOException ex) &#123; throw new IllegalStateException(\"Unable to load schema mappings from location [\" + this.schemaMappingsLocation + \"]\", ex); &#125; &#125; &#125; &#125; return this.schemaMappings;&#125; 12345678910111213141516171819202122232425262728/** * @param publicId * @param systemId */PluggableSchemaResolver#resolveEntity(String publicId, String systemId)&#123; if (systemId != null) &#123; // æ ¹æ® spring.schemasä¸­é…ç½®çš„xxx.xsdæ‰¾åˆ°å¯¹åº”çš„xsdæ–‡ä»¶ String resourceLocation = getSchemaMappings().get(systemId); if (resourceLocation != null) &#123; // åŠ è½½xsdæ–‡ä»¶ Resource resource = new ClassPathResource(resourceLocation, this.classLoader); try &#123; InputSource source = new InputSource(resource.getInputStream()); source.setPublicId(publicId); source.setSystemId(systemId); if (logger.isDebugEnabled()) &#123; logger.debug(\"Found XML schema [\" + systemId + \"] in classpath: \" + resourceLocation); &#125; return source; &#125;catch (FileNotFoundException ex) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Couldn't find XML schema [\" + systemId + \"]: \" + resource, ex); &#125; &#125; &#125; &#125; return null;&#125; ä»¥ä¸Šå°±æ˜¯Springåœ¨å¯åŠ¨æ—¶åŠ è½½spring.schemasä¸­é…ç½®çš„xsdæ–‡ä»¶çš„å‡ ä¸ªä»£ç ç‰‡æ®µï¼Œå°†XMLé…ç½®æ–‡ä»¶è§£ææˆDOMçš„è¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸ªæ ‡ç­¾åŠå…¶å±æ€§è¿›è¡Œæ ¡éªŒï¼Œä¾æ®å°±æ˜¯xsdä¸­çš„çº¦æŸæ¡ä»¶ã€‚ç”±äºæ˜¯Springçš„æºç éƒ¨åˆ†ï¼Œè¿™é‡Œä¸è¿›è¡Œæ·±å…¥åˆ†æï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥è‡ªè¡Œè°ƒè¯•ã€‚ åŠ è½½ spring.handlers æ–‡ä»¶123456789101112/** * @param doc é…ç½®æ–‡ä»¶å¯¹åº”çš„DOMå¯¹è±¡ * @param resource é…ç½®æ–‡ä»¶èµ„æºå¯¹è±¡ */XmlBeanDefinitionReader#registerBeanDefinitions(Document doc, Resource resource)&#123; // åˆ›å»ºBeanå®šä¹‰çš„DOMReaderï¼Œç”¨æ¥è¯»å–ã€è§£æDOMï¼Œæ¥ç€åˆ›å»ºå¯¹åº”çš„Bean BeanDefinitionDocumentReader documentReader = createBeanDefinitionDocumentReader(); int countBefore = getRegistry().getBeanDefinitionCount(); // è¯»å–ã€è§£æDOMã€åˆ›å»ºå¯¹åº”çš„Bean documentReader.registerBeanDefinitions(doc, createReaderContext(resource)); return getRegistry().getBeanDefinitionCount() - countBefore;&#125; registerBeanDefinitionsæ–¹æ³•æ˜¯å°†Springçš„XMLé…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„æœ‰å…³æ ‡ç­¾è¿›è¡Œåˆ›å»ºå¹¶æ³¨å†Œåˆ°Springçš„æ³¨å†Œè¡¨ä¸­ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ‰€è¯´çš„èƒ½å¤Ÿåˆ›å»ºBeançš„æœ‰å…³æ ‡ç­¾å¿…é¡»æœ‰å¯¹åº”çš„BeanDefinitionParserï¼Œå¦åˆ™ä¸ä¼šå¯¹è¯¥æ ‡ç­¾è¿›è¡Œå¤„ç†ã€‚ 1234567891011121314/** * @param resource é…ç½®æ–‡ä»¶èµ„æºå¯¹è±¡ */XmlBeanDefinitionReader#createReaderContext(Resource resource)&#123; return new XmlReaderContext( resource, this.problemReporter, this.eventListener, this.sourceExtractor, this, // è¯»å– META-INF/spring.handlers æ–‡ä»¶ getNamespaceHandlerResolver() );&#125; createReaderContext æ–¹æ³•ç”¨æ¥åˆ›å»º XmlReaderContextï¼Œè¯¥å¯¹è±¡ä¸­åŒ…å«çš„æ ¸å¿ƒå±æ€§å¦‚ä¸‹ï¼š ç”±XmlReaderContextå¯¹è±¡ä¸­çš„å±æ€§å¯çŸ¥ï¼Œåœ¨åˆ›å»ºè¯¥å¯¹è±¡çš„è¿‡ç¨‹ä¸­å¯¹ META-INF/spring.handlers æ–‡ä»¶è¿›è¡Œäº†è¯»å–ã€‚ç°åœ¨æœ‰äº†é…ç½®æ–‡ä»¶çš„DOMå¯¹è±¡ã€Beanå®šä¹‰å·¥å‚ä»¥åŠspring.handlersæ–‡ä»¶ä¸­å„ç§NamespaceHandlerï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥è§£æDOMæ ‘ï¼Œåˆ›å»ºå¹¶æ³¨å†Œç›¸åº”çš„Beanã€‚ 12345678DefaultBeanDefinitionDocumentReader#registerBeanDefinitions(Document doc, XmlReaderContext readerContext)&#123; this.readerContext = readerContext; logger.debug(\"Loading bean definitions\"); // è·å–DOMçš„æ ¹å…ƒç´ ï¼Œä¸€èˆ¬æ˜¯ beans Element root = doc.getDocumentElement(); // è§£æå…¥å£ doRegisterBeanDefinitions(root);&#125; ä¸Šé¢çš„ä»£ç ä¸»è¦æ˜¯è·å–DOMå¯¹è±¡çš„æ ¹å…ƒç´ ï¼Œç„¶åä»¥è¿™ä¸ªæ ¹å…ƒç´ ä½œä¸ºèµ·ç‚¹è¿›è¡Œè§£æï¼Œä¸‹é¢æˆ‘ä»¬æ¥ç€è§£æä»£ç ã€‚ 123456789101112131415161718192021222324252627282930/*** Parse the elements at the root level in the document:* \"import\", \"alias\", \"bean\".* @param root DOMçš„æ ¹å…ƒç´ * @param delegate Beanå®šä¹‰è§£æå™¨ä»£ç†*/DefaultBeanDefinitionDocumentReader#parseBeanDefinitions(Element root, BeanDefinitionParserDelegate delegate) &#123; // åˆ¤è¯»æ ¹å…ƒç´ æ˜¯ä¸æ˜¯é»˜è®¤çš„å‘½åç©ºé—´ 'http://www.springframework.org/schema/beans' if (delegate.isDefaultNamespace(root)) &#123; // è·å–æ ¹å…ƒç´ ä¸‹çš„å­å…ƒç´ åˆ—è¡¨ NodeList nl = root.getChildNodes(); for (int i = 0; i &lt; nl.getLength(); i++) &#123; Node node = nl.item(i); // åˆ¤æ–­æ˜¯å¦æ˜¯å…ƒç´  if (node instanceof Element) &#123; Element ele = (Element) node; // å½“å‰å…ƒç´ çš„å‘½åç©ºé—´å¦‚æœæ˜¯é»˜è®¤çš„å‘½åç©ºé—´å³Springè‡ªèº«çš„å‘½åç©ºé—´ï¼Œåˆ™é€šè¿‡Springè‡ªèº«é€»è¾‘è¿›è¡Œè§£æ if (delegate.isDefaultNamespace(ele)) &#123; parseDefaultElement(ele, delegate); &#125; // å½“å‰å…ƒç´ çš„å‘½åç©ºé—´éé»˜è®¤çš„å‘½åç©ºé—´å³è‡ªå®šä¹‰çš„æ ‡ç­¾ï¼Œåˆ™é€šè¿‡è‡ªå®šä¹‰é€»è¾‘è¿›è¡Œè§£æ else &#123; delegate.parseCustomElement(ele); &#125; &#125; &#125; &#125;else &#123; delegate.parseCustomElement(root); &#125;&#125; ä¸Šé¢ä»£ç çš„ä¸»è¦é€»è¾‘æ˜¯åˆ¤æ–­è¦è§£æçš„DOMå…ƒç´ å³æ ‡ç­¾ï¼Œæ˜¯å¦æ˜¯Springå†…ç½®çš„ï¼Œå¦‚æœæ˜¯Springå†…ç½®åˆ™æ•´ä¸ªè§£æé€»è¾‘ä½¿ç”¨Springè‡ªèº«çš„é‚£ä¸€å¥—ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰çš„ï¼Œåˆ™è§£æé€»è¾‘äº¤ç»™å¼€å‘è€…ã€‚Springè‡ªèº«çš„è§£æé€»è¾‘å¿½ç•¥ï¼Œä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸‹è‡ªå®šä¹‰çš„æ ‡ç­¾çš„å¤„ç†æµç¨‹ã€‚ 1234567891011121314151617181920BeanDefinitionParserDelegate#parseCustomElement(org.w3c.dom.Element ele)&#123; return parseCustomElement(ele, null);&#125;/** * @param ele DOMçš„æ ¹å…ƒç´  * @param containingBd */BeanDefinitionParserDelegate#parseCustomElement(org.w3c.dom.Element ele, org.springframework.beans.factory.config.BeanDefinition containingBd)&#123; // è·å–å…ƒç´ å³æ ‡ç­¾çš„å‘½åç©ºé—´ String namespaceUri = getNamespaceURI(ele); // ä½¿ç”¨ XmlReaderContextä¸­çš„ DefaultNamespaceHandlerResolverè·å–å‘½åç©ºé—´å¯¹åº”çš„ NamespaceHandlerå¯¹è±¡ NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler == null) &#123; error(\"Unable to locate Spring NamespaceHandler for XML schema namespace [\" + namespaceUri + \"]\", ele); return null; &#125; // ä½¿ç”¨ NamespaceHandler å¯¹è±¡è§£ææ ‡ç­¾ return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));&#125; ä¸Šé¢ä»£ç å…ˆæ˜¯è·å–å½“å‰å…ƒç´ çš„å‘½åç©ºé—´ï¼Œç„¶åé€šè¿‡è¯¥å‘½åç©ºé—´è·å–å¯¹åº” NamespaceHandlerå¯¹è±¡ï¼Œæœ€åé€šè¿‡è¯¥å¯¹è±¡è§£æå½“å‰å…ƒç´ ã€‚ä¸‹é¢æˆ‘ä»¬ä¾æ¬¡åˆ†æè¿™ä¸¤ä¸ªæ­¥éª¤çš„ä»£ç ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738DefaultNamespaceHandlerResolver#resolve(String namespaceUri)&#123;// è·å– DefaultNamespaceHandlerResolver#handlerMappingså±æ€§ï¼Œå³å‘½åç©ºé—´åˆ°NamespaceHandlerçš„æ˜ å°„ï¼Œæ³¨æ„è¿™é‡Œçš„NamespaceHandlerå¯èƒ½æ˜¯è¿˜æ²¡æœ‰è¿›è¡Œå®ä¾‹åŒ–çš„å­—ç¬¦ä¸² Map&lt;String, Object&gt; handlerMappings = getHandlerMappings();// ä»ç¼“å­˜ä¸­è·å– NamespaceHandler Object handlerOrClassName = handlerMappings.get(namespaceUri); if (handlerOrClassName == null) &#123; return null; &#125;// å¦‚æœå½“å‰å‘½åç©ºé—´å¯¹åº”çš„ NamespaceHandler å°±æ˜¯ NamespaceHandlerå¯¹è±¡ï¼Œåˆ™éœ€è¦è¿›è¡Œå®ä¾‹åŒ–ï¼Œç›´æ¥è¿”å›å³å¯ else if (handlerOrClassName instanceof NamespaceHandler) &#123; return (NamespaceHandler) handlerOrClassName; &#125; // å½“å‰å‘½åç©ºé—´å¯¹åº”çš„ NamespaceHandler è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦åå°„åˆ›å»ºå¯¹è±¡ else &#123; String className = (String) handlerOrClassName; try &#123; // è·å–å½“å‰ å½“å‰å‘½åç©ºé—´å¯¹åº”çš„ NamespaceHandler ä¸² çš„ Class Class&lt;?&gt; handlerClass = ClassUtils.forName(className, this.classLoader); if (!NamespaceHandler.class.isAssignableFrom(handlerClass)) &#123; throw new FatalBeanException(\"Class [\" + className + \"] for namespace [\" + namespaceUri + \"] does not implement the [\" + NamespaceHandler.class.getName() + \"] interface\"); &#125; // åˆ›å»ºå¯¹è±¡ NamespaceHandler namespaceHandler = (NamespaceHandler) BeanUtils.instantiateClass(handlerClass); // æ‰§è¡Œ init æ–¹æ³•ï¼Œè¿›è¡Œæ ‡ç­¾å’ŒBeanDefinitionParser çš„å…³è” namespaceHandler.init(); // åŠ å…¥ç¼“å­˜ handlerMappings.put(namespaceUri, namespaceHandler); return namespaceHandler; &#125;catch (ClassNotFoundException ex) &#123; throw new FatalBeanException(\"NamespaceHandler class [\" + className + \"] for namespace [\" + namespaceUri + \"] not found\", ex); &#125;catch (LinkageError err) &#123; throw new FatalBeanException(\"Invalid NamespaceHandler class [\" + className + \"] for namespace [\" + namespaceUri + \"]: problem with handler class file or dependent class\", err); &#125; &#125;&#125; ä¸Šé¢ä»£ç æ ¸å¿ƒæ˜¯è·å–å½“å‰å‘½åç©ºé—´å¯¹åº”çš„ NamespaceHandler ï¼Œå¦‚æœ NamespaceHandler è¿˜æ˜¯ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆå°±é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡ï¼Œæ¥ç€è°ƒç”¨è¯¥å¯¹è±¡çš„ init(),è¿›è¡Œæ ‡ç­¾å’Œ BeanDefinitionParser çš„å…³è” ï¼Œæ–¹æ³•å¦‚æœå·²ç»åˆ›å»ºè¿‡äº†å¯¹è±¡åˆ™ç›´æ¥è¿”å›è¯¥ NamespaceHandler å¯¹è±¡ã€‚ç”±äºDubboè‡ªå®šä¹‰æ ‡ç­¾çš„å‘½åç©ºé—´å¯¹åº”çš„NamespaceHandleræ˜¯ DubboNamespaceHandlerï¼Œæˆ‘ä»¬åœ¨å‰é¢å·²ç»åˆ†æè¿‡äº†å®ƒçš„æºç ï¼Œè¿™é‡Œå†è¯¦ç»†è¯´æ˜ä¸‹ã€‚ 1234567891011121314151617181920212223public class DubboNamespaceHandler extends NamespaceHandlerSupport &#123; static &#123; Version.checkDuplicate(DubboNamespaceHandler.class); &#125; /** * æ–¹æ³•ä¸­å®šä¹‰äº†æ¯ä¸ª&lt;xsd:element/&gt;å¯¹åº”çš„BeanDefinitionParser ã€Dubbo Beanå®šä¹‰è§£æå™¨ã€‘ */ @Override public void init() &#123; registerBeanDefinitionParser(\"application\", new DubboBeanDefinitionParser(ApplicationConfig.class, true)); registerBeanDefinitionParser(\"module\", new DubboBeanDefinitionParser(ModuleConfig.class, true)); registerBeanDefinitionParser(\"registry\", new DubboBeanDefinitionParser(RegistryConfig.class, true)); registerBeanDefinitionParser(\"monitor\", new DubboBeanDefinitionParser(MonitorConfig.class, true)); registerBeanDefinitionParser(\"provider\", new DubboBeanDefinitionParser(ProviderConfig.class, true)); registerBeanDefinitionParser(\"consumer\", new DubboBeanDefinitionParser(ConsumerConfig.class, true)); registerBeanDefinitionParser(\"protocol\", new DubboBeanDefinitionParser(ProtocolConfig.class, true)); registerBeanDefinitionParser(\"service\", new DubboBeanDefinitionParser(ServiceBean.class, true)); registerBeanDefinitionParser(\"reference\", new DubboBeanDefinitionParser(ReferenceBean.class, false)); registerBeanDefinitionParser(\"annotation\", new AnnotationBeanDefinitionParser()); &#125;&#125; ä¸Šé¢çš„ä»£ç æ¯”è¾ƒç›´è§‚ï¼Œä¸€ä¸ªæ ‡ç­¾å¯¹åº”ä¸€ä¸ª DubboBeanDefinitionParser å¯¹è±¡ï¼ŒåŒæ—¶ä¹Ÿå¯¹åº”è¿™ä¸€ä¸ªDubboçš„é…ç½®æ‰¿è½½ç±»ã€‚æˆ‘ä»¬æ¥ä¸‹ä¸»è¦çœ‹registerBeanDefinitionParseræ–¹æ³•æ˜¯æ€ä¹ˆæŠŠæ ‡ç­¾å’ŒDubboBeanDefinitionParserå…³è”åˆ°ä¸€èµ·çš„ã€‚ 1234567891011121314public abstract class NamespaceHandlerSupport implements NamespaceHandler &#123; /** * æ ‡ç­¾å åˆ° BeanDefinitionParser æ˜ å°„é›†åˆ */ private final Map&lt;String, BeanDefinitionParser&gt; parsers = new HashMap&lt;String, BeanDefinitionParser&gt;(); /** * å…³è” æ ‡ç­¾å åˆ° BeanDefinitionParser */ protected final void registerBeanDefinitionParser(String elementName, BeanDefinitionParser parser) &#123; this.parsers.put(elementName, parser); &#125;&#125; åŸæ¥å¦‚æ­¤ç®€å•ï¼Œå°±æ˜¯è°ƒç”¨çˆ¶ç±» NamespaceHandlerSupport çš„registerBeanDefinitionParseræ–¹æ³•ï¼Œå°†æ ‡ç­¾ååˆ°BeanDefinitionParserçš„æ˜ å°„ä¿å­˜åˆ°ç¼“å­˜ä¸­ã€‚åˆ°äº†è¿™é‡Œæ‰€æœ‰è§£æå‰çš„å·¥ä½œå·²ç»å‡†å¤‡å°±ç»ªï¼Œç»ˆäºå¯ä»¥è¿›å…¥åˆ°è¿™ç¯‡æ–‡ç« çš„æ ¸å¿ƒéƒ¨åˆ†äº†ã€‚ä¹‹æ‰€ä»¥ç”¨äº†é‚£ä¹ˆå¤šçš„é“ºå«ï¼Œå°±æ˜¯æƒ³æŠŠæ•´ä¸ªè¿‡ç¨‹ä¸²èµ·æ¥ï¼Œå¦‚æœä¸€ä¸‹å­è¿›å…¥åˆ°Dubboè‡ªå®šä¹‰æ ‡ç­¾çš„è§£ææ„Ÿè§‰è¿˜æ˜¯æŒºå¥‡æ€ªçš„ï¼Œæ¯•ç«Ÿç¬”è€…å¯¹Springçš„æºç ä¹Ÿä¸ç†Ÿæ‚‰ï¼Œå°±æŒ‰éƒ¨å°±ç­å§ã€‚ è§£ææ ‡ç­¾è§£æå‡†å¤‡æ˜¯ç‰¹æ„ä¸ºè§£ææ ‡ç­¾åšçš„é“ºå«ï¼Œæœ‰äº†è¿™ä¸ªé“ºå«ä¸‹é¢çš„è§£æé€»è¾‘å°±å®¹æ˜“å¾ˆå¤šäº†ã€‚æˆ‘ä»¬æ¥ç€è§£æå‡†å¤‡ä¸­çš„ parseCustomElement æ–¹æ³•ç»§ç»­åˆ†æã€‚ 123456789101112public BeanDefinition parseCustomElement(Element ele, BeanDefinition containingBd) &#123; // 1. è·å–DOMå…ƒç´ å³æ ‡ç­¾å¯¹åº”çš„å‘½åç©ºé—´ String namespaceUri = getNamespaceURI(ele); // 2. è·å–å‘½åç©ºé—´æ˜ å°„çš„ NamespaceHandlerå¯¹è±¡ NamespaceHandler handler = this.readerContext.getNamespaceHandlerResolver().resolve(namespaceUri); if (handler == null) &#123; error(\"Unable to locate Spring NamespaceHandler for XML schema namespace [\" + namespaceUri + \"]\", ele); return null; &#125; // 3. è°ƒç”¨ NamespaceHandlerå¯¹è±¡ çš„parseæ–¹æ³•è¿›è¡Œè§£æ return handler.parse(ele, new ParserContext(this.readerContext, this, containingBd));&#125; ä¸Šé¢ä»£ç ä¸­çš„ç¬¬3æ­¥æ‰æ­£å¼è¿›å…¥åˆ°æ ‡ç­¾çš„è§£æï¼Œè¿™é‡Œçš„ NamespaceHandler å°± DubboNamespaceHandlerå¯¹è±¡ï¼Œparse æ–¹æ³•æ˜¯å…¶çˆ¶ç±» NamespaceHandlerSupport ä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹é€»è¾‘ã€‚ 123456789101112131415161718192021 @Overridepublic BeanDefinition parse(Element element, ParserContext parserContext) &#123; /* * 1. è·å–æ ‡ç­¾çš„åç§°å…³è”çš„ BeanDefinitionParser * 2. ä½¿ç”¨ BeanDefinitionParserè§£ææ ‡ç­¾ */ return findParserForElement(element, parserContext).parse(element, parserContext);&#125;private BeanDefinitionParser findParserForElement(Element element, ParserContext parserContext) &#123; // è·å–æ ‡ç­¾å String localName = parserContext.getDelegate().getLocalName(element); // ä»ç¼“å­˜ä¸­è·å–æ ‡ç­¾åå¯¹åº”çš„ BeanDefinitionParserå¯¹è±¡ï¼Œå³ DubboBeanDefinitionParserå¯¹è±¡ BeanDefinitionParser parser = this.parsers.get(localName); if (parser == null) &#123; parserContext.getReaderContext().fatal( \"Cannot locate BeanDefinitionParser for element [\" + localName + \"]\", element); &#125; return parser;&#125; ä¸Šé¢ä»£ç å°±æ˜¯ä» æ ‡ç­¾å åˆ° BeanDefinitionParser æ˜ å°„é›†åˆparsersä¸­è·å–æ ‡ç­¾åå¯¹åº”çš„BeanDefinitionParserå¯¹è±¡ï¼Œè¯¥æ˜ å°„é›†åˆæ˜¯åœ¨ DubboNamespaceHandler#init æ–¹æ³•æ‰§è¡Œæ—¶ç»´æŠ¤çš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€åˆ†æDubboBeanDefinitionParserç±»ã€‚ Dubbo Beanå®šä¹‰è§£æå™¨1234567891011121314151617181920212223242526272829303132333435public class DubboBeanDefinitionParser implements BeanDefinitionParser &#123; /** * æ ‡ç­¾å…ƒç´ å¯¹åº”çš„å¯¹è±¡ç±» */ private final Class&lt;?&gt; beanClass; /** * æ˜¯å¦éœ€è¦Beançš„ id å±æ€§ */ private final boolean required; /** * @param beanClass Bean å¯¹è±¡çš„ç±» * @param required æ˜¯å¦éœ€è¦åœ¨Beanå¯¹è±¡çš„ç¼–å·ï¼ˆidï¼‰ä¸å­˜åœ¨æ—¶è‡ªåŠ¨ç”Ÿæˆç¼–å·ã€‚æ— éœ€è¢«å…¶ä»–åº”ç”¨å¼•ç”¨çš„é…ç½®å¯¹è±¡ï¼Œæ— éœ€è‡ªåŠ¨ç”Ÿæˆç¼–å·ã€‚ egï¼š&lt;dubbo:reference/&gt; */ public DubboBeanDefinitionParser(Class&lt;?&gt; beanClass, boolean required) &#123; this.beanClass = beanClass; this.required = required; &#125; /** * Springè§£ææ ‡ç­¾çš„å…¥å£æ–¹æ³• * * @param element æ ‡ç­¾å…ƒç´ å¯¹è±¡ * @param parserContext è§£æä¸Šä¸‹æ–‡ * @return */ @Override public BeanDefinition parse(Element element, ParserContext parserContext) &#123; return parse(element, parserContext, beanClass, required); &#125; // $&#123;çœç•¥çš„ä»£ç &#125; &#125; DubboBeanDefinitionParserå®ç°äº†Springçš„BeanDefinitionParseræ¥å£ï¼Œå³Springçš„Beanå®šä¹‰è§£æå™¨ã€‚è¯¥ç±»ä¸­æœ‰ä¸¤ä¸ªé‡è¦å±æ€§ï¼ŒbeanClass å’Œ requiredï¼Œè¿™ä¸¤ä¸ªå±æ€§çš„å€¼æ˜¯åœ¨åˆ›å»ºDubboçš„Beanå®šä¹‰è§£æå™¨æ—¶é€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥çš„ï¼Œåˆ†åˆ«æ˜¯æ ‡ç­¾å…ƒç´ å¯¹åº”çš„é…ç½®ç±»å’Œåœ¨åˆ›å»ºé…ç½®Beançš„æ—¶å€™å¯èƒ½éœ€è¦içš„då±æ€§ã€‚parseæ–¹æ³•æ˜¯è§£æXMLå…ƒç´ çš„ä¸»æµç¨‹çš„å…¥å£ï¼Œå…¶ä¸­ parserContext å‚æ•°æ˜¯XMLè§£æçš„ä¸Šä¸‹æ–‡ï¼Œå®ƒåŒ…å«äº† XmlReaderContext è¿™ä¸ªé‡è¦å¯¹è±¡ï¼Œè€Œè¯¥å¯¹è±¡ä¸­åˆåŒ…å«äº†BeanFactoryç­‰ä¿¡æ¯ï¼Œå…·ä½“å¦‚ä¸‹å›¾: æœ‰äº†BeanFactoryå°±å¯ä»¥å®ç°Beançš„å®šä¹‰äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»§ç»­åˆ†æDubboæ˜¯å¦‚ä½•å¤„ç†è‡ªå®šä¹‰æ ‡ç­¾ä¸å¯¹åº”çš„é…ç½®ç±»ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠæ€æ ·åˆ›å»ºæ ‡ç­¾å¯¹åº”çš„Beanå®šä¹‰çš„ã€‚ åˆ›å»ºBeanå®šä¹‰å¹¶æ³¨å†Œåˆ°Springä¸Šä¸‹æ–‡1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859/** * @param element æ ‡ç­¾å¯¹åº”çš„DOM * @param parserContext spring è§£æä¸Šä¸‹æ–‡ * @param beanClass æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±» * @param required åœ¨åˆ›å»ºBeanå®šä¹‰çš„æ—¶å€™æ˜¯å¦éœ€è¦id * @return æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰ */ @SuppressWarnings(\"unchecked\") private static BeanDefinition parse(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, boolean required) &#123; // ç”ŸæˆSpringçš„Beanå®šä¹‰ï¼ŒæŒ‡å®šbeanClassäº¤ç»™Springåå°„åˆ›å»ºå®ä¾‹ RootBeanDefinition beanDefinition = new RootBeanDefinition(); beanDefinition.setBeanClass(beanClass); /** * è®¾ç½®Beanåˆå§‹åŒ–æ–¹å¼ï¼Œé»˜è®¤è®¾ç½®ä¸ºå»¶è¿ŸåŠ è½½ã€‚ * éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå¼•ç”¨ç¼ºçœæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰å¼•ç”¨è¢«æ³¨å…¥åˆ°å…¶å®ƒBeanæˆ–è€…getBean() è·å–æ‰ä¼šåˆå§‹åŒ–ã€‚å¦‚æœéœ€è¦ç«‹å³åˆå§‹åŒ–å¯ä»¥é…ç½®ï¼š &lt;dubbo:reference init=\"true\"/&gt; */ beanDefinition.setLazyInit(false); //--------------------------- ç¡®ä¿Spring å®¹å™¨ä¸­æ²¡æœ‰é‡å¤çš„Beanå®šä¹‰ å¼€å§‹ ------------------------/ // è§£ææ ‡ç­¾å¯¹è±¡çš„idå±æ€§ String id = element.getAttribute(\"id\"); // æ ‡ç­¾æ²¡æœ‰è®¾ç½®idå±æ€§ï¼Œå¹¶ä¸”åˆ›å»ºçš„Beanå®šä¹‰éœ€è¦idæ—¶ï¼Œå°±æ‰§è¡Œç”Ÿæˆidçš„é€»è¾‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒDubboçš„referenceæ ‡ç­¾å¯¹åº”Beanå®šä¹‰ä¸éœ€è¦id if ((id == null || id.length() == 0) &amp;&amp; required) &#123; // 1. å–nameå±æ€§å€¼ String generatedBeanName = element.getAttribute(\"name\"); if (generatedBeanName == null || generatedBeanName.length() == 0) &#123; // 2. ä¹Ÿæ²¡æœ‰è®¾ç½®nameå±æ€§ï¼Œæ­¤æ—¶å¦‚æœå½“å‰æ ‡ç­¾æ˜¯Protocolï¼Œé‚£ä¹ˆidçš„å€¼å°±ç›´æ¥è®¾ç½®ä¸º 'dubbo'ï¼ŒéProtocolåè®®åˆ™å°è¯•å–æ ‡ç­¾çš„interfaceå±æ€§å€¼ if (ProtocolConfig.class.equals(beanClass)) &#123; generatedBeanName = \"dubbo\"; &#125; else &#123; generatedBeanName = element.getAttribute(\"interface\"); &#125; &#125; // 3. ä»¥ä¸Šè¿‡ç¨‹éƒ½æ²¡æœ‰ç”Ÿæˆidï¼Œåˆ™æœ€åä½¿ç”¨æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„ç±»å if (generatedBeanName == null || generatedBeanName.length() == 0) &#123; generatedBeanName = beanClass.getName(); &#125; id = generatedBeanName; int counter = 2; // æ£€æŸ¥Springæ³¨å†Œè¡¨ä¸­æ˜¯å¦å­˜åœ¨æ ‡è¯†idï¼Œå­˜åœ¨å°±é€šè¿‡è‡ªå¢åºåˆ—ç»§ç»­å¤„ç†id,ä½¿å…¶å”¯ä¸€ while (parserContext.getRegistry().containsBeanDefinition(id)) &#123; id = generatedBeanName + (counter++); &#125; &#125; if (id != null &amp;&amp; id.length() &gt; 0) &#123; if (parserContext.getRegistry().containsBeanDefinition(id)) &#123; throw new IllegalStateException(\"Duplicate spring bean id \" + id); &#125; // æŠŠæ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰æ³¨å†Œåˆ°Springï¼ŒBean åç§°ä¸ºid parserContext.getRegistry().registerBeanDefinition(id, beanDefinition); // ä¸ºBeanè¿½åŠ idå±æ€§ beanDefinition.getPropertyValues().addPropertyValue(\"id\", id); &#125; // $&#123;çœç•¥çš„ä»£ç &#125; &#125; ç‰¹æ®Šå¤„ç†protocolæ ‡ç­¾123456789101112131415161718192021222324252627282930313233343536373839/** * @param element æ ‡ç­¾å¯¹åº”çš„DOM * @param parserContext spring è§£æä¸Šä¸‹æ–‡ * @param beanClass æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±» * @param required åœ¨åˆ›å»ºBeanå®šä¹‰çš„æ—¶å€™æ˜¯å¦éœ€è¦id * @return æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰ */ @SuppressWarnings(\"unchecked\") private static BeanDefinition parse(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, boolean required) &#123; // $&#123;çœç•¥çš„ä»£ç &#125; if (ProtocolConfig.class.equals(beanClass)) &#123; /** * ä»¥ä¸‹ä»£ç é€»è¾‘éœ€è¦æ»¡è¶³ï¼š * é¡ºåºéœ€è¦è¿™æ ·ï¼š * 1 &lt;dubbo:service interface=\"com.xxx.xxxService protocol=\"dubbo\" ref=\"xxxServiceImpl\"/&gt; * 2 &lt;dubbo:protocol id =\"dubbo\" name=\"dubbo\" port=\"20880\"/&gt; */ // è·å–Beanæ³¨å†Œè¡¨ä¸­æ‰€æœ‰çš„Bean id for (String name : parserContext.getRegistry().getBeanDefinitionNames()) &#123; // æ ¹æ®idè·å–Beanå®šä¹‰ BeanDefinition definition = parserContext.getRegistry().getBeanDefinition(name); // è·å–å½“å‰Beanå®šä¹‰çš„å±æ€§å¯¹è±¡é›†åˆï¼Œå¹¶å°è¯•è·å–å±æ€§åä¸º 'protocol' çš„å±æ€§å¯¹è±¡ PropertyValue property = definition.getPropertyValues().getPropertyValue(\"protocol\"); if (property != null) &#123; // è·å–å±æ€§å€¼ Object value = property.getValue(); // å¦‚æœå½“å‰éå†çš„Beanå®šä¹‰ä¸­çš„å±æ€§æ»¡è¶³æ¡ä»¶ï¼Œå°±æ›´æ–°è¯¥Beançš„ protocol å±æ€§å€¼ï¼Œå³åç§°ä¸ºidçš„RuntimeBeanReferenceå¯¹è±¡ if (value instanceof ProtocolConfig &amp;&amp; id.equals(((ProtocolConfig) value).getName())) &#123; definition.getPropertyValues().addPropertyValue(\"protocol\", new RuntimeBeanReference(id)); &#125; &#125; &#125; &#125; // $&#123;çœç•¥çš„ä»£ç &#125; &#125; ä¸Šé¢çš„ä»£ç ç”¨æ¥å¤„ç†æ¡†æ¶ä¸­é‚£äº›å±æ€§åä¸ºâ€™protocolâ€™ä¸”å±æ€§ç±»å‹ä¸ºä¸ºProtocolConfigçš„Beanï¼Œå¦‚æœè¯¥Beanç¬¦åˆæ¡ä»¶å°±æ›´æ–°è¯¥Beançš„protocolå±æ€§å€¼ã€‚ ç‰¹æ®Šå¤„ç†serviceæ ‡ç­¾1234567891011121314151617181920212223242526272829/** * @param element æ ‡ç­¾å¯¹åº”çš„DOM * @param parserContext spring è§£æä¸Šä¸‹æ–‡ * @param beanClass æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±» * @param required åœ¨åˆ›å»ºBeanå®šä¹‰çš„æ—¶å€™æ˜¯å¦éœ€è¦id * @return æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰ */ @SuppressWarnings(\"unchecked\") private static BeanDefinition parse(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, boolean required) &#123; // $&#123;çœç•¥çš„ä»£ç &#125; else if (ServiceBean.class.equals(beanClass)) &#123; // å¦‚æœ&lt;dubbo:service&gt;é…ç½®äº†classå±æ€§ï¼Œé‚£ä¹ˆä¸ºå…·ä½“classé…ç½®çš„ç±»åˆ›å»ºBeanå®šä¹‰ï¼Œå¹¶ä¸”æŠŠè¯¥å®šä¹‰æ³¨å…¥åˆ°Serviceçš„ refå±æ€§ã€‚ä¸€èˆ¬ä¸è¿™ä¹ˆä½¿ç”¨ã€‚ // eg: &lt;dubbo:service interface=\"com.alibaba.dubbo.demo.DemoService class=\"com.alibaba.dubbo.demo.provider.DemoServiceImpl\"/&gt; String className = element.getAttribute(\"class\"); if (className != null &amp;&amp; className.length() &gt; 0) &#123; RootBeanDefinition classDefinition = new RootBeanDefinition(); classDefinition.setBeanClass(ReflectUtils.forName(className)); classDefinition.setLazyInit(false); // è§£æ &lt;dubbo:service class=\"xxx\"/&gt; æƒ…å†µä¸‹å†…åµŒçš„&lt;property/&gt;æ ‡ç­¾ï¼Œç„¶åè®¾ç½®åˆ°classDefinitionçš„å±æ€§ä¸­ parseProperties(element.getChildNodes(), classDefinition); // è®¾ç½®refå±æ€§ï¼Œç›¸å½“äºè®¾ç½® &lt;dubbo:service ref=\"\"/&gt;å±æ€§ beanDefinition.getPropertyValues().addPropertyValue(\"ref\", new BeanDefinitionHolder(classDefinition, id + \"Impl\")); &#125; &#125; // $&#123;çœç•¥çš„ä»£ç &#125; &#125; ä¸Šé¢çš„ä»£ç ç”¨æ¥å¤„ç† serviceæ ‡ç­¾ ä¸­æœ‰ class å±æ€§çš„æƒ…å†µï¼Œå¤„ç†é€»è¾‘å°±æ˜¯åˆ›å»ºclasså¯¹åº”çš„Beanå®šä¹‰ï¼Œç„¶åè®¾ç½®åˆ° serviceæ ‡ç­¾ å¯¹åº”çš„Beançš„refå±æ€§ä¸­ã€‚æˆ‘ä»¬å†æ¥çœ‹çœ‹å¯¹serviceçš„å­æ ‡ç­¾ property çš„è§£æã€‚ 123456789101112131415161718192021222324252627282930313233/** * è§£æ &lt;dubbo:service class=\"xxx\"/&gt; æƒ…å†µä¸‹å†…åµŒçš„&lt;property/&gt; * * @param nodeList å­å…ƒç´ æ•°ç»„ * @param beanDefinition Beanå®šä¹‰å¯¹è±¡ */private static void parseProperties(NodeList nodeList, RootBeanDefinition beanDefinition) &#123; if (nodeList != null &amp;&amp; nodeList.getLength() &gt; 0) &#123; for (int i = 0; i &lt; nodeList.getLength(); i++) &#123; Node node = nodeList.item(i); // åªè§£æ&lt;property/&gt;æ ‡ç­¾ if (node instanceof Element) &#123; if (\"property\".equals(node.getNodeName()) || \"property\".equals(node.getLocalName())) &#123; String name = ((Element) node).getAttribute(\"name\"); // ä¼˜å…ˆä½¿ç”¨valueå±æ€§ï¼Œå…¶æ¬¡ä½¿ç”¨refå±æ€§ if (name != null &amp;&amp; name.length() &gt; 0) &#123; String value = ((Element) node).getAttribute(\"value\"); String ref = ((Element) node).getAttribute(\"ref\"); if (value != null &amp;&amp; value.length() &gt; 0) &#123; beanDefinition.getPropertyValues().addPropertyValue(name, value); &#125; else if (ref != null &amp;&amp; ref.length() &gt; 0) &#123; beanDefinition.getPropertyValues().addPropertyValue(name, new RuntimeBeanReference(ref)); &#125; else &#123; // å±æ€§ä¸å…¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ throw new UnsupportedOperationException(\"Unsupported &lt;property name=\\\"\" + name + \"\\\"&gt; sub tag, Only supported &lt;property name=\\\"\" + name + \"\\\" ref=\\\"...\\\" /&gt; or &lt;property name=\\\"\" + name + \"\\\" value=\\\"...\\\" /&gt;\"); &#125; &#125; &#125; &#125; &#125; &#125;&#125; ä¸Šé¢çš„ä»£ç ç”¨æ¥è§£æserviceçš„propertyæ ‡ç­¾ï¼Œç›®çš„æ˜¯ä¸ºserviceæ ‡ç­¾çš„classå±æ€§å¯¹åº”çš„Beanå®šä¹‰è®¾ç½®å±æ€§ï¼Œæ¯”è¾ƒç®€å•ã€‚ ç‰¹æ®Šå¤„ç†provider/consumeræ ‡ç­¾1234567891011121314151617181920212223/** * @param element æ ‡ç­¾å¯¹åº”çš„DOM * @param parserContext spring è§£æä¸Šä¸‹æ–‡ * @param beanClass æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±» * @param required åœ¨åˆ›å»ºBeanå®šä¹‰çš„æ—¶å€™æ˜¯å¦éœ€è¦id * @return æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰ */ @SuppressWarnings(\"unchecked\") private static BeanDefinition parse(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, boolean required) &#123; // $&#123;çœç•¥çš„ä»£ç &#125; else if (ProviderConfig.class.equals(beanClass)) &#123; // è§£æ &lt;dubbo:provider/&gt; çš„å†…åµŒå­å…ƒç´ &lt;dubbo:service/&gt; parseNested(element, parserContext, ServiceBean.class, true, \"service\", \"provider\", id, beanDefinition); &#125;else if (ConsumerConfig.class.equals(beanClass)) &#123; // è§£æ &lt;dubbo:consumer/&gt; çš„å†…åµŒå­å…ƒç´ &lt;dubbo:reference/&gt; parseNested(element, parserContext, ReferenceBean.class, false, \"reference\", \"consumer\", id, beanDefinition); &#125; // $&#123;çœç•¥çš„ä»£ç &#125; &#125; ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œç‰¹æ®Šå¤„ç†provider/consumeræ ‡ç­¾å°±æ˜¯å¤„ç†å®ƒæœ‰service/referenceå­æ ‡ç­¾çš„æƒ…å†µï¼Œä»£ç è¿‡ç¨‹å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243/** * è§£æå†…åµŒçš„æ ‡ç­¾ * * @param element çˆ¶æ ‡ç­¾å¯¹è±¡ - provider/consumeræ ‡ç­¾å¯¹è±¡ * @param parserContext Springè§£æä¸Šä¸‹æ–‡ * @param beanClass å†…åµŒå­å…ƒç´ çš„Beanç±» - ServiceBean/ReferenceBean * @param required æ˜¯å¦éœ€è¦Beançš„idå±æ€§ * @param tag å­å…ƒç´ æ ‡ç­¾å service/reference * @param property çˆ¶Beanå¯¹è±¡åœ¨å­å…ƒç´ ä¸­çš„å±æ€§å provider/consumer * @param ref çˆ¶Beançš„id * @param beanDefinition çˆ¶Beanå®šä¹‰å¯¹è±¡ */ private static void parseNested(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, boolean required, String tag, String property, String ref, BeanDefinition beanDefinition) &#123; // è·å–å­èŠ‚ç‚¹åˆ—è¡¨ NodeList nodeList = element.getChildNodes(); if (nodeList != null &amp;&amp; nodeList.getLength() &gt; 0) &#123; boolean first = true; for (int i = 0; i &lt; nodeList.getLength(); i++) &#123; // è·å–å­èŠ‚ç‚¹ Node node = nodeList.item(i); if (node instanceof Element) &#123; // å½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯æŒ‡å®šçš„å­èŠ‚ç‚¹ï¼Œè¿™é‡Œå¯èƒ½æ˜¯service/referenceèŠ‚ç‚¹ if (tag.equals(node.getNodeName()) || tag.equals(node.getLocalName())) &#123; if (first) &#123; first = false; // è·å–çˆ¶èŠ‚ç‚¹çš„defaultçš„å±æ€§å€¼ [æš‚æ—¶ä¸çŸ¥é“æœ‰ä»€ä¹ˆç”¨] String isDefault = element.getAttribute(\"default\"); if (isDefault == null || isDefault.length() == 0) &#123; beanDefinition.getPropertyValues().addPropertyValue(\"default\", \"false\"); &#125; &#125; // è§£æå­å…ƒç´ ï¼Œåˆ›å»ºBeanDefinition å¯¹è±¡ ï¼ˆé€’å½’ï¼‰ BeanDefinition subDefinition = parse((Element) node, parserContext, beanClass, required); // è®¾ç½®å­BeanDefinitionçš„æŒ‡å‘ï¼ŒæŒ‡å‘çˆ¶BeanDefinition if (subDefinition != null &amp;&amp; ref != null &amp;&amp; ref.length() &gt; 0) &#123; subDefinition.getPropertyValues().addPropertyValue(property, new RuntimeBeanReference(ref)); &#125; &#125; &#125; &#125; &#125; &#125; ä¸Šé¢çš„ä»£ç ä¸»è¦å¤„ç†provider/consumeræ ‡ç­¾å†…éƒ¨åµŒå¥—çš„æ ‡ç­¾ï¼Œå†…éƒ¨åµŒå¥—çš„æ ‡ç­¾å¯¹è±¡ä¼šè‡ªåŠ¨æŒæœ‰å¤–å±‚æ ‡ç­¾çš„å¯¹è±¡ã€‚ è®¾ç½®æ ‡ç­¾çš„å±æ€§åˆ° BeanDefinitionå‰é¢å¤„ç†çš„é€»è¾‘å±äºç‰¹æ®Šçš„æƒ…å†µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åˆ†ææ ‡ç­¾çš„å±æ€§æ˜¯å¦‚ä½•è®¾ç½®åˆ°é…ç½®å¯¹è±¡ä¸­çš„ã€‚æœ¬è´¨ä¸Šæ˜¯é€šè¿‡éå†é…ç½®å¯¹è±¡çš„getã€setå’Œiså‰ç¼€æ–¹æ³•ï¼Œé€šè¿‡åå°„å°†æ ‡ç­¾å±æ€§è®¾ç½®åˆ°é…ç½®å¯¹è±¡ä¸­ã€‚æ€»ä½“ä¸Šåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š å¦‚æœæ ‡ç­¾å±æ€§å’Œæ–¹æ³•åç›¸åŒï¼Œåˆ™é€šè¿‡åå°„è°ƒç”¨è®¾ç½®æ ‡ç­¾çš„å€¼åˆ°é…ç½®å¯¹è±¡ä¸­ã€‚ å¦‚æœæ ‡ç­¾å±æ€§ä¸èƒ½åŒ¹é…åˆ°é…ç½®å¯¹è±¡ä¸­çš„æ–¹æ³•åç§°ï¼Œåˆ™å°†æ ‡ç­¾å±æ€§å½“ä½œparameterå‚æ•°è®¾ç½®åˆ°é…ç½®å¯¹è±¡ä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194/** * @param element æ ‡ç­¾å¯¹åº”çš„DOM * @param parserContext spring è§£æä¸Šä¸‹æ–‡ * @param beanClass æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±» * @param required åœ¨åˆ›å»ºBeanå®šä¹‰çš„æ—¶å€™æ˜¯å¦éœ€è¦id * @return æ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰ */ @SuppressWarnings(\"unchecked\") private static BeanDefinition parse(Element element, ParserContext parserContext, Class&lt;?&gt; beanClass, boolean required) &#123; // $&#123;çœç•¥çš„ä»£ç &#125; // ç”¨æ¥ä¿å­˜å·²éå†çš„é…ç½®å¯¹è±¡çš„å±æ€§é›†åˆï¼Œç”¨æ¥åˆ¤æ–­æ ‡ç­¾ä¸­å“ªäº›å±æ€§æ²¡æœ‰åŒ¹é…ä¸Š Set&lt;String&gt; props = new HashSet&lt;String&gt;(); // ä¸“é—¨å­˜æ”¾&lt;dubbo:parameters/&gt; æ ‡ç­¾ä¸‹å­æ ‡ç­¾å±æ€§ä¿¡æ¯ã€‚æœ€åéƒ½è®¾ç½®åˆ°Beanå®šä¹‰ä¸­ ManagedMap parameters = null; // 1. è·å–é…ç½®å¯¹è±¡æ‰€æœ‰æ–¹æ³• for (Method setter : beanClass.getMethods()) &#123; String name = setter.getName(); // 2. é€‰æ‹©æ‰€æœ‰setå‰ç¼€æ–¹æ³•ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå‚æ•°çš„ public æ–¹æ³• if (name.length() &gt; 3 &amp;&amp; name.startsWith(\"set\") &amp;&amp; Modifier.isPublic(setter.getModifiers()) &amp;&amp; setter.getParameterTypes().length == 1) &#123; // è·å–æ–¹æ³•çš„å‚æ•°ç±»å‹ Class&lt;?&gt; type = setter.getParameterTypes()[0]; // 3. æå–setå¯¹åº”çš„å±æ€§åå­—ï¼Œeg: setTimeout-&gt;timeout,setBeanName-&gt;bean-name String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), \"-\"); // ä¿å­˜åˆ°å±æ€§ props é›†åˆä¸­ props.add(property); // 4. å°è¯•è·å–å±æ€§å¯¹åº”çš„getteræ–¹æ³• Method getter = null; try &#123; getter = beanClass.getMethod(\"get\" + name.substring(3), new Class&lt;?&gt;[0]); &#125; catch (NoSuchMethodException e) &#123; try &#123; // æ²¡æœ‰setterå¯¹åº”çš„getteræ–¹æ³•ï¼Œå°è¯•è·å–isæ–¹æ³•ï¼Œisæ–¹æ³•åœ¨åŠŸèƒ½ä¸Šæ˜¯åŒgetter getter = beanClass.getMethod(\"is\" + name.substring(3), new Class&lt;?&gt;[0]); &#125; catch (NoSuchMethodException e2) &#123; &#125; &#125; // 5. æ ¡éªŒå±æ€§æ˜¯å¦æœ‰å¯¹åº”çš„getter/iså‰ç¼€æ–¹æ³•ï¼Œæ²¡æœ‰å°±è·³è¿‡ if (getter == null || !Modifier.isPublic(getter.getModifiers()) || !type.equals(getter.getReturnType())) &#123; continue; &#125; // 6. è§£æ &lt;dubbo:parameter/&gt; æ ‡ç­¾ï¼Œå°†å½“å‰æ ‡ç­¾elementçš„å­æ ‡ç­¾ &lt;dubbo:parameter/&gt; çš„å±æ€§é”®å€¼å¯¹ä¿å­˜åˆ°parametersä¸­ if (\"parameters\".equals(property)) &#123; parameters = parseParameters(element.getChildNodes(), beanDefinition); // 7. è§£æ &lt;dubbo:method/&gt; æ ‡ç­¾ï¼Œå°†å½“å‰æ ‡ç­¾elementçš„å­æ ‡ç­¾ &lt;dubbo:method/&gt; è¿›è¡Œè§£æï¼Œå°†è§£æå¾—åˆ°çš„å¯¹åº”BeanDefinitonæ”¾å…¥åˆ°ManagedListé›†åˆä¸­ï¼Œæœ€åä½œä¸º beanDefinitonçš„methodså±æ€§å€¼ã€‚ &#125; else if (\"methods\".equals(property)) &#123; parseMethods(id, element.getChildNodes(), beanDefinition, parserContext); // 8. è§£æ &lt;dubbo:argument/&gt;æ ‡ç­¾ï¼Œå°†å½“å‰æ ‡ç­¾elementçš„å­æ ‡ç­¾ &lt;dubbo:argument/&gt; è¿›è¡Œè§£æï¼Œå°†è§£æå¾—åˆ°çš„å¯¹åº”çš„BeanDefinitionæ”¾å…¥åˆ°ManagedListé›†åˆä¸­ï¼Œæœ€åä½œä¸º beanDefinitionçš„argumentså±æ€§å€¼ã€‚ &#125; else if (\"arguments\".equals(property)) &#123; parseArguments(id, element.getChildNodes(), beanDefinition, parserContext); &#125; else &#123; // 9. è·å–æ ‡ç­¾å±æ€§çš„å€¼ ã€å‰é¢çš„æ­¥éª¤ä¹‹æ‰€ä»¥å•ç‹¬å¤„ç†ï¼Œæ˜¯å› ä¸ºå½“å‰é…ç½®é…ç½®å¯¹è±¡å¯¹åº”çš„å±æ€§ä¸æ˜¯ä¸€ä¸ªæ ‡ç­¾å±æ€§ï¼Œè€Œæ˜¯ä¸€ä¸ªå­æ ‡ç­¾ã€‘ String value = element.getAttribute(property); if (value != null) &#123; value = value.trim(); if (value.length() &gt; 0) &#123; // 9.1 æ ‡ç­¾ä¸­é…ç½®äº† registry=N/A, ä¸æƒ³æ³¨å†Œåˆ°çš„æƒ…å†µ if (\"registry\".equals(property) &amp;&amp; RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(value)) &#123; RegistryConfig registryConfig = new RegistryConfig(); // RegistryConfigçš„åœ°å€è®¾ç½® N/A registryConfig.setAddress(RegistryConfig.NO_AVAILABLE); beanDefinition.getPropertyValues().addPropertyValue(property, registryConfig); // 9.2 å¤šæ³¨å†Œä¸­å¿ƒæƒ…å†µï¼Œå°†å¤šä¸ªæ³¨å†Œä¸­å¿ƒå¤„ç†æˆä¸€ä¸ªé›†åˆï¼Œç„¶åè®¾ç½®åˆ° beanDefiniton ä¸­ï¼Œå±æ€§åä¸º 'registries' &#125; else if (\"registry\".equals(property) &amp;&amp; value.indexOf(',') != -1) &#123; parseMultiRef(\"registries\", value, beanDefinition, parserContext); // 9.3 å¤šæœåŠ¡æä¾›è€…æƒ…å†µï¼Œå°†å¤šä¸ªæœåŠ¡æä¾›è€…å¤„ç†æˆä¸€ä¸ªé›†åˆï¼Œç„¶åè®¾ç½®åˆ° beanDefinition ä¸­ï¼Œå±æ€§ä¸º 'providers' &#125; else if (\"provider\".equals(property) &amp;&amp; value.indexOf(',') != -1) &#123; parseMultiRef(\"providers\", value, beanDefinition, parserContext); // 9.4 å¤šåè®®æƒ…å†µï¼Œå°†å¤šä¸ªåè®®å¤„ç†æˆä¸€ä¸ªé›†åˆï¼Œç„¶åè®¾ç½®åˆ° beanDefinition ä¸­ï¼Œå±æ€§ä¸º 'protocols' &#125; else if (\"protocol\".equals(property) &amp;&amp; value.indexOf(',') != -1) &#123; parseMultiRef(\"protocols\", value, beanDefinition, parserContext); &#125; else &#123; Object reference; // 10. å±æ€§ç±»å‹ä¸ºåŸºæœ¬ç±»å‹çš„æƒ…å†µ if (isPrimitive(type)) &#123; // å…¼å®¹æ€§å¤„ç†ã€ä¸€äº›è®¾ç½®äº†ä½†æ˜¯æ„ä¹‰ä¸å¤§çš„å±æ€§å°±æŠŠå€¼è®¾ç½®ä¸ºnullã€‘ if (\"async\".equals(property) &amp;&amp; \"false\".equals(value) || \"timeout\".equals(property) &amp;&amp; \"0\".equals(value) || \"delay\".equals(property) &amp;&amp; \"0\".equals(value) || \"version\".equals(property) &amp;&amp; \"0.0.0\".equals(value) || \"stat\".equals(property) &amp;&amp; \"-1\".equals(value) || \"reliable\".equals(property) &amp;&amp; \"false\".equals(value)) &#123; // backward compatibility for the default value in old version's xsd value = null; &#125; reference = value; //11. å¤„ç†åœ¨&lt;dubbo:provider/&gt; æˆ–è€… &lt;dubbo:service/&gt; ä¸Šå®šä¹‰äº† protocol å±æ€§çš„å…¼å®¹æ€§ï¼Œç›®å‰å·²ç»ä¸æ¨èè¿™æ ·ä½¿ç”¨äº†ï¼Œåº”è¯¥å•ç‹¬é…ç½® &lt;dubbo:protocol/&gt; &#125; else if (\"protocol\".equals(property) &amp;&amp; ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(value) &amp;&amp; (!parserContext.getRegistry().containsBeanDefinition(value) || !ProtocolConfig.class.getName().equals(parserContext.getRegistry().getBeanDefinition(value).getBeanClassName()))) &#123; if (\"dubbo:provider\".equals(element.getTagName())) &#123; logger.warn(\"Recommended replace &lt;dubbo:provider protocol=\\\"\" + value + \"\\\" ... /&gt; to &lt;dubbo:protocol name=\\\"\" + value + \"\\\" ... /&gt;\"); &#125; // backward compatibility ProtocolConfig protocol = new ProtocolConfig(); protocol.setName(value); reference = protocol; //------- 12. äº‹ä»¶é€šçŸ¥: åœ¨è°ƒç”¨å‰ï¼Œè°ƒç”¨åï¼Œå‡ºç°å¼‚å¸¸ï¼Œä¼šè§¦å‘oninvokeï¼Œonreturn,onthrowä¸‰ä¸ªäº‹ä»¶ï¼Œå¯ä»¥é…ç½®å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œé€šçŸ¥å“ªä¸ªç±»çš„å“ªä¸ªæ–¹æ³• ------// /* // æ ¼å¼ï¼šå®ç°Bean.æ–¹æ³• &lt;bean id=\"demoCallBack\" class = \"com.alibaba.dubbo.callback.implicit.NofifyImpl\"/&gt; &lt;dubbo:reference id = \"demoService\" interface=\"com.alibaba.dubbo.IDemoService\"&gt; &lt;dubbo:method name=\"get\" onreturn=\"demoCallBack.xxxMethod\" onthrow=\"demoCallBack.xMethod\"/&gt; &lt;/dubbo:reference&gt; */ // 12.1 å¤„ç† onreturn å±æ€§ &#125; else if (\"onreturn\".equals(property)) &#123; // æŒ‰ç…§ . æ‹†åˆ† int index = value.lastIndexOf(\".\"); // è·å–å®ä¾‹å String returnRef = value.substring(0, index); // è·å–å®ä¾‹çš„æ–¹æ³• String returnMethod = value.substring(index + 1); // åˆ›å»º RuntimeBeanReferenceï¼ŒæŒ‡å‘å›è°ƒçš„å¯¹è±¡ reference = new RuntimeBeanReference(returnRef); // è®¾ç½® onreturnMethod åˆ° BeanDefinition çš„å±æ€§å€¼ beanDefinition.getPropertyValues().addPropertyValue(\"onreturnMethod\", returnMethod); // 12.2 å¤„ç† onthrow å±æ€§ &#125; else if (\"onthrow\".equals(property)) &#123; int index = value.lastIndexOf(\".\"); String throwRef = value.substring(0, index); String throwMethod = value.substring(index + 1); // åˆ›å»º RuntimeBeanReferenceï¼ŒæŒ‡å‘å›è°ƒçš„å¯¹è±¡ reference = new RuntimeBeanReference(throwRef); // è®¾ç½® onthrowMethod åˆ° BeanDefinition çš„å±æ€§å€¼ beanDefinition.getPropertyValues().addPropertyValue(\"onthrowMethod\", throwMethod); //12.3 å¤„ç†oninvoke å±æ€§ &#125; else if (\"oninvoke\".equals(property)) &#123; int index = value.lastIndexOf(\".\"); String invokeRef = value.substring(0, index); String invokeRefMethod = value.substring(index + 1); reference = new RuntimeBeanReference(invokeRef); beanDefinition.getPropertyValues().addPropertyValue(\"oninvokeMethod\", invokeRefMethod); //----------------------------- äº‹ä»¶é€šçŸ¥ç»“æŸ ------------------------------// &#125; else &#123; // 13. å±æ€§åæ²¡æœ‰åŒ¹é…åˆ°å¯¹åº”çš„æ ‡ç­¾åï¼Œéƒ½ä¼šåˆ°è¿™é‡Œ //13.1 å¦‚æœå±æ€§åæ˜¯ref, ref å¯¹åº”çš„Bean å¿…é¡»æ˜¯å•ä¾‹çš„ if (\"ref\".equals(property) &amp;&amp; parserContext.getRegistry().containsBeanDefinition(value)) &#123; BeanDefinition refBean = parserContext.getRegistry().getBeanDefinition(value); if (!refBean.isSingleton()) &#123; throw new IllegalStateException(\"The exported service ref \" + value + \" must be singleton! Please set the \" + value + \" bean scope to singleton, eg: &lt;bean id=\\\"\" + value + \"\\\" scope=\\\"singleton\\\" ...&gt;\"); &#125; &#125; // åˆ›å»ºRuntimeBeanReference reference = new RuntimeBeanReference(value); &#125; // è®¾ç½®Beanå®šä¹‰çš„å±æ€§ beanDefinition.getPropertyValues().addPropertyValue(property, reference); &#125; &#125; &#125; &#125; &#125; &#125; // å°†æ ‡ç­¾ä¸­è‡ªå®šä¹‰çš„å±æ€§ï¼ˆä¸æ˜¯Dubbo Schema çº¦å®šå¥½çš„ï¼‰ä¹ŸåŠ å…¥åˆ° parameters é›†åˆä¸­ NamedNodeMap attributes = element.getAttributes(); int len = attributes.getLength(); for (int i = 0; i &lt; len; i++) &#123; Node node = attributes.item(i); String name = node.getLocalName(); if (!props.contains(name)) &#123; if (parameters == null) &#123; parameters = new ManagedMap(); &#125; String value = node.getNodeValue(); parameters.put(name, new TypedStringValue(value, String.class)); &#125; &#125; if (parameters != null) &#123; beanDefinition.getPropertyValues().addPropertyValue(\"parameters\", parameters); &#125; return beanDefinition; &#125; ä¸Šé¢çš„ä»£ç æ˜¯æŠŠå±æ€§æ³¨å…¥åˆ°æ ‡ç­¾å¯¹åº”çš„BeanDefinitionï¼Œå¦‚æœå±æ€§æ˜¯å¼•ç”¨å¯¹è±¡ï¼ŒDubboé»˜è®¤ä¼šåˆ›å»º RuntimeBeanReference ç±»å‹æ³¨å…¥ï¼Œè¿è¡Œæ—¶ç”±Springæ³¨å…¥å¼•ç”¨å¯¹è±¡ã€‚ æ€»ç»“Dubboæ¡†æ¶è§£æé…ç½®æ–‡ä»¶ç”ŸæˆBeanDefinitionå…¶å®æ˜¯ç”Ÿæˆæ ‡ç­¾å¯¹åº”çš„é…ç½®ç±»çš„Beanå®šä¹‰ï¼ŒBeanå®šä¹‰ä¸­çš„å±æ€§å€¼ä¸»è¦æ¥æºäºæ ‡ç­¾çš„å±æ€§å€¼ï¼ŒDubboå¯¹æ ‡ç­¾å±æ€§åªæ˜¯è¿›è¡Œäº†æå–ï¼Œæ ‡ç­¾çš„å†…åµŒæ ‡ç­¾å¤„ç†ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œè¿è¡Œæ—¶å±æ€§æ³¨å…¥å’Œè½¬æ¢éƒ½è¿˜æ˜¯Springæ¥å®Œæˆçš„ï¼ŒDubboæ¡†æ¶ç”Ÿæˆçš„BeanDefinitionæœ€ç»ˆä¼šå§”æ‰˜Springåˆ›å»ºå¯¹åº”çš„å¯¹è±¡ï¼Œè¿™ä¸ªå±äºSpringçš„æµç¨‹å°±ä¸å¤šè¯´äº†ã€‚dubbo.xsdæ–‡ä»¶ä¸­å®šä¹‰çš„ç±»å‹éƒ½ä¼šæœ‰ä¸ä¹‹å¯¹åº”çš„é…ç½®æ‰¿è½½ç±»ä¸­çš„å±æ€§ï¼Œæˆ‘ä»¬å·²ç»åœ¨APIé…ç½®ä¸­ä»‹ç»è¿‡äº†ã€‚XMLé…ç½®è§£æè¿˜æ˜¯æŒºå¤æ‚çš„ï¼Œåˆ†æ”¯æµæ¯”è¾ƒå¤šï¼Œä¸‹ä¸€ç« è¦åˆ†æçš„æ³¨è§£é…ç½®ç¨å¾®æ¯”è¿™ä¸ªå¤æ‚ä¸€äº›ã€‚éšç€åé¢æ·±å…¥çš„åˆ†æå°±ä¼šå‘ç°è¿™äº›ä¸œè¥¿éƒ½æ˜¯åŸºç¡€ï¼Œç»“åˆDubboçš„æ•´ä¸ªè¿‡ç¨‹å°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"}]},{"title":"Dubboæºç åˆ†æ - APIå’Œå±æ€§é…ç½®","slug":"rpc/APIé…ç½®","date":"2020-03-24T16:00:00.000Z","updated":"2020-09-03T03:12:53.647Z","comments":false,"path":"posts/1d3295e6/","link":"","permalink":"https://gentryhuang.com/posts/1d3295e6/","excerpt":"","text":"å‰è¨€æˆ‘ä»¬é€šè¿‡ Dubbo URLç»Ÿä¸€æ¨¡å‹ å·²ç»äº†è§£äº†Dubbo URLæ˜¯Dubooçš„é…ç½®æ€»çº¿ï¼Œè´¯ç©¿æ•´ä¸ªDubboçš„ç”Ÿå‘½å‘¨æœŸã€‚è™½ç„¶Dubbo URLç›´æ¥å†³å®šäº†Dubboç»„ä»¶çš„è§’è‰²å¹¶æ§åˆ¶Dubboçš„è¡Œä¸ºï¼Œä½†æ˜¯Dubbo URLä¸­çš„ä¿¡æ¯éœ€è¦Dubboçš„é…ç½®æ‰¿å¯¹è±¡æ¥æä¾›ï¼Œè€Œé…ç½®æ‰¿è½½å¯¹è±¡ä¸­çš„æ•°æ®æ¥æºäºå¤šç§é…ç½®å’Œè®¾ç½®ã€‚ ç›®å‰Dubboæ¡†æ¶åŒæ—¶æ”¯æŒ4ç§é…ç½®æ–¹å¼ï¼šAPIç¡¬ç¼–ç é…ç½®ã€XMLé…ç½®ã€æ³¨è§£é…ç½®ã€å±æ€§é…ç½®ã€‚è€Œæ‰€æœ‰çš„é…ç½®é¡¹åˆ†ä¸ºä¸‰å¤§ç±»: æœåŠ¡æ³¨å†Œå’Œå‘ç°ï¼šè¡¨ç¤ºè¯¥é…ç½®é¡¹ç”¨äºæœåŠ¡çš„æ³¨å†Œå’Œå‘ç°ã€‚ æœåŠ¡æ²»ç†ï¼šè¡¨ç¤ºè¯¥é…ç½®é¡¹ç”¨äºæ²»ç†æœåŠ¡é—´çš„å…³ç³»ï¼Œæˆ–ä¸ºå¼€å‘æµ‹è¯•æä¾›ä¾¿åˆ©æ¡ä»¶ã€‚ æ€§èƒ½è°ƒä¼˜ï¼šè¡¨ç¤ºè¯¥é…ç½®é¡¹ç”¨äºè°ƒä¼˜æ€§èƒ½ï¼Œä¸åŒçš„é€‰é¡¹å¯¹æ€§èƒ½ä¼šäº§ç”Ÿå½±å“ã€‚ æ³¨æ„ï¼šæ‰€æœ‰é…ç½®æœ€ç»ˆéƒ½ä¼šè½¬æ¢ä¸ºDubbo URL é…ç½®æ‰¿è½½å¯¹è±¡ä¸ç®¡æ˜¯æ³¨è§£è¿˜æ˜¯XMLé…ç½®éƒ½éœ€è¦é…ç½®å¯¹è±¡æ¥æ‰¿è½½ï¼ŒXMLé…ç½®ã€æ³¨è§£é…ç½®ã€å±æ€§é…ç½®éƒ½æ˜¯å’Œé…ç½®å¯¹è±¡æˆ–å…¶å±æ€§ç›¸æ˜ å°„çš„ï¼Œä¸ºä»€ä¹ˆè¿™é‡Œæ²¡æœ‰è¯´APIé…ç½®å’Œé…ç½®å¯¹è±¡çš„æ˜ å°„å…³ç³»å‘¢ï¼Ÿå…¶å®APIé…ç½®å°±æ˜¯ç›´æ¥æ“ä½œé…ç½®å¯¹è±¡ï¼Œè€ŒXMLé…ç½®å’Œæ³¨è§£é…ç½®éƒ½æ˜¯ç”±Springæ¥åˆ›å»ºé…ç½®å¯¹è±¡å¹¶è®¾ç½®å±æ€§çš„ï¼Œè€Œæˆ‘ä»¬çš„å±æ€§é…ç½®æ˜¯åœ¨é…ç½®å¯¹è±¡å·²ç»å­˜åœ¨çš„åŸºç¡€ä¸Šï¼Œä¸ºå…¶è®¾ç½®æŒ‡å®šçš„å±æ€§å€¼ã€‚ä¸‹é¢æ˜¯Dubboçš„å±æ€§é…ç½®ç±»çš„ç»“æ„ï¼š ä¸Šå›¾ä¸­æˆ‘ä½¿ç”¨äº†é»„è‰²æ¡†å’Œçº¢è‰²æ¡†åˆ†åˆ«å¯¹æŠ½è±¡é…ç½®ç±»å’Œé…ç½®å®ç°ç±»è¿›è¡Œäº†æ ‡æ³¨ï¼Œå…¶ä¸­DubboShutdownHookå…ˆå¿½ç•¥ã€‚çº¢è‰²æ¡†ä¸­çš„é…ç½®ç±»æ˜¯ç›´æ¥çš„é…ç½®æ‰¿è½½ç±»ï¼Œé»„è‰²æ¡†ä¸­çš„æŠ½è±¡é…ç½®ç±»æ˜¯é…ç½®æ‰¿è½½ç±»çš„çˆ¶ç±»ã€‚ä¸‹é¢æ˜¯é…ç½®æ‰¿è½½ç±»çš„UMLå›¾ï¼š ç›´è§‚å›¾ ä¾èµ–å…³ç³»å›¾ é€šè¿‡ä¸Šé¢çš„å…³ç³»å›¾æˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ¥šåœ°äº†è§£åˆ°æ¯ä¸ªé…ç½®ä¹‹é—´çš„å…³ç³»ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±é¡ºç€å…³ç³»å›¾åˆ†åˆ«ä»‹ç»æ ¸å¿ƒçš„é…ç½®ç±»ã€‚ AbstractConfig æŠ½è±¡é…ç½®ç±»é™¤äº†ArgumentConfigé…ç½®ç±»ï¼Œå‡ ä¹å…¶ä»–çš„æ‰€æœ‰é…ç½®ç±»éƒ½ç›´æ¥æˆ–é—´æ¥ç»§æ‰¿è¯¥ç±»ï¼Œè¯¥ç±»ä¸»è¦æä¾›é…ç½®è§£æä¸æ ¡éªŒç›¸å…³çš„å·¥å…·æ–¹æ³•ã€‚ æ ¼å¼æ ¡éªŒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108public abstract class AbstractConfig implements Serializable &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; //-------------------------- æ ¼å¼æ£€éªŒ -----------------------------/ private static final int MAX_LENGTH = 200; private static final int MAX_PATH_LENGTH = 200; private static final Pattern PATTERN_NAME = Pattern.compile(\"[\\\\-._0-9a-zA-Z]+\"); private static final Pattern PATTERN_MULTI_NAME = Pattern.compile(\"[,\\\\-._0-9a-zA-Z]+\"); private static final Pattern PATTERN_METHOD_NAME = Pattern.compile(\"[a-zA-Z][0-9a-zA-Z]*\"); private static final Pattern PATTERN_PATH = Pattern.compile(\"[/\\\\-$._0-9a-zA-Z]+\"); private static final Pattern PATTERN_NAME_HAS_SYMBOL = Pattern.compile(\"[:*,/\\\\-._0-9a-zA-Z]+\"); private static final Pattern PATTERN_KEY = Pattern.compile(\"[*,\\\\-._0-9a-zA-Z]+\"); protected static void checkExtension(Class&lt;?&gt; type, String property, String value) &#123; checkName(property, value); if (value != null &amp;&amp; value.length() &gt; 0 &amp;&amp; !ExtensionLoader.getExtensionLoader(type).hasExtension(value)) &#123; throw new IllegalStateException(\"No such extension \" + value + \" for \" + property + \"/\" + type.getName()); &#125; &#125; protected static void checkMultiExtension(Class&lt;?&gt; type, String property, String value) &#123; checkMultiName(property, value); if (value != null &amp;&amp; value.length() &gt; 0) &#123; String[] values = value.split(\"\\\\s*[,]+\\\\s*\"); for (String v : values) &#123; if (v.startsWith(Constants.REMOVE_VALUE_PREFIX)) &#123; v = v.substring(1); &#125; if (Constants.DEFAULT_KEY.equals(v)) &#123; continue; &#125; if (!ExtensionLoader.getExtensionLoader(type).hasExtension(v)) &#123; throw new IllegalStateException(\"No such extension \" + v + \" for \" + property + \"/\" + type.getName()); &#125; &#125; &#125; &#125; protected static void checkLength(String property, String value) &#123; checkProperty(property, value, MAX_LENGTH, null); &#125; protected static void checkPathLength(String property, String value) &#123; checkProperty(property, value, MAX_PATH_LENGTH, null); &#125; protected static void checkName(String property, String value) &#123; checkProperty(property, value, MAX_LENGTH, PATTERN_NAME); &#125; protected static void checkNameHasSymbol(String property, String value) &#123; checkProperty(property, value, MAX_LENGTH, PATTERN_NAME_HAS_SYMBOL); &#125; protected static void checkKey(String property, String value) &#123; checkProperty(property, value, MAX_LENGTH, PATTERN_KEY); &#125; protected static void checkMultiName(String property, String value) &#123; checkProperty(property, value, MAX_LENGTH, PATTERN_MULTI_NAME); &#125; protected static void checkPathName(String property, String value) &#123; checkProperty(property, value, MAX_PATH_LENGTH, PATTERN_PATH); &#125; protected static void checkMethodName(String property, String value) &#123; checkProperty(property, value, MAX_LENGTH, PATTERN_METHOD_NAME); &#125; protected static void checkParameterName(Map&lt;String, String&gt; parameters) &#123; if (parameters == null || parameters.size() == 0) &#123; return; &#125; for (Map.Entry&lt;String, String&gt; entry : parameters.entrySet()) &#123; checkNameHasSymbol(entry.getKey(), entry.getValue()); &#125; &#125; protected static void checkProperty(String property, String value, int maxlength, Pattern pattern) &#123; if (value == null || value.length() == 0) &#123; return; &#125; if (value.length() &gt; maxlength) &#123; throw new IllegalStateException(\"Invalid \" + property + \"=\\\"\" + value + \"\\\" is longer than \" + maxlength); &#125; if (pattern != null) &#123; Matcher matcher = pattern.matcher(value); if (!matcher.matches()) &#123; throw new IllegalStateException(\"Invalid \" + property + \"=\\\"\" + value + \"\\\" contains illegal \" + \"character, only digit, letter, '-', '_' or '.' is legal.\"); &#125; &#125; &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; AbstractConfigçš„å­ç±»ä¼šè°ƒç”¨è¿™é‡Œçš„æ–¹æ³•è¿›è¡Œç›¸å…³çš„å‚æ•°æ ¡éªŒã€‚ æ·»åŠ å±æ€§ï¼ˆå±æ€§å’Œç³»ç»Ÿå‚æ•°é…ç½®ï¼‰è¯»å–å¯åŠ¨å‚æ•°å˜é‡å’ŒPropertiesé…ç½®æ–‡ä»¶ä¸­å±æ€§åˆ°é…ç½®æ‰¿è½½å¯¹è±¡ä¸­ï¼Œè¯¥æ–¹æ³•å…¶å®å°±æ˜¯å±æ€§é…ç½® å’Œ ç³»ç»Ÿå‚æ•°é…ç½®çš„é€»è¾‘ã€‚è¿™ä¸ªé€»è¾‘éå¸¸é‡è¦ï¼Œæ— è®ºæ˜¯APIé…ç½®è¿˜æ˜¯XMLé…ç½®ï¼Œä»¥åŠæ³¨è§£é…ç½®ï¼Œéƒ½ä¼šä½¿ç”¨è¯¥é€»è¾‘ä¸ºé…ç½®æ‰¿è½½å¯¹è±¡è®¾ç½®ç³»ç»Ÿå‚æ•°å€¼ä»¥åŠé…ç½®å±æ€§å€¼ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104public abstract class AbstractConfig implements Serializable &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * 1 id å±æ€§ï¼ŒBeanå®šä¹‰çš„åç§°ï¼Œé€‚ç”¨äºé™¤äº†APIé…ç½®ä¹‹å¤–çš„ä¸‰ç§é…ç½®ï¼ˆå±æ€§é…ç½®ï¼Œxmlé…ç½®,æ³¨è§£é…ç½®ï¼‰æ–¹å¼ï¼Œå¯ç”¨äºå¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ * 2 ä¸é€‚ç”¨APIé…ç½®ï¼Œæ˜¯å› ä¸ºAPIé…ç½®ç›´æ¥setter(xxx)å¯¹è±¡å³å¯ */ protected String id; /** * è¯»å–å¸¦æœ‰é…ç½®é¡¹åå‰ç¼€çš„å¯åŠ¨å‚æ•°å˜é‡å’Œpropertiesé…ç½®åˆ° é…ç½®æ‰¿è½½å¯¹è±¡ä¸­ã€‚ * è¯´æ˜ï¼šåœ¨æ­¤ä¹‹å‰é…ç½®æ‰¿è½½å¯¹è±¡ä¸­åªå¯èƒ½æœ‰xmlé…ç½®çš„å±æ€§å€¼ï¼Œæˆ–è€…æ³¨è§£é…ç½®çš„å±æ€§å€¼ * * @param config é…ç½®å¯¹è±¡ */ protected static void appendProperties(AbstractConfig config) &#123; if (config == null) &#123; return; &#125; // è·å¾—é…ç½®é¡¹å‰ç¼€ï¼ˆä½¿ç”¨é…ç½®ç±»çš„ç±»åï¼Œè·å¾—å¯¹åº”çš„å±æ€§æ ‡ç­¾ï¼‰-&gt; dubbo.tag. String prefix = \"dubbo.\" + getTagName(config.getClass()) + \".\"; // è·å¾—é…ç½®ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œç”¨äºä¸‹é¢é€šè¿‡åå°„è·å¾—é…ç½®é¡¹çš„å±æ€§åï¼Œå†ç”¨å±æ€§åå»è¯»å–å¯åŠ¨å‚æ•°å˜é‡å’Œ.propertiesé…ç½®åˆ°é…ç½®å¯¹è±¡ Method[] methods = config.getClass().getMethods(); for (Method method : methods) &#123; try &#123; // æ‹¿åˆ°æ–¹æ³•å String name = method.getName(); // é€‰æ‹©æ–¹æ³•æ˜¯ ã€public &amp;&amp; setter &amp;&amp; å”¯ä¸€å‚æ•°ä¸ºåŸºæœ¬ç±»å‹ã€‘ çš„æ–¹æ³• if (name.length() &gt; 3 &amp;&amp; name.startsWith(\"set\") &amp;&amp; Modifier.isPublic(method.getModifiers()) &amp;&amp; method.getParameterTypes().length == 1 &amp;&amp; isPrimitive(method.getParameterTypes()[0])) &#123; // è·å¾—å±æ€§å å¦‚ï¼š ApplicationConfig#setName(...) æ–¹æ³•ï¼Œå¯¹åº”çš„å±æ€§åä¸º name String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), \".\"); //----------- è¯»å–çš„è¦†ç›–ç­–ç•¥ï¼š JVM -D &gt; XML &gt; .properties ----------/ String value = null; //ã€å¯åŠ¨å‚æ•°å˜é‡ã€‘ä¼˜å…ˆä»å¸¦æœ‰ idå±æ€§çš„XxxConfigçš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ dubbo.application.demo-provider.name if (config.getId() != null &amp;&amp; config.getId().length() &gt; 0) &#123; // idå­—æ®µ String pn = prefix + config.getId() + \".\" + property; value = System.getProperty(pn); if (!StringUtils.isBlank(value)) &#123; logger.info(\"Use System Property \" + pn + \" to config dubbo\"); &#125; &#125; //ã€å¯åŠ¨å‚æ•°å˜é‡ã€‘è·å–ä¸åˆ°ï¼Œå†ä»ä¸å¸¦ idå±æ€§ çš„XxxConfigçš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼šdubbo.application.name if (value == null || value.length() == 0) &#123; // æ²¡æœ‰idå­—æ®µ String pn = prefix + property; value = System.getProperty(pn); if (!StringUtils.isBlank(value)) &#123; logger.info(\"Use System Property \" + pn + \" to config dubbo\"); &#125; &#125; // é…ç½®ä¼˜å…ˆçº§ä»¥åŠè¦†ç›–ï¼š å¯åŠ¨å‚æ•°å˜é‡ &gt; XMLé…ç½®[æ³¨è§£/javaé…ç½®] &gt; propertiesé…ç½® ã€‚å› æ­¤éœ€è¦ä½¿ç”¨getteråˆ¤æ–­XMLæ˜¯å¦å·²ç»é…ç½® if (value == null || value.length() == 0) &#123; Method getter; try &#123; getter = config.getClass().getMethod(\"get\" + name.substring(3)); &#125; catch (NoSuchMethodException e) &#123; try &#123; getter = config.getClass().getMethod(\"is\" + name.substring(3)); &#125; catch (NoSuchMethodException e2) &#123; getter = null; &#125; &#125; if (getter != null) &#123; // ä½¿ç”¨getter åˆ¤æ–­XMLæ˜¯å¦å·²ç»è®¾ç½®è¿‡ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®çš„è¯å°±ä».propertiesæ–‡ä»¶ä¸­è¯»å– if (getter.invoke(config) == null) &#123; // [propertiesé…ç½®] ä¼˜å…ˆä»å¸¦æœ‰ id å±æ€§çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼šdubbo.application.demo-provider.name if (config.getId() != null &amp;&amp; config.getId().length() &gt; 0) &#123; value = ConfigUtils.getProperty(prefix + config.getId() + \".\" + property); &#125; // [propertiesé…ç½®]è·å–ä¸åˆ°ï¼Œå†ä»ä¸å¸¦ id å±æ€§çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼šdubbo.application.name if (value == null || value.length() == 0) &#123; value = ConfigUtils.getProperty(prefix + property); &#125; // [propertiesé…ç½®]è·å–ä¸åˆ°ï¼Œè¿™é‡Œè¿›è¡Œè€ç‰ˆæœ¬å…¼å®¹ï¼Œä»ä¸å¸¦idå±æ€§çš„é…ç½®ä¸­è·å– if (value == null || value.length() == 0) &#123; String legacyKey = legacyProperties.get(prefix + property); if (legacyKey != null &amp;&amp; legacyKey.length() &gt; 0) &#123; value = convertLegacyValue(legacyKey, ConfigUtils.getProperty(legacyKey)); &#125; &#125; &#125; &#125; &#125; // è·å–åˆ°å€¼ï¼ˆç³»ç»Ÿå‚æ•°é…ç½®æˆ–è€….propertiesæ–‡ä»¶ä¸­çš„ï¼Œä¸åŒ…å«xmlé…ç½®ï¼Œxmlé…ç½®æœ‰å•ç‹¬çš„è®¾ç½®æ–¹æ³•ï¼‰ if (value != null &amp;&amp; value.length() &gt; 0) &#123; method.invoke(config, convertPrimitive(method.getParameterTypes()[0], value)); &#125; &#125; &#125; catch (Exception e) &#123; logger.error(e.getMessage(), e); &#125; &#125; &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; ä¸Šé¢çš„ä»£ç ä¸»è¦å°±æ˜¯ä¸ºå·²ç»å®ä¾‹åŒ–å¥½çš„é…ç½®æ‰¿è½½å¯¹è±¡è®¾ç½®å±æ€§å€¼ï¼Œä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š æ ¹æ®é…ç½®å¯¹è±¡è·å–å±æ€§é…ç½®çš„å‰ç¼€ï¼Œå¦‚ dubbo.application. éå†é…ç½®æ‰¿è½½å¯¹è±¡ä¸­çš„æ‰€æœ‰æ–¹æ³•æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„setteræ–¹æ³• æ ¹æ®é…ç½®è¦†ç›–ç­–ç•¥çš„ä¼˜å…ˆçº§ï¼Œè®¾ç½®é…ç½®æ‰¿è½½å¯¹è±¡çš„å±æ€§å€¼ é…ç½®å¯¹è±¡çš„å±æ€§åˆ°å‚æ•°é›†åˆå°†é…ç½®æ‰¿è½½å¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°å‚æ•°é›†åˆä¸­ï¼Œç”¨äºæ„å»ºDubbo URLï¼Œå¦‚åœ¨æœåŠ¡æš´éœ²å’Œå¼•ç”¨æ˜¯æ„å»ºç›¸å…³çš„URLã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111public abstract class AbstractConfig implements Serializable &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * å°†é…ç½®å¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°å‚æ•°é›†åˆ * * @param parameters * @param config */ protected static void appendParameters(Map&lt;String, String&gt; parameters, Object config) &#123; appendParameters(parameters, config, null); &#125; /** * å°†é…ç½®å¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°å‚æ•°é›†åˆï¼Œä¸»è¦é€»è¾‘ï¼š * &lt;p&gt; * 1 é€šè¿‡åå°„è·å–ç›®æ ‡å¯¹è±¡çš„getteræ–¹æ³•ï¼Œå¹¶è°ƒç”¨è¯¥æ–¹æ³•è·å–å±æ€§å€¼ï¼Œç„¶åå†é€šè¿‡getteræ–¹æ³•åè§£æå‡ºå±æ€§åï¼Œå¦‚ï¼šä»æ–¹æ³•ågetNameä¸­å¯è§£æå‡ºå±æ€§nameï¼Œå¦‚æœç”¨æˆ·ä¼ å…¥äº†å±æ€§åå‰ç¼€ï¼Œæ­¤æ—¶éœ€è¦å°†å±æ€§ååŠ å…¥å‰ç¼€å†…å®¹ã€‚ * 2 å°† å±æ€§å-å±æ€§å€¼ é”®å€¼å¯¹å­˜å…¥åˆ°mapä¸­å°±å¯ä»¥äº† * * @param parameters å‚æ•°é›†åˆï¼Œè¯¥é›†åˆä¼šç”¨äºURL * @param config é…ç½®å¯¹è±¡ * @param prefix å±æ€§å‰ç¼€ã€‚ç”¨äºé…ç½®é¡¹æ·»åŠ åˆ°å‚æ•°é›†åˆä¸­æ—¶çš„å‰ç¼€ */ @SuppressWarnings(\"unchecked\") protected static void appendParameters(Map&lt;String, String&gt; parameters, Object config, String prefix) &#123; if (config == null) &#123; return; &#125; // è·å¾—æ‰€æœ‰æ–¹æ³•çš„æ•°ç»„ï¼Œä¸ºä¸‹é¢é€šè¿‡åå°„è·å¾—é…ç½®é¡¹çš„å€¼åšå‡†å¤‡ Method[] methods = config.getClass().getMethods(); for (Method method : methods) &#123; try &#123; String name = method.getName(); // é€‰æ‹©æ–¹æ³•ä¸º è¿”å›å€¼ä¸ºåŸºæœ¬ç±»å‹ + publicçš„getter/isæ–¹æ³• ï¼ˆå’Œè§£æåˆ°é…ç½®ç±»çš„è¿‡æ»¤æ·»åŠ å‘¼åº”ï¼‰ if ((name.startsWith(\"get\") || name.startsWith(\"is\")) &amp;&amp; !\"getClass\".equals(name) &amp;&amp; Modifier.isPublic(method.getModifiers()) &amp;&amp; method.getParameterTypes().length == 0 &amp;&amp; isPrimitive(method.getReturnType())) &#123; // å°è¯•è·å–æ–¹æ³•ä¸Šçš„@Parameteræ³¨è§£ Parameter parameter = method.getAnnotation(Parameter.class); // æ–¹æ³•è¿”å›ç±»å‹æ˜¯Objectçš„æˆ–è€…æ–¹æ³•çš„@Parameter(excluded = true)çš„ï¼Œ ä¸ç»Ÿè®¡å¯¹åº”çš„å€¼åˆ°å‚æ•°é›†åˆ if (method.getReturnType() == Object.class || parameter != null &amp;&amp; parameter.excluded()) &#123; continue; &#125; // è·å¾—å±æ€§å int i = name.startsWith(\"get\") ? 3 : 2; String prop = StringUtils.camelToSplitName(name.substring(i, i + 1).toLowerCase() + name.substring(i + 1), \".\"); String key; // @Parameteræ³¨è§£æœ‰é…ç½®keyå±æ€§å°±å–å‡ºè¯¥å€¼ if (parameter != null &amp;&amp; parameter.key().length() &gt; 0) &#123; key = parameter.key(); &#125; else &#123; key = prop; &#125; // åˆ©ç”¨åå°„è·å¾—å±æ€§çš„å€¼ Object value = method.invoke(config); String str = String.valueOf(value).trim(); if (value != null &amp;&amp; str.length() &gt; 0) &#123; // æ˜¯å¦è½¬ç§»ï¼Œé»˜è®¤ä¸è½¬è¯‘ if (parameter != null &amp;&amp; parameter.escaped()) &#123; str = URL.encode(str); &#125; // @Parameteræ³¨è§£æœ‰é…ç½®appendå±æ€§ï¼Œå°±è¿›è¡Œæ‹¼æ¥ if (parameter != null &amp;&amp; parameter.append()) &#123; // 1. çœ‹å‚æ•°é›†åˆä¸­æ˜¯å¦æœ‰keyä¸ºï¼š default.keyçš„å€¼(é»˜è®¤å±æ€§å€¼),æœ‰å°±æ‹¼æ¥åˆ°å±æ€§å€¼å‰é¢ String pre = parameters.get(Constants.DEFAULT_KEY + \".\" + key); if (pre != null &amp;&amp; pre.length() &gt; 0) &#123; str = pre + \",\" + str; &#125; // 2. çœ‹å‚æ•°é›†åˆä¸­æ˜¯å¦æœ‰keyå¯¹åº”çš„å€¼ï¼Œæœ‰å°±æ‹¼æ¥åˆ°å±æ€§å€¼å‰é¢ pre = parameters.get(key); if (pre != null &amp;&amp; pre.length() &gt; 0) &#123; str = pre + \",\" + str; &#125; &#125; // å¦‚æœæŒ‡å®šäº†å±æ€§å‰ç¼€å°±æ‹¼æ¥ä¸Šå»ï¼Œå°±åœ¨å±æ€§åå‰é¢åŠ ä¸Šå‰ç¼€ if (prefix != null &amp;&amp; prefix.length() &gt; 0) &#123; key = prefix + \".\" + key; &#125; // æŠŠæœ€åå¤„ç†çš„å±æ€§å€¼åŠ å…¥å‚æ•°é›†åˆä¸­ parameters.put(key, str); // å½“é…ç½®å¯¹è±¡çš„å±æ€§getteræ–¹æ³•åŠ äº†@Parameter(required=true)æ—¶ï¼Œæ ¡éªŒé…ç½®é¡¹éç©º &#125; else if (parameter != null &amp;&amp; parameter.required()) &#123; throw new IllegalStateException(config.getClass().getSimpleName() + \".\" + key + \" == null\"); &#125; // å½“æ–¹æ³•ä¸ºpublic Map getParameters()&#123;...&#125;æ—¶ï¼Œå°±ä»¥æ­¤å°†Mapä¸­çš„key-valueåŠ å…¥åˆ°å‚æ•°é›†åˆ &#125; else if (\"getParameters\".equals(name) &amp;&amp; Modifier.isPublic(method.getModifiers()) &amp;&amp; method.getParameterTypes().length == 0 &amp;&amp; method.getReturnType() == Map.class) &#123; // é€šè¿‡ getParameters()æ–¹æ³•ï¼Œè·å–åŠ¨æ€è®¾ç½®çš„é…ç½®é¡¹ Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) method.invoke(config, new Object[0]); if (map != null &amp;&amp; map.size() &gt; 0) &#123; String pre = (prefix != null &amp;&amp; prefix.length() &gt; 0 ? prefix + \".\" : \"\"); for (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123; parameters.put(pre + entry.getKey().replace('-', '.'), entry.getValue()); &#125; &#125; &#125; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; ä¸Šé¢ä»£ç ä¸»è¦å°±æ˜¯å°†é…ç½®æ‰¿è½½å¯¹è±¡ä¸­çš„å±æ€§è®¾ç½®åˆ°å±æ€§é›†åˆMapä¸­ï¼Œç”¨äºæ„å»ºDubbo URLã€‚æ•´ä¸ªé€»è¾‘éœ€è¦æ³¨æ„ï¼Œé…ç½®æ‰¿è½½å¯¹è±¡çš„getteræ–¹æ³•ä¸Šæ ‡æ³¨çš„ @Parameter æ³¨è§£ï¼Œä»¥åŠé…ç½®æ‰¿è½½å¯¹è±¡çš„getParametersæ–¹æ³•ã€‚ æ·»åŠ äº‹ä»¶é€šçŸ¥å±æ€§12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public abstract class AbstractConfig implements Serializable &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; protected static void appendAttributes(Map&lt;Object, Object&gt; parameters, Object config) &#123; appendAttributes(parameters, config, null); &#125; /** * * @param parameters å‚æ•°é›†åˆ * @param config é…ç½®å¯¹è±¡ * @param prefix å±æ€§å‰ç¼€ã€‚ç”¨äºé…ç½®é¡¹æ·»åŠ åˆ°å‚æ•°é›†åˆä¸­æ—¶çš„å‰ç¼€ */ protected static void appendAttributes(Map&lt;Object, Object&gt; parameters, Object config, String prefix) &#123; if (config == null) &#123; return; &#125; Method[] methods = config.getClass().getMethods(); for (Method method : methods) &#123; try &#123; String name = method.getName(); // é€‰æ‹©æ–¹æ³•ä¸º è¿”å›å€¼ä¸ºåŸºæœ¬ç±»å‹ + publicçš„getter/isæ–¹æ³• ï¼ˆå’Œè§£æåˆ°é…ç½®ç±»çš„è¿‡æ»¤æ·»åŠ å‘¼åº”ï¼‰ if ((name.startsWith(\"get\") || name.startsWith(\"is\")) &amp;&amp; !\"getClass\".equals(name) &amp;&amp; Modifier.isPublic(method.getModifiers()) &amp;&amp; method.getParameterTypes().length == 0 &amp;&amp; isPrimitive(method.getReturnType())) &#123; // é€‰æ‹©å¸¦æœ‰@Parameter(attribute=true)çš„æ–¹æ³• Parameter parameter = method.getAnnotation(Parameter.class); if (parameter == null || !parameter.attribute()) &#123; continue; &#125; String key; parameter.key(); if (parameter.key().length() &gt; 0) &#123; key = parameter.key(); &#125; else &#123; int i = name.startsWith(\"get\") ? 3 : 2; key = name.substring(i, i + 1).toLowerCase() + name.substring(i + 1); &#125; // è·å¾—å±æ€§å€¼ï¼Œå­˜åœ¨åˆ™æ·»åŠ åˆ°å‚æ•°é›†åˆä¸­ Object value = method.invoke(config); if (value != null) &#123; if (prefix != null &amp;&amp; prefix.length() &gt; 0) &#123; key = prefix + \".\" + key; &#125; parameters.put(key, value); &#125; &#125; &#125; catch (Exception e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; &#125; &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; ä¸Šé¢ä»£ç ä¸»è¦ç”¨äºDubboçš„äº‹ä»¶é€šçŸ¥çš„ï¼Œå…·ä½“æ˜¯æ ‡æ³¨åœ¨MethodConfigé…ç½®æ‰¿è½½å¯¹è±¡çš„ getOnreturn(),getOnreturnMethod(),getOnthrow()â€¦æ–¹æ³•ä¸Šã€‚ AbstractInterfaceConfig æŠ½è±¡é…ç½®ç±»ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š 123AbstractConfig - AbstractMethodConfig - AbstractInterfaceConfig AbstractConfigæŠ½è±¡ç±»çš„æ ¸å¿ƒé€»è¾‘å·²ç»åˆ†æè¿‡ï¼ŒAbstractMethodConfigæŠ½è±¡ç±»ä¸­æ²¡æœ‰æ¯”è¾ƒé‡è¦çš„é€»è¾‘ï¼ŒåŸºæœ¬éƒ½æ˜¯ é…ç½®å±æ€§çš„è®¾ç½®/è·å–æ–¹æ³•ï¼Œå°±ä¸å†åˆ†æï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·çœ‹ä¸‹AbstractInterfaceConfigæŠ½è±¡ç±»çš„é€»è¾‘ã€‚ æ ¡éªŒæ³¨å†Œä¸­å¿ƒé…ç½®123456789101112131415161718192021222324252627282930313233343536public abstract class AbstractInterfaceConfig extends AbstractMethodConfig &#123;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;protected void checkRegistry() &#123; // for backward compatibility if (registries == null || registries.isEmpty()) &#123; String address = ConfigUtils.getProperty(\"dubbo.registry.address\"); if (address != null &amp;&amp; address.length() &gt; 0) &#123; registries = new ArrayList&lt;RegistryConfig&gt;(); String[] as = address.split(\"\\\\s*[|]+\\\\s*\"); for (String a : as) &#123; RegistryConfig registryConfig = new RegistryConfig(); registryConfig.setAddress(a); registries.add(registryConfig); &#125; &#125; &#125; if ((registries == null || registries.isEmpty())) &#123; throw new IllegalStateException((getClass().getSimpleName().startsWith(\"Reference\") ? \"No such any registry to refer service in consumer \" : \"No such any registry to export service in provider \") + NetUtils.getLocalHost() + \" use dubbo version \" + Version.getVersion() + \", Please add &lt;dubbo:registry address=\\\"...\\\" /&gt; to your spring config. If you want unregister, please set &lt;dubbo:service registry=\\\"N/A\\\" /&gt;\"); &#125; for (RegistryConfig registryConfig : registries) &#123; // è°ƒç”¨AbstractConfigä¸­çš„æ–¹æ³• appendProperties(registryConfig); &#125; &#125;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; æ ¡éªŒåº”ç”¨é…ç½®123456789101112131415161718192021222324252627282930313233public abstract class AbstractInterfaceConfig extends AbstractMethodConfig &#123;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; protected void checkApplication() &#123; // for backward compatibility if (application == null) &#123; String applicationName = ConfigUtils.getProperty(\"dubbo.application.name\"); if (applicationName != null &amp;&amp; applicationName.length() &gt; 0) &#123; application = new ApplicationConfig(); &#125; &#125; if (application == null) &#123; throw new IllegalStateException( \"No such application config! Please add &lt;dubbo:application name=\\\"...\\\" /&gt; to your spring config.\"); &#125; // è°ƒç”¨AbstractConfigä¸­çš„æ–¹æ³• appendProperties(application); String wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_KEY); if (wait != null &amp;&amp; wait.trim().length() &gt; 0) &#123; System.setProperty(Constants.SHUTDOWN_WAIT_KEY, wait.trim()); &#125; else &#123; wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY); if (wait != null &amp;&amp; wait.trim().length() &gt; 0) &#123; System.setProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY, wait.trim()); &#125; &#125; &#125;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; åŠ è½½æ³¨å†Œä¸­å¿ƒURLæ•°ç»„12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public abstract class AbstractInterfaceConfig extends AbstractMethodConfig &#123;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * åŠ è½½æ³¨å†Œä¸­å¿ƒURLæ•°ç»„ * * @param provider æ˜¯å¦æ˜¯æœåŠ¡æä¾›è€… * @return URLæ•°ç»„ */ protected List&lt;URL&gt; loadRegistries(boolean provider) &#123; // æ ¡éªŒRegistryConfig é…ç½®æ•°ç»„ï¼Œä¸å­˜åœ¨ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶ä¸”è¯¥æ–¹æ³•ä¼šåˆå§‹åŒ–RegistryConfigçš„é…ç½®å±æ€§ checkRegistry(); // åˆ›å»ºæ³¨å†Œä¸­å¿ƒURLæ•°ç»„ List&lt;URL&gt; registryList = new ArrayList&lt;URL&gt;(); if (registries != null &amp;&amp; !registries.isEmpty()) &#123; // éå†RegistryConfig æ•°ç»„ for (RegistryConfig config : registries) &#123; // è·å–æ³¨å†Œä¸­å¿ƒçš„åœ°å€ String address = config.getAddress(); // åœ°å€ä¸ºç©ºå°±ä½¿ç”¨ 0.0.0.0 ä»»æ„åœ°å€ if (address == null || address.length() == 0) &#123; address = Constants.ANYHOST_VALUE; &#125; // å¦‚æœé…ç½®äº†å¯åŠ¨å‚æ•°çš„æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œå®ƒçš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œå°±è¿›è¡Œè¦†ç›– String sysaddress = System.getProperty(\"dubbo.registry.address\"); if (sysaddress != null &amp;&amp; sysaddress.length() &gt; 0) &#123; address = sysaddress; &#125; // é€‰æ‹©æœ‰æ•ˆçš„æ³¨å†Œä¸­å¿ƒåœ°å€ if (address.length() &gt; 0 &amp;&amp; !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) &#123; // åˆ›å»ºå‚æ•°é›†åˆmap,ç”¨äºDubbo URLçš„æ„å»º Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(); // å°†åº”ç”¨é…ç½®å¯¹è±¡å’Œæ³¨å†Œä¸­å¿ƒé…ç½®å¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°å‚æ•°é›†åˆmapä¸­ appendParameters(map, application); /** * éœ€è¦æ³¨æ„çš„æ˜¯ï¼šRegistryConfig çš„ getAddressæ–¹æ³•ä¸Šä½¿ç”¨äº† @Parameter(excluded = true)æ³¨è§£ï¼Œå› æ­¤å®ƒçš„addresså±æ€§ä¸ä¼šåŠ å…¥åˆ°å‚æ•°é›†åˆmapä¸­ * @Parameter(excluded = true) * public String getAddress() &#123;return address;&#125; */ appendParameters(map, config); // æ·»åŠ  path,dubbo,timestamp,pid åˆ°å‚æ•°é›†åˆmapä¸­ map.put(\"path\", RegistryService.class.getName()); // è¿™é‡Œçš„pathè¦å’ŒæœåŠ¡æš´éœ²é€»è¾‘ä¸­çš„pathåŒºåˆ†ï¼Œæ³¨å†Œä¸­å¿ƒçš„URLä¸­çš„pathä¸ºRegistryServiceçš„å…¨è·¯å¾„å map.put(\"dubbo\", Version.getProtocolVersion()); map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis())); if (ConfigUtils.getPid() &gt; 0) &#123; map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid())); &#125; // å‚æ•°é›†åˆmapä¸­ä¸å­˜åœ¨ protocol å‚æ•°ã€ä»¥ä¸Šé…ç½®å¯¹è±¡çš„å±æ€§ä¸­æ²¡æœ‰æœ‰æ•ˆçš„åè®®protocolå‚æ•°ã€‘ï¼Œå°±é»˜è®¤ ä½¿ç”¨ dubbo ä½œä¸º åè®®protocolçš„å€¼ if (!map.containsKey(\"protocol\")) &#123; // ä¸éœ€è€ƒè™‘remoteæ‰©å±•å®ç°çš„æƒ…å†µ if (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension(\"remote\")) &#123; map.put(\"protocol\", \"remote\"); &#125; else &#123; map.put(\"protocol\", \"dubbo\"); &#125; &#125; // è§£æåœ°å€ï¼Œåˆ›å»ºDubbo URLæ•°ç»„ï¼Œæ³¨æ„addresså¯èƒ½åŒ…å«å¤šä¸ªæ³¨å†Œä¸­å¿ƒip, ã€æ•°ç»„å¤§å°å¯ä»¥ä¸ºä¸€ã€‘ List&lt;URL&gt; urls = UrlUtils.parseURLs(address, map); // å¾ªç¯ dubbo Register url for (URL url : urls) &#123; // è®¾ç½® registry=$&#123;protocol&#125;å‚æ•°,è®¾ç½®åˆ°æ³¨å†Œä¸­å¿ƒçš„ URLçš„å‚æ•°éƒ¨åˆ†çš„ä½ç½®ä¸Šï¼Œå¹¶ä¸”æ˜¯è¿½åŠ å¼çš„æ·»åŠ  url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol()); // é‡ç½® URLä¸­çš„ protocolå±æ€§ä¸º 'registry',å³å°†URLçš„åè®®å¤´è®¾ç½®ä¸º'registry' url = url.setProtocol(Constants.REGISTRY_PROTOCOL); /** * é€šè¿‡åˆ¤æ–­æ¡ä»¶ï¼Œå†³å®šæ˜¯å¦æ·»åŠ urlåˆ°registryListä¸­ï¼Œæ¡ä»¶å¦‚ä¸‹ï¼š * 1 å¦‚æœæ˜¯æœåŠ¡æä¾›è€…,æ˜¯å¦åªè®¢é˜…ä¸æ³¨å†Œï¼Œå¦‚æœæ˜¯å°±ä¸æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒURLæ•°ç»„ä¸­ * 2 å¦‚æœæ˜¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œæ˜¯å¦æ˜¯åªæ³¨å†Œä¸è®¢é˜…ï¼Œå¦‚æœæ˜¯å°±ä¸æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒURLæ•°ç»„ä¸­ * */ if ((provider &amp;&amp; url.getParameter(Constants.REGISTER_KEY, true)) || (!provider &amp;&amp; url.getParameter(Constants.SUBSCRIBE_KEY, true))) &#123; registryList.add(url); &#125; &#125; &#125; &#125; &#125; return registryList; &#125;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; åŠ è½½ç›‘æ§ä¸­å¿ƒURL12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394public abstract class AbstractInterfaceConfig extends AbstractMethodConfig &#123;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;/** * åŠ è½½ç›‘æ§ä¸­å¿ƒURL * * @param registryURL æ³¨å†Œä¸­å¿ƒURL * @return ç›‘æ§ä¸­å¿ƒURL */ protected URL loadMonitor(URL registryURL) &#123; // å¦‚æœç›‘æ§é…ç½®ä¸ºç©ºï¼Œå°±ä»å±æ€§é…ç½®ä¸­åŠ è½½é…ç½®åˆ°MonitorConfig if (monitor == null) &#123; // è·å–ç›‘æ§åœ°å€ String monitorAddress = ConfigUtils.getProperty(\"dubbo.monitor.address\"); // è·å–ç›‘æ§åè®® String monitorProtocol = ConfigUtils.getProperty(\"dubbo.monitor.protocol\"); // æ²¡æœ‰é…ç½®å°±ç›´æ¥è¿”å› if ((monitorAddress == null || monitorAddress.length() == 0) &amp;&amp; (monitorProtocol == null || monitorProtocol.length() == 0)) &#123; return null; &#125; // åˆ›å»ºMonitorConfig monitor = new MonitorConfig(); if (monitorAddress != null &amp;&amp; monitorAddress.length() &gt; 0) &#123; monitor.setAddress(monitorAddress); &#125; if (monitorProtocol != null &amp;&amp; monitorProtocol.length() &gt; 0) &#123; monitor.setProtocol(monitorProtocol); &#125; &#125; // ä¸ºMonitorConfigåŠ è½½é…ç½®ã€å¯åŠ¨å‚æ•°å˜é‡å’Œpropertiesé…ç½®åˆ°é…ç½®å¯¹è±¡ã€‘ appendProperties(monitor); // æ·»åŠ  interface,dubbo,timestamp,pid åˆ° map é›†åˆä¸­ Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(); map.put(Constants.INTERFACE_KEY, MonitorService.class.getName()); map.put(\"dubbo\", Version.getProtocolVersion()); map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis())); if (ConfigUtils.getPid() &gt; 0) &#123; map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid())); &#125; //set ip String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY); if (hostToRegistry == null || hostToRegistry.length() == 0) &#123; hostToRegistry = NetUtils.getLocalHost(); &#125; else if (isInvalidLocalHost(hostToRegistry)) &#123; throw new IllegalArgumentException(\"Specified invalid registry ip from property:\" + Constants.DUBBO_IP_TO_REGISTRY + \", value:\" + hostToRegistry); &#125; map.put(Constants.REGISTER_IP_KEY, hostToRegistry); appendParameters(map, monitor); appendParameters(map, application); // è·å¾—ç›‘æ§åœ°å€ String address = monitor.getAddress(); // å¦‚æœå¯åŠ¨å‚æ•°é…ç½®äº†ç›‘æ§ä¸­å¿ƒåœ°å€ï¼Œå°±è¿›è¡Œè¦†ç›–ï¼Œå¯åŠ¨å‚æ•°ä¼˜å…ˆçº§æœ€é«˜ String sysaddress = System.getProperty(\"dubbo.monitor.address\"); if (sysaddress != null &amp;&amp; sysaddress.length() &gt; 0) &#123; address = sysaddress; &#125; // ç›´è¿ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨åœ°å€ if (ConfigUtils.isNotEmpty(address)) &#123; // è‹¥ç›‘æ§åœ°å€ä¸å­˜åœ¨ protocol å‚æ•°ï¼Œé»˜è®¤ dubbo æ·»åŠ åˆ° map é›†åˆä¸­ if (!map.containsKey(Constants.PROTOCOL_KEY)) &#123; // logstatè¿™ä¸ªæ‹“å±•å®ç°å·²ç»ä¸å­˜åœ¨äº†,å¯ä»¥å¿½ç•¥ if (ExtensionLoader.getExtensionLoader(MonitorFactory.class).hasExtension(\"logstat\")) &#123; map.put(Constants.PROTOCOL_KEY, \"logstat\"); &#125; else &#123; map.put(Constants.PROTOCOL_KEY, \"dubbo\"); &#125; &#125; // è§£æåœ°å€ï¼Œåˆ›å»ºDubbo URL å¯¹è±¡ return UrlUtils.parseURL(address, map); /** * 1 å½“ protocol=registryæ—¶ï¼Œå¹¶ä¸”æ³¨å†Œä¸­å¿ƒURLéç©ºæ—¶ï¼Œä»æ³¨å†Œä¸­å¿ƒå‘ç°ç›‘æ§ä¸­å¿ƒåœ°å€ï¼Œä»¥æ³¨å†Œä¸­å¿ƒURLä¸ºåŸºç¡€ï¼Œåˆ›å»ºç›‘æ§ä¸­å¿ƒURL * 2 åŸºäºæ³¨å†Œä¸­å¿ƒåˆ›å»ºçš„ç›‘æ§ä¸­å¿ƒURLï¼š protocol = dubbo,parameters.protocol=registry,parameter.refer=map */ &#125; else if (Constants.REGISTRY_PROTOCOL.equals(monitor.getProtocol()) &amp;&amp; registryURL != null) &#123; return registryURL.setProtocol(\"dubbo\").addParameter(Constants.PROTOCOL_KEY, \"registry\").addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)); &#125; return null; &#125;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; æ ¡éªŒæ¥å£å’Œæ–¹æ³•åˆ—è¡¨123456789101112131415161718192021222324252627282930313233343536373839404142434445public abstract class AbstractInterfaceConfig extends AbstractMethodConfig &#123;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * æ ¡éªŒæ¥å£å’Œæ–¹æ³•ï¼š * 1 æ¥å£ç±»å¿…é¡»éç©ºå¹¶ä¸”å¿…é¡»æ˜¯æ¥å£ * 2 æ–¹æ³•åœ¨æ¥å£ä¸­å·²ç»å®šä¹‰ * * @param interfaceClass * @param methods */ protected void checkInterfaceAndMethods(Class&lt;?&gt; interfaceClass, List&lt;MethodConfig&gt; methods) &#123; // interface cannot be null if (interfaceClass == null) &#123; throw new IllegalStateException(\"interface not allow null!\"); &#125; // to verify interfaceClass is an interface if (!interfaceClass.isInterface()) &#123; throw new IllegalStateException(\"The interface class \" + interfaceClass + \" is not a interface!\"); &#125; // check if methods exist in the interface if (methods != null &amp;&amp; !methods.isEmpty()) &#123; for (MethodConfig methodBean : methods) &#123; String methodName = methodBean.getName(); if (methodName == null || methodName.length() == 0) &#123; throw new IllegalStateException(\"&lt;dubbo:method&gt; name attribute is required! Please check: &lt;dubbo:service interface=\\\"\" + interfaceClass.getName() + \"\\\" ... &gt;&lt;dubbo:method name=\\\"\\\" ... /&gt;&lt;/&lt;dubbo:reference&gt;\"); &#125; boolean hasMethod = false; for (java.lang.reflect.Method method : interfaceClass.getMethods()) &#123; if (method.getName().equals(methodName)) &#123; hasMethod = true; break; &#125; &#125; if (!hasMethod) &#123; throw new IllegalStateException(\"The interface \" + interfaceClass.getName() + \" not found method \" + methodName); &#125; &#125; &#125; &#125;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; æ ¡éªŒStubå’ŒMockç›¸å…³çš„é…ç½®1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071public abstract class AbstractInterfaceConfig extends AbstractMethodConfig &#123;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * æ ¡éªŒStubå’ŒMockç›¸å…³çš„é…ç½® * * @param interfaceClass */ protected void checkStubAndMock(Class&lt;?&gt; interfaceClass) &#123; if (ConfigUtils.isNotEmpty(local)) &#123; Class&lt;?&gt; localClass = ConfigUtils.isDefault(local) ? ReflectUtils.forName(interfaceClass.getName() + \"Local\") : ReflectUtils.forName(local); if (!interfaceClass.isAssignableFrom(localClass)) &#123; throw new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceClass.getName()); &#125; try &#123; ReflectUtils.findConstructor(localClass, interfaceClass); &#125; catch (NoSuchMethodException e) &#123; throw new IllegalStateException(\"No such constructor \\\"public \" + localClass.getSimpleName() + \"(\" + interfaceClass.getName() + \")\\\" in local implementation class \" + localClass.getName()); &#125; &#125; if (ConfigUtils.isNotEmpty(stub)) &#123; Class&lt;?&gt; localClass = ConfigUtils.isDefault(stub) ? ReflectUtils.forName(interfaceClass.getName() + \"Stub\") : ReflectUtils.forName(stub); if (!interfaceClass.isAssignableFrom(localClass)) &#123; throw new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceClass.getName()); &#125; try &#123; ReflectUtils.findConstructor(localClass, interfaceClass); &#125; catch (NoSuchMethodException e) &#123; throw new IllegalStateException(\"No such constructor \\\"public \" + localClass.getSimpleName() + \"(\" + interfaceClass.getName() + \")\\\" in local implementation class \" + localClass.getName()); &#125; &#125; // mock é…ç½®æ ¡éªŒ if (ConfigUtils.isNotEmpty(mock)) &#123; // å¦‚æœmockä»¥ 'return' å¼€å¤´ï¼Œåˆ™å»æ‰è¯¥å‰ç¼€ if (mock.startsWith(Constants.RETURN_PREFIX)) &#123; // è·å–return æŒ‡å®šçš„å†…å®¹ String value = mock.substring(Constants.RETURN_PREFIX.length()); try &#123; // è§£æreturnæŒ‡å®šçš„å†…å®¹ï¼Œå¹¶è½¬æ¢æˆå¯¹åº”çš„è¿”å›ç±»å‹ MockInvoker.parseMockValue(value); &#125; catch (Exception e) &#123; throw new IllegalStateException(\"Illegal mock json value in &lt;dubbo:service ... mock=\\\"\" + mock + \"\\\" /&gt;\"); &#125; // ä¸æ˜¯ä»¥ 'return' å¼€å¤´ &#125; else &#123; // è·å¾—Mockç±» Class&lt;?&gt; mockClass = ConfigUtils.isDefault(mock) ? ReflectUtils.forName(interfaceClass.getName() + \"Mock\") : ReflectUtils.forName(mock); // æ ¡éªŒæ˜¯å¦å®ç°æ¥å£ if (!interfaceClass.isAssignableFrom(mockClass)) &#123; throw new IllegalStateException(\"The mock implementation class \" + mockClass.getName() + \" not implement interface \" + interfaceClass.getName()); &#125; // æ ¡éªŒæ˜¯å¦æœ‰é»˜è®¤çš„æ„é€ æ–¹æ³• try &#123; mockClass.getConstructor(new Class&lt;?&gt;[0]); &#125; catch (NoSuchMethodException e) &#123; throw new IllegalStateException(\"No such empty constructor \\\"public \" + mockClass.getSimpleName() + \"()\\\" in mock implementation class \" + mockClass.getName()); &#125; &#125; &#125; &#125;// çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; ServiceConfig é…ç½®ç±»è¯¥ç±»æ˜¯ æœåŠ¡æš´éœ² çš„æ ¸å¿ƒç±»ï¼Œæˆ‘ä»¬åœ¨ Dubboç¤ºä¾‹ - APIé…ç½® ä¸­å·²ç»ä½¿ç”¨APIçš„æ–¹å¼åˆ›å»ºä¸€ä¸ªDubboåº”ç”¨ï¼Œæœ€åé€šè¿‡è°ƒç”¨ ServiceConfig#export()æ–¹æ³•è¿›è¡ŒæœåŠ¡çš„å¯¼å‡ºï¼ŒServiceConfig ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š 12345AbstractConfig - AbstractMethodConfig - AbstractInterfaceConfig - AbstractServiceConfig - ServiceConfig AbstractServiceConfig æŠ½è±¡ç±»ä¸­ä¹Ÿæ²¡æœ‰æ ¸å¿ƒçš„é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯é…ç½®å±æ€§çš„è®¾ç½®å’Œè·å–æ–¹æ³•ï¼Œå› æ­¤ä¹Ÿä¸å†åˆ†æã€‚ ServiceConfig#export()æ–¹æ³•ä¸»è¦åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š è¿›ä¸€æ­¥åˆå§‹åŒ–Dubboçš„é…ç½®æ‰¿è½½å¯¹è±¡ï¼Œå› ä¸ºæœ‰çš„é…ç½®å¯¹è±¡æˆ‘ä»¬å¯èƒ½å¹¶æ²¡æœ‰æ˜¾ç¤ºåˆ›å»ºæˆ–é…ç½®ã€‚ å¯¹é…ç½®å¯¹è±¡ä»¬è¿›è¡Œæ ¡éªŒæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æ–°å»ºï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚ ServiceConfigèšé›†äº†DubboæœåŠ¡çš„çš„æ‰€æœ‰é…ç½®å±æ€§ï¼Œä½¿ç”¨å®ƒçš„å±æ€§æ„å»ºDubbo URLå¯¹è±¡ è¿›è¡ŒæœåŠ¡æš´éœ² ServiceConfig å±æ€§1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public class ServiceConfig&lt;T&gt; extends AbstractServiceConfig &#123; /** * è‡ªé€‚åº” Protocolå®ç°å¯¹è±¡ */ private static final Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension(); /** * è‡ªé€‚åº” ProxyFactory å®ç°å¯¹è±¡ */ private static final ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory.class).getAdaptiveExtension(); /** * éšæœºç«¯å£é›†åˆ */ private static final Map&lt;String, Integer&gt; RANDOM_PORT_MAP = new HashMap&lt;String, Integer&gt;(); /** * å»¶è¿Ÿæš´éœ²çº¿ç¨‹æ±  */ private static final ScheduledExecutorService delayExportExecutor = Executors.newSingleThreadScheduledExecutor(new NamedThreadFactory(\"DubboServiceDelayExporter\", true)); private final List&lt;URL&gt; urls = new ArrayList&lt;URL&gt;(); /** * æœåŠ¡é…ç½®æš´éœ²çš„Exporter é›†åˆ */ private final List&lt;Exporter&lt;?&gt;&gt; exporters = new ArrayList&lt;Exporter&lt;?&gt;&gt;(); /** * æœåŠ¡æ¥å£å…¨è·¯å¾„å */ private String interfaceName; /** * éé…ç½®ï¼Œé€šè¿‡interfaceName é€šè¿‡åå°„è·å¾— */ private Class&lt;?&gt; interfaceClass; /** * æœåŠ¡æ¥å£çš„å®ç°å¯¹è±¡ */ private T ref; /** * æœåŠ¡å */ private String path; /** * æœåŠ¡æ–¹æ³•é…ç½®å¯¹è±¡é›†åˆ */ private List&lt;MethodConfig&gt; methods; /** * æœåŠ¡æä¾›è€…é»˜è®¤é…ç½®çš„é…ç½®å¯¹è±¡ */ private ProviderConfig provider; private transient volatile boolean exported; private transient volatile boolean unexported; /** * æ³›åŒ– */ private volatile String generic; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; è¿›ä¸€æ­¥åˆå§‹åŒ–é…ç½®æ‰¿è½½å¯¹è±¡123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182public class ServiceConfig&lt;T&gt; extends AbstractServiceConfig &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * æš´éœ²æœåŠ¡å…¥å£ï¼ŒåŠ jvmé” */ public synchronized void export() &#123; // å½“export æˆ–è€… delay æœªé…ç½®æ—¶ï¼Œä»ProviderConfigå¯¹è±¡è¯»å– if (provider != null) &#123; if (export == null) &#123; export = provider.getExport(); &#125; if (delay == null) &#123; delay = provider.getDelay(); &#125; &#125; // ä¸æš´éœ²æœåŠ¡(export = false),åˆ™ä¸è¿›è¡Œæš´éœ²æœåŠ¡é€»è¾‘ if (export != null &amp;&amp; !export) &#123; return; &#125; // å»¶è¿Ÿæš´éœ²çš„è¯ï¼Œå°±æ˜¯ä½¿ç”¨ä»»åŠ¡çº¿ç¨‹æ± ScheduledExecutorServiceå¤„ç† if (delay != null &amp;&amp; delay &gt; 0) &#123; delayExportExecutor.schedule(new Runnable() &#123; @Override public void run() &#123; doExport(); &#125; &#125;, delay, TimeUnit.MILLISECONDS); &#125; else &#123; doExport(); &#125; &#125; /** * æœåŠ¡æš´éœ²ï¼Œjvmé” */ protected synchronized void doExport() &#123; // æ£€æŸ¥æ˜¯å¦å¯ä»¥æš´éœ²ï¼Œè‹¥å¯ä»¥ï¼Œæ ‡è®°å·²ç»æš´éœ²ç„¶åæ‰§è¡ŒæœåŠ¡æš´éœ²é€»è¾‘ if (unexported) &#123; throw new IllegalStateException(\"Already unexported!\"); &#125; // å¦‚æœå·²ç»æš´éœ²äº†ç›´æ¥è¿”å› if (exported) &#123; return; &#125; // æ ‡è®°å·²ç»æš´éœ²è¿‡äº† exported = true; // æ ¡éªŒinterfaceName æ˜¯å¦åˆæ³•ï¼Œå³æ¥å£åéç©º if (interfaceName == null || interfaceName.length() == 0) &#123; throw new IllegalStateException(\"&lt;dubbo:service interface=\\\"\\\" /&gt; interface not allow null!\"); &#125; // æ ¡éªŒprovideræ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æ–°å»ºä¸€ä¸ªï¼Œå¹¶æ‹¼æ¥å±æ€§é…ç½®ï¼ˆç¯å¢ƒå˜é‡ + .propertiesæ–‡ä»¶ä¸­çš„ å±æ€§ï¼‰åˆ°ProviderConfigå¯¹è±¡ checkDefault(); // æ£€æµ‹applicationï¼Œmoduleç­‰æ ¸å¿ƒé…ç½®ç±»å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™å°è¯•ä»å…¶ä»–é…ç½®ç±»å¯¹è±¡ä¸­è·å–å¯¹åº”çš„å®ä¾‹ã€‚å³ï¼š ä»ProviderConfig å¯¹è±¡ä¸­ï¼Œè¯»å–application,module,registries,monitor,protocolsé…ç½®å¯¹è±¡ if (provider != null) &#123; if (application == null) &#123; application = provider.getApplication(); &#125; if (module == null) &#123; module = provider.getModule(); &#125; if (registries == null) &#123; registries = provider.getRegistries(); &#125; if (monitor == null) &#123; monitor = provider.getMonitor(); &#125; if (protocols == null) &#123; protocols = provider.getProtocols(); &#125; &#125; // ä»ModuleConfig å¯¹è±¡ä¸­ï¼Œè¯»å–registries,monitoré…ç½®å¯¹è±¡ if (module != null) &#123; if (registries == null) &#123; registries = module.getRegistries(); &#125; if (monitor == null) &#123; monitor = module.getMonitor(); &#125; &#125; // ä»ApplicationConfig å¯¹è±¡ä¸­ï¼Œè¯»å–registries,monitoré…ç½®å¯¹è±¡ if (application != null) &#123; if (registries == null) &#123; registries = application.getRegistries(); &#125; if (monitor == null) &#123; monitor = application.getMonitor(); &#125; &#125; // æ£€æµ‹refæ˜¯å¦æ³›åŒ–æ¥å£çš„å®ç° if (ref instanceof GenericService) &#123; // è®¾ç½® interfaceClass ä¸º GenericService.class interfaceClass = GenericService.class; if (StringUtils.isEmpty(generic)) &#123; // è®¾ç½® generic = \"true\" generic = Boolean.TRUE.toString(); &#125; // æ™®é€šæ¥å£çš„å®ç° &#125; else &#123; try &#123; // é€šè¿‡åå°„è·å–å¯¹åº”çš„æ¥å£çš„Class interfaceClass = Class.forName(interfaceName, true, Thread.currentThread() .getContextClassLoader()); &#125; catch (ClassNotFoundException e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; // æ£€éªŒæ¥å£å’Œæ–¹æ³• ï¼ˆæ¥å£éç©ºï¼Œæ–¹æ³•éƒ½åœ¨æ¥å£ä¸­å®šä¹‰ï¼‰ checkInterfaceAndMethods(interfaceClass, methods); // æ ¡éªŒå¼•ç”¨refæ˜¯å¦å®ç°äº†å½“å‰æ¥å£ checkRef(); // æ ‡è®°ä¸ºéæ³›åŒ–å®ç° generic = Boolean.FALSE.toString(); &#125; /** å¤„ç†æœåŠ¡æ¥å£å®¢æˆ·ç«¯æœ¬åœ°ä»£ç†,å³æœ¬åœ°å­˜æ ¹ï¼ˆlocal å±æ€§ -&gt; AbstractInterfaceConfig#setLocalï¼‰ã€‚ç›®å‰å·²ç»åºŸå¼ƒï¼Œæ­¤å¤„ä¸»è¦ç”¨äºå…¼å®¹ï¼Œä½¿ç”¨stubå±æ€§. todo æœåŠ¡ç«¯æ²¡æœ‰æ„ä¹‰ &#123;@link StubProxyFactoryWrapper#getInvoker(java.lang.Object, java.lang.Class, com.alibaba.dubbo.common.URL)&#125; */ if (local != null) &#123; // å¦‚æœlocalå±æ€§è®¾ç½®ä¸ºtureï¼Œè¡¨ç¤ºä½¿ç”¨ç¼ºçœä»£ç†ç±»åï¼Œå³ï¼šæ¥å£å + Local åç¼€ if (\"true\".equals(local)) &#123; local = interfaceName + \"Local\"; &#125; Class&lt;?&gt; localClass; try &#123; // è·å–æœ¬åœ°å­˜æ ¹ç±» localClass = ClassHelper.forNameWithThreadContextClassLoader(local); &#125; catch (ClassNotFoundException e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; // æ£€æµ‹æœ¬åœ°å­˜æ ¹ç±»æ˜¯å¦å¯èµ‹å€¼ç»™æ¥å£ç±»ï¼Œè‹¥ä¸å¯èµ‹å€¼åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæé†’ä½¿ç”¨è€…æœ¬åœ°å­˜æ ¹ç±»ç±»å‹ä¸åˆæ³• if (!interfaceClass.isAssignableFrom(localClass)) &#123; throw new IllegalStateException(\"The local implementation class \" + localClass.getName() + \" not implement interface \" + interfaceName); &#125; &#125; /** å¤„ç†æœåŠ¡æ¥å£å®¢æˆ·ç«¯æœ¬åœ°ä»£ç†(stub å±æ€§)ç›¸å…³ï¼Œå³æœ¬åœ°å­˜æ ¹ã€‚ç›®çš„ï¼šæƒ³åœ¨å®¢æˆ·ç«¯ã€æœåŠ¡æ¶ˆè´¹æ–¹ã€‘æ‰§è¡Œéœ€è¦çš„é€»è¾‘ï¼Œä¸å±€é™æœåŠ¡æä¾›çš„é€»è¾‘ã€‚æœ¬åœ°å­˜æ ¹ç±»ç¼–å†™æ–¹å¼æ˜¯å›ºå®šã€‚todo æœåŠ¡ç«¯æ²¡æœ‰æ„ä¹‰ &#123;@link StubProxyFactoryWrapper#getInvoker(java.lang.Object, java.lang.Class, com.alibaba.dubbo.common.URL)&#125;*/ if (stub != null) &#123; // å¦‚æœstubå±æ€§è®¾ç½®ä¸ºtureï¼Œè¡¨ç¤ºä½¿ç”¨ç¼ºçœä»£ç†ç±»åï¼Œå³ï¼šæ¥å£å + Stub åç¼€ if (\"true\".equals(stub)) &#123; stub = interfaceName + \"Stub\"; &#125; Class&lt;?&gt; stubClass; try &#123; // è·å–æœ¬åœ°å­˜æ ¹ç±» stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub); &#125; catch (ClassNotFoundException e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; // åˆ¤æ–­interfaceClass æ˜¯å¦æ˜¯ stubClass çš„æ¥å£ï¼Œå³ æ£€æµ‹æœ¬åœ°å­˜æ ¹ç±»æ˜¯å¦å¯èµ‹å€¼ç»™æ¥å£ç±»ï¼Œè‹¥ä¸å¯èµ‹å€¼åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œæé†’ä½¿ç”¨è€…æœ¬åœ°å­˜æ ¹ç±»ç±»å‹ä¸åˆæ³• if (!interfaceClass.isAssignableFrom(stubClass)) &#123; throw new IllegalStateException(\"The stub implementation class \" + stubClass.getName() + \" not implement interface \" + interfaceName); &#125; &#125; /* æ£€æµ‹å„ç§å¯¹è±¡æ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æ–°å»ºï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸*/ // æ ¡éªŒApplicationConfigé…ç½® checkApplication(); // æ ¡éªŒRegistryConfigé…ç½® checkRegistry(); // æ ¡éªŒProtocolConfigé…ç½®æ•°ç»„ checkProtocol(); // è¯»å–ç¯å¢ƒå˜é‡å’Œpropertiesé…ç½®åˆ°ServiceConfigå¯¹è±¡ï¼ˆè‡ªå·±ï¼‰ appendProperties(this); // æ ¡éªŒStubå’ŒMockç›¸å…³çš„é…ç½® checkStubAndMock(interfaceClass); // æœåŠ¡è·¯å¾„ï¼Œç¼ºçœæ˜¯æ¥å£å if (path == null || path.length() == 0) &#123; path = interfaceName; &#125; // æš´éœ²æœåŠ¡ doExportUrls(); ProviderModel providerModel = new ProviderModel(getUniqueServiceName(), this, ref); ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel); &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; å¤šåè®®å¤šæ³¨å†Œä¸­å¿ƒ123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196public class ServiceConfig&lt;T&gt; extends AbstractServiceConfig &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; /** * Dubbo å…è®¸æˆ‘ä»¬ä½¿ç”¨ä¸åŒçš„åè®®å¯¼å‡ºæœåŠ¡ï¼Œä¹Ÿå…è®¸æˆ‘ä»¬å‘å¤šä¸ªæ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ã€‚Dubbo åœ¨ doExportUrls æ–¹æ³•ä¸­å¯¹å¤šåè®®ï¼Œå¤šæ³¨å†Œä¸­å¿ƒè¿›è¡Œäº†æ”¯æŒ */ @SuppressWarnings(&#123;\"unchecked\", \"rawtypes\"&#125;) private void doExportUrls() &#123; // åŠ è½½æ³¨å†Œä¸­å¿ƒURL æ•°ç»„ ã€åè®®å·²ç»å¤„ç†è¿‡ï¼Œä¸å†æ˜¯é…ç½®çš„æ³¨å†Œä¸­å¿ƒåè®® å¦‚ï¼šzookeeper ,è€Œæ˜¯ç»Ÿä¸€æ›¿æ¢æˆäº†registryã€‘ List&lt;URL&gt; registryURLs = loadRegistries(true); // éå†åè®®é›†åˆï¼Œæ”¯æŒå¤šåè®®æš´éœ²ã€‚ for (ProtocolConfig protocolConfig : protocols) &#123; doExportUrlsFor1Protocol(protocolConfig, registryURLs); &#125; &#125; /** * ä½¿ç”¨ä¸åŒçš„åè®®ï¼Œé€ä¸ªå‘æ³¨å†Œä¸­å¿ƒåˆ†ç»„æš´éœ²æœåŠ¡ã€‚è¯¥æ–¹æ³•ä¸­åŒ…å«äº†æœ¬åœ°å’Œè¿œç¨‹ä¸¤ç§æš´éœ²æ–¹å¼ * * @param protocolConfig åè®®é…ç½®å¯¹è±¡ * @param registryURLs å¤„ç†è¿‡çš„æ³¨å†Œä¸­å¿ƒåˆ†ç»„é›†åˆã€å·²ç»æ·»åŠ äº†ApplicationConfigå’ŒRegistryConfigçš„å‚æ•°ã€‘ */ private void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs) &#123; // åè®®å String name = protocolConfig.getName(); // åè®®åä¸ºç©ºæ—¶ï¼Œç¼ºçœè®¾ç½®ä¸º dubbo if (name == null || name.length() == 0) &#123; name = \"dubbo\"; &#125; // åˆ›å»ºå‚æ•°é›†åˆmapï¼Œç”¨äºDubbo URL çš„æ„å»ºï¼ˆæœåŠ¡æä¾›è€…URLï¼‰ Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(); // å°†side,dubbo,timestamp,pidå‚æ•°ï¼Œæ·»åŠ åˆ°mapé›†åˆä¸­ map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE); map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion()); map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis())); if (ConfigUtils.getPid() &gt; 0) &#123; map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid())); &#125; // é€šè¿‡åå°„å°†å„ç§é…ç½®å¯¹è±¡ä¸­çš„å±æ€§æ·»åŠ åˆ°mapé›†åˆä¸­ï¼Œmapç”¨äºURLçš„æ„å»ºã€æ³¨æ„å±æ€§è¦†ç›–é—®é¢˜ã€‘ appendParameters(map, application); appendParameters(map, module); appendParameters(map, provider, Constants.DEFAULT_KEY); appendParameters(map, protocolConfig); appendParameters(map, this); // å°†MethodConfig å¯¹è±¡æ•°ç»„æ·»åŠ åˆ° map é›†åˆä¸­ã€‚å°±æ˜¯å°†æ¯ä¸ªMethodConfigå’Œå…¶å¯¹åº”çš„ArgumentConfigå¯¹è±¡æ•°ç»„æ·»åŠ åˆ°mapä¸­ã€å¤„ç†æ–¹æ³•ç›¸å…³çš„å±æ€§åˆ°mapã€‘ if (methods != null &amp;&amp; !methods.isEmpty()) &#123; // methods ä¸º MethodConfig é›†åˆï¼ŒMethodConfig ä¸­å­˜å‚¨äº† &lt;dubbo:method&gt; æ ‡ç­¾çš„é…ç½®ä¿¡æ¯ for (MethodConfig method : methods) &#123; /** * å°†MethodConfigå¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°mapé›†åˆä¸­ï¼Œå…¶ä¸­å±æ€§é”® = æ–¹æ³•å.å±æ€§åã€‚å¦‚ï¼š * &lt;dubbo:method name=\"sleep\" retries=\"2\"&gt;&lt;/dubbo:method&gt;å¯¹åº”çš„MethodConfigï¼Œå±æ€§åˆ°mapçš„æ ¼å¼ map=&#123;\"sleep.retries\":2,...&#125; */ appendParameters(map, method, method.getName()); // å½“é…ç½®äº† MehodConfig.retry = false æ—¶ï¼Œå¼ºåˆ¶ç¦ç”¨é‡è¯• String retryKey = method.getName() + \".retry\"; if (map.containsKey(retryKey)) &#123; String retryValue = map.remove(retryKey); // æ£€æµ‹ MethodConfig retry æ˜¯å¦ä¸º falseï¼Œè‹¥æ˜¯ï¼Œåˆ™è®¾ç½®é‡è¯•æ¬¡æ•°ä¸º0 if (\"false\".equals(retryValue)) &#123; map.put(method.getName() + \".retries\", \"0\"); &#125; &#125; // å°†MethodConfigä¸‹çš„ArgumentConfig å¯¹è±¡æ•°ç»„ï¼Œæ·»åŠ åˆ° map é›†åˆä¸­ List&lt;ArgumentConfig&gt; arguments = method.getArguments(); if (arguments != null &amp;&amp; !arguments.isEmpty()) &#123; for (ArgumentConfig argument : arguments) &#123; // æ£€æµ‹type å±æ€§æ˜¯å¦ä¸ºç©ºï¼Œ if (argument.getType() != null &amp;&amp; argument.getType().length() &gt; 0) &#123; // é€šè¿‡åå°„å–å‡ºæ¥å£çš„æ–¹æ³•åˆ—è¡¨ Method[] methods = interfaceClass.getMethods(); // éå†æ¥å£ä¸­çš„æ–¹æ³•åˆ—è¡¨ if (methods != null &amp;&amp; methods.length &gt; 0) &#123; for (int i = 0; i &lt; methods.length; i++) &#123; String methodName = methods[i].getName(); // æ¯”å¯¹æ–¹æ³•åï¼ŒæŸ¥æ‰¾ç›®æ ‡æ–¹æ³• if (methodName.equals(method.getName())) &#123; // é€šè¿‡åå°„å–å‡ºç›®æ ‡æ–¹æ³•çš„å‚æ•°ç±»å‹åˆ—è¡¨ Class&lt;?&gt;[] argtypes = methods[i].getParameterTypes(); // è‹¥æœé…ç½®indexé…ç½®é¡¹ï¼Œä¸”å€¼ä¸ä¸º-1 if (argument.getIndex() != -1) &#123; // ä»argtypesæ•°ç»„ä¸­è·å–ä¸‹æ ‡indexå¤„çš„å…ƒç´ argTypeï¼Œå¹¶æ£€æµ‹ArgumentConfigä¸­çš„typeå±æ€§ä¸argTypeåç§°æ˜¯å¦ä¸€è‡´ï¼Œä¸ä¸€è‡´åˆ™æŠ›å‡ºå¼‚å¸¸ if (argtypes[argument.getIndex()].getName().equals(argument.getType())) &#123; // å°†ArgumentConfigå¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°mapé›†åˆä¸­ï¼Œé”®å‰ç¼€=æ–¹æ³•å.indexï¼Œå¦‚ï¼šmap = &#123;\"sleep.2\":true&#125; appendParameters(map, argument, method.getName() + \".\" + argument.getIndex()); &#125; else &#123; throw new IllegalArgumentException(\"argument config error : the index attribute and type attribute not match :index :\" + argument.getIndex() + \", type:\" + argument.getType()); &#125; &#125; else &#123; // éå†å‚æ•°ç±»å‹æ•°ç»„argtypesï¼ŒæŸ¥æ‰¾argument.typeç±»å‹çš„å‚æ•° for (int j = 0; j &lt; argtypes.length; j++) &#123; Class&lt;?&gt; argclazz = argtypes[j]; // ä»å‚æ•°ç±»å‹åˆ—è¡¨ä¸­æŸ¥æ‰¾ç±»å‹åç§°ä¸ºargument.typeçš„å‚æ•° if (argclazz.getName().equals(argument.getType())) &#123; // å°†ArgumentConfigå¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°mapé›†åˆä¸­ appendParameters(map, argument, method.getName() + \".\" + j); if (argument.getIndex() != -1 &amp;&amp; argument.getIndex() != j) &#123; throw new IllegalArgumentException(\"argument config error : the index attribute and type attribute not match :index :\" + argument.getIndex() + \", type:\" + argument.getType()); &#125; &#125; &#125; &#125; &#125; &#125; &#125; // ç”¨æˆ·æœªé…ç½® type å±æ€§ï¼Œä½†é…ç½®äº†indexå±æ€§ï¼Œä¸”index != -1 &#125; else if (argument.getIndex() != -1) &#123; // æŒ‡å®šå•ä¸ªå‚æ•°çš„ä½ç½® // å°†ArgumentConfigå¯¹è±¡çš„å±æ€§æ·»åŠ åˆ°mapé›†åˆä¸­ appendParameters(map, argument, method.getName() + \".\" + argument.getIndex()); &#125; else &#123; throw new IllegalArgumentException(\"argument config must set index or type attribute.eg: &lt;dubbo:argument index='0' .../&gt; or &lt;dubbo:argument type=xxx .../&gt;\"); &#125; &#125; &#125; &#125; // end of methods for &#125; //------------------- æ£€æµ‹ generic æ˜¯å¦ ä¸º true ,å¹¶æ ¹æ®æ£€æµ‹ç»“æœå‘mapä¸­æ·»åŠ ä¸åŒçš„ä¿¡æ¯ ---/ // å°† generic,methods,revision åŠ å…¥åˆ°æ•°ç»„ if (ProtocolUtils.isGeneric(generic)) &#123; map.put(Constants.GENERIC_KEY, generic); map.put(Constants.METHODS_KEY, Constants.ANY_VALUE); &#125; else &#123; // å…ˆä»MAINFEST.MF ä¸­è·å–ç‰ˆæœ¬å·ï¼Œè‹¥è·å–ä¸åˆ°ï¼Œå†ä»jaråŒ…å‘½åä¸­å¯èƒ½å¸¦çš„ç‰ˆæœ¬å·ä½œä¸ºç»“æœï¼Œå¦‚ 2.6.5.RELEASEã€‚è‹¥éƒ½ä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤ç‰ˆæœ¬å·ã€æºç è¿è¡Œå¯èƒ½ä¼šæ²¡æœ‰ã€‘ String revision = Version.getVersion(interfaceClass, version); if (revision != null &amp;&amp; revision.length() &gt; 0) &#123; map.put(\"revision\", revision); // ä¿®è®¢å· &#125; // ä¸ºæ¥å£ç”ŸæˆåŒ…è£¹ç±» Wrapperï¼ŒWrapper ä¸­åŒ…å«äº†æ¥å£çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯”å¦‚æ¥å£æ–¹æ³•åæ•°ç»„ï¼Œå­—æ®µä¿¡æ¯ç­‰ã€Dubbo è‡ªå®šä¹‰åŠŸèƒ½ç±»ã€‘ String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames(); // æ·»åŠ æ–¹æ³•ååˆ° map ä¸­ï¼Œå¦‚æœåŒ…å«å¤šä¸ªæ–¹æ³•åï¼Œåˆ™ç”¨é€—å·éš”å¼€ï¼Œæ¯”å¦‚ï¼šmethod=a,b if (methods.length == 0) &#123; logger.warn(\"NO method found in service interface \" + interfaceClass.getName()); // æ²¡æœ‰æ–¹æ³•åå°±æ·»åŠ  method=* map.put(Constants.METHODS_KEY, Constants.ANY_VALUE); &#125; else &#123; // å°†é€—å·ä½œä¸ºåˆ†éš”ç¬¦è¿æ¥æ–¹æ³•åï¼Œå¹¶å°†è¿æ¥åçš„å­—ç¬¦ä¸²æ”¾å…¥ map ä¸­ map.put(Constants.METHODS_KEY, StringUtils.join(new HashSet&lt;String&gt;(Arrays.asList(methods)), \",\")); &#125; &#125; // token ã€ä½¿æš´éœ²å‡ºå»çš„æœåŠ¡æ›´å®‰å…¨ï¼Œä½¿ç”¨tokenåšå®‰å…¨æ ¡éªŒã€‘ if (!ConfigUtils.isEmpty(token)) &#123; if (ConfigUtils.isDefault(token)) &#123; map.put(Constants.TOKEN_KEY, UUID.randomUUID().toString()); &#125; else &#123; map.put(Constants.TOKEN_KEY, token); &#125; &#125; // åè®®ä¸ºinjvmæ—¶ï¼Œä¸æ³¨å†Œï¼Œä¸é€šçŸ¥ if (Constants.LOCAL_PROTOCOL.equals(protocolConfig.getName())) &#123; protocolConfig.setRegister(false); map.put(\"notify\", \"false\"); &#125; // è·å¾—åŸºç¡€è·¯å¾„ String contextPath = protocolConfig.getContextpath(); if ((contextPath == null || contextPath.length() == 0) &amp;&amp; provider != null) &#123; contextPath = provider.getContextpath(); &#125; // --------------------------- ä¸»æœºç»‘å®š----------------------------/ // è·å¾—æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡æä¾›è€…hostï¼Œå¹¶ä¸ºmapè®¾ç½®bind.ip , anyhost ä¸¤ä¸ªkey String host = this.findConfigedHosts(protocolConfig, registryURLs, map); // è·å–ç«¯å£ï¼Œå¹¶ä¸ºmapè®¾ç½®bing.port key Integer port = this.findConfigedPorts(protocolConfig, name, map); /** * åˆ›å»ºDubbo URLå¯¹è±¡ ã€æ³¨æ„è¿™é‡Œçš„ path çš„å€¼ã€‘ * 1 name: åè®®å * 2 host: ä¸»æœºå * 3 port: ç«¯å£ * 4 path: ã€åŸºç¡€è·¯å¾„ã€‘/path * 5 parameters: å±æ€§é›†åˆmap */ URL url = new URL(name, host, port, (contextPath == null || contextPath.length() == 0 ? \"\" : contextPath + \"/\") + path, map); // çœç•¥æœåŠ¡æš´éœ²ä»£ç  &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; ReferenceConfig é…ç½®ç±»è¯¥ç±»æ˜¯ æœåŠ¡å¼•ç”¨ çš„æ ¸å¿ƒç±»ï¼Œæˆ‘ä»¬åœ¨ Dubboç¤ºä¾‹ - APIé…ç½® ä¸­å·²ç»ä½¿ç”¨APIçš„æ–¹å¼åˆ›å»ºä¸€ä¸ªDubboåº”ç”¨ï¼Œæœ€åé€šè¿‡è°ƒç”¨ ReferenceConfig#get()æ–¹æ³•å¼•ç”¨æœåŠ¡ï¼ŒReferenceConfig ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š 12345AbstractConfig - AbstractMethodConfig - AbstractInterfaceConfig - AbstractReferenceConfig - ReferenceConfig AbstractReferenceConfig æŠ½è±¡ç±»ä¸­ä¹Ÿæ²¡æœ‰æ ¸å¿ƒçš„é€»è¾‘ï¼Œä¸»è¦å°±æ˜¯é…ç½®å±æ€§çš„è®¾ç½®å’Œè·å–æ–¹æ³•ï¼Œå› æ­¤ä¹Ÿä¸å†åˆ†æã€‚ ReferenceConfig#get()æ–¹æ³•ä¸»è¦åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š è¿›ä¸€æ­¥åˆå§‹åŒ–Dubboçš„é…ç½®æ‰¿è½½å¯¹è±¡ï¼Œå› ä¸ºæœ‰çš„é…ç½®å¯¹è±¡æˆ‘ä»¬å¯èƒ½å¹¶æ²¡æœ‰æ˜¾ç¤ºåˆ›å»ºæˆ–é…ç½®ã€‚ å¯¹é…ç½®å¯¹è±¡ä»¬è¿›è¡Œæ ¡éªŒæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™æ–°å»ºï¼Œæˆ–è€…æŠ›å‡ºå¼‚å¸¸ã€‚ ReferenceConfigèšé›†äº†DubboæœåŠ¡æ¶ˆè´¹è€…çš„çš„æ‰€æœ‰é…ç½®å±æ€§ï¼Œä½¿ç”¨å®ƒçš„å±æ€§æ„å»ºDubbo URLå¯¹è±¡ è¿›è¡ŒæœåŠ¡å¼•ç”¨ ReferenceConfig å±æ€§1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465public class ReferenceConfig&lt;T&gt; extends AbstractReferenceConfig &#123; /** * è‡ªé€‚åº” Protocol æ‹“å±•å®ç° */ private static final Protocol refprotocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension(); /** * è‡ªé€‚åº” Cluster æ‹“å±•å®ç° */ private static final Cluster cluster = ExtensionLoader.getExtensionLoader(Cluster.class).getAdaptiveExtension(); /** * è‡ªé€‚åº” ProxyFactory æ‹“å±•å®ç° */ private static final ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory.class).getAdaptiveExtension(); /** * æœåŠ¡å¼•ç”¨URLæ•°ç»„ */ private final List&lt;URL&gt; urls = new ArrayList&lt;URL&gt;(); /** * æœåŠ¡æ¥å£å */ private String interfaceName; /** * æœåŠ¡æ¥å£ */ private Class&lt;?&gt; interfaceClass; /** * è¿æ¥ç±»å‹ */ private String client; /** * ç›´è¿æœåŠ¡æä¾›è€…åœ°å€ * 1 å¯ä»¥æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æä¾›è€… * 2 å¯ä»¥é…ç½®å¤šä¸ªï¼Œä½¿ç”¨ \";\" åˆ†å‰² */ private String url; /** * æ–¹æ³•é…ç½®å¯¹è±¡é›†åˆ */ private List&lt;MethodConfig&gt; methods; /** * æ¶ˆè´¹è€…é»˜è®¤é…ç½®çš„é…ç½®å¯¹è±¡ */ private ConsumerConfig consumer; /** * åè®® */ private String protocol; /** * æœåŠ¡æ¥å£ä»£ç†å¯¹è±¡ */ private transient volatile T ref; /** * Invoker */ private transient volatile Invoker&lt;?&gt; invoker; private transient volatile boolean initialized; private transient volatile boolean destroyed; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; è¿›ä¸€æ­¥åˆå§‹åŒ–é…ç½®æ‰¿è½½å¯¹è±¡123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230public class ReferenceConfig&lt;T&gt; extends AbstractReferenceConfig &#123; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125; public synchronized T get() &#123; // å·²é”€æ¯ï¼Œä¸å¯è·å¾— if (destroyed) &#123; throw new IllegalStateException(\"Already destroyed!\"); &#125; // è‹¥æœªåˆå§‹åŒ–ï¼Œè°ƒç”¨init()æ–¹æ³•è¿›è¡Œåˆå§‹åŒ– if (ref == null) &#123; init(); &#125; // è¿”å›å¼•ç”¨æœåŠ¡ return ref; &#125; private void init() &#123; // å·²ç»åˆå§‹åŒ–è¿‡ï¼Œç›´æ¥è¿”å› if (initialized) &#123; return; &#125; initialized = true; // æ ¡éªŒæ¥å£åéç©º if (interfaceName == null || interfaceName.length() == 0) &#123; throw new IllegalStateException(\"&lt;dubbo:reference interface=\\\"\\\" /&gt; interface not allow null!\"); &#125; // æ‹¼æ¥å±æ€§é…ç½®ï¼ˆç¯å¢ƒå˜é‡ + .properties ä¸­çš„å±æ€§ï¼‰åˆ° ConsumerConfigå¯¹è±¡ checkDefault(); // æ‹¼æ¥å±æ€§é…ç½®ï¼ˆç¯å¢ƒå˜é‡ + .properties ä¸­çš„å±æ€§ï¼‰åˆ°ReferenceConfigï¼ˆè‡ªå·±ï¼‰ appendProperties(this); // è‹¥æœªè®¾ç½® generic å±æ€§ï¼Œå°±ä½¿ç”¨ConsumerConfigçš„genericå±æ€§ if (getGeneric() == null &amp;&amp; getConsumer() != null) &#123; setGeneric(getConsumer().getGeneric()); &#125; // æ˜¯å¦æ˜¯æ³›åŒ–æ¥å£çš„å®ç°ï¼Œå¦‚æœæ˜¯æ³›åŒ–æ¥å£å®ç°çš„è¯ï¼Œå°±ç›´æ¥è®¾ç½®å½“å‰æ¥å£ä¸º GenericService.class if (ProtocolUtils.isGeneric(getGeneric())) &#123; interfaceClass = GenericService.class; // æ™®é€šæ¥å£çš„å®ç° &#125; else &#123; try &#123; // æ ¹æ®æ¥å£åï¼Œè·å¾—å¯¹åº”çš„æ¥å£ç±» interfaceClass = Class.forName(interfaceName, true, Thread.currentThread().getContextClassLoader()); &#125; catch (ClassNotFoundException e) &#123; throw new IllegalStateException(e.getMessage(), e); &#125; // æ ¡éªŒæ¥å£å’Œæ–¹æ³• checkInterfaceAndMethods(interfaceClass, methods); &#125; // ç›´è¿æä¾›è€…ï¼Œç¬¬ä¸€ä¼˜å…ˆçº§ï¼Œé€šè¿‡ -D å‚æ•°ï¼ˆç³»ç»Ÿå˜é‡ï¼‰æŒ‡å®š ï¼Œä¾‹å¦‚ java -Dcom.alibaba.xxx.XxxService=dubbo://localhost:20890 String resolve = System.getProperty(interfaceName); String resolveFile = null; // ç›´è¿æä¾›è€…ç¬¬äºŒä¼˜å…ˆçº§ï¼Œé€šè¿‡æ–‡ä»¶æ˜ å°„ï¼Œä¾‹å¦‚ com.alibaba.xxx.XxxService=dubbo://localhost:20890 if (resolve == null || resolve.length() == 0) &#123; // ä»ç³»ç»Ÿå±æ€§ä¸­è·å–è§£ææ–‡ä»¶è·¯å¾„ resolveFile = System.getProperty(\"dubbo.resolve.file\"); if (resolveFile == null || resolveFile.length() == 0) &#123; // é»˜è®¤å…ˆåŠ è½½ $&#123;user.home&#125;/dubbo-resolve.properties æ–‡ä»¶ï¼Œæ— éœ€é…ç½®ï¼Œè‡ªåŠ¨åŠ è½½ File userResolveFile = new File(new File(System.getProperty(\"user.home\")), \"dubbo-resolve.properties\"); if (userResolveFile.exists()) &#123; // è·å–æ–‡ä»¶ç»å¯¹è·¯å¾„ resolveFile = userResolveFile.getAbsolutePath(); &#125; &#125; // å­˜åœ¨resolveFile,åˆ™è¿›è¡Œæ–‡ä»¶è¯»å–åŠ è½½ if (resolveFile != null &amp;&amp; resolveFile.length() &gt; 0) &#123; Properties properties = new Properties(); FileInputStream fis = null; try &#123; fis = new FileInputStream(new File(resolveFile)); // ä»æ–‡ä»¶ä¸­åŠ è½½é…ç½® properties.load(fis); &#125; catch (IOException e) &#123; throw new IllegalStateException(\"Unload \" + resolveFile + \", cause: \" + e.getMessage(), e); &#125; finally &#123; try &#123; if (null != fis) &#123; fis.close(); &#125; &#125; catch (IOException e) &#123; logger.warn(e.getMessage(), e); &#125; &#125; // æ ¹æ®æœåŠ¡å…¨è·¯å¾„åè·å–å¯¹åº”çš„ ç›´è¿æä¾›è€…çš„url resolve = properties.getProperty(interfaceName); &#125; &#125; // è®¾ç½®ç›´è¿æä¾›è€…çš„ url if (resolve != null &amp;&amp; resolve.length() &gt; 0) &#123; url = resolve; if (logger.isWarnEnabled()) &#123; if (resolveFile != null) &#123; logger.warn(\"Using default dubbo resolve file \" + resolveFile + \" replace \" + interfaceName + \"\" + resolve + \" to p2p invoke remote service.\"); &#125; else &#123; logger.warn(\"Using -D\" + interfaceName + \"=\" + resolve + \" to p2p invoke remote service.\"); &#125; &#125; &#125; // ä¸é€šè¿‡ç³»ç»Ÿå±æ€§æŒ‡å®šï¼Œå°±ä½¿ç”¨é…ç½®çš„ç›´è¿ï¼ˆåœ¨é…ç½®çš„å‰æä¸‹ï¼‰ï¼Œå¦‚ï¼š&lt;dubbo:reference id=\"xxxService\" interface=\"com.alibaba.xxx.XxxService\" url=\"dubbo://localhost:20890\" /&gt; // å°è¯•ä»ConsumerConfig å¯¹è±¡ä¸­ï¼Œè¯»å– application,module,registries,monitor é…ç½®å¯¹è±¡ if (consumer != null) &#123; if (application == null) &#123; application = consumer.getApplication(); &#125; if (module == null) &#123; module = consumer.getModule(); &#125; if (registries == null) &#123; registries = consumer.getRegistries(); &#125; if (monitor == null) &#123; monitor = consumer.getMonitor(); &#125; &#125; // ä»ModuleConfig å¯¹è±¡ä¸­ï¼Œè¯»å–registries,monitoré…ç½®å¯¹è±¡ if (module != null) &#123; if (registries == null) &#123; registries = module.getRegistries(); &#125; if (monitor == null) &#123; monitor = module.getMonitor(); &#125; &#125; // ä»ApplicationConfigå¯¹è±¡ä¸­ï¼Œè¯»å–registries,monitoré…ç½®å¯¹è±¡ if (application != null) &#123; if (registries == null) &#123; registries = application.getRegistries(); &#125; if (monitor == null) &#123; monitor = application.getMonitor(); &#125; &#125; // æ ¡éªŒApplicationConfigé…ç½® checkApplication(); // æ ¡éªŒ Stubå’Œ Mock ç›¸å…³çš„é…ç½® checkStubAndMock(interfaceClass); // åˆ›å»ºå‚æ•°é›†åˆmapï¼Œç”¨äºä¸‹é¢åˆ›å»ºDubbo URL Map&lt;String, String&gt; map = new HashMap&lt;String, String&gt;(); // ç¬¦åˆæ¡ä»¶çš„æ–¹æ³•å¯¹è±¡çš„å±æ€§ï¼Œä¸»è¦ç”¨æ¥Dubboäº‹ä»¶é€šçŸ¥ Map&lt;Object, Object&gt; attributes = new HashMap&lt;Object, Object&gt;(); // å°† sideï¼Œdubbo,timestamp,pidå‚æ•°ï¼Œæ·»åŠ åˆ°mapé›†åˆä¸­ map.put(Constants.SIDE_KEY, Constants.CONSUMER_SIDE); map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion()); map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis())); if (ConfigUtils.getPid() &gt; 0) &#123; map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid())); &#125; // éæ³›åŒ–æœåŠ¡ï¼Œè®¾ç½®revision,methods,interfaceåŠ å…¥åˆ°mapé›†åˆä¸­ if (!isGeneric()) &#123; String revision = Version.getVersion(interfaceClass, version); if (revision != null &amp;&amp; revision.length() &gt; 0) &#123; map.put(\"revision\", revision); &#125; // è·å–æ¥å£æ–¹æ³•åˆ—è¡¨ï¼Œå¹¶æ·»åŠ åˆ°mapä¸­ String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames(); if (methods.length == 0) &#123; logger.warn(\"NO method found in service interface \" + interfaceClass.getName()); map.put(\"methods\", Constants.ANY_VALUE); &#125; else &#123; map.put(\"methods\", StringUtils.join(new HashSet&lt;String&gt;(Arrays.asList(methods)), \",\")); &#125; &#125; map.put(Constants.INTERFACE_KEY, interfaceName); // å°†å„ç§é…ç½®å¯¹è±¡ä¸­çš„å±æ€§ï¼Œæ·»åŠ åˆ° map é›†åˆä¸­ appendParameters(map, application); appendParameters(map, module); appendParameters(map, consumer, Constants.DEFAULT_KEY); appendParameters(map, this); // è·å¾—æœåŠ¡é”®ï¼Œä½œä¸ºå‰ç¼€ æ ¼å¼ï¼šgroup/interface:version String prefix = StringUtils.getServiceKey(map); // å°†MethodConfig å¯¹è±¡æ•°ç»„ä¸­æ¯ä¸ªMethodConfigä¸­çš„å±æ€§æ·»åŠ åˆ°mapä¸­ if (methods != null &amp;&amp; !methods.isEmpty()) &#123; // éå† MethodConfig åˆ—è¡¨ for (MethodConfig method : methods) &#123; appendParameters(map, method, method.getName()); // å½“é…ç½®äº† MethodConfig.retry=false æ—¶ï¼Œå¼ºåˆ¶ç¦ç”¨é‡è¯• String retryKey = method.getName() + \".retry\"; if (map.containsKey(retryKey)) &#123; String retryValue = map.remove(retryKey); if (\"false\".equals(retryValue)) &#123; // æ·»åŠ é‡è¯•æ¬¡æ•°é…ç½® methodName.retries map.put(method.getName() + \".retries\", \"0\"); &#125; &#125; // å°†å¸¦æœ‰@Parameter(attribute=true)é…ç½®å¯¹è±¡çš„å±æ€§ï¼Œæ·»åŠ åˆ°å‚æ•°é›†åˆä¸­ appendAttributes(attributes, method, prefix + \".\" + method.getName()); // æ£€æŸ¥å±æ€§é›†åˆä¸­çš„äº‹ä»¶é€šçŸ¥æ–¹æ³•æ˜¯å¦æ­£ç¡®ï¼Œè‹¥æ­£ç¡®ï¼Œè¿›è¡Œè½¬æ¢ checkAndConvertImplicitConfig(method, map, attributes); &#125; &#125; // ä»¥ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆDUBBO_IP_TO_REGISTRYï¼‰çš„å€¼ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ipåœ°å€,æ²¡æœ‰è®¾ç½®å†å–ä¸»æœºåœ°å€ String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY); if (hostToRegistry == null || hostToRegistry.length() == 0) &#123; hostToRegistry = NetUtils.getLocalHost(); &#125; else if (isInvalidLocalHost(hostToRegistry)) &#123; throw new IllegalArgumentException(\"Specified invalid registry ip from property:\" + Constants.DUBBO_IP_TO_REGISTRY + \", value:\" + hostToRegistry); &#125; map.put(Constants.REGISTER_IP_KEY, hostToRegistry); // æŠŠattributesé›†åˆæ·»åŠ åˆ°StaticContextè¿›è¡Œç¼“å­˜ï¼Œä¸ºäº†ä»¥åçš„äº‹ä»¶é€šçŸ¥ StaticContext.getSystemContext().putAll(attributes); try&#123; System.out.println(\" ref = createProxy(map); is begin.....\"); Thread.sleep(5000); &#125;catch (Exception ex)&#123; &#125; // çœç•¥æœåŠ¡å¼•ç”¨ä»£ç  &#125; // çœç•¥å…¶å®ƒä»£ç  $&#123;&#125;&#125; å…¶å®ƒé…ç½®ç±»å‰é¢åªæ˜¯é’ˆå¯¹Dubboçš„æ ¸å¿ƒé…ç½®ç±»è¿›è¡Œäº†åˆ†æï¼Œè¿˜å¾ˆå¤šå…¶å®ƒçš„é…ç½®ç±»å¹¶æ²¡æœ‰åˆ†æåˆ°(ServiceBeanå’ŒReferenceBeanå±äºæ•´åˆSpringçš„é…ç½®ç±»ï¼Œæˆ‘ä»¬åœ¨XMLé…ç½®ä¸­åˆ†æ)ï¼Œä¸è¿‡æ²¡æœ‰åˆ†æåˆ°çš„é…ç½®ç±»ä¸­å‡ ä¹éƒ½æ²¡æœ‰å¤æ‚çš„é€»è¾‘ï¼Œå¤§å¤šæ˜¯å°è£…äº†é…ç½®å±æ€§çš„è®¾ç½®å’Œè·å–æ“ä½œã€‚æ¯ä¸ªé…ç½®ç±»ä¸­å°è£…çš„é…ç½®å±æ€§éƒ½æœ‰æ‰€ä¸åŒï¼Œé‚£äº›æŠ½è±¡çš„é…ç½®ç±»å°è£…çš„éƒ½æ˜¯å¯ä¾›ä¸åŒå­ç±»å¤ç”¨çš„å±æ€§å’Œæ–¹æ³•ï¼Œæ¯ä¸ªé…ç½®ç±»å¯ä»¥è®¾ç½®é‚£äº›å±æ€§æˆ‘ä»¬å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå®˜ç½‘ç»™å‡ºçš„æ˜¯XMLé…ç½®å½¢å¼ï¼Œä¸è¿‡æŒ‰ç…§å¯¹åº”çš„è§„åˆ™è½¬æ¢å°±å¯ä»¥ç›¸é€šäº†ã€‚ æ€»ç»“Dubboçš„é…ç½®ç›¸å¯¹æ¯”è¾ƒæ¯ç‡¥ï¼Œåˆšå¼€å§‹çœ‹çš„æ—¶å€™å¯èƒ½æœ‰ç‚¹è’™åœˆï¼Œç¬”è€…ä¹Ÿæ˜¯ç¡¬ç€å¤´çš®çœ‹äº†å¥½ä¹…ï¼Œçœ‹å®Œåä¹Ÿä¸æ˜¯å¾ˆç†è§£ï¼Œä½†æ˜¯æŠŠæ•´ä¸ªæµç¨‹çœ‹å®Œåå†å›æ¥çœ‹ä½“ä¼šå°±æ›´æ·±äº†ã€‚XMLé…ç½®å’Œæ³¨è§£é…ç½®ä¹Ÿæ˜¯åŸºäºAPIé…ç½®å’Œå±æ€§é…ç½®çš„ï¼ŒåŒºåˆ«æ˜¯XMLé…ç½®å’Œæ³¨è§£é…ç½®è¦è§£å†³å’ŒSpringèåˆé—®é¢˜ï¼Œæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥çš„æ–‡ç« ä¸­å†è¯¦ç»†åˆ†æã€‚å˜¿å’»ï¼Œæ•´ç¯‡æ–‡ç« éƒ½åœ¨è´´ä»£ç ï¼","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"Dubboæºç åˆ†æ - åŠ¨æ€ç¼–è¯‘","slug":"rpc/DubboåŠ¨æ€ç¼–è¯‘","date":"2020-03-21T16:00:00.000Z","updated":"2020-09-03T03:12:53.630Z","comments":false,"path":"posts/68ac5094/","link":"","permalink":"https://gentryhuang.com/posts/68ac5094/","excerpt":"","text":"æ¦‚è¿°åœ¨Dubboè‡ªé€‚åº”æ‰©å±•ä¸­ï¼Œæˆ‘ä»¬å·²ç»å¾—åˆ°äº†è‡ªé€‚åº”æ‰©å±•ç±»çš„å­—ç¬¦ä¸²ï¼Œéœ€è¦é€šè¿‡ç¼–è¯‘æ‰èƒ½å¾—åˆ°çœŸæ­£çš„Classï¼Œæœ¬ç¯‡æ–‡ç« å°±æ¥ä»‹ç»å°†ç±»çš„å­—ç¬¦ä¸²ç¼–è¯‘æˆç±»çš„è¿‡ç¨‹ã€‚ åŠ¨æ€ç¼–è¯‘ dubbo çš„åŠ¨æ€ç¼–è¯‘çš„æ•´ä½“ç»“æ„å¦‚ä¸Šå›¾æ‰€ç¤ºã€‚dubboä¸­çš„CompileråŸºäºdubbo spiæœºåˆ¶è¿›è¡ŒåŠ è½½ï¼Œç›®å‰æ”¯æŒjdkå’Œjavassistä¸¤ç§å®ç°ï¼š 12&lt;dubbo:application compiler=\"jdk\" /&gt;&lt;dubbo:application compiler=\"javassist\" /&gt; æ•´ä½“äº†è§£äº†dubboçš„åŠ¨æ€ç¼–è¯‘åï¼Œæˆ‘ä»¬æ¥ç€ä¸Šä¸€ç¯‡æ–‡ç« ç»§ç»­åˆ†æï¼ŒdubboåŠ¨æ€ç¼–è¯‘å…¥å£çš„ä»£ç å¦‚ä¸‹ï¼š 12345678910private Class&lt;?&gt; createAdaptiveExtensionClass() &#123; // ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•å®ç°çš„ä»£ç å­—ç¬¦ä¸² String code = createAdaptiveExtensionClassCode(); // è·å–ç±»åŠ è½½å™¨ ClassLoader classLoader = findClassLoader(); // è·å–Compilerè‡ªé€‚åº”æ‰©å±•å¯¹è±¡ com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension(); // åŠ¨æ€ç¼–è¯‘ï¼Œç”ŸæˆClass return compiler.compile(code, classLoader);&#125; è¯¥æ–¹æ³•åœ¨ç¼–è¯‘é˜¶æ®µéœ€è¦å…ˆè·å–è‡ªé€‚åº”ç¼–è¯‘å¯¹è±¡ï¼Œç„¶åè°ƒç”¨è¯¥å¯¹è±¡çš„compileæ–¹æ³•è¿›è¡Œä»£ç çš„ç¼–è¯‘ã€‚å…¶å®è¿™é‡Œå¹¶ä¸æ˜¯ç›´æ¥ä½¿ç”¨è‡ªé€‚åº”å¯¹è±¡è¿›è¡Œä»£ç ç¼–è¯‘ï¼Œè€Œæ˜¯å°†å…·ä½“çš„ç¼–è¯‘ä»»åŠ¡äº¤ç»™å­ç±»æ¥å®Œæˆï¼Œå³JdkCompilerå­ç±»å’ŒJavassistCompilerå­ç±»ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹dubbo åŠ¨æ€ç¼–è¯‘çš„æˆå‘˜åŠå®ƒä»¬çš„ç”¨é€”ã€‚ Compiler æ‰©å±•æ¥å£12345678910111213141516/** * Compiler. (SPI, Singleton, ThreadSafe) * ä½¿ç”¨Dubbo SPIæœºåˆ¶ï¼Œé»˜è®¤æ‹“å±•åä¸ºjavassist */@SPI(\"javassist\")public interface Compiler &#123; /** * ç¼–è¯‘Java ä»£ç  * * @param code Javaä»£ç å­—ç¬¦ä¸² * @param classLoader ç±»åŠ è½½å™¨ * @return Compiled class ç¼–è¯‘åçš„ç±» */ Class&lt;?&gt; compile(String code, ClassLoader classLoader);&#125; AdaptiveCompiler å›ºå®šè‡ªé€‚åº”æ‰©å±•ç±»12345678910111213141516171819202122232425262728293031323334353637383940/** * AdaptiveCompiler. (SPI, Singleton, ThreadSafe) * å®ç°Compileræ¥å£ï¼Œå¸¦æœ‰@Adaptiveæ³¨è§£ï¼Œæ˜¯å›ºå®šçš„è‡ªé€‚åº”å®ç°ç±» */@Adaptivepublic class AdaptiveCompiler implements Compiler &#123; /** * é»˜è®¤ç¼–è¾‘å™¨çš„æ‹“å±•å */ private static volatile String DEFAULT_COMPILER; /** * é™æ€æ–¹æ³•ï¼Œè®¾ç½®é»˜è®¤ç¼–è¾‘å™¨çš„æ‹“å±•åã€‚è¯¥æ–¹æ³•è¢« &#123;@link com.alibaba.dubbo.config.ApplicationConfig#setCompiler(java.lang.String)&#125;æ–¹æ³•è°ƒç”¨. * åœ¨&lt;dubbo:application compiler=\"\"/&gt; é…ç½® å¯è§¦å‘è¯¥æ–¹æ³• * * @param compiler */ public static void setDefaultCompiler(String compiler) &#123; DEFAULT_COMPILER = compiler; &#125; @Override public Class&lt;?&gt; compile(String code, ClassLoader classLoader) &#123; Compiler compiler; // è·å¾—Compilerçš„ExtensionLoaderå¯¹è±¡ ExtensionLoader&lt;Compiler&gt; loader = ExtensionLoader.getExtensionLoader(Compiler.class); // å£°æ˜ name å˜é‡ String name = DEFAULT_COMPILER; // ä½¿ç”¨è®¾ç½®çš„æ‹“å±•åï¼Œè·å¾—Compileræ‹“å±•å¯¹è±¡ if (name != null &amp;&amp; name.length() &gt; 0) &#123; compiler = loader.getExtension(name); // è·å¾—é»˜è®¤çš„Compileræ‹“å±•å¯¹è±¡ &#125; else &#123; compiler = loader.getDefaultExtension(); &#125; // ä½¿ç”¨çœŸæ­£çš„Compilerå¯¹è±¡ï¼ŒåŠ¨æ€ç¼–è¯‘ä»£ç  return compiler.compile(code, classLoader); &#125;&#125; è¯¥ç±»ä½¿ç”¨äº†@Adaptiveæ³¨è§£ï¼Œè¯´æ˜AdaptiveCompilerä¼šå›ºå®šä¸ºé»˜è®¤å®ç°ï¼Œé€šè¿‡ä»£ç çš„é€»è¾‘ä¸éš¾å‘ç°ï¼Œè¯¥ç±»ä¸»è¦ç”¨æ¥ç®¡ç†å…¶å®ƒçš„Compiler,æ¯æ¬¡è°ƒç”¨compileræ–¹æ³•æ—¶ä¼šå°è¯•æ ¹æ®æ‰©å±•åè·å–Compilerçš„æ‰©å±•å¯¹è±¡ï¼Œé»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨JavassistCompileræ‰©å±•å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ç¼–è¯‘å¯¹è±¡è¿›è¡ŒåŠ¨æ€ç¼–è¯‘ä»£ç ä¸²ã€‚ AbstractCompiler æŠ½è±¡ç¼–è¯‘ç±»1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public abstract class AbstractCompiler implements Compiler &#123; /** * åŒ…åçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ³¨æ„åŒ¹é…ç»„ */ private static final Pattern PACKAGE_PATTERN = Pattern.compile(\"package\\\\s+([$_a-zA-Z][$_a-zA-Z0-9\\\\.]*);\"); /** * ç±»åçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ³¨æ„åŒ¹é…ç»„ */ private static final Pattern CLASS_PATTERN = Pattern.compile(\"class\\\\s+([$_a-zA-Z][$_a-zA-Z0-9]*)\\\\s+\"); @Override public Class&lt;?&gt; compile(String code, ClassLoader classLoader) &#123; // è·å¾—åŒ…å code = code.trim(); Matcher matcher = PACKAGE_PATTERN.matcher(code); String pkg; if (matcher.find()) &#123; pkg = matcher.group(1); &#125; else &#123; pkg = \"\"; &#125; // è·å¾—ç±»å matcher = CLASS_PATTERN.matcher(code); String cls; if (matcher.find()) &#123; cls = matcher.group(1); &#125; else &#123; throw new IllegalArgumentException(\"No such class name in \" + code); &#125; // è·å¾—å®Œæ•´ç±»åï¼š åŒ…å.ç±»å String className = pkg != null &amp;&amp; pkg.length() &gt; 0 ? pkg + \".\" + cls : cls; try &#123; // ä½¿ç”¨ç±»åŠ è½½å™¨å°è¯•åŠ è½½ç±»ï¼Œå¦‚æœåŠ è½½æˆåŠŸï¼Œè¯´æ˜å·²ç»å­˜åœ¨ï¼ˆå¯èƒ½ç¼–è¯‘è¿‡äº†ï¼‰ return Class.forName(className, true, ClassHelper.getCallerClassLoader(getClass())); // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå¯èƒ½ç±»ä¸å­˜åœ¨ï¼Œè¯´æ˜å¯èƒ½æœªç¼–è¯‘è¿‡ï¼Œå°±è¿›è¡Œç¼–è¯‘ &#125; catch (ClassNotFoundException e) &#123; // ä»£ç æ ¼å¼éªŒè¯ if (!code.endsWith(\"&#125;\")) &#123; throw new IllegalStateException(\"The java code not endsWith \\\"&#125;\\\", code: \\n\" + code + \"\\n\"); &#125; try &#123; // ä½¿ç”¨å…·ä½“çš„ç¼–è¯‘å™¨è¿›è¡Œä»£ç ç¼–è¯‘ï¼Œç”±å­ç±»å®ç° return doCompile(className, code); &#125; catch (RuntimeException t) &#123; throw t; &#125; catch (Throwable t) &#123; throw new IllegalStateException(\"Failed to compile class, cause: \" + t.getMessage() + \", class: \" + className + \", code: \\n\" + code + \"\\n, stack: \" + ClassUtils.toString(t)); &#125; &#125; &#125; /** * ç¼–è¯‘ä»£ç  * * @param name ç±»å * @param source ä»£ç ä¸² * @return ç¼–è¯‘åçš„ç±» * @throws Throwable å¼‚å¸¸ */ protected abstract Class&lt;?&gt; doCompile(String name, String source) throws Throwable;&#125; è¯¥æŠ½è±¡ç±»ä¸»è¦åšä¸¤ä»¶äº‹æƒ…ï¼Œå…ˆè·å–è¦ç¼–è¯‘çš„å­—ç¬¦ä¸²ä¸­çš„ç±»çš„å…¨è·¯å¾„åï¼Œæ ¹æ®ç±»åå°è¯•åŠ è½½å¯¹åº”çš„ç±»ï¼Œå¦‚æœåŠ è½½æˆåŠŸè¯´æ˜å·²ç»ç¼–è¯‘è¿‡äº†ï¼Œå°±ç›´æ¥è¿”å›å³å¯ï¼Œé˜²æ­¢é‡å¤ç¼–è¯‘ã€‚å¦‚æœåŠ è½½å¤±è´¥ï¼Œé‚£ä¹ˆå°±éœ€è¦è¿›è¡Œç¼–è¯‘å¤„ç†ã€‚æ¥ä¸‹æ¥å°†ç¼–è¯‘çš„ä»»åŠ¡äº¤ç»™å…·ä½“çš„å­ç±»æ¥å®Œæˆã€‚ JavassistCompiler ç¼–è¯‘å™¨åœ¨ä»‹ç»JavassistCompilerç¼–è¯‘å™¨å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆç®€å•äº†è§£ä¸‹Javassistï¼Œè¿™æ ·å°±èƒ½å¾ˆå¥½ç†è§£JavassistCompilerçš„é€»è¾‘äº†ã€‚Javassistæ˜¯ç”¨æ¥å¤„ç†javaå­—èŠ‚ç çš„ç±»åº“ï¼Œå¯ä»¥è¿›è¡Œåˆ†æã€ç¼–è¾‘å’Œåˆ›å»ºJavaå­—èŠ‚ç ï¼Œå®ƒæä¾›äº†ä¸°å¯Œçš„APIï¼Œå¯ä»¥ä½¿å¼€å‘äººå‘˜å¾ˆæ–¹ä¾¿æ“ä½œå­—èŠ‚ç ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“å¤„ç†Javaå­—èŠ‚ç çš„å·¥å…·å¾ˆå¤šï¼Œå¦‚cglibï¼Œasmç­‰ï¼Œä¸ºä»€ä¹ˆé€‰æ‹©Javassistå‘¢ï¼Ÿå› ä¸ºJavassistç®€å•ä¸”å¿«é€Ÿï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨Javaç¼–ç çš„æ–¹å¼è€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤å°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„ï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹javassistçš„å‡ ä¸ªAPIï¼Œdubboå°±æ˜¯ä½¿ç”¨javassistçš„APIæ¥åŠ¨æ€ç”Ÿæˆç±»çš„ã€‚ è¯»å–Class 1234567891011121314// è·å–é»˜è®¤çš„ClassPoolï¼ˆæœç´¢ç±»è·¯å¾„åªæ˜¯JVMçš„åŒè·¯å¾„ä¸‹çš„classï¼‰ï¼Œæ˜¯ä¸€ä¸ªJavassistçš„ç±»æ± ClassPool pool = ClassPool.getDefault();//ä»classpathä¸­æŸ¥è¯¢ç±»XxxCtClass cc = pool.get(\"Xxx\");//è®¾ç½®Xxxçš„çˆ¶ç±»Yyycc.setSuperclass(pool.get(\"Yyy\"));// è½¬ä¸ºå­—èŠ‚æ•°ç»„ï¼Œè¿›è¡ŒCtClassçš„å†»ç»“byte[] b=cc.toBytecode();// ç”Ÿæˆclass ç±»ï¼Œé»˜è®¤åŠ è½½åˆ°å½“å‰çº¿ç¨‹çš„ClassLoaderä¸­ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©è¾“å‡ºçš„ClassLoaderã€‚Class clazz=cc.toClass();// ä¿®æ”¹è¯»å–çš„Classçš„nameï¼Œè¿™æ ·ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Classï¼Œæ—§çš„ä¸ä¼šåˆ é™¤cc.setName(\"XxxTemp\");// å…¶å®ƒapi... åˆ›å»ºClass 12345678910111213ClassPool pool = ClassPool.getDefault();// åˆ›å»ºä¸€ä¸ªXxxç±»CtClass cc = pool.makeClass(\"Xxx\");//æ–°å¢æ–¹æ³•CtMethod m = CtNewMethod.make(\"public void test()&#123;System.out.print(hello world)&#125;\",cc);cc.addMethod(m);//æ–°å¢FieldCtField f = new CtField(CtClass.intType, \"a\", point);cc.addField(f);//å¼•å…¥åŒ…pool.importPackage(\"package\");// å…¶å®ƒapi... æœç´¢è·¯å¾„ 12345678910ClassPool pool = ClassPool.getDefault();//é»˜è®¤åŠ è½½æ–¹å¼å¦‚pool.insertClassPath(new ClassClassPath(this.getClass()));//ä»æ–‡ä»¶åŠ è½½classpathpool.insertClassPath(\"filepath\")//ä»URLä¸­åŠ è½½pool.insertClassPath(new URLClassPath(\"xxx\"));//è¿½åŠ  LoaderClassPathpool.appendClassPath(new LoaderClassPath(ClassHelper.getCallerClassLoader(getClass()))); å…·ä½“æ“ä½œç¤ºä¾‹123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899public class JavassistCompilerDemo &#123; public static void main(String[] args) throws Exception &#123; // åˆ›å»º createStudentClass(); // è¯»å– readStudentClass(); &#125; /** * åˆ›å»ºå­—èŠ‚ç ä¿¡æ¯ * * @throws Exception */ private static void createStudentClass() throws Exception &#123; // åˆ›å»ºClassPool ClassPool pool = ClassPool.getDefault(); // åˆ›å»º com.alibaba.dubbo.test.Student ç±» CtClass ctClass = pool.makeClass(\"com.alibaba.dubbo.test.Student\"); // åˆ›å»ºå±æ€§(é€šç”¨å½¢å¼) CtField nameField = CtField.make(\"private String name;\", ctClass); ctClass.addField(nameField); // APIå½¢å¼åˆ›å»ºå±æ€§ CtField ageField = new CtField(pool.getCtClass(\"int\"), \"age\", ctClass); ageField.setModifiers(Modifier.PRIVATE); ctClass.addField(ageField); // åˆ›å»ºæ–¹æ³• ï¼ˆé€šç”¨æ–¹å¼ï¼‰ CtMethod setName = CtMethod.make(\"public void setName(String name)&#123;this.name = name;&#125;\", ctClass); CtMethod getName = CtMethod.make(\"public String getName()&#123;return name;&#125;\", ctClass); ctClass.addMethod(setName); ctClass.addMethod(getName); // apiå½¢å¼åˆ›å»ºæ–¹æ³• ctClass.addMethod(CtNewMethod.getter(\"getAge\", ageField)); ctClass.addMethod(CtNewMethod.setter(\"setAge\", ageField)); //åˆ›å»ºæ— å‚æ„é€ æ–¹æ³• CtConstructor ctConstructor = new CtConstructor(null, ctClass); ctConstructor.setBody(\"&#123;&#125;\"); ctClass.addConstructor(ctConstructor); // åˆ›å»ºæœ‰å‚æ„é€ æ–¹æ³• CtConstructor constructor = new CtConstructor(new CtClass[]&#123;CtClass.intType, pool.get(\"java.lang.String\")&#125;, ctClass); constructor.setBody(\"&#123;this.age=age;this.name=name;&#125;\"); ctClass.addConstructor(constructor); // apiåˆ›å»ºæ™®é€šæ–¹æ³• CtMethod ctMethod = new CtMethod(CtClass.voidType, \"sayHello\", new CtClass[]&#123;&#125;, ctClass); ctMethod.setModifiers(Modifier.PUBLIC); ctMethod.setBody(new StringBuilder(\"&#123;\\n System.out.println(\\\"hello world!\\\"); \\n&#125;\").toString()); ctClass.addMethod(ctMethod); // ç”Ÿæˆclass ç±» Class&lt;?&gt; clazz = ctClass.toClass(); // åå°„åˆ›å»ºå¯¹è±¡ Object obj = clazz.newInstance(); //æ–¹æ³•è°ƒç”¨ obj.getClass().getMethod(\"sayHello\", new Class[]&#123;&#125;).invoke(obj); // è·å–ctClassçš„å­—èŠ‚ç  byte[] codeByteArray = ctClass.toBytecode(); // å°†å­—èŠ‚ç å†™å…¥åˆ°classæ–‡ä»¶ä¸­ FileOutputStream fos = new FileOutputStream(new File(\"/opt/test/Student.class\")); fos.write(codeByteArray); fos.close(); &#125; /** * è®¿é—®å·²å­˜åœ¨çš„å­—èŠ‚ç ä¿¡æ¯ * * @throws Exception */ private static void readStudentClass() throws Exception &#123; // åˆ›å»ºClassPool ClassPool pool = ClassPool.getDefault(); CtClass ctClass = pool.get(\"com.alibaba.dubbo.test.Student\"); //å¾—åˆ°å­—èŠ‚ç  byte[] bytes = ctClass.toBytecode(); System.out.println(Arrays.toString(bytes)); //è·å–ç±»å System.out.println(ctClass.getName()); //è·å–æ¥å£ System.out.println(Arrays.toString(ctClass.getInterfaces())); //è·å–æ–¹æ³•åˆ—è¡¨ System.out.println(Arrays.toString(ctClass.getMethods())); &#125;&#125; è¿è¡Œä¸Šé¢çš„ä»£ç ä¼šåœ¨æœ¬åœ°/opt/testæ–‡ä»¶ç›®å½•ä¸‹ç”Ÿæˆäº†ä¸€ä¸ªStudent.classæ–‡ä»¶ï¼Œæˆ‘ä»¬é€šè¿‡ javap å‘½ä»¤è¿›è¡Œåç¼–è¯‘çš„ç»“æœå¦‚ä¸‹ï¼š1234567891011$ javap Student.class Compiled from \"Student.java\"public class com.alibaba.dubbo.test.Student &#123; public void setName(java.lang.String); public java.lang.String getName(); public int getAge(); public void setAge(int); public com.alibaba.dubbo.test.Student(); public com.alibaba.dubbo.test.Student(int, java.lang.String); public void sayHello();&#125; å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œé€šè¿‡JavassistæŠŠä¸€ä¸ªå®Œæ•´çš„classå­—ç¬¦ä¸²ç¼–è¯‘æˆä¸ºä¸€ä¸ªClassï¼Œæœ‰äº†è¿™ä¸ªæ¡ˆä¾‹çš„é“ºå«æˆ‘ä»¬å°±å¾ˆå®¹æ˜“ç†è§£JavassistCompilerçš„åŸç†äº†ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹å®ƒçš„é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140/** * JavassistCompiler. (SPI, Singleton, ThreadSafe) * åŸºäº Javassist å®ç°çš„ Compiler */public class JavassistCompiler extends AbstractCompiler &#123; /** * åŒ¹é…import */ private static final Pattern IMPORT_PATTERN = Pattern.compile(\"import\\\\s+([\\\\w\\\\.\\\\*]+);\\n\"); /** * åŒ¹é… extents */ private static final Pattern EXTENDS_PATTERN = Pattern.compile(\"\\\\s+extends\\\\s+([\\\\w\\\\.]+)[^\\\\&#123;]*\\\\&#123;\\n\"); /** * åŒ¹é… implements */ private static final Pattern IMPLEMENTS_PATTERN = Pattern.compile(\"\\\\s+implements\\\\s+([\\\\w\\\\.]+)\\\\s*\\\\&#123;\\n\"); /** * æ­£åˆ™åŒ¹é…æ–¹æ³•/å±æ€§ */ private static final Pattern METHODS_PATTERN = Pattern.compile(\"\\n(private|public|protected)\\\\s+\"); /** * æ­£åˆ™åŒ¹é…å˜é‡ */ private static final Pattern FIELD_PATTERN = Pattern.compile(\"[^\\n]+=[^\\n]+;\"); @Override public Class&lt;?&gt; doCompile(String name, String source) throws Throwable &#123; // è·å¾—ç±»å int i = name.lastIndexOf('.'); String className = i &lt; 0 ? name : name.substring(i + 1); // åˆ›å»ºClassPollå¯¹è±¡ ClassPool pool = new ClassPool(true); // è®¾ç½®ç±»æœç´¢è·¯å¾„ pool.appendClassPath(new LoaderClassPath(ClassHelper.getCallerClassLoader(getClass()))); // åŒ¹é…import Matcher matcher = IMPORT_PATTERN.matcher(source); // å¼•å…¥åŒ…å List&lt;String&gt; importPackages = new ArrayList&lt;String&gt;(); // å¼•å…¥ç±»å Map&lt;String, String&gt; fullNames = new HashMap&lt;String, String&gt;(); // åŒ¹é…importï¼Œå¯¼å…¥ä¾èµ–åŒ… while (matcher.find()) &#123; String pkg = matcher.group(1); // å¯¼å…¥æ•´ä¸ªåŒ…ä¸‹çš„ç±»/æ¥å£ if (pkg.endsWith(\".*\")) &#123; String pkgName = pkg.substring(0, pkg.length() - 2); pool.importPackage(pkgName); importPackages.add(pkgName); // å¯¼å…¥æŒ‡å®šç±»/æ¥å£ &#125; else &#123; int pi = pkg.lastIndexOf('.'); if (pi &gt; 0) &#123; String pkgName = pkg.substring(0, pi); pool.importPackage(pkgName); importPackages.add(pkgName); fullNames.put(pkg.substring(pi + 1), pkg); &#125; &#125; &#125; String[] packages = importPackages.toArray(new String[0]); // åŒ¹é…extends matcher = EXTENDS_PATTERN.matcher(source); CtClass cls; if (matcher.find()) &#123; String extend = matcher.group(1).trim(); String extendClass; // å†…åµŒçš„ç±»ï¼Œå¦‚ï¼š extends A.B if (extend.contains(\".\")) &#123; extendClass = extend; // æŒ‡å®šå¼•ç”¨çš„ç±» &#125; else if (fullNames.containsKey(extend)) &#123; extendClass = fullNames.get(extend); // å¼•ç”¨æ•´ä¸ªåŒ…ä¸‹çš„ç±» &#125; else &#123; extendClass = ClassUtils.forName(packages, extend).getName(); &#125; // åˆ›å»º CtClass å¯¹è±¡ cls = pool.makeClass(name, pool.get(extendClass)); &#125; else &#123; // åˆ›å»º CtClass å¯¹è±¡ cls = pool.makeClass(name); &#125; // åŒ¹é… implements matcher = IMPLEMENTS_PATTERN.matcher(source); if (matcher.find()) &#123; String[] ifaces = matcher.group(1).trim().split(\"\\\\,\"); for (String iface : ifaces) &#123; iface = iface.trim(); String ifaceClass; // å†…åµŒçš„æ¥å£ï¼Œä¾‹å¦‚ï¼šextends A.B if (iface.contains(\".\")) &#123; ifaceClass = iface; // æŒ‡å®šå¼•ç”¨çš„æ¥å£ &#125; else if (fullNames.containsKey(iface)) &#123; ifaceClass = fullNames.get(iface); // å¼•ç”¨æ•´ä¸ªåŒ…ä¸‹çš„æ¥å£ &#125; else &#123; ifaceClass = ClassUtils.forName(packages, iface).getName(); &#125; // æ·»åŠ æ¥å£ cls.addInterface(pool.get(ifaceClass)); &#125; &#125; // è·å¾—ç±»ä¸­çš„å†…å®¹ï¼Œå³ &#123; &#125; å†…çš„å†…å®¹ String body = source.substring(source.indexOf(\"&#123;\") + 1, source.length() - 1); // åŒ¹é… æ–¹æ³•ã€å±æ€§ String[] methods = METHODS_PATTERN.split(body); for (String method : methods) &#123; method = method.trim(); if (method.length() &gt; 0) &#123; // æ„é€ æ–¹æ³• if (method.startsWith(className)) &#123; cls.addConstructor(CtNewConstructor.make(\"public \" + method, cls)); // å˜é‡ &#125; else if (FIELD_PATTERN.matcher(method).matches()) &#123; cls.addField(CtField.make(\"private \" + method, cls)); // æ–¹æ³• &#125; else &#123; cls.addMethod(CtNewMethod.make(\"public \" + method, cls)); &#125; &#125; &#125; // ç”Ÿæˆç±» return cls.toClass(ClassHelper.getCallerClassLoader(getClass()), JavassistCompiler.class.getProtectionDomain()); &#125;&#125; æ•´ä¸ªé€»è¾‘ä¸‹æ¥å°±æ˜¯æŒ‰ç…§ç¼–å†™ä¸€ä¸ªç±»çš„æ­¥éª¤å¯¹è‡ªé€‚åº”ç±»çš„å­—ç¬¦ä¸²è¿›è¡Œæ­£åˆ™åŒ¹é…æ‹†è§£ï¼Œä¸æ–­é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸åŒéƒ¨åˆ†çš„ä»£ç ï¼Œç„¶åè°ƒç”¨Javassistçš„APIç”Ÿæˆä»£è¡¨ä¸åŒéƒ¨åˆ†çš„å¯¹è±¡ï¼Œæœ€ç»ˆç»„è£…æˆä¸€ä¸ªå®Œæ•´çš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œè¿˜æ˜¯æŒºç®€å•çš„ã€‚è¿™é‡Œè¯´ä¸€å¥ï¼Œdubboä¸­å¾ˆå¤šåœ°æ–¹éƒ½æ˜¯é‡‡ç”¨æ‹¼æ¥å­—ç¬¦ä¸²æ–¹å¼ï¼Œç„¶åé€šè¿‡å…·ä½“çš„æŠ€æœ¯æ‰‹æ®µç”Ÿæˆç›®æ ‡å¯¹è±¡ï¼Œå¦‚dubbo çš„æœåŠ¡æš´éœ²æºç ä¸­Wrapperç±»çš„ç”Ÿæˆé€»è¾‘ä¹Ÿæ˜¯å…ˆæ‹¼æ¥å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡dubboçš„ClassGeneratorå¤„ç†æˆClassï¼Œä½†æ˜¯ClassGeneratorå†…éƒ¨ä¹Ÿæ˜¯å°è£…äº†Javassistç›¸å…³å¯¹è±¡ï¼Œå…·ä½“ç”ŸæˆClassè¿˜æ˜¯Javassistæ¥å®Œæˆçš„ã€‚ JdkCompiler ç¼–è¯‘å™¨JdkCompilerä½¿ç”¨çš„æ˜¯jdkå†…ç½®çš„ç¼–è¯‘å™¨ï¼Œä¸»è¦ä½¿ç”¨ä¸‰ä¸ªä¸åŒåŠŸèƒ½çš„å¯¹è±¡å®Œæˆå¯¹å­—ç¬¦ä¸²çš„ç¼–è¯‘: JavaFileObjectå¯¹è±¡å°†å­—ç¬¦ä¸²ä»£ç åŒ…è£…æˆä¸€ä¸ªæ–‡ä»¶å¯¹è±¡ JavaFileManageræ¥å£è´Ÿè´£ç®¡ç†æ–‡ä»¶çš„è¯»å–å’Œè¾“å‡ºä½ç½® JavaCompiler.CompilationTask å¯¹è±¡æŠŠJavaFileObjectå¯¹è±¡ ç¼–è¯‘æˆå…·ä½“çš„ç±» 1234567891011121314151617181920212223public Class&lt;?&gt; doCompile(String name, String sourceCode) throws Throwable &#123; int i = name.lastIndexOf('.'); String packageName = i &lt; 0 ? \"\" : name.substring(0, i); String className = i &lt; 0 ? name : name.substring(i + 1); // 1 åˆ›å»ºJavaFileObject å¯¹è±¡ JavaFileObjectImpl javaFileObject = new JavaFileObjectImpl(className, sourceCode); // 2 JavaFileManager ç®¡ç†ç±»æ–‡ä»¶çš„è¾“å…¥å’Œè¾“å‡ºä½ç½® javaFileManager.putFileForInput(StandardLocation.SOURCE_PATH, packageName, className + ClassUtils.JAVA_EXTENSION, javaFileObject); // 3 è°ƒç”¨JavaCompiler.CompilationTask çš„callæ–¹æ³• æŠŠJavaFileObjectå¯¹è±¡ ç¼–è¯‘æˆå…·ä½“çš„ç±» Boolean result = compiler.getTask(null, javaFileManager, diagnosticCollector, options, null, Arrays.asList(javaFileObject)) .call(); if (result == null || !result) &#123; throw new IllegalStateException(\"Compilation failed. class: \" + name + \", diagnostics: \" + diagnosticCollector); &#125; // åŠ è½½ç”Ÿæˆçš„ç±» return classLoader.loadClass(name);&#125; ä¸Šé¢ä»£ç å°±æ˜¯JdkCompilerç¼–è¯‘çš„é€»è¾‘ï¼Œä½¿ç”¨çš„éƒ½æ˜¯jdkçš„æ¥å£ï¼Œæƒ³è¦äº†è§£æ›´å¤šå¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æºä»£ç ï¼Œå…¶å®ƒçš„å°±ä¸å¤šåšåˆ†æã€‚ å°ç»“è‡ªæ­¤ï¼Œdubbo spiåˆ†æå®Œäº†ã€‚dubboæ¡†æ¶å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å¾—ç›Šäºä¸¤ä¸ªæ–¹é¢ï¼Œç¬¬ä¸€ä¸ªæ–¹é¢å°±æ˜¯åœ¨ä¸åŒçš„åœºæ™¯ä¸­ï¼Œdubboä½¿ç”¨äº†ä¸åŒçš„è®¾è®¡æ¨¡å¼ï¼Œç¬¬äºŒä¸ªæ–¹é¢å°±æ˜¯dubbo spiæœºåˆ¶ã€‚å¯ä»¥è¯´dubboä¸­å‡ ä¹æ‰€æœ‰çš„ç»„ä»¶éƒ½æ˜¯é€šè¿‡dubbo spiæœºåˆ¶ä¸²è”èµ·æ¥çš„ï¼Œä¸²è”çš„æ€»çº¿å°±æ˜¯Dubbo URLï¼Œå¯è§dubbo spiåœ¨æ•´ä¸ªæ¡†æ¶ä¸­çš„é‡è¦æ€§ã€‚åœ¨æ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°†ä¸€èµ·äº†è§£ä¸‹dubboå¤šæ ·çš„é…ç½®ï¼Œæ€»ä½“ä¸Šä¸éš¾ï¼Œå°±æ˜¯å†…å®¹æœ‰ç‚¹å¤šã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Javassist","slug":"Javassist","permalink":"https://gentryhuang.com/tags/Javassist/"},{"name":"JDK","slug":"JDK","permalink":"https://gentryhuang.com/tags/JDK/"}]},{"title":"Dubboæºç åˆ†æ - è‡ªé€‚åº”æ‰©å±•","slug":"rpc/Dubboè‡ªé€‚åº”æ‰©å±•","date":"2020-03-17T16:00:00.000Z","updated":"2020-09-03T03:12:53.633Z","comments":false,"path":"posts/3e0b5964/","link":"","permalink":"https://gentryhuang.com/posts/3e0b5964/","excerpt":"","text":"å‰è¨€ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æäº†dubbo spiæœºåˆ¶ï¼Œä½†æ˜¯é—ç•™äº†è‡ªé€‚åº”æ‰©å±•å¹¶æ²¡æœ‰å±•å¼€è¯´æ˜ï¼Œè¿™ç¯‡æ–‡ç« å°±æ˜¯æ¥å¡«å‘çš„ã€‚ä¸Šç¯‡æ–‡ç« ä¸­ä¹Ÿä»‹ç»äº†å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ä»¥åŠåŠ è½½çš„æµç¨‹ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ä¸“æ³¨äºè‡ªåŠ¨ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•ç±»ä»¥åŠè‡ªé€‚åº”æ‰©å±•å¯¹è±¡çš„åˆ›å»ºï¼Œå°±ä¸å†è¿‡å¤šä»‹ç»å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ã€‚è‡ªé€‚åº”æ‰©å±•æ•´ä½“ä¸Šéœ€è¦è®¨è®ºä¸‰éƒ¨åˆ†å†…å®¹ï¼šè‡ªé€‚åº”æ‰©å±•åŸç†ã€è‡ªé€‚åº”æ‰©å±•ç±»ä¸²çš„ç”Ÿæˆ å’Œ åŠ¨æ€ç¼–è¯‘ ã€‚ è¯¥ç¯‡æ–‡ç« å°†è®¨è®ºå‰ä¸¤ä¸ªéƒ¨åˆ†ï¼ŒåŠ¨æ€ç¼–è¯‘ä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è¯¦ç»†è¯´æ˜ã€‚ è‡ªé€‚åº”æ‰©å±•åŸç†æ‰©å±•ç‚¹çš„æ‰©å±•ç±»ä¸€èˆ¬ä¼šåœ¨æ¡†æ¶å¯åŠ¨æ—¶è¢«åŠ è½½ï¼Œä½†æˆ‘ä»¬è¿™æ¬¡çš„ä¸»è§’å¹¶ä¸ä¼šåœ¨æ¡†æ¶å¯åŠ¨æ—¶è¢«åŠ è½½ï¼Œåªå¯èƒ½åœ¨è·å–è‡ªé€‚åº”å®ç°çš„æ—¶å€™è¢«åˆ›å»ºã€ç¼–è¯‘å’Œå®ä¾‹åŒ–ã€‚è¿™é‡Œä¹‹æ‰€ä»¥è¯´å¯èƒ½ï¼Œæ˜¯å½“ä¸€ä¸ªæ‰©å±•æ¥å£æ—¢æœ‰å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œåˆæƒ³å®ç°è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»çš„æƒ…å†µä¸‹ï¼Œåªä¼šä»¥å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ä¸ºå‡†ï¼Œä¸ä¼šå»åˆ›å»ºåŠ¨æ€çš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œåœ¨æ¡†æ¶å¯åŠ¨æ—¶å°±ä¼šåŠ è½½å›ºå®šæ‰©å±•ç±»å¹¶æ”¾å…¥ç¼“å­˜ã€‚å½“ç¼“å­˜ä¸­ä¸å­˜åœ¨è‡ªé€‚åº”æ‰©å±•ç±»æ—¶ï¼Œdubboæ²¡æœ‰ç›´æ¥ä½¿ç”¨ä»£ç†æ¨¡å¼å®ç°è‡ªé€‚åº”æ‰©å±•ï¼Œè€Œæ˜¯ä¸ºæ‰©å±•æ¥å£ç”Ÿæˆå…·æœ‰ä»£ç†åŠŸèƒ½çš„ä»£ç ï¼Œç„¶åé€šè¿‡åŠ¨æ€ç¼–è¯‘å¾—åˆ°è‡ªé€‚åº”ç±»ï¼Œæ•´ä¸ªè¿‡ç¨‹æœ€ç»ˆçš„ç›®çš„æ˜¯ä¸ºæ‰©å±•ç‚¹ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œè€Œä»£ç†å¯¹è±¡ä¸»è¦ä»»åŠ¡å°±æ˜¯ä»URLä¸­è·å–æ‰©å±•åå¯¹åº”çš„æ‰©å±•å®ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡å¯¹å®˜ç½‘çš„ä¾‹å­ç¨åŠ æ”¹åŠ¨æ¥è¯´æ˜è‡ªåŠ¨ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•çš„åŸç†ã€‚ è½¦è½®åˆ¶é€ æ¥å£ WheelMaker 123public interface WheelMaker &#123; void makeWheel(URL url);&#125; WheelMaker æ¥å£çš„æ™®é€šå®ç°ç±» 123456// CommonWheelMakerå¯¹åº”çš„æ‰©å±•åè®¾ç½®ä¸º commonWheelMakerpublic class CommonWheelMaker implements WheelMaker &#123; public void makeWheel(URL url) &#123; System.out.println(\"æ‰“å°urlï¼Œåˆ¶é€ å…¨å®‡å®™æœ€å¥½çš„è½¦è½®...\" + url); &#125;&#125; WheelMaker æ¥å£çš„è‡ªé€‚åº”å®ç°ç±» 12345678910111213141516171819public class AdaptiveWheelMaker implements WheelMaker &#123; public void makeWheel(URL url) &#123; if (url == null) &#123; throw new IllegalArgumentException(\"url == null\"); &#125; // 1.ä» URL ä¸­è·å– WheelMaker åç§° String wheelMakerName = url.getParameter(\"wheel.maker\"); if (wheelMakerName == null) &#123; throw new IllegalArgumentException(\"wheelMakerName == null\"); &#125; // 2.é€šè¿‡ SPI åŠ è½½ WheelMaker åç§° å¯¹åº”WheelMakerå…·ä½“å®ç°ã€‚è¿™é‡Œè·å–æ‰©å±•å®ç°è¿˜æ˜¯ä½¿ç”¨getExtensionæ–¹æ³•ã€‚ WheelMaker wheelMaker = ExtensionLoader.getExtensionLoader(WheelMaker.class).getExtension(wheelMakerName); // 3.è°ƒç”¨ç›®æ ‡æ–¹æ³• wheelMaker.makeWheel(url); &#125;&#125; AdaptiveWheelMaker æ˜¯ä¸€ä¸ªä»£ç†ç±»[åœ¨dubboæ¡†æ¶ä¸­è¯¥ç±»å‹çš„ç±»æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„,å¹¶å‘æ‰‹åŠ¨å®ç°],ä¸ä¼ ç»Ÿçš„ä»£ç†é€»è¾‘ä¸åŒï¼ŒAdaptiveWheelMaker æ‰€ä»£ç†çš„å¯¹è±¡æ˜¯åœ¨ makeWheel æ–¹æ³•ä¸­é€šè¿‡ SPI åŠ è½½å¾—åˆ°çš„ã€‚makeWheel æ–¹æ³•ä¸»è¦åšäº†ä¸‰ä»¶äº‹æƒ…ï¼š ä» URL ä¸­è·å– WheelMaker æ‰©å±•å é€šè¿‡ SPI åŠ è½½å…·ä½“çš„ WheelMaker å®ç°ç±» è°ƒç”¨ç›®æ ‡æ–¹æ³• ç¨‹åºè¿è¡Œæ—¶ï¼Œå‡è®¾æˆ‘ä»¬è·å–åˆ°äº†AdaptiveWheelMakerå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å®ƒçš„makeWheelæ–¹æ³•ï¼Œç„¶åæœ‰è¿™æ ·ä¸€ä¸ª url å‚æ•°ä¼ å…¥ï¼š 1dubbo:&#x2F;&#x2F;192.168.0.101:20880&#x2F;XxxService?wheel.maker&#x3D;commonWheelMaker AdaptiveWheelMaker çš„ makeWheel æ–¹æ³•ä» url ä¸­æå– wheel.maker å‚æ•°ï¼Œå¾—åˆ°æ‰©å±•å commonWheelMakerï¼Œä¹‹åå†é€šè¿‡ SPI åŠ è½½æ‰©å±•åä¸º commonWheelMaker çš„å®ç°ç±»ï¼Œæœ€ç»ˆå¾—åˆ°å…·ä½“çš„ WheelMaker å®ä¾‹ã€‚ åŸç†å°ç»“è¿™ä¸ªä¾‹å­å±•ç¤ºäº†è‡ªåŠ¨ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•ç±»çš„æ ¸å¿ƒå®ç°ï¼Œå³åœ¨æ‰©å±•æ¥å£çš„æ–¹æ³•è¢«è°ƒç”¨ï¼ˆdubboä¸­æ˜¯ä½¿ç”¨è‡ªé€‚åº”æ‰©å±•å¯¹è±¡è°ƒç”¨çš„ï¼‰æ—¶ï¼Œé€šè¿‡SPIåŠ è½½å…·ä½“çš„æ‰©å±•å¯¹è±¡ï¼Œå¹¶è°ƒç”¨è¯¥æ‰©å±•å¯¹è±¡çš„åŒåæ–¹æ³•ã€‚ è‡ªé€‚åº”æ‰©å±•ç±»ä¸²çš„ç”Ÿæˆé€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬ç›´è§‚çš„è®¤è¯†äº†è‡ªé€‚åº”æ‰©å±•ç±»çš„å·¥ä½œåŸç†ã€‚é€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬çŸ¥é“@Adaptive å¯æ³¨è§£åœ¨ç±»æˆ–æ–¹æ³•ä¸Šï¼Œæ³¨è§£åœ¨ç±»ä¸Šæ—¶ï¼ŒDubbo ä¸ä¼šä¸ºè¯¥ç±»ç”Ÿæˆä»£ç†ç±»ã€‚æ³¨è§£åœ¨æ‰©å±•æ¥å£çš„æ–¹æ³•ä¸Šæ—¶ï¼ŒDubbo ä¼šä¸ºä¸ºè¯¥æ¥å£ç”Ÿæˆä»£ç†é€»è¾‘ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°çš„getAdaptiveExtensionæ–¹æ³•å…¥å£ç»§ç»­åˆ†æã€‚ getAdaptiveExtension æ–¹æ³•12345678910111213141516171819202122232425262728293031323334353637public T getAdaptiveExtension() &#123; // ä»ç¼“å­˜ä¸­è·å–æ‰©å±•ç‚¹å¯¹åº”çš„è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ Object instance = cachedAdaptiveInstance.get(); // å¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™é€šè¿‡åŒé‡æ£€é”è·å–/åˆ›å»º if (instance == null) &#123; // è‹¥ä¹‹å‰åˆ›å»ºçš„æ—¶å€™æ²¡æœ‰æŠ¥é”™ï¼Œå³ä¹‹å‰åˆ›å»ºäº†å¹¶ä¸”æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ if (createAdaptiveInstanceError == null) &#123; synchronized (cachedAdaptiveInstance) &#123; // å†æ¬¡å°è¯•ä»ç¼“å­˜ä¸­è·å– instance = cachedAdaptiveInstance.get(); if (instance == null) &#123; try &#123; // åˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ instance = createAdaptiveExtension(); // æ”¾å…¥ç¼“å­˜ä¸­ cachedAdaptiveInstance.set(instance); &#125; catch (Throwable t) &#123; createAdaptiveInstanceError = t; throw new IllegalStateException(\"fail to create adaptive instance: \" + t.toString(), t); &#125; &#125; &#125; // è‹¥ä¹‹å‰åˆ›å»ºçš„æ—¶å€™æŠ¥é”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ &#125; else &#123; throw new IllegalStateException(\"fail to create adaptive instance: \" + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError); &#125; &#125; return (T) instance;&#125; ä¸Šé¢çš„ä»£ç ç”¨æ¥è·å–æ‰©å±•ç‚¹çš„è‡ªé€‚åº”å¯¹è±¡ï¼Œè¯¥æ–¹æ³•å…ˆæ£€æŸ¥ç¼“å­˜ï¼Œç¼“å­˜ä¸­æ²¡æœ‰åˆ™è°ƒç”¨ createAdaptiveExtension æ–¹æ³•å°è¯•åˆ›å»ºè‡ªé€‚åº”å¯¹è±¡ã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¿› createAdaptiveExtension æ–¹æ³•ã€‚ 12345678910111213private T createAdaptiveExtension() &#123; try &#123; /** * 1 getAdaptiveExtensionClassæ–¹æ³•ç”¨æ¥è·å¾—è‡ªé€‚åº”æ‰©å±•ç±»ã€æ³¨æ„ï¼Œè·å¾—çš„è‡ªé€‚åº”æ‰©å±•ç±»å¯èƒ½æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„ç±»ï¼Œä¹Ÿå¯èƒ½æ˜¯é€šè¿‡å­—èŠ‚ç åˆ›å»ºçš„ã€‘ * 2 é€šè¿‡åå°„åˆ›å»ºè‡ªé€‚åº”æ‰©å±•å¯¹è±¡ * 3 è°ƒç”¨injectExtensionæ–¹æ³•ï¼Œå‘åˆ›å»ºçš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡æ³¨å…¥ä¾èµ– */ return injectExtension((T) getAdaptiveExtensionClass().newInstance()); &#125; catch (Exception e) &#123; throw new IllegalStateException(\"Can not create adaptive extension \" + type + \", cause: \" + e.getMessage(), e); &#125; &#125; ä¸Šé¢çš„æ–¹æ³•å…ˆè·å–è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œç„¶ååˆ©ç”¨åå°„åˆ›å»ºè‡ªé€‚åº”å¯¹è±¡ï¼Œæ¥ç€ä¼šå‘åˆ›å»ºçš„è‡ªé€‚åº”å¯¹è±¡æ³¨å…¥ä¾èµ–ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†è‡ªé€‚åº”æ‰©å±•ç±»åˆ†ä¸ºä¸¤ç±»ï¼Œå›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ä¸­å¯èƒ½å­˜åœ¨ä¸€äº›ä¾èµ–ï¼Œè¿™æ—¶éœ€è¦ä½¿ç”¨æ‰©å±•å·¥å‚è¿›è¡Œsetteræ³¨å…¥ï¼Œè‡ªåŠ¨ç”Ÿæˆçš„æ‰©å±•å®ç°ä¸€èˆ¬ä¸ä¼šä¾èµ–å…¶å®ƒå±æ€§ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†æä¸‹è‡ªé€‚åº”æ‰©å±•ç±»æ€ä¹ˆè·å–çš„ã€‚ 123456789101112private Class&lt;?&gt; getAdaptiveExtensionClass() &#123; // åˆ·æ–°æ‰©å±•ç‚¹å®ç°ç±»é›†åˆ getExtensionClasses(); // ç¼“å­˜ä¸­æœ‰æ‰©å±•ç‚¹çš„è‡ªé€‚åº”ç±»å°±ç›´æ¥è¿”å› if (cachedAdaptiveClass != null) &#123; return cachedAdaptiveClass; &#125; // æ²¡æœ‰å°±è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•ç±»çš„ä»£ç ï¼Œç¼–è¯‘åè¿”å›è¯¥ç±» return cachedAdaptiveClass = createAdaptiveExtensionClass(); &#125; ä¸Šé¢çš„ä»£ç å…ˆæ˜¯åˆ·æ–°æ‰©å±•ç‚¹å®ç°ç±»é›†åˆï¼Œæ³¨æ„å¦‚æœæ‰©å±•æ¥å£çš„å®ç°ç±»ä¸­æœ‰æ ‡æ³¨@Adaptiveæ³¨è§£çš„ç±»ï¼Œé‚£ä¹ˆcachedAdaptiveClassç¼“å­˜å±æ€§ä¸­ä¿å­˜çš„å°±æ˜¯è¯¥ç±»ï¼Œå³å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ã€‚å¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¯´æ˜å½“å‰æ‰©å±•æ¥å£çš„å®ç°ç±»ä¸­ä¸å­˜åœ¨å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œé‚£ä¹ˆåªèƒ½å°è¯•åˆ›å»ºè¯¥æ¥å£çš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œä»£ç é€»è¾‘å¦‚ä¸‹ï¼š 1234567891011private Class&lt;?&gt; createAdaptiveExtensionClass() &#123; // ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•å®ç°ç±»çš„ä»£ç å­—ç¬¦ä¸² String code = createAdaptiveExtensionClassCode(); // è·å–ç±»åŠ è½½å™¨ ClassLoader classLoader = findClassLoader(); // è·å–Compilerè‡ªé€‚åº”æ‰©å±•å¯¹è±¡ com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension(); // åŠ¨æ€ç¼–è¯‘ï¼Œç”ŸæˆClass return compiler.compile(code, classLoader); &#125; createAdaptiveExtensionClass æ–¹æ³•åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼š ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•å®ç°ç±»çš„ä»£ç å­—ç¬¦ä¸² è·å–Compilerè‡ªé€‚åº”æ‰©å±•å¯¹è±¡ åŠ¨æ€ç¼–è¯‘ è‡ªé€‚åº”æ‹“å±•å®ç°ç±»çš„ä»£ç å­—ç¬¦ä¸² ï¼Œç”ŸæˆClass åé¢ä¸¤ä¸ªæ­¥éª¤å±äº åŠ¨æ€ç¼–è¯‘ éƒ¨åˆ†ï¼Œä¸åœ¨æœ¬æ–‡èŒƒç•´ï¼Œæˆ‘ä»¬ä¸»è¦å…³æ³¨ è‡ªé€‚åº”æ‰©å±•å®ç°ç±»çš„ä»£ç å­—ç¬¦ä¸² çš„ç”Ÿæˆé€»è¾‘ã€‚ è‡ªé€‚åº”æ‰©å±•ç±»ä»£ç ç”ŸæˆcreateAdaptiveExtensionClassCodeæ–¹æ³•ä»£ç éå¸¸å¤šï¼Œä¸è¿‡æ€»çš„é€»è¾‘å¤§è‡´å¯ä»¥åˆ†ä¸ºå…«ä¸ªé€»è¾‘åˆ†æ”¯ï¼Œå·²ç»è¿›è¡Œè¯¦ç»†çš„æ³¨é‡Šï¼Œä¸‹é¢å°±ç›´æ¥è´´ä¸Šä»£ç ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322private String createAdaptiveExtensionClassCode() &#123; StringBuilder codeBuilder = new StringBuilder(); //----------------- 1 æ£€æŸ¥æ‰©å±•æ¥å£æ–¹æ³•æ˜¯å¦åŒ…å« Adaptiveæ³¨è§£ï¼Œè¦æ±‚è‡³å°‘æœ‰ä¸€ä¸ªæ–¹æ³•è¢« Adaptive æ³¨è§£ä¿®é¥° --------------------/ // åå°„è·å–æ‰©å±•ç‚¹æ‰€æœ‰æ–¹æ³• Method[] methods = type.getMethods(); boolean hasAdaptiveAnnotation = false; // éå†æ–¹æ³•åˆ—è¡¨ï¼Œæ£€æµ‹æ˜¯å¦æ ‡æ³¨ Adaptive æ³¨è§£ for (Method m : methods) &#123; if (m.isAnnotationPresent(Adaptive.class)) &#123; hasAdaptiveAnnotation = true; break; &#125; &#125; // è‹¥æ‰€æœ‰æ–¹æ³•ä¸Šéƒ½æ²¡æœ‰Adaptiveæ³¨è§£ï¼Œå°±æŠ›å‡ºå¼‚å¸¸ if (!hasAdaptiveAnnotation) &#123; throw new IllegalStateException(\"No adaptive method on extension \" + type.getName() + \", refuse to create the adaptive class!\"); &#125; //------------------ 2 ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»çš„ä»£ç å­—ç¬¦ä¸²ï¼Œä»£ç ç”Ÿæˆçš„é¡ºåºä¸ Java æ–‡ä»¶å†…å®¹é¡ºåºä¸€è‡´ ---------------------------/ // ç”Ÿæˆpackage codeBuilder.append(\"package \").append(type.getPackage().getName()).append(\";\"); // ç”Ÿæˆimportï¼Œæ³¨æ„è‡ªé€‚åº”ç±»åªä¾èµ–ExtensionLoaderï¼Œå…¶å®ƒçš„éƒ½ä¸ä¼šä¾èµ–ï¼Œå› ä¸ºä½¿ç”¨çš„éƒ½æ˜¯å…¨è·¯å¾„åï¼Œä¸éœ€è¦å†å¯¼å…¥åŒ…äº† codeBuilder.append(\"\\nimport \").append(ExtensionLoader.class.getName()).append(\";\"); // å¼€å§‹ç”Ÿæˆ class codeBuilder.append(\"\\npublic class \").append(type.getSimpleName()).append(\"$Adaptive\").append(\" implements \").append(type.getCanonicalName()).append(\" &#123;\"); //------------------ 3 ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»ä¸­çš„æ–¹æ³•ï¼Œæ¥å£ä¸­æ–¹æ³•å¯ä»¥è¢« Adaptive æ³¨è§£ä¿®é¥°ï¼Œä¹Ÿå¯ä»¥ä¸è¢«ä¿®é¥°ï¼Œä½†å¤„ç†æ–¹å¼ä¹Ÿä¸åŒ -------/ // éå†æ–¹æ³•åˆ—è¡¨ï¼Œä¸ºç±»ä¸­å¡«å……æ–¹æ³• for (Method method : methods) &#123; // æ–¹æ³•è¿”å›ç±»å‹ Class&lt;?&gt; rt = method.getReturnType(); // æ–¹æ³•å‚æ•°ç±»å‹ Class&lt;?&gt;[] pts = method.getParameterTypes(); // æ–¹æ³•å¼‚å¸¸ç±»å‹ Class&lt;?&gt;[] ets = method.getExceptionTypes(); // å°è¯•è·å–æ–¹æ³•çš„ Adaptive æ³¨è§£ï¼Œæœ‰æ— æ³¨è§£çš„åŒºåˆ«ä½“ç°åœ¨ ç”Ÿæˆæ–¹æ³•å­—ç¬¦ä¸²çš„å·®å¼‚ä¸Š Adaptive adaptiveAnnotation = method.getAnnotation(Adaptive.class); // ç±»ä¸­çš„æ–¹æ³•å­—ç¬¦ä¸²é›† StringBuilder code = new StringBuilder(512); // 3.1 ç”Ÿæˆæ²¡æœ‰Adaptiveæ³¨è§£çš„æ–¹æ³•ä»£ç ä¸²ã€‚Dubboä¸ä¼šä¸ºæ²¡æœ‰æ ‡æ³¨Adaptiveæ³¨è§£çš„æ–¹æ³•ç”Ÿæˆä»£ç†é€»è¾‘ï¼Œä»…ä»…ç”Ÿæˆä¸€å¥æŠ›å‡ºå¼‚å¸¸ä»£ç  if (adaptiveAnnotation == null) &#123; code.append(\"throw new UnsupportedOperationException(\\\"method \") .append(method.toString()).append(\" of interface \") .append(type.getName()).append(\" is not adaptive method!\\\");\"); // 3.2 ç”Ÿæˆæœ‰Adaptiveæ³¨è§£çš„æ–¹æ³•ä»£ç ä¸²ã€‚æ ¸å¿ƒé€»è¾‘å°±æ˜¯ä»æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸­ç›´æ¥æˆ–é—´æ¥è·å–é…ç½®æ€»çº¿URLï¼Œç„¶åç»“åˆAdaptiveæ³¨è§£å€¼åŠé»˜è®¤æ‰©å±•åç­–ç•¥ï¼Œä»URLä¸­å¾—åˆ°æ‰©å±•åï¼Œç„¶åé€šè¿‡ExtensionLoaderè·å–æ‰©å±•åå¯¹åº”çš„æ‰©å±•å®ç°å¯¹è±¡ã€‚ &#125; else &#123; int urlTypeIndex = -1; // éå†æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„ for (int i = 0; i &lt; pts.length; ++i) &#123; // åˆ¤æ–­å‚æ•°ç±»å‹æ˜¯ä¸æ˜¯URLï¼Œç¡®å®šURLå‚æ•°ä½ç½® if (pts[i].equals(URL.class)) &#123; urlTypeIndex = i; break; &#125; &#125; // urlTypeIndex != -1ï¼Œè¡¨ç¤ºå‚æ•°åˆ—è¡¨ä¸­å­˜åœ¨ URLç±»å‹çš„å‚æ•°ï¼Œå³ç›´æ¥è·å–é…ç½®æ€»çº¿URLã€‚å¦‚ï¼š &lt;T&gt; Invoker&lt;T&gt; refer(Class&lt;T&gt; type, URL url) throws RpcException æ–¹æ³• if (urlTypeIndex != -1) &#123; // ä¸º URL ç±»å‹å‚æ•°ç”Ÿæˆåˆ¤ç©ºä»£ç ï¼Œå¦‚ï¼šif (arg0 == null) throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument == null\"); String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"url == null\\\");\", urlTypeIndex); code.append(s); // ä¸º URL ç±»å‹å‚æ•°ç”Ÿæˆèµ‹å€¼ä»£ç ï¼Œå½¢å¦‚ URL url = arg0 s = String.format(\"\\n%s url = arg%d;\", URL.class.getName(), urlTypeIndex); code.append(s); &#125; // å‚æ•°åˆ—è¡¨ä¸­ä¸å­˜åœ¨ URL ç±»å‹å‚æ•°ï¼Œåªèƒ½é—´æ¥å°è¯•è·å–é…ç½®æ€»çº¿URLã€‚å¦‚ï¼š&lt;T&gt; Exporter&lt;T&gt; export(Invoker&lt;T&gt; invoker) throws RpcException æ–¹æ³•ï¼Œé…ç½®æ€»çº¿URLæ˜¯ä»invokerä¸­è·å–ã€‚ else &#123; // ç›®æ ‡æ–¹æ³•åï¼Œè¿™é‡Œå¦‚æœå­˜åœ¨å°±æ˜¯ getUrl String attribMethod = null; // find URL getter method LBL_PTS: // éå†æ–¹æ³•çš„å‚æ•°ç±»å‹åˆ—è¡¨ for (int i = 0; i &lt; pts.length; ++i) &#123; // è·å–å½“å‰æ–¹æ³•çš„å‚æ•°ç±»å‹ çš„ å…¨éƒ¨æ–¹æ³• Method[] ms = pts[i].getMethods(); // åˆ¤æ–­æ–¹æ³•å‚æ•°å¯¹è±¡ä¸­æ˜¯å¦æœ‰ public URL getUrl() æ–¹æ³• for (Method m : ms) &#123; String name = m.getName(); if ((name.startsWith(\"get\") || name.length() &gt; 3) &amp;&amp; Modifier.isPublic(m.getModifiers()) &amp;&amp; !Modifier.isStatic(m.getModifiers()) &amp;&amp; m.getParameterTypes().length == 0 &amp;&amp; m.getReturnType() == URL.class) &#123; urlTypeIndex = i; attribMethod = name; // æ‰¾åˆ°æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­é—´æ¥å­˜åœ¨URLçš„å‚æ•°ï¼Œåˆ™ç»“æŸå¯»æ‰¾é€»è¾‘ break LBL_PTS; &#125; &#125; &#125; // å¦‚æœå‚æ•°åˆ—è¡¨ä¸­æ²¡æœ‰ä¸€ä¸ªå‚æ•°æœ‰getUrlæ–¹æ³•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ if (attribMethod == null) &#123; throw new IllegalStateException(\"fail to create adaptive class for interface \" + type.getName() + \": not found url parameter or url attribute in parameters of method \" + method.getName()); &#125; // ä¸ºå¯è¿”å›URLçš„å‚æ•°ç”Ÿæˆåˆ¤ç©ºä»£ç ï¼Œå¦‚ï¼šif (arg0 == null) throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument == null\"); String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"%s argument == null\\\");\", urlTypeIndex, pts[urlTypeIndex].getName()); code.append(s); // ä¸ºå¯è¿”å›URLçš„å‚æ•° çš„getUrlæ–¹æ³•è¿”å› çš„URLç”Ÿæˆåˆ¤ç©ºä»£ç ï¼Œå¦‚ï¼šif (arg0.getUrl() == null) throw new IllegalArgumentException(\"com.alibaba.dubbo.rpc.Invoker argument getUrl() == null\"); s = String.format(\"\\nif (arg%d.%s() == null) throw new IllegalArgumentException(\\\"%s argument %s() == null\\\");\", urlTypeIndex, attribMethod, pts[urlTypeIndex].getName(), attribMethod); code.append(s); // ç”Ÿæˆèµ‹å€¼è¯­å¥ï¼Œå½¢å¦‚ï¼šURL url = argN.getUrl(); s = String.format(\"%s url = arg%d.%s();\", URL.class.getName(), urlTypeIndex, attribMethod); code.append(s); &#125; //----------------- 4 è·å– Adaptive æ³¨è§£å€¼ ï¼ŒAdaptive æ³¨è§£å€¼ value ç±»å‹ä¸º String[]ï¼Œå¯å¡«å†™å¤šä¸ªå€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ºç©ºæ•°ç»„ -------------/ /** * è·å–@Adaptiveæ³¨è§£çš„å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œè¿™äº›å€¼å°†ä½œä¸ºè·å–æ‰©å±•åçš„keyï¼Œéœ€è¦æ³¨æ„ï¼ŒProtocolæ‰©å±•å’Œå…¶å®ƒæ‰©å±•ç‚¹æ˜¯ä¸åŒçš„ï¼Œå‰è€…è·å–æ‰©å±•åæ˜¯å–åè®®ï¼Œåè€…è·å–æ‰©å±•åæ˜¯å–å‚æ•°çš„å€¼ * 1 æ™®é€šæ‰©å±•ç‚¹ï¼Œå¦‚ProxyFactorï¼š String extName = url.getParameter(\"proxy\", \"javassist\"); * 2 Protocolæ‰©å±•ç‚¹ï¼š String extName = ( url.getProtocol() == null ? \"dubbo\" : url.getProtocol() ); */ String[] value = adaptiveAnnotation.value(); // å¦‚æœ@Adaptiveæ³¨è§£æ²¡æœ‰æŒ‡å®šå€¼ï¼Œåˆ™æ ¹æ®æ‰©å±•æ¥å£åç”Ÿæˆã€‚å¦‚ï¼šSimpleExt -&gt; simple.extï¼Œå³å°†æ‰©å±•æ¥å£åä¸­çš„å¤§å†™è½¬å°å†™ï¼Œå¹¶ä½¿ç”¨'.'æŠŠå®ƒä»¬è¿æ¥èµ·æ¥ if (value.length == 0) &#123; // è·å–æ‰©å±•æ¥å£ç®€å•åç§°çš„å­—ç¬¦æ•°ç»„ char[] charArray = type.getSimpleName().toCharArray(); StringBuilder sb = new StringBuilder(128); for (int i = 0; i &lt; charArray.length; i++) &#123; // åˆ¤æ–­æ˜¯å¦å¤§å†™å­—æ¯ï¼Œå¦‚æœæ˜¯å°±ä½¿ç”¨ '.' è¿æ¥ï¼Œå¹¶å¤§å†™è½¬å°å†™ if (Character.isUpperCase(charArray[i])) &#123; if (i != 0) &#123; sb.append(\".\"); &#125; sb.append(Character.toLowerCase(charArray[i])); &#125; else &#123; sb.append(charArray[i]); &#125; &#125; value = new String[]&#123;sb.toString()&#125;; &#125; //--------------------- 5 æ£€æµ‹æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­æ˜¯å¦å­˜åœ¨ Invocation ç±»å‹çš„å‚æ•°ï¼Œæœ‰åˆ™è¡¨ç¤ºæ˜¯è°ƒç”¨æ–¹æ³• --------------------/ boolean hasInvocation = false; for (int i = 0; i &lt; pts.length; ++i) &#123; // å‚æ•°ç±»å‹æ˜¯Invocation if (pts[i].getName().equals(\"com.alibaba.dubbo.rpc.Invocation\")) &#123; // ä¸º Invocation ç±»å‹å‚æ•°ç”Ÿæˆåˆ¤ç©ºä»£ç  String s = String.format(\"\\nif (arg%d == null) throw new IllegalArgumentException(\\\"invocation == null\\\");\", i); code.append(s); // ç”Ÿæˆ String methodName = argN.getMethodName()ï¼› ä»£ç ï¼ŒInvocationæ˜¯è°ƒç”¨ä¿¡æ¯ï¼Œé‡Œé¢åŒ…å«è°ƒç”¨æ–¹æ³• s = String.format(\"\\nString methodName = arg%d.getMethodName();\", i); code.append(s); hasInvocation = true; break; &#125; &#125; //----------------------- 6 æ‰©å±•åå†³ç­–é€»è¾‘ï¼Œ@SPIã€@Adaptiveä»¥åŠæ–¹æ³•å«æœ‰Invocationç±»å‹å‚æ•°éƒ½ä¼šå½±å“æœ€ç»ˆçš„æ‰©å±•å -------------------------/ // è®¾ç½®é»˜è®¤æ‹“å±•åï¼ŒSPIæ³¨è§£å€¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ SPIæ³¨è§£å€¼ä¸ºç©ºä¸²ï¼Œæ­¤æ—¶cachedDefaultName = null String defaultExtName = cachedDefaultName; String getNameCode = null; /** * éå†Adaptive çš„æ³¨è§£å€¼ï¼Œç”¨äºç”Ÿæˆä»URLä¸­è·å–æ‹“å±•åçš„ä»£ç ï¼Œæœ€ç»ˆçš„æ‰©å±•åä¼šèµ‹å€¼ç»™ getNameCode å˜é‡ã€‚ * æ³¨æ„ï¼š * 1 è¿™ä¸ªå¾ªç¯çš„éå†é¡ºåºæ˜¯ç”±åå‘å‰éå†çš„ï¼Œå› ä¸ºAdaptiveæ³¨è§£å¯èƒ½é…ç½®äº†å¤šä¸ªæ‰©å±•åï¼Œè€Œdubboè·å–æ‰©å±•åçš„ç­–ç•¥æ˜¯ä»å‰å¾€åä¾æ¬¡è·å–ï¼Œæ‰¾åˆ°å³ç»“æŸï¼Œä»¥ä¸‹ä»£ç æ‹¼æ¥çš„æ—¶å€™ä¹Ÿæ˜¯ä»åå¾€å‰æ‹¼æ¥ã€‚ * 2 ç”Ÿæˆçš„æ‰©å±•åä»£ç å¤§è‡´æœ‰3å¤§ç±»ï¼ŒAdaptiveçš„æ³¨è§£ä¸­å±æ€§å€¼çš„æ•°ç›®å†³å®šäº†å†…åµŒå±‚çº§ï¼š *ï¼ˆ1ï¼‰ String extName = (url.getProtocol() == null ? defaultExtName : url.getProtocol()); è·å–åè®®æ‰©å±•ç‚¹çš„æ‰©å±•å *ï¼ˆ2ï¼‰ String extName = url.getMethodParameter(methodName, Adaptiveçš„æ³¨è§£å€¼, defaultExtName); è·å–æ–¹æ³•çº§åˆ«çš„å‚æ•°å€¼ä½œä¸ºæ‰©å±•åï¼Œå› ä¸ºæ–¹æ³•çš„å‚æ•°åˆ—è¡¨ä¸­å«æœ‰Invocationè°ƒç”¨ä¿¡æ¯ã€‚ *ï¼ˆ3ï¼‰ String extName = url.getParameter(Adaptiveçš„æ³¨è§£å€¼, defaultExtName); è·å–å‚æ•°å€¼ä½œä¸ºæ‰©å±•å *ï¼ˆ4ï¼‰ å¦‚æœAdaptiveçš„æ³¨è§£ä¸­å±æ€§å€¼æœ‰å¤šä¸ªï¼Œå°±è¿›è¡ŒåµŒå¥—è·å–ã€‚å¦‚é…ç½®ä¸¤ä¸ªï¼Œä»¥(3)ä¸ºä¾‹ï¼šString extName = url.getParameter(Adaptiveçš„æ³¨è§£å€¼[0],url.getParameter(Adaptiveçš„æ³¨è§£å€¼[1], defaultExtName)); * 3 å‚æ•°å¦‚æœæ˜¯protocolï¼Œprotocolæ˜¯urlä¸»è¦éƒ¨åˆ†ï¼Œå¯é€šè¿‡getProtocolæ–¹æ³•ç›´æ¥è·å–ã€‚å¦‚æœæ˜¯å…¶ä»–çš„éœ€è¦æ˜¯ä»URLå‚æ•°éƒ¨åˆ†è·å–ã€‚ä¸¤è€…è·å–æ–¹æ³•ä¸ä¸€æ ·ã€‚å…¶ä¸­å‚æ•°è·å–åˆå¯åˆ†ä¸ºæ–¹æ³•çº§åˆ«å‚æ•°å’Œéæ–¹æ³•çº§åˆ«å‚æ•° */ for (int i = value.length - 1; i &gt;= 0; --i) &#123; // ç¬¬ä¸€æ¬¡éå†åˆ†æ”¯ if (i == value.length - 1) &#123; if (null != defaultExtName) &#123; if (!\"protocol\".equals(value[i])) &#123; // æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­æœ‰è°ƒç”¨ä¿¡æ¯Invocationå‚æ•° if (hasInvocation) &#123; getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName); &#125; else &#123; getNameCode = String.format(\"url.getParameter(\\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName); &#125; &#125; else &#123; getNameCode = String.format(\"( url.getProtocol() == null ? \\\"%s\\\" : url.getProtocol() )\", defaultExtName); &#125; &#125; else &#123; if (!\"protocol\".equals(value[i])) &#123; // æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­æœ‰è°ƒç”¨ä¿¡æ¯Invocationå‚æ•° if (hasInvocation) &#123; getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName); &#125; else &#123; getNameCode = String.format(\"url.getParameter(\\\"%s\\\")\", value[i]); &#125; &#125; else &#123; getNameCode = \"url.getProtocol()\"; &#125; &#125; // ç¬¬äºŒæ¬¡å¼€å§‹éƒ½èµ°è¯¥åˆ†æ”¯ï¼Œç”¨äºåµŒå¥—è·å–æ‰©å±•å &#125; else &#123; if (!\"protocol\".equals(value[i])) &#123; // æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸­æœ‰è°ƒç”¨ä¿¡æ¯Invocationå‚æ•° if (hasInvocation) &#123; getNameCode = String.format(\"url.getMethodParameter(methodName, \\\"%s\\\", \\\"%s\\\")\", value[i], defaultExtName); &#125; else &#123; getNameCode = String.format(\"url.getParameter(\\\"%s\\\", %s)\", value[i], getNameCode); &#125; &#125; else &#123; getNameCode = String.format(\"url.getProtocol() == null ? (%s) : url.getProtocol()\", getNameCode); &#125; &#125; &#125; // ç”Ÿæˆæ‰©å±•æ˜ èµ‹å€¼ä»£ç  code.append(\"\\nString extName = \").append(getNameCode).append(\";\"); // ç”Ÿæˆ æ‰©å±•æ˜ åˆ¤ç©ºä»£ç  String s = String.format(\"\\nif(extName == null) \" + \"throw new IllegalStateException(\\\"Fail to get extension(%s) name from url(\\\" + url.toString() + \\\") use keys(%s)\\\");\", type.getName(), Arrays.toString(value)); code.append(s); //---------------------------------------- 7 ç”Ÿæˆ è·å–æ‰©å±•å¯¹è±¡ä»£ç  ä»¥åŠ è°ƒç”¨æ‰©å±•å¯¹è±¡çš„ç›®æ ‡æ–¹æ³•ä»£ç  ---------------------------------/ // ç”Ÿæˆ extensionæ‰©å±•å¯¹è±¡ èµ‹å€¼ ä»£ç  s = String.format(\"\\n%s extension = (%&lt;s)%s.getExtensionLoader(%s.class).getExtension(extName);\", type.getName(), ExtensionLoader.class.getSimpleName(), type.getName()); code.append(s); // å¦‚æœæ–¹æ³•è¿”å›å€¼ç±»å‹évoidï¼Œåˆ™ç”Ÿæˆreturnè¯­å¥ if (!rt.equals(void.class)) &#123; code.append(\"\\nreturn \"); &#125; // ç”Ÿæˆ extensionæ‰©å±•å¯¹è±¡ è°ƒç”¨ç›®æ ‡æ–¹æ³•é€»è¾‘ï¼Œå½¢å¦‚ï¼š extension.æ–¹æ³•å(arg0, arg2, ..., argN); s = String.format(\"extension.%s(\", method.getName()); code.append(s); // ç”Ÿæˆextensionè°ƒç”¨æ–¹æ³•ä¸­çš„å‚æ•° æ‹¼æ¥ï¼Œæ³¨æ„å’Œç”Ÿæˆæ–¹æ³•ç­¾åçš„å‚æ•°åä¿æŒä¸€ç›´ for (int i = 0; i &lt; pts.length; i++) &#123; if (i != 0) &#123; code.append(\", \"); &#125; code.append(\"arg\").append(i); &#125; code.append(\");\"); &#125; //------------------------------------------- 8 ç”Ÿæˆæ–¹æ³•ç­¾åï¼ŒåŒ…è£¹æ–¹æ³•ä½“å†…å®¹ ---------------------------------------/ // ç”Ÿæˆæ–¹æ³•ç­¾åï¼Œæ ¼å¼ï¼špublic + è¿”å›å€¼å…¨é™å®šå + æ–¹æ³•å +( codeBuilder.append(\"\\npublic \").append(rt.getCanonicalName()).append(\" \").append(method.getName()).append(\"(\"); // ç”Ÿæˆæ–¹æ³•ç­¾åçš„å‚æ•°åˆ—è¡¨ for (int i = 0; i &lt; pts.length; i++) &#123; if (i &gt; 0) &#123; codeBuilder.append(\", \"); &#125; codeBuilder.append(pts[i].getCanonicalName()); codeBuilder.append(\" \"); codeBuilder.append(\"arg\").append(i); &#125; codeBuilder.append(\")\"); // ç”Ÿæˆå¼‚å¸¸æŠ›å‡ºä»£ç  if (ets.length &gt; 0) &#123; codeBuilder.append(\" throws \"); for (int i = 0; i &lt; ets.length; i++) &#123; if (i &gt; 0) &#123; codeBuilder.append(\", \"); &#125; codeBuilder.append(ets[i].getCanonicalName()); &#125; &#125; // æ–¹æ³•å¼€å§‹ç¬¦å· codeBuilder.append(\" &#123;\"); // åŒ…æ‹¬æ–¹æ³•ä½“å†…å®¹ codeBuilder.append(code.toString()); // è¿½åŠ æ–¹æ³•ç»“æŸç¬¦å· codeBuilder.append(\"\\n&#125;\"); &#125; // è¿½åŠ ç±»çš„ç»“æŸç¬¦å·ï¼Œç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»ç»“æŸ codeBuilder.append(\"\\n&#125;\"); if (logger.isDebugEnabled()) &#123; logger.debug(codeBuilder.toString()); &#125; return codeBuilder.toString(); &#125; ä¸Šé¢çš„ä»£ç é€»è¾‘å°±ä¸€ä¸ªä»»åŠ¡ï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•ç±»ä¸²ï¼Œæ¢³ç†å‡ºæ¥åå¹¶æ²¡æœ‰é‚£ä¹ˆå¤æ‚ï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§ç¼–å†™ä¸€ä¸ªç±»çš„æ­¥éª¤è¿›è¡Œæ‹¼æ¥çš„ã€‚å¦‚æœéè¦è¯´å¤æ‚çš„è¯ï¼Œé‚£ä¹ˆå°±æä½“ç°åœ¨æ‹¼æ¥æ‰©å±•åçš„é€»è¾‘ä»£ç ä¸­ï¼Œå› ä¸ºæƒ…å†µéå¸¸å¤šï¼Œèƒ–å‹ä»¬å¯ä»¥å¤šè°ƒè¯•å¤šå½’ç±»ã€‚æƒ³è¦è§‚å¯Ÿç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•ç±»æœ‰ä¸¤ç§åŠæ³•ï¼Œæ—¥å¿—çº§åˆ«è®¾ç½®æˆdebugæ˜¯ä¸€ç§ç®€å•ç²—æš´çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥ä½¿ç”¨åç¼–è¯‘å·¥å…·è¿›è¡ŒæŸ¥çœ‹ã€‚ æ€»ç»“æœ¬ç¯‡æ–‡ç« ä¸»è¦åˆ†æäº†è‡ªåŠ¨ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•ç±»çš„åŸç†ï¼Œä»¥åŠè¯¦ç»†åˆ†æäº†ç”Ÿæˆä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•ç±»çš„è¿‡ç¨‹ï¼Œæ€»ä½“æ¥è¯´è¿˜æ˜¯å¾ˆå¤æ‚çš„ã€‚è‡³äºä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ä»£ç†çš„æ–¹å¼ç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»ï¼Œä¸»è¦çš„åŸå› æ˜¯ä»£ç†æ–¹å¼æ•ˆç‡å¤ªä½ï¼Œæ›´è¯¦ç»†çš„å¯ä»¥å‚è€ƒæ¢é£å¤§ä½¬çš„åšå®¢ åŠ¨æ€ä»£ç†æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”ã€‚è‡ªé€‚åº”æ‰©å±•è¿˜æ²¡ç»“æŸï¼Œæˆ‘ä»¬è™½ç„¶æœ‰äº†ä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•ç±»çš„å­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿˜éœ€è¦å¯¹è¿™ä¸ªå­—ç¬¦ä¸²è¿›è¡Œç¼–è¯‘å¤„ç†æˆClassï¼Œè¿™æ ·æ‰èƒ½åˆ›å»ºä¸€ä¸ªå¯¹è±¡è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å°±æ¥åˆ†ædubboçš„åŠ¨æ€ç¼–è¯‘åŸç†ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"SPI","slug":"SPI","permalink":"https://gentryhuang.com/tags/SPI/"}]},{"title":"Dubboæºç åˆ†æ - Dubbo SPI","slug":"rpc/spiæœºåˆ¶ä¹‹dubbo","date":"2020-03-12T16:00:00.000Z","updated":"2020-09-05T14:06:44.015Z","comments":false,"path":"posts/5d81f464/","link":"","permalink":"https://gentryhuang.com/posts/5d81f464/","excerpt":"","text":"æ¦‚è¿°dubboå¹¶æœªä½¿ç”¨jdkæ ‡å‡†çš„SPIæœºåˆ¶ï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡Œäº†å¢å¼ºï¼Œä¼˜åŒ–äº†æ€§èƒ½é—®é¢˜å¹¶ä¸”ç›¸æ¯”jdk spiæ›´åŠ å¥å£®ã€‚ dubbo spi å¯¹ jdk spiçš„æ”¹è¿› JDK æ ‡å‡†çš„ SPI ä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰©å±•ç‚¹æ‰€æœ‰å®ç°ï¼Œå¦‚æœæœ‰æ‰©å±•å®ç°åˆå§‹åŒ–å¾ˆè€—æ—¶ï¼Œä½†å¦‚æœæ²¡ç”¨ä¸Šä¹ŸåŠ è½½ï¼Œä¼šå¾ˆæµªè´¹èµ„æºï¼Œè€Œdubboå¯ä»¥é€‰æ‹©æ€§å®ä¾‹åŒ–ã€‚ å¦‚æœæ‰©å±•ç‚¹åŠ è½½å¤±è´¥ï¼Œè¿æ‰©å±•ç‚¹çš„åç§°éƒ½æ‹¿ä¸åˆ°äº†ã€‚æ¯”å¦‚ï¼šJDKæ ‡å‡†çš„ ScriptEngineï¼Œé€šè¿‡ getName() è·å–è„šæœ¬ç±»å‹çš„åç§°ï¼Œä½†å¦‚æœRubyScriptEngine å› ä¸ºæ‰€ä¾èµ–çš„ jruby.jar ä¸å­˜åœ¨ï¼Œå¯¼è‡´ RubyScriptEngine ç±»åŠ è½½å¤±è´¥ï¼Œè¿™ä¸ªå¤±è´¥åŸå› è¢«åƒæ‰äº†ï¼Œå’Œ ruby å¯¹åº”ä¸èµ·æ¥ï¼Œå½“ç”¨æˆ·æ‰§è¡Œ ruby è„šæœ¬æ—¶ä¼šæŠ¥ä¸æ”¯æŒrubyï¼Œè€Œä¸æ˜¯çœŸæ­£å¤±è´¥çš„åŸå› ã€‚ å¢åŠ äº†å¯¹æ‰©å±•ç‚¹ IoC å’Œ AOP çš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥ç›´æ¥ setter æ³¨å…¥å…¶å®ƒæ‰©å±•ç‚¹ã€‚ åŸå§‹jdk spi ä¸æ”¯æŒç¼“å­˜ï¼Œdubboè®¾è®¡äº†å¤šç»´åº¦ç¼“å­˜ï¼Œæé«˜äº†æ¡†æ¶çš„æ€§èƒ½ã€‚ dubbo spi é…ç½®è§„èŒƒ spié…ç½®æ–‡ä»¶è·¯å¾„ 123META-INF&#x2F;dubbo&#x2F;internal : ä¸»è¦ç”¨äº Dubbo å†…éƒ¨æä¾›çš„æ‹“å±•ç‚¹å®ç°META-INF&#x2F;dubbo : ä¸»è¦ç”¨äºè‡ªå®šä¹‰æ‰©å±•ç‚¹å®ç°META-INF&#x2F;services : ç”¨äºå…¼å®¹jdkçš„spi è¯´æ˜: ä¸Šé¢çš„spié…ç½®æ–‡ä»¶è·¯å¾„æ˜¯ç§è§„èŒƒï¼Œå®é™…ä¸Šåœ¨ä½¿ç”¨çš„æ—¶å€™å†™åœ¨å“ªä¸ªæ–‡ä»¶ä¸‹éƒ½å¯ä»¥è¢«åŠ è½½åˆ°ï¼Œä½†æ˜¯å®é™…å¼€æ”¾ç§æœ€å¥½æŒ‰ç…§è§„èŒƒé…ç½®ã€‚ spié…ç½®æ–‡ä»¶åç§° 1æ‰©å±•ç‚¹å…¨è·¯å¾„å æ–‡ä»¶å†…å®¹ 12key&#x3D;valueå½¢å¼ï¼Œå¤šä¸ªä½¿ç”¨æ¢è¡Œç¬¦åˆ†å‰²ï¼Œè¿™æ˜¯dubboé…ç½®çš„æ–¹å¼valueå½¢å¼ï¼Œæ²¡æœ‰æŒ‡å®šæ‰©å±•åï¼Œè¿™æ˜¯jdké…ç½®æ–¹å¼ï¼Œdubboè¿›è¡Œäº†å…¼å®¹ï¼Œä¼šè‡ªåŠ¨ä¸ºæ‰©å±•å®ç°ç±»ç”Ÿæˆé»˜è®¤çš„æ‰©å±•å è¯´æ˜: dubbo spi é€šè¿‡é”®å€¼å¯¹çš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æŒ‰éœ€å®ä¾‹åŒ–æ‰©å±•ç‚¹çš„å®ç°ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡å®ä¾‹åŒ–æ‰€æœ‰çš„æ‰©å±•å®ç°ç±»ã€‚ åŠ è½½æ‰©å±•å®ç°1dubboä½¿ç”¨ExtensionLoaderåŠ è½½æŒ‡å®šå®ç°ç±»ï¼Œdubbo spiçš„é€»è¾‘å‡ ä¹éƒ½å°è£…åœ¨è¯¥ç±»ä¸­ã€‚ ç¤ºä¾‹å‰é¢ç®€å•ä»‹ç»äº†dubbo spiæœºåˆ¶ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥æ¼”ç¤ºdubbo spiçš„ç®€å•ç”¨æ³•ã€‚æ‰©å±•ç‚¹æ¥å£åŠå®ç°å¤ç”¨ spiæœºåˆ¶ä¹‹jdkç¤ºä¾‹ ä¸­ä»£ç ï¼ŒåŒºåˆ«æ˜¯dubbo spiçš„æ¥å£ä½¿ç”¨@SPIæ³¨è§£è¿›è¡Œæ ‡æ³¨ã€‚ å®šä¹‰æ‰©å±•æ¥å£ï¼Œä½¿ç”¨@SPIæ³¨è§£è¿›è¡Œæ ‡æ³¨ 123456789package com.alibaba.dubbo.spi;@SPIpublic interface Command &#123; /** * æ‰§è¡Œæ–¹æ³• */ void execute();&#125; åœ¨META-INF/dubboæ–‡ä»¶ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œåç§°ä¸ºCommandçš„å…¨è·¯å¾„å com.alibaba.dubbo.spi.Commandã€‚ é…ç½®å†…å®¹ä¸ºæ‰©å±•å®ç°ç±»åŠå…¶æ‰©å±•åï¼Œå¦‚ä¸‹ï¼š 12start&#x3D;com.alibaba.dubbo.spi.impl.StartCommandshutdown&#x3D;com.alibaba.dubbo.spi.impl.ShutdownCommand å‡†å¤‡å°±ç»ªåï¼Œæœ€åå†™æµ‹è¯•ä»£ç ï¼Œå¦‚ä¸‹ï¼š 123456789101112131415public class Main &#123; public static void main(String[] args) &#123; // ExtensionLoaderæ˜¯dubboæä¾›çš„ï¼Œç”¨æ¥åŠ è½½æ‹“å±•å®ç°ç±» ExtensionLoader&lt;Command&gt; extensionLoader = ExtensionLoader.getExtensionLoader(Command.class); // åŠ è½½æŒ‡å®šæ‰©å±•åå¯¹åº”çš„æ‰©å±•å®ç°å¯¹è±¡ï¼ˆè·å–çš„æ—¶å€™ä¼šè¿›è¡Œå®ä¾‹åŒ–ï¼‰ Command startCommand = extensionLoader.getExtension(\"start\"); startCommand.execute(); Command shutdownCommand = extensionLoader.getExtension(\"shutdown\"); shutdownCommand.execute(); &#125;&#125; æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š 1234start commandshut down commandProcess finished with exit code 0 ç®€å•è¯´æ˜å’Œæ¼”ç¤ºdubbo spiåï¼Œæˆ‘ä»¬å¯¹dubbo spiæœ‰äº†ä¸€å®šçš„è®¤è¯†ï¼Œä½¿ç”¨èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ¥ä¸‹æ¥è¿›å…¥æºç åˆ†æé˜¶æ®µï¼Œè®©æˆ‘ä»¬ä¸€èµ·å»çœ‹çœ‹dubboåº•å±‚æ˜¯æ€ä¹ˆåŠ è½½å’Œé€‰æ‹©æ‰©å±•å®ç°çš„ã€‚ dubbo spi æºç åˆ†æè¿›è¡Œæºç åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹dubbo spiæ•´ä½“çš„ä»£ç ç»“æ„ï¼Œç„¶åå¯¹æ ¸å¿ƒæ³¨è§£å’Œç±»è¿›è¡Œè¯´æ˜ã€‚ ä»£ç ç»“æ„ æ‰©å±•ç‚¹ SPI æ³¨è§£æ‰©å±•ç‚¹æ¥å£æ ‡è¯†ï¼Œdubboçš„æ‰©å±•ç‚¹å¿…é¡»æ ‡æ³¨è¯¥æ³¨è§£ï¼Œå¦åˆ™åœ¨æ‰§è¡Œspié€»è¾‘æ—¶æ¡†æ¶ä¼šæŠ¥å¼‚å¸¸ã€‚ 1234567891011@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE&#125;)public @interface SPI &#123; /** * @return ç¼ºçœæ‰©å±•å */ String value() default \"\";&#125; SPIæ³¨è§£çš„valueå±æ€§æ˜¯ç”¨æ¥æŒ‡å®šæ‰©å±•ç‚¹çš„é»˜è®¤æ‰©å±•åï¼Œå¦‚Protocolæ‰©å±•æ¥å£ï¼š 12@SPI(\"dubbo\")public interface Protocol &#123;//...&#125; // dubboå¯¹åº”çš„æ‰©å±•å®ç°ç±»å°±æ˜¯DubboProtocolï¼Œå³Protocolé»˜è®¤çš„æ‰©å±•å®ç°ç±» æ‰©å±•ç‚¹ Adaptive æ³¨è§£12345678910111213141516171819@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)public @interface Adaptive &#123; /** * æ ¹æ®URLçš„Keyè·å–å¯¹åº”çš„Valueä½œä¸ºè‡ªé€‚åº”æ‹“å±•åã€‚æ¯”å¦‚ï¼Œ&lt;code&gt;String[] &#123;\"key1\", \"key2\"&#125;&lt;/code&gt;ï¼Œè¡¨ç¤º * &lt;ul&gt; * &lt;li&gt;å…ˆåœ¨URLä¸Šæ‰¾key1çš„Valueä½œä¸ºè‡ªé€‚åº”æ‹“å±•åï¼› * &lt;li&gt;key1æ²¡æœ‰valueï¼Œåˆ™ä½¿ç”¨key2çš„valueä½œä¸ºè‡ªé€‚åº”æ‹“å±•åã€‚ * &lt;li&gt;key2æ²¡æœ‰valueï¼Œå°±ä½¿ç”¨ç¼ºçœçš„æ‰©å±•ï¼Œå³ï¼š å¦‚æœ&#123;@link URL&#125;è¿™äº›Keyéƒ½æ²¡æœ‰valueï¼Œä½¿ç”¨ç¼ºçœçš„æ‰©å±•ï¼ˆåœ¨æ¥å£çš„&#123;@link SPI&#125;ä¸­è®¾å®šçš„å€¼ï¼‰ * &lt;li&gt;å¦‚æœæ²¡æœ‰è®¾ç½®ç¼ºçœæ‰©å±•åæˆ–è€…ç¼ºçœæ‰©å±•åä¹Ÿæ²¡æœ‰valueï¼Œåˆ™æ–¹æ³•è°ƒç”¨ä¼šæŠ›å‡º&#123;@link IllegalStateException&#125;ã€‚ * &lt;/ul&gt; * æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰ä½¿ç”¨Adaptiveæ³¨è§£æŒ‡å®šæ‰©å±•åï¼Œæ‰©å±•æ¥å£ä¹Ÿæ²¡æœ‰æŒ‡å®š@SPIé»˜è®¤å€¼ï¼Œåˆ™åœ¨åŠ è½½æ‰©å±•å®ç°çš„æ—¶å€™dubboä¼šè‡ªåŠ¨æŠŠæ‰©å±•æ¥å£åç§°æ ¹æ®é©¼å³°å¤§å°å†™åˆ†å¼€ï¼Œå¹¶ä½¿ç”¨ '.' ç¬¦å·è¿æ¥èµ·æ¥ï¼Œ * ä»¥æ­¤åç§°ä½œä¸ºé»˜è®¤æ‰©å±•åã€‚å¦‚ï¼šSimpleExt -&gt; simple.ext * * @return parameter key names in URL */ String[] value() default &#123;&#125;;&#125; ä¸€ä¸ªæ‹“å±•æ¥å£ï¼Œåœ¨æ¡†æ¶ä¸­åŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ª Adaptive æ‹“å±•å®ç°ç±»ï¼Œå¯èƒ½æ˜¯å›ºå®šçš„æ‰©å±•å®ç°ç±»ï¼Œä¹Ÿå¯èƒ½æ˜¯è‡ªåŠ¨ç”Ÿæˆã€ç¼–è¯‘å¾—åˆ°çš„æ‰©å±•å®ç°ç±»ã€‚@Adaptive æ³¨è§£ï¼Œå¯æ·»åŠ ç±»æˆ–æ–¹æ³•ä¸Šï¼Œåˆ†åˆ«ä»£è¡¨äº†ä¸¤ç§ä¸åŒçš„ä½¿ç”¨æ–¹å¼ã€‚ç¬¬ä¸€ç§ï¼Œæ ‡è®°åœ¨ç±»ä¸Šï¼ˆå±äºè£…é¥°ç±»ï¼‰ï¼Œæ•´ä¸ªå®ç°ç±»ä¼šä½œä¸ºè‡ªé€‚åº”æ‰©å±•ç±»ï¼Œdubboä¸ä¼šä¸ºè¯¥ç±»ç”Ÿæˆä»£ç†ç±»ï¼Œå®ƒä¸»è¦ç”¨äºå›ºå®šå·²çŸ¥ç±»ã€‚ç›®å‰ Dubbo é¡¹ç›®é‡Œï¼Œåªæœ‰ ExtensionFactory æ‹“å±•çš„å®ç°ç±» AdaptiveExtensionFactory å’ŒCompiler æ‹“å±•çš„å®ç°AdaptiveCompilerè¿™ä¹ˆä½¿ç”¨ã€‚ç¬¬äºŒç§ï¼Œæ ‡è®°åœ¨æ‰©å±•æ¥å£çš„æ–¹æ³•ä¸Šï¼Œä»£è¡¨è‡ªåŠ¨ç”Ÿæˆã€ç¼–è¯‘ä¸€ä¸ªè¯¥æ¥å£çš„åŠ¨æ€Adaptiveæ‹“å±•å®ç°ç±»ï¼ˆå±äºåŠ¨æ€ä»£ç†ç±»ï¼Œå¦‚Protocol$Adaptiveï¼‰ï¼Œä¸€èˆ¬è¯¥ç±»æ²¡æœ‰å®é™…çš„å·¥ä½œï¼Œåªæ˜¯æ ¹æ®å‚æ•°å’Œè¿è¡ŒçŠ¶æ€åŠ è½½å…¶ä»–çš„æ‰©å±•å®ç°æ¥å®Œæˆæœ€ç»ˆçš„å·¥ä½œã€‚ æ‰©å±•ç‚¹ Activate æ³¨è§£1234567891011121314151617181920212223242526272829303132333435@Documented@Retention(RetentionPolicy.RUNTIME)@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)public @interface Activate &#123; /** * groupè¿‡æ»¤æ¡ä»¶ã€‚åœ¨è°ƒç”¨&#123;@link ExtensionLoader#getActivateExtension(URL, String, String)&#125; æ–¹æ³•æ—¶ï¼Œå¦‚æœä¼ å…¥çš„groupå‚æ•°ç¬¦åˆè¯¥æ³¨è§£è®¾ç½®çš„groupå±æ€§å€¼ï¼Œåˆ™åŒ¹é…ã€‚ */ String[] group() default &#123;&#125;; /** * keyè¿‡æ»¤æ¡ä»¶ã€‚åœ¨è°ƒç”¨&#123;@link ExtensionLoader#getActivateExtension(URL, String, String)&#125; æ–¹æ³•æ—¶ï¼Œå¦‚æœurlä¸­çš„å‚æ•°ä¸­å­˜åœ¨è¯¥æ³¨è§£è®¾ç½®çš„keyå€¼ï¼Œåˆ™åŒ¹é…ã€‚ */ String[] value() default &#123;&#125;; /** * æ’åºå±æ€§ * * @return extension list which should be put before the current one */ String[] before() default &#123;&#125;; /** * æ’åºå±æ€§ * * @return extension list which should be put after the current one */ String[] after() default &#123;&#125;; /** * æ’åºå±æ€§ * * @return absolute ordering info */ int order() default 0;&#125; è¯¥æ³¨è§£ç”¨äºè®¾ç½®æ‰©å±•å®ç°ç±»è¢«è‡ªåŠ¨æ¿€æ´»çš„åŠ è½½æ¡ä»¶ï¼Œå¦‚ï¼šè¿‡æ»¤å™¨æ‰©å±•ç‚¹æœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨è¯¥æ³¨è§£è®¾ç½®æ¿€æ´»æ¡ä»¶ï¼Œåœ¨è·å–è‡ªåŠ¨æ¿€æ´»æ‰©å±•å®ç°æ—¶éœ€è¦ç¬¦åˆæ¡ä»¶æ‰èƒ½è·å–åˆ°ã€‚æ¡†æ¶é€šè¿‡ExtensionLoader#getActivateExtensionæ–¹æ³•è·å¾—æ¿€æ´»æ¡ä»¶çš„æ‰©å±•å®ç°é›†åˆã€‚ ExtensionLoaderdubboçš„æ‰©å±•åŠ è½½å™¨ï¼Œdubbo spi çš„ç›¸å…³é€»è¾‘å‡ ä¹éƒ½è¢«å°è£…åœ¨è¯¥ç±»ä¸­ï¼Œè¯¥ç±»æ˜¯ dubbo spi çš„ æ ¸å¿ƒã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136public class ExtensionLoader&lt;T&gt; &#123; //========================================= ç±»å±æ€§ï¼Œæ‰€æœ‰ExtensionLoaderå¯¹è±¡å…±äº« ================================================ /** * dubboæ‰©å±•ç‚¹ç›®å½• ï¼Œè¯¥ç›®å½•æ˜¯ä¸ºäº†å…¼å®¹jdkçš„spi */ private static final String SERVICES_DIRECTORY = \"META-INF/services/\"; /** * dubboæ‰©å±•ç‚¹ç›®å½•ï¼Œä¸»è¦ç”¨äºè‡ªå®šä¹‰æ‰©å±•ç‚¹å®ç° */ private static final String DUBBO_DIRECTORY = \"META-INF/dubbo/\"; /** * dubboæ‰©å±•ç‚¹ç›®å½•ï¼Œç”¨äº Dubbo å†…éƒ¨æä¾›çš„æ‹“å±•ç‚¹å®ç° */ private static final String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + \"internal/\"; /** * æ‰©å±•ç‚¹å®ç°åçš„åˆ†éš”ç¬¦ æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¤šä¸ªæ‰©å±•ç‚¹åä¹‹é—´ä½¿ç”¨ ',' è¿›è¡Œåˆ†å‰² */ private static final Pattern NAME_SEPARATOR = Pattern.compile(\"\\\\s*[,]+\\\\s*\"); /** * æ‰©å±•ç‚¹åŠ è½½å™¨é›†åˆ * key: æ‹“å±•ç‚¹æ¥å£ * value: æ‰©å±•ç‚¹åŠ è½½å™¨ã€‚ ä¸€ä¸ªæ‰©å±•ç‚¹æ¥å£å¯¹åº”ä¸€ä¸ª æ‰©å±•ç‚¹åŠ è½½å™¨ */ private static final ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = new ConcurrentHashMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt;(); /** * æ‰©å±•ç‚¹å®ç°ç±»é›†åˆ * key: æ‰©å±•ç‚¹å®ç°ç±» * value: æ‰©å±•ç‚¹å®ç°å¯¹è±¡ * è¯´æ˜ï¼š * ä¸€ä¸ªæ‰©å±•ç‚¹é€šè¿‡å¯¹åº”çš„ExtensionLoaderå»åŠ è½½å®ƒçš„å…·ä½“å®ç°ï¼Œè€ƒè™‘åˆ°æ€§èƒ½å’Œèµ„æºé—®é¢˜ï¼Œåœ¨åŠ è½½æ‹“å±•é…ç½®åä¸ä¼šç«‹é©¬è¿›è¡Œæ‰©å±•å®ç°çš„å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œè€Œæ˜¯å…ˆæŠŠæ‰©å±•é…ç½®å­˜èµ·æ¥ã€‚ * ç­‰åˆ°çœŸæ­£ä½¿ç”¨å¯¹åº”çš„æ‹“å±•å®ç°æ—¶æ‰è¿›è¡Œæ‰©å±•å®ç°çš„å¯¹è±¡çš„åˆå§‹åŒ–ï¼Œåˆå§‹åŒ–åä¹Ÿè¿›è¡Œç¼“å­˜ã€‚å³ï¼š * 1 ç¼“å­˜åŠ è½½çš„æ‹“å±•é…ç½® * 2 ç¼“å­˜åˆ›å»ºçš„æ‹“å±•å®ç°å¯¹è±¡ */ private static final ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; EXTENSION_INSTANCES = new ConcurrentHashMap&lt;Class&lt;?&gt;, Object&gt;(); // ============================== å®ä¾‹å±æ€§ ï¼Œæ¯ä¸ªExtensionLoaderå¯¹è±¡ç‹¬æœ‰ ==================================================== /** * æ‰©å±•ç‚¹ï¼Œå¦‚ï¼šProtocol */ private final Class&lt;?&gt; type; /** * æ‰©å±•ç‚¹å®ç°å·¥å‚ï¼Œç”¨äºå‘æ‰©å±•å¯¹è±¡ä¸­æ³¨å…¥ä¾èµ–å±æ€§ï¼Œä¸€èˆ¬é€šè¿‡è°ƒç”¨ &#123;@link #injectExtension(Object)&#125; æ–¹æ³•è¿›è¡Œå®ç°ã€‚ * ç‰¹åˆ«è¯´æ˜ï¼š * é™¤äº†ExtensionFactoryæ‰©å±•æ¥å£ï¼Œå…¶ä½™çš„æ‰€æœ‰æ‰©å±•æ¥å£çš„ExtensionLoaderå¯¹è±¡éƒ½ä¼šæ‹¥æœ‰ä¸€ä¸ªè‡ªå·±çš„æ‰©å±•å·¥å‚ï¼Œå³ objectFactory = AdaptiveExtensionFactoryï¼› * @see ExtensionLoader æ„é€ æ–¹æ³• */ private final ExtensionFactory objectFactory; /** * æ‰©å±•ç‚¹å®ç°ç±» åˆ° æ‰©å±•å çš„æ˜ å°„ * å¦‚ï¼š * dubbo=dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol ===&gt; &lt;DubboProtocol,dubbo&gt; */ private final ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = new ConcurrentHashMap&lt;Class&lt;?&gt;, String&gt;(); /** * æ‰©å±•å åˆ° æ‰©å±•ç‚¹å®ç°ç±» çš„æ˜ å°„ * ä¸åŒ…æ‹¬ä»¥ä¸‹ä¸¤ç§ç±»å‹ï¼š * 1 è‡ªé€‚åº”æ‰©å±•å®ç°ç±»ï¼Œå¦‚ï¼šAdaptiveExtensionFactory * 2 æ‰©å±•ç‚¹çš„Wrapperå®ç°ç±»ï¼Œå¦‚ï¼šProtocolFilterWrapper * å¦‚ï¼š * dubbo=dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol ===&gt; &lt;dubbo,DubboProtocol&gt; */ private final Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = new Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;(); /** * æ‰©å±•å åˆ° @Activateæ³¨è§£ çš„æ˜ å°„ï¼Œ å¦‚ï¼š ContextFilter -&gt; Activate */ private final Map&lt;String, Activate&gt; cachedActivates = new ConcurrentHashMap&lt;String, Activate&gt;(); /** * æ‰©å±•å åˆ° æ‰©å±•ç‚¹å®ç°å¯¹è±¡ çš„æ˜ å°„ * å¦‚ï¼š * dubbo=dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol ===&gt; &lt;dubbo,Holder&lt;DubboProtocolå¯¹è±¡&gt;&gt; */ private final ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = new ConcurrentHashMap&lt;String, Holder&lt;Object&gt;&gt;(); /** * è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ * æ³¨æ„: ä¸€ä¸ªæ‰©å±•ç‚¹æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•å¯¹è±¡ï¼Œ&gt; 1 æ¡†æ¶å°±ä¼šæŠ¥é”™ */ private final Holder&lt;Object&gt; cachedAdaptiveInstance = new Holder&lt;Object&gt;(); /** * è‡ªé€‚åº”æ‰©å±•å®ç°ç±» &#123;@link #getAdaptiveExtensionClass()&#125; */ private volatile Class&lt;?&gt; cachedAdaptiveClass = null; /** * æ‰©å±•ç‚¹çš„é»˜è®¤æ‰©å±•åï¼Œé€šè¿‡ &#123;@link SPI&#125; æ³¨è§£è·å¾— */ private String cachedDefaultName; /** * åˆ›å»ºè‡ªé€‚åº”å¯¹è±¡æ—¶å‘ç”Ÿçš„å¼‚å¸¸ -&gt; &#123;@link #createAdaptiveExtension()&#125; */ private volatile Throwable createAdaptiveInstanceError; /** * æ‰©å±•ç‚¹Wrapperå®ç°ç±»é›†åˆï¼Œå¦‚ï¼šProtocolFilterWrapper */ private Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses; /** * æ‰©å±•å åˆ° åŠ è½½å¯¹åº”æ‰©å±•ç±»å‘ç”Ÿçš„å¼‚å¸¸ çš„æ˜ å°„ */ private Map&lt;String, IllegalStateException&gt; exceptions = new ConcurrentHashMap&lt;String, IllegalStateException&gt;(); /** * æ„é€ æ–¹æ³• * è¯´æ˜ï¼š * 1 ä»»æ„ä¸€ä¸ªæ‰©å±•ç‚¹åœ¨è·å–å¯¹åº”çš„ExtensionLoaderæ—¶ï¼Œéƒ½ä¼šå…ˆå°è¯•è·å–å±äºå®ƒçš„ExtensionFactoryè‡ªé€‚åº”æ‰©å±•ï¼Œå³ AdaptiveExtensionFactoryï¼Œ * å®ƒç®¡ç†ç€SpiExtensionFactoryå’ŒSpringExtensionFactoryè¿™ä¸¤å¤§æ‰©å±•ç‚¹å·¥å‚ï¼Œç”¨äºè°ƒç”¨ &#123;@link #injectExtension(Object)&#125;æ–¹æ³•ï¼Œå‘æ‰©å±•å®ç°ä¸­æ³¨å…¥ä¾èµ–å±æ€§ï¼Œ * éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒSpiExtensionFactoryå’ŒSpringExtensionFactoryè·å¾—å¯¹è±¡æ˜¯ä¸åŒçš„ï¼Œå‰è€…è·å–è‡ªé€‚åº”å¯¹è±¡ï¼Œåè€…ä»Springå®¹å™¨ä¸­è·å–å¯¹è±¡ã€‚ * 2 å½“æ‰©å±•ç‚¹æ˜¯ExtensionFactoryæ—¶ï¼Œé‚£ä¹ˆå®ƒçš„å¯¹åº”çš„ExtensionLoaderçš„objectFactory å±æ€§ä¸ºnull * * @param type æ‰©å±•ç‚¹ */ private ExtensionLoader(Class&lt;?&gt; type) &#123; this.type = type; objectFactory = (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension()); &#125; // çœç•¥å…¶å®ƒä»£ç ...&#125; åŸºäºæ€§èƒ½çš„è€ƒè™‘ï¼Œdubbo spiç›¸æ¯”è¾ƒä¸jdk spiçš„ä¸€ä¸ªæ”¹è¿›å°±æ˜¯ä½¿ç”¨äº†å¤§é‡çš„ç¼“å­˜ï¼Œdubbo spi ç¼“å­˜ä»å¤§çš„æ–¹å‘å¯åˆ†ä¸º ç±»ç¼“å­˜ã€å®ä¾‹ç¼“å­˜ï¼Œè¿™ä¸¤ç§ç¼“å­˜åˆèƒ½æ ¹æ®æ‰©å±•å®ç°ç±»çš„ç§ç±»åˆ†ä¸º æ™®é€šæ‰©å±•ç¼“å­˜ã€åŒ…è£…æ‰©å±•ç¼“å­˜ã€è‡ªé€‚åº”æ‰©å±•ç¼“å­˜ã€‚ ç±»ç¼“å­˜ dubbo spiåœ¨æŸ¥è¯¢æ‰©å±•ç±»æ—¶ï¼Œä¼šå…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œå†åŠ è½½é…ç½®æ–‡ä»¶å¹¶åˆ†ç±»ç¼“å­˜ï¼Œæ³¨æ„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–æµç¨‹ã€‚ å®ä¾‹ç¼“å­˜ dubbo spiç¼“å­˜çš„Classæ˜¯æŒ‰éœ€è¿›è¡Œå®ä¾‹åŒ–çš„ï¼Œåœ¨æŸ¥è¯¢å®ä¾‹æ—¶ä¼šå…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœç¼“å­˜ä¸å­˜åœ¨åˆ™ä¼šè¿›è¡ŒåŠ è½½/åˆå§‹åŒ–ï¼Œç„¶åç¼“å­˜èµ·æ¥ã€‚ å¤šç±»å‹çš„æ‰©å±•ç‚¹æ ¹æ®æ‰©å±•å®ç°ç±»çš„ç‰¹ç‚¹åŠç”¨é€”å¯ä»¥åˆ†ä¸ºæ™®é€šæ‰©å±•ç±»ã€è‡ªåŠ¨æ¿€æ´»æ‰©å±•ç±»ã€åŒ…è£…æ‰©å±•ç±»ä»¥åŠè‡ªé€‚åº”æ‰©å±•ç±»ï¼Œå…¶ä¸­è‡ªåŠ¨æ¿€æ´»æ‰©å±•ç±»å±äºæ™®é€šæ‰©å±•ç±»ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé™¤äº†åŠ¨æ€ç¼–è¯‘å¾—åˆ°çš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œå…¶å®ƒçš„æ‰€æœ‰æ‰©å±•ç±»éƒ½éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ï¼Œå¦åˆ™æ¡†æ¶æ— æ³•åŠ è½½åˆ°ã€‚ä¸‹é¢æˆ‘ä»¬ç®€å•è¯´æ˜ä¸‹å„ä¸ªç±»å‹çš„æ‰©å±•ç±»åŠå…¶ç‰¹ç‚¹ã€‚ æ™®é€šæ‰©å±•ç±»å±äºæœ€åŸºç¡€çš„æ‰©å±•ç±»ï¼Œä¸€èˆ¬é€šè¿‡æ‰©å±•åè·å–å¯¹åº”çš„æ‰©å±•å®ç°å°±æ˜¯è¯¥ç±»å‹ã€‚åœ¨é…ç½®æ™®é€šæ‰©å±•ç±»æ—¶éœ€è¦æŒ‡å®šæ‰©å±•åï¼Œä¸æŒ‡å®šä¼šæŒ‰è§„åˆ™è‡ªåŠ¨ç”Ÿæˆï¼Œå› ä¸ºæ™®é€šæ‰©å±•å®ç°éƒ½æ˜¯æ ¹æ®æ‰©å±•åè·å–çš„ã€‚ åŒ…è£…æ‰©å±•ç±»åŒ…æ‹¬æ‰©å±•ç±»åˆå« Wrapperç±»ï¼Œä¸€èˆ¬ä¸æ˜¯æ‰©å±•ç‚¹çš„çœŸæ­£å®ç°ï¼Œä¸»è¦ç”¨æ¥å¯¹æ‰©å±•å®ç°è¿›è¡ŒåŠŸèƒ½å¢å¼ºæˆ–é€šç”¨é€»è¾‘å¤„ç†ã€‚Wrapperç±»æœ‰ä¸¤ä¸ªç‰¹å¾ï¼šå®ç°æ‰©å±•æ¥å£ã€å­˜åœ¨ä¸€ä¸ªå‚æ•°ç±»å‹æ˜¯æ‰©å±•ç‚¹çš„æ„é€ æ–¹æ³•ã€‚Wrapperç±»æ˜¯dubbo AOPçš„å®ç°ã€‚åœ¨é…ç½®Wrapperç±»æ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šæ‰©å±•åï¼Œå³ä½¿æŒ‡å®šäº†ä¹Ÿä¸ä¼šä½¿ç”¨ï¼Œä½†ä¸€èˆ¬æƒ…å†µæ ¹æ®dubbo spiçš„çº¦å®šè¿˜æ˜¯ç»Ÿä¸€é…ç½®ã€‚ è‡ªé€‚åº”ç±»è‡ªé€‚åº”ç±»éå¸¸çµæ´»ï¼Œä¹Ÿå« Adaptiveç±»ï¼Œæœ‰ä¸¤ç§å®ç°æ–¹å¼ã€‚Adaptiveç±»çš„ä¸¤ä¸ªç‰¹å¾ï¼šå®ç°æ‰©å±•æ¥å£ã€å®ç°ç±»æˆ–æ‰©å±•æ¥å£çš„æ–¹æ³•ä¸Šéœ€è¦ä½¿ç”¨ @Adaptive æ ‡æ³¨ã€‚ç±»ä¸Šæ ‡æ³¨@Adaptiveæ˜¯ä¸€ä¸ªAdaptiveç±»å¯ä»¥ç†è§£ï¼Œä½†æ˜¯æ‰©å±•æ¥å£çš„æ–¹æ³•ä¸Šæ ‡æ³¨@Adaptiveæ€ä¹ˆä¼šæ˜¯ä¸€ä¸ªç±»å‘¢ï¼Ÿæ˜¯å› ä¸ºæ ‡æ³¨åœ¨æ‰©å±•æ¥å£çš„æ–¹æ³•ä¸Šï¼Œdubbo spiæœºåˆ¶åœ¨è·å–è‡ªé€‚åº”æ‰©å±•å®ç°ç±»æ—¶ï¼Œå¦‚æœå½“å‰ç¯å¢ƒä¸­æ²¡æœ‰è‡ªé€‚åº”æ‰©å±•å®ç°ç±»å°±ä¼šå¯¹æ ‡æ³¨çš„æ–¹æ³•æ‰€åœ¨æ¥å£è¿›è¡Œjavassistæ“ä½œï¼Œç”Ÿæˆè‡ªé€‚åº”æ‰©å±•ç±»çš„å­—ç¬¦ä¸²ï¼Œç„¶åé€šè¿‡åŠ¨æ€ç¼–è¯‘æˆä¸€ä¸ªè‡ªé€‚åº”ç±»ã€‚@Adaptiveæ ‡æ³¨åœ¨æ‰©å±•æ¥å£çš„æ–¹æ³•ä¸Šçš„æ–¹å¼ï¼Œå¯ä»¥åŠ¨æ€åœ°é€šè¿‡URLä¸­çš„å‚æ•°æ¥ç¡®å®šä½¿ç”¨å“ªä¸ªæ‰©å±•å®ç°ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ä»¥ä¸æŒ‡å®šæ‰©å±•åï¼Œå³ä½¿æŒ‡å®šäº†ä¹Ÿä¸ä¼šä½¿ç”¨ï¼Œä½†ä¸€èˆ¬æƒ…å†µæ ¹æ®dubbo spiçš„çº¦å®šè¿˜æ˜¯ç»Ÿä¸€é…ç½®ã€‚ è‡ªåŠ¨æ¿€æ´»ç±»è‡ªåŠ¨æ¿€æ´»ç±»å±äºç‰¹æ®Šçš„æ™®é€šæ‰©å±•ç±»ï¼Œè¯¥ç±»çš„ä¸¤ä¸ªç‰¹å¾ï¼šå®ç°æ¥å£ã€ç±»ä¸Šä½¿ç”¨ @Activate æ ‡æ³¨ã€‚å®ƒæ”¯æŒæŸä¸ªæ‰©å±•ç‚¹éœ€è¦åŒæ—¶æ¿€æ´»å¤šä¸ªå®ç°çš„ç‰¹æ€§ï¼Œå¦‚ dubboä¸­çš„è¿‡æ»¤å™¨æ‰©å±•ç‚¹ï¼Œéœ€è¦æ¿€æ´»å¤šä¸ªæ‰©å±•å®ç°ã€‚ ExtensionLoader å·¥ä½œæµç¨‹ExtensionLoaderå°è£…äº†dubbo spiçš„ä¸»è¦é€»è¾‘ï¼Œé…ç½®çš„åŠ è½½ã€æ‰©å±•ç±»ç¼“å­˜ã€æ‰©å±•å®ç°çš„å®ä¾‹åŒ–åŠç¼“å­˜ã€è‡ªé€‚åº”ç±»çš„ç”Ÿæˆä¸ç¼–è¯‘åŠç¼“å­˜ã€è‡ªé€‚åº”å¯¹è±¡çš„å®ä¾‹åŒ–åŠç¼“å­˜ä»¥åŠdubbo iocå’Œaopçš„å®ç°ç­‰ã€‚è¿™äº›é€»è¾‘ä¸»è¦ä½“ç°åœ¨ä¸‰ä¸ªå…¥å£æ–¹æ³•ä¸­ï¼Œæ¯ä¸ªå…¥å£æ–¹æ³•è·å–åˆ°çš„æ‰©å±•å®ç°ç±»å‹ä¼šæœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æ–¹æ³•å†…éƒ¨é€»è¾‘æœ‰ç›¸åŒä¹‹å¤„ã€‚ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«ä»ä¸‰ä¸ªå…¥å£æ–¹æ³•å¼€å§‹è¯¦ç»†åˆ†ædubbo spiçš„æ•´ä¸ªæµç¨‹ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼ŒgetExtensionæ–¹æ³•æ˜¯æœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œå…¶å®ƒä¸¤ä¸ªå…¥å£æ–¹æ³•éƒ½ä¼šä¾èµ–è¯¥æ–¹æ³•ä¸­çš„éƒ¨åˆ†æµç¨‹ï¼Œå› æ­¤æˆ‘ä»¬ä¼šå…ˆåˆ†ægetExtensionæ–¹æ³•ï¼Œåœ¨åˆ†æå…¶å®ƒä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™æ¶‰åŠé‡å¤çš„æµç¨‹å°±ä¸å†åˆ†æã€‚ getExtension æ–¹æ³•ExtensionLoaderä¸­æœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œå› ä¸ºå®ƒå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„æŸ¥è¯¢æ‰©å±•å®ç°çš„é€»è¾‘ã€‚è·å–è¿‡ç¨‹ä¸­çš„æ¯ä¸€æ­¥éƒ½ä¼šå…ˆæ£€æŸ¥ç¼“å­˜æ˜¯å¦å‘½ä¸­ï¼Œå‘½ä¸­å°±ç›´æ¥è¿”å›æˆ–è¿›è¡Œèµ‹å€¼ï¼Œæ²¡æœ‰å‘½ä¸­åˆ™åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç„¶åç¼“å­˜é…ç½®æ–‡ä»¶ä¸­çš„æ‰©å±•å®ç°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940/** * è·å¾—æŒ‡å®šæ‰©å±•åçš„æ‰©å±•å¯¹è±¡ * * @param name æ‰©å±•å * @return */ @SuppressWarnings(\"unchecked\") public T getExtension(String name) &#123; if (name == null || name.length() == 0) &#123; throw new IllegalArgumentException(\"Extension name == null\"); &#125; // å¦‚æœå½“å‰æ‰©å±•åæ˜¯ 'true'ï¼Œå°±è·å–é»˜è®¤çš„æ‰©å±•å¯¹è±¡ if (\"true\".equals(name)) &#123; // æ–¹æ³•ç®€åŒ–ä¸º getExtension(cachedDefaultName) , cacheDefaultNameçš„å€¼å‚è§ @SPIæ³¨è§£ return getDefaultExtension(); &#125; // ä»ç¼“å­˜ä¸­è·å¾—å¯¹åº”çš„æ‰©å±•å¯¹è±¡ Holder&lt;Object&gt; holder = cachedInstances.get(name); if (holder == null) &#123; cachedInstances.putIfAbsent(name, new Holder&lt;Object&gt;()); holder = cachedInstances.get(name); &#125; Object instance = holder.get(); // ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œ åŒé‡æ£€é”è·å–æ‰©å±•åå¯¹åº”æ‰©å±•å®ç°å¯¹è±¡ if (instance == null) &#123; synchronized (holder) &#123; instance = holder.get(); if (instance == null) &#123; // ç¼“å­˜ä¸­ç¡®å®æ²¡æœ‰ï¼Œå°±åˆ›å»ºæ‰©å±•åå¯¹åº”çš„æ‰©å±•å®ç°å¯¹è±¡ instance = createExtension(name); // å°†æ‰©å±•å®ç°å¯¹è±¡æ”¾å…¥ç¼“å­˜ä¸­ holder.set(instance); &#125; &#125; &#125; return (T) instance; &#125; ä¸Šé¢çš„ä»£ç é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æ‰©å±•åè·å–æ‰©å±•å¯¹è±¡ï¼Œå…ˆæ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰ç›®æ ‡å¯¹è±¡ï¼Œæ²¡æœ‰åˆ™è°ƒç”¨ createExtensionæ–¹æ³•å¼€å§‹åˆ›å»ºæ‰©å±•å¯¹è±¡ã€‚éœ€è¦ç‰¹è¢«è¯´æ˜çš„æ˜¯ï¼Œå¦‚æœnameæ˜¯trueçš„æƒ…å†µï¼ŒåŠ è½½çš„å°±æ˜¯é»˜è®¤æ‰©å±•ç±»ã€‚é‚£ä¹ˆä¸‹é¢æˆ‘ä»¬æ¥åˆ†æcreateExtensionæ–¹æ³•æµç¨‹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253/** * åˆ›å»ºæ‰©å±•åå¯¹åº”çš„æ‰©å±•ç‚¹å®ç°å¯¹è±¡å¹¶ç¼“å­˜åˆ°ç±»å±æ€§çš„é›†åˆä¸­ * * @param name * @return */ @SuppressWarnings(\"unchecked\") private T createExtension(String name) &#123; // è·å–æ‰©å±•åå¯¹åº”çš„æ‰©å±•ç‚¹å®ç°ç±»ï¼Œå…ˆå°è¯•ä»ç¼“å­˜ä¸­å–å¯¹åº”çš„æ‰©å±•å®ç°ç±»ï¼Œæ²¡æœ‰çš„è¯å°±åŠ è½½é…ç½®æ–‡ä»¶ç„¶åå†æ¬¡è·å– Class&lt;?&gt; clazz = getExtensionClasses() .get(name); // æ²¡æœ‰æ‰¾åˆ°æ‰©å±•åå¯¹åº”çš„æ‰©å±•ç‚¹å®ç°ç±»ï¼Œåˆ™æŠ¥é”™ if (clazz == null) &#123; throw findException(name); &#125; try &#123; // ä»ç±»å±æ€§ç¼“å­˜é›†åˆä¸­å°è¯•è·å–æ‰©å±•ç‚¹å®ç°ç±»å¯¹åº”çš„å¯¹è±¡ T instance = (T) EXTENSION_INSTANCES.get(clazz); // å½“ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±é€šè¿‡åå°„åˆ›å»ºæ‰©å±•ç‚¹å®ç°ç±»å¯¹è±¡å¹¶æ”¾å…¥ç¼“å­˜ if (instance == null) &#123; EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance()); instance = (T) EXTENSION_INSTANCES.get(clazz); &#125; // dubbo iocå®ç°ï¼Œè¿›è¡Œsetteræ³¨å…¥ injectExtension(instance); /** * dubbo aopå®ç° * æ³¨æ„ï¼š * å¦‚æœå½“å‰æ‰©å±•ç‚¹å­˜åœ¨ Wrapperç±»ï¼Œé‚£ä¹ˆä»ExtensionLoader ä¸­è·å¾—çš„å®é™…ä¸Šæ˜¯ Wrapper ç±»çš„å®ä¾‹ï¼ŒWrapper æŒæœ‰äº†å®é™…çš„æ‰©å±•ç‚¹å®ç°ç±»ï¼Œå› æ­¤è°ƒç”¨æ–¹æ³•æ—¶è°ƒç”¨çš„æ˜¯Wrapperç±»ä¸­çš„æ–¹æ³•ï¼Œå¹¶éç›´æ¥è°ƒç”¨æ‰©å±•ç‚¹çš„çœŸæ­£å®ç°ã€‚ * å³ å¦‚æœåœ¨Wrapperçš„æ–¹æ³•ä¸­ä¸æ˜¾ç¤ºè°ƒç”¨æ‰©å±•ç‚¹çš„çœŸæ­£å®ç°çš„è¯ï¼Œé‚£ä¹ˆç»“æœä¸€å®šä¸æ˜¯é¢„æœŸçš„ã€‚ */ Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses; if (wrapperClasses != null &amp;&amp; !wrapperClasses.isEmpty()) &#123; for (Class&lt;?&gt; wrapperClass : wrapperClasses) &#123; // åˆ›å»º Wrapper å®ä¾‹ï¼Œç„¶åè¿›è¡Œ setteræ³¨å…¥ä¾èµ–å±æ€§ instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance)); &#125; &#125; return instance; &#125; catch (Throwable t) &#123; throw new IllegalStateException(\"Extension instance(name: \" + name + \", class: \" + type + \") could not be instantiated: \" + t.getMessage(), t); &#125; &#125; createExtension(String name)æ–¹æ³•çš„é€»è¾‘ä»£ç ä¸­å·²ç»è¯¦ç»†æ³¨é‡Šè¯´æ˜ï¼Œä¸‹é¢å°ç»“å…³é”®çš„æ­¥éª¤ï¼š è°ƒç”¨getExtensionClasses()åˆ·æ–°æ‰©å±•ç‚¹å®ç°ç±»é›†åˆ é€šè¿‡åå°„åˆ›å»ºæ‰©å±•ç‚¹çš„æ‰©å±•å¯¹è±¡å¹¶æ”¾å…¥ç±»ç¼“å­˜ä¸­ ä½¿ç”¨dubboçš„setteræ³¨å…¥å‘æ‰©å±•å¯¹è±¡ä¸­æ³¨å…¥ä¾èµ–å±æ€§ ä½¿ç”¨æ‰©å±•ç‚¹çš„Wrapperå¯¹æ‰©å±•å¯¹è±¡å®ç°dubboçš„aopå¤„ç†é€»è¾‘ é€šè¿‡æ‰©å±•åè·å–æ‰©å±•å¯¹è±¡æ—¶å¯èƒ½ä¸èƒ½å‘½ä¸­ç¼“å­˜ï¼Œæ­¤æ—¶å°±è¦åˆ›å»ºæ‰©å±•å¯¹è±¡ï¼Œåˆ›å»ºæ‰©å±•å¯¹è±¡éœ€è¦æ‰©å±•å®ç°ç±»ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹dubboè·å–æ‰©å±•ååˆ°æ‰©å±•å®ç°ç±»çš„æ˜ å°„é›†åˆã€‚ 123456789101112131415161718192021222324/** * è·å–æ‰©å±•ç‚¹å®ç°ç±»çš„é›†åˆï¼Œå…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œæ²¡æœ‰å‘½ä¸­ç¼“å­˜å°±ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½å¹¶åˆ†ç±»æ”¾å…¥ç¼“å­˜ã€‚ * * @return */ private Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() &#123; // å…ˆä»ç¼“å­˜ä¸­è·å– Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get(); // åŒé‡æ£€é”ï¼Œè·å–æ‰©å±•ç‚¹çš„æ‰©å±•å®ç°ç±»é›†åˆ if (classes == null) &#123; synchronized (cachedClasses) &#123; classes = cachedClasses.get(); if (classes == null) &#123; // åŠ è½½æ‰©å±•ç±» classes = loadExtensionClasses(); // å°† æ‰©å±•ååˆ°æ‰©å±•ç‚¹å®ç°ç±»çš„æ˜ å°„ åŠ å…¥åˆ° cachedClasses é›†åˆä¸­ï¼Œç¼“å­˜èµ·æ¥ cachedClasses.set(classes); &#125; &#125; &#125; return classes; &#125; å¦‚æœç¼“å­˜ä¸èƒ½å‘½ä¸­æ‰©å±•åå¯¹åº”çš„æ‰©å±•å®ç°ç±»å°±åªèƒ½åŠ è½½é…ç½®æ–‡ä»¶åˆ·æ–°æ‰©å±•ç‚¹å®ç°ç±»é›†åˆ,ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹dubboæ˜¯å¦‚ä½•åŠ è½½é…ç½®æ–‡ä»¶çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536private Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() &#123; //1ã€ é€šè¿‡@SPIæ³¨è§£è·å¾—æ‰©å±•ç‚¹çš„é»˜è®¤æ‰©å±•åï¼ˆå‰ææ˜¯å½“å‰æ‹“å±•ç‚¹éœ€è¦æœ‰@SPIæ³¨è§£ï¼Œå…¶å®ç¨‹åºæ‰§è¡Œåˆ°è¿™é‡Œtypeä¸€å®šæ˜¯æœ‰@SPIæ³¨è§£çš„ï¼Œå› ä¸ºåœ¨è·å–æ‰©å±•ç‚¹çš„æ‰©å±•åŠ è½½å™¨çš„æ—¶å€™å·²ç»åˆ¤æ–­äº†ï¼‰ final SPI defaultAnnotation = type.getAnnotation(SPI.class); //1.1 å¦‚æœæ‰©å±•ç‚¹çš„@SPIæ³¨è§£è®¾ç½®äº†é»˜è®¤å€¼ if (defaultAnnotation != null) &#123; // @SPIæ³¨è§£çš„å€¼å°±æ˜¯æ‰©å±•ç‚¹çš„é»˜è®¤æ‰©å±•å String value = defaultAnnotation.value(); if ((value = value.trim()).length() &gt; 0) &#123; // å¯¹é»˜è®¤æ‰©å±•åè¿›è¡Œåˆ†éš”å¤„ç†ï¼Œä»¥é€—å·åˆ†éš”ä¸ºå­—ç¬¦ä¸²æ•°ç»„ String[] names = NAME_SEPARATOR.split(value); // æ£€æµ‹ SPI æ³¨è§£å†…å®¹æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™æŠ›å‡ºå¼‚å¸¸ if (names.length &gt; 1) &#123; throw new IllegalStateException(\"more than 1 default extension name on extension \" + type.getName() + \": \" + Arrays.toString(names)); &#125; /** è®¾ç½®é»˜è®¤åç§°ï¼ŒcachedDefaultName æ˜¯ç”¨æ¥åŠ è½½æ‰©å±•ç‚¹çš„é»˜è®¤å®ç° &#123;@link #getDefaultExtension()&#125; */ if (names.length == 1) &#123; cachedDefaultName = names[0]; &#125; &#125; &#125; //2ã€ ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½æ‹“å±•å®ç°ç±»é›†åˆï¼Œè¿™é‡Œåˆ†åˆ«å¯¹åº”ä¸‰ç±»æ–‡ä»¶ï¼ˆ1. Dubboå†…ç½®çš„ 2. Dubboè‡ªå®šä¹‰ 3. JDK SPIï¼‰ Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = new HashMap&lt;String, Class&lt;?&gt;&gt;(); loadDirectory(extensionClasses, DUBBO_INTERNAL_DIRECTORY); loadDirectory(extensionClasses, DUBBO_DIRECTORY); loadDirectory(extensionClasses, SERVICES_DIRECTORY); return extensionClasses;&#125; æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¯¥æ–¹æ³•æ²¡æœ‰å¤ªå¤šçš„é€»è¾‘ï¼Œä¸»è¦å¤„ç†æ‰©å±•ç‚¹çš„é»˜è®¤æ‰©å±•åï¼Œå¦‚æœå­˜åœ¨çš„åŒ–å°±æ”¾å…¥ç¼“å­˜ä¸­ï¼Œå…·ä½“åŠ è½½é…ç½®æ–‡ä»¶çš„é€»è¾‘ç”±loadDirectoryæ–¹æ³•å®ç°ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå”¯ä¸€è°ƒç”¨è¯¥æ–¹æ³•çš„å…¥å£ {@link #getExtensionClasses()} å·²ç»åŠ è¿‡äº†é”ï¼Œå› æ­¤æ­¤å¤„æ— éœ€å†æ¬¡åŠ é”ã€‚æ¥ä¸‹æ¥ç»§ç»­åˆ†ædubboå¦‚ä½•åŠ è½½é…ç½®æ–‡ä»¶ã€‚ 123456789101112131415161718192021222324252627282930313233private void loadDirectory(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir) &#123; // æ‹¼æ¥å®Œæ•´çš„æ–‡ä»¶åï¼ˆç›¸å¯¹è·¯å¾„ï¼‰ï¼š ç›®å½• + typeå…¨ç±»å String fileName = dir + type.getName(); try &#123; Enumeration&lt;java.net.URL&gt; urls; // ç±»åŠ è½½å™¨ ClassLoader classLoader = findClassLoader(); /** è·å¾—æ–‡ä»¶åå¯¹åº”çš„æ‰€æœ‰æ–‡ä»¶æ•°ç»„ï¼ˆå¯èƒ½åŒä¸€ä¸ªæ–‡ä»¶ååœ¨ä¸åŒçš„ç›®å½•ç»“æ„ä¸­ï¼Œè¿™æ ·å°±ä¼šè·å–å¤šä¸ªæ–‡ä»¶ï¼‰,æ¯ä¸ªæ–‡ä»¶å†…å®¹å°è£…åˆ°ä¸€ä¸ªjava.net.URLä¸­*/ if (classLoader != null) &#123; urls = classLoader.getResources(fileName); &#125; else &#123; urls = ClassLoader.getSystemResources(fileName); &#125; // éå†java.net.URLé›†åˆ if (urls != null) &#123; while (urls.hasMoreElements()) &#123; java.net.URL resourceURL = urls.nextElement(); // åŠ è½½java.net.URL loadResource(extensionClasses, classLoader, resourceURL); &#125; &#125; &#125; catch (Throwable t) &#123; logger.error(\"Exception when load extension class(interface: \" + type + \", description file: \" + fileName + \").\", t); &#125;&#125; é€šè¿‡ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º,loadDirectoryæ–¹æ³•ä¸»è¦å°±åšä¸€ä»¶äº‹ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶å¹¶å°†æ¯ä¸ªé…ç½®æ–‡ä»¶å†…å®¹å°è£…åˆ°java.net.URLé›†åˆä¸­ï¼Œæ¥ä¸‹æ¥åœ¨loadResourceæ–¹æ³•ä¸­å°±å¯ä»¥ä»è¯¥URLä¸­ä¾æ¬¡è§£ææ‰©å±•åå’Œæ‰©å±•å®ç°ç±»ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677/** * åŠ è½½é…ç½®æ–‡ä»¶å†…å®¹ï¼ˆå·²ç»å°è£…æˆäº†java.net.URLï¼‰ * * @param extensionClasses æ‰©å±•ç±»é›†åˆ * @param classLoader ç±»åŠ è½½å™¨ * @param resourceURL æ–‡ä»¶å†…å®¹èµ„æº */ private void loadResource(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, ClassLoader classLoader, java.net.URL resourceURL) &#123; try &#123; // è¯»å–æ–‡ä»¶å†…å®¹ BufferedReader reader = new BufferedReader(new InputStreamReader(resourceURL.openStream(), \"utf-8\")); try &#123; String line; // ä¸€è¡Œä¸€è¡Œçš„è¯»å–ã€‚ä¼šè·³è¿‡å½“å‰è¢«æ³¨é‡Šæ‰è¡Œï¼Œä¾‹å¦‚ï¼š#dubbo=xxx while ((line = reader.readLine()) != null) &#123; // å¦‚æœæœ‰#æ³¨é‡Šï¼Œé‚£ä¹ˆciä¸º0ï¼Œæ²¡æœ‰å°±ä¸º-1 final int ci = line.indexOf('#'); // åœ¨æœ‰#æ³¨é‡Šçš„æƒ…å†µä¸‹ï¼Œæ­¤æ—¶lineçš„é•¿åº¦ä¸º0 if (ci &gt;= 0) &#123; line = line.substring(0, ci); &#125; // å»é™¤å‰åç«¯ç©ºæ ¼ï¼Œé˜²æ­¢è‡ªå®šä¹‰æ‰©å±•ç‚¹å®ç°æ—¶é…ç½®ä¸è§„èŒƒ line = line.trim(); // æ²¡æœ‰#æ³¨é‡Šçš„æƒ…å†µ if (line.length() &gt; 0) &#123; try &#123; /** * æ‹†åˆ† key=value ï¼Œnameä¸ºæ‹“å±•å lineä¸ºæ‹“å±•å®ç°ç±»åã€‚æ³¨æ„ï¼š * 1 è¿™é‡Œnameå¯èƒ½ä¸ºç©º,è¿™ç§æƒ…å†µæ‰©å±•åä¼šè‡ªåŠ¨ç”Ÿæˆï¼ˆå› ä¸ºDubbo SPIå…¼å®¹Java SPIï¼ŒDubbo SPIé…ç½®å¼ºè°ƒkey=valueæ ¼å¼ï¼Œåº”è¯¥å°½å¯èƒ½éµå®ˆè§„åˆ™ï¼‰ * 2 æ‰©å±•ååªå¯¹æ™®é€šæ‰©å±•æ‰æœ‰æ„ä¹‰ï¼Œå¯¹è‡ªé€‚åº”æ‰©å±•ã€Wrapperæ˜¯æ²¡ç”¨çš„ï¼Œä¹‹æ‰€ä»¥è¦é…ç½®ï¼Œæ˜¯ä¸ºäº†ç»Ÿä¸€dubbo spié…ç½®è§„åˆ™ */ String name = null; // i &gt; 0ï¼Œæœ‰æ‰©å±•åï¼› i &lt; 0 æ²¡æœ‰é…ç½®æ‰©å±•åï¼Œå³å…¼å®¹Java SPI int i = line.indexOf('='); if (i &gt; 0) &#123; /** è·å– = å·¦è¾¹çš„key å³æ‰©å±•å */ name = line.substring(0, i).trim(); /** è·å– = å³è¾¹çš„value å³æ‹“å±•ç‚¹çš„å®ç°çš„å…¨é™å®šæ€§ç±»å */ line = line.substring(i + 1).trim(); &#125; // åŠ è½½å½“å‰è¡Œå¯¹åº”çš„æ‰©å±•ç‚¹é…ç½® if (line.length() &gt; 0) &#123; /** * 1 é€šè¿‡åå°„ï¼Œæ ¹æ®åç§°è·å–æ‰©å±•ç‚¹å®ç°ç±» * 2 å¯¹æ‰©å±•å®ç°ç±»è¿›è¡Œåˆ†ç±»ç¼“å­˜ */ loadClass(extensionClasses, resourceURL, Class.forName(line, true, classLoader), name); &#125; &#125; catch (Throwable t) &#123; IllegalStateException e = new IllegalStateException(\"Failed to load extension class(interface: \" + type + \", class line: \" + line + \") in \" + resourceURL + \", cause: \" + t.getMessage(), t); exceptions.put(line, e); &#125; &#125; &#125; &#125; finally &#123; reader.close(); &#125; &#125; catch (Throwable t) &#123; logger.error(\"Exception when load extension class(interface: \" + type + \", class file: \" + resourceURL + \") in \" + resourceURL, t); &#125; &#125; loadResourceæ–¹æ³•ç”¨äºå°†é…ç½®æ–‡ä»¶ä¸­çš„æ¯è¡Œè®°å½•è¯»å–å‡ºæ¥ï¼Œç»è¿‡è§£æå’Œåå°„å¤„ç†å°±èƒ½æ‹¿åˆ°æ‰©å±•åå’Œå¯¹åº”çš„æ‰©å±•å®ç°ç±»ï¼Œæ‰©å±•åå’Œæ‰©å±•å®ç°ç±»çš„è·å–é€»è¾‘å·²ç»åœ¨ä»£ç ä¸­è¯¦ç»†æ³¨é‡Šã€‚æœ€åè°ƒç”¨loadClassæ–¹æ³•è¿›è¡Œåˆ†ç±»ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜å¾ˆå¤šï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹dubboæ˜¯å¦‚ä½•å¤„ç†å®ä¾‹ç¼“å­˜çš„åˆ†ç±»çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102/** * å¯¹æ‰©å±•ç‚¹å®ç°ç±»è¿›è¡Œåˆ†ç±»ç¼“å­˜ * * @param extensionClasses æ‰©å±•å®ç°ç±»é›†åˆ * @param resourceURL æ–‡ä»¶å†…å®¹èµ„æº * @param clazz æ‰©å±•ç‚¹å®ç°ç±» * @param name æ‰©å±•å ã€åªå¯¹æ™®é€šæ‰©å±•æ‰æœ‰æ„ä¹‰ã€‘ * @throws NoSuchMethodException */private void loadClass(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, java.net.URL resourceURL, Class&lt;?&gt; clazz, String name) throws NoSuchMethodException &#123; // åˆ¤æ–­æ‹“å±•ç‚¹å®ç°ç±»ï¼Œæ˜¯å¦å®ç°äº†å½“å‰typeæ¥å£ï¼Œæ²¡æœ‰å®ç°å°±ä¼šæŠ¥é”™ if (!type.isAssignableFrom(clazz)) &#123; throw new IllegalStateException(\"Error when load extension class(interface: \" + type + \", class line: \" + clazz.getName() + \"), class \" + clazz.getName() + \"is not subtype of interface.\"); &#125; //-------------------------------------- æ ¹æ®æ‰©å±•ç‚¹å®ç°ç±»çš„ç±»å‹å¯åˆ†ä¸ºä¸‰å¤§ç±» ï¼Œåœ¨è¿›è¡Œåˆ†ç±»ç¼“å­˜ä¸­æœ‰ä¼˜å…ˆçº§ï¼Œå³åŒä¸€ä¸ªå®ç°ç±»åªèƒ½å½’å±åˆ°æŸä¸ªåˆ†ç±»ä¸­ --------------------------------/ /** * 1ã€è‡ªé€‚åº”æ‰©å±•ç±» * è¯´æ˜ï¼š * ï¼ˆ1ï¼‰å½“å‰æ‰©å±•ç‚¹å®ç°ç±»æ˜¯å¦æ ‡æ³¨@Adaptiveæ³¨è§£ï¼Œæ ‡è®°çš„è¯å°±æ˜¯è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œç›´æ¥ç¼“å­˜åˆ° cachedAdaptiveClass å±æ€§ä¸­ï¼Œç„¶åç»“æŸé€»è¾‘ï¼Œå³ä¸ä¼šè¿›è¡Œä¸‹é¢çš„ Wrapperã€æ™®é€šæ‰©å±•ç±»ä»¥åŠè‡ªåŠ¨æ¿€æ´»ç±»é€»è¾‘åˆ¤æ–­ã€‚ * ï¼ˆ2ï¼‰è‡ªé€‚åº”å›ºå®šæ‰©å±•å®ç°ç±»å…¶å®ä¸éœ€è¦é…ç½®æ‰©å±•åï¼Œå³ä½¿é…ç½®äº†ä¹Ÿç”¨ä¸åˆ°ï¼Œå› ä¸ºè‡ªé€‚åº”æ‰©å±•ç±»å’Œè‡ªé€‚åº”æ‰©å±•å¯¹è±¡æ•´ä¸ªè½¬æ¢é—­ç¯éƒ½ç”¨ä¸åˆ°æ‰©å±•åã€‚ä¹‹æ‰€ä»¥é…ç½®ï¼Œæ˜¯ä¸ºäº†ç»Ÿä¸€è§„åˆ™ã€‚ */ if (clazz.isAnnotationPresent(Adaptive.class)) &#123; // ä¸€ä¸ªæ‰©å±•ç‚¹æœ‰ä¸”ä»…å…è®¸ä¸€ä¸ªè‡ªé€‚åº”æ‰©å±•å®ç°ç±»ï¼Œå¦‚æœç¬¦åˆæ¡ä»¶å°±åŠ å…¥åˆ°ç¼“å­˜ä¸­ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ if (cachedAdaptiveClass == null) &#123; cachedAdaptiveClass = clazz; &#125; else if (!cachedAdaptiveClass.equals(clazz)) &#123; throw new IllegalStateException(\"More than 1 adaptive class found: \" + cachedAdaptiveClass.getClass().getName() + \", \" + clazz.getClass().getName()); &#125; /** * 2ã€Wrapperç±»å‹ ï¼ˆè¯¥ç±»éœ€è¦æœ‰æœ‰ä¸€ä¸ªå‚æ•°çš„æ„é€ æ–¹æ³•ï¼Œä¸”è¿™ä¸ªå‚æ•°ç±»å‹æ˜¯å½“å‰çš„æ‰©å±•ç‚¹typeï¼‰ * è¯´æ˜ï¼š * ï¼ˆ1ï¼‰å½“å‰æ‰©å±•ç‚¹å®ç°ç±»å¦‚æœæ˜¯Wrapperç±»ï¼Œç›´æ¥ç¼“å­˜åˆ° cachedWrapperClasses å±æ€§é›†åˆä¸­ï¼Œç„¶åç»“æŸé€»è¾‘ï¼Œå³ä¸ä¼šè¿›è¡Œä¸‹é¢çš„ æ™®é€šæ‰©å±•ç±»ä»¥åŠè‡ªåŠ¨æ¿€æ´»ç±»é€»è¾‘åˆ¤æ–­ã€‚ * ï¼ˆ2ï¼‰Wrapperç±»å…¶å®ä¸éœ€è¦é…ç½®æ‰©å±•åï¼Œå³ä½¿é…ç½®äº†ä¹Ÿç”¨ä¸åˆ°ã€‚ä¹‹æ‰€ä»¥é…ç½®ï¼Œæ˜¯ä¸ºäº†ç»Ÿä¸€è§„åˆ™ã€‚ */ &#125; else if (isWrapperClass(clazz)) &#123; Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses; if (wrappers == null) &#123; cachedWrapperClasses = new ConcurrentHashSet&lt;Class&lt;?&gt;&gt;(); wrappers = cachedWrapperClasses; &#125; wrappers.add(clazz); /** * 3ã€æ™®é€šçš„æ‰©å±•å®ç°ç±»ï¼Œæ³¨æ„Activateè‡ªåŠ¨æ¿€æ´»ç±»ä»å¤§çš„æ–¹é¢ä¹Ÿå±äºæ™®é€šçš„æ‰©å±•å®ç°ç±» */ &#125; else &#123; // åˆ¤æ–­æ˜¯å¦æœ‰é»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œæ²¡æœ‰ä¼šæŠ›å‡ºå¼‚å¸¸ clazz.getConstructor(); // æœªé…ç½®æ‰©å±•åï¼Œåˆ™è‡ªåŠ¨ç”Ÿæˆã€‚é€‚ç”¨äºJava SPIçš„é…ç½®æ–¹å¼ï¼ˆDubbo SPI å…¼å®¹Java SPIï¼‰ ä¾‹å¦‚ï¼š xxx.yyy.DemoFilterç”Ÿæˆçš„æ‹“å±•åä¸ºdemo if (name == null || name.length() == 0) &#123; // è‡ªåŠ¨ç”Ÿæˆæ‰©å±•å name = findAnnotationName(clazz); if (name.length() == 0) &#123; throw new IllegalStateException(\"No such extension name for the class \" + clazz.getName() + \" in the config \" + resourceURL); &#125; &#125; // å¯¹æ‰©å±•åè¿›è¡Œåˆ†å‰²å¤„ç†ï¼Œdubboæ”¯æŒé…ç½®å¤šä¸ªæ‰©å±•åã€‚å¦‚æœé…ç½®å¤šä¸ªæ‰©å±•åéœ€è¦ä»¥','åˆ†å‰² String[] names = NAME_SEPARATOR.split(name); if (names != null &amp;&amp; names.length &gt; 0) &#123; // 3.1ã€ å¦‚æœå½“å‰ç±»æ ‡æ³¨äº†@Activateï¼Œå°±ç¼“å­˜åˆ° cachedActivatesé›†åˆã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿æ‰©å±•ç‚¹é…ç½®å¤šä¸ªï¼ŒcachedActivates çš„key åªå–ç¬¬ä¸€ä¸ªã€‚ Activate activate = clazz.getAnnotation(Activate.class); if (activate != null) &#123; // æ‹“å±•åä¸ @Activateçš„æ˜ å°„ cachedActivates.put(names[0], activate); &#125; /** * 3.2ã€ç¼“å­˜å½“å‰æ‰©å±•ç‚¹åˆ†ç±»åˆ° cachedNames é›†åˆ å’Œ cachedClasses é›†åˆ * è¯´æ˜ï¼š * ï¼ˆ1ï¼‰cachedNames ç¼“å­˜é›†åˆä¸­çš„æ•°æ®ç‰¹ç‚¹ï¼šåŒä¸€ä¸ªæ‰©å±•ç‚¹å®ç°ç±»å¯¹åº”çš„æ‰©å±•åå³ä½¿åœ¨é…ç½®å¤šä¸ªæ‰©å±•åçš„æƒ…å†µä¸‹ä¹Ÿåªå–ç¬¬ä¸€ä¸ª * ï¼ˆ2ï¼‰cachedClasses ç¼“å­˜é›†åˆçš„æ•°æ®ç‰¹ç‚¹ï¼šåŒä¸€ä¸ªæ‰©å±•ç‚¹å®ç°ç±»å¯¹åº”çš„æ‰©å±•åå¯èƒ½å­˜åœ¨å¤šä¸ª */ for (String n : names) &#123; // ç¼“å­˜æ‰©å±•ç±»åˆ°æ‰©å±•åçš„æ˜ å°„ if (!cachedNames.containsKey(clazz)) &#123; cachedNames.put(clazz, n); &#125; // ç¼“å­˜æ‰©å±•ååˆ°æ‰©å±•ç±»çš„æ˜ å°„ï¼Œæ³¨æ„å¦‚æœåœ¨ä¸åŒçš„æ–‡ä»¶ä¸­é…ç½®åŒä¸€ä¸ªæ‰©å±•ç‚¹å®ç°ï¼Œå¹¶ä¸”æ‰©å±•åæœ‰ç›¸åŒçš„æƒ…å†µï¼Œè¿™æ—¶ä»¥è§£æçš„ç¬¬ä¸€ä¸ªä¸ºå‡† Class&lt;?&gt; c = extensionClasses.get(n); if (c == null) &#123; extensionClasses.put(n, clazz); &#125; else if (c != clazz) &#123; throw new IllegalStateException(\"Duplicate extension \" + type.getName() + \" name \" + n + \" on \" + c.getName() + \" and \" + clazz.getName()); &#125; &#125; &#125; &#125;&#125; é€šè¿‡ä¸Šé¢çš„ä»£ç å¯çŸ¥ï¼ŒloadClassæ–¹æ³•ä¸»è¦å°±æ˜¯åˆ†ç±»ç¼“å­˜ä¸åŒæ‰©å±•å®ç°ç±»ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸æ¶‰åŠæ‰©å±•å®ç°ç±»çš„å®ä¾‹åŒ–ï¼Œè¿™ä¹ŸéªŒè¯äº†å‰é¢çš„ç»“è®ºï¼Œdubbo spiæ˜¯æŒ‰éœ€å®ä¾‹åŒ–å¯¹è±¡ã€‚åˆ°è¿™é‡ŒgetExtensionæ–¹æ³•ä¸»è¦è¿‡å°±åˆ†æå®Œäº†ï¼Œå‰é¢ä¹Ÿè¯´åˆ°è¯¥æ–¹æ³•æ˜¯åŠ è½½æ‰©å±•å®ç°çš„å®Œæ•´é€»è¾‘ï¼Œå…¶å®ƒçš„ä¸¤ä¸ªå…¥å£ä¸­çš„é€»è¾‘ä¹Ÿä¼šä½¿ç”¨ä¸Šé¢è¿‡ç¨‹ä¸­çš„éƒ¨åˆ†é€»è¾‘ï¼Œåœ¨ä¸‹é¢çš„ä»£ç åˆ†æä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ã€‚ getActivateExtension æ–¹æ³•è¯¥æ–¹æ³•åªæ˜¯æ ¹æ®ä¸åŒçš„æ¡ä»¶åŒæ—¶æ¿€æ´»å¤šä¸ªæ™®é€šæ‰©å±•å®ç°ç±»ï¼Œå³ä¼šåšä¸€äº›é€šç”¨çš„åˆ¤æ–­æ¥ç­›é€‰æ˜¯å¦æ˜¯æ¿€æ´»æ‰©å±•æ‰©å±•å¯¹è±¡ã€‚å‰é¢å¤šæ¬¡æåˆ°è¯¥æ³•ä¼šä¾èµ–getExtensionæ–¹æ³•ä¸­çš„é€»è¾‘ï¼Œä¸‹é¢æˆ‘å°±ä¸€èµ·æ¥çœ‹çœ‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687/** * è·å¾—æ¿€æ´»æ¡ä»¶çš„æ‰©å±•å®ç°å¯¹è±¡é›†åˆ * * @param url url * @param values æ¿€æ´»çš„æ‰©å±•åæ•°ç»„ï¼Œå¯èƒ½ä¸ºç©ºã€‚å¦‚ï¼šè·å–dubboå†…ç½®çš„è¿‡æ»¤å™¨æ—¶ï¼Œkey=service.filterï¼Œurlä¸­æ²¡æœ‰å¯¹åº”çš„å€¼ * @param group è¿‡æ»¤åˆ†ç»„å * @return è¢«æ¿€æ´»çš„æ‰©å±•å®ç°å¯¹è±¡é›†åˆ * @see com.alibaba.dubbo.common.extension.Activate */ public List&lt;T&gt; getActivateExtension(URL url, String[] values, String group) &#123; // æ¿€æ´»æ‰©å±•å®ç°å¯¹è±¡ç»“æœé›† List&lt;T&gt; exts = new ArrayList&lt;T&gt;(); // æ¿€æ´»çš„æ‰©å±•åé›†åˆ List&lt;String&gt; names = values == null ? new ArrayList&lt;String&gt;(0) : Arrays.asList(values); // åˆ¤æ–­æ‰©å±•åé›†åˆä¸­æ˜¯å¦æœ‰ '-default' , å¦‚ï¼š &lt;dubbo:service filter=\"-default\"/&gt; ä»£è¡¨ç§»å‡ºæ‰€æœ‰é»˜è®¤çš„è¿‡æ»¤å™¨ã€‚æ³¨æ„ï¼Œnamesæ˜¯ä¸ªç©ºçš„Listæ˜¯ç¬¦åˆæ¡ä»¶çš„ if (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) &#123; // è·å–/åˆ·æ–° æ‰©å±•ç‚¹å®ç°ç±»çš„é›†åˆ getExtensionClasses(); /** * éå†cachedActivates (æ‹“å±•å åˆ° @Activate çš„æ˜ å°„) * 1 åŒ¹é…åˆ†ç»„ï¼ŒåŒ¹é…æˆåŠŸåˆ™ç»§ç»­é€»è¾‘ï¼Œå¦åˆ™ä¸å¤„ç† åŠ è½½é…ç½®æ–‡ä»¶æ—¶æ”¶é›†åˆ°çš„æ¿€æ´»æ‰©å±•ç±» * 2 å¯¹æ¿€æ´»æ‰©å±•ç±»è¿›è¡Œå®ä¾‹åŒ–[åˆæ¬¡æ‰ä¼šï¼Œä»¥åå°±ä»ç¼“å­˜ä¸­å–] * 3 åˆ¤æ–­å½“å‰ç¼“å­˜ä¸­çš„æ¿€æ´»æ‰©å±•ç±»æ˜¯å¦å’Œä¼ å…¥çš„æ¿€æ´»æ‰©å±•ç±»å†²çªï¼Œå¦‚æœæœ‰å†²çªï¼Œå°±å¿½ç•¥ç¼“å­˜ä¸­çš„æ¿€æ´»æ‰©å±•ç±»ï¼Œä»¥ä¼ å…¥çš„æ‰©å±•ç±»ä¸ºä¸» */ for (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) &#123; // æ‰©å±•å String name = entry.getKey(); // Activate Activate activate = entry.getValue(); // åŒ¹é…åˆ†ç»„ï¼Œåˆ¤æ–­Activateæ³¨è§£çš„groupå±æ€§å€¼æ˜¯å¦åŒ…å«å½“å‰ä¼ å…¥çš„groupï¼ŒåŒ…å«å°±ç¬¦åˆåˆ†ç»„æ¡ä»¶ if (isMatchGroup(group, activate.group())) &#123; // è·å–æ‰©å±•åå¯¹åº”çš„æ‰©å±•ç‚¹å®ç°å¯¹è±¡ T ext = getExtension(name); // æ˜¯å¦å¿½ç•¥ åŠ è½½é…ç½®æ–‡ä»¶æ—¶æ”¶é›†åˆ°çš„æ¿€æ´»æ‰©å±•ç±» if (!names.contains(name) // åŒ¹é…æ‰©å±•å &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name) // å¦‚æœåŒ…å« '-' è¡¨ç¤ºä¸æ¿€æ´»è¯¥æ‰©å±•å®ç° &amp;&amp; isActive(activate, url)) // æ£€æµ‹URLä¸­æ˜¯å¦å‡ºç°äº†æŒ‡å®šçš„key &#123; exts.add(ext); &#125; &#125; &#125; // å¯¹æ‰©å±•å¯¹è±¡è¿›è¡Œæ’åºï¼ˆæ ¹æ®æ³¨è§£çš„beforeã€afterã€orderå±æ€§ï¼‰ Collections.sort(exts, ActivateComparator.COMPARATOR); &#125; List&lt;T&gt; usrs = new ArrayList&lt;T&gt;(); // éå†ä¼ å…¥çš„æ¿€æ´»æ‰©å±•åé›†åˆ for (int i = 0; i &lt; names.size(); i++) &#123; // è·å–æ¿€æ´»æ‰©å±•å String name = names.get(i); // åˆ¤æ–­æ˜¯å¦æ˜¯ ç§»é™¤æ¿€æ´»æ‰©å±•åï¼Œå¦‚æœæ˜¯å°±å¿½ç•¥ã€‚ å¦‚ï¼š &lt;dubbo:service filter=\"-demo\"/&gt;ï¼Œé‚£ä¹ˆæ­¤æ—¶demoå¯¹åº”çš„æ‰©å±•å®ç°å°±æ˜¯å±äºæ— æ•ˆçš„ if (!name.startsWith(Constants.REMOVE_VALUE_PREFIX) &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) &#123; // å¤„ç† è‡ªå®šä¹‰çš„æ¿€æ´»æ‰©å±•é…ç½®åœ¨é»˜è®¤çš„æ¿€æ´»æ‰©å±•å‰é¢çš„æƒ…å†µ, å¦‚ï¼š &lt;dubbo:service filter=\"demo,default\"/&gt;ï¼Œé‚£ä¹ˆè‡ªå®šä¹‰çš„demoæ¿€æ´»æ‰©å±•å°±ä¼˜å…ˆé»˜è®¤çš„æ¿€æ´»æ‰©å±•ã€‚ä¸»è¦æ˜¯extsä¸­çš„å€¼å˜åŒ–ï¼Œå‰é¢å·²ç»å¤„ç†äº†é»˜è®¤çš„æ¿€æ´»æ‰©å±•(åŠ è½½é…ç½®æ–‡ä»¶æ—¶æ”¶é›†åˆ°çš„æ¿€æ´»æ‰©å±•ç±») if (Constants.DEFAULT_KEY.equals(name)) &#123; if (!usrs.isEmpty()) &#123; exts.addAll(0, usrs); usrs.clear(); &#125; &#125; else &#123; // è·å¾—æ¿€æ´»æ‰©å±•å®ç°å¯¹è±¡ T ext = getExtension(name); usrs.add(ext); &#125; &#125; &#125; if (!usrs.isEmpty()) &#123; exts.addAll(usrs); &#125; return exts; &#125; è·å–æ¿€æ´»çš„æ‰©å±•å¯¹è±¡é€»è¾‘åœ¨ä»£ç ä¸­å·²ç»è¯¦ç»†æ³¨é‡Šè¯´æ˜ï¼Œè·å–æ‰©å±•å®ç°å¯¹è±¡è¿˜æ˜¯è°ƒç”¨äº†getExtensionæ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸»è¦æ­¥éª¤ï¼š å¦‚æœè§¦å‘è·å–æ‰©å±•å®ç°ç±»åŠ¨ä½œæ—¶ï¼Œä¼šæ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå°±åŠ è½½é…ç½®æ–‡ä»¶æ¥åˆ·æ–°æ‰©å±•å®ç°ç±»é›†åˆã€‚ éå†ç¼“å­˜ä¸­çš„æ¿€æ´»é›†åˆï¼ˆè¿™ä¸ªç¼“å­˜å†…å®¹æ˜¯åŠ è½½çš„å¸¦æœ‰@Activateæ³¨è§£çš„æ‰©å±•ç±»ä¿¡æ¯ï¼‰ï¼Œæ ¹æ®ä¼ å…¥çš„URLåŒ¹é…æ¡ä»¶ç­›é€‰å‡ºç¬¦åˆæ¿€æ´»æ¡ä»¶çš„æ‰©å±•ç±»å®ç°ï¼Œç„¶åè¿›è¡Œæ’åºæ“ä½œã€‚ éå†ä¼ å…¥çš„æ¿€æ´»æ‰©å±•åé›†åˆï¼Œæ ¹æ®è®¾ç½®çš„é¡ºåºè°ƒæ•´æ‰©å±•ç‚¹æ¿€æ´»é¡ºåºï¼Œå…¶ä¸­defaultä»£è¡¨çš„æ˜¯æ‰€æœ‰@Activateæ ‡æ³¨å¹¶ä¸”é…ç½®åœ¨é…ç½®æ–‡ä»¶ä¸­çš„æ‰©å±•å®ç°ç±» é€šè¿‡getExtension(name)è·å–æ¿€æ´»æ‰©å±•åå¯¹åº”çš„æ‰©å±•å¯¹è±¡å¹¶åŠ å…¥ç»“æœé›†åˆ è¿”å›ç¬¦åˆæ¡ä»¶çš„æ¿€æ´»ç±»é›†åˆ getAdaptiveExtension æ–¹æ³•è·å–è‡ªé€‚åº”æ‰©å±•å¯¹è±¡çš„å…¥å£ï¼Œå¦‚æœè·å–çš„è‡ªé€‚åº”æ‰©å±•ç±»å±äºå›ºå®šçš„ï¼Œé‚£ä¹ˆè¯¥æ–¹æ³•ç›¸å¯¹ç‹¬ç«‹ï¼Œå‡ ä¹ä¸ä¾èµ–getExtensionæ–¹æ³•çš„é€»è¾‘ã€‚å¦‚æœå±äºåŠ¨æ€ç”Ÿæˆåˆ™å†…éƒ¨ä¹Ÿä¼šè°ƒç”¨getExtensionæ–¹æ³•ã€‚ç”±äºè¯¥æ–¹æ³•ä¼šæ¶‰åŠåˆ°javassistã€åŠ¨æ€ç¼–è¯‘ç­‰æŠ€æœ¯ï¼Œå†…å®¹è¾ƒå¤šä¸”æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¸å†è¿›è¡Œåˆ†æï¼Œæˆ‘ä¼šå•ç‹¬å†™ä¸€ç¯‡æ–‡ç« è¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚ä¸‹é¢å…ˆç»™å‡ºå›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»å’Œè‡ªåŠ¨ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•ç±»çš„ç¤ºä¾‹ï¼Œè®©èƒ–å‹ä»¬æœ‰ä¸ªæ¦‚å¿µã€‚ å›ºå®šçš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œä»¥ç¼–è¯‘æ‰©å±•æ¥å£ä¸ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940/** * AdaptiveCompiler. (SPI, Singleton, ThreadSafe) * å®ç°Compileræ¥å£ï¼Œè‡ªé€‚åº”Compilerå®ç°ç±» */@Adaptivepublic class AdaptiveCompiler implements Compiler &#123; /** * é»˜è®¤ç¼–è¾‘å™¨çš„æ‹“å±•å */ private static volatile String DEFAULT_COMPILER; /** * é™æ€æ–¹æ³•ï¼Œè®¾ç½®é»˜è®¤ç¼–è¾‘å™¨çš„æ‹“å±•åã€‚è¯¥æ–¹æ³•è¢« &#123;@link com.alibaba.dubbo.config.ApplicationConfig#setCompiler(java.lang.String)&#125;æ–¹æ³•è°ƒç”¨. * åœ¨&lt;dubbo:application compiler=\"\"/&gt; é…ç½®ä¸‹å¯è§¦å‘è¯¥æ–¹æ³• * * @param compiler */ public static void setDefaultCompiler(String compiler) &#123; DEFAULT_COMPILER = compiler; &#125; @Override public Class&lt;?&gt; compile(String code, ClassLoader classLoader) &#123; Compiler compiler; // è·å¾—Compilerçš„ExtensionLoaderå¯¹è±¡ ExtensionLoader&lt;Compiler&gt; loader = ExtensionLoader.getExtensionLoader(Compiler.class); // å£°æ˜ name å˜é‡ï¼Œå¼•ç”¨ DEFAULT_COMPILER çš„å€¼ï¼Œé¿å…ä¸‹é¢çš„å€¼å˜äº† String name = DEFAULT_COMPILER; // ä½¿ç”¨è®¾ç½®çš„æ‹“å±•åï¼Œè·å¾—Compileræ‹“å±•å¯¹è±¡ if (name != null &amp;&amp; name.length() &gt; 0) &#123; compiler = loader.getExtension(name); // è·å¾—é»˜è®¤çš„Compileræ‹“å±•å¯¹è±¡ &#125; else &#123; compiler = loader.getDefaultExtension(); &#125; // ä½¿ç”¨çœŸæ­£çš„Compilerå¯¹è±¡ï¼ŒåŠ¨æ€ç¼–è¯‘ä»£ç  return compiler.compile(code, classLoader); &#125;&#125; åŠ¨æ€ç”Ÿæˆçš„è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œä»¥ZookeeperTransporteræ‰©å±•æ¥å£ä¸ºä¾‹ 12345678910111213141516171819import com.alibaba.dubbo.common.extension.ExtensionLoader;public class ZookeeperTransporter$Adaptive implements com.alibaba.dubbo.remoting.zookeeper.ZookeeperTransporter &#123; public com.alibaba.dubbo.remoting.zookeeper.ZookeeperClient connect(com.alibaba.dubbo.common.URL arg0) &#123; if (arg0 == null) &#123; throw new IllegalArgumentException(\"url == null\"); &#125; com.alibaba.dubbo.common.URL url = arg0; String extName = url.getParameter(\"client\", url.getParameter(\"transporter\", \"curator\")); if (extName == null) &#123; throw new IllegalStateException(\"Fail to get extension(com.alibaba.dubbo.remoting.zookeeper.ZookeeperTransporter) name from url(\" + url.toString() + \") use keys([client, transporter])\"); &#125; com.alibaba.dubbo.remoting.zookeeper.ZookeeperTransporter extension = (com.alibaba.dubbo.remoting.zookeeper.ZookeeperTransporter) ExtensionLoader .getExtensionLoader(com.alibaba.dubbo.remoting.zookeeper.ZookeeperTransporter.class) .getExtension(extName); return extension.connect(arg0); &#125;&#125; hasExtension æ–¹æ³•123456789101112131415161718/** * åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„æ‰©å±•å®ç°ç±» * * @param name æ‰©å±•å * @return */ public boolean hasExtension(String name) &#123; if (name == null || name.length() == 0) &#123; throw new IllegalArgumentException(\"Extension name == null\"); &#125; try &#123; // æ²¡æœ‰nameå¯¹åº”çš„æ‰©å±•å®ç°ç±»å°±æŠ›å‡ºå¼‚å¸¸ï¼Œå³æœ€åè¿”å›false this.getExtensionClass(name); return true; &#125; catch (Throwable t) &#123; return false; &#125; &#125; ä¸Šé¢ä»£ç æ¯”è¾ƒç®€å•ï¼Œæ ¹æ®æ‰©å±•ååˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„æ‰©å±•å®ç°ç±»ï¼Œä¹‹æ‰€ä»¥å•ç‹¬æ‹¿å‡ºæ¥ä»‹ç»æ˜¯Dubboçš„å¾ˆå¤šæµç¨‹ä¼šç”¨åˆ°è¯¥æ–¹æ³•ï¼Œæœ‰ä¸ªå°è±¡å°±å¯ä»¥äº†ã€‚ dubbo ioc å®ç°dubboçš„iocå®ç°ç›®å‰ä»…æ”¯æŒsetteræ³¨å…¥ï¼Œä¸¥è°¨æ¥è¯´ï¼Œdubboçš„iocå®ç°æ–¹å¼è¿˜å¯ä»¥é€šè¿‡æ„é€ æ³¨å…¥ï¼Œå³Wrapperç±»çš„å®ç°ã€‚dubboçš„setteræ³¨å…¥è¦æ±‚æ˜¯ï¼Œå¦‚æœæŸä¸ªæ‰©å±•ç±»æ˜¯å¦å¤–ä¸€ä¸ªæ‰©å±•ç‚¹å®ç°ç±»çš„æˆå‘˜å±æ€§ï¼Œå¹¶ä¸”æ‹¥æœ‰å¯¹åº”çš„setteræ–¹æ³•ï¼Œé‚£ä¹ˆdubboå°±ä¼šè‡ªåŠ¨æ³¨å…¥å¯¹åº”çš„æ‰©å±•ç‚¹å®ç°å¯¹è±¡ã€‚è¿™ä¸ªåŠŸèƒ½åœ¨ä¸Šé¢åˆ›å»ºæ‰©å±•å®ç°çš„æ—¶å€™éœ€è¦ç”¨åˆ°ï¼Œå½“æ—¶æ²¡æœ‰è¯¦ç»†è¯´æ˜ï¼Œä¸‹é¢æˆ‘ä»¬å•ç‹¬æ¥åˆ†æã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061/** * ä¾èµ–æ³¨å…¥ * * @param instance æ‰©å±•å®ç°å¯¹è±¡ ï¼ˆæ³¨æ„ï¼Œå¯èƒ½ä¼šæ˜¯ä¸€ä¸ªWrapperï¼‰ * @return */ private T injectExtension(T instance) &#123; try &#123; // åªæœ‰ExtensionFactoryæ‰©å±•ç‚¹å¯¹åº”çš„ExtensionLoaderå¯¹è±¡çš„è¯¥å±æ€§ä¸ºnullï¼Œå…¶å®ƒæ‰©å±•ç‚¹çš„ExtensionLoaderå¯¹è±¡çš„è¯¥å±æ€§å¿…ç„¶ä¸ä¸ºnull if (objectFactory != null) &#123; // åå°„è·å¾—æ‰©å±•å®ç°å¯¹è±¡ä¸­çš„æ‰€æœ‰æ–¹æ³• for (Method method : instance.getClass().getMethods()) &#123; // è¿‡æ»¤è§„åˆ™ä¸º ' setå¼€å¤´ + ä»…æœ‰ä¸€ä¸ªå‚æ•° + public ' çš„æ–¹æ³• if (method.getName().startsWith(\"set\") &amp;&amp; method.getParameterTypes().length == 1 &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123; /** * æ£€æŸ¥æ–¹æ³•æ˜¯å¦æœ‰ @DisableInject æ³¨è§£ï¼Œæœ‰è¯¥æ³¨è§£å°±å¿½ç•¥ä¾èµ–æ³¨å…¥ */ if (method.getAnnotation(DisableInject.class) != null) &#123; continue; &#125; // è·å–setteræ–¹æ³•å‚æ•°ç±»å‹ Class&lt;?&gt; pt = method.getParameterTypes()[0]; try &#123; // è·å¾—å±æ€§åï¼Œå¦‚ï¼šsetXxx -&gt; xxx String property = method.getName().length() &gt; 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : \"\"; /** * é€šè¿‡æ‰©å±•å·¥å‚è·å¾—å±æ€§å€¼ï¼Œå³ æ–¹æ³•å‚æ•°ç±»å‹ä½œä¸ºæ‰©å±•ç‚¹ï¼Œå±æ€§åä½œä¸ºæ‰©å±•åã€‚ * ExtensionFactoryçš„å®ç°æœ‰ä¸‰ä¸ª,AdaptiveExtensionFactoryæ˜¯å¯¹å…¶å®ƒä¸¤ä¸ªå·¥å‚çš„ç®¡ç†ï¼ŒgetExtensionæ–¹æ³•çš„çœŸæ­£è°ƒç”¨çš„æ˜¯å…¶å®ƒä¸¤ä¸ªå·¥å‚çš„æ–¹æ³•: * 1ï¼‰SpringExtensionFactory * getExtensionæ–¹æ³•ä¼šè¿”å›å®¹å™¨ä¸­åç§°ä¸ºpropertyå¹¶ä¸”ç±»å‹ä¸ºptçš„beanå¯¹è±¡ * 2ï¼‰SpiExtensionFactory * getExtensionæ–¹æ³•ä¼šè¿”å›ç±»å‹ä¸ºptçš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ï¼Œå› ä¸ºè¯¥æ–¹æ³•ä¼šæ ¡éªŒptæ˜¯æ¥å£ç±»å‹å¹¶ä¸”æœ‰@SPIæ³¨è§£ï¼Œç„¶åptæœ‰æ‹“å±•ç±»çš„æƒ…å†µä¸‹ï¼Œå°±ä¼šè·å–ptçš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ï¼Œpropertyæ²¡ç”¨åˆ° */ Object object = objectFactory.getExtension(pt, property); // é€šè¿‡åå°„è®¾ç½®å±æ€§å€¼ if (object != null) &#123; method.invoke(instance, object); &#125; &#125; catch (Exception e) &#123; logger.error(\"fail to inject via method \" + method.getName() + \" of interface \" + type.getName() + \": \" + e.getMessage(), e); &#125; &#125; &#125; &#125; &#125; catch (Exception e) &#123; logger.error(e.getMessage(), e); &#125; return instance; &#125; dubboçš„iocåŸºäºsetteræ–¹æ³•æ³¨å…¥ä¾èµ–çš„ï¼Œæ³¨å…¥çš„ä¾èµ–æ¥æºåˆ™éœ€è¦é€šè¿‡æ‰©å±•å·¥å‚æä¾›ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥åˆ†ædubboçš„æ‰©å±•å·¥å‚ã€‚ æ‰©å±•å·¥å‚æ¥å£123456789101112@SPIpublic interface ExtensionFactory &#123; /** * Get extension. è·å¾—æ‰©å±•å¯¹è±¡ * * @param type object type. æ‰©å±•æ¥å£ * @param name object name. æ‰©å±•å * @return object instance. æ‰©å±•å®ç°å®ä¾‹ */ &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name);&#125; ExtensionFactory æ‰©å±•å·¥å‚ï¼Œæ˜¯dubboçš„ä¸€ä¸ªæ‰©å±•ç‚¹ã€‚ä¸»è¦ç”¨äºè·å–æ‰©å±•å®ç°å¯¹è±¡æ‰€éœ€çš„ä¾èµ–ï¼Œç„¶åå®Œæˆä¾èµ–æ³¨å…¥ï¼Œè¯¥æ¥å£çš„umlå…³ç³»å¦‚ä¸‹ï¼š ç”±umlå›¾å¯çŸ¥ï¼Œè¯¥æ¥å£æœ‰ä¸‰ä¸ªæ‰©å±•å®ç°ç±»ã€‚AdaptiveExtensionFactoryæ˜¯å®ƒçš„è‡ªé€‚åº”å®ç°ç±»ï¼Œåªæ˜¯ç”¨æ¥ç®¡ç†SpiExtensionFactoryå’ŒSpringExtensionFactoryï¼Œå…·ä½“ä¾èµ–çš„æŸ¥æ‰¾è¿˜æ˜¯ç”±è¿™ä¸¤ä¸ªç±»å®Œæˆï¼Œä¸‹é¢æˆ‘ä»¬åˆ†åˆ«æ¥åˆ†æã€‚ AdaptiveExtensionFactory å·¥å‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546@Adaptivepublic class AdaptiveExtensionFactory implements ExtensionFactory &#123; /** * ExtensionFactoryæ‰©å±•å®ç°å¯¹è±¡é›†åˆ */ private final List&lt;ExtensionFactory&gt; factories; /** * AdaptiveExtensionFactoryä¹Ÿæ˜¯ExtensionFactoryçš„æ‰©å±•å®ç°ç±»ï¼Œåªæ˜¯æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯è‡ªé€‚åº”æ‰©å±•ç±»ï¼Œä¸åŒäºæ™®é€šçš„æ‰©å±•ç±» */ public AdaptiveExtensionFactory() &#123; ExtensionLoader&lt;ExtensionFactory&gt; loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class); List&lt;ExtensionFactory&gt; list = new ArrayList&lt;ExtensionFactory&gt;(); // ä½¿ç”¨ExtensionLoader åŠ è½½æ‹“å±•ç‚¹å®ç°ç±»ï¼ŒgetSupportedExtensions() è¿”å›çš„æ˜¯ExtensionFactoryæ‰©å±•ç‚¹å®ç°ç±»å¯¹åº”çš„æ‰©å±•åé›†åˆ for (String name : loader.getSupportedExtensions()) &#123; // æ ¹æ®æ‰©å±•åè·å– ExtensionFactory çš„æ‰©å±•å®ç°å¯¹è±¡ å¹¶åŠ å…¥ç¼“å­˜ä¸­ list.add(loader.getExtension(name)); &#125; factories = Collections.unmodifiableList(list); &#125; /** * è·å–ç›®æ ‡å¯¹è±¡ï¼Œä¸»è¦ç”¨äº &#123;@link ExtensionLoader#injectExtension(java.lang.Object)&#125; æ–¹æ³•ä¸­ï¼Œç”¨äºè·å–æ‰©å±•å®ç°å¯¹è±¡æ‰€éœ€è¦çš„ä¾èµ–å±æ€§å€¼ * * @param type object type. æ‰©å±•æ¥å£ * @param name object name. æ‰©å±•å * @param &lt;T&gt; * @return */ @Override public &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name) &#123; // éå†æ‰©å±•å·¥å‚å¯¹è±¡ï¼Œè·å–æŒ‡å®šçš„æ‰©å±•å¯¹è±¡æˆ–Springä¸­çš„Beanå¯¹è±¡ for (ExtensionFactory factory : factories) &#123; T extension = factory.getExtension(type, name); if (extension != null) &#123; return extension; &#125; &#125; return null; &#125;&#125; AdaptiveExtensionFactory è‡ªé€‚åº”æ‰©å±•å·¥å‚ï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª ExtensionFactory åˆ—è¡¨ï¼Œç”¨æ¥ç®¡ç†å…¶å®ƒçš„ExtensionFactoryã€‚åœ¨ç”¨æˆ·æ²¡æœ‰è‡ªå®šä¹‰ExtensionFactoryçš„æƒ…å†µä¸‹ï¼Œdubboç›®å‰æä¾›äº†ä¸¤ç§ ExtensionFactoryï¼Œåˆ†åˆ«æ˜¯ SpiExtensionFactory å’Œ SpringExtensionFactoryã€‚å‰è€…ç”¨äºåˆ›å»º è‡ªé€‚åº”çš„æ‹“å±•ï¼Œåè€…ä»Springå®¹å™¨ä¸­è·å–æ‰€éœ€ä¾èµ–ã€‚ SpiExtensionFactory å·¥å‚12345678910111213141516171819202122232425public class SpiExtensionFactory implements ExtensionFactory &#123; /** * è·å–è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ * * @param type object type. æ‰©å±•æ¥å£ * @param name object name. æ‰©å±•å * @param &lt;T&gt; * @return */ @Override public &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name) &#123; // æ ¡éªŒæ˜¯æ¥å£ç±»å‹å¹¶ä¸”æœ‰@SPIæ³¨è§£ if (type.isInterface() &amp;&amp; type.isAnnotationPresent(SPI.class)) &#123; // åŠ è½½æ‹“å±•æ¥å£å¯¹åº”çš„ ExtensionLoader ExtensionLoader&lt;T&gt; loader = ExtensionLoader.getExtensionLoader(type); // åˆ¤æ–­å½“å‰æ‰©å±•ç‚¹æ˜¯å¦æœ‰æ™®é€šçš„æ‰©å±•å®ç°ç±»ï¼Œæ³¨æ„ï¼šå½“å‰æ‰©å±•ç‚¹å­˜åœ¨æ™®é€šçš„æ‰©å±•å®ç°ç±»æ‰ä¼šå»è·å–å¯¹åº”çš„è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ if (!loader.getSupportedExtensions().isEmpty()) &#123; // è·å–è‡ªé€‚åº”æ‰©å±•å¯¹è±¡ return loader.getAdaptiveExtension(); &#125; &#125; return null; &#125;&#125; SpringExtensionFactory å·¥å‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public class SpringExtensionFactory implements ExtensionFactory &#123; private static final Logger logger = LoggerFactory.getLogger(SpringExtensionFactory.class); /** * Springä¸Šä¸‹æ–‡ */ private static final Set&lt;ApplicationContext&gt; contexts = new ConcurrentHashSet&lt;ApplicationContext&gt;(); /** * ä¿å­˜Springä¸Šä¸‹æ–‡ * * @param context */ public static void addApplicationContext(ApplicationContext context) &#123; contexts.add(context); &#125; public static void removeApplicationContext(ApplicationContext context) &#123; contexts.remove(context); &#125; // currently for test purpose public static void clearContexts() &#123; contexts.clear(); &#125; @Override @SuppressWarnings(\"unchecked\") public &lt;T&gt; T getExtension(Class&lt;T&gt; type, String name) &#123; // éå†SpringContextä¸Šä¸‹é›†åˆ for (ApplicationContext context : contexts) &#123; // åˆ¤æ–­å®¹å™¨ä¸­æ˜¯å¦åŒ…å«åç§°ä¸ºnameçš„bean if (context.containsBean(name)) &#123; // è·å¾—beanå¯¹è±¡ Object bean = context.getBean(name); // åˆ¤æ–­è·å¾—çš„beanç±»å‹æ˜¯å¦æ˜¯typeç±»å‹ if (type.isInstance(bean)) &#123; return (T) bean; &#125; &#125; &#125; logger.warn(\"No spring extension (bean) named:\" + name + \", try to find an extension (bean) of type \" + type.getName()); if (Object.class == type) &#123; return null; &#125; for (ApplicationContext context : contexts) &#123; try &#123; return context.getBean(type); &#125; catch (NoUniqueBeanDefinitionException multiBeanExe) &#123; logger.warn(\"Find more than 1 spring extensions (beans) of type \" + type.getName() + \", will stop auto injection. Please make sure you have specified the concrete parameter type and there's only one extension of that type.\"); &#125; catch (NoSuchBeanDefinitionException noBeanExe) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Error when get spring extension(bean) for type:\" + type.getName(), noBeanExe); &#125; &#125; &#125; logger.warn(\"No spring extension (bean) named:\" + name + \", type:\" + type.getName() + \" found, stop get bean.\"); return null; &#125;&#125; dubboä½¿ç”¨springå®¹å™¨ç®¡ç†çš„ä¾èµ–ä¸ºæ‰©å±•å¯¹è±¡æ³¨å…¥ä¾èµ–å±æ€§ã€‚dubboæ˜¯å¦‚ä½•ä¸springå®¹å™¨æ‰“é€šçš„å‘¢ï¼Ÿæœ‰ä¸¤å¤„ç»“åˆç‚¹ï¼Œåˆ†åˆ«æ˜¯æœåŠ¡æš´éœ²å’ŒæœåŠ¡å¼•ç”¨çš„æ—¶å€™ï¼Œåˆ©ç”¨ApplicationContextAwareçš„å›è°ƒæ–¹æ³•è®¾ç½®springä¸Šä¸‹æ–‡ã€‚ æœåŠ¡æš´éœ²ç»“åˆç‚¹ 123456789101112131415161718192021222324252627282930313233public class ServiceBean&lt;T&gt; extends ServiceConfig&lt;T&gt; implements InitializingBean, DisposableBean, ApplicationContextAware, ApplicationListener&lt;ContextRefreshedEvent&gt;, BeanNameAware, ApplicationEventPublisherAware &#123; // çœç•¥æ— å…³ä»£ç  @Override public void setApplicationContext(ApplicationContext applicationContext) &#123;// å½“å‰åŠ è½½çš„ä¸Šä¸‹æ–‡ this.applicationContext = applicationContext; // ä¸ºSpringæ‹“å±•å·¥å‚æ³¨å…¥ä¸Šä¸‹æ–‡ ,todo dubboå’ŒSpringå®¹å™¨æ‰“é€š SpringExtensionFactory.addApplicationContext(applicationContext); if (applicationContext != null) &#123; SPRING_CONTEXT = applicationContext; try &#123; Method method = applicationContext.getClass().getMethod(\"addApplicationListener\", new Class&lt;?&gt;[]&#123;ApplicationListener.class&#125;); // backward compatibility to spring 2.0.1 method.invoke(applicationContext, new Object[]&#123;this&#125;); supportedApplicationListener = true; // å½“å‰Springå®¹å™¨æ˜¯å¦æ”¯æŒä¸Šä¸‹æ–‡ç›‘å¬ &#125; catch (Throwable t) &#123; if (applicationContext instanceof AbstractApplicationContext) &#123; try &#123; Method method = AbstractApplicationContext.class.getDeclaredMethod(\"addListener\", new Class&lt;?&gt;[]&#123;ApplicationListener.class&#125;); // backward compatibility to spring 2.0.1 if (!method.isAccessible()) &#123; method.setAccessible(true); &#125; method.invoke(applicationContext, new Object[]&#123;this&#125;); supportedApplicationListener = true; &#125; catch (Throwable t2) &#123; &#125; &#125; &#125; &#125; &#125;&#125; æœåŠ¡å¼•ç”¨ç»“åˆç‚¹123456789public class ReferenceBean&lt;T&gt; extends ReferenceConfig&lt;T&gt; implements FactoryBean, ApplicationContextAware, InitializingBean, DisposableBean &#123; // çœç•¥æ— å…³ä»£ç  @Override public void setApplicationContext(ApplicationContext applicationContext) &#123; this.applicationContext = applicationContext; // dubbo å’Œ springå®¹å™¨æ‰“é€š SpringExtensionFactory.addApplicationContext(applicationContext); &#125;&#125; dubbo aop å®ç°dubbo aop å®ç°éœ€è¦Wrapperç±»ï¼Œå…³äºWrapperç±»å‰é¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œä¸å†è¯´æ˜ã€‚å…³äºdubbo aopçš„åŠŸèƒ½ä¹Ÿåœ¨å‰é¢çš„æµç¨‹ä¸­ä½“ç°å‡ºæ¥äº†ï¼Œå•ç‹¬æŠŠdubbo aopæ‹¿å‡ºæ¥è¿›è¡Œè¯´æ˜æ˜¯è€ƒè™‘åˆ°å‰é¢çš„ç¯‡å¹…æ²¡æœ‰å…·ä½“åˆ°Wrapperç±»ï¼Œåªæ˜¯é˜è¿°äº†å…¶åŠŸèƒ½å’Œå®ç°ã€‚å®ç°ä¸€ä¸ªWrapperç±»çš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š å®šä¹‰ä¸€ä¸ªWrapperç±»å¹¶å®ç°æ‰©å±•æ¥å£ï¼Œç„¶åç¼–å†™AOPé€»è¾‘ã€‚ åœ¨é…ç½®æ–‡ä»¶é…ç½®è‡ªå®šä¹‰çš„Wrapperç±» å®šä¹‰ Wrapperç±»123456789101112131415161718192021public class CommandWrapper implements Command &#123; Command command; /** * æ„é€ æ–¹æ³•çš„å‚æ•°å¿…é¡»æ˜¯æ‰©å±•ç‚¹ç±»å‹ * * @param command */ public CommandWrapper(Command command) &#123; this.command = command; &#125; @Override public void execute() &#123; System.out.println(\"CommandWrapper is running ...\"); // æ‰§è¡Œæ‰©å±•å®ç°å¯¹è±¡ï¼Œæ³¨æ„ï¼Œå¦‚æœä¸æ˜¾ç¤ºè°ƒç”¨æ‰©å±•å®ç°ï¼Œé‚£ä¹ˆå°±è¾¾ä¸åˆ°ç›®æ ‡ç»“æœï¼Œåªä¼šæ‰§è¡Œè¿™ä¸ªå¹¶æ²¡æœ‰çœŸæ­£å®ç°çš„Wrapper command.execute(); &#125;&#125; å®šä¹‰Wrapperç±»å¾ˆç®€å•ï¼Œåªè¦æŒ‰ç…§Wrapperç±»çš„è¦æ±‚è¿›è¡Œå®ç°å³å¯ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæˆ‘ä»¬æ‰€è¯´çš„Wrapperç±»å…¶å®ä¸å¼ºåˆ¶ç±»åä»¥Wrapperç»“å°¾ï¼Œåªè¦ç¬¦åˆWrapperç±»çš„è¦æ±‚å°±æ˜¯ä¸€ä¸ªWrapperç±»ï¼Œå¹¶ä¸æ˜¯ç”¨åå­—è¿›è¡ŒåŒºåˆ†æ˜¯å¦Wrapperç±»ï¼Œåªæ˜¯è¿™æ ·å†™æ˜¯dubboçš„ä¸€ç§çº¦å®šç½¢äº†ã€‚ é…ç½® Wrapperç±» dubbo å†…ç½®çš„Wrapper ä¸¾ä¾‹123456789101112131415161718192021222324252627/** * å®ç° Clusteræ¥å£ï¼ŒMockClusterWrapperå®ç°ç±»ï¼Œæ³¨æ„å®ƒæ˜¯ä¸ªWrapperç±»ï¼Œå¯¹åº”çš„Clusterå¯¹è±¡éƒ½ä¼šè¢«å®ƒæ‰€åŒ…è£…ã€‚ */public class MockClusterWrapper implements Cluster &#123; /** * çœŸæ­£çš„Cluster å¯¹è±¡ */ private Cluster cluster; public MockClusterWrapper(Cluster cluster) &#123; this.cluster = cluster; &#125; /** * åˆ›å»ºMockClusterInvokerå¯¹è±¡ * * @param directory Directory å¯¹è±¡ * @param &lt;T&gt; * @return * @throws RpcException */ @Override public &lt;T&gt; Invoker&lt;T&gt; join(Directory&lt;T&gt; directory) throws RpcException &#123; return new MockClusterInvoker&lt;T&gt;(directory, this.cluster.join(directory)); &#125;&#125; æ€»ç»“æœ¬ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†dubbo spi ç”¨æ³•ï¼Œå¹¶å¯¹ dubbo spi çš„æ ¸å¿ƒæºç è¿›è¡Œäº†åˆ†æï¼Œæ€»ä½“ä¸Šä¸ç®—å¤æ‚ä½†å¾ˆç¹çï¼Œç»†èŠ‚ç‚¹å¾ˆå¤šï¼Œæ¯”å¦‚ï¼Œæ‰©å±•åç”Ÿæˆçš„è§„åˆ™ï¼Œæ‰©å±•ç±»çš„ç§ç±»åŒºåˆ«ï¼Œè‡ªåŠ¨æ¿€æ´»æ‰©å±•ç”Ÿæ•ˆæ¡ä»¶ã€‚æƒ³è¦æŒæ¡æ•´ä¸ªæµç¨‹éœ€è¦è€å¿ƒè°ƒè¯•æºç ï¼Œç¬”è€…å·®ç‚¹è¢«spiåŠæ¥ä¸‹æ¥è¦åˆ†æçš„dubboé…ç½®ç»™åŠé€€äº†ã€‚å¦å¤–ï¼Œç”±äºdubbo spiè‡ªé€‚åº”æœºåˆ¶æ¶‰åŠåˆ°çš„ä»£ç é‡è¾ƒå¤šï¼Œé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å•ç‹¬è¿›è¡Œåˆ†æã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"SPI","slug":"SPI","permalink":"https://gentryhuang.com/tags/SPI/"}]},{"title":"Java SPI","slug":"rpc/SPIæœºåˆ¶ä¹‹JDK","date":"2020-03-10T16:00:00.000Z","updated":"2020-09-03T01:23:40.731Z","comments":false,"path":"posts/a9c33b8c/","link":"","permalink":"https://gentryhuang.com/posts/a9c33b8c/","excerpt":"","text":"SPIæ¦‚è¿°SPIï¼ˆService Provider Interfaceï¼‰æ˜¯JDKå†…ç½®çš„ä¸€ç§æœåŠ¡æä¾›å‘ç°æœºåˆ¶ã€‚ä¸€ä¸ªæœåŠ¡(Service)é€šå¸¸æŒ‡çš„æ˜¯å·²çŸ¥çš„æ¥å£æˆ–è€…æŠ½è±¡ç±»ï¼ŒæœåŠ¡æä¾›æ–¹å°±æ˜¯å¯¹è¿™ä¸ªæ¥å£æˆ–è€…æŠ½è±¡ç±»çš„å®ç°ï¼Œç„¶åæŒ‰ç…§SPIæ ‡å‡†å­˜æ”¾åˆ°èµ„æºè·¯å¾„META-INF/servicesç›®å½•ä¸‹ï¼Œæ–‡ä»¶çš„å‘½åä¸ºè¯¥æœåŠ¡æ¥å£çš„å…¨é™å®šåã€‚Java SPIä½¿ç”¨äº†ç­–ç•¥æ¨¡å¼ï¼Œä¸€ä¸ªæ¥å£å¤šç§å®ç°ï¼Œæˆ‘ä»¬åªå£°æ˜æ¥å£ï¼Œå…·ä½“çš„å®ç°å¹¶ä¸åœ¨ç¨‹åºä¸­ç›´æ¥ç¡®å®šï¼Œè€Œæ˜¯ç”±é…ç½®å†³å®šã€‚ çº¦å®š æœåŠ¡çš„æä¾›è€…çš„æ¥å£ï¼Œå®ƒçš„å¤šç§å®ç°ä¸€èˆ¬ä¼šåœ¨jaråŒ…çš„META-INF/services ç›®å½•ä¸‹ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸‹åˆ›å»ºæœåŠ¡æä¾›è€…æ¥å£åŒåæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­å°±æ˜¯æ¥å£çš„å…·ä½“å®ç°ç±»çš„å…¨é™å®šæ€§ç±»åã€‚è€Œå½“å¤–éƒ¨åŠ è½½è¿™ä¸ªæœåŠ¡æä¾›åŠŸèƒ½æ—¶ï¼Œå°±èƒ½é€šè¿‡è¯¥jaråŒ…META-INF/services/ä¸‹çš„é…ç½®æ–‡ä»¶å¾—åˆ°å…·ä½“çš„å®ç°ç±»åï¼Œå¹¶åŠ è½½å®ä¾‹åŒ–ï¼Œå®ŒæˆåŠŸèƒ½çš„è£…é…ã€‚ å®ç°æ­¥éª¤ å®šä¹‰æ¥å£ ç¼–å†™æ¥å£å®ç°ç±» åœ¨META-INF/services ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªä»¥æ¥å£å…¨è·¯å¾„åçš„æ–‡ä»¶ æ–‡ä»¶å†…å®¹æ˜¯æ¥å£å®ç°ç±»çš„å…¨è·¯å¾„åï¼Œå¯ä»¥æœ‰å¤šä¸ªï¼Œå¦‚æœå¤šä¸ªéœ€è¦ä½¿ç”¨åˆ†è¡Œç¬¦åˆ†å‰² åœ¨ä»£ç ä¸­ä½¿ç”¨jdkçš„ServiceLoaderæ¥åŠ è½½æ¥å£çš„å…·ä½“å®ç°ç±» ç¤ºä¾‹æœåŠ¡æä¾›è€…æ¥å£1234567package com.alibaba.dubbo.spi;public interface Command &#123; /** * æ‰§è¡Œæ–¹æ³• */ void execute();&#125; æœåŠ¡æä¾›è€…å®ç°ç±»1234567package com.alibaba.dubbo.spi.impl;public class StartCommand implements Command&#123; @Override public void execute() &#123; System.out.println(\"start....\"); &#125; &#125; 1234567package com.alibaba.dubbo.spi.impl;public class ShutdownCommand implements Command&#123; @Override public void execute() &#123; System.out.println(\"shutdown....\"); &#125; &#125; åœ¨META-INF/servicesä¸‹åˆ›å»º com.alibaba.dubbo.spi.Commandæ–‡ä»¶123# å†…å®¹com.alibaba.dubbo.spi.impl.StartCommandcom.alibaba.dubbo.spi.impl.ShutdownCommand åŠ è½½æ‰©å±•å®ç°123456789101112131415public class Main &#123; public static void main(String[] args) &#123; // ServiceLoaderæ˜¯JDKçš„ï¼Œç”¨æ¥åŠ è½½æ¥å£çš„å®ç°ç±»ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶åŠ è½½ï¼‰ ServiceLoader&lt;Command&gt; serviceLoader = ServiceLoader.load(Command.class); for (Command command : serviceLoader) &#123; if (command instanceof StartCommand) &#123; System.out.println(\"åˆ¤æ–­å‡ºæ˜¯Startï¼š\" + command.getClass().getSimpleName()); &#125; if (command instanceof ShutdownCommand) &#123; System.out.println(\"åˆ¤æ–­å‡ºæ˜¯Shutdownï¼š\" + command.getClass().getSimpleName()); &#125; command.execute(); &#125; &#125;&#125; ä½¿ç”¨jdkçš„spiçš„ä¾èµ–mysqlé©±åŠ¨ SpringServletContaineråˆå§‹åŒ–å™¨ å°ç»“jdkçš„spiæœºåˆ¶è™½ç„¶å®ç°äº†æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå³åœ¨æ¨¡å—è£…é…çš„æ—¶å€™ä¸åœ¨æ¨¡å—ä¸­å†™æ­»ä»£ç å°±èƒ½å¤Ÿå‘ç°æœåŠ¡ï¼Œä½†æ˜¯å­˜åœ¨æ€§èƒ½å’Œå¥å£®æ€§é—®é¢˜ï¼Œå…·ä½“çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆåœ¨dubbo spiä¸­è¯´æ˜ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"JDK","slug":"JDK","permalink":"https://gentryhuang.com/tags/JDK/"},{"name":"SPI","slug":"SPI","permalink":"https://gentryhuang.com/tags/SPI/"}]},{"title":"Dubboé¡¹ç›®ç»“æ„æ€»è§ˆ","slug":"rpc/dubboé¡¹ç›®ç»“æ„æ€»è§ˆ","date":"2020-03-08T16:00:00.000Z","updated":"2020-08-15T13:48:14.901Z","comments":false,"path":"posts/e2577ca1/","link":"","permalink":"https://gentryhuang.com/posts/e2577ca1/","excerpt":"","text":"å‰è¨€dubboæºç åˆ†æç›¸å…³æ–‡ç« ä½¿ç”¨çš„dubboç‰ˆæœ¬ä¸º2.6.5ï¼Œå¦‚ä½¿ç”¨å…¶å®ƒç‰ˆæœ¬ä¼šæ˜¾ç¤ºè¯´æ˜ã€‚å‚è€ƒæ–‡æ¡£ä»¥å®˜æ–¹æ–‡æ¡£ ä¸ºä¸»ã€å®˜ç½‘æ–‡æ¡£å†™çš„å¤ªå¥½äº†ã€‘ï¼Œå‚è€ƒä¹¦ç±ã€Šæ·±å…¥ç†è§£Apache Dubboä¸å®æˆ˜ã€‹ã€‚ æ¡†æ¶è®¾è®¡ç”±äºdubboå®˜æ–¹æ–‡æ¡£å†™çš„éå¸¸å¥½ï¼Œè¿™é‡Œä¼šå¤§é‡å¼•ç”¨ç›¸å…³çš„å›¾ç‰‡åŠè¯´æ˜ï¼Œç‚¹æˆ‘ è¿›å…¥å®˜æ–¹æ–‡æ¡£ã€‚ æ•´ä½“è®¾è®¡ å›¾ä¾‹è¯´æ˜ï¼š å›¾ä¸­å·¦è¾¹æ·¡è“èƒŒæ™¯çš„ä¸ºæœåŠ¡æ¶ˆè´¹æ–¹ä½¿ç”¨çš„æ¥å£ï¼Œå³è¾¹æ·¡ç»¿è‰²èƒŒæ™¯çš„ä¸ºæœåŠ¡æä¾›æ–¹ä½¿ç”¨çš„æ¥å£ï¼Œä½äºä¸­è½´çº¿ä¸Šçš„ä¸ºåŒæ–¹éƒ½ç”¨åˆ°çš„æ¥å£ã€‚ å›¾ä¸­ä»ä¸‹è‡³ä¸Šåˆ†ä¸ºåå±‚ï¼Œå„å±‚å‡ä¸ºå•å‘ä¾èµ–ï¼Œå³è¾¹çš„é»‘è‰²ç®­å¤´ä»£è¡¨å±‚ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥å‰¥ç¦»ä¸Šå±‚è¢«å¤ç”¨ï¼Œå…¶ä¸­ï¼ŒService å’Œ Config å±‚ä¸º APIï¼Œå…¶å®ƒå„å±‚å‡ä¸º SPIã€‚ å›¾ä¸­ç»¿è‰²å°å—çš„ä¸ºæ‰©å±•æ¥å£ï¼Œè“è‰²å°å—ä¸ºå®ç°ç±»ï¼Œå›¾ä¸­åªæ˜¾ç¤ºç”¨äºå…³è”å„å±‚çš„å®ç°ç±»ã€‚ å›¾ä¸­è“è‰²è™šçº¿ä¸ºåˆå§‹åŒ–è¿‡ç¨‹ï¼Œå³å¯åŠ¨æ—¶ç»„è£…é“¾ï¼Œçº¢è‰²å®çº¿ä¸ºæ–¹æ³•è°ƒç”¨è¿‡ç¨‹ï¼Œå³è¿è¡Œæ—¶è°ƒæ—¶é“¾ï¼Œç´«è‰²ä¸‰è§’ç®­å¤´ä¸ºç»§æ‰¿ï¼Œå¯ä»¥æŠŠå­ç±»çœ‹ä½œçˆ¶ç±»çš„åŒä¸€ä¸ªèŠ‚ç‚¹ï¼Œçº¿ä¸Šçš„æ–‡å­—ä¸ºè°ƒç”¨çš„æ–¹æ³•ã€‚ æ€»ä½“åˆ†å±‚ä»æ•´ä½“è®¾è®¡è®¾è®¡å›¾å¯çŸ¥æ‚‰ï¼Œdubboçš„æ€»ä½“åˆ†ä¸ºä¸šåŠ¡å±‚(Business)ã€RPCå±‚ã€Remoteä¸‰å±‚ï¼Œæ¯ä¸€å±‚ç»†åˆ†å…±å¯åˆ†æˆåå±‚ã€‚Serviceå’ŒConfigä¸¤å±‚å¯ä»¥è®¤ä¸ºæ˜¯APIå±‚ï¼Œä¸»è¦æä¾›ç»™APIä½¿ç”¨è€…ï¼Œä½¿ç”¨è€…æ— é¡»å…³å¿ƒåº•å±‚çš„å®ç°ï¼Œåªéœ€è¦é…ç½®å’Œå®Œæˆä¸šåŠ¡ä»£ç å³å¯ã€‚å…¶å®ƒå…«å±‚åˆåœ¨ä¸€èµ·å¯ä»¥è®¤ä¸ºæ˜¯SPIå±‚ï¼Œç”¨äºæ‰©å±•ï¼Œå³å¼€æ”¾è€…å¯ä»¥åŸºäºSPIå±‚è‡ªå®šä¹‰ä¸€äº›ç»„ä»¶æ¥å®Œæˆå…·ä½“ä¸šåŠ¡ï¼Œä¹Ÿå¯ä»¥åŸºäºdubboæ¡†æ¶åšå®šåˆ¶æ€§çš„äºŒæ¬¡å¼€å‘ã€‚ dubboæ ¸å¿ƒç»„ä»¶dubboä¸­æ¯å±‚éƒ½ä»£è¡¨äº†ä¸åŒçš„é€»è¾‘å®ç°ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªä¸ªç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶æ„æˆäº†æ•´ä¸ªdubboä½“ç³»ã€‚å¯¹äºä½¿ç”¨æ–¹æ¥è¯´æ›´å¤šæ¥è§¦åˆ°çš„æ˜¯é…ç½®ï¼ŒæŒ‰ç…§dubboé…ç½®è§„åˆ™é€‰æ‹©é€‚åˆå½“å‰ä¸šåŠ¡çš„é…ç½®é¡¹å³å¯è½»æ¾å®ç°rpcè°ƒç”¨ã€‚æ­£æ˜¯ç”±äºdubboçš„å„ä¸ªç»„ä»¶èŒè´£åˆ†æ˜çš„è®¾è®¡ï¼Œæ‰ä½¿å¾—dubboæ¡†æ¶èƒ½å¤Ÿåšåˆ°é«˜æ‰©å±•æ€§ã€‚dubboæ ¸å¿ƒç»„ä»¶å¦‚ä¸‹è¡¨ï¼š åˆ†å±‚å ä½œç”¨ service ä¸šåŠ¡å±‚ï¼šåŒ…æ‹¬ä¸šåŠ¡ä»£ç çš„æ¥å£ä¸å®ç°ï¼Œå³å¼€æ”¾è€…å®ç°çš„ä¸šåŠ¡ä»£ç ã€‚ config é…ç½®å±‚ï¼šä¸»è¦å›´ç»•ServiceConfigï¼ˆæœåŠ¡æä¾›æ–¹é…ç½®ï¼‰å’ŒReferenceConfigï¼ˆæœåŠ¡æ¶ˆè´¹æ–¹ï¼‰å±•å¼€ï¼Œåˆå§‹åŒ–é…ç½®ä¿¡æ¯ã€‚å¯ä»¥ç†è§£ä¸ºè¯¥å±‚ç®¡ç†äº†æ•´ä¸ªdubboçš„é…ç½® proxy æœåŠ¡ä»£ç†å±‚ï¼šåœ¨dubboä¸­ï¼Œæ— è®ºæä¾›è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œæ¡†æ¶éƒ½ä¼šç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹ä¸Šå±‚æ˜¯é€æ˜çš„ã€‚å½“è°ƒç”¨ä¸€ä¸ªè¿œç¨‹æ¥å£æ—¶ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯è°ƒç”¨äº†ä¸€ä¸ªæœ¬åœ°æ¥å£ä¸€æ ·ï¼Œä»£ç†å±‚ä¼šè‡ªåŠ¨åšè¿œç¨‹è°ƒç”¨å¹¶è¿”å›ç»“æœï¼Œå³è®©ä¸šåŠ¡å±‚å¯¹è¿œç¨‹è°ƒç”¨å®Œå…¨æ— æ„ŸçŸ¥ registry æ³¨å†Œä¸­å¿ƒå±‚ï¼šè´Ÿè´£dubboæ¡†æ¶çš„æœåŠ¡æ³¨å†Œä¸å‘ç°ã€‚å½“æœ‰æ–°çš„æœåŠ¡åŠ å…¥æˆ–æ—§æœåŠ¡ä¸‹çº¿æ—¶ï¼Œæ³¨å†Œä¸­å¿ƒéƒ½ä¼šæ„ŸçŸ¥å¹¶é€šçŸ¥ç»™æ‰€æœ‰è®¢é˜…æ–¹ cluster é›†ç¾¤å®¹é”™å±‚ï¼šæä¾›å¤šç§å®¹é”™ç­–ç•¥ã€å°è£…å¤šä¸ªæä¾›è€…çš„è·¯ç”±åŠè´Ÿè½½å‡è¡¡ï¼Œå¹¶æ¡¥æ¥æ³¨å†Œä¸­å¿ƒï¼Œä»¥ Invoker ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Cluster, Directory, Router, LoadBalanceä»¥åŠMock monitor ç›‘æ§å±‚ï¼šRPC è°ƒç”¨æ¬¡æ•°å’Œè°ƒç”¨æ—¶é—´ç›‘æ§ç­‰ protocol è¿œç¨‹è°ƒç”¨å±‚ï¼šå°è£…RPCè°ƒç”¨å…·ä½“è¿‡ç¨‹ï¼Œä»¥ Invocation, Result ä¸ºä¸­å¿ƒï¼Œæ˜¯ Invoker æš´éœ²å’Œå¼•ç”¨çš„ä¸»åŠŸèƒ½å…¥å£ï¼Œå®ƒè´Ÿè´£ Invoker çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ exchange ä¿¡æ¯äº¤æ¢å±‚ï¼šå»ºç«‹Request-Responseæ¨¡å‹ï¼Œå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒ transport ç½‘ç»œä¼ è¾“å±‚ï¼šæŠŠç½‘ç»œä¼ è¾“æŠ½è±¡ä¸ºç»Ÿä¸€æ¥å£ï¼Œä»¥ Message ä¸ºä¸­å¿ƒï¼Œå¦‚Minaå’ŒNettyè™½ç„¶æ¥å£ä¸ä¸€æ ·ï¼Œä½†æ˜¯Dubboåœ¨å®ƒä»¬ä¸Šé¢å°è£…äº†ç»Ÿä¸€çš„æ¥å£ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®å…¶æ‰©å±•æ¥å£æ·»åŠ æ›´å¤šçš„ç½‘ç»œä¼ è¾“æ–¹å¼ã€‚ serialize åºåˆ—åŒ–å±‚ï¼šå¦‚æœæ•°æ®è¦é€šè¿‡ç½‘ç»œè¿›è¡Œä¼ è¾“ï¼Œåˆ™éœ€è¦å…ˆåšåºåˆ—åŒ–ï¼Œè½¬æˆäºŒè¿›åˆ¶æµã€‚åºåˆ—åŒ–å±‚è´Ÿè´£ç®¡ç†æ•´ä¸ªæ¡†æ¶ç½‘ç»œä¼ è¾“æ—¶çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å·¥ä½œ å…³ç³»è¯´æ˜ åœ¨ RPC ä¸­ï¼ŒProtocol æ˜¯æ ¸å¿ƒå±‚ï¼Œä¹Ÿå°±æ˜¯åªè¦æœ‰ Protocol + Invoker + Exporter å°±å¯ä»¥å®Œæˆéé€æ˜çš„ RPC è°ƒç”¨ï¼Œç„¶ååœ¨ Invoker çš„ä¸»è¿‡ç¨‹ä¸Š Filter æ‹¦æˆªç‚¹ã€‚ å›¾ä¸­çš„ Consumer å’Œ Provider æ˜¯æŠ½è±¡æ¦‚å¿µï¼Œåªæ˜¯æƒ³è®©çœ‹å›¾è€…æ›´ç›´è§‚çš„äº†è§£å“ªäº›ç±»åˆ†å±äºå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯ï¼Œä¸ç”¨ Client å’Œ Server çš„åŸå› æ˜¯ Dubbo åœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½ä½¿ç”¨ Provider, Consumer, Registry, Monitor åˆ’åˆ†é€»è¾‘æ‹“æ™®èŠ‚ç‚¹ï¼Œä¿æŒç»Ÿä¸€æ¦‚å¿µã€‚ è€Œ Cluster æ˜¯å¤–å›´æ¦‚å¿µï¼Œæ‰€ä»¥ Cluster çš„ç›®çš„æ˜¯å°†å¤šä¸ª Invoker ä¼ªè£…æˆä¸€ä¸ª Invokerï¼Œè¿™æ ·å…¶å®ƒäººåªè¦å…³æ³¨ Protocol å±‚ Invoker å³å¯ï¼ŒåŠ ä¸Š Cluster æˆ–è€…å»æ‰ Cluster å¯¹å…¶å®ƒå±‚éƒ½ä¸ä¼šé€ æˆå½±å“ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªæä¾›è€…æ—¶ï¼Œæ˜¯ä¸éœ€è¦ Cluster çš„ã€‚ Proxy å±‚å°è£…äº†æ‰€æœ‰æ¥å£çš„é€æ˜åŒ–ä»£ç†ï¼Œè€Œåœ¨å…¶å®ƒå±‚éƒ½ä»¥ Invoker ä¸ºä¸­å¿ƒï¼Œåªæœ‰åˆ°äº†æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨æ—¶ï¼Œæ‰ç”¨ Proxy å°† Invoker è½¬æˆæ¥å£ï¼Œæˆ–å°†æ¥å£å®ç°è½¬æˆ Invokerï¼Œä¹Ÿå°±æ˜¯å»æ‰ Proxy å±‚ RPC æ˜¯å¯ä»¥ Run çš„ï¼Œåªæ˜¯ä¸é‚£ä¹ˆé€æ˜ï¼Œä¸é‚£ä¹ˆçœ‹èµ·æ¥åƒè°ƒæœ¬åœ°æœåŠ¡ä¸€æ ·è°ƒè¿œç¨‹æœåŠ¡ã€‚ è€ŒRemoting å®ç°æ˜¯ Dubbo åè®®çš„å®ç°ï¼Œå¦‚æœä½ é€‰æ‹© RMI åè®®ï¼Œæ•´ä¸ª Remoting éƒ½ä¸ä¼šç”¨ä¸Šï¼ŒRemoting å†…éƒ¨å†åˆ’ä¸º Transport ä¼ è¾“å±‚å’Œ Exchange ä¿¡æ¯äº¤æ¢å±‚ï¼ŒTransport å±‚åªè´Ÿè´£å•å‘æ¶ˆæ¯ä¼ è¾“ï¼Œæ˜¯å¯¹ Mina, Netty, Grizzly çš„æŠ½è±¡ï¼Œå®ƒä¹Ÿå¯ä»¥æ‰©å±• UDP ä¼ è¾“ï¼Œè€Œ Exchange å±‚æ˜¯åœ¨ä¼ è¾“å±‚ä¹‹ä¸Šå°è£…äº† Request-Response è¯­ä¹‰ã€‚ Registry å’Œ Monitor å®é™…ä¸Šä¸ç®—ä¸€å±‚ï¼Œè€Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ï¼Œåªæ˜¯ä¸ºäº†å…¨å±€æ¦‚è§ˆï¼Œç”¨å±‚çš„æ–¹å¼ç”»åœ¨ä¸€èµ·ã€‚ é¢†åŸŸæ¨¡å‹ Protocol æ˜¯æœåŠ¡åŸŸï¼Œå®ƒæ˜¯ Invoker æš´éœ²å’Œå¼•ç”¨çš„ä¸»åŠŸèƒ½å…¥å£ï¼Œå®ƒè´Ÿè´£ Invoker çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ Invoker æ˜¯å®ä½“åŸŸï¼Œå®ƒæ˜¯ Dubbo çš„æ ¸å¿ƒæ¨¡å‹ï¼Œå…¶å®ƒæ¨¡å‹éƒ½å‘å®ƒé æ‰°ï¼Œæˆ–è½¬æ¢æˆå®ƒï¼Œå®ƒä»£è¡¨ä¸€ä¸ªå¯æ‰§è¡Œä½“ï¼Œå¯å‘å®ƒå‘èµ· invoke è°ƒç”¨ï¼Œå®ƒæœ‰å¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°çš„å®ç°ï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªè¿œç¨‹çš„å®ç°ï¼Œä¹Ÿå¯èƒ½ä¸€ä¸ªé›†ç¾¤å®ç°ã€‚ Invocation æ˜¯ä¼šè¯åŸŸï¼Œå®ƒæŒæœ‰è°ƒç”¨è¿‡ç¨‹ä¸­çš„å˜é‡ï¼Œæ¯”å¦‚æ–¹æ³•åï¼Œå‚æ•°ç­‰ã€‚ ç‰¹åˆ«è¯´æ˜: protocolæ˜¯å¯¹æ•°æ®æ ¼å¼çš„ä¸€ç§çº¦å®šï¼Œå®ƒå¯ä»¥æŠŠæˆ‘ä»¬å¯¹æ¥å£çš„é…ç½®ï¼Œæ ¹æ®å…·ä½“çš„åè®®è½¬æ¢æˆä¸åŒçš„Invokerå¯¹è±¡ã€‚ åŸºæœ¬è®¾è®¡åŸåˆ™ Dubbo è‡ªèº«çš„åŠŸèƒ½ä¹Ÿæ˜¯é€šè¿‡æ‰©å±•ç‚¹å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯ Dubbo çš„æ‰€æœ‰åŠŸèƒ½ç‚¹éƒ½å¯è¢«ç”¨æˆ·è‡ªå®šä¹‰æ‰©å±•æ‰€æ›¿æ¢ é‡‡ç”¨ URL ä½œä¸ºé…ç½®ä¿¡æ¯çš„ç»Ÿä¸€æ ¼å¼ï¼Œæ‰€æœ‰æ‰©å±•ç‚¹éƒ½é€šè¿‡ä¼ é€’ URL æºå¸¦é…ç½®ä¿¡æ¯ æºç åˆ†æèŒƒå›´é™¤äº†æ¶æ„å›¾ä¸­çš„Monitoræ¨¡å—ä¸ä¼šè¯¦ç»†åˆ†æï¼Œå…¶å®ƒéƒ½ä¼šè¯¦ç»†åˆ†æã€‚ å°ç»“æœ¬æ–‡ä¸»è¦ç®€å•ä»‹ç»äº†dubboçš„æ€»ä½“æ¶æ„å›¾å’Œæ ¸å¿ƒç»„ä»¶ï¼Œè¿™æ ·åœ¨é˜…è¯»æºç ä¹‹å‰æœ‰æ•´ä½“çš„æ¦‚å¿µã€‚æ›´è¯¦ç»†çš„ä»‹ç»å¯ä»¥å‚è€ƒå®˜ç½‘æ–‡æ¡£ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"URLç»Ÿä¸€æ¨¡å‹","slug":"rpc/dubboä¹‹urlç»Ÿä¸€æ¨¡å‹","date":"2020-03-06T16:00:00.000Z","updated":"2020-09-04T09:14:17.485Z","comments":false,"path":"posts/46f95e97/","link":"","permalink":"https://gentryhuang.com/posts/46f95e97/","excerpt":"","text":"URL å®šä¹‰URL çš„å…¨åå³ç»Ÿä¸€èµ„æºå®šä½ç¬¦ï¼Œå› ç‰¹ç½‘ä¸Šçš„å¯ç”¨èµ„æºæ˜¯ä½¿ç”¨å­—ç¬¦ä¸²æ¥è¡¨ç¤ºçš„ï¼Œè€Œè¿™äº›å…·æœ‰ç‰¹å®šæ ¼å¼å’Œè¯­ä¹‰çš„å­—ç¬¦ä¸²å°±æ˜¯URL æ ‡å‡†çš„URLæ ¼å¼: 12ç»„æˆï¼šåè®®ã€è´¦å·&#x2F;å¯†ç ã€ä¸»æœºã€ç«¯å£ã€è·¯å¾„ [å¤§å¤šæ•°urlä¸éœ€è¦è´¦å·&#x2F;å¯†ç ,éœ€è¦å®‰å…¨è®¤è¯çš„æ‰ä¼šéœ€è¦]æ ¼å¼ï¼šprotocol:&#x2F;&#x2F;[username:password@]host:port&#x2F;path?key&#x3D;value&amp;key&#x3D;value Dubboä¸­çš„ URLDubboä¸­ä¹Ÿä½¿ç”¨äº†ç±»ä¼¼çš„ URLï¼ŒURL ä¸­çš„æ¯ä¸ªå‚æ•°å‡ ä¹éƒ½æœ‰å„è‡ªçš„ç”¨é€”ï¼Œå®ƒä»¬å¾€å¾€å¯¹åº”ç€ç‰¹å®šçš„åŠŸèƒ½æˆ–å®ç°ã€‚Dubboä¸­å¯¹è¿™ä¸ª URL åšäº†å°è£…ï¼Œå¤§ä½“ä¸Šåˆ†ä¸ºä¸»è¦å‚æ•°å’Œé”®å€¼å¯¹å‚æ•°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394/** * url ä¾‹å­: * &lt;ul&gt; * &lt;li&gt;http://www.facebook.com/friends?param1=value1&amp;amp;param2=value2 * &lt;li&gt;http://username:password@10.20.130.230:8080/list?version=1.0.0 * &lt;li&gt;ftp://username:password@192.168.1.7:21/1/read.txt * &lt;li&gt;registry://192.168.1.7:9090/com.alibaba.service1?param1=value1&amp;amp;param2=value2 * &lt;/ul&gt; * ä¸€äº›ç‰¹åˆ«çš„url: * &lt;ul&gt; * &lt;li&gt;192.168.1.3:20880&lt;br&gt; * for this case, url protocol = null, url host = 192.168.1.3, port = 20880, url path = null * &lt;li&gt;file:///home/user1/router.js?type=script&lt;br&gt; * for this case, url protocol = file, url host = null, url path = home/user1/router.js * &lt;li&gt;file://home/user1/router.js?type=script&lt;br&gt; * for this case, url protocol = file, url host = home, url path = user1/router.js * &lt;li&gt;file:///D:/1/router.js?type=script&lt;br&gt; * for this case, url protocol = file, url host = null, url path = D:/1/router.js * &lt;li&gt;file:/D:/1/router.js?type=script&lt;br&gt; * åŒä¸Šï¼š file:///D:/1/router.js?type=script * &lt;li&gt;/home/user1/router.js?type=script &lt;br&gt; * å¯¹äºè¿™äº›ä¾‹å­ï¼š url protocol = null, url host = null, url path = home/user1/router.js * &lt;li&gt;home/user1/router.js?type=script &lt;br&gt; * å¯¹äºè¿™äº›ä¾‹å­ï¼š url protocol = null, url host = home, url path = user1/router.js * &lt;/ul&gt; * * @see java.net.URL * @see java.net.URI */public final class URL implements Serializable &#123; private static final long serialVersionUID = -1985165475234910535L; /** * åè®®å */ private final String protocol; /** * ç”¨æˆ·å */ private final String username; /** * å¯†ç  */ private final String password; /** by default, host to registry * åœ°å€ */ private final String host; /** by default, port to registry * ç«¯å£ */ private final int port; /** * è·¯å¾„ï¼ˆæœåŠ¡åï¼‰ */ private final String path; /** * å‚æ•°é›†åˆï¼Œé”®å€¼å¯¹å½¢å¼ */ private final Map&lt;String, String&gt; parameters; // çœç•¥å…¶å®ƒå±æ€§åŠæ„é€ å‡½æ•° public URL(String protocol, String username, String password, String host, int port, String path, Map&lt;String, String&gt; parameters) &#123; if ((username == null || username.length() == 0) &amp;&amp; password != null &amp;&amp; password.length() &gt; 0) &#123; throw new IllegalArgumentException(\"Invalid url, password without username!\"); &#125; this.protocol = protocol; this.username = username; this.password = password; this.host = host; this.port = (port &lt; 0 ? 0 : port); // trim the beginning \"/\" while (path != null &amp;&amp; path.startsWith(\"/\")) &#123; path = path.substring(1); &#125; this.path = path; if (parameters == null) &#123; parameters = new HashMap&lt;String, String&gt;(); &#125; else &#123; parameters = new HashMap&lt;String, String&gt;(parameters); &#125; this.parameters = Collections.unmodifiableMap(parameters); &#125; // çœç•¥å…¶å®ƒæ–¹æ³• &#125; Dubboä¸­å¸¸è§çš„ URL Dubboåè®®çš„æœåŠ¡ 1dubbo:&#x2F;&#x2F;10.1.22.50:20880&#x2F;com.alibaba.dubbo.demo.DemoService?anyhost&#x3D;true&amp;application&#x3D;demo-provider&amp;bean.name&#x3D;com.alibaba.dubbo.demo.DemoService&amp;bind.ip&#x3D;10.1.14.50&amp;bind.port&#x3D;20880&amp;dubbo&#x3D;2.0.2&amp;generic&#x3D;false&amp;interface&#x3D;com.alibaba.dubbo.demo.DemoService&amp;methods&#x3D;sayHello&amp;owner&#x3D;gentryhuang&amp;pid&#x3D;3272&amp;qos.port&#x3D;22222&amp;side&#x3D;provider&amp;timestamp&#x3D;1596611769521 æœåŠ¡æä¾›è€… 1provider:&#x2F;&#x2F;10.1.22.50:20880&#x2F;com.alibaba.dubbo.demo.DemoService?anyhost&#x3D;true&amp;application&#x3D;demo-provider&amp;bean.name&#x3D;com.alibaba.dubbo.demo.DemoService&amp;category&#x3D;configurators&amp;check&#x3D;false&amp;dubbo&#x3D;2.0.2&amp;generic&#x3D;false&amp;interface&#x3D;com.alibaba.dubbo.demo.DemoService&amp;methods&#x3D;sayHello&amp;owner&#x3D;gentryhuang&amp;pid&#x3D;3272&amp;side&#x3D;provider&amp;timestamp&#x3D;1596611769521 æœåŠ¡æ¶ˆè´¹è€… 1consumer:&#x2F;&#x2F;10.1.22.50&#x2F;com.alibaba.dubbo.demo.DemoService?application&#x3D;demo-consumer&amp;category&#x3D;consumers&amp;check&#x3D;false&amp;dubbo&#x3D;2.0.2&amp;interface&#x3D;com.alibaba.dubbo.demo.DemoService&amp;methods&#x3D;sayHello&amp;pid&#x3D;3363&amp;qos.port&#x3D;33333&amp;side&#x3D;consumer&amp;timestamp&#x3D;1596612621336 æœåŠ¡æš´éœ²è¿‡ç¨‹ä¸´æ—¶åè®® 1registry:&#x2F;&#x2F;127.0.0.1:2181&#x2F;com.alibaba.dubbo.registry.RegistryService?application&#x3D;demo-provider&amp;dubbo&#x3D;2.0.2&amp;owner&#x3D;gentryhuang&amp;pid&#x3D;3272&amp;qos.port&#x3D;22222&amp;registry&#x3D;zookeeper&amp;timestamp&#x3D;1596611658802 zkæ³¨å†Œä¸­å¿ƒ 1zookeeper:&#x2F;&#x2F;127.0.0.1:2181&#x2F;com.alibaba.dubbo.registry.RegistryService?application&#x3D;demo-provider&amp;dubbo&#x3D;2.0.2&amp;interface&#x3D;com.alibaba.dubbo.registry.RegistryService&amp;owner&#x3D;gentryhuang&amp;pid&#x3D;3272&amp;qos.port&#x3D;22222&amp;timestamp&#x3D;1596611658802 è¯´æ˜: é™¤æ­¤ä¹‹å¤–è¿˜æœ‰å¾ˆå¤šç±»å‹çš„ URL ï¼Œä¸åŒçš„åè®®[å¦‚ï¼šdubboåè®®ã€httpåè®®ç­‰]å¯¹åº”ä¸åŒçš„URLã€ä¸åŒçš„è§’è‰²[å¦‚ï¼šæä¾›è€…ã€æ¶ˆè´¹è€…ã€æ³¨å†Œä¸­å¿ƒã€è·¯ç”±å™¨ç­‰]å¯¹åº”ä¸åŒçš„URLã€ä¸åŒçš„åŠŸèƒ½æµç¨‹[å¦‚ï¼šæœåŠ¡æš´éœ²ã€æœåŠ¡å¼•ç”¨ã€æœåŠ¡è·¯ç”±ç­‰]å¯¹åº”ä¸åŒçš„URLâ€¦è¿™äº›åœ¨åé¢çš„æºç è§£æä¸­éƒ½æœ‰å¯¹åº”ã€‚ Dubboçš„ URL ç»Ÿä¸€æ¨¡å‹çš„æ„ä¹‰Dubboä¸­çš„ URL å¯ä»¥è¯´æ˜¯Dubboçš„é…ç½®æ€»çº¿ï¼Œå®ƒè´¯ç©¿æ•´ä¸ªDubboçš„ç”Ÿå‘½å‘¨æœŸã€‚ä¸Šä¸‹æ–‡çš„ä¿¡æ¯ä¼ é€’éœ€è¦ URL æ¥æä¾›ï¼Œç‰¹å®šåŠŸèƒ½çš„å®ç°éœ€è¦ URL çš„æ”¯æŒ[å¦‚ï¼šæ‰€æœ‰æ‰©å±•ç‚¹å‚æ•°éƒ½åŒ…å«urlå‚æ•°ï¼Œurlä½œä¸ºä¸Šä¸‹æ–‡ä¿¡æ¯è´¯ç©¿æ•´ä¸ªæ‹“å±•ç‚¹ä½“ç³»]ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"Dubboç¤ºä¾‹ - æ³¨è§£é…ç½®","slug":"rpc/Dubboç¬¬ä¸‰ä¾‹","date":"2020-03-05T16:00:00.000Z","updated":"2020-09-01T12:12:42.307Z","comments":false,"path":"posts/7202a9c0/","link":"","permalink":"https://gentryhuang.com/posts/7202a9c0/","excerpt":"","text":"å¿«é€Ÿå¯åŠ¨ä½¿ç”¨æ³¨è§£çš„æ–¹å¼è¿›è¡Œé…ç½® å®šä¹‰æœåŠ¡æ¥å£12345678910package com.alibaba.dubbo.examples.annotation.api;/** * AnnotationService */public interface AnnotationService &#123; String sayHello(String name);&#125; æœåŠ¡æä¾›æ–¹123456789101112131415161718package com.alibaba.dubbo.examples.annotation.impl;import com.alibaba.dubbo.config.annotation.Service;import com.alibaba.dubbo.examples.annotation.api.AnnotationService;/** * AnnotationServiceImplï¼Œæ³¨æ„ï¼Œè¿™é‡Œ @Service æ³¨è§£æ˜¯Dubboçš„æ³¨è§£ï¼Œç”¨æ¥è¿›è¡ŒæœåŠ¡æš´éœ²çš„ */@Servicepublic class AnnotationServiceImpl implements AnnotationService &#123; @Override public String sayHello(String name) &#123; System.out.println(\"async provider received: \" + name); return \"annotation: hello, \" + name; &#125;&#125; æœåŠ¡æä¾›æ–¹å±æ€§é…ç½®12345# dubbo-provider.propertiesdubbo.application.name&#x3D;annotation-providerdubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;127.0.0.1:2181dubbo.protocol.name&#x3D;dubbodubbo.protocol.port&#x3D;20880 è¯´æ˜: ä½¿ç”¨dubboæ³¨è§£å½¢å¼ä¸€èˆ¬ç»“åˆå±æ€§é…ç½®ï¼Œç”¨æ¥é…ç½®åº”ç”¨å…±äº«çš„é…ç½®é¡¹ã€‚ æŒ‡å®šæ‰«æè·¯å¾„ï¼Œå¯åŠ¨å®¹å™¨å¹¶æš´éœ²æœåŠ¡12345678910111213141516171819202122232425262728293031323334353637383940package com.alibaba.dubbo.examples.annotation;import com.alibaba.dubbo.config.ProviderConfig;import com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;import org.springframework.context.annotation.AnnotationConfigApplicationContext;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.PropertySource;/** * AnnotationProvider * * Java Config + æ³¨è§£çš„æ–¹å¼ */public class AnnotationProvider &#123; public static void main(String[] args) throws Exception &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ProviderConfiguration.class); context.start(); System.in.read(); &#125; @Configuration @EnableDubbo(scanBasePackages = \"com.alibaba.dubbo.examples.annotation.impl\") @PropertySource(\"classpath:/com/alibaba/dubbo/examples/annotation/dubbo-provider.properties\") static public class ProviderConfiguration &#123; /** * è¿™é‡Œé€šè¿‡Java Configæ˜¾ç¤ºç»„è£…å‡ºBeanï¼Œä¼šæ³¨å…¥ç»™DubboæœåŠ¡ï¼Œå³æ ‡æ³¨æœ‰@Serviceçš„ç±»ã€‚å¦‚æœä¸æ˜¾ç¤ºè£…é…ï¼ŒDubboä¼šé»˜è®¤åˆ›å»ºå†…ç½®çš„é…ç½®ç±»å®šä¹‰ï¼Œåˆ›å»ºå†…ç½®çš„é…ç½®ç±»å®šä¹‰çš„å‰ææ˜¯é…ç½®äº†ç›¸å…³çš„å±æ€§ï¼Œå¦åˆ™ä¸ä¼šåˆ›å»ºã€‚å…¶ä»–é…ç½®ç±»ä¼¼ã€‚ */ @Bean public ProviderConfig providerConfig() &#123; ProviderConfig providerConfig = new ProviderConfig(); providerConfig.setTimeout(5000); return providerConfig; &#125; &#125;&#125; æœåŠ¡æ¶ˆè´¹æ–¹123456789101112131415161718192021package com.alibaba.dubbo.examples.annotation.action;import com.alibaba.dubbo.config.annotation.Reference;import com.alibaba.dubbo.examples.annotation.api.AnnotationService;import org.springframework.stereotype.Component;/** * AnnotationActionï¼Œæ³¨æ„ï¼Œ@Referenceæ³¨è§£ç”¨æ¥å¼•ç”¨æœåŠ¡ */@Component(\"annotationAction\")public class AnnotationAction &#123; @Reference private AnnotationService annotationService; public String doSayHello(String name) &#123; return annotationService.sayHello(name); &#125;&#125; æœåŠ¡æ¶ˆè´¹æ–¹å±æ€§é…ç½®1234# dubbo-consumer.propertiesdubbo.application.name&#x3D;annotation-consumerdubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;127.0.0.1:2181dubbo.consumer.timeout&#x3D;3000 è¯´æ˜: ä½¿ç”¨dubboæ³¨è§£å½¢å¼ä¸€èˆ¬ç»“åˆå±æ€§é…ç½®ï¼Œç”¨æ¥é…ç½®åº”ç”¨å…±äº«çš„é…ç½®é¡¹ã€‚ æ‰«æè·¯å¾„ï¼Œå¯åŠ¨å®¹å™¨å¹¶è°ƒç”¨æœåŠ¡123456789101112131415161718192021222324252627282930313233343536373839404142package com.alibaba.dubbo.examples.annotation;import com.alibaba.dubbo.config.spring.context.annotation.EnableDubbo;import com.alibaba.dubbo.examples.annotation.action.AnnotationAction;import org.springframework.context.annotation.AnnotationConfigApplicationContext;import org.springframework.context.annotation.ComponentScan;import org.springframework.context.annotation.Configuration;import org.springframework.context.annotation.PropertySource;/** * AnnotationConsumer */public class AnnotationConsumer &#123; public static void main(String[] args) throws Exception &#123; AnnotationConfigApplicationContext context = new AnnotationConfigApplicationContext(ConsumerConfiguration.class); context.start(); final AnnotationAction annotationAction = (AnnotationAction) context.getBean(\"annotationAction\"); String hello = annotationAction.doSayHello(\"world\"); System.out.println(\"result :\" + hello); System.in.read(); &#125; @Configuration @EnableDubbo(scanBasePackages = \"com.alibaba.dubbo.examples.annotation.action\") @PropertySource(\"classpath:/com/alibaba/dubbo/examples/annotation/dubbo-consumer.properties\") @ComponentScan(value = &#123;\"com.alibaba.dubbo.examples.annotation.action\"&#125;) static public class ConsumerConfiguration &#123; /** * è¿™é‡Œé€šè¿‡Java Configæ˜¾ç¤ºç»„è£…å‡ºBeanï¼Œä¼šæ³¨å…¥ç»™DubboæœåŠ¡ï¼Œå³æ ‡æ³¨æœ‰@Referenceçš„ç±»ã€‚å¦‚æœä¸æ˜¾ç¤ºè£…é…ï¼ŒDubboä¼šé»˜è®¤åˆ›å»ºå†…ç½®çš„é…ç½®ç±»å®šä¹‰ï¼Œåˆ›å»ºå†…ç½®çš„é…ç½®ç±»å®šä¹‰çš„å‰ææ˜¯é…ç½®äº†ç›¸å…³çš„å±æ€§ï¼Œå¦åˆ™ä¸ä¼šåˆ›å»ºã€‚å…¶ä»–é…ç½®ç±»ä¼¼ã€‚ */ @Bean public ConsumerConfig consumerConfig() &#123; ConsumerConfig consumerConfig = new ConsumerConfig(); consumerConfig.setTimeout(3000); return consumerConfig; &#125; &#125;&#125; å°ç»“æ³¨è§£å®ç°ä½¿ä»£ç æ›´æ•´æ´ï¼Œå¼€å‘æ•ˆç‡æ›´é«˜ï¼Œéšç€æ³¨è§£å’Œé…ç½®åŒ–çš„ç››è¡Œï¼Œxmlçš„æ–¹å¼ä¼šæ¸æ¸åœ°æ·¡å‡ºèˆå°ã€‚ä½†ä½¿ç”¨æ³¨è§£å¯¹å¼€æ”¾è€…çš„è¦æ±‚æ›´é«˜ï¼Œå…·ä½“çš„dubboæ³¨è§£å¦‚ä½•ä¸Springèåˆï¼Œåœ¨åé¢çš„ç« èŠ‚ä¸­ä¼šè¿›è¡Œè¯´æ˜ã€‚ä½¿ç”¨æ³¨è§£çš„æ–¹å¼ï¼Œé…ç½®å¯¹è±¡çš„åˆ›å»ºåŠé…ç½®å¯¹è±¡å±æ€§è®¾ç½®ä¹Ÿéƒ½æ˜¯Springå®Œæˆçš„ï¼Œæ³¨æ„è¿™é‡ŒSpringå®Œæˆé…ç½®å±æ€§åœ°è®¾ç½®æ˜¯æŒ‡å¯åŠ¨åŠ è½½çš„é…ç½®å±æ€§ï¼Œå¦‚ä¸Šé¢ä¾‹å­ä¸­çš„@PropertySourceæ³¨è§£å¼•å…¥çš„é…ç½®æ–‡ä»¶å†…å®¹ï¼Œæ­¤å¤–@Serviceã€@Referenceæ³¨è§£ä¸­çš„å±æ€§Springä¼šè‡ªåŠ¨ç»‘å®šåˆ°é…ç½®å¯¹è±¡ä¸­ï¼Œè‡³äºç³»ç»Ÿå‚æ•°ã€dubbo.propertiesä¸­çš„é…ç½®å‚æ•°ç­‰æ˜¯dubboæ¡†æ¶è‡ªåŠ¨åŠ è½½å¹¶é…ç½®çš„ï¼Œæˆ‘ä»¬å¯åœ¨æœåŠ¡æš´éœ²å’ŒæœåŠ¡å¼•ç”¨ä¸­çœ‹åˆ°å…·ä½“çš„è¿‡ç¨‹ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"Dubboç¤ºä¾‹ - XMLé…ç½®","slug":"rpc/Dubboç¬¬äºŒä¾‹","date":"2020-03-03T16:00:00.000Z","updated":"2020-08-15T15:30:22.534Z","comments":false,"path":"posts/3f1c0a92/","link":"","permalink":"https://gentryhuang.com/posts/3f1c0a92/","excerpt":"","text":"å¿«é€Ÿå¯åŠ¨ä½¿ç”¨xmlçš„æ–¹å¼è¿›è¡Œé…ç½®ï¼Œè¯¦ç»†é…ç½®é¡¹ï¼šé…ç½®å‚è€ƒæ‰‹å†Œ å®šä¹‰æœåŠ¡æ¥å£12345package com.alibaba.dubbo.demo;public interface DemoService &#123; String sayHello(String name);&#125; æœåŠ¡æä¾›æ–¹å®ç°æ¥å£12345678910111213141516package com.alibaba.dubbo.demo.provider;import com.alibaba.dubbo.demo.DemoService;import com.alibaba.dubbo.rpc.RpcContext;import java.text.SimpleDateFormat;import java.util.Date;public class DemoServiceImpl implements DemoService &#123; @Override public String sayHello(String name) &#123; System.out.println(\"[\" + new SimpleDateFormat(\"HH:mm:ss\").format(new Date()) + \"] Hello \" + name + \", request from consumer: \" + RpcContext.getContext().getRemoteAddress()); return \"Hello \" + name + \", response from provider: \" + RpcContext.getContext().getLocalAddress(); &#125;&#125; æœåŠ¡æä¾›æ–¹æœåŠ¡æš´éœ²é…ç½®1234567891011121314151617181920212223&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:dubbo=\"http://dubbo.apache.org/schema/dubbo\" xmlns=\"http://www.springframework.org/schema/beans\" xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd\"&gt; &lt;!-- æä¾›æ–¹åº”ç”¨ä¿¡æ¯ï¼Œç”¨äºè®¡ç®—ä¾èµ–å…³ç³» --&gt; &lt;dubbo:application name=\"demo-provider\" owner=\"gentryhuang\"/&gt; &lt;!-- ä½¿ç”¨zookeeperæ³¨å†Œä¸­å¿ƒæš´éœ²æœåŠ¡åœ°å€ --&gt; &lt;dubbo:registry address=\"zookeeper://127.0.0.1:2181\"/&gt; &lt;!-- ç”¨dubboåè®®åœ¨20880ç«¯å£æš´éœ²æœåŠ¡ --&gt; &lt;dubbo:protocol name=\"dubbo\" port=\"20880\"/&gt; &lt;!-- å£°æ˜éœ€è¦æš´éœ²çš„æœåŠ¡æ¥å£ --&gt; &lt;bean id=\"demoService\" class=\"com.alibaba.dubbo.demo.provider.DemoServiceImpl\"/&gt; &lt;!-- å’Œæœ¬åœ°beanä¸€æ ·å®ç°æœåŠ¡ --&gt; &lt;dubbo:service interface=\"com.alibaba.dubbo.demo.DemoService\" ref=\"demoService\"/&gt;&lt;/beans&gt; å¯åŠ¨Springå®¹å™¨ï¼Œè¿›è¡ŒæœåŠ¡æš´éœ²12345678910111213package com.alibaba.dubbo.demo.provider;import org.springframework.context.support.ClassPathXmlApplicationContext;public class Provider &#123; public static void main(String[] args) throws Exception &#123; ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]&#123;\"META-INF/spring/dubbo-demo-provider.xml\"&#125;); context.start(); System.in.read(); // press any key to exit &#125;&#125; æœåŠ¡æ¶ˆè´¹è€…å¼•ç”¨æœåŠ¡é…ç½®1234567891011121314151617&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;beans xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:dubbo=\"http://dubbo.apache.org/schema/dubbo\" xmlns=\"http://www.springframework.org/schema/beans\" xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd\"&gt; &lt;!-- æ¶ˆè´¹æ–¹åº”ç”¨åï¼Œç”¨äºè®¡ç®—ä¾èµ–å…³ç³»ï¼Œä¸æ˜¯åŒ¹é…æ¡ä»¶ï¼Œä¸è¦ä¸æä¾›æ–¹ä¸€æ · --&gt; &lt;dubbo:application name=\"demo-consumer\"/&gt; &lt;!-- ä½¿ç”¨zookeeperæ³¨å†Œä¸­å¿ƒæš´éœ²å‘ç°æœåŠ¡åœ°å€ --&gt; &lt;dubbo:registry address=\"zookeeper://127.0.0.1:2181\"/&gt; &lt;!-- ç”Ÿæˆè¿œç¨‹æœåŠ¡ä»£ç†ï¼Œå¯ä»¥å’Œæœ¬åœ°beanä¸€æ ·ä½¿ç”¨demoService --&gt; &lt;dubbo:reference id=\"demoService\" check=\"false\" interface=\"com.alibaba.dubbo.demo.DemoService\"/&gt;&lt;/beans&gt; åŠ è½½Springé…ç½®ï¼Œå¹¶è°ƒç”¨è¿œç¨‹æœåŠ¡123456789101112131415161718192021222324package com.alibaba.dubbo.demo.consumer;import com.alibaba.dubbo.demo.DemoService;import org.springframework.context.support.ClassPathXmlApplicationContext;public class Consumer &#123; public static void main(String[] args) &#123; ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]&#123;\"META-INF/spring/dubbo-demo-consumer.xml\"&#125;); context.start(); DemoService demoService = (DemoService) context.getBean(\"demoService\"); // get remote service proxy while (true) &#123; try &#123; Thread.sleep(5000); String hello = demoService.sayHello(\"world\"); // call remote method System.out.println(hello); // get result &#125; catch (Throwable throwable) &#123; throwable.printStackTrace(); &#125; &#125; &#125;&#125; å°ç»“dubboè‡ªå®šä¹‰äº†å¾ˆå¤šçš„xmlæ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾å°±å¯¹åº”äº†APIé…ç½®ä¸­çš„é…ç½®å¯¹è±¡ï¼Œæ ‡ç­¾çš„å±æ€§å°±å¯¹åº”é…ç½®å¯¹è±¡çš„å±æ€§ï¼ŒAPIçš„æ–¹å¼æ˜¯æ‰‹åŠ¨åˆ›å»ºé…ç½®å¯¹è±¡å¹¶è®¾ç½®å±æ€§å€¼ï¼Œxmlçš„æ–¹å¼æ˜¯åˆ›å»ºé…ç½®å¯¹è±¡å’Œè®¾ç½®å±æ€§å€¼éƒ½äº¤ç»™Springæ¥å®Œæˆï¼Œæ³¨æ„DubboBeanDefinitionParserè®¾ç½®çš„å±æ€§å€¼ä¸åŒ…æ‹¬ç³»ç»Ÿå‚æ•°ã€dubbo.propertiesç­‰ï¼Œè€Œæ˜¯xmlä¸­é…ç½®å¯¹è±¡çš„å±æ€§ã€‚è¿™äº›æ ‡ç­¾æ˜¯æ€ä¹ˆå’Œpringèåˆçš„åœ¨springè‡ªå®šä¹‰æ ‡ç­¾ä¸­å·²ç»ä»‹ç»äº†å®ç°åŸç†ï¼Œåœ¨åé¢çš„dubboé…ç½®è§£æä¸­ä¼šç»§ç»­è¯´æ˜ã€‚æ›´å¤šçš„é…ç½®è¯·å‚è€ƒï¼šé…ç½®å‚è€ƒæ‰‹å†Œã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä»‹ç»ä½¿ç”¨æ³¨è§£çš„æ–¹å¼è¿›è¡Œé…ç½®,è¿™ç§æ–¹å¼æ›´ç®€æ´ï¼Œæ•ˆç‡æ›´é«˜ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"Dubboç¤ºä¾‹ - APIé…ç½®","slug":"rpc/Dubboç¬¬ä¸€ä¾‹","date":"2020-03-02T16:00:00.000Z","updated":"2020-08-15T08:43:51.063Z","comments":false,"path":"posts/f0ae64a/","link":"","permalink":"https://gentryhuang.com/posts/f0ae64a/","excerpt":"","text":"å¿«é€Ÿå¯åŠ¨ä½¿ç”¨APIçš„æ–¹å¼è¿›è¡Œå¯åŠ¨ã€è°ƒç”¨ã€‚API å±æ€§ä¸é…ç½®é¡¹ä¸€å¯¹ä¸€ï¼Œå„å±æ€§å«ä¹‰ï¼Œè¯·å‚è§ï¼šé…ç½®å‚è€ƒæ‰‹å†Œï¼Œæ¯”å¦‚ï¼šApplicationConfig.setName(â€œxxxâ€) å¯¹åº” &lt;dubbo:application name=â€xxxâ€ /&gt; å®šä¹‰æœåŠ¡æ¥å£1234567891011121314151617package com.code.resorce.api;/** * DemoService * * @author shunhua * @since 2020/03/03 * &lt;p&gt; * descï¼š */public interface DemoService &#123; /** * @return */ String hello();&#125; æœåŠ¡æä¾›æ–¹å®ç°æ¥å£123456789101112131415161718package com.code.resource.reading.api;import com.code.resorce.api.DemoService;/** * DemoServiceImpl * * @author shunhua * @since 2020/03/03 * &lt;p&gt; * descï¼š */public class DemoServiceImpl implements DemoService &#123; @Override public String hello() &#123; return \"hello world\"; &#125;&#125; ä½¿ç”¨APIé…ç½®å£°æ˜æš´éœ²æœåŠ¡123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * ApiProvider * * @author shunhua * @since 2020/03/03 * &lt;p&gt; * descï¼š */public class ApiProvider &#123; public static void main(String[] args) throws IOException &#123; // æœåŠ¡å¯¹è±¡ DemoService demoService = new DemoServiceImpl(); // åº”ç”¨é…ç½® ApplicationConfig applicationConfig = new ApplicationConfig(); applicationConfig.setName(\"api-config-demo-provider\"); // è¿æ¥æ³¨å†Œä¸­å¿ƒé…ç½® RegistryConfig registryConfig = new RegistryConfig(); registryConfig.setAddress(\"zookeeper://127.0.0.1:2181\"); // æœåŠ¡æä¾›è€…åè®®é…ç½® ProtocolConfig protocolConfig = new ProtocolConfig(); protocolConfig.setName(\"dubbo\"); protocolConfig.setPort(20880); //çœç•¥ServiceConfigçš„å…¶å®ƒé…ç½®é¡¹ï¼Œå¦‚Moduleã€Providerã€Monitorç­‰ // æœåŠ¡æä¾›è€…æš´éœ²æœåŠ¡é…ç½®ï¼Œæ³¨æ„ï¼šServiceConfigä¸ºé‡å¯¹è±¡ï¼Œå†…éƒ¨å°è£…äº†ä¸æ³¨å†Œä¸­å¿ƒçš„è¿æ¥ï¼Œä»¥åŠå¼€å¯æœåŠ¡ç«¯å£ï¼Œè¯·è‡ªè¡Œç¼“å­˜ï¼Œå¦åˆ™å¯èƒ½é€ æˆå†…å­˜å’Œè¿æ¥æ³„æ¼ ServiceConfig&lt;DemoService&gt; serviceConfig = new ServiceConfig&lt;DemoService&gt;(); serviceConfig.setApplication(applicationConfig); serviceConfig.setRegistry(registryConfig); serviceConfig.setProtocol(protocolConfig); serviceConfig.setInterface(DemoService.class); serviceConfig.setRef(demoService); // æš´éœ²åŠæ³¨å†ŒæœåŠ¡ serviceConfig.export(); // é˜»ä¸»çº¿ç¨‹ï¼Œé˜²æ­¢æœåŠ¡å…³é—­ï¼Œç”¨äºæ¶ˆè´¹è€…çš„è°ƒç”¨ System.in.read(); &#125;&#125; ä½¿ç”¨APIé…ç½®æœåŠ¡å¼•ç”¨123456789101112131415161718192021222324252627282930313233343536373839/** * ApiConsumer * * @author shunhua * @since 2020/03/03 * &lt;p&gt; * descï¼š */public class ApiConsumer &#123; public static void main(String[] args) throws InterruptedException &#123; // å½“å‰åº”ç”¨é…ç½® ApplicationConfig applicationConfig = new ApplicationConfig(); applicationConfig.setName(\"api-config-demo-provider\"); // è¿æ¥æ³¨å†Œä¸­å¿ƒé…ç½® RegistryConfig registryConfig = new RegistryConfig(); registryConfig.setAddress(\"zookeeper://127.0.0.1:2181\"); // çœç•¥ReferenceConfigçš„å…¶å®ƒé…ç½®é¡¹ï¼Œå¦‚ Moduleã€Consumerã€Monitorç­‰ // å¼•ç”¨è¿œç¨‹æœåŠ¡ï¼Œæ³¨æ„ï¼šReferenceConfigä¸ºé‡å¯¹è±¡ï¼Œå†…éƒ¨å°è£…äº†ä¸æ³¨å†Œä¸­å¿ƒçš„è¿æ¥ï¼Œä»¥åŠä¸æœåŠ¡æä¾›æ–¹çš„è¿æ¥ï¼Œè¯·è‡ªè¡Œç¼“å­˜ï¼Œå¦åˆ™å¯èƒ½é€ æˆå†…å­˜å’Œè¿æ¥æ³„æ¼ ReferenceConfig&lt;DemoService&gt; referenceConfig = new ReferenceConfig&lt;DemoService&gt;(); referenceConfig.setApplication(applicationConfig); referenceConfig.setRegistry(registryConfig); referenceConfig.setInterface(DemoService.class); // è·å–ä»£ç†å¯¹è±¡ DemoService demoService = referenceConfig.get(); while (true) &#123; String ping = demoService.sayHello(\"ping\"); System.out.println(ping); Thread.sleep(3000); &#125; &#125;&#125; å°ç»“ä½¿ç”¨APIç¡¬ç¼–ç çš„æ–¹å¼ç®€å•ã€ç›´è§‚ï¼Œæ— éœ€å…³æ³¨å…¶å®ƒç»†èŠ‚ï¼ˆå¦‚ä¸éœ€è¦å…³å¿ƒå’ŒSpringæ•´åˆçš„ç»†èŠ‚ï¼‰ï¼Œè®©ä½¿ç”¨è€…æ›´å®¹å™¨ç†è§£dubboçš„å„ä¸ªç»„ä»¶åŠå…¶ä¹‹é—´çš„è”ç³»ï¼Œç¼–å†™æœåŠ¡æä¾›è€…ä¸æ¶ˆè´¹è€…æ›´åŠ å®¹æ˜“ã€‚é»˜è®¤æƒ…å†µä¸‹dubboæ¡†æ¶åªéœ€è¦ä¾èµ–Nettyé€šä¿¡æ¡†æ¶å°±å¯ä»¥å®ç°RPCè°ƒç”¨ï¼Œæ³¨å†Œä¸­å¿ƒä¹Ÿå¯ä»¥ä¸éœ€è¦ï¼Œå³åªè¦æœ‰æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€… ä»¥åŠ æ¶èµ·æ¶ˆè´¹è€…è¿æ¥åˆ°æä¾›è€…çš„é€šä¿¡æ¡¥æ¢å³å¯å®ç°ä¸€ä¸ªå®Œæ•´çš„RPCè°ƒç”¨ã€‚ è™½ç„¶ä½¿ç”¨APIçš„æ–¹å¼ç®€å•æ˜“æ‡‚ï¼Œä½†æ˜¯å¯¹äºåº”ç”¨ã€æœåŠ¡çš„ç®¡ç†å°±éœ€è¦å¾ˆå¤§çš„æˆæœ¬ï¼Œå¯¹äºæ¯ä¸ªåº”ç”¨ã€æœåŠ¡éƒ½éœ€ç¼–å†™å¤§é‡é‡å¤çš„ä»£ç ï¼Œå¹¶ä¸”æ˜¯ç¡¬ç¼–ç ï¼Œæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚Springæœ¬èº«çš„ä¸€å¤§ç‰¹æ€§å°±æ˜¯ä¾èµ–ç®¡ç†ï¼Œè€Œæˆ‘ä»¬è¿™äº›APIä¸­çš„é…ç½®æ‰¿è½½å¯¹è±¡å®Œå…¨å¯ä»¥äº¤ç»™Springæ¥ç®¡ç†ï¼Œè¿™æ ·å°±å®ç°äº†é…ç½®åŒ–ï¼Œè™½ç„¶å¼•å…¥äº†Springè¿™ä¸ªç¬¬ä¸‰æ–¹æ¡†æ¶ï¼Œä½†æ˜¯æ˜¯éå¸¸åˆç†çš„ï¼Œæ¯•ç«ŸSpringæ˜¯ä¸»æµã€‚ä¸‹ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä½¿ç”¨Springçš„xmlé…ç½®æ–¹å¼å®ç°RPCè°ƒç”¨ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"Springè‡ªå®šä¹‰æ ‡ç­¾","slug":"rpc/Springè‡ªå®šä¹‰æ ‡ç­¾","date":"2020-03-01T16:00:00.000Z","updated":"2020-09-03T01:33:46.285Z","comments":false,"path":"posts/eee3e639/","link":"","permalink":"https://gentryhuang.com/posts/eee3e639/","excerpt":"","text":"springè‡ªå®šä¹‰æ ‡ç­¾Springé™¤äº†å¾ˆå¤šå†…ç½®çš„xmlæ ‡ç­¾å¤–ï¼Œè¿˜æ”¯æŒè‡ªå®šä¹‰xmlæ ‡ç­¾ï¼Œå¼€å‘è€…åªéœ€è¦æŒ‰ç…§Springçš„çº¦å®šè§„åˆ™å°±å¯ä»¥å®ç°è‡ªå®šä¹‰æ ‡ç­¾ï¼Œè¿™æ ·å¼€å‘è€…å°±å¯ä»¥æŠŠè‡ªå®šä¹‰çš„Beanäº¤ç»™Springç®¡ç†ã€‚è‡ªå®šä¹‰æ ‡ç­¾åŒ…ç»“æ„å¦‚ä¸‹ï¼š è‡ªå®šä¹‰æ ‡ç­¾çš„è§„åˆ™ç¼–å†™æ¨¡å‹1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.code.resource.reading.xml.schema.model;/** * Hero * * @author shunhua * @since 2020/03/02 * &lt;p&gt; * descï¼š */public class Hero &#123; /** * name */ private String name; /** * age */ private int age; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public int getAge() &#123; return age; &#125; public void setAge(int age) &#123; this.age = age; &#125; @Override public String toString() &#123; return \"Hero&#123;\" + \"name='\" + name + '\\'' + \", age=\" + age + '&#125;'; &#125;&#125; å®šä¹‰æ¨¡å‹çš„xsdæ–‡ä»¶12345678910111213141516171819202122232425262728293031&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;xsd:schema xmlns=\"http://gentryhuang.site/schema/people\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" targetNamespace=\"http://gentryhuang.com/schema/people\"&gt; &lt;!-- å®šä¹‰å…ƒç´ çš„å¤æ‚ç±»å‹ --&gt; &lt;xsd:complexType name=\"elementComplexType\"&gt; &lt;!-- å®šä¹‰æ¨¡å‹ç±»ä¸­çš„å±æ€§ --&gt; &lt;xsd:attribute name=\"name\" type=\"xsd:string\"&gt; &lt;xsd:annotation&gt; &lt;xsd:documentation&gt;&lt;![CDATA[ The element name. ]]&gt;&lt;/xsd:documentation&gt; &lt;/xsd:annotation&gt; &lt;/xsd:attribute&gt; &lt;xsd:attribute name=\"age\" type=\"xsd:int\"&gt; &lt;xsd:annotation&gt; &lt;xsd:documentation&gt;&lt;![CDATA[ The element age. ]]&gt;&lt;/xsd:documentation&gt; &lt;/xsd:annotation&gt; &lt;/xsd:attribute&gt; &lt;/xsd:complexType&gt; &lt;!-- å®šä¹‰åœ¨xmlæ–‡ä»¶ä¸­ç”¨åˆ°çš„å…ƒç´ åç§° --&gt; &lt;xsd:element name=\"hero\" type=\"elementComplexType\"&gt; &lt;xsd:annotation&gt; &lt;xsd:documentation&gt;&lt;![CDATA[ å®šä¹‰æ ‡ç­¾ ]]&gt;&lt;/xsd:documentation&gt; &lt;/xsd:annotation&gt; &lt;/xsd:element&gt;&lt;/xsd:schema&gt; è¯´æ˜: è¯¥æ–‡ä»¶è¦æ”¾åœ¨ resourcesçš„META-INFç›®å½•ä¸‹ã€‚è¯¥æ–‡ä»¶æ˜¯ç”¨æ¥çº¦æŸä½¿ç”¨xmlé…ç½®æ—¶çš„æ ‡ç­¾å’Œå¯¹åº”çš„å±æ€§ã€‚ ç¼–å†™spring.schemasæ–‡ä»¶1http\\:&#x2F;&#x2F;gentryhuang.com&#x2F;schema&#x2F;people&#x2F;hero.xsd&#x3D;META-INF&#x2F;hero.xsd è¯´æ˜: http://gentryhuang.com/schema/people å°±æ˜¯æ¨¡å‹å¯¹åº”çš„xsdä¸­çš„targetNamespaceçš„å€¼ï¼Œå®ƒæŒ‡å®šäº†çº¦æŸæ–‡ä»¶çš„å…·ä½“è·¯å¾„ã€‚ ç¼–å†™BeanDefinitionParser12345678910111213141516171819202122232425262728293031323334353637383940414243package com.code.resource.reading.xml.schema;import org.springframework.beans.factory.config.BeanDefinition;import org.springframework.beans.factory.support.BeanDefinitionRegistry;import org.springframework.beans.factory.support.RootBeanDefinition;import org.springframework.beans.factory.xml.BeanDefinitionParser;import org.springframework.beans.factory.xml.ParserContext;import org.w3c.dom.Element;/** * HeroBeanDefinitionParser * * @author shunhua * @since 2020/03/02 * &lt;p&gt; * descï¼š */public class HeroBeanDefinitionParser implements BeanDefinitionParser &#123; /** * æ ‡ç­¾å¯¹åº”çš„ç±» */ private final Class&lt;?&gt; beanClass; public HeroBeanDefinitionParser(Class&lt;?&gt; beanClass) &#123; this.beanClass = beanClass; &#125; @Override public BeanDefinition parse(Element element, ParserContext parserContext) &#123; RootBeanDefinition beanDefinition = new RootBeanDefinition(); beanDefinition.setBeanClass(beanClass); beanDefinition.setLazyInit(false); beanDefinition.getPropertyValues().add(\"name\",element.getAttribute(\"name\")); beanDefinition.getPropertyValues().add(\"age\",element.getAttribute(\"age\")); // è·å–Beanå®šä¹‰æ³¨å†Œè¡¨ BeanDefinitionRegistry registry = parserContext.getRegistry(); // æ³¨å†ŒBean registry.registerBeanDefinition(\"hero\",beanDefinition); return beanDefinition; &#125;&#125; è¯´æ˜: ç”¨æ¥è§£æè‡ªå®šä¹‰çš„xmlæ ‡ç­¾ ç¼–å†™å‘½åç©ºé—´å¤„ç†å™¨123456789101112131415161718192021222324package com.code.resource.reading.xml.schema;import com.code.resource.reading.xml.schema.model.Hero;import org.springframework.beans.factory.xml.NamespaceHandlerSupport;/** * HeroNamespaceHandler * * @author shunhua * @since 2020/03/02 * &lt;p&gt; * descï¼š */public class HeroNamespaceHandler extends NamespaceHandlerSupport &#123; /** * å®šä¹‰äº†&lt;xsd:element/&gt;å¯¹åº”çš„BeanDefinitionParser */ @Override public void init() &#123; registerBeanDefinitionParser(\"hero\",new HeroBeanDefinitionParser(Hero.class)); &#125;&#125; è¯´æ˜:ä¸€èˆ¬æƒ…å†µä¸‹ ä¸€ä¸ª&lt;xsd:element/&gt; å¯¹åº”ä¸€ä¸ªBeanDefinitionParser ç¼–å†™spring.handlersæ–‡ä»¶1http\\:&#x2F;&#x2F;gentryhuang.com&#x2F;schema&#x2F;people&#x3D;com.code.resource.reading.xml.schema.HeroNamespaceHandler è¯´æ˜: è¿™æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼Œkeyæ˜¯xsdæ–‡ä»¶ä¸­çš„ targetNamespaceï¼Œè¯¥æ–‡ä»¶æŒ‡æ˜äº†ä½¿ç”¨å“ªä¸ªç±»æ¥è§£æè‡ªå®šä¹‰çš„æ ‡ç­¾ã€‚ ä½¿ç”¨springçš„è‡ªå®šä¹‰æ ‡ç­¾12345678910111213141516&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;beans xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:people=\"http://gentryhuang.com/schema/people\" xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://gentryhuang.com/schema/people http://gentryhuang.com/schema/people/hero.xsd\"&gt; &lt;!-- 1 xmlns:peopleçš„å€¼æ˜¯xsdæ–‡ä»¶ä¸­çš„targetNamespace 2 xmlns:hero å¯ä»¥å†™æˆxmlns:xxx,æ­¤æ—¶æ ‡ç­¾å‰ç¼€ä¹Ÿè¦æ˜¯ &lt;xxx:hero/&gt; --&gt; &lt;people:hero name=\"hlb\" age=\"18\"/&gt;&lt;/beans&gt; æµ‹è¯•123456789101112131415161718192021package com.code.resource.reading.xml.schema;import com.code.resource.reading.xml.schema.model.Hero;import org.springframework.context.ApplicationContext;import org.springframework.context.support.ClassPathXmlApplicationContext;/** * Client * * @author shunhua * @since 2020/03/02 * &lt;p&gt; * descï¼š */public class Client &#123; public static void main(String[] args) &#123; ApplicationContext applicationContext = new ClassPathXmlApplicationContext(\"hero.xml\"); Hero hero = (Hero) applicationContext.getBean(\"hero\"); System.out.println(hero); &#125;&#125; å°ç»“springåœ¨è§£æåˆ°è‡ªå®šä¹‰çš„namespaceæ ‡ç­¾æ—¶ï¼Œæ¯”å¦‚ &lt;people:hero /&gt;ï¼Œä¼šæŸ¥æ‰¾å¯¹åº”çš„spring.schemaså’Œspring.handlersæ–‡ä»¶ï¼Œé€šè¿‡spring.schemasæ–‡ä»¶ç¡®å®šéœ€è¦åŠ è½½çš„æ ‡ç­¾åŠå±æ€§ï¼Œç„¶åä¼šè§¦å‘spring.handlersæ–‡ä»¶ä¸­æŒ‡å®šçš„ç±»æ¥è¿›è¡Œåˆå§‹åŒ–å’Œè§£æã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"},{"name":"Spring","slug":"Spring","permalink":"https://gentryhuang.com/tags/Spring/"}]},{"title":"åˆè¯†RPC","slug":"rpc/åˆè¯†RPC","date":"2020-02-29T16:00:00.000Z","updated":"2020-09-06T03:59:50.707Z","comments":false,"path":"posts/626d9676/","link":"","permalink":"https://gentryhuang.com/posts/626d9676/","excerpt":"","text":"åŸºæœ¬æ¦‚å¿µRPCï¼ˆRemote Procedure Callï¼‰è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹è¯·æ±‚å¦ä¸€ä¸ªèŠ‚ç‚¹æä¾›çš„æœåŠ¡ï¼Œåƒæœ¬åœ°æ–¹æ³•è°ƒç”¨ä¸€æ ·è°ƒç”¨è¿œç¨‹çš„æœåŠ¡ã€‚è¯¦ç»†è¯´æ˜ï¼šè¯·æ±‚æ–¹æ²¡æœ‰æœåŠ¡å®ç°çš„ç»†èŠ‚ï¼Œæ‰§è¡Œç›®æ ‡è¡Œä¸ºè¿˜æ˜¯æœåŠ¡æä¾›çš„èŠ‚ç‚¹ã€‚è¯·æ±‚æœåŠ¡çš„èŠ‚ç‚¹å’ŒæœåŠ¡æä¾›çš„èŠ‚ç‚¹ä»¥æŸç§æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œè¯·æ±‚æ–¹æŠŠè¡Œä¸ºåŠè¡Œä¸ºå‚æ•°ä¼ é€’ç»™æœåŠ¡æä¾›æ–¹ï¼ŒæœåŠ¡æä¾›æ–¹ä¼šæ ¹æ®è¯·æ±‚æ–¹ä¼ é€’çš„æ•°æ®æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡å®ç°ç„¶åæ‰§è¡Œç›®æ ‡è¡Œä¸ºï¼Œæœ€åå†æŠŠæ‰§è¡Œç»“æœè¿”å›ç»™è¯·æ±‚æ–¹ã€‚ æœ¬åœ°è¿‡ç¨‹è°ƒç”¨å‘èµ·è¯·æ±‚å’Œå“åº”ç»“æœéƒ½åœ¨åŒä¸€ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šï¼Œåœ¨Javaä¸­å°±æ˜¯åŒä¸€ä¸ªJVMä¸­çš„æ–¹æ³•è°ƒç”¨è¿‡ç¨‹ã€‚ è¿œç¨‹è¿‡ç¨‹è°ƒç”¨è¯·æ±‚çš„å‘èµ·è€…å’Œè¯·æ±‚çš„å¤„ç†è€…ä¸åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ƒä»¬ä¹‹é—´éœ€è¦è¿›è¡Œç½‘ç»œé€šä¿¡æ‰èƒ½å®Œæˆè¯·æ±‚å’Œå“åº”ã€‚ ç®€å•RPCå®ç°è¯´æ˜: ä¾‹å­æ˜¯ä½¿ç”¨æ¢é£å¤§ä½¬çš„ æŠ€æœ¯åšå®¢ ä¸­çš„æ¡ˆä¾‹ æœåŠ¡æ¥å£åŠå®ç°12345678910111213141516171819202122232425262728293031package com.alibaba.study.rpc.service;/** * HelloService */public interface HelloService &#123; /** * æœåŠ¡æ–¹æ³• * * @param name * @return */ String hello(String name);&#125;---package com.alibaba.study.rpc.service.impl;import com.alibaba.study.rpc.service.HelloService;/** * HelloServiceImpl */public class HelloServiceImpl implements HelloService &#123; @Override public String hello(String name) &#123; return \"Hello \" + name; &#125;&#125; RPCæ¡†æ¶123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177package com.alibaba.study.rpc.framework;import java.io.ObjectInputStream;import java.io.ObjectOutputStream;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.net.ServerSocket;import java.net.Socket;/** * RpcFramework */public class RpcFramework &#123; /** * æš´éœ²æœåŠ¡ * * @param service æœåŠ¡å®ç° * @param port æœåŠ¡ç«¯å£ * @throws Exception */ public static void export(final Object service, int port) throws Exception &#123; if (service == null) &#123; throw new IllegalArgumentException(\"service instance == null\"); &#125; if (port &lt;= 0 || port &gt; 65535) &#123; throw new IllegalArgumentException(\"Invalid port \" + port); &#125; System.out.println(\"Export service \" + service.getClass().getName() + \" on port \" + port); // ä»¥æŒ‡å®šç«¯å£åˆ›å»ºServerSocket ServerSocket server = new ServerSocket(port); for (; ; ) &#123; try &#123; // ç­‰å¾…æ¥æ”¶è¯·æ±‚ final Socket socket = server.accept(); new Thread(new Runnable() &#123; @Override public void run() &#123; try &#123; try &#123; // è·å–è¯·æ±‚çš„æ•°æ®æµ ObjectInputStream input = new ObjectInputStream(socket.getInputStream()); try &#123; // è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„æ–¹æ³•å String methodName = input.readUTF(); // è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„å‚æ•°ç±»å‹åˆ—è¡¨ Class&lt;?&gt;[] parameterTypes = (Class&lt;?&gt;[]) input.readObject(); // è·å–å®¢æˆ·ç«¯è¯·æ±‚çš„å‚æ•°åˆ—è¡¨ Object[] arguments = (Object[]) input.readObject(); // åˆ›å»ºå¯¹è±¡è¾“å‡ºæµå¯¹è±¡ï¼Œç”¨äºå“åº”ç»“æœç»™å®¢æˆ·ç«¯ ObjectOutputStream output = new ObjectOutputStream(socket.getOutputStream()); try &#123; // é€šè¿‡åå°„ï¼Œè·å–æœåŠ¡æ¥å£æŒ‡å®šçš„æ–¹æ³• Method method = service.getClass().getMethod(methodName, parameterTypes); // åå°„è°ƒç”¨ Object result = method.invoke(service, arguments); // å°†ç»“æœå“åº”ç»™å®¢æˆ·ç«¯ output.writeObject(result); &#125; catch (Throwable t) &#123; output.writeObject(t); &#125; finally &#123; output.close(); &#125; &#125; finally &#123; input.close(); &#125; &#125; finally &#123; socket.close(); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125;).start(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125; /** * å¼•ç”¨æœåŠ¡ * * @param &lt;T&gt; æ¥å£æ³›å‹ * @param interfaceClass æ¥å£ç±»å‹ * @param host æœåŠ¡å™¨ä¸»æœºå * @param port æœåŠ¡å™¨ç«¯å£ * @return è¿œç¨‹æœåŠ¡ * @throws Exception */ @SuppressWarnings(\"unchecked\") public static &lt;T&gt; T refer(final Class&lt;T&gt; interfaceClass, final String host, final int port) throws Exception &#123; if (interfaceClass == null) &#123; throw new IllegalArgumentException(\"Interface class == null\"); &#125; if (!interfaceClass.isInterface()) &#123; throw new IllegalArgumentException(\"The \" + interfaceClass.getName() + \" must be interface class!\"); &#125; if (host == null || host.length() == 0) &#123; throw new IllegalArgumentException(\"Host == null!\"); &#125; if (port &lt;= 0 || port &gt; 65535) &#123; throw new IllegalArgumentException(\"Invalid port \" + port); &#125; System.out.println(\"Get remote service \" + interfaceClass.getName() + \" from server \" + host + \":\" + port); /** * ä½¿ç”¨JDKçš„åŠ¨æ€ä»£ç†åˆ›å»ºæ¥å£çš„ä»£ç†å¯¹è±¡ * è¯´æ˜ï¼š * åœ¨ InvocationHandler#invokeæ–¹æ³•å†…éƒ¨å®ç°Socketä¸ServerSocketçš„é€šä¿¡ã€‚å½“ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå†…éƒ¨ä½¿ç”¨Socketè¿›è¡Œé€šä¿¡ï¼Œç„¶åæŠŠé€šä¿¡çš„ç»“æœè¿”å›ã€‚ */ return (T) Proxy.newProxyInstance( interfaceClass.getClassLoader(), new Class&lt;?&gt;[]&#123;interfaceClass&#125;, new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] arguments) throws Throwable &#123; // åˆ›å»ºSocketï¼Œç”¨äºè¿æ¥ServerSocket Socket socket = new Socket(host, port); try &#123; // åˆ›å»ºç”¨äºå‘é€æ•°æ®åˆ°ServerSocketçš„è¾“å‡ºæµ ObjectOutputStream output = new ObjectOutputStream(socket.getOutputStream()); try &#123; //--------------------- æ•°æ®å¥‘çº¦ ----------------------------/ // æ–¹æ³•å output.writeUTF(method.getName()); // å‚æ•°ç±»å‹ output.writeObject(method.getParameterTypes()); // å‚æ•°å€¼ output.writeObject(arguments); //------------------------ æ•°æ®å¥‘çº¦ --------------------------/ // åˆ›å»ºç”¨äºæ¥æ”¶ServerSocketçš„è¾“å…¥æµ ObjectInputStream input = new ObjectInputStream(socket.getInputStream()); try &#123; // è¯»å–ServerSocketå“åº”çš„æ•°æ® Object result = input.readObject(); if (result instanceof Throwable) &#123; throw (Throwable) result; &#125; // è¿”å›ç»“æœ return result; &#125; finally &#123; input.close(); &#125; &#125; finally &#123; output.close(); &#125; &#125; finally &#123; socket.close(); &#125; &#125; &#125;); &#125;&#125; æœåŠ¡æš´éœ²1234567891011121314151617package com.alibaba.study.rpc.provider;import com.alibaba.study.rpc.framework.RpcFramework;import com.alibaba.study.rpc.service.HelloService;import com.alibaba.study.rpc.service.impl.HelloServiceImpl;/** * RpcProvider */public class RpcProvider &#123; public static void main(String[] args) throws Exception &#123; // æœåŠ¡å®ç° HelloService service = new HelloServiceImpl(); // æš´éœ²æœåŠ¡ RpcFramework.export(service, 1234); &#125;&#125; å¼•ç”¨æœåŠ¡1234567891011121314151617181920package com.alibaba.study.rpc.consumer;import com.alibaba.study.rpc.framework.RpcFramework;import com.alibaba.study.rpc.service.HelloService;/** * RpcConsumer */public class RpcConsumer &#123; public static void main(String[] args) throws Exception &#123; // å¼•ç”¨æœåŠ¡ã€ä»£ç†å¯¹è±¡ã€‘ HelloService service = RpcFramework.refer(HelloService.class, \"127.0.0.1\", 1234); while (true) &#123; String hello = service.hello(\"World\"); System.out.println(hello); Thread.sleep(1000); &#125; &#125;&#125; å°ç»“è¿™ä¸ªä¾‹å­ä¸­ï¼Œé€šä¿¡æ˜¯ä½¿ç”¨åŒæ­¥é˜»å¡çš„Socketæ¥å®ç°çš„ï¼Œé‡‡ç”¨ç«¯å¯¹ç«¯çš„æ–¹å¼ã€‚è¿œç¨‹è°ƒç”¨ä½¿ç”¨çš„æ˜¯JDKçš„åŠ¨æ€ä»£ç†ï¼Œåœ¨invokeæ–¹æ³•ä¸­å®ç°ç½‘ç»œé€šä¿¡ã€‚å‚æ•°åºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯JDKçš„ObjectStreamã€‚ä¸€ä¸ªå®Œå–„çš„RPCæ¡†æ¶å…¶å®å°±æ˜¯åœ¨è¿™ä¾‹å­çš„åŸºç¡€ä¸Šè¿›è¡Œå¤šæ–¹ä½æ‰©å±•å’Œæ”¹è¿›ã€‚æ¯”å¦‚ï¼Œç½‘ç»œé€šä¿¡å¯ä»¥ä½¿ç”¨æ€§èƒ½æ›´å¥½çš„NIOæ¡†æ¶Nettyï¼ŒåŠ¨æ€ä»£ç†å¯ä»¥ä½¿ç”¨javaassistå­—èŠ‚ç ç”Ÿæˆæ–¹å¼[æ³¨æ„ï¼šä¸æ˜¯javaassistæä¾›çš„åŠ¨æ€ä»£ç†æ¥å£ï¼Œè¯¥æ¥å£æ¯”JDKè‡ªå¸¦çš„è¿˜æ…¢]ï¼Œåºåˆ—åŒ–æ–¹å¼å¯ä»¥é‡‡ç”¨fastjsonã€hession2ä»¥åŠkryoç­‰æŠ€æœ¯ã€‚å¦‚æœæœåŠ¡æ•°é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡ï¼Œå¯ä»¥å¼•è¿›æ³¨å†Œä¸­å¿ƒè¿›è¡ŒæœåŠ¡çš„æ²»ç†ã€‚èŠ‚ç‚¹é—´çš„é€šä¿¡æ–¹å¼å¯ä»¥æœ‰å¤šç§ï¼Œå› æ­¤å¯ä»¥æ‰©å±•å¤šåè®®ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ€§èƒ½å’Œå¥å£®æ€§ä¹Ÿæ˜¯ä¸€ä¸ªä¼˜ç§€çš„RPCæ¡†æ¶æ‰€å¿…é¡»çš„ï¼Œå¦‚é›†ç¾¤å®¹é”™ã€è´Ÿè½½å‡è¡¡ã€é‡è¯•æœºåˆ¶ã€æœåŠ¡é™çº§â€¦è¿™äº›éƒ½ä¼šåœ¨åé¢åˆ†æçš„Dubboæ¡†æ¶ä¸­å¾—åˆ°å¾ˆå¥½çš„ä½“ç°ã€‚","categories":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"}],"tags":[{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"}]},{"title":"å‘½ä»¤æ¨¡å¼","slug":"design_pattern/behaviour_type/å‘½ä»¤æ¨¡å¼","date":"2019-10-04T16:00:00.000Z","updated":"2020-08-09T09:26:57.923Z","comments":true,"path":"posts/78134e07/","link":"","permalink":"https://gentryhuang.com/posts/78134e07/","excerpt":"","text":"å®šä¹‰å‘½ä»¤æ¨¡å¼åˆå«æŒ‡ä»¤æ¨¡å¼ï¼Œæ˜¯å°†â€œè¯·æ±‚â€å°è£…æˆå¯¹è±¡ï¼Œä»¥ä¾¿ä½¿ç”¨ä¸åŒçš„è¯·æ±‚ã€‚æˆ‘ä»¬å¯ä»¥æŠŠä¸åŒçš„è¯·æ±‚å°è£…æˆä¸åŒè¯·æ±‚å¯¹è±¡ï¼Œå¯¹äºæ¥æ”¶è€…æ¥è¯´è¿™äº›ç±»å‹éƒ½èƒ½è¯†åˆ«ï¼Œç„¶åæ ¹æ®ä¸åŒçš„è¯·æ±‚å¯¹è±¡æ‰§è¡Œä¸åŒçš„è¡Œä¸ºã€‚ è¯´æ˜å‘½ä»¤æ¨¡å¼è§£å†³äº†åº”ç”¨ç¨‹åºä¸­å¯¹è±¡çš„èŒè´£ä»¥åŠå®ƒä»¬ä¹‹é—´çš„é€šä¿¡æ–¹å¼ï¼Œå‘½ä»¤æ¨¡å¼å¯ä»¥ä½¿å‘½ä»¤å‘é€è€…å’Œæ¥æ”¶è€…å®Œå…¨è§£è€¦ï¼Œå‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„å¼•ç”¨å…³ç³»ã€‚å‘é€å‘½ä»¤çš„å¯¹è±¡åªçŸ¥é“å¦‚ä½•ä¸‹å‘½ä»¤ï¼Œä¸éœ€è¦çŸ¥é“å¦‚ä½•å®Œæˆå‘½ä»¤ã€‚ ç±»å‹è¡Œä¸ºå‹ ä½¿ç”¨åœºæ™¯121. è¯·æ±‚è°ƒç”¨è€…å’Œè¯·æ±‚æ¥æ”¶è€…éœ€è¦è§£è€¦ï¼Œä½¿å¾—è°ƒç”¨è€…å’Œæ¥æ”¶è€…ä¸ç›´æ¥äº¤äº’2. éœ€è¦æŠ½è±¡å‡ºç­‰å¾…æ‰§è¡Œçš„è¡Œä¸º ä¼˜ç‚¹1231. é™ä½è€¦åˆ - é€šè¿‡å‘½ä»¤æ¨¡å¼æŠŠè¯·æ±‚çš„å‘é€è€…å’Œè¯·æ±‚çš„æ¥æ”¶è€…è¿›è¡Œè§£è€¦2. å®¹æ˜“æ‰©å±•æ–°å‘½ä»¤æˆ–è€…ä¸€ç»„å‘½ä»¤ ç¼ºç‚¹12å‘½ä»¤çš„æ— é™æ‰©å±•ä¼šå¢åŠ ç±»çš„æ•°é‡ï¼Œæé«˜ç³»ç»Ÿå®ç°å¤æ‚åº¦ - é’ˆå¯¹æ¯ä¸€ä¸ªå‘½ä»¤æˆ‘ä»¬éƒ½è¦è®¾è®¡å¹¶å¼€å‘ä¸€ä¸ªå…·ä½“çš„å‘½ä»¤ç±» ç›¸å…³çš„è®¾è®¡æ¨¡å¼å‘½ä»¤æ¨¡å¼å’Œå¤‡å¿˜å½•æ¨¡å¼ 1å¯ä»¥æŠŠä¸¤è€…ç»“åˆä½¿ç”¨ï¼Œä½¿ç”¨å¤‡å¿˜å½•æ¨¡å¼ä¿å­˜å‘½ä»¤çš„å†å²è®°å½•ï¼Œè¿™æ ·å¯ä»¥è°ƒç”¨ä¹‹å‰çš„å‘½ä»¤ ç®€å•éœ€æ±‚ä¸€åˆ›ä¸šå…¬å¸ä¸ºäº†æŠ¢å å¸‚åœºï¼Œè€æ¿å¯¹å¼€å‘éƒ¨å‰åä¸‹è¾¾äº†ä¸¤ä¸ªå‘½ä»¤ï¼Œå…ˆä½¿ç”¨å•ä¾‹æ¶æ„å¿«é€Ÿå¼€å‘å‡ºäº§å“ï¼Œç­‰åˆ°æŠ¢å äº†å¸‚åœºåå†æ‰©å¤§è§„æ¨¡æŠŠå•ä½“ç»“æ„æ‹†æˆå¾®æœåŠ¡æ¶æ„ã€‚ å‘½ä»¤æ¨¡å¼æ¼”ç»ƒ æŠŠå‘½ä»¤æŠ½è±¡æˆå¯¹è±¡ï¼Œè¿™æ˜¯å‘½ä»¤æ¨¡å¼å®ç°çš„æ ¸å¿ƒ 1å‘½ä»¤æ‰©å±•å¾ˆå®¹æ˜“ï¼Œå¢åŠ å‘½ä»¤åªéœ€å°è£…ä¸€ä¸ªå‘½ä»¤ç±»ã€‚å¦‚æœæœ‰å‘½ä»¤è¡Œä¸ºä½“æ ¹æ®æƒ…å†µä¿®æ”¹å‘½ä»¤è¡Œä¸ºä½“ã€‚ å‘½ä»¤è¡Œä¸ºä½“ 1æ¯ä¸ªå‘½ä»¤æ‰§è¡Œçš„å…·ä½“è¡Œä¸ºåœ¨è¡Œä¸ºä½“ä¸­ï¼Œä½†ä¸æ˜¯å¿…é¡»çš„ï¼Œä¹Ÿå¯ä»¥ä¸è¦è¡Œä¸ºä½“ï¼Œè®©å‘½ä»¤æ‰§è¡Œå˜å¾—æ›´çµæ´»ã€‚ 123456789101112131415161718192021222324252627282930313233343536package com.design.pattern.command;import lombok.extern.slf4j.Slf4j;/** * Project é¡¹ç›® * * @author shunhua * @date 2019-10-04 */@Slf4jpublic class Project &#123; /** * é¡¹ç›®åç§° */ private String name; public Project(String name)&#123; this.name = name; &#125; /** * ä½¿ç”¨å•ä½“æ¶æ„å¼€å‘é¡¹ç›® */ public void monomer()&#123; log.info(String.format(\"%sé¡¹ç›®ä½¿ç”¨å•ä½“æ¶æ„å¼€å‘\",this.name)); &#125; /** * ä½¿ç”¨å¾®æœåŠ¡æ¶æ„å¼€å‘é¡¹ç›® */ public void microservice()&#123; log.info(String.format(\"%sé¡¹ç›®ä½¿ç”¨å¾®æœåŠ¡æ¶æ„å¼€å‘\",this.name)); &#125;&#125; å‘½ä»¤æ¥å£ 1234567891011121314package com.design.pattern.command;/** * Command å‘½ä»¤æ¥å£ * * @author shunhua * @date 2019-10-04 */public interface Command &#123; /** * æ‰§è¡Œå‘½ä»¤ */ void execute();&#125; å•ä½“æ¶æ„å¼€å‘å‘½ä»¤ 123456789101112131415161718192021222324252627282930package com.design.pattern.command;/** * MonomerCommand å•ä½“æ¶æ„å¼€å‘å‘½ä»¤ç±»ï¼Œæ‰§è¡Œçš„æ˜¯å•ä½“æ¶æ„å¼€å‘ * * @author shunhua * @date 2019-10-04 */public class MonomerCommand implements Command &#123; /** * ç»„åˆï¼Œå‘½ä»¤å¯¹åº”çš„è¡Œä¸ºä½“ (éå¿…é¡»çš„ï¼Œå‘½ä»¤çš„è¡Œä¸ºå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡ç¼–å†™) */ private Project project; /** * æ„é€ æ–¹æ³• * @param project */ public MonomerCommand(Project project)&#123; this.project = project; &#125; /** * æ‰§è¡Œå‘½ä»¤ */ @Override public void execute() &#123; project.monomer(); &#125;&#125; å¾®æœåŠ¡æ¶æ„å¼€å‘å‘½ä»¤ 12345678910111213141516171819202122232425262728293031package com.design.pattern.command;/** * MicroserviceCommand å¾®æœåŠ¡æ¶æ„å¼€å‘å‘½ä»¤ç±»ï¼Œæ‰§è¡Œçš„æ˜¯å¾®æœåŠ¡æ¶æ„å¼€å‘ * * @author shunhua * @date 2019-10-04 */public class MicroserviceCommand implements Command &#123; /** * ç»„åˆï¼Œå‘½ä»¤å¯¹åº”çš„è¡Œä¸ºä½“ (éå¿…é¡»çš„ï¼Œå‘½ä»¤çš„è¡Œä¸ºå¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡ç¼–å†™) */ private Project project; /** * æ„é€ æ–¹æ³• * @param project */ public MicroserviceCommand(Project project)&#123; this.project = project; &#125; /** * æ‰§è¡Œå‘½ä»¤ */ @Override public void execute() &#123; project.microservice(); &#125;&#125; å‘½ä»¤æ¥æ”¶è€… 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package com.design.pattern.command;import java.util.ArrayList;import java.util.List;/** * Staff å‘½ä»¤æ‰§è¡Œè€… * * @author shunhua * @date 2019-10-04 */public class Staff &#123; /** * å‘½ä»¤é›†åˆï¼Œå¯ä»¥æ¥æ”¶å¤šä¸ªå‘½ä»¤ */ private List&lt;Command&gt; commands = new ArrayList&lt;&gt;(); /** * æ¥æ”¶å‘½ä»¤ * @param command */ public void addCommand(Command command)&#123; commands.add(command); &#125; /** * ç§»é™¤å‘½ä»¤ * @param command */ public void removeCommand(Command command)&#123; commands.remove(command); &#125; /** * æ‰§è¡ŒæŒ‡å®šçš„å * @param command */ public void execureCommand(Command command)&#123; command.execute(); &#125; /** * æ‰§è¡Œå‘½ä»¤é›† */ public void executeCommandList()&#123; this.commands.stream().forEach(Command::execute); commands.clear(); &#125;&#125; åº”ç”¨å±‚ 1234567891011121314151617181920212223242526272829303132333435363738package com.design.pattern.command;import org.junit.Test;/** * Boss å‘½ä»¤çš„ä¸‹è¾¾è€… * * @author shunhua * @date 2019-10-04 */public class Boss &#123; @Test public void test() throws InterruptedException &#123; // åˆ›å»ºå‘½ä»¤çš„è¡Œä¸ºä½“ Project projectDevelopment = new Project(\"å¸¦ä½ é£\"); // åˆ›å»ºå‘½ä»¤å¯¹è±¡(è€æ¿ä¸‹è¾¾å‘½ä»¤) MicroserviceCommand microserviceCommand = new MicroserviceCommand(projectDevelopment); MonomerCommand monomerCommand = new MonomerCommand(projectDevelopment); System.out.println(\"//-----------------------åˆ†åˆ«æ‰§è¡Œå‘½ä»¤---------------------------/\"); // å‘˜å·¥æ¥æ”¶å¹¶æ‰§è¡Œå‘½ä»¤ Staff staff = new Staff(); staff.execureCommand(microserviceCommand); staff.execureCommand(monomerCommand); Thread.sleep(2000); System.out.println(\"//-----------------------ç»Ÿä¸€æ‰§è¡Œå‘½ä»¤é›†-------------------------/\"); // å‘˜å·¥æ¥æ”¶å¤šä¸ªå‘½ä»¤,ç»Ÿä¸€æ‰§è¡Œ staff.addCommand(microserviceCommand); staff.addCommand(monomerCommand); staff.executeCommandList(); &#125;&#125; å‘½ä»¤æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨Runnableæ¥å£çš„å®ç°ç±» 1Runnableå¯ä»¥çœ‹æˆä¸€ä¸ªæŠ½è±¡çš„å‘½ä»¤ï¼Œå®ƒçš„å®ç°å¯ä»¥ç†è§£ä¸ºå…·ä½“çš„å‘½ä»¤å®ç°","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"çŠ¶æ€æ¨¡å¼","slug":"design_pattern/behaviour_type/çŠ¶æ€æ¨¡å¼","date":"2019-10-04T16:00:00.000Z","updated":"2020-08-09T09:28:21.142Z","comments":true,"path":"posts/8acb1976/","link":"","permalink":"https://gentryhuang.com/posts/8acb1976/","excerpt":"","text":"å®šä¹‰å…è®¸ä¸€ä¸ªå¯¹è±¡åœ¨å…¶å†…éƒ¨çŠ¶æ€æ”¹å˜æ—¶ï¼Œæ”¹å˜å®ƒçš„è¡Œä¸ºï¼Œå¦‚æœè¡Œä¸ºä¸éœ€è¦æ”¹å˜å°±ä¸è¦æ”¹å˜ã€‚ä¸€èˆ¬è¿™ä¸ªå­˜åœ¨å¤šä¸ªçŠ¶æ€çš„å¯¹è±¡æ˜¯ä¸€ä¸ªâ€œä¸Šä¸‹æ–‡â€ã€‚ ç±»å‹è¡Œä¸ºå‹ ä½¿ç”¨åœºæ™¯1ä¸€ä¸ªå¯¹è±¡å­˜åœ¨å¤šä¸ªçŠ¶æ€ï¼ˆä¸åŒçŠ¶æ€ä¸‹è¡Œä¸ºä¸åŒï¼‰ï¼Œä¸”çŠ¶æ€å¯ç›¸äº’è½¬æ¢ ä¼˜ç‚¹12341. å°†ä¸åŒçš„çŠ¶æ€éš”ç¦» - æ¯ä¸ªçŠ¶æ€éƒ½æ˜¯ä¸€ä¸ªç±»2. æŠŠå„ç§çŠ¶æ€çš„è½¬æ¢é€»è¾‘åˆ†å¸ƒåˆ°Stateçš„å­ç±»ä¸­ï¼Œå‡å°‘ç›¸äº’é—´ä¾èµ– 3. å¢åŠ æ–°çš„çŠ¶æ€éå¸¸ç®€å•ï¼ˆä¹Ÿå°±å¢åŠ ä¸€ä¸ªçŠ¶æ€ç±»ï¼Œå¦‚æœè¿˜è¦æ»¡è¶³ç›¸äº’è½¬æ¢ï¼Œå…¶ä»–å·²æœ‰çš„çŠ¶æ€å†…éƒ¨ä¹Ÿéœ€è¦ä¿®æ”¹ï¼‰ ç¼ºç‚¹1çŠ¶æ€å¤šçš„ä¸šåŠ¡åœºæ™¯å¯¼è‡´ç±»æ•°ç›®å¢åŠ ï¼Œç³»ç»Ÿå˜å¾—å¤æ‚ ç›¸å…³çš„è®¾è®¡æ¨¡å¼çŠ¶æ€æ¨¡å¼å’Œäº«å…ƒæ¨¡å¼ 1å®ƒä»¬æœ‰æ—¶å¯ä»¥é…åˆä½¿ç”¨ ç®€å•éœ€æ±‚æ’­æ”¾è§†é¢‘çš„æ—¶å€™ï¼Œæœ‰æ’­æ”¾çŠ¶æ€ã€å¿«è¿›æ’­æ”¾çŠ¶æ€ã€æš‚åœçŠ¶æ€ä»¥åŠåœæ­¢çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€å¤§éƒ½å¯ä»¥ç›¸äº’è½¬æ¢ã€‚å½“çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶å¯¹åº”çš„æ’­æ”¾è¡Œä¸ºä¹Ÿå‘ç”Ÿäº†æ”¹å˜ã€‚ çŠ¶æ€çˆ¶ç±» 1234567891011121314151617181920212223242526272829303132333435363738package com.design.pattern.state;import lombok.Setter;/** * VideoState è§†é¢‘çŠ¶æ€ * * @author shunhua * @date 2019-10-05 */@Setterpublic abstract class VideoState &#123; /** * è§†é¢‘èµ„æºä¸Šä¸‹æ–‡ */ protected VideoContext videoContext; /** * æ’­æ”¾ */ public abstract void play(); /** * å¿«è¿› */ public abstract void speed(); /** * æš‚åœ */ public abstract void pause(); /** * åœæ­¢ */ public abstract void stop(); &#125; æ’­æ”¾çŠ¶æ€ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142package com.design.pattern.state;import lombok.extern.slf4j.Slf4j;/** * PlayState è§†é¢‘æ’­æ”¾çŠ¶æ€ * * @author shunhua * @date 2019-10-05 */@Slf4jpublic class PlayState extends VideoState &#123; @Override public void play() &#123; log.info(\"è§†é¢‘æ­£å¸¸æ’­æ”¾çŠ¶æ€\"); &#125; /** * å¯åˆ‡æ¢å¿«è¿› */ @Override public void speed() &#123; super.videoContext.setVideoState(VideoContext.SPEED_STATE); &#125; /** * å¯åˆ‡æ¢æš‚åœ */ @Override public void pause() &#123; super.videoContext.setVideoState(VideoContext.PAUSE_STATE); &#125; /** * å¯åˆ‡æ¢åœæ­¢ */ @Override public void stop() &#123; super.videoContext.setVideoState(VideoContext.STOP_STATE); &#125;&#125; æš‚åœæ’­æ”¾çŠ¶æ€ç±» 123456789101112131415161718192021222324252627282930313233package com.design.pattern.state;import lombok.extern.slf4j.Slf4j;/** * PauseState è§†é¢‘æš‚åœçŠ¶æ€ * * @author shunhua * @date 2019-10-05 */@Slf4jpublic class PauseState extends VideoState &#123; @Override public void play() &#123; super.videoContext.setVideoState(VideoContext.PLAY_STATE); &#125; @Override public void speed() &#123; super.videoContext.setVideoState(VideoContext.SPEED_STATE); &#125; @Override public void pause() &#123; log.info(\"è§†é¢‘æš‚åœæ’­æ”¾çŠ¶æ€\"); &#125; @Override public void stop() &#123; super.videoContext.setVideoState(VideoContext.STOP_STATE); &#125;&#125; å¿«è¿›æ’­æ”¾çŠ¶æ€ç±» 123456789101112131415161718192021222324252627282930313233package com.design.pattern.state;import lombok.extern.slf4j.Slf4j;/** * SpeedState è§†é¢‘åŠ é€ŸçŠ¶æ€ * * @author shunhua * @date 2019-10-05 */@Slf4jpublic class SpeedState extends VideoState &#123; @Override public void play() &#123; super.videoContext.setVideoState(VideoContext.PLAY_STATE); &#125; @Override public void speed() &#123; log.info(\"è§†é¢‘å¿«è¿›æ’­æ”¾çŠ¶æ€\"); &#125; @Override public void pause() &#123; super.videoContext.setVideoState(VideoContext.PAUSE_STATE); &#125; @Override public void stop() &#123; super.videoContext.setVideoState(VideoContext.STOP_STATE); &#125;&#125; åœæ­¢çŠ¶æ€ç±» 123456789101112131415161718192021222324252627282930313233package com.design.pattern.state;import lombok.extern.slf4j.Slf4j;/** * StopState è§†é¢‘åœæ­¢çŠ¶æ€ * * @author shunhua * @date 2019-10-05 */@Slf4jpublic class StopState extends VideoState &#123; @Override public void play() &#123; super.videoContext.setVideoState(VideoContext.PLAY_STATE); &#125; @Override public void speed() &#123; log.info(\"åœæ­¢çŠ¶æ€ä¸èƒ½å¿«è¿›\"); &#125; @Override public void pause() &#123; log.info(\"åœæ­¢çŠ¶æ€ä¸èƒ½æš‚åœ\"); &#125; @Override public void stop() &#123; log.info(\"è§†é¢‘åœæ­¢æ’­æ”¾çŠ¶æ€\"); &#125;&#125; çŠ¶æ€å¯¹åº”çš„ä¸Šä¸‹æ–‡ 123456789101112131415161718192021222324252627282930313233package com.design.pattern.state;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-04 */@Slf4jpublic class Client &#123; @Test public void test()&#123; // å£°æ˜ä¸€ä¸ªä¸Šä¸‹æ–‡ VideoContext videoContext = new VideoContext(); videoContext.setVideoState(new PlayState()); log.info(\"å½“å‰çŠ¶æ€ï¼š\" + videoContext.getVideoState().getClass().getSimpleName()); videoContext.pause(); log.info(\"å½“å‰çŠ¶æ€ï¼š\" + videoContext.getVideoState().getClass().getSimpleName()); videoContext.speed(); log.info(\"å½“å‰çŠ¶æ€ï¼š\" + videoContext.getVideoState().getClass().getSimpleName()); videoContext.stop(); log.info(\"å½“å‰çŠ¶æ€ï¼š\" + videoContext.getVideoState().getClass().getSimpleName()); &#125;&#125; çŠ¶æ€æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨ çŠ¶æ€æ¨¡å¼å’Œä¸šåŠ¡åœºæ™¯æ›´ç´§å¯†ç›¸å…³ï¼Œæ¯”å¦‚ç”µå•†ä¸­è®¢å•çš„çŠ¶æ€ã€æ ¹æ®ä¸šåŠ¡è®¾ç½®çŠ¶æ€æœºã€åŠå…¬ç³»ç»Ÿæµç¨‹çš„çŠ¶æ€ç­‰ï¼Œæºç ä¸­ç›¸å¯¹å¾ˆå°‘ä½¿ç”¨","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è®¿é—®è€…æ¨¡å¼","slug":"design_pattern/behaviour_type/è®¿é—®è€…æ¨¡å¼","date":"2019-10-04T16:00:00.000Z","updated":"2020-08-09T09:30:13.914Z","comments":true,"path":"posts/64b51ed9/","link":"","permalink":"https://gentryhuang.com/posts/64b51ed9/","excerpt":"","text":"å®šä¹‰å°è£…ä½œç”¨äºæŸæ•°æ®ç»“æ„(å¦‚List/Set/Mapç­‰)ä¸­çš„å„å…ƒç´ çš„æ“ä½œã€‚å¯ä»¥åœ¨ä¸æ”¹å˜å„å…ƒç´ çš„ç±»çš„å‰æä¸‹ï¼Œå®šä¹‰ä½œç”¨äºè¿™äº›å…ƒç´ çš„æ“ä½œã€‚å³å½“è®¿é—®æŸä¸ªèµ„æºæ—¶ï¼Œä¸å»ä¿®æ”¹èµ„æºæœ¬èº«è€Œæ˜¯å®šä¹‰è®¿é—®èµ„æºçš„æ“ä½œ ç±»å‹è¡Œä¸ºå‹ ä½¿ç”¨åœºæ™¯121. ä¸€ä¸ªæ•°æ®ç»“æ„å¦‚ï¼ˆList&#x2F;Set&#x2F;Mapç­‰ï¼‰åŒ…å«å¾ˆå¤šç±»å‹å¯¹è±¡2. æ•°æ®ç»“æ„äºæ•°æ®æ“ä½œåˆ†ç¦» ä¼˜ç‚¹1å¢åŠ æ–°çš„æ“ä½œå¾ˆå®¹æ˜“ï¼Œå³å¢åŠ ä¸€ä¸ªæ–°çš„è®¿é—®è€… ç¼ºç‚¹1231. å¢åŠ æ–°çš„æ•°æ®ç»“æ„å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹çš„åœ°æ–¹æ¯”è¾ƒå¤š2. å…·ä½“å…ƒç´ å˜æ›´æ¯”è¾ƒéº»çƒ¦ - å¢åŠ æˆ–è€…åˆ é™¤å…ƒç´ é‡Œé¢çš„å±æ€§éƒ½ç®—å˜æ›´ ç›¸å…³çš„è®¾è®¡æ¨¡å¼è®¿é—®è€…æ¨¡å¼å’Œè¿­ä»£å™¨æ¨¡å¼ 121. å®ƒä»¬éƒ½æ˜¯åœ¨æŸç§æ•°æ®ç»“æ„ä¸Šè¿›è¡Œå¤„ç†2. è®¿é—®è€…æ¨¡å¼ä¸»è¦å¯¹ä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­çš„å…ƒç´ è¿›è¡ŒæŸç§ç‰¹å®šçš„å¤„ç†ï¼Œè¿­ä»£å™¨ç”¨äºé€ä¸ªéå†ä¿å­˜åœ¨æ•°æ®ç»“æ„ä¸­çš„ä¸€äº›å…ƒç´  ç®€å•éœ€æ±‚ç½‘ç»œè¯¾ç¨‹æœ‰å…è´¹çš„ä¹Ÿæœ‰ä»˜è´¹çš„ï¼Œå…è´¹çš„è¯¾ç¨‹æ™®é€šç”¨æˆ·éƒ½å¯ä»¥è®¿é—®ï¼Œä»˜è´¹çš„è¯¾ç¨‹éœ€è¦è´­ä¹°ç§°ä¸ºVipç”¨æˆ·æ‰èƒ½è®¿é—®ã€‚ç›¸åŒçš„èµ„æºä¸åŒçš„ç”¨æˆ·èº«ä»½ï¼Œè®¿é—®çš„ç»“æœä¸åŒ è®¿é—®è€…æ¨¡å¼æ¼”ç»ƒ å½“è®¿é—®æŸä¸ªèµ„æºæ—¶ï¼Œä¸å»ä¿®æ”¹èµ„æºæœ¬èº«è€Œæ˜¯å®šä¹‰è®¿é—®èµ„æºçš„æ“ä½œã€‚ç›¸åŒçš„èµ„æºä¸åŒçš„è®¿é—®èº«ä»½ï¼Œäº§ç”Ÿä¸åŒçš„æ“ä½œè¡Œä¸º æŠ½è±¡è¯¾ç¨‹èµ„æº 12345678910111213141516171819202122232425262728package com.design.pattern.visitor;import lombok.Getter;import lombok.Setter;/** * Course è¢«è®¿é—®çš„èµ„æº * * ä¸æ”¹å˜Course,è€Œæ˜¯å®šä¹‰è®¿é—®Courseçš„æ“ä½œï¼Œè¿™é‡Œä½“ç°åœ¨IVisitorçš„æ–¹æ³•ä¸Š * * @author shunhua * @date 2019-10-05 */@Getter@Setterpublic abstract class Course &#123; /** * è¯¾ç¨‹åç§° */ private String name; /** * æ¥å—è®¿é—® æŠŠè®¿é—®è€…ä¼ å…¥ * @param visitor */ public abstract void accept(IVisitor visitor); &#125; å…è´¹è¯¾ç¨‹èµ„æº 12345678910111213141516171819package com.design.pattern.visitor;/** * FreeCourse * * @author shunhua * @date 2019-10-05 */public class FreeCourse extends Course &#123; /** * æ¥å—è®¿é—® * @param visitor */ @Override public void accept(IVisitor visitor) &#123; visitor.visit(this); &#125;&#125; ä»˜è´¹è¯¾ç¨‹èµ„æº 12345678910111213141516171819202122232425262728package com.design.pattern.visitor;import lombok.Getter;import lombok.Setter;/** * PayCourse * * @author shunhua * @date 2019-10-05 */@Getter@Setterpublic class PayCourse extends Course &#123; /** * ä»·æ ¼ */ private int price; /** * æ¥å—è®¿é—® * @param visitor */ @Override public void accept(IVisitor visitor) &#123; visitor.visit(this); &#125;&#125; è®¿é—®è€…æŠ½è±¡ 12345678910111213141516171819202122232425package com.design.pattern.visitor;/** * IVisitor è®¿é—®æ¥å£ * * è¿™é‡Œå®šä¹‰äº†è®¿é—®èµ„æºçš„æ“ä½œï¼Œå…·ä½“çš„è®¿é—®ç»†èŠ‚ä½“ç°åœ¨å®ç°ç±»ä¸­ï¼Œä¸åŒçš„å®ç°ç±»å¯¹ç›¸åŒçš„èµ„æºäº§ç”Ÿä¸åŒçš„æ“ä½œè¡Œä¸ºï¼Œè¿™æ˜¯è®¿é—®è€…çš„æ ¸å¿ƒ * * @author shunhua * @date 2019-10-05 */public interface IVisitor &#123; /** * è®¿é—®å…è´¹è¯¾ç¨‹ * @param freeCourse */ void visit(FreeCourse freeCourse); /** * è®¿é—®ä»˜è´¹è¯¾ç¨‹ * @param payCourse */ void visit(PayCourse payCourse);&#125; æ™®é€šè®¿é—®è€… 12345678910111213141516171819202122232425262728293031package com.design.pattern.visitor;import lombok.extern.slf4j.Slf4j;/** * GeneralVisitor æ™®é€šè®¿é—®è€… * * @author shunhua * @date 2019-10-05 */@Slf4jpublic class GeneralVisitor implements IVisitor &#123; /** * è®¿é—®å…è´¹è¯¾ç¨‹ * @param freeCourse */ @Override public void visit(FreeCourse freeCourse) &#123; log.info(\"å…è´¹è¯¾ç¨‹åï¼š\" + freeCourse.getName()); &#125; /** * è®¿é—®ä»˜è´¹è¯¾ç¨‹ * @param payCourse */ @Override public void visit(PayCourse payCourse) &#123; log.info(\"è¿™æ˜¯ä»˜è´¹è¯¾ç¨‹ï¼Œä½ è¿˜æ²¡æœ‰è´­ä¹°ï¼Œæ²¡æœ‰è®¿é—®æƒé™\"); &#125;&#125; Vipè®¿é—®è€… 12345678910111213141516171819202122232425262728293031package com.design.pattern.visitor;import lombok.extern.slf4j.Slf4j;/** * VipVisitor Vipè®¿é—®è€… * * @author shunhua * @date 2019-10-05 */@Slf4jpublic class VipVisitor implements IVisitor&#123; /** * è®¿é—®å…è´¹è¯¾ç¨‹ * @param freeCourse */ @Override public void visit(FreeCourse freeCourse) &#123; log.info(\"å…è´¹è¯¾ç¨‹åï¼š\" + freeCourse.getName()); &#125; /** * è®¿é—®ä»˜è´¹è¯¾ç¨‹ * @param payCourse */ @Override public void visit(PayCourse payCourse) &#123; log.info(\"ä»˜è´¹è¯¾ç¨‹åï¼š\" + payCourse.getName() + \" ä»·æ ¼ä¸ºï¼š\" + payCourse.getPrice()); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.design.pattern.visitor;import org.junit.Test;import java.util.ArrayList;import java.util.List;/** * Client * * @author shunhua * @date 2019-10-05 */public class Client &#123; @Test public void test()&#123; List&lt;Course&gt; courseList = new ArrayList&lt;&gt;(); FreeCourse freeCourse = new FreeCourse(); freeCourse.setName(\"è¿™æ˜¯ä¸€ä¸ªå…è´¹çš„è¯¾ç¨‹\"); PayCourse payCourse = new PayCourse(); payCourse.setName(\"è¿™æ˜¯ä¸€ä¸ªä»˜è´¹çš„è¯¾ç¨‹\"); payCourse.setPrice(300); courseList.add(freeCourse); courseList.add(payCourse); // æ™®é€šè®¿é—®è€… GeneralVisitor generalVisitor = new GeneralVisitor(); // Vipç”¨æˆ· VipVisitor vipVisitor = new VipVisitor(); System.out.println(\"//----------æ™®é€šè®¿é—®è€…----------------/\"); courseList.stream().forEach(course -&gt; &#123; course.accept(generalVisitor); &#125;); System.out.println(\"//----------vipç”¨æˆ·------------------/\"); courseList.stream().forEach(course -&gt; &#123; course.accept(vipVisitor); &#125;); &#125;&#125; è®¿é—®è€…æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨FileVisitor 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283package java.nio.file;import java.nio.file.attribute.BasicFileAttributes;import java.io.IOException;import java.util.Objects;/** * èµ„æºæ˜¯æ–‡ä»¶ * * @since 1.7 */public class SimpleFileVisitor&lt;T&gt; implements FileVisitor&lt;T&gt; &#123; /** * Initializes a new instance of this class. */ protected SimpleFileVisitor() &#123; &#125; /** * Invoked for a directory before entries in the directory are visited. * * &lt;p&gt; Unless overridden, this method returns &#123;@link FileVisitResult#CONTINUE * CONTINUE&#125;. */ @Override public FileVisitResult preVisitDirectory(T dir, BasicFileAttributes attrs) throws IOException &#123; Objects.requireNonNull(dir); Objects.requireNonNull(attrs); return FileVisitResult.CONTINUE; &#125; /** * Invoked for a file in a directory. * * &lt;p&gt; Unless overridden, this method returns &#123;@link FileVisitResult#CONTINUE * CONTINUE&#125;. */ @Override public FileVisitResult visitFile(T file, BasicFileAttributes attrs) throws IOException &#123; Objects.requireNonNull(file); Objects.requireNonNull(attrs); return FileVisitResult.CONTINUE; &#125; /** * Invoked for a file that could not be visited. * * &lt;p&gt; Unless overridden, this method re-throws the I/O exception that prevented * the file from being visited. */ @Override public FileVisitResult visitFileFailed(T file, IOException exc) throws IOException &#123; Objects.requireNonNull(file); throw exc; &#125; /** * Invoked for a directory after entries in the directory, and all of their * descendants, have been visited. * * &lt;p&gt; Unless overridden, this method returns &#123;@link FileVisitResult#CONTINUE * CONTINUE&#125; if the directory iteration completes without an I/O exception; * otherwise this method re-throws the I/O exception that caused the iteration * of the directory to terminate prematurely. */ @Override public FileVisitResult postVisitDirectory(T dir, IOException exc) throws IOException &#123; Objects.requireNonNull(dir); if (exc != null) throw exc; return FileVisitResult.CONTINUE; &#125;&#125; BeanDefinitionVisitor 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package org.springframework.beans.factory.config;import java.util.LinkedHashMap;import java.util.LinkedHashSet;import java.util.List;import java.util.Map;import java.util.Set;import org.springframework.beans.MutablePropertyValues;import org.springframework.beans.PropertyValue;import org.springframework.lang.Nullable;import org.springframework.util.Assert;import org.springframework.util.ObjectUtils;import org.springframework.util.StringValueResolver;/** * èµ„æºï¼šBeançš„å®šä¹‰ * * @author Juergen Hoeller * @author Sam Brannen * @since 1.2 * @see BeanDefinition * @see BeanDefinition#getPropertyValues * @see BeanDefinition#getConstructorArgumentValues * @see PropertyPlaceholderConfigurer */public class BeanDefinitionVisitor &#123; @Nullable private StringValueResolver valueResolver; /** * Create a new BeanDefinitionVisitor, applying the specified * value resolver to all bean metadata values. * @param valueResolver the StringValueResolver to apply */ public BeanDefinitionVisitor(StringValueResolver valueResolver) &#123; Assert.notNull(valueResolver, \"StringValueResolver must not be null\"); this.valueResolver = valueResolver; &#125; /** * Create a new BeanDefinitionVisitor for subclassing. * Subclasses need to override the &#123;@link #resolveStringValue&#125; method. */ protected BeanDefinitionVisitor() &#123; &#125; /** * Traverse the given BeanDefinition object and the MutablePropertyValues * and ConstructorArgumentValues contained in them. * @param beanDefinition the BeanDefinition object to traverse * @see #resolveStringValue(String) */ public void visitBeanDefinition(BeanDefinition beanDefinition) &#123; visitParentName(beanDefinition); visitBeanClassName(beanDefinition); visitFactoryBeanName(beanDefinition); visitFactoryMethodName(beanDefinition); visitScope(beanDefinition); if (beanDefinition.hasPropertyValues()) &#123; visitPropertyValues(beanDefinition.getPropertyValues()); &#125; if (beanDefinition.hasConstructorArgumentValues()) &#123; ConstructorArgumentValues cas = beanDefinition.getConstructorArgumentValues(); visitIndexedArgumentValues(cas.getIndexedArgumentValues()); visitGenericArgumentValues(cas.getGenericArgumentValues()); &#125; &#125; &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"ä¸­ä»‹è€…æ¨¡å¼","slug":"design_pattern/behaviour_type/ä¸­ä»‹è€…æ¨¡å¼","date":"2019-10-03T16:00:00.000Z","updated":"2020-08-09T09:26:26.731Z","comments":true,"path":"posts/d036071c/","link":"","permalink":"https://gentryhuang.com/posts/d036071c/","excerpt":"","text":"å®šä¹‰å®šä¹‰äº†ä¸€ä¸ªå°è£…ä¸€ç»„å¯¹è±¡å¦‚ä½•äº¤äº’çš„å¯¹è±¡ï¼ˆè¿™ä¸ªå¯¹è±¡ç”¨æ¥åè°ƒè¿™ä¸€ç»„å¯¹è±¡ï¼ˆâ€œåŒäº‹ç±»â€ï¼‰ï¼‰ã€‚é€šè¿‡ä½¿å¯¹è±¡æ˜ç¡®åœ°ç›¸äº’å¼•ç”¨æ¥ä¿ƒè¿›æ¾æ•£è€¦åˆï¼Œå¹¶å…è®¸ç‹¬ç«‹åœ°æ”¹å˜å®ƒä»¬çš„äº¤äº’ã€‚ ç±»å‹è¡Œä¸ºå‹ é€‚ç”¨åœºæ™¯121. ç³»ç»Ÿä¸­å¯¹è±¡ä¹‹é—´å­˜åœ¨å¤æ‚çš„å¼•ç”¨å…³ç³»ï¼Œäº§ç”Ÿçš„ç›¸äº’ä¾èµ–å…³ç³»ç»“æ„æ··ä¹±éš¾ä»¥ç†è§£ï¼Œä½¿ç”¨ä¸­ä»‹è€…è¿›è¡Œåè°ƒ2. äº¤äº’çš„å…¬å…±è¡Œä¸ºï¼Œå¦‚æœéœ€è¦æ”¹å˜è¡Œä¸ºåˆ™å¯ä»¥å¢åŠ æ–°çš„ä¸­ä»‹è€…ç±» ä¼˜ç‚¹121. å°†ä¸€å¯¹å¤šè½¬åŒ–æˆäº†ä¸€å¯¹ä¸€ã€é™ä½ç¨‹åºå¤æ‚åº¦2. ç±»ä¹‹é—´çš„è§£è€¦ ç¼ºç‚¹1ä¸­ä»‹è€…è¿‡å¤šï¼Œå¯¼è‡´ç³»ç»Ÿå¤æ‚ ç›¸å…³çš„è®¾è®¡æ¨¡å¼ä¸­ä»‹è€…æ¨¡å¼å’Œè§‚å¯Ÿè€…æ¨¡å¼ 1ä¸¤è€…æœ‰æ—¶ç»“åˆä½¿ç”¨ï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼å®ç°ä¸­ä»‹è€…æ¨¡å¼ä¸­è§’è‰²é—´çš„é€šä¿¡ ç®€å•éœ€æ±‚å…¬å¸çš„å‘˜å·¥ä¹‹é—´å‘é€å…¬æœ‰æ¶ˆæ¯ï¼Œä½¿ç”¨å·¥ä½œç¾¤ç»Ÿä¸€å‘é€ï¼Œä¸éœ€è¦å‘é€è€…é€ä¸€å‘ç»™å…¶ä»–å‘˜å·¥ ä¸­ä»‹è€…æ¨¡å¼æ¼”ç»ƒ ä¸­ä»‹è€… 12345678910111213141516171819202122232425package com.design.pattern.mediator;import lombok.extern.slf4j.Slf4j;import java.util.Date;/** * WorkGroup ä¸­ä»‹è€… - å·¥ä½œç¾¤ * * @author shunhua * @date 2019-10-04 */@Slf4jpublic class WorkGroup &#123; /** * ä¸­ä»‹è€…æ˜¾ç¤ºå‘˜å·¥å‘é€çš„æ¶ˆæ¯ * @param worker * @param msg */ public static void showMsg(Worker worker, String msg)&#123; log.info(String.format(\"%s ã€%sã€‘: %s\",new Date().toString(),worker.getName(),msg)); &#125;&#125; å‚ä¸äº¤äº’çš„å¯¹è±¡ç±» 123456789101112131415161718192021222324252627package com.design.pattern.mediator;import lombok.AllArgsConstructor;import lombok.Data;/** * Worker å‘˜å·¥ é€šå¸¸ç§°ä¸ºâ€œåŒäº‹ç±»â€ * * @author shunhua * @date 2019-10-04 */@Data@AllArgsConstructorpublic class Worker &#123; /** * èŠ±å */ private String name; /** * å‘˜å·¥åªå’Œä¸­ä»‹è€…ï¼ˆå·¥ä½œç¾¤ï¼‰æ‰“äº¤é“ï¼Œè¿™æ˜¯ä¸­ä»‹è€…æ¨¡å¼çš„æ ¸å¿ƒ * @param msg */ public void sendMsg(String msg)&#123; WorkGroup.showMsg(this,msg); &#125;&#125; åº”ç”¨å±‚ 12345678910111213141516171819202122232425package com.design.pattern.mediator;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-04 */public class Client &#123; @Test public void test()&#123; Worker worker = new Worker(\"èˆœå\"); Worker worker1= new Worker(\"é«˜æ–¯æ—\"); worker1.sendMsg(\"å°ä¼™å­ï¼Œå°±ä½ è¿˜æƒ³å­¦æˆ‘çš„Javaï¼ï¼ï¼\"); worker.sendMsg(\"æœ‰å¥è¯ä¸çŸ¥å½“è®²ä¸å½“è®²ï¼Ÿ\"); &#125;&#125; ä¸­ä»‹è€…æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨Timer 1Timeræ˜¯ä¸€ä¸ªä¸­ä»‹è€…ï¼Œå®ƒåè°ƒTimerTaskä»»åŠ¡ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465package java.util;import java.util.Date;import java.util.concurrent.atomic.AtomicInteger;public class Timer &#123; /** * The timer task queue. This data structure is shared with the timer * thread. The timer produces tasks, via its various schedule calls, * and the timer thread consumes, executing timer tasks as appropriate, * and removing them from the queue when they're obsolete. */ private final TaskQueue queue = new TaskQueue(); /** * The timer thread. */ private final TimerThread thread = new TimerThread(queue); /** * Timerä¸­æœ‰å¤šä¸ªscheduleé‡è½½æ–¹æ³•ï¼Œé‡Œé¢éƒ½è°ƒç”¨äº†schedæ–¹æ³• */ public void schedule(TimerTask task, long delay) &#123; if (delay &lt; 0) throw new IllegalArgumentException(\"Negative delay.\"); sched(task, System.currentTimeMillis()+delay, 0); &#125; /** * * Timeræ˜¯ä¸€ä¸ªä¸­ä»‹è€…ï¼Œé€šè¿‡schedæ–¹æ³•ç»Ÿä¸€åè°ƒTimerTask * * @param task è¢«åè°ƒçš„å¯¹è±¡ * @param time * @param period */ private void sched(TimerTask task, long time, long period) &#123; if (time &lt; 0) throw new IllegalArgumentException(\"Illegal execution time.\"); // Constrain value of period sufficiently to prevent numeric // overflow while still being effectively infinitely large. if (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; 1)) period &gt;&gt;= 1; synchronized(queue) &#123; if (!thread.newTasksMayBeScheduled) throw new IllegalStateException(\"Timer already cancelled.\"); synchronized(task.lock) &#123; if (task.state != TimerTask.VIRGIN) throw new IllegalStateException( \"Task already scheduled or cancelled\"); task.nextExecutionTime = time; task.period = period; task.state = TimerTask.SCHEDULED; &#125; queue.add(task); if (queue.getMin() == task) queue.notify(); &#125; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å¤‡å¿˜å½•æ¨¡å¼","slug":"design_pattern/behaviour_type/å¤‡å¿˜å½•æ¨¡å¼","date":"2019-10-03T16:00:00.000Z","updated":"2020-08-09T09:27:24.516Z","comments":true,"path":"posts/c3176455/","link":"","permalink":"https://gentryhuang.com/posts/c3176455/","excerpt":"","text":"å®šä¹‰ä¿å­˜ä¸€ä¸ªå¯¹è±¡çš„æŸä¸ªçŠ¶æ€ï¼Œä»¥ä¾¿åœ¨é€‚å½“çš„æ—¶å€™æ¢å¤å¯¹è±¡ã€‚è¿™é‡Œçš„çŠ¶æ€å¯ä»¥ç†è§£ä¸ºå¯¹è±¡çš„ä¸€ä¸ªå¿«ç…§ã€‚ ç±»å‹è¡Œä¸ºå‹ é€‚ç”¨åœºæ™¯121 ä¿å­˜åŠæ¢å¤æ•°æ®ç›¸å…³ä¸šåŠ¡åœºæ™¯2 åæ‚”çš„æ—¶å€™ï¼Œå³æƒ³æ¢å¤åˆ°ä¹‹å‰çš„çŠ¶æ€ ä¼˜ç‚¹121 ä¸ºç”¨æˆ·æä¾›ä¸€ç§å¯æ¢å¤æœºåˆ¶2 å­˜æ¡£ä¿¡æ¯çš„å°è£… ç¼ºç‚¹12èµ„æºå ç”¨ - å¦‚æœæš‚å­˜çš„å¯¹è±¡æ¯”è¾ƒå¤šï¼Œè€Œä¸”å¯¹è±¡çš„å±æ€§ä¹Ÿæ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆè‚¯å®šä¼šå¯¹èµ„æºé€ æˆä¸€å®šçš„æ¶ˆè€—ï¼Œå ç”¨å¤§é‡çš„èµ„æºã€‚ ç›¸å…³çš„è®¾è®¡æ¨¡å¼å¤‡å¿˜å½•æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼ 1å¤‡å¿˜å½•æ¨¡å¼ä¸­æ˜¯ç”¨å®ä¾‹æ¥è¡¨ç¤ºçŠ¶æ€çš„ï¼Œæˆ‘ä»¬å­˜æ¡£çš„æ˜¯ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚çŠ¶æ€æ¨¡å¼ä¸­æ˜¯ä½¿ç”¨ç±»æ¥è¡¨ç¤ºçŠ¶æ€ã€‚ ç®€å•éœ€æ±‚åœ¨å†™æ–‡æ¡£æ—¶ï¼Œé—´æ–­æ€§åœ°ä¿å­˜ï¼Œç„¶åå¯ä»¥æ’¤é”€å›é€€åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ å¤‡å¿˜å½•æ¨¡å¼æ¼”ç»ƒ æ–‡ç«  12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package com.design.pattern.memento;import lombok.AllArgsConstructor;import lombok.Data;import java.io.Serializable;/** * Article æ–‡ç«  * * @author shunhua * @date 2019-10-04 */@Data@AllArgsConstructorpublic class Article implements Serializable &#123; private static final long serialVersionUID = -321234774998152556L; /** * æ–‡ç« æ ‡é¢˜ */ private String title; /** * æ–‡ç« å†…å®¹ */ private String content; /** * å›¾ç‰‡ */ private String img; /** * æŠŠæ–‡ç« ä¿å­˜èµ·æ¥ * @return */ public ArticleMemento saveToMemento()&#123; ArticleMemento articleMemento = new ArticleMemento(this.title,this.content,this.img); return articleMemento; &#125; /** * æŠŠä¿å­˜çš„æ–‡ç« æ ‡é¢˜ã€å†…å®¹ä»¥åŠå›¾ç‰‡å›é€€å›æ¥ * @param articleMemento */ public void undoFromMemento(ArticleMemento articleMemento)&#123; this.title = articleMemento.getTitle(); this.content = articleMemento.getContent(); this.img = articleMemento.getImg(); &#125;&#125; æ–‡ç« å¿«ç…§ 123456789101112131415161718192021222324252627282930package com.design.pattern.memento;import lombok.AllArgsConstructor;import lombok.Getter;import lombok.ToString;/** * ArticleMemento æ–‡ç« å¿«ç…§,å¯¹äºå¿«ç…§ä¸éœ€è¦Setteræ–¹æ³•ï¼Œåªç”¨äºä¿å­˜ * * @author shunhua * @date 2019-10-04 */@Getter@ToString@AllArgsConstructorpublic class ArticleMemento &#123; /** * æ ‡é¢˜ */ private String title; /** * å†…å®¹ */ private String content; /** * å›¾ç‰‡ */ private String img;&#125; æ–‡ç« å¿«ç…§æš‚å­˜ç®¡ç† 12345678910111213141516171819202122232425262728293031323334package com.design.pattern.memento;import java.util.Stack;/** * ArticleMementoManager æ–‡ç« å¿«ç…§ç®¡ç†è€… * * @author shunhua * @date 2019-10-04 */public class ArticleMementoManager &#123; /** * ä¿å­˜ æ–‡ç« å¿«ç…§ çš„æ ˆï¼Œåœ¨å›é€€çš„æ—¶å€™å›é€€çš„æ˜¯æœ€æ–°çš„çŠ¶æ€ */ private final Stack&lt;ArticleMemento&gt; ARTICLE_MEMENTO_STACK = new Stack&lt;&gt;(); /** * è·å–æ–‡ç« å¿«ç…§ * @return */ public ArticleMemento getMemento()&#123; ArticleMemento articleMemento = ARTICLE_MEMENTO_STACK.pop(); return articleMemento; &#125; /** * æŠŠæ–‡ç« ä¿å­˜ä¸ºå¿«ç…§ * @param articleMemento */ public void addMemento(ArticleMemento articleMemento)&#123; ARTICLE_MEMENTO_STACK.push(articleMemento); &#125;&#125; å¤‡å¿˜å½•æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨spring-webflowä¸­çš„ä½¿ç”¨ 123456789101112131415161718192021222324252627282930313233343536373839package org.springframework.binding.message;import java.io.Serializable;import org.springframework.context.MessageSource;/** * A message context whose internal state can be managed by an external care-taker. State management employs the GOF * Memento pattern. This context can produce a serializable memento representing its internal state at any time. A * care-taker can then use that memento at a later time to restore any context instance to a previous state. * * @author Keith Donald */public interface StateManageableMessageContext extends MessageContext &#123; /** * å­˜æ¡£ * Create a serializable memento, or token representing a snapshot of the internal state of this message context. * @return the messages memento */ Serializable createMessagesMemento(); /** * å›é€€ * Set the state of this context from the memento provided. After this call, the messages in this context will match * what is encapsulated inside the memento. Any previous state will be overridden. * @param messagesMemento the messages memento */ void restoreMessages(Serializable messagesMemento); /** * Configure the message source used to resolve messages added to this context. May be set at any time to change how * coded messages are resolved. * @param messageSource the message source * @see MessageContext#addMessage(MessageResolver) */ void setMessageSource(MessageSource messageSource);&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è´£ä»»é“¾æ¨¡å¼","slug":"design_pattern/behaviour_type/è´£ä»»é“¾æ¨¡å¼","date":"2019-10-03T16:00:00.000Z","updated":"2020-08-09T09:30:40.577Z","comments":true,"path":"posts/6208627e/","link":"","permalink":"https://gentryhuang.com/posts/6208627e/","excerpt":"","text":"å®šä¹‰è´£ä»»é“¾æ¨¡å¼åˆå«èŒè´£é“¾æ¨¡å¼ã€‚ä¸ºè¯·æ±‚åˆ›å»ºä¸€ä¸ªæ¥æ”¶æ­¤æ¬¡è¯·æ±‚çš„å¯¹è±¡çš„é“¾ï¼Œè¿™ä¸ªé“¾æ¡ç”±å¤šä¸ªå¯¹è±¡ç»„æˆã€‚ ç±»å‹è¡Œä¸ºå‹ é€‚ç”¨åœºæ™¯1ä¸€ä¸ªè¯·æ±‚çš„å¤„ç†éœ€è¦é“¾ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªåä½œå¤„ç† ä¼˜ç‚¹1231.è¯·æ±‚çš„å‘é€è€…å’Œæ¥æ”¶è€…ï¼ˆè¯·æ±‚çš„å¤„ç†è€…ï¼‰è§£è€¦ 2.è´£ä»»é“¾å¯ä»¥åŠ¨æ€ç»„åˆ3.è´£ä»»é“¾æ–¹ä¾¿æ‰©å±•å’Œæ”¶ç¼©ï¼ˆå¢åŠ æˆ–å‡å°‘å¤„ç†å¯¹è±¡ï¼‰ ç¼ºç‚¹121. è´£ä»»é“¾å¤ªé•¿æˆ–è€…å¤„ç†æ—¶é—´è¿‡é•¿ä¼šå½±å“æ€§èƒ½2. è´£ä»»é“¾æœ‰å¯èƒ½è¿‡å¤š ç›¸å…³çš„è®¾è®¡æ¨¡å¼è´£ä»»é“¾æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼ 1è´£ä»»é“¾æ¨¡å¼ä¸­å„ä¸ªå¯¹è±¡ä¸ä¼šæŒ‡å®šä¸‹ä¸€ä¸ªå¤„ç†å¯¹è±¡æ˜¯è°ï¼Œåªæœ‰åœ¨å®¢æˆ·ç«¯è®¾å®šé“¾æ¡ä¸­çš„é¡ºåºä»¥åŠå…ƒç´ ç›´åˆ°è¢«æŸä¸ªå…ƒç´ å¤„ç†æˆ–æ•´æ¡é“¾ç»“æŸã€‚çŠ¶æ€æ¨¡å¼æ˜¯è®©æ¯ä¸ªçŠ¶æ€å¯¹è±¡çŸ¥é“è‡ªå·±ä¸‹ä¸€ä¸ªå¤„ç†çš„å¯¹è±¡æ˜¯è°ï¼Œåœ¨ç¼–è¯‘æ—¶å°±è®¾å®šå¥½äº†ã€‚ ç®€å•éœ€æ±‚åœ¨æ³¨å†Œç½‘ç«™çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æä¾›ç”¨æˆ·åã€é‚®ç®±ä»¥åŠå¯†ç ï¼Œç½‘ç«™ä¼šæœ‰ä¸€ä¸ªæ ¡éªŒæµç¨‹ï¼Œåˆ†åˆ«å¯¹ç”¨æˆ·åã€é‚®ç®±ä»¥åŠå¯†ç è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä»»ä½•ä¸€ä¸ªæ­¥éª¤æ²¡æœ‰é€šè¿‡å°±ä¸èƒ½æ³¨å†Œï¼Œåªæœ‰å…¨éƒ¨æ ¡éªŒé€šè¿‡æ‰èƒ½å®Œæˆæ³¨å†Œã€‚ è´£ä»»é“¾æ¨¡å¼æ¼”ç»ƒ è´£ä»»é“¾çš„æ„å»ºæ˜¯ç”±å®¢æˆ·ç«¯å†³å®šçš„ï¼Œè´£ä»»é“¾çš„å…¥å£ä¹Ÿæ˜¯å®¢æˆ·ç«¯å†³å®šçš„ å¾…å¤„ç†çš„å¯¹è±¡ 12345678910111213141516171819202122232425262728package com.design.pattern.chain;import lombok.AllArgsConstructor;import lombok.Data;/** * User å¾…æ ¡éªŒçš„ç”¨æˆ· * * @author shunhua * @date 2019-10-04 */@Data@AllArgsConstructorpublic class User &#123; /** * ç”¨æˆ·å */ private String name; /** * é‚®ç®± */ private String email; /** * å¯†ç  */ private String password;&#125; å¤„ç†å™¨çˆ¶ç±» 1234567891011121314151617181920212223242526272829303132package com.design.pattern.chain;/** * Handler è´£ä»»é“¾æ¨¡å¼çš„æ ¸å¿ƒ * * æ³¨æ„ï¼šæ„é€ è´£ä»»é“¾æ˜¯å®¢æˆ·ç«¯çš„ä»»åŠ¡,å¹¶ä¸”å…¥å£ä¹Ÿæ˜¯å®¢æˆ·å•é€‰æ‹©çš„ * * @author shunhua * @date 2019-10-04 */public abstract class Handler &#123; /** * ä¸€ä¸ªè‡ªå·±ç±»å‹çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯å­ç±»å¯¹è±¡ */ protected Handler handler; /** * è®¾ç½®ä¸‹ä¸€ä¸ªå¤„ç†å™¨ * @param handler */ public void setNextHandler(Handler handler)&#123; this.handler = handler; &#125; /** * äº¤ç»™å­ç±»å®ç°ï¼Œç”¨æ¥æ ¡éªŒç”¨æˆ·ä¿¡æ¯æ˜¯å¦ç¬¦åˆ * @param user */ protected abstract void handle(User user);&#125; åç§°å¤„ç†å™¨ 1234567891011121314151617181920212223242526272829303132333435package com.design.pattern.chain;import lombok.extern.slf4j.Slf4j;import org.apache.commons.lang3.StringUtils;import org.springframework.util.ObjectUtils;/** * NameHandler ç”¨æˆ·åå¤„ç†å™¨ * * @author shunhua * @date 2019-10-04 */@Slf4jpublic class NameHandler extends Handler &#123; /** * æ ¡éªŒç”¨æˆ·å * @param user */ @Override protected void handle(User user) &#123; if(StringUtils.isNotBlank(user.getName()))&#123; log.info(\"ç”¨æˆ·åç¬¦åˆè¦æ±‚\"); // å¦‚æœæœ‰ä¸‹ä¸€ä¸ªæ ¡éªŒå™¨å°±ç»§ç»­æ‰§è¡Œï¼Œæ³¨æ„è¿™ä¸ªé“¾çš„é¡ºåºæ˜¯ç”±å®¢æˆ·ç«¯å†³å®šçš„ if(!ObjectUtils.isEmpty(super.handler))&#123; super.handler.handle(user); return; &#125;else &#123; log.info(\"å®Œæˆæ³¨å†Œ\"); &#125; return; &#125; log.info(\"ç”¨æˆ·åæ ¡éªŒä¸é€šè¿‡ï¼Œç»“æŸæ ¡éªŒ\"); &#125;&#125; é‚®ç®±å¤„ç†å™¨ 123456789101112131415161718192021222324252627282930package com.design.pattern.chain;import lombok.extern.slf4j.Slf4j;import org.apache.commons.lang3.StringUtils;import org.springframework.util.ObjectUtils;/** * EmailHandler é‚®ç®±æ ¡éªŒå™¨ * * @author shunhua * @date 2019-10-04 */@Slf4jpublic class EmailHandler extends Handler&#123; @Override protected void handle(User user) &#123; if(StringUtils.isNotBlank(user.getEmail()))&#123; log.info(\"é‚®ç®±ç¬¦åˆè¦æ±‚\"); if(!ObjectUtils.isEmpty(super.handler))&#123; super.handler.handle(user); return; &#125;else &#123; log.info(\"å®Œæˆæ³¨å†Œ\"); &#125; return; &#125; log.info(\"é‚®ç®±éªŒè¯ä¸é€šè¿‡ï¼ŒéªŒè¯ç»“æŸ\"); &#125;&#125; å¯†ç å¤„ç†å™¨ 123456789101112131415161718192021222324252627282930package com.design.pattern.chain;import lombok.extern.slf4j.Slf4j;import org.apache.commons.lang3.StringUtils;import org.springframework.util.ObjectUtils;/** * PasswordHandler å¯†ç éªŒè¯å™¨ * * @author shunhua * @date 2019-10-04 */@Slf4jpublic class PasswordHandler extends Handler &#123; @Override protected void handle(User user) &#123; if(StringUtils.isNotBlank(user.getPassword()) &amp;&amp; user.getPassword().length() &gt;5)&#123; log.info(\"å¯†ç ç¬¦åˆè¦æ±‚\"); if(!ObjectUtils.isEmpty(super.handler))&#123; super.handler.handle(user); return; &#125;else &#123; log.info(\"å®Œæˆæ³¨å†Œ\"); &#125; return; &#125; log.info(\"å¯†ç éªŒè¯ä¸é€šè¿‡ï¼ŒéªŒè¯ç»“æŸ\"); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425262728293031323334353637package com.design.pattern.chain;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-04 */public class Client &#123; @Test public void test()&#123; // åˆ›å»ºå¾…éªŒè¯çš„ç”¨æˆ· User user = new User(\"shunhua\",\"gentryhuang.xw@gmail.com\",\"123456\"); // å§“åéªŒè¯å™¨ NameHandler nameHandler = new NameHandler(); // é‚®ç®±éªŒè¯å™¨ EmailHandler emailHandler = new EmailHandler(); // å¯†ç éªŒè¯å™¨ PasswordHandler passwordHandler = new PasswordHandler(); /** * æ³¨æ„ï¼šæ„é€ è´£ä»»é“¾æ˜¯å®¢æˆ·ç«¯å†³å®šçš„ * * æ„å»ºè´£ä»»é“¾ : NameHandler -&gt; EmailHandler -&gt; PasswordHandler */ nameHandler.setNextHandler(emailHandler); emailHandler.setNextHandler(passwordHandler); /** * å¤„ç†è¯·æ±‚å…¥å£ */ nameHandler.handle(user); &#125;&#125; è´£ä»»é“¾åœ¨æºç ä¸­çš„ä½¿ç”¨è¿‡æ»¤å™¨-Filter 123456789101112131415161718192021222324252627282930313233// ä»¥OncePerRequestFilterä¸ºä¾‹public abstract class OncePerRequestFilter extends GenericFilterBean &#123; public static final String ALREADY_FILTERED_SUFFIX = \".FILTERED\"; public OncePerRequestFilter() &#123; &#125; public final void doFilter(ServletRequest request, ServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; if (request instanceof HttpServletRequest &amp;&amp; response instanceof HttpServletResponse) &#123; HttpServletRequest httpRequest = (HttpServletRequest)request; HttpServletResponse httpResponse = (HttpServletResponse)response; String alreadyFilteredAttributeName = this.getAlreadyFilteredAttributeName(); boolean hasAlreadyFilteredAttribute = request.getAttribute(alreadyFilteredAttributeName) != null; if (!hasAlreadyFilteredAttribute &amp;&amp; !this.skipDispatch(httpRequest) &amp;&amp; !this.shouldNotFilter(httpRequest)) &#123; request.setAttribute(alreadyFilteredAttributeName, Boolean.TRUE); try &#123; this.doFilterInternal(httpRequest, httpResponse, filterChain); &#125; finally &#123; request.removeAttribute(alreadyFilteredAttributeName); &#125; &#125; else &#123; // å¾…ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨å¤„ç† filterChain.doFilter(request, response); &#125; &#125; else &#123; throw new ServletException(\"OncePerRequestFilter just supports HTTP requests\"); &#125; &#125; // ... &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"ä»£ç†æ¨¡å¼","slug":"design_pattern/structure_type/ä»£ç†æ¨¡å¼","date":"2019-10-02T16:00:00.000Z","updated":"2020-08-09T09:34:32.145Z","comments":true,"path":"posts/7b510e10/","link":"","permalink":"https://gentryhuang.com/posts/7b510e10/","excerpt":"","text":"å®šä¹‰ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ç§ä»£ç†ï¼Œä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†å¯¹è±¡åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡ä¹‹é—´èµ·åˆ°ä¸­ä»‹çš„ä½œç”¨ã€‚ ä¸¾ä¾‹ï¼šç§Ÿæˆ¿å­ï¼Œç›®æ ‡å¯¹è±¡ä»£è¡¨æˆ¿ä¸œï¼Œå®¢æˆ·ç«¯ä»£è¡¨ç”¨æˆ·ï¼Œæˆ¿å±‹ä¸­ä»‹ä»£è¡¨ä¸­ä»‹ã€‚æˆ¿å±‹ä¸­ä»‹èµ·åˆ°ä»£ç†çš„ä½œç”¨ï¼Œç­¾åˆåŒå’Œç¼´çº³æ°´ç”µè´¹ç›´æ¥æ‰¾ä¸­ä»‹å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦å’Œæˆ¿ä¸œç›´æ¥æ¥è§¦ï¼Œå³ä¸­ä»‹ä»£ç†æˆ¿ä¸œã€‚ ç±»å‹ç»“æ„å‹ ä½¿ç”¨åœºæ™¯12â—† ä¿æŠ¤ç›®æ ‡å¯¹è±¡â—† å¢å¼ºç›®æ ‡å¯¹è±¡ ä¼˜ç‚¹1234â—† ä»£ç†æ¨¡å¼èƒ½å°†ä»£ç†å¯¹è±¡ä¸çœŸå®è¢«è°ƒç”¨çš„ç›®æ ‡å¯¹è±¡åˆ†ç¦»â—† ä¸€å®šç¨‹åº¦ä¸Šé™ä½äº†ç³»ç»Ÿçš„è€¦åˆåº¦ï¼Œæ‰©å±•æ€§å¥½â—† ä¿æŠ¤ç›®æ ‡å¯¹è±¡â—† åœ¨ä¸ä¿®æ”¹ç›®æ ‡ç±»çš„å‰æä¸‹ï¼Œå¢å¼ºç›®æ ‡å¯¹è±¡ ç¼ºç‚¹123â—† ä»£ç†æ¨¡å¼ä¼šé€ æˆç³»ç»Ÿè®¾è®¡ä¸­ç±»çš„æ•°ç›®å¢åŠ â—† åœ¨å®¢æˆ·ç«¯å’Œç›®æ ‡å¯¹è±¡å¢åŠ ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œä¼šé€ æˆè¯·æ±‚å¤„ç†é€Ÿåº¦å˜æ…¢â—† å¢åŠ ç³»ç»Ÿçš„å¤æ‚åº¦ æ‰©å±• æ ¹æ®ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡ä»£ç†å…³ç³»çš„åˆ›å»ºæ—¶æœºçš„ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºé™æ€ä»£ç†å’ŒåŠ¨æ€ä»£ç†ã€‚åŠ¨æ€ä»£ç†åˆæ ¹æ®å®ç°æŠ€æœ¯çš„ä¸åŒåˆ†ä¸ºJDKçš„ProxyåŠ¨æ€ä»£ç†å’ŒCGLIBåŠ¨æ€ä»£ç†ã€‚ é™æ€ä»£ç† 1é™æ€ä»£ç†å°±æ˜¯åœ¨ä»£ç ä¸­æŒ‡å®šæ˜¾å¼çš„ä»£ç†,åœ¨ç¼–è¯‘ä¹‹å‰ä»£ç†å…³ç³»å°±å·²ç»ç¡®å®šäº†ã€‚åœ¨ä»£ç†ç±»ä¸­å¯¹åŒåçš„æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œç”¨æˆ·é€šè¿‡å¯¹ä»£ç†ç±»çš„è¢«åŒ…è£…è¿‡çš„æ–¹æ³•æ¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„ä¸šåŠ¡æ–¹æ³•ï¼ŒåŒæ—¶å¯¹ç›®æ ‡å¯¹è±¡çš„ä¸šåŠ¡æ–¹æ³•è¿›è¡Œå¢å¼ºã€‚ JDKåŠ¨æ€ä»£ç† 1jdkçš„åŠ¨æ€ä»£ç†æ˜¯é€šè¿‡æ¥å£ä¸­çš„æ–¹æ³•åå¯¹åœ¨åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»ä¸­ï¼Œè°ƒç”¨ä¸šåŠ¡å®ç°ç±»çš„åŒåæ–¹æ³•ã€‚æ³¨æ„:å¿…é¡»æ˜¯æ¥å£,å› ä¸ºjdkåº•å±‚å…ˆåˆ›å»ºä¸€ä¸ªä»£ç†ç±»ï¼Œç„¶åå†åˆ›å»ºä»£ç†ç±»çš„å®ä¾‹ï¼Œå®ƒçš„ç±»å‹æ˜¯æ¥å£ç±»å‹ï¼Œä¸æ˜¯ç›®æ ‡ç±»çš„ç±»å‹ã€‚ CGLIBä»£ç† 1cglibæ˜¯é€šè¿‡ç»§æ‰¿æ¥å®ç°çš„ï¼Œç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ä¸šåŠ¡ç±»çš„å­ç±»ï¼Œé€šè¿‡é‡å†™ä¸šåŠ¡æ–¹æ³•æ‰§è¡Œä»£ç†ã€‚ä½¿ç”¨CGLibè¿›è¡Œä»£ç†æ—¶ä¸€å®šè¦æ³¨æ„finalä¿®æ”¹çš„ç±»å’Œæ–¹æ³•ä»¥åŠæ˜¯å¦æœ‰æ— å‚æ„é€ å™¨ã€‚CGLibåº•å±‚ä½¿ç”¨asmå­—èŠ‚ç ç”Ÿæˆçš„ã€‚ ä»£ç†æ¨¡å¼ç›¸å…³çš„è®¾è®¡æ¨¡å¼ä»£ç†æ¨¡å¼å’Œè£…é¥°è€…æ¨¡å¼ 1ç›®çš„ä¸åŒï¼Œè£…é¥°è€…æ¨¡å¼æ˜¯ä¸ºå¯¹è±¡åŠ ä¸Šè¡Œä¸ºï¼Œè€Œä»£ç†æ¨¡å¼æ˜¯æ§åˆ¶è®¿é—®ï¼Œä»£ç†æ¨¡å¼æ›´åŠ å…³æ³¨é€šè¿‡æ§åˆ¶ä»£ç†äººçš„æ–¹å¼æ¥å¢å¼ºç›®æ ‡å¯¹è±¡ã€‚å¢å¼ºå¯¹è±¡çš„æ–¹å¼ä¸€èˆ¬æ˜¯å¢å¼ºå¯¹è±¡çš„æŸäº›è¡Œä¸ºã€‚ ä»£ç†æ¨¡å¼å’Œé€‚é…å™¨æ¨¡å¼ 1é€‚é…å™¨æ¨¡å¼ä¸»è¦æ”¹å˜æ‰€è¦è€ƒè™‘å¯¹è±¡çš„æ¥å£ï¼Œä»£ç†æ¨¡å¼ä¸å¯ä»¥æ”¹å˜æ‰€ä»£ç†ç±»çš„æ¥å£ã€‚ ä»£ç†æ¨¡å¼æ¼”ç»ƒé™æ€ä»£ç† é™æ€ä»£ç†çš„ä»£ç†ç±»æ˜¯æ‰‹åŠ¨ç¼–å†™çš„ï¼Œä»£ç†å…³ç³»åœ¨ç¼–è¯‘ä¹‹å‰å°±ç¡®ç«‹äº†ã€‚é€šå¸¸ç›®æ ‡å¯¹è±¡åœ¨ä»£ç†ç±»ä¸­åˆ›å»ºã€‚ ç›®æ ‡ç±»æ¥å£ 1234567891011121314package com.design.pattern.proxy.staticproxy;/** * IRentalHouseService * * @author shunhua * @date 2019-10-03 */public interface IRentalHouseService &#123; /** * ç§Ÿæˆ¿æ–¹æ³• */ void rent();&#125; ç›®æ ‡ç±» 123456789101112131415161718192021222324package com.design.pattern.proxy.jdkproxy;import com.design.pattern.proxy.staticproxy.IRentalHouseService;import lombok.extern.slf4j.Slf4j;/** *RentalHouseServiceImpl * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class RentalHouseService implements IRentalHouseService &#123; /** * å‡ºç§Ÿæˆ¿å­ï¼Œç›®æ ‡æ–¹æ³• * @return */ @Override public void rent()&#123; log.info(\"1800/æœˆï¼Œ2å®¤1å…1å¨1å«ï¼\"); &#125;&#125; ä»£ç†ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.design.pattern.proxy.staticproxy;import lombok.extern.slf4j.Slf4j;/** * RentalHouseServiceProxy ä»£ç†ç±» * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class RentalHouseServiceProxy &#123; /** * ä»£ç†å¯¹è±¡éœ€è¦ç›®æ ‡å¯¹è±¡ */ private RentalHouseService rentalHouseService; /** * æ„é€ æ–¹æ³• */ public RentalHouseServiceProxy()&#123; rentalHouseService = new RentalHouseService(); &#125; /** * ä»£ç†æ–¹æ³• */ public void rent()&#123; dialNumber(); rentalHouseService.rent(); signContract(); &#125; /** * éœ€è¦æˆ¿ç§Ÿè¯·è”ç³»æˆ‘ï¼Œç›®æ ‡æ–¹æ³•çš„å‰ç½®æ–¹æ³• */ private void dialNumber() &#123; log.info(\"éœ€è¦ç§Ÿæˆ¿è¯·è‡´ç”µï¼š123456\"); &#125; /** * ç­¾åˆåŒï¼Œç›®æ ‡æ–¹æ³•çš„åç½®æ–¹æ³• */ private void signContract() &#123; log.info(\"æˆ¿å­è¿˜æ»¡æ„å°±å¯ä»¥ç­¾åˆåŒäº†ï¼\"); &#125;&#125; åº”ç”¨å±‚ 1234567891011121314151617181920package com.design.pattern.proxy.staticproxy;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-03 */public class Client &#123; @Test public void test()&#123; // ç§Ÿæˆ¿ç›´æ¥æ‰¾ä»£ç† RentalHouseServiceProxy proxy = new RentalHouseServiceProxy(); proxy.rent(); &#125;&#125; jdkåŠ¨æ€ä»£ç† jdkåŠ¨æ€ä»£ç†ç”¨äºç›®æ ‡ç±»æœ‰æ¥å£çš„æƒ…å†µã€‚ä»£ç†ç±»ä¸æ˜¯æ‰‹åŠ¨åˆ›å»ºï¼Œè€Œæ˜¯ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆã€‚æœ‰æ—¶ç›®æ ‡å¯¹è±¡éœ€è¦åœ¨å®¢æˆ·ç«¯ä¸­åˆ›å»ºï¼Œè¿™æ ·æƒ…å†µä¸‹ä¸èƒ½å¤Ÿä¿æŠ¤å’Œéšè—ç›®æ ‡å¯¹è±¡ï¼Œåªæ˜¯å¢å¼ºäº†ç›®æ ‡æ–¹æ³•åŠŸèƒ½ã€‚ä»£ç†ç±»çš„åç§°ç”±ä¸‰éƒ¨åˆ†æ„æˆï¼š$ + Proxy + æ•°å­—ï¼Œæ•°å­—è¡¨ç¤ºå½“å‰JDKçš„Proxyæ‰€ç”Ÿæˆçš„ä»£ç†ç±»çš„ç´¢å¼•ï¼Œç´¢å¼•ä»0å¼€å§‹è®¡æ•°ã€‚ ç›®æ ‡ç±»æ¥å£ 1234567891011121314package com.design.pattern.proxy.jdkproxy;/** * IRentalHouseService * * @author shunhua * @date 2019-10-03 */public interface IRentalHouseService &#123; /** * ç§Ÿæˆ¿æ–¹æ³• */ void rent();&#125; ç›®æ ‡ç±» 123456789101112131415161718192021222324package com.design.pattern.proxy.jdkproxy;import com.design.pattern.proxy.staticproxy.IRentalHouseService;import lombok.extern.slf4j.Slf4j;/** * RentalHouseServiceImpl ç›®æ ‡ç±» * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class RentalHouseServiceImpl implements IRentalHouseService &#123; /** * å‡ºç§Ÿæˆ¿å­ï¼Œç›®æ ‡æ–¹æ³• * @return */ @Override public void rent()&#123; log.info(\"1800/æœˆï¼Œ2å®¤1å…1å¨1å«ï¼\"); &#125;&#125; InvocationHandlerå®ç° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758package com.design.pattern.proxy.jdkproxy;import lombok.extern.slf4j.Slf4j;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;/** * RentalHouseServiceProxy * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class RentalHouseServiceProxy implements InvocationHandler &#123; private IRentalHouseService target; public RentalHouseServiceProxy(IRentalHouseService target) &#123; this.target = target; &#125; /** * å½“æ‰§è¡Œä»£ç†å¯¹è±¡çš„ä»£ç†æ–¹æ³•æ—¶ï¼Œä»£ç†æ–¹æ³•ä¼šè°ƒç”¨è¯¥invoke() * * @param proxy ä»£ç†å¯¹è±¡ * @param method ç›®æ ‡æ–¹æ³• * @param args ç›®æ ‡æ–¹æ³•çš„å‚æ•°åˆ—è¡¨ * @return * @throws Throwable */ @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; // è°ƒç”¨ç›®æ ‡æ–¹æ³•å‰ dialNumber(); // æ‰§è¡Œç›®æ ‡æ–¹æ³• Object result = method.invoke(target, args); // è°ƒç”¨ç›®æ ‡æ–¹æ³•å signContract(); return result; &#125; /** * éœ€è¦æˆ¿ç§Ÿè¯·è”ç³»æˆ‘ï¼Œç›®æ ‡æ–¹æ³•çš„å‰ç½®æ–¹æ³• */ private void dialNumber() &#123; log.info(\"éœ€è¦ç§Ÿæˆ¿è¯·è‡´ç”µï¼š123456\"); &#125; /** * ç­¾åˆåŒï¼Œç›®æ ‡æ–¹æ³•çš„åç½®æ–¹æ³• */ private void signContract() &#123; log.info(\"æˆ¿å­è¿˜æ»¡æ„å°±å¯ä»¥ç­¾åˆåŒäº†ï¼\"); &#125;&#125; å®¢æˆ·ç«¯ 123456789101112131415161718192021222324252627282930313233package com.design.pattern.proxy.jdkproxy;import org.junit.Test;import java.lang.reflect.Proxy;/** * Client * * @author shunhua * @date 2019-10-04 */public class Client &#123; @Test public void test()&#123; // åˆ›å»ºç›®æ ‡å¯¹è±¡ IRentalHouseService target = new RentalHouseServiceImpl(); // åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆæ¥å£å®ç°ç±»çš„ä»£ç†å¯¹è±¡ï¼‰ IRentalHouseService proxy = (IRentalHouseService) Proxy.newProxyInstance( target.getClass().getClassLoader(), target.getClass().getInterfaces(), new RentalHouseServiceProxy(target) ); /** * è°ƒç”¨ä»£ç†å¯¹è±¡çš„ä»£ç†æ–¹æ³•,æ³¨æ„å½“è°ƒç”¨ä»£ç†å¯¹è±¡çš„ä»£ç†æ–¹æ³•æ—¶ï¼ŒInvocationHandlerçš„invokeæ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ */ proxy.rent(); &#125;&#125; CGLIBåŠ¨æ€ä»£ç† CGLIBçš„åº•å±‚æ˜¯é€šè¿‡ä½¿ç”¨å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMæ¥è½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ï¼Œä»£ç†çš„ç›®æ ‡ç±»å¯ä»¥æ²¡æœ‰å®ç°æ¥å£ï¼Œä¹Ÿå¯ä»¥æœ‰å®ç°çš„æ¥å£ã€‚CGLIBä½¿ç”¨å­ç±»æ‰©å±•çˆ¶ç±»çš„æ–¹å¼æ¥ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œå³CGLIBä¼šåŠ¨æ€ç”Ÿæˆç›®æ ‡ç±»çš„å­ç±»ä½œä¸ºä»£ç†ç±»ï¼Œå¹¶åˆ›å»ºå…¶å¯¹è±¡å³ä»£ç†å¯¹è±¡ã€‚ ç›®æ ‡ç±» 123456789101112131415161718192021222324package com.design.pattern.proxy.cglibproxy;import com.design.pattern.proxy.staticproxy.IRentalHouseService;import lombok.extern.slf4j.Slf4j;/** * RentalHouseServiceImpl ç›®æ ‡ç±» * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class RentalHouseServiceImpl implements IRentalHouseService &#123; /** * å‡ºç§Ÿæˆ¿å­ï¼Œç›®æ ‡æ–¹æ³• * @return */ @Override public void rent()&#123; log.info(\"1800/æœˆï¼Œ2å®¤1å…1å¨1å«ï¼\"); &#125;&#125; MethodInterceptorçš„å®ç° 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package com.design.pattern.proxy.cglibproxy;import lombok.extern.slf4j.Slf4j;import net.sf.cglib.proxy.MethodInterceptor;import net.sf.cglib.proxy.MethodProxy;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;/** * RentalHouseServiceProxy * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class RentalHouseServiceProxy implements MethodInterceptor &#123; /** * * @param o ä»£ç†å¯¹è±¡ * @param method ç›®æ ‡æ–¹æ³• * @param objects ç›®æ ‡æ–¹æ³•å‚æ•°åˆ—è¡¨ * @param methodProxy ç›®æ ‡æ–¹æ³•çš„ä»£ç†å¯¹è±¡ * @return * @throws Throwable */ @Override public Object intercept(Object o, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; return null; &#125; /** * éœ€è¦æˆ¿ç§Ÿè¯·è”ç³»æˆ‘ï¼Œç›®æ ‡æ–¹æ³•çš„å‰ç½®æ–¹æ³• */ private void dialNumber() &#123; log.info(\"éœ€è¦ç§Ÿæˆ¿è¯·è‡´ç”µï¼š123456\"); &#125; /** * ç­¾åˆåŒï¼Œç›®æ ‡æ–¹æ³•çš„åç½®æ–¹æ³• */ private void signContract() &#123; log.info(\"æˆ¿å­è¿˜æ»¡æ„å°±å¯ä»¥ç­¾åˆåŒäº†ï¼\"); &#125;&#125; ç”Ÿæˆä»£ç†ç±»çš„é€»è¾‘ç±» 1234567891011121314151617181920212223242526272829303132333435package com.design.pattern.proxy.cglibproxy;import net.sf.cglib.proxy.Enhancer;import net.sf.cglib.proxy.MethodInterceptor;/** * CglibProxy æ‰‹åŠ¨åˆ›å»º * * @author shunhua * @date 2019-10-04 */public class CglibProxy &#123; /** * åˆ›å»ºCglibçš„ä»£ç†å¯¹è±¡ * * @param targetClass ç›®æ ‡ç±» * @param callBack å§”æ‰˜ç±»å¯¹è±¡ * @return */ public static IRentalHouseService createCglibProxy(Class targetClass, MethodInterceptor callBack)&#123; // åˆ›å»ºå¢å¼ºå…¶ Enhancer enhancer = new Enhancer(); // æŒ‡å®šç›®æ ‡ç±» enhancer.setSuperclass(targetClass); // è®¾ç½®å›è°ƒæ¥å£ enhancer.setCallback(callBack); // åˆ›å»ºå¹¶è¿”å›ä»£ç†å¯¹è±¡ï¼Œå³ç›®æ ‡ç±»çš„å­ç±»å¯¹è±¡ return (IRentalHouseService) enhancer.create(); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425262728293031package com.design.pattern.proxy.cglibproxy;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-04 */public class Client &#123; @Test public void test() &#123; // åˆ›å»ºç›®æ ‡å¯¹è±¡ IRentalHouseService target = new RentalHouseServiceImpl(); // åˆ›å»ºå§”æ‰˜å¯¹è±¡ RentalHouseServiceProxy rentalHouseServiceProxy = new RentalHouseServiceProxy(); // åˆ›å»ºä»£ç†å¯¹è±¡ï¼ˆæ¥å£å®ç°ç±»çš„ä»£ç†å¯¹è±¡ï¼‰ IRentalHouseService cglibProxy = CglibProxy.createCglibProxy(target.getClass(), rentalHouseServiceProxy); /** * è°ƒç”¨ä»£ç†å¯¹è±¡çš„ä»£ç†æ–¹æ³•,æ³¨æ„å½“è°ƒç”¨ä»£ç†å¯¹è±¡çš„ä»£ç†æ–¹æ³•æ—¶ï¼ŒInvocationHandlerçš„invokeæ–¹æ³•ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ */ cglibProxy.rent(); &#125;&#125; ä»£ç†æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨jdkä¸­çš„åº”ç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490package java.lang.reflect;import java.lang.ref.WeakReference;import java.security.AccessController;import java.security.PrivilegedAction;import java.util.Arrays;import java.util.IdentityHashMap;import java.util.Map;import java.util.Objects;import java.util.concurrent.atomic.AtomicLong;import java.util.function.BiFunction;import sun.misc.ProxyGenerator;import sun.misc.VM;import sun.reflect.CallerSensitive;import sun.reflect.Reflection;import sun.reflect.misc.ReflectUtil;import sun.security.util.SecurityConstants;public class Proxy implements java.io.Serializable &#123; private static final long serialVersionUID = -2222568056686623797L; /** parameter types of a proxy class constructor */ private static final Class&lt;?&gt;[] constructorParams = &#123; InvocationHandler.class &#125;; /** * a cache of proxy classes */ private static final WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt; proxyClassCache = new WeakCache&lt;&gt;(new KeyFactory(), new ProxyClassFactory()); /** * the invocation handler for this proxy instance. * @serial */ protected InvocationHandler h; /** * Prohibits instantiation. */ private Proxy() &#123; &#125; /** * Constructs a new &#123;@code Proxy&#125; instance from a subclass * (typically, a dynamic proxy class) with the specified value * for its invocation handler. * * @param h the invocation handler for this proxy instance * * @throws NullPointerException if the given invocation handler, &#123;@code h&#125;, * is &#123;@code null&#125;. */ protected Proxy(InvocationHandler h) &#123; Objects.requireNonNull(h); this.h = h; &#125; @CallerSensitive public static Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;... interfaces) throws IllegalArgumentException &#123; final Class&lt;?&gt;[] intfs = interfaces.clone(); final SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; checkProxyAccess(Reflection.getCallerClass(), loader, intfs); &#125; return getProxyClass0(loader, intfs); &#125; /* * Check permissions required to create a Proxy class. * * To define a proxy class, it performs the access checks as in * Class.forName (VM will invoke ClassLoader.checkPackageAccess): * 1. \"getClassLoader\" permission check if loader == null * 2. checkPackageAccess on the interfaces it implements * * To get a constructor and new instance of a proxy class, it performs * the package access check on the interfaces it implements * as in Class.getConstructor. * * If an interface is non-public, the proxy class must be defined by * the defining loader of the interface. If the caller's class loader * is not the same as the defining loader of the interface, the VM * will throw IllegalAccessError when the generated proxy class is * being defined via the defineClass0 method. */ private static void checkProxyAccess(Class&lt;?&gt; caller, ClassLoader loader, Class&lt;?&gt;... interfaces) &#123; SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; ClassLoader ccl = caller.getClassLoader(); if (VM.isSystemDomainLoader(loader) &amp;&amp; !VM.isSystemDomainLoader(ccl)) &#123; sm.checkPermission(SecurityConstants.GET_CLASSLOADER_PERMISSION); &#125; ReflectUtil.checkProxyPackageAccess(ccl, interfaces); &#125; &#125; /** * ç”Ÿæˆä»£ç†ç±»çš„æ ¸å¿ƒæ–¹æ³• */ private static Class&lt;?&gt; getProxyClass0(ClassLoader loader, Class&lt;?&gt;... interfaces) &#123; if (interfaces.length &gt; 65535) &#123; throw new IllegalArgumentException(\"interface limit exceeded\"); &#125; // å¦‚æœç¼“å­˜ä¸­æœ‰å¯¹åº”çš„ä»£ç†ç±»å°±ç›´æ¥è·å–ï¼Œæ²¡æœ‰å°±åˆ›å»ºç„¶åæ”¾å…¥ç¼“å­˜ return proxyClassCache.get(loader, interfaces); &#125; /* * a key used for proxy class with 0 implemented interfaces */ private static final Object key0 = new Object(); /* * Key1 and Key2 are optimized for the common use of dynamic proxies * that implement 1 or 2 interfaces. */ /* * a key used for proxy class with 1 implemented interface */ private static final class Key1 extends WeakReference&lt;Class&lt;?&gt;&gt; &#123; private final int hash; Key1(Class&lt;?&gt; intf) &#123; super(intf); this.hash = intf.hashCode(); &#125; @Override public int hashCode() &#123; return hash; &#125; @Override public boolean equals(Object obj) &#123; Class&lt;?&gt; intf; return this == obj || obj != null &amp;&amp; obj.getClass() == Key1.class &amp;&amp; (intf = get()) != null &amp;&amp; intf == ((Key1) obj).get(); &#125; &#125; /* * a key used for proxy class with 2 implemented interfaces */ private static final class Key2 extends WeakReference&lt;Class&lt;?&gt;&gt; &#123; private final int hash; private final WeakReference&lt;Class&lt;?&gt;&gt; ref2; Key2(Class&lt;?&gt; intf1, Class&lt;?&gt; intf2) &#123; super(intf1); hash = 31 * intf1.hashCode() + intf2.hashCode(); ref2 = new WeakReference&lt;Class&lt;?&gt;&gt;(intf2); &#125; @Override public int hashCode() &#123; return hash; &#125; @Override public boolean equals(Object obj) &#123; Class&lt;?&gt; intf1, intf2; return this == obj || obj != null &amp;&amp; obj.getClass() == Key2.class &amp;&amp; (intf1 = get()) != null &amp;&amp; intf1 == ((Key2) obj).get() &amp;&amp; (intf2 = ref2.get()) != null &amp;&amp; intf2 == ((Key2) obj).ref2.get(); &#125; &#125; /* * a key used for proxy class with any number of implemented interfaces * (used here for 3 or more only) */ private static final class KeyX &#123; private final int hash; private final WeakReference&lt;Class&lt;?&gt;&gt;[] refs; @SuppressWarnings(\"unchecked\") KeyX(Class&lt;?&gt;[] interfaces) &#123; hash = Arrays.hashCode(interfaces); refs = (WeakReference&lt;Class&lt;?&gt;&gt;[])new WeakReference&lt;?&gt;[interfaces.length]; for (int i = 0; i &lt; interfaces.length; i++) &#123; refs[i] = new WeakReference&lt;&gt;(interfaces[i]); &#125; &#125; @Override public int hashCode() &#123; return hash; &#125; @Override public boolean equals(Object obj) &#123; return this == obj || obj != null &amp;&amp; obj.getClass() == KeyX.class &amp;&amp; equals(refs, ((KeyX) obj).refs); &#125; private static boolean equals(WeakReference&lt;Class&lt;?&gt;&gt;[] refs1, WeakReference&lt;Class&lt;?&gt;&gt;[] refs2) &#123; if (refs1.length != refs2.length) &#123; return false; &#125; for (int i = 0; i &lt; refs1.length; i++) &#123; Class&lt;?&gt; intf = refs1[i].get(); if (intf == null || intf != refs2[i].get()) &#123; return false; &#125; &#125; return true; &#125; &#125; /** * A function that maps an array of interfaces to an optimal key where * Class objects representing interfaces are weakly referenced. */ private static final class KeyFactory implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Object&gt; &#123; @Override public Object apply(ClassLoader classLoader, Class&lt;?&gt;[] interfaces) &#123; switch (interfaces.length) &#123; case 1: return new Key1(interfaces[0]); // the most frequent case 2: return new Key2(interfaces[0], interfaces[1]); case 0: return key0; default: return new KeyX(interfaces); &#125; &#125; &#125; /** * A factory function that generates, defines and returns the proxy class given * the ClassLoader and array of interfaces. */ private static final class ProxyClassFactory implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt; &#123; // prefix for all proxy class names private static final String proxyClassNamePrefix = \"$Proxy\"; // next number to use for generation of unique proxy class names private static final AtomicLong nextUniqueNumber = new AtomicLong(); @Override public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123; Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = new IdentityHashMap&lt;&gt;(interfaces.length); for (Class&lt;?&gt; intf : interfaces) &#123; /* * Verify that the class loader resolves the name of this * interface to the same Class object. */ Class&lt;?&gt; interfaceClass = null; try &#123; interfaceClass = Class.forName(intf.getName(), false, loader); &#125; catch (ClassNotFoundException e) &#123; &#125; if (interfaceClass != intf) &#123; throw new IllegalArgumentException( intf + \" is not visible from class loader\"); &#125; /* * Verify that the Class object actually represents an * interface. */ if (!interfaceClass.isInterface()) &#123; throw new IllegalArgumentException( interfaceClass.getName() + \" is not an interface\"); &#125; /* * Verify that this interface is not a duplicate. */ if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123; throw new IllegalArgumentException( \"repeated interface: \" + interfaceClass.getName()); &#125; &#125; String proxyPkg = null; // package to define proxy class in int accessFlags = Modifier.PUBLIC | Modifier.FINAL; /* * Record the package of a non-public proxy interface so that the * proxy class will be defined in the same package. Verify that * all non-public proxy interfaces are in the same package. */ for (Class&lt;?&gt; intf : interfaces) &#123; int flags = intf.getModifiers(); if (!Modifier.isPublic(flags)) &#123; accessFlags = Modifier.FINAL; String name = intf.getName(); int n = name.lastIndexOf('.'); String pkg = ((n == -1) ? \"\" : name.substring(0, n + 1)); if (proxyPkg == null) &#123; proxyPkg = pkg; &#125; else if (!pkg.equals(proxyPkg)) &#123; throw new IllegalArgumentException( \"non-public interfaces from different packages\"); &#125; &#125; &#125; if (proxyPkg == null) &#123; // if no non-public proxy interfaces, use com.sun.proxy package proxyPkg = ReflectUtil.PROXY_PACKAGE + \".\"; &#125; /* * Choose a name for the proxy class to generate. */ long num = nextUniqueNumber.getAndIncrement(); String proxyName = proxyPkg + proxyClassNamePrefix + num; /* * Generate the specified proxy class. */ byte[] proxyClassFile = ProxyGenerator.generateProxyClass( proxyName, interfaces, accessFlags); try &#123; return defineClass0(loader, proxyName, proxyClassFile, 0, proxyClassFile.length); &#125; catch (ClassFormatError e) &#123; /* * A ClassFormatError here means that (barring bugs in the * proxy class generation code) there was some other * invalid aspect of the arguments supplied to the proxy * class creation (such as virtual machine limitations * exceeded). */ throw new IllegalArgumentException(e.toString()); &#125; &#125; &#125; // è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼ˆç›®æ ‡å¯¹è±¡ï¼‰ @CallerSensitive public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) throws IllegalArgumentException &#123; Objects.requireNonNull(h); final Class&lt;?&gt;[] intfs = interfaces.clone(); final SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; checkProxyAccess(Reflection.getCallerClass(), loader, intfs); &#125; /* * ç”Ÿæˆä»£ç†ç±»çš„æ ¸å¿ƒæ–¹æ³• */ Class&lt;?&gt; cl = getProxyClass0(loader, intfs); /* * Invoke its constructor with the designated invocation handler. */ try &#123; if (sm != null) &#123; checkNewProxyPermission(Reflection.getCallerClass(), cl); &#125; final Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams); final InvocationHandler ih = h; if (!Modifier.isPublic(cl.getModifiers())) &#123; AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; cons.setAccessible(true); return null; &#125; &#125;); &#125; return cons.newInstance(new Object[]&#123;h&#125;); &#125; catch (IllegalAccessException|InstantiationException e) &#123; throw new InternalError(e.toString(), e); &#125; catch (InvocationTargetException e) &#123; Throwable t = e.getCause(); if (t instanceof RuntimeException) &#123; throw (RuntimeException) t; &#125; else &#123; throw new InternalError(t.toString(), t); &#125; &#125; catch (NoSuchMethodException e) &#123; throw new InternalError(e.toString(), e); &#125; &#125; private static void checkNewProxyPermission(Class&lt;?&gt; caller, Class&lt;?&gt; proxyClass) &#123; SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; if (ReflectUtil.isNonPublicProxyClass(proxyClass)) &#123; ClassLoader ccl = caller.getClassLoader(); ClassLoader pcl = proxyClass.getClassLoader(); // do permission check if the caller is in a different runtime package // of the proxy class int n = proxyClass.getName().lastIndexOf('.'); String pkg = (n == -1) ? \"\" : proxyClass.getName().substring(0, n); n = caller.getName().lastIndexOf('.'); String callerPkg = (n == -1) ? \"\" : caller.getName().substring(0, n); if (pcl != ccl || !pkg.equals(callerPkg)) &#123; sm.checkPermission(new ReflectPermission(\"newProxyInPackage.\" + pkg)); &#125; &#125; &#125; &#125; /** * Returns true if and only if the specified class was dynamically * generated to be a proxy class using the &#123;@code getProxyClass&#125; * method or the &#123;@code newProxyInstance&#125; method. * * &lt;p&gt;The reliability of this method is important for the ability * to use it to make security decisions, so its implementation should * not just test if the class in question extends &#123;@code Proxy&#125;. * * @param cl the class to test * @return &#123;@code true&#125; if the class is a proxy class and * &#123;@code false&#125; otherwise * @throws NullPointerException if &#123;@code cl&#125; is &#123;@code null&#125; */ public static boolean isProxyClass(Class&lt;?&gt; cl) &#123; return Proxy.class.isAssignableFrom(cl) &amp;&amp; proxyClassCache.containsValue(cl); &#125; /** * Returns the invocation handler for the specified proxy instance. * * @param proxy the proxy instance to return the invocation handler for * @return the invocation handler for the proxy instance * @throws IllegalArgumentException if the argument is not a * proxy instance * @throws SecurityException if a security manager, &lt;em&gt;s&lt;/em&gt;, is present * and the caller's class loader is not the same as or an * ancestor of the class loader for the invocation handler * and invocation of &#123;@link SecurityManager#checkPackageAccess * s.checkPackageAccess()&#125; denies access to the invocation * handler's class. */ @CallerSensitive public static InvocationHandler getInvocationHandler(Object proxy) throws IllegalArgumentException &#123; /* * Verify that the object is actually a proxy instance. */ if (!isProxyClass(proxy.getClass())) &#123; throw new IllegalArgumentException(\"not a proxy instance\"); &#125; final Proxy p = (Proxy) proxy; final InvocationHandler ih = p.h; if (System.getSecurityManager() != null) &#123; Class&lt;?&gt; ihClass = ih.getClass(); Class&lt;?&gt; caller = Reflection.getCallerClass(); if (ReflectUtil.needsPackageAccessCheck(caller.getClassLoader(), ihClass.getClassLoader())) &#123; ReflectUtil.checkPackageAccess(ihClass); &#125; &#125; return ih; &#125; private static native Class&lt;?&gt; defineClass0(ClassLoader loader, String name, byte[] b, int off, int len);&#125; Springä¸­çš„åº”ç”¨12345678910111213141516public class ProxyFactoryBean extends ProxyCreatorSupport implements FactoryBean&lt;Object&gt;, BeanClassLoaderAware, BeanFactoryAware &#123; //å¦‚æœä¸å£°æ˜ï¼Œé»˜è®¤å•ä¾‹å¯¹è±¡ï¼Œæ³¨è§£å£°æ˜å¤šä¾‹ï¼Œåˆ™å£°æ˜å¤šä¾‹å¯¹è±¡ public Object getObject() throws BeansException &#123; this.initializeAdvisorChain(); if (this.isSingleton()) &#123; return this.getSingletonInstance(); &#125; else &#123; if (this.targetName == null) &#123; this.logger.warn(\"Using non-singleton proxies with singleton targets is often undesirable. Enable prototype proxies by setting the 'targetName' property.\"); &#125; return this.newPrototypeInstance(); &#125; &#125;&#125; 12JdkDynamicAopProxy:å¯¹jdkåŠ¨æ€ä»£ç†çš„å°è£…CglibAopProxy:å¯¹ç±»è¿›è¡Œä»£ç†å¢å¼º MyBatisä¸­çš„åº”ç”¨1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677package org.apache.ibatis.binding;import java.lang.reflect.Method;import java.lang.reflect.Proxy;import java.util.Map;import java.util.concurrent.ConcurrentHashMap;import org.apache.ibatis.session.SqlSession;/** * @author Lasse Voss */public class MapperProxyFactory&lt;T&gt; &#123; private final Class&lt;T&gt; mapperInterface; private final Map&lt;Method, MapperMethod&gt; methodCache = new ConcurrentHashMap&lt;&gt;(); public MapperProxyFactory(Class&lt;T&gt; mapperInterface) &#123; this.mapperInterface = mapperInterface; &#125; public Class&lt;T&gt; getMapperInterface() &#123; return mapperInterface; &#125; public Map&lt;Method, MapperMethod&gt; getMethodCache() &#123; return methodCache; &#125; @SuppressWarnings(\"unchecked\") protected T newInstance(MapperProxy&lt;T&gt; mapperProxy) &#123; // ç”Ÿæˆä¸€ä¸ªä»£ç†å¯¹è±¡å¹¶è¿”å› return (T) Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] &#123; mapperInterface &#125;,); &#125; public T newInstance(SqlSession sqlSession) &#123; final MapperProxy&lt;T&gt; mapperProxy = new MapperProxy&lt;&gt;(sqlSession, mapperInterface, methodCache); return newInstance(mapperProxy); &#125;&#125;/** * MapperProxyä»£ç†ç±»çš„ä¿¡æ¯ */public class MapperProxy&lt;T&gt; implements InvocationHandler, Serializable &#123; private static final long serialVersionUID = -6424540398559729838L; private final SqlSession sqlSession; private final Class&lt;T&gt; mapperInterface; private final Map&lt;Method, MapperMethod&gt; methodCache; public MapperProxy(SqlSession sqlSession, Class&lt;T&gt; mapperInterface, Map&lt;Method, MapperMethod&gt; methodCache) &#123; this.sqlSession = sqlSession; this.mapperInterface = mapperInterface; this.methodCache = methodCache; &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; try &#123; if (Object.class.equals(method.getDeclaringClass())) &#123; return method.invoke(this, args); &#125; else if (isDefaultMethod(method)) &#123; return invokeDefaultMethod(proxy, method, args); &#125; &#125; catch (Throwable t) &#123; throw ExceptionUtil.unwrapThrowable(t); &#125; final MapperMethod mapperMethod = cachedMapperMethod(method); return mapperMethod.execute(sqlSession, args); &#125; private MapperMethod cachedMapperMethod(Method method) &#123; return methodCache.computeIfAbsent(method, k -&gt; new MapperMethod(mapperInterface, method, sqlSession.getConfiguration())); &#125; // ... ç­‰ç­‰ ï½","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è§‚å¯Ÿè€…æ¨¡å¼","slug":"design_pattern/behaviour_type/è§‚å¯Ÿè€…æ¨¡å¼","date":"2019-10-01T16:00:00.000Z","updated":"2020-08-09T09:29:21.271Z","comments":true,"path":"posts/9a246216/","link":"","permalink":"https://gentryhuang.com/posts/9a246216/","excerpt":"","text":"å®šä¹‰å®šä¹‰äº†å¯¹è±¡ä¹‹é—´çš„ä¸€å¯¹å¤šä¾èµ–ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒæ—¶ç›‘å¬æŸä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œå½“ä¸»é¢˜å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒçš„æ‰€æœ‰ä¾èµ–è€…ï¼ˆè§‚å¯Ÿè€…ï¼‰éƒ½ä¼šæ”¶åˆ°é€šçŸ¥å¹¶æ›´æ–°ã€‚ ç±»å‹è¡Œä¸ºå‹ é€‚ç”¨åœºæ™¯1å…³è”è¡Œä¸ºåœºæ™¯ï¼Œå»ºç«‹ä¸€å¥—è§¦å‘æœºåˆ¶ã€‚å¦‚ï¼šæ³¨æŸä¸ªäº§å“çš„ä»·æ ¼ï¼Œç„¶åè¿›è¡Œé€šçŸ¥ï¼Œå…¶ä¸­ä»·æ ¼çš„å˜åŠ¨å¯èƒ½ä¼šå½±å“ä¸€æ¡é“¾ï¼Œå°±åƒæ˜¯ä¸€ä¸ªè§¦å‘é“¾æ¡ã€‚è¿™æ ·å°±å¯ä»¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼åˆ›å»ºä¸€ä¸ªç§é“¾å¼å‘æœºåˆ¶ã€‚ ä¼˜ç‚¹12341. è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´å»ºç«‹ä¸€ä¸ªæŠ½è±¡çš„è€¦åˆ - å› ä¸ºæ˜¯æŠ½è±¡çš„è€¦åˆå…³ç³»ï¼Œä¸ç®¡æ˜¯å¢åŠ è§‚å¯Ÿè€…è¿˜æ˜¯è¢«è§‚å¯Ÿè€…éƒ½å¾ˆå®¹æ˜“æ‰©å±•2. æ”¯æŒå¹¿æ’­é€šä¿¡ - ç±»ä¼¼æ¶ˆæ¯å¹¿æ’­ï¼Œéœ€è¦ç›‘å¬ä¸»é¢˜çš„åªéœ€è¦æ³¨å†Œå°±å¯ä»¥äº† ç¼ºç‚¹123451. è§‚å¯Ÿè€…ä¹‹é—´æœ‰è¿‡å¤šçš„ç»†èŠ‚ä¾èµ–ã€æé«˜äº†æ—¶é—´æ¶ˆè€—åŠç¨‹åºå¤æ‚åº¦ - è¿‡å¤šçš„ä¾èµ–ï¼šè§¦å‘æœºåˆ¶å’Œè§¦å‘é“¾æ¡ - æé«˜äº†æ—¶é—´æ¶ˆè€—åŠç¨‹åºå¤æ‚åº¦ï¼šå¦‚æœä¸€ä¸ªè¢«è§‚å¯Ÿå¯¹è±¡æœ‰å¤šä¸ªç›´æ¥æˆ–é—´æ¥è§‚å¯Ÿè€…ï¼Œä¸€æ—¦è¢«è§‚å¯Ÿè€…å˜åŒ–ï¼Œç„¶åå‘å‡ºé€šçŸ¥ï¼Œå°†æ‰€æœ‰è§‚å¯Ÿè€…éƒ½é€šçŸ¥åˆ°ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´2. ä½¿ç”¨è¦å¾—å½“ï¼Œé¿å…å¾ªç¯è°ƒç”¨ - å¦‚æœåœ¨è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´æœ‰å¾ªç¯ä¾èµ–çš„è¯ï¼Œè¢«è§‚å¯Ÿè€…ï¼ˆä¸»é¢˜å¯¹è±¡ï¼‰ä¼šè§¦å‘å®ƒä»¬ä¹‹é—´è¿›è¡Œå¾ªç¯è°ƒç”¨ï¼Œè¿™æ ·ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ ç®€å•éœ€æ±‚å­¦ç”Ÿåœ¨å­¦ä¹ è¯¾ç¨‹çš„æ—¶å€™å¯èƒ½ä¼šæå‡ºé—®é¢˜ï¼Œè€Œè€å¸ˆåˆ™æ˜¯å…³æ³¨è‡ªå·±çš„è¯¾ç¨‹ï¼Œæœ‰å­¦ç”Ÿæå‡ºè‡ªå·±è¯¾ç¨‹çš„é—®é¢˜å°±ç»™å‡ºè§£ç­” è§‚å¯Ÿè€…æ¨¡å¼æ¼”ç»ƒ è¢«è§‚å¯Ÿè€…éœ€è¦ç»§æ‰¿çš„ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109package java.util;/** * @since JDK1.0 */public class Observable &#123; private boolean changed = false; private Vector&lt;Observer&gt; obs; /** Construct an Observable with zero Observers. */ public Observable() &#123; obs = new Vector&lt;&gt;(); &#125; /** * * åœ¨è§‚å¯Ÿè€…åˆ—è¡¨ä¸­å¢åŠ ä¸€ä¸ªè§‚å¯Ÿè€… * * @param o è¦æ·»åŠ çš„è§‚å¯Ÿè€…å¯¹è±¡ * @throws NullPointerException å¦‚æœå‚æ•°ä¼ å…¥nullä¼šæŠ›å‡ºå¼‚å¸¸ */ public synchronized void addObserver(Observer o) &#123; if (o == null) throw new NullPointerException(); if (!obs.contains(o)) &#123; obs.addElement(o); &#125; &#125; /** * ä»è§‚å¯Ÿè€…åˆ—è¡¨ä¸­åˆ é™¤æŒ‡å®šçš„è§‚å¯Ÿè€… * * @param o è¦è¢«ç§»å‡ºçš„è§‚å¯Ÿè€… å‡ºå…¥ä¸ºnullä¸ä¼šæŠ›å‡ºå¼‚å¸¸ */ public synchronized void deleteObserver(Observer o) &#123; obs.removeElement(o); &#125; /** * é€šçŸ¥è§‚å¯Ÿè€…ä»¬ï¼Œä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…å‘ç”Ÿäº†æ”¹å˜ï¼‰ï¼Œè¯¥æ–¹æ³•ä¸ä¼ å‚æ•°ç»™è§‚å¯Ÿè€…ä»¬ */ public void notifyObservers() &#123; notifyObservers(null); &#125; /** * é€šçŸ¥è§‚å¯Ÿè€…ä»¬ï¼Œä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…å‘ç”Ÿäº†æ”¹å˜ï¼‰ï¼Œè¯¥æ–¹æ³•ä¼ å‚æ•°ç»™è§‚å¯Ÿè€…ä»¬ */ public void notifyObservers(Object arg) &#123; /* * a temporary array buffer, used as a snapshot of the state of * current Observers. */ Object[] arrLocal; synchronized (this) &#123; /* * åœ¨é€šçŸ¥è§‚å¯Ÿè€…ä»¬ä¹‹å‰ä¼šå…ˆæ ¡éªŒæ ‡è¯†ä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰æ”¹å˜çš„å±æ€§ï¼Œå¦‚æœæ²¡æœ‰æ”¹å˜å°±ç›´æ¥è¿”å›ä¸è¿›è¡Œé€šçŸ¥ */ if (!changed) return; arrLocal = obs.toArray(); clearChanged(); &#125; for (int i = arrLocal.length-1; i&gt;=0; i--) // é€šè¿‡è°ƒç”¨è§‚å¯Ÿè€…çš„updateæ–¹æ³•é€šçŸ¥è§‚å¯Ÿè€…ï¼Œä¼šæŠŠå½“å‰ä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…å¯¹è±¡ï¼‰ä¼ ç»™è§‚å¯Ÿè€… ((Observer)arrLocal[i]).update(this, arg); &#125; /** * æ¸…é™¤è§‚å¯Ÿè€…åˆ—è¡¨ */ public synchronized void deleteObservers() &#123; obs.removeAllElements(); &#125; /** * è°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±æ˜¯è¯´æ˜äº†ä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…å‘ç”Ÿäº†æ”¹å˜ï¼‰ï¼Œè®¾ç½®æ ‡è¯†å¯¹è±¡ä¸ºtrue */ protected synchronized void setChanged() &#123; changed = true; &#125; /** * * è°ƒç”¨è¿™ä¸ªæ–¹æ³•è¯´æ˜ä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰å·²ç»ä¸å†æ”¹å˜äº†æˆ–è€…è¦é€šçŸ¥çš„è§‚å¯Ÿè€…éƒ½é€šçŸ¥å®Œäº†ã€‚è¿™ä¸ªæ–¹æ³•ä¼šåœ¨è°ƒç”¨notifyObserversæ–¹æ³•è‡ªåŠ¨è°ƒç”¨ */ protected synchronized void clearChanged() &#123; changed = false; &#125; /** * è·å–ä¸»é¢˜å¯¹è±¡æ˜¯å¦æ”¹å˜çš„æ ‡è¯† */ public synchronized boolean hasChanged() &#123; return changed; &#125; /** * è¿”å›å…³æ³¨ä¸»é¢˜å¯¹è±¡çš„è§‚å¯Ÿçš„ä¸ªæ•° * * @return the number of observers of this object. */ public synchronized int countObservers() &#123; return obs.size(); &#125;&#125; è§‚å¯Ÿè€…éœ€è¦å®ç°çš„æ¥å£ 123456789101112package java.util;/** * @since JDK1.0 */public interface Observer &#123; /** * * å½“è®¢é˜…çš„ä¸»é¢˜å¯¹è±¡ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šé€šè¿‡è°ƒç”¨ notifyObserversæ–¹æ³•æ¥é€šçŸ¥æ‰€æœ‰è®¾è®¡åˆ°çš„è§‚å¯Ÿè€…ï¼Œå°±æ˜¯é€šè¿‡è°ƒç”¨è§‚å¯Ÿè€…çš„updateæ–¹æ³•è¿›è¡Œé€šçŸ¥çš„ */ void update(Observable o, Object arg);&#125; ä¸»é¢˜ç±»ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859package com.design.pattern.observer;import lombok.Data;import lombok.extern.slf4j.Slf4j;import java.util.ArrayList;import java.util.List;import java.util.Observable;/** * Course * 1 å®ƒä¸‹é¢æœ‰é—®é¢˜ï¼ŒCourseå±äºè¢«è§‚å¯Ÿè€…ï¼Œä¹Ÿå°±æ˜¯ä¸»é¢˜å¯¹è±¡ * 2 ä½œä¸ºè¢«è§‚å¯Ÿè€…å¿…é¡»ç»§æ‰¿Observableç±»ï¼Œæ ‡å¿—æ˜¯å¯è§‚å¯Ÿçš„ * * @author shunhua * @date 2019-10-02 */@Data@Slf4jpublic class Course extends Observable &#123; /** * è¯¾ç¨‹å */ private String name; /** * è¯¾ç¨‹å¯¹åº”çš„é—®é¢˜åˆ—è¡¨ */ private List&lt;Question&gt; questions = new ArrayList&lt;&gt;(); public Course(String name) &#123; this.name = name; &#125; public void addQuestion(Question question) &#123; questions.add(question); &#125; /** * ä¸»é¢˜æ”¹å˜æ–¹æ³• * * @param course */ public void produceQuestion(Course course) &#123; questions.stream().forEach(question -&gt; &#123; log.info(String.format(\"%såœ¨%sæå‡ºäº†é—®é¢˜\", question.getUserName(), course.getName())); /** * è°ƒç”¨çˆ¶ç±»Observabelä¸­çš„setChangedæ–¹æ³•ï¼ŒæŠŠchangedæ ‡è¯†è®¾ç½®ä¸ºtrue,è¡¨ç¤ºä¸»é¢˜å¯¹è±¡å‘ç”Ÿäº†æ”¹å˜,æ­¤æ—¶è§‚å¯Ÿè€…å’Œè¢«è§‚å¯Ÿè€…ä¹‹é—´è¿›è¡Œé€šä¿¡ */ setChanged(); /** * é€šçŸ¥è§‚å¯Ÿè€… */ notifyObservers(question); &#125; ); &#125;&#125; è§‚å¯Ÿè€… 123456789101112131415161718192021222324252627282930313233343536373839package com.design.pattern.observer;import lombok.AllArgsConstructor;import lombok.Data;import lombok.extern.slf4j.Slf4j;import java.util.Observable;import java.util.Observer;/** * Teacher * * 1 è§‚å¯Ÿçš„æ˜¯è¯¾ç¨‹ï¼Œè€Œä¸æ˜¯é—®é¢˜ï¼Œé—®é¢˜å±äºè¯¾ç¨‹ ã€‚ Teacherå±äºè§‚å¯Ÿè€… * 2 å¿…é¡»å®ç°Observeræ¥å£ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªè§‚å¯Ÿè€… * * @author shunhua * @date 2019-10-02 */@Data@AllArgsConstructor@Slf4jpublic class Teacher implements Observer &#123; /** * è€å¸ˆåç§° */ private String name; /** * * @param o è¢«è§‚å¯Ÿå¯¹è±¡ * @param arg è¢«è§‚å¯Ÿè€…çš„notifyObserversæ–¹æ³•ä¼ é€’è¿‡æ¥çš„å¯¹è±¡ */ @Override public void update(Observable o, Object arg) &#123; Course course = (Course) o; Question question = (Question) arg; log.info(String.format(\"%sè¯¾ç¨‹è¢«%såŒå­¦æå‡º%sçš„é—®é¢˜ï¼Œéœ€è¦%sè§£ç­”\",course.getName(),question.getUserName(),question.getQuestionContent(),name)); &#125;&#125; åº”ç”¨è¾…åŠ©ç±» 1234567891011121314151617181920212223package com.design.pattern.observer;import lombok.Builder;import lombok.Data;/** * Question * * @author shunhua * @date 2019-10-02 */@Data@Builderpublic class Question &#123; /** * é—®é¢˜æé—®è€…åç§° */ private String userName; /** * å…·ä½“é—®é¢˜ */ private String questionContent;&#125; åº”ç”¨å±‚ 123456789101112131415161718192021222324252627282930313233343536package com.design.pattern.observer;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-02 */public class Client &#123; @Test public void test()&#123; Course course = new Course(\"ã€ŠJavaä»å…¥é—¨åˆ°æ”¾å¼ƒã€‹\"); Teacher teacher = new Teacher(\"Javaå­¦é™¢è€å¸ˆ\"); Teacher teacher1 = new Teacher(\"é¼“åŠ±å¸ˆ\"); // ä¸ºè¯¾ç¨‹æ·»åŠ è§‚å¯Ÿè€… course.addObserver(teacher); course.addObserver(teacher1); // æ·»åŠ è¯¾ç¨‹çš„é—®é¢˜ course.addQuestion(Question.builder() .userName(\"gentryhuang\") .questionContent(\"Javaå­¦ä¸å®Œï¼Œéœ€è¦æ”¾å¼ƒå—ï¼Ÿ\") .build()); course.addQuestion(Question.builder() .userName(\"xw\") .questionContent(\"å¿«çœ‹ï¼Œåˆä¸€ä¸ªå­¦Javaçš„è½¬è¡Œäº†ï¼Œè¦è·‘è·¯å—ï¼Ÿ\") .build()); // ä¸»é¢˜å¯¹è±¡å‘ç”Ÿå˜åŒ–ï¼ˆæœ‰é—®é¢˜æå‡ºäº†ï¼‰ course.produceQuestion(course); &#125;&#125; è§‚å¯Ÿè€…æ¨¡å¼æºç è§£æç›‘å¬å™¨å®ç°æ–¹æ¡ˆå°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼å®ç°çš„ä¸€ç§ Guavaä¸­è§‚å¯Ÿè€…æ¨¡å¼çš„ä½¿ç”¨ ä½¿ç”¨@Subscribeè¿›è¡Œæ–¹æ³•æ ‡æ³¨ 12345678910111213141516171819package com.design.pattern.observer.guava;import com.google.common.eventbus.Subscribe;import lombok.extern.slf4j.Slf4j;/** * GuavaEvent * * @author shunhua * @date 2019-10-02 */@Slf4jpublic class GuavaEvent &#123; @Subscribe public void subscribe(String event)&#123; log.info(\"æ‰§è¡Œsubscribeæ–¹æ³•ï¼Œä¼ å…¥å‚æ•°æ˜¯ï¼š\" + event); &#125;&#125; åœ¨åº”ç”¨å±‚æŠŠè®¢é˜…è€…è¿›è¡Œæ³¨å†Œ 12345678910111213141516171819202122232425262728293031323334package com.design.pattern.observer.guava;import com.google.common.eventbus.EventBus;import org.junit.Test;/** * GuavaEventTest * * @author shunhua * @date 2019-10-02 */public class GuavaEventTest &#123; @Test public void test() &#123; /** * Guavaå®ç°è§‚å¯Ÿè€…æ¨¡å¼çš„æ ¸å¿ƒç±» */ EventBus eventBus = new EventBus(); /** * GuavaEventä¸­æœ‰ä½¿ç”¨@Subscribeæ³¨è§£æ ‡æ³¨çš„æ–¹æ³• */ GuavaEvent guavaEvent = new GuavaEvent(); /** * GuavaEventçš„@Subscribeæ ‡æ³¨çš„æ–¹æ³• åŠ å…¥åˆ°è§‚å¯Ÿè€…æ¨¡å¼ä¸­ï¼Œä½œä¸ºè®¢é˜…è€…å³è§‚å¯Ÿè€… */ eventBus.register(guavaEvent); /** * è°ƒç”¨EventBusçš„postæ–¹æ³•ä¼šå›è°ƒSubscribeæ ‡æ³¨çš„æ–¹æ³• */ eventBus.post(\"postçš„å†…å®¹\"); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è§£é‡Šå™¨æ¨¡å¼","slug":"design_pattern/behaviour_type/è§£é‡Šå™¨æ¨¡å¼","date":"2019-10-01T16:00:00.000Z","updated":"2020-08-09T09:29:48.704Z","comments":true,"path":"posts/30cf0cd2/","link":"","permalink":"https://gentryhuang.com/posts/30cf0cd2/","excerpt":"","text":"å®šä¹‰ç»™å®šä¸€ä¸ªè¯­è¨€ï¼Œå®šä¹‰å®ƒçš„æ–‡æ³•ï¼ˆè¯­æ³•ï¼‰çš„ä¸€ç§è¡¨ç¤ºï¼Œå¹¶å®šä¹‰ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¿™ä¸ªè§£é‡Šå™¨ä½¿ç”¨è¯¥è¡¨ç¤ºæ¥è§£é‡Šè¯­è¨€ä¸­çš„å¥å­ã€‚å³ ä¸ºäº†è§£é‡Šä¸€ç§è¯­è¨€ï¼ˆè¯­è¨€çš„è¯­æ³•ï¼‰ï¼Œè€Œä¸ºè¯­è¨€åˆ›å»ºçš„è§£é‡Šå™¨ ç±»å‹è¡Œä¸ºå‹ é€‚ç”¨åœºæ™¯1åœ¨å¤„ç†æ—¥å¿—çš„æ—¶å€™ï¼Œç”±äºå¤šä¸ªæœåŠ¡äº§ç”Ÿçš„æ—¥å¿—æ ¼å¼ä¸ä¸€å®šç»Ÿä¸€ï¼Œä½†æ˜¯æ•°æ®é‡Œé¢çš„è¦ç´ æ˜¯ç›¸åŒçš„ï¼Œè¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç¨‹åºæ¥è§£å†³è¯¥é—®é¢˜ï¼Œè€Œè¿™ä¸ªç¨‹åºæˆ‘ä»¬å°±å¯ä»¥ç†è§£ä¸ºè§£é‡Šå™¨ï¼Œåªä¸è¿‡å¯ä»¥è§£é‡Šä¸åŒæ—¥å¿—æ ¼å¼ã€‚åœ¨å®é™…é¡¹ç›®ä¸­è§£é‡Šå™¨æ¨¡å¼ä½¿ç”¨çš„æ¯”è¾ƒå°‘ï¼Œå¤šä½¿ç”¨å¼€æºåŒ…ã€‚ ä¼˜ç‚¹1è¯­æ³•ç”±å¾ˆå¤šç±»è¡¨ç¤ºï¼Œå®¹æ˜“æ”¹å˜åŠæ‰©å±•æ­¤â€œè¯­è¨€â€ï¼ˆæ¶‰åŠçš„ä»£ç è¿˜ä¸è¶³ä»¥è¯´æ˜æ˜¯ç§è¯­è¨€ï¼‰ ç¼ºç‚¹1å½“è¯­æ³•è§„åˆ™æ•°ç›®å¤ªå¤šæ—¶ï¼Œå¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦ ç®€å•éœ€æ±‚è‡ªå®šä¹‰ä¸€å¥—å¯ä»¥åŠ æ³•ã€ä¹˜æ³•çš„è¯­æ³•ï¼Œä½¿ç”¨æ ˆæ¥è¡¨ç¤ºï¼Œè¿™å’Œæ—¥å¸¸çš„åŠ æ³•å’Œä¹˜æ³•æ˜¯ä¸ä¸€æ ·çš„ã€‚ç„¶åå®šä¹‰åŠ æ³•å’Œä¹˜æ³•è§£é‡Šå™¨ï¼Œè§£é‡Šå¯¹åº”çš„è¡¨è¾¾å¼ç„¶åæ‹¿åˆ°æœ€ç»ˆçš„ç»“æœã€‚ è§£é‡Šå™¨æ¨¡å¼æ¼”ç»ƒ è§£é‡Šå™¨æ¥å£ 123456789101112131415package com.design.pattern.interpreter;/** * Interpreter è§£é‡Šæ¥å£ * * @author shunhua * @date 2019-10-02 */public interface Interpreter &#123; /** * è§£é‡Šæ–¹æ³• * @return */ int interpret();&#125; åŠ æ³•è§£é‡Šå™¨ 123456789101112131415161718192021222324252627282930313233343536373839package com.design.pattern.interpreter;/** * AddInterpreter åŠ æ³•è§£é‡Šå™¨ * * @author shunhua * @date 2019-10-02 */public class AddInterpreter implements Interpreter &#123; /** * å®ƒä»¬çš„æ–¹æ³•è¿”å›å€¼ä½œä¸ºåŠ æ•°å’Œè¢«åŠ æ•° */ private Interpreter firstExpression,secondeExpression; /** * åŠ æ³•éœ€è¦ åŠ æ•°å’Œè¢«åŠ æ•° * @param firstExpression * @param secondeExpression */ public AddInterpreter(Interpreter firstExpression,Interpreter secondeExpression)&#123; this.firstExpression = firstExpression; this.secondeExpression = secondeExpression; &#125; /** * è¿”å›ä¸¤ä¸ªè¡¨è¾¾å¼ç»“æœçš„å’Œ * @return */ @Override public int interpret() &#123; return this.firstExpression.interpret() + this.secondeExpression.interpret(); &#125; @Override public String toString() &#123; return \"+\"; &#125;&#125; ä¹˜æ³•è§£é‡Šå™¨ 1234567891011121314151617181920212223242526272829303132333435363738package com.design.pattern.interpreter;/** * MultiInterpreter ä¹˜æ³•è§£é‡Šå™¨ * * @author shunhua * @date 2019-10-02 */public class MultiInterpreter implements Interpreter &#123; /** * å®ƒä»¬çš„è¡¨è¾¾å¼ç»“æœä½œä¸ºä¹˜æ•°å’Œè¢«ä¹˜é™¤æ•° */ private Interpreter firstExpression,secondExpression; /** * ä¹˜æ³•éœ€è¦ ä¹˜æ•°å’Œè¢«ä¹˜æ•° * @param firstExpression * @param secondExpression */ public MultiInterpreter(Interpreter firstExpression,Interpreter secondExpression)&#123; this.firstExpression = firstExpression; this.secondExpression = secondExpression; &#125; /** * ä¹˜æ³•è§£é‡Šå™¨çš„è§£é‡Šæ–¹æ³• * @return */ @Override public int interpret() &#123; return this.firstExpression.interpret() * this.secondExpression.interpret(); &#125; @Override public String toString() &#123; return \"*\"; &#125;&#125; è¡¨è¾¾å¼å¤„ç†è§£é‡Šå™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041// æ³¨æ„è¿™ä¸ªè§£é‡Šå™¨å°±æ˜¯ç®€å•è½¬æ¢æ•°æ®çš„package com.design.pattern.interpreter;/** * NumberInterpreter è¡¨è¾¾å¼å¤„ç†è§£é‡Šå™¨ * * @author shunhua * @date 2019-10-02 */public class NumberInterpreter implements Interpreter &#123; /** * è¡¨è¾¾å¼è¦è¿”å›çš„å€¼ */ private int number; /** * æ•°å€¼æ„é€ å™¨ * @param number */ public NumberInterpreter(int number)&#123; this.number = number; &#125; /** * å­—ç¬¦ä¸²è½¬æ¢æ„é€ å™¨ * @param number */ public NumberInterpreter(String number)&#123; this.number = Integer.parseInt(number); &#125; /** * è§£é‡Šæ–¹æ³• * @return */ @Override public int interpret() &#123; return this.number; &#125;&#125; å°è£…è§£é‡Šå™¨çš„å¤„ç†ç±»â€“æš´éœ²ç»™ç”¨æˆ·çš„è§£é‡Šå™¨ï¼ˆå®ƒå†…éƒ¨æ˜¯å¯¹å‡ ä¸ªè§£é‡Šå™¨çš„å°è£…ï¼‰ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package com.design.pattern.interpreter;import lombok.extern.slf4j.Slf4j;import java.util.Arrays;import java.util.Stack;/** * ExpressionParse * * @author shunhua * @date 2019-10-02 */@Slf4jpublic class ExpressionParse &#123; /** * å®šä¹‰ä¸€ä¸ªæ ˆï¼Œè¿™é‡Œæ˜¯è§£é‡Šå™¨ç±»å‹æ ˆ */ private Stack&lt;Interpreter&gt; stack = new Stack&lt;&gt;(); public int parse(String str)&#123; String[] strItemArray = str.split(\" \"); Arrays.stream(strItemArray).forEach(symbol -&gt;&#123; // ä¸æ˜¯è¿ç®—ç¬¦ï¼Œéœ€è¦å…¥æ ˆ if(!OperatorUtil.isOperator(symbol))&#123; Interpreter numberExpression = new NumberInterpreter(symbol); stack.push(numberExpression); log.info(String.format(\"å…¥æ ˆï¼š%d\",numberExpression.interpret())); &#125;else &#123; // æ˜¯è¿ç®—ç¬¦ï¼Œå¯ä»¥è¿›è¡Œè®¡ç®— Interpreter firstExpression = stack.pop(); Interpreter secondExpression = stack.pop(); log.info(String.format(\"å‡ºæ ˆï¼š %d å’Œ %d\",firstExpression.interpret(),secondExpression.interpret())); Interpreter operator = OperatorUtil.getExpressionObject(firstExpression,secondExpression,symbol); log.info(String.format(\"è§£é‡Šå™¨ç±»å‹ï¼š%s\",operator.toString())); int result = operator.interpret(); NumberInterpreter resultExpression = new NumberInterpreter(result); stack.push(resultExpression); log.info(String.format(\"é˜¶æ®µç»“æœå…¥æ ˆï¼š %d\",resultExpression.interpret())); &#125; &#125;); int result = stack.pop().interpret(); return result; &#125;&#125; å·¥å…·ç±» 1234567891011121314151617181920212223242526272829303132333435package com.design.pattern.interpreter;/** * OperatorUtil * * @author shunhua * @date 2019-10-02 */public class OperatorUtil &#123; /** * æ˜¯å¦å¯æ“ä½œ * @param symbol * @return */ public static boolean isOperator(String symbol)&#123; return \"+\".equals(symbol) || \"*\".equals(symbol); &#125; /** * ä½¿ç”¨è§£é‡Šå™¨è¿›è¡Œè§£é‡Šï¼Œè¡¨è¾¾å¼çš„ç»“æœ * @param firstExpression * @param secondExpression * @param symbol * @return */ public static Interpreter getExpressionObject(Interpreter firstExpression,Interpreter secondExpression,String symbol)&#123; if(\"+\".equals(symbol))&#123; return new AddInterpreter(firstExpression,secondExpression); &#125; else if (\"*\".equals(symbol))&#123; return new MultiInterpreter(firstExpression,secondExpression); &#125; return null; &#125;&#125; åº”ç”¨ 12345678910111213141516171819202122232425package com.design.pattern.interpreter;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-10-02 */@Slf4jpublic class Client &#123; @Test public void test()&#123; // è¾“å…¥è¡¨è¾¾å¼ String inputStr = \"18 70 12 + *\"; // å¯¹è¡¨è¾¾å¼è¿›è¡Œè§£é‡Š ExpressionParse expressionParse = new ExpressionParse(); int result = expressionParse.parse(inputStr); log.info(\"æœ€ç»ˆè§£é‡Šç»“æœï¼š\" + result); &#125;&#125; è§£é‡Šå™¨æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨java.util.regex.Pattern 1æ­£åˆ™è¡¨è¾¾å¼å°±æ˜¯ä¸€ç§è¯­æ³•ï¼Œé€šè¿‡jdkä¸­çš„æ­£åˆ™è§£é‡Šå™¨æŠŠå®ƒè§£é‡Šå‡ºæ¥ 123456789101112131415161718192021222324252627282930package com.design.pattern.interpreter;import lombok.extern.slf4j.Slf4j;import org.junit.Test;import java.util.regex.Matcher;import java.util.regex.Pattern;/** * PatternTest * * @author shunhua * @date 2019-10-02 */@Slf4jpublic class PatternTest &#123; @Test public void test()&#123; String str = \"china\"; String patternStr = \"\\\\s+\" + str + \"\\\\s+\"; // æ­£åˆ™è§£é‡Šå™¨ï¼Œè§£é‡Šæ­£åˆ™è¡¨è¾¾å¼ Pattern pattern = Pattern.compile(patternStr); String content = \" china becames more and more beautiful! \"; Matcher matcher = pattern.matcher(content); if (matcher.find()) &#123; String content_new = matcher.replaceAll(\"China \"); log.info(String.format(\"old: %s, new: %s\",content,content_new)); &#125; &#125;&#125; Springçš„ELè§£é‡Šå™¨ 1Elè¡¨è¾¾å¼æ˜¯ä¸€ç§è¯­æ³•ï¼Œé€šè¿‡Springçš„è§£é‡Šå™¨å»è§£é‡Š 12345678910111213141516171819202122232425262728293031package com.design.pattern.interpreter.resource;import lombok.extern.slf4j.Slf4j;import org.junit.Test;import org.springframework.expression.Expression;import org.springframework.expression.ExpressionParser;import org.springframework.expression.spel.standard.SpelExpressionParser;/** * SpelParserTest * * @author shunhua * @date 2019-10-02 */@Slf4jpublic class SpelParserTest &#123; /** * ä½¿ç”¨Springçš„è¯­è¨€è§£é‡Šå™¨(ExpressionParser) è§£é‡ŠSpringçš„ELï¼ˆè§£é‡Šè¯­è¨€ï¼‰è¡¨è¾¾å¼ */ @Test public void test() &#123; // åˆ›å»ºSpringçš„è¯­è¨€è§£é‡Šå™¨ ExpressionParser parser = new SpelExpressionParser(); // ä½¿ç”¨è§£é‡Šè§£æSpringçš„Elè¡¨è¾¾å¼ Expression expression = parser.parseExpression(\"2 * 100 * 10 + 19\"); // å–å‡ºç»“æœ int result = (Integer) expression.getValue(); log.info(\"è§£é‡Šåçš„ç»“æœï¼š\" + result); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å•ä¾‹æ¨¡å¼","slug":"design_pattern/creation_type/å•ä¾‹æ¨¡å¼","date":"2019-10-01T16:00:00.000Z","updated":"2020-07-04T16:28:45.963Z","comments":true,"path":"posts/f1601c3e/","link":"","permalink":"https://gentryhuang.com/posts/f1601c3e/","excerpt":"","text":"å•ä¾‹æ¨¡å¼å®šä¹‰ä¿è¯ä¸€ä¸ªç±»ä»…æœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚ ç±»å‹åˆ›å»ºå‹ é€‚ç”¨åœºæ™¯12æƒ³ç¡®ä¿ä»»ä½•æƒ…å†µä¸‹éƒ½ç»å¯¹åªæœ‰ä¸€ä¸ªå®ä¾‹ - æ•°æ®åº“è¿æ¥æ± ã€çº¿ç¨‹æ± ä»¥åŠè®¡æ•°å™¨ç­‰ ä¼˜ç‚¹1234561. åœ¨å†…å­˜é‡Œåªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå‡å°‘äº†å†…å­˜å¼€é”€ - ç‰¹åˆ«æ˜¯ä¸€ä¸ªå¯¹è±¡é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯ï¼Œè€Œä¸”åœ¨åˆ›å»ºå’Œé”€æ¯æ—¶æ€§èƒ½åˆä¸èƒ½å¾ˆå¥½çš„ä¼˜åŒ–2. å¯ä»¥é¿å…å¯¹èµ„æºçš„å¤šé‡å ç”¨ - å¦‚å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå†™æ“ä½œï¼Œç”±äºåªæœ‰ä¸€ä¸ªå®ä¾‹å­˜åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥é¿å…å¯¹åŒä¸€ä¸ªèµ„æºæ–‡ä»¶åŒæ—¶å†™æ“ä½œ3. è®¾ç½®å…¨å±€è®¿é—®ç‚¹ï¼Œä¸¥æ ¼æ§åˆ¶è®¿é—® - å¯¹å¤–æ§åˆ¶åˆ›å»ºçš„å…¥å£ ç¼ºç‚¹1æ²¡æœ‰æ¥å£ï¼Œæ‰©å±•å›°éš¾ï¼Œæƒ³è¦æ‰©å±•éœ€è¦ä¿®æ”¹æºä»£ç  æ‹“å±•ç‚¹1234567891011121. ç§æœ‰æ„é€ å™¨ - ä¸ºäº†ç¦æ­¢ä»å•ä¾‹ç±»å¤–éƒ¨è°ƒç”¨æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡ï¼Œä¸ºäº†è¾¾åˆ°ç›®çš„å¿…é¡»è®¾ç½®æ„é€ å‡½æ•°ä¸ºç§æœ‰çš„2. çº¿ç¨‹å®‰å…¨ - çº¿ç¨‹å®‰å…¨åœ¨å•ä¾‹æ¨¡å¼è®¾è®¡çš„è¿‡ç¨‹ä¸­éå¸¸é‡è¦3. å»¶è¿ŸåŠ è½½ - å»¶æ—¶åˆ›å»ºå¯¹è±¡4. åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®‰å…¨ - å¯¹äºå•ä¾‹å¯¹è±¡ä¸€æ—¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œå°±ä¼šå¯¹å•ä¾‹è¿›è¡Œç ´å5. åå°„ - å•ä¾‹æ¨¡å¼ä¹Ÿè¦é˜²æ­¢åå°„æ”»å‡»6. åŒé‡æ£€é”æœºåˆ¶7. å•ä¾‹é™æ€å†…éƒ¨ç±»çš„å®ç°æ–¹æ¡ˆ å•ä¾‹æ¨¡å¼ç›¸å…³çš„è®¾è®¡æ¨¡å¼å•ä¾‹æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ 1åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå·¥å‚ç±»è®¾ç½®ä¸ºå•ä¾‹çš„ å•ä¾‹æ¨¡å¼å’Œäº«å…ƒæ¨¡å¼ 1åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œè¦ç®¡ç†å¾ˆå¤šå•ä¾‹å¯¹è±¡ï¼Œé€šè¿‡äº«å…ƒæ¨¡å¼å’Œå•ä¾‹æ¨¡å¼ç»“åˆæ¥å®Œæˆå•ä¾‹å¯¹è±¡çš„è·å–ï¼Œåœ¨è¿™ç§ç»“åˆåœºæ™¯ä¸‹ï¼Œäº«å…ƒæ¨¡å¼çš„åº”ç”¨å°±ç±»ä¼¼äºå•ä¾‹å¯¹è±¡çš„ä¸€ä¸ªå·¥å‚ï¼Œåªä¸è¿‡ä¼šè·å–å·²ç»åˆ›å»ºå¥½çš„å¯¹è±¡è€Œä¸ä¼šé‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚ å•ä¾‹æ¨¡å¼ç±»å‹æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼-éå®‰å…¨ 1234567891011121314151617181920212223242526272829303132333435363738394041package com.design.pattern.singleton.lazynosafe;/** * LazyDoubleCheckSingleton æ‡’æ±‰å¼-çº¿ç¨‹ä¸å®‰å…¨ * * @author shunhua * @date 2019-10-02 */public class LazySingleton &#123; /** * å®šä¹‰LazySingletonå±æ€§ */ private static LazySingleton lazySingleton = null; /** * æŒ‡å®šæ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ */ private LazySingleton()&#123;&#125; /** * å…¨å±€æ§åˆ¶ç‚¹ * @return */ public static LazySingleton getInstance()&#123; /** * åœ¨æ²¡æœ‰æ–­ç‚¹å¹²é¢„çš„æƒ…å†µä¸‹ï¼Œå¤šçº¿ç¨‹æ‰§è¡Œå’ŒCPUåˆ†é…æœ‰å…³ã€‚ä¸ºäº†æ›´æ¸…æ¥šçš„è§‚çœ‹å¤šçº¿ç¨‹æ‰§è¡Œï¼Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹debugæ¥è¾¾åˆ°æ§åˆ¶å¤šä¸ªçº¿ç¨‹çš„ç›®çš„ * * åœ¨å¤šçº¿ç¨‹ä¸‹æœ‰ä»¥ä¸‹å‡ ç§å¯èƒ½ï¼Œè¿™é‡Œä»¥ä¸¤ä¸ªçº¿ç¨‹è§£é‡Šï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹B * * 1 å½“çº¿ç¨‹Bèµ°åˆ°if(lazySingleton == null)æ—¶ï¼Œçº¿ç¨‹Aå·²ç»æ‰§è¡Œåˆ›å»ºå¥½äº†å¯¹è±¡ï¼Œæ­¤æ—¶çº¿ç¨‹Bç›´æ¥è¿”å›çº¿ç¨‹Aåˆ›å»ºçš„å¯¹è±¡ * 2 å½“çº¿ç¨‹Bèµ°åˆ°if(lazySingleton == null)æ—¶ï¼Œçº¿ç¨‹Aè¿˜æ²¡æœ‰åˆ›å»ºå¥½å¯¹è±¡å³LazySingletonä»ç„¶ä¸ºç©ºï¼Œç´§æ¥ç€çº¿ç¨‹Bçš„ifåˆ¤æ–­é€šè¿‡ï¼Œå½“Aåˆ›å»ºå®Œå¯¹è±¡å‡†å¤‡è¿”å›lazySingletonå³æ‰§è¡Œreturn lazySingletonæ—¶ï¼Œçº¿ç¨‹Båˆ›å»ºå¥½äº†å¯¹è±¡å¹¶èµ‹å€¼ç»™lazySingletonï¼Œæ­¤æ—¶lazySingletonå˜é‡çš„å€¼æ˜¯çº¿ç¨‹Båˆ›å»ºçš„å¯¹è±¡å¼•ç”¨ï¼Œä¼šè¦†ç›–çº¿ç¨‹Aåˆ›å»ºçš„å¯¹è±¡å¯¹åº”çš„å¼•ç”¨ï¼Œæœ€ç»ˆçº¿ç¨‹Aå’Œçº¿ç¨‹Bè¿”å›çš„è™½ç„¶æ˜¯æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼ˆçº¿ç¨‹Båˆ›å»ºçš„ï¼‰çš„å¼•ç”¨ï¼Œä½†æ˜¯å®è´¨ä¸Šå¯¹è±¡å·²ç»åˆ›å»ºäº†ä¸¤æ¬¡ã€‚ * 3 å½“çº¿ç¨‹Bèµ°åˆ°if(lazySingleton == null)æ—¶ï¼Œçº¿ç¨‹Aè¿˜æ²¡æœ‰åˆ›å»ºå¥½å¯¹è±¡å³LazySingletonä»ç„¶ä¸ºç©ºï¼Œä»…æ¥ç€çº¿ç¨‹Bçš„ifåˆ¤æ–­é€šè¿‡ï¼Œçº¿ç¨‹Aåœ¨çº¿ç¨‹Båˆ›å»ºå¯¹è±¡ä¹‹å‰è¿”å›äº†ï¼Œé‚£ä¹ˆæœ€ç»ˆçº¿ç¨‹Aå’Œçº¿ç¨‹Béƒ½ä¼šåˆ›å»ºå¯¹è±¡ï¼Œå¹¶ä¸”è¿”å›çš„å¯¹è±¡å¼•ç”¨ä¸ä¼šç›¸åŒï¼Œå®ƒä»¬æŒ‡å‘å„è‡ªåˆ›å»ºçš„å¯¹è±¡ã€‚ * */ if(lazySingleton == null)&#123; lazySingleton = new LazySingleton(); &#125; return lazySingleton; &#125;&#125; 123456789101112131415161718192021package com.design.pattern.singleton.lazynosafe;import lombok.extern.slf4j.Slf4j;/** * MyThread å®ç°Runnableæ¥å£ï¼Œå®ç°å¤šçº¿ç¨‹ * * @author shunhua * @date 2019-10-02 */@Slf4jpublic class MyThread implements Runnable &#123; @Override public void run() &#123; // è·å–ç›®æ ‡å¯¹è±¡ LazySingleton lazySingleton = LazySingleton.getInstance(); // æ‰“å°å½“å‰æ‰§è¡Œçš„çº¿ç¨‹ä¿¡æ¯å’Œç›®æ ‡å¯¹è±¡ä¿¡æ¯ log.info(Thread.currentThread().getName() +\" \"+ lazySingleton); &#125;&#125; æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼å®‰å…¨-é”ç²’åº¦è¾ƒå¤§ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.design.pattern.singleton.lazysafebutlockisbig;/** * LazyDoubleCheckSingleton æ‡’æ±‰å¼-çº¿ç¨‹å®‰å…¨ä½†æ˜¯é”çš„ç²’åº¦å¤ªå¤§ * * @author shunhua * @date 2019-10-02 */public class LazySingleton &#123; /** * å®šä¹‰LazySingletonå±æ€§ */ private static LazySingleton lazySingleton = null; /** * æŒ‡å®šæ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ */ private LazySingleton()&#123;&#125; /** * å…¨å±€æ§åˆ¶ç‚¹ * * synchronizeåŠ é”çš„ä½ç½®ä¸åŒï¼Œçº¿ç¨‹æŒæœ‰çš„å¯¹è±¡ä¹Ÿä¼šä¸åŒ * 1 åŠ åœ¨é™æ€æ–¹æ³•ä¸Šï¼ŒæŒæœ‰çš„æ˜¯ç±»çš„classæ–‡ä»¶ï¼Œå³å½“å‰ç±» * 2 åŠ åœ¨éé™æ€æ–¹æ³•ä¸Šï¼ŒæŒæœ‰çš„æ˜¯å †å†…å­˜ä¸­çš„å¯¹è±¡ï¼Œå³æ‰§è¡Œå½“å‰æ–¹æ³•çš„å¯¹è±¡ * * @return */ public synchronized static LazySingleton getInstance()&#123; /** * synchronizeåŠ é”åœ¨é™æ€æ–¹æ³•ä¸Šç­‰åŒäºé”ä»£ç å—æ—¶LazySingleton.classä½œä¸ºæŒæœ‰å¯¹è±¡ï¼š * * public static LazyDoubleCheckSingleton getInstance()&#123; * synchronized(LazyDoubleCheckSingleton.class)&#123; * if (lazySingleton == null) &#123; * lazySingleton = new LazyDoubleCheckSingleton(); * &#125; * &#125; * return lazySingleton; * &#125; */ if(lazySingleton == null)&#123; lazySingleton = new LazySingleton(); &#125; return lazySingleton; &#125;&#125; æ‡’æ±‰å¼å•ä¾‹æ¨¡å¼-åŒé‡æ£€é” 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768package com.design.pattern.singleton.lazysafedoublecheck;/** * LazyDoubleCheckSingleton åŒé‡æ£€é”ï¼Œå…¼é¡¾äº†æ€§èƒ½å’Œçº¿ç¨‹å®‰å…¨ * * @author shunhua * @date 2019-10-03 */public class LazyDoubleCheckSingleton &#123; /** * å®šä¹‰LazySingletonå±æ€§ ,è¿™é‡ŒåŠ volatileå…³é”®å­—é˜²æ­¢æŒ‡ä»¤é‡æ’åºå’Œå†…å­˜å¯è§ */ private volatile static LazyDoubleCheckSingleton lazySingleton = null; /** * æŒ‡å®šæ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ */ private LazyDoubleCheckSingleton()&#123;&#125; /** * å…¨å±€æ§åˆ¶ç‚¹ * * åŒé‡æ£€é”æŒ‡çš„å°±æ˜¯ä¸¤æ¬¡åˆ¤æ–­ * * @return */ public static LazyDoubleCheckSingleton getInstance()&#123; /** * 1 è¿™ä¸€å±‚ifåˆ¤æ–­å¦‚æœä¸ä½¿ç”¨ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯é”çš„ç²’åº¦åˆå›åˆ°äº†å¤§ç²’åº¦ç‰ˆæœ¬ã€‚ä½¿ç”¨è¿™ä¸€å±‚åˆ¤æ–­æ˜¯ä¸ºäº†ç¼©å°synchronizedé”çš„ç²’åº¦ * 2 å¼•å…¥äº†è¿™ä¸€å±‚ä¼šå¢åŠ ä¸€ä¸ªéšæ‚£-ç”±äºæŒ‡ä»¤é‡æ’åºï¼Œèµ°åˆ°è¯¥å±‚ifåˆ¤æ–­lazySingletonå¯èƒ½ç¡®å®ä¸ä¸ºç©ºï¼Œä½†æ˜¯å®ƒæŒ‡å‘çš„å¯¹è±¡å¯èƒ½è¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆï¼Œå½“ä½¿ç”¨è¿™ä¸ªå¯¹è±¡çš„æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå¼‚å¸¸ */ if(lazySingleton == null)&#123; /** * åŠ é” */ synchronized (LazyDoubleCheckSingleton.class)&#123; /** * è¿™ä¸€å±‚ifå¿…é¡»è¦æœ‰ï¼Œå› ä¸ºsynchronizedé”çš„ç²’åº¦å°äº†ï¼Œä¸æ˜¯æ•´ä¸ªæ–¹æ³•ï¼Œå½“å‡ºç°çº¿ç¨‹è¿›å…¥ç¬¬ä¸€ä¸ªifå—ä¸­ä½†è¢«é˜»å¡åœ¨åŒæ­¥ä»£ç å—å¤–æ—¶ï¼ˆåˆ«çš„çº¿ç¨‹æ‹¿åˆ°äº†é”åœ¨é‡Œé¢åˆ›å»ºå¯¹è±¡ï¼‰ï¼Œ * å¦‚æœä¸åŠ è¯¥ifåˆ¤æ–­è¯¥çº¿ç¨‹è¿˜ä¼šåˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸ä¼šç›´æ¥è¿”å›å·²ç»åˆ›å»ºå¥½çš„å¯¹è±¡çš„å¼•ç”¨ã€‚ */ if(lazySingleton == null)&#123; /** LazyDoubleCheckSingleton = new LazyDoubleCheckSingleton() JVMä¸»è¦åšçš„äº‹ç²—ç•¥æ­¥éª¤å¦‚ä¸‹ï¼š * * 1. åœ¨å †ç©ºé—´é‡Œåˆ†é…å†…å­˜ç»™è¿™ä¸ªå¯¹è±¡ * 2. æ‰§è¡Œæ„é€ æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œæ³¨æ„æ­¤åˆå§‹åŒ–ä¸æ˜¯ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ– * 3. è®¾ç½®lazySingletonæŒ‡å‘åˆ†é…å¥½çš„å†…å­˜åœ°å€ * æ³¨æ„ï¼šåœ¨æ²¡æœ‰å¤„ç†æŒ‡ä»¤é‡æ’åºçš„æƒ…å†µä¸‹2ã€3ä¸¤æ­¥ç”±äºé‡æ’åºå¯èƒ½æ­¥éª¤ä¼šå€’ç½®ï¼ˆå› ä¸ºJavaè¯­è¨€è§„èŒƒï¼Œå…è®¸é‚£äº›åœ¨å•çº¿ç¨‹å†…ä¸ä¼šæ”¹å˜å•çº¿ç¨‹ç¨‹åºæ‰§è¡Œç»“æœçš„é‡æ’åºï¼Œå› ä¸ºæœ‰çš„é‡æ’åºå¯ä»¥æé«˜ç¨‹åºæ‰§è¡Œæ€§èƒ½ ï¼‰ï¼Œè¿™ä¼šå¯èƒ½ä¼šé€ æˆçº¿ç¨‹æ‹¿åˆ°çš„å¼•ç”¨æŒ‡å‘çš„æ˜¯ä¸€ä¸ªè¿˜æ²¡æœ‰åˆå§‹åŒ–å®Œæˆçš„å¯¹è±¡ï¼Œè™½ç„¶ä¸ä¸ºç©ºä½†å®ƒè¿˜æ²¡æœ‰æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œå¦‚æœæ°å·§æ„é€ æ–¹æ³•é‡Œé¢éœ€è¦å¯¹æŸäº›å‚æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œå½“ä½¿ç”¨è¿™ä¸ªå¯¹è±¡è¿˜æ²¡æœ‰åˆå§‹åŒ–çš„å‚æ•°æ—¶ä¼šå¯¼è‡´ç³»ç»Ÿå¼‚å¸¸ * * è¯¦ç»†çš„æ­¥éª¤å¦‚ä¸‹ï¼š * 1. å½“é‡åˆ°newæŒ‡ä»¤æ—¶ï¼Œä¼šå…ˆæ£€æŸ¥è¿™ä¸ªæŒ‡å®šçš„å‚æ•°ä¹Ÿå°±æ˜¯LazyDoubleCheckSingletonèƒ½å¦åœ¨å¸¸é‡æ± ä¸­å®šä½åˆ°è¯¥ç±»çš„ç¬¦å·å¼•ç”¨ï¼Œå¹¶ä¸”æ£€æŸ¥è¿™ä¸ªç¬¦å·å¼•ç”¨ä»£è¡¨çš„ç±»æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡ç±»çš„åŠ è½½ï¼ˆåŠ è½½ã€è§£æã€å‡†å¤‡å’Œåˆå§‹åŒ–ï¼‰ï¼Œå¦‚æœæ²¡æœ‰å°±æ‰§è¡Œä¸‹ä¸€æ­¥ï¼Œå¦‚æœæ‰§è¡Œäº†æ¥ç€è™šæ‹Ÿæœºä¸ºæ–°ç”Ÿå¯¹è±¡åˆ†é…å†…å­˜ï¼ˆæ­¤æ—¶ä»è™šæ‹Ÿæœºçš„è§†è§’æ¥è¯´ä¸€ä¸ªæ–°å¯¹è±¡å·²ç»äº§ç”Ÿäº†ï¼‰ï¼Œç´§æ¥ç€æ‰§è¡ŒnewæŒ‡ä»¤æ‰§è¡Œä¹‹åçš„è°ƒç”¨&lt;init&gt;æ–¹æ³•ã€‚ * 2. åŠ è½½ ï¼ˆ1 é€šè¿‡ç±»çš„å…¨é™å®šåè·å–å®šä¹‰æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ 2 å°†è¿™ä¸ªå­—èŠ‚æµä»£è¡¨çš„é™æ€å­˜å‚¨ç»“æ„è½¬åŒ–ä¸ºæ–¹æ³•åŒºçš„è¿è¡Œæ—¶æ•°æ®ç»“æ„å³Classä¸­çš„å¸¸é‡æ± è¿›å…¥æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ 3 åœ¨æ–¹æ³•åŒºç”Ÿæˆä¸€ä¸ªä»£è¡¨è¿™ä¸ªç±»çš„Classå¯¹è±¡ï¼‰ * 3. éªŒè¯ ï¼ˆç¡®ä¿Classæ–‡ä»¶çš„å­—èŠ‚æµä¸­åŒ…å«çš„ä¿¡æ¯ç¬¦åˆå½“å‰è™šæ‹Ÿæœºçš„è¦æ±‚ï¼Œç¡®ä¿è™šæ‹Ÿæœºè‡ªèº«å®‰å…¨ï¼‰ * 4. å‡†å¤‡ ï¼ˆåœ¨æ–¹æ³•åŒºä¸­ä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶è®¾ç½®ç±»å˜é‡åˆå§‹å€¼ï¼‰ * 5. è§£æ ï¼ˆå¯èƒ½ä¼šå‘ç”Ÿï¼Œå› ä¸ºå®ƒä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨åˆå§‹åŒ–é˜¶æ®µä¹‹åã€‚ ä¸»è¦ä½œç”¨å°±æ˜¯å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼‰ * 6. åˆå§‹åŒ– ï¼ˆè¿™æ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„æœ€åä¸€æ­¥ï¼Œä¸»è¦å°±æ˜¯æ‰§è¡Œç±»æ„é€ å™¨&lt;clinit&gt;æ–¹æ³•ï¼Œåˆå§‹åŒ–ç±»å˜é‡ï¼‰ * * æœ€åï¼šè®¾ç½®lazySingletonæŒ‡å‘åˆ†é…å¥½çš„å†…å­˜åœ°å€ */ lazySingleton = new LazyDoubleCheckSingleton(); &#125; &#125; &#125; return lazySingleton; &#125;&#125; æšä¸¾å¼å•ä¾‹æ¨¡å¼ 12345678910111213141516171819202122232425262728293031323334353637383940package com.design.pattern.singleton.enuminstance;/** * EnumInstance ä½¿ç”¨æšä¸¾çš„æ–¹å¼å®ç°å•ä¾‹æ¨¡å¼ * * 1. æšä¸¾å®é™…ä¸Šæ˜¯ä¸€ä¸ªç»§æ‰¿Enumçš„è¢«finalä¿®é¥°çš„ç±»ï¼Œå®ƒçš„æ„é€ æ–¹æ³•ï¼ˆåªæœ‰æœ‰å‚æ„é€ æ–¹æ³•ï¼‰ä¹Ÿæ˜¯ç§æœ‰çš„ã€‚å…¶ä¸­æšä¸¾å¸¸é‡ä¹Ÿæ˜¯static finalçš„ï¼Œå¹¶ä¸”åœ¨staticä»£ç å—ä¸­å®ä¾‹åŒ–ï¼ˆå’Œæ¶æ±‰å¼å¾ˆåƒï¼‰ * 2. æšä¸¾å®ç°çš„å•ä¾‹é˜²æ­¢äº†åºåˆ—åŒ–æ”»å‡»ï¼ˆreadObjectæ–¹æ³•æ‰§è¡Œè·å–çš„å¯¹è±¡æ˜¯å·²ç»å­˜åœ¨çš„æšä¸¾å¸¸é‡ï¼‰å’Œåå°„æ”»å‡»ï¼ˆæšä¸¾ç±»çš„æ„é€ å‡½æ•°ä¼šåˆ¤æ–­ï¼Œå¦‚æœé€šè¿‡åå°„è°ƒç”¨å°±æŠ›å‡ºå¼‚å¸¸ï¼‰ä»¥åŠçº¿ç¨‹å®‰å…¨ * 3. æ¨èä½¿ç”¨æšä¸¾å®ç°å•ä¾‹ * * @author shunhua * @date 2019-10-03 */public enum EnumInstance &#123; /** * æšä¸¾å¸¸é‡ */ INSTANCE; /** * æšä¸¾çš„æˆå‘˜å˜é‡ */ private Object data; public Object getData() &#123; return data; &#125; public void setData(Object data) &#123; this.data = data; &#125; /** * æš´éœ²ç»™å¤–éƒ¨çš„å…¨å±€ç‚¹ * * @return */ public static EnumInstance getInstance() &#123; return INSTANCE; &#125;&#125; 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105package com.design.pattern.singleton.enuminstance;import lombok.extern.slf4j.Slf4j;import java.io.*;import java.lang.reflect.Constructor;/** * EnumInstanceTest * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class EnumInstanceTest &#123; public static void main(String[] args) &#123; EnumInstance instance = EnumInstance.getInstance(); instance.setData(new Object()); try &#123; //------------------ æšä¸¾å®ç°çš„å•ä¾‹ï¼Œæ˜¯ä¸å—åºåˆ—åŒ–ç ´åçš„å½±å“---------------------/ File file = new File(\"singleton\"); // ä½¿ç”¨ObjectOutputStreamå¯¹è±¡è¾“å‡ºæµï¼ŒæŠŠå•ä¾‹å¯¹è±¡å†™å…¥æ–‡ä»¶ä¸­ã€‚æ³¨æ„æ–‡ä»¶çš„åç¼€åå¸¦ä¸å¸¦éƒ½è¡Œã€‚å¦‚æœä¸æŒ‡å®šæ–‡ä»¶çš„è·¯å¾„ï¼Œå°±é»˜è®¤ä½¿ç”¨å½“å‰å·¥ç¨‹çš„ç›®å½•ä½œä¸ºè·¯å¾„ ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(file)); // å°†å•ä¾‹å¯¹è±¡å†™å…¥æ–‡ä»¶ä¸­ objectOutputStream.writeObject(instance); // ä½¿ç”¨ObjectInputStreamå¯¹è±¡è¾“å…¥æµï¼ŒæŠŠæ–‡ä»¶ä¸­çš„å•ä¾‹å¯¹è±¡è¯»åˆ°å†…å­˜ä¸­ ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(file)); EnumInstance newInstance = (EnumInstance) objectInputStream.readObject(); /** readObjectæ–¹æ³•è°ƒç”¨çš„æ ¸å¿ƒæ–¹æ³•ï¼šè¿™ä¸ªé€»è¾‘ä¿è¯äº†å–å‡ºçš„æšä¸¾å¯¹è±¡çš„å”¯ä¸€æ€§ private Enum&lt;?&gt; readEnum(boolean unshared) throws IOException &#123; if (bin.readByte() != TC_ENUM) &#123; throw new InternalError(); &#125; ObjectStreamClass desc = readClassDesc(false); if (!desc.isEnum()) &#123; throw new InvalidClassException(\"non-enum class: \" + desc); &#125; int enumHandle = handles.assign(unshared ? unsharedMarker : null); ClassNotFoundException resolveEx = desc.getResolveException(); if (resolveEx != null) &#123; handles.markException(enumHandle, resolveEx); &#125; // è·å–æšä¸¾å¯¹è±¡çš„åç§°ï¼Œè¿™ä¸ªæ˜¯å”¯ä¸€çš„ï¼Œå®ƒå¯¹åº”ä¸€ä¸ªæšä¸¾å¸¸é‡ String name = readString(false); Enum&lt;?&gt; result = null; // è·å–æšä¸¾å¯¹è±¡çš„Class Class&lt;?&gt; cl = desc.forClass(); if (cl != null) &#123; try &#123; // é€šè¿‡æšä¸¾å¯¹è±¡çš„Classå’Œæšä¸¾å¯¹è±¡çš„åç§°è·å–å¯¹åº”çš„æšä¸¾å¸¸é‡ï¼Œæ²¡æœ‰åˆ›å»ºæ–°çš„å¯¹è±¡ @SuppressWarnings(\"unchecked\") Enum&lt;?&gt; en = Enum.valueOf((Class)cl, name); result = en; &#125; catch (IllegalArgumentException ex) &#123; throw (IOException) new InvalidObjectException( \"enum constant \" + name + \" does not exist in \" + cl).initCause(ex); &#125; if (!unshared) &#123; handles.setObject(enumHandle, result); &#125; &#125; handles.finish(enumHandle); passHandle = enumHandle; return result; &#125; */ log.info(\"instance: \" + instance); log.info(\"newInstance: \" + newInstance); log.info(String.format(\"instance [%s] newInstance\", instance == newInstance)); System.out.println(\"------------------------------------------\"); log.info(\"instance: \" + instance.getData()); log.info(\"newInstance: \" + newInstance.getData()); log.info(String.format(\"instance.data [%s] newInstance.data\", instance.getData() == newInstance.getData())); //-------------------------- æšä¸¾å®ç°çš„å•ä¾‹,ä¸å—åå°„ç ´åçš„å½±å“ï¼Œ ----------------/ Class enumClass = EnumInstance.class; Constructor constructor = enumClass.getDeclaredConstructor(); constructor.setAccessible(true); /** * é€šè¿‡åå°„è°ƒç”¨æšä¸¾çš„æ„é€ å™¨ï¼ˆæ„é€ å™¨åªæœ‰æœ‰å‚æ„é€ ï¼‰ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œé˜²æ­¢äº†åå°„æ”»å‡» */ &#125; catch (Exception e) &#123; log.info(e.getMessage()); &#125; &#125;&#125; å®¹å™¨å•ä¾‹æ¨¡å¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445package com.design.pattern.singleton.containersingleton;import org.apache.commons.lang3.StringUtils;import org.springframework.util.ObjectUtils;import java.util.Map;import java.util.concurrent.ConcurrentHashMap;/** * ContainerSingleton å®¹å™¨å•ä¾‹æ¨¡å¼ * * ç»Ÿä¸€ç®¡ç†å¤šä¸ªå®ä¾‹ï¼ŒèŠ‚çœèµ„æº * * @author shunhua * @date 2019-10-03 */public class ContainerSingleton &#123; /** * å­˜æ”¾å¯¹è±¡ï¼Œç›¸å½“äºä¸€ä¸ªç¼“å­˜ */ private static Map&lt;String,Object&gt; SINGLETON_MAP = new ConcurrentHashMap&lt;&gt;(); /** * å¤šçº¿ç¨‹æƒ…å†µä¸‹ä¸å®‰å…¨ï¼Œå¯èƒ½å¯¼è‡´å€¼çš„è¦†ç›– * @param key * @param instance */ public static void putInstance(String key,Object instance)&#123; if(StringUtils.isNotBlank(key) &amp;&amp; !ObjectUtils.isEmpty(instance))&#123; if(!SINGLETON_MAP.containsKey(key))&#123; SINGLETON_MAP.put(key,instance); &#125; &#125; &#125; /** * è·å–å¯¹è±¡ * @param key * @return */ public static Object getInstance(String key)&#123; return SINGLETON_MAP.get(key); &#125;&#125; é¥¿æ±‰å¼å•ä¾‹æ¨¡å¼ 1234567891011121314151617181920212223242526272829303132333435363738394041package com.design.pattern.singleton.hungry;/** * HungrySingleton é¥¿æ±‰å¼ * &lt;p&gt; * 1 ä¼˜ç‚¹ * å†™æ³•ç®€å•ï¼Œç±»åŠ è½½ï¼ˆä¸¥æ ¼æ¥è¯´æ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„åˆå§‹åŒ–é˜¶æ®µä»¥åŠè°ƒç”¨æ„é€ å‡½æ•°ï¼‰çš„æ—¶å€™å°±å®Œæˆäº†å¯¹è±¡çš„åˆ›å»ºï¼Œé¿å…äº†çº¿ç¨‹åŒæ­¥é—®é¢˜ * 2 ç¼ºç‚¹ * ç±»åŠ è½½çš„æ—¶å€™å°±å®Œæˆäº†å¯¹è±¡çš„åˆ›å»ºï¼Œæ²¡æœ‰å»¶è¿Ÿæ•ˆæœï¼Œå¦‚æœç±»çš„å¯¹è±¡ä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰ç”¨è¿‡ï¼Œæˆ–è€…åªæ˜¯æƒ³è·å–ç±»çš„æŸä¸ªç±»å˜é‡ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šåˆ›å»ºå¯¹è±¡ï¼Œè¿™æ— ç–‘é€ æˆäº†å†…å­˜çš„æµªè´¹ * * * @author shunhua * @date 2019-10-03 */public class HungrySingleton &#123; /** * ç§æœ‰æ„é€ å‡½æ•° */ private HungrySingleton() &#123; &#125; /** * å£°æ˜ä¸ºfinalçš„å˜é‡å¿…é¡»åœ¨ç±»åŠ è½½å®Œæˆæ—¶ï¼ˆå‡†ç¡®çš„æ˜¯ç±»åŠ è½½åˆå§‹åŒ–çš„æ—¶å€™ï¼Œsingletonå°±éœ€è¦è¢«èµ‹å€¼å³HungrySingletonå¯¹è±¡çš„å¼•ç”¨ï¼‰å°±å·²ç»èµ‹å€¼ */ // private final static HungrySingleton singleton = new HungrySingleton(); private final static HungrySingleton singleton; static &#123; singleton = new HungrySingleton(); &#125; /** * å…¨å±€è®¿é—®ç‚¹ * @return */ public static HungrySingleton getInstance() &#123; return singleton; &#125;&#125; ç ´åé¥¿æ±‰å¼å•ä¾‹-æ–¹å¼1 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.design.pattern.singleton.reflectattackresolve;/** * HungrySingleton é¥¿æ±‰å¼ * &lt;p&gt; * 1 ä¼˜ç‚¹ * å†™æ³•ç®€å•ï¼Œç±»åŠ è½½ï¼ˆä¸¥æ ¼æ¥è¯´æ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„åˆå§‹åŒ–é˜¶æ®µä»¥åŠè°ƒç”¨æ„é€ å‡½æ•°ï¼‰çš„æ—¶å€™å°±å®Œæˆäº†å¯¹è±¡çš„åˆ›å»ºï¼Œé¿å…äº†çº¿ç¨‹åŒæ­¥é—®é¢˜ * 2 ç¼ºç‚¹ * ç±»åŠ è½½çš„æ—¶å€™å°±å®Œæˆäº†å¯¹è±¡çš„åˆ›å»ºï¼Œæ²¡æœ‰å»¶è¿Ÿæ•ˆæœï¼Œå¦‚æœç±»çš„å¯¹è±¡ä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰ç”¨è¿‡ï¼Œæˆ–è€…åªæ˜¯æƒ³è·å–ç±»çš„æŸä¸ªç±»å˜é‡ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šåˆ›å»ºå¯¹è±¡ï¼Œè¿™æ— ç–‘é€ æˆäº†å†…å­˜çš„æµªè´¹ * * * @author shunhua * @date 2019-10-03 */public class HungrySingleton &#123; // private final static HungrySingleton singleton = new HungrySingleton(); private final static HungrySingleton singleton; /** * ç§æœ‰æ„é€ å‡½æ•° */ private HungrySingleton() &#123; if(singleton == null)&#123; System.out.println(\"è°ƒç”¨æ„é€ æ–¹æ³•åœ¨èµ‹å€¼å¼•ç”¨ç»™singletonä¹‹å‰ï¼Œè¿™æ˜¯æŒ‡ä»¤é‡æ’åºå¸¦æ¥çš„å¯èƒ½\"); &#125;else &#123; System.out.println(\"è°ƒç”¨æ„é€ æ–¹æ³•åœ¨èµ‹å€¼å¼•ç”¨ç»™singletonä¹‹åï¼Œè¿™æ˜¯æŒ‡ä»¤é‡æ’åºå¸¦æ¥çš„å¯èƒ½\"); &#125; &#125; /** * å£°æ˜ä¸ºfinalçš„å˜é‡å¿…é¡»åœ¨ç±»åŠ è½½å®Œæˆæ—¶ï¼ˆå‡†ç¡®çš„æ˜¯ç±»åŠ è½½åˆå§‹åŒ–çš„æ—¶å€™ï¼Œsingletonå°±éœ€è¦è¢«èµ‹å€¼å³HungrySingletonå¯¹è±¡çš„å¼•ç”¨ï¼‰å°±å·²ç»èµ‹å€¼ */ static &#123; singleton = new HungrySingleton(); &#125; /** * å…¨å±€è®¿é—®ç‚¹ * @return */ public static HungrySingleton getInstance() &#123; return singleton; &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849package com.design.pattern.singleton.reflectattackresolve;import lombok.extern.slf4j.Slf4j;import java.lang.reflect.Constructor;/** * HungrySingletonTest * * åå°„ç ´åå•ä¾‹æ¨¡å¼ä¸å®¹æ˜“å½»åº•é˜»æ­¢ï¼Œæ²¡æœ‰ç‰¹åˆ«å¥½çš„æ–¹å¼ã€‚ * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class HungrySingletonTest &#123; /** * å¯¹äºåœ¨ç±»åŠ è½½çš„æ•´ä¸ªè¿‡ç¨‹å®ä¾‹å°±èƒ½åˆ›å»ºå¥½çš„å•ä¾‹æ¨¡å¼ï¼ˆæ¶æ±‰å¼ã€é™æ€å†…éƒ¨ç±»ï¼‰ï¼Œä¸ºäº†é˜²æ­¢åå°„æ”»å‡»ï¼Œå¯ä»¥åœ¨æ„é€ æ–¹æ³•ä¸­è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯é€šè¿‡åå°„åˆ›å»ºå¯¹è±¡å°±æŠ›å‡ºå¼‚å¸¸ * * * @param args */ public static void main(String[] args) &#123; try &#123; // è·å–hungrySingletonçš„Classå¯¹è±¡ Class objectClass = HungrySingleton.class; // é€šè¿‡å…¨å±€è®¿é—®ç‚¹æ‹¿åˆ°å•ä¾‹å¯¹è±¡ HungrySingleton instance = HungrySingleton.getInstance(); // è·å–å£°æ˜çš„æ„é€ å™¨ Constructor constructor = objectClass.getDeclaredConstructor(); // å¼ºåˆ¶è®¾ç½®å£°æ˜çš„æ„é€ å™¨æ˜¯å¯ä»¥è®¿é—®çš„ constructor.setAccessible(true); // é€šè¿‡æ„é€ å™¨åå°„åˆ›å»ºå¯¹è±¡ HungrySingleton newInstance = (HungrySingleton) constructor.newInstance(); log.info(\"instance: \" + instance); log.info(\"newInstanceï¼š \" + newInstance); log.info(String.format(\"instance [%s] newInstance\",instance == newInstance)); &#125;catch (Exception e)&#123; log.info(e.getMessage()); &#125; &#125;&#125; ç ´åé¥¿æ±‰å¼å•ä¾‹-æ–¹å¼2 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758package com.design.pattern.singleton.serializationdestroysingleton;import java.io.Serializable;/** * HungrySingleton é¥¿æ±‰å¼ * &lt;p&gt; * 1 ä¼˜ç‚¹ * å†™æ³•ç®€å•ï¼Œç±»åŠ è½½ï¼ˆä¸¥æ ¼æ¥è¯´æ˜¯ç±»åŠ è½½è¿‡ç¨‹çš„åˆå§‹åŒ–é˜¶æ®µä»¥åŠè°ƒç”¨æ„é€ å‡½æ•°ï¼‰çš„æ—¶å€™å°±å®Œæˆäº†å¯¹è±¡çš„åˆ›å»ºï¼Œé¿å…äº†çº¿ç¨‹åŒæ­¥é—®é¢˜ * 2 ç¼ºç‚¹ * ç±»åŠ è½½çš„æ—¶å€™å°±å®Œæˆäº†å¯¹è±¡çš„åˆ›å»ºï¼Œæ²¡æœ‰å»¶è¿Ÿæ•ˆæœï¼Œå¦‚æœç±»çš„å¯¹è±¡ä»å§‹è‡³ç»ˆéƒ½æ²¡æœ‰ç”¨è¿‡ï¼Œæˆ–è€…åªæ˜¯æƒ³è·å–ç±»çš„æŸä¸ªç±»å˜é‡ï¼Œé‚£ä¹ˆè¿˜æ˜¯ä¼šåˆ›å»ºå¯¹è±¡ï¼Œè¿™æ— ç–‘é€ æˆäº†å†…å­˜çš„æµªè´¹ * 3 å®ç°Serializableï¼Œä¸ºäº†å®ç°åºåˆ—åŒ– * * @author shunhua * @date 2019-10-03 */public class HungrySingleton implements Serializable &#123; private static final long serialVersionUID = 1136799709809340054L; /** * ç§æœ‰æ„é€ å‡½æ•° */ private HungrySingleton() &#123; &#125; /** * å£°æ˜ä¸ºfinalçš„å˜é‡å¿…é¡»åœ¨ç±»åŠ è½½å®Œæˆæ—¶ï¼ˆå‡†ç¡®çš„æ˜¯ç±»åŠ è½½åˆå§‹åŒ–çš„æ—¶å€™ï¼Œsingletonå°±éœ€è¦è¢«èµ‹å€¼å³HungrySingletonå¯¹è±¡çš„å¼•ç”¨ï¼‰å°±å·²ç»èµ‹å€¼ */ // private final static HungrySingleton singleton = new HungrySingleton(); private final static HungrySingleton singleton; static &#123; singleton = new HungrySingleton(); &#125; /** * å…¨å±€è®¿é—®ç‚¹ * @return */ public static HungrySingleton getInstance() &#123; return singleton; &#125; /** * 1. å¯¹äºä½¿ç”¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–äº§ç”Ÿæ–°çš„å®ä¾‹çš„æ–¹å¼ç ´åäº†å•ä¾‹ï¼Œå¯ä»¥åœ¨ç±»ä¸­å¢åŠ readResolve()æ–¹æ³•æ¥é¢„é˜²ï¼ŒreadResolveï¼ˆï¼‰æ–¹æ³•è¿”å›å•ä¾‹å¯¹è±¡å³å¯ * 2. è¿™æ˜¯ååºåˆ—åŒ–æœºåˆ¶å†³å®šçš„ï¼Œåœ¨ååºåˆ—åŒ–çš„æ—¶å€™ä¼šåˆ¤æ–­ç±»å¦‚æœå®ç°äº†Serializableæˆ–è€…Externalizableæ¥å£åˆåŒ…å«readResolve()æ–¹æ³•çš„è¯ï¼Œä¼šç›´æ¥ * è°ƒç”¨readResolveï¼ˆï¼‰æ–¹æ³•æ¥è·å–å®ä¾‹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒreadObjectæ–¹æ³•åº•å±‚ä¼šå…ˆé€šè¿‡åå°„åˆ›å»ºä¸€ä¸ªæ–°çš„å•ä¾‹å®ä¾‹ï¼Œç„¶åå†é€šè¿‡åå°„è°ƒç”¨readResolveæ–¹ * æ³•è·å–å•ä¾‹å¯¹è±¡ã€‚å³è™½ç„¶æœ€åé€šè¿‡readResolveæ‹¿åˆ°çš„æ˜¯å·²ç»åˆ›å»ºå¥½çš„å¯¹è±¡ï¼Œä½†æœ¬è´¨ä¸Šè¿˜æ˜¯é€šè¿‡åå°„åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œåªæ˜¯è¿™ä¸ªæ–°çš„å¯¹è±¡æ˜¯ç”¨æ¥è°ƒç”¨readResolveæ–¹æ³• * è¿”å›å•ä¾‹å¯¹è±¡è€Œå·²ã€‚ * * * @return */ public Object readResolve()&#123; return singleton; &#125;&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546package com.design.pattern.singleton.serializationdestroysingleton;import lombok.extern.slf4j.Slf4j;import java.io.*;/** * HungrySingletonTest * * @author shunhua * @date 2019-10-03 */@Slf4jpublic class HungrySingletonTest &#123; public static void main(String[] args) &#123; HungrySingleton instance = HungrySingleton.getInstance(); try &#123; File file = new File(\"singleton\"); // ä½¿ç”¨ObjectOutputStreamå¯¹è±¡è¾“å‡ºæµï¼ŒæŠŠå•ä¾‹å¯¹è±¡å†™å…¥æ–‡ä»¶ä¸­ã€‚æ³¨æ„æ–‡ä»¶çš„åç¼€åå¸¦ä¸å¸¦éƒ½è¡Œã€‚å¦‚æœä¸æŒ‡å®šæ–‡ä»¶çš„è·¯å¾„ï¼Œå°±é»˜è®¤ä½¿ç”¨å½“å‰å·¥ç¨‹çš„ç›®å½•ä½œä¸ºè·¯å¾„ ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(file)); // å°†å•ä¾‹å¯¹è±¡å†™å…¥æ–‡ä»¶ä¸­ objectOutputStream.writeObject(instance); // ä½¿ç”¨ObjectInputStreamå¯¹è±¡è¾“å…¥æµï¼ŒæŠŠæ–‡ä»¶ä¸­çš„å•ä¾‹å¯¹è±¡è¯»åˆ°å†…å­˜ä¸­ ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(file)); /** * * å¦‚æœHungrySingletonç±»å®ç°äº†Serializableæˆ–è€…Externalizableæ¥å£ï¼Œé‚£ä¹ˆreadObjectæ–¹æ³•åº•å±‚ä¼šä½¿ç”¨åå°„ï¼Œè°ƒç”¨ObjectStreamClass#newInstanceæ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„å•ä¾‹å¯¹è±¡, * è¿™ä¸ªå•ä¾‹å¯¹è±¡æ˜¯ä¸ºäº†è°ƒç”¨å®ƒå¯¹åº”çš„ç±»ä¸­çš„readResolveæ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å®ç°é‚£ä¸¤ä¸ªæ¥å£ä¸­çš„ä»»ä½•ä¸€ä¸ªå°±ä¼šè¿”å›nullã€‚å³æ¥ç€ä¼šåˆ¤æ–­è¿™ä¸ªæ–°åˆ›å»ºçš„å•ä¾‹å¯¹è±¡ä¸­æœ‰æ²¡æœ‰readResolveæ–¹æ³•ï¼Œå¦‚æœ * æœ‰å°±ä¼šé€šè¿‡åå°„è°ƒç”¨è¿™ä¸ªreadResolveæ–¹æ³•ï¼Œæœ€ç»ˆreadObjectæ–¹æ³•è¿”å›çš„æ˜¯readResolveæ–¹æ³•è¿”å›çš„å¯¹è±¡ * */ HungrySingleton newInstance = (HungrySingleton) objectInputStream.readObject(); log.info(\"instance: \" + instance); log.info(\"newInstance: \" + newInstance); log.info(String.format(\"instance [%s] newInstance\", instance == newInstance)); &#125; catch (Exception e) &#123; &#125; &#125;&#125; é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455package com.design.pattern.singleton.staticinnerclass;/** * StaticInnerClassSingleton é™æ€å†…éƒ¨ç±»çš„å•ä¾‹æ¨¡å¼ ï¼Œä½¿ç”¨é™æ€å†…éƒ¨ç±»ä¹Ÿæ˜¯åšå»¶è¿Ÿåˆå§‹åŒ–å•ä¾‹å¯¹è±¡ï¼Œæ¥é™ä½å•ä¾‹å®ä¾‹çš„å¼€é”€å³åœ¨éœ€è¦çš„æ—¶å€™æ‰è¿›è¡Œåˆå§‹åŒ– * * @author shunhua * @date 2019-10-03 */public class StaticInnerClassSingleton &#123; /** * ç§æœ‰æ„é€ å™¨ä¸èƒ½å°‘ï¼Œé˜²æ­¢å¤–éƒ¨åˆ›å»ºå¯¹è±¡ï¼Œè®©å¤–éƒ¨åªèƒ½é€šè¿‡å…¨å±€è®¿é—®ç‚¹æ‹¿åˆ°å•ä¾‹å¯¹è±¡ */ private StaticInnerClassSingleton()&#123;&#125; /** * 1. è¿™ä¸ªé™æ€å†…éƒ¨ç±»è¦å£°æ˜ä¸ºç§æœ‰çš„ï¼Œå› ä¸ºåˆ›å»ºå¯¹è±¡åœ¨å®ƒé‡Œé¢ï¼Œä¸èƒ½è®©å¤–é¢è®¿é—®å®ƒ * 2. å¦‚æœç±»æ²¡æœ‰åˆå§‹åŒ–ï¼Œéœ€è¦ç±»ç«‹å³åˆå§‹åŒ–çš„å¸¸è§æƒ…å†µï¼š * ï¼ˆ1ï¼‰new ä¸€ä¸ªå¯¹è±¡ * ï¼ˆ2ï¼‰ç±»ä¸­å£°æ˜çš„é™æ€æ–¹æ³•è¢«è°ƒç”¨ * ï¼ˆ3ï¼‰ç±»ä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€æˆå‘˜è¢«èµ‹å€¼ * ï¼ˆ4ï¼‰ç±»ä¸­å£°æ˜çš„ä¸€ä¸ªé™æ€æˆå‘˜è¢«ä½¿ç”¨ï¼Œå¹¶ä¸”è¿™ä¸ªæˆå‘˜ä¸æ˜¯ä¸€ä¸ªå¸¸é‡ï¼ˆè¢«finalä¿®é¥°ï¼Œå·²åœ¨ç¼–è¯‘æœŸæŠŠç»“æœæ”¾å…¥å¸¸é‡æ± ä¸­çš„é™æ€å­—æ®µï¼‰ * ï¼ˆ5ï¼‰å¯¹ç±»è¿›è¡Œåå°„è°ƒç”¨ * ï¼ˆ6ï¼‰ä½œä¸ºçˆ¶ç±»ï¼ˆåŒ…æ‹¬æ¥å£ï¼‰ï¼Œå…¶å­ç±»è¢«åˆå§‹åŒ–äº†ï¼Œé‚£ä¹ˆçˆ¶ç±»éœ€è¦å…ˆåˆå§‹åŒ– * ï¼ˆ7ï¼‰æ‰§è¡Œçš„ä¸»ç±»ï¼ˆåŒ…å«mainæ–¹æ³•çš„ç±»ï¼‰ * * 3.ä½¿ç”¨é™æ€å†…éƒ¨ç±»åˆ›å»ºå•ä¾‹å¯¹è±¡åˆ©ç”¨äº†ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–é˜¶æ®µçš„ç‰¹æ€§ï¼š * è™šæ‹Ÿæœºä¼šä¿è¯ä¸€ä¸ªç±»çš„ç±»æ„é€ å™¨&lt;clinit&gt;æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­è¢«æ­£ç¡®åœ°åŠ ç±»çš„å¯¹è±¡åˆå§‹åŒ–é”ï¼ˆè¿™æ˜¯JVMå¸®æˆ‘ä»¬è‡ªåŠ¨å®Œæˆçš„ï¼‰ã€åŒæ­¥ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å»åˆå§‹åŒ–ä¸€ä¸ªç±»ï¼Œ * é‚£ä¹ˆåªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œè¿™ä¸ªç±»çš„ç±»æ„é€ å™¨æ–¹æ³•&lt;clinit&gt;ï¼Œå…¶ä»–çº¿ç¨‹éƒ½éœ€è¦é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æ´»åŠ¨çº¿ç¨‹æ‰§è¡Œ&lt;clinit&gt;æ–¹æ³•å®Œæ¯•ã€‚ * å› æ­¤ï¼Œå³ä½¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹æ‰§è¡Œ private static StaticInnerClassSingleton staticInnerClassSingleton = new StaticInnerClassSingleton()è¯­å¥ * ä¹Ÿä¸éœ€è¦å…³å¿ƒæŒ‡ä»¤é‡æ’åºçš„æƒ…å†µï¼Œå› ä¸ºåˆå§‹åŒ–é˜¶æ®µåœ¨å¯¹ç±»å˜é‡èµ‹å€¼çš„æ—¶å€™åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œ&lt;clinit&gt;æ–¹æ³•ï¼Œè€Œå•çº¿ç¨‹æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼ŒæŒ‡ä»¤æ˜¯å¦é‡æ’åºæ˜¯æ²¡æœ‰å½±å“çš„ã€‚ */ private static class InnerClass &#123; /** * 1. åˆå§‹åŒ–æ—¶ï¼Œéœ€è¦staticInnerClassSingletonèµ‹å€¼ï¼Œå³ new StaticInnerClassSingleton()ä¼šè¢«æ‰§è¡Œã€‚è¿™äº›éƒ½æ˜¯&lt;clinit&gt;æ–¹æ³•æ‰§è¡Œçš„ç»“æœï¼Œè€Œ&lt;clinit&gt;æ–¹æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œå³ä½¿è¿™ä¸ªæ–¹æ³•å†…éƒ¨æ¶‰åŠé‡æ’åºä¹Ÿå…³ç³»ã€‚ * 2. æ´»è·ƒçº¿ç¨‹åˆå§‹åŒ–ç±»ï¼ˆæ‰§è¡Œ&lt;clinit&gt;æ–¹æ³•ï¼‰å,ç±»å·²ç»åˆå§‹åŒ–å®Œæˆï¼Œä¸ä¼šå†è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶ä»–çº¿ç¨‹ç›´æ¥è®¿é—®ç±»æˆå‘˜å³å¯ */ private static StaticInnerClassSingleton staticInnerClassSingleton = new StaticInnerClassSingleton(); &#125; /** * å…¨å±€è®¿é—®ç‚¹ * * å½“æ‰§è¡ŒgetInstanceæ–¹æ³•æ—¶å°±å»è°ƒç”¨InnerClasså†…éƒ¨ç±»é‡Œé¢çš„staticInnerClassSingletonå®ä¾‹ï¼Œæ­¤æ—¶InnerClasså†…éƒ¨ç±»ä¼šè¢«åŠ è½½åˆ°å†…å­˜é‡Œï¼Œåœ¨ç±»åŠ è½½çš„æ—¶å€™å°±åˆ›å»ºå¯¹è±¡ï¼Œå’Œé¥¿æ±‰å¼ä¸€ä¸ªé“ç†ï¼Œä¿è¯äº†åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œ * è€Œä¸”åœ¨è°ƒç”¨getInstanceæ–¹æ³•æ—¶æ‰è¿›è¡Œå•ä¾‹çš„åˆ›å»ºï¼Œåˆå…·æœ‰æ‡’æ±‰å¼çš„éƒ¨åˆ†ç‰¹æ€§ã€‚ * @return */ public static StaticInnerClassSingleton getInstance() &#123; /** * å¤–éƒ¨è®¿é—®getInstanceè¿™ä¸ªå…¨å±€è®¿é—®ç‚¹æ—¶ï¼Œä¼šé—´æ¥è®¿é—®InnerClassçš„é™æ€æˆå‘˜ï¼Œè¿™ä¼šå¯¼è‡´é™æ€å†…éƒ¨ç±»è¢«åˆå§‹åŒ– */ return InnerClass.staticInnerClassSingleton; &#125;&#125; å•ä¾‹æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨jdk-RunTime 12345678910111213141516171819202122232425262728293031package java.lang;import java.io.*;import java.util.StringTokenizer;import sun.reflect.CallerSensitive;import sun.reflect.Reflection;/** * Every Java application has a single instance of class * &lt;code&gt;Runtime&lt;/code&gt; that allows the application to interface with * the environment in which the application is running. The current * runtime can be obtained from the &lt;code&gt;getRuntime&lt;/code&gt; method. * &lt;p&gt; * An application cannot create its own instance of this class. * * @author unascribed * @see java.lang.Runtime#getRuntime() * @since JDK1.0 */public class Runtime &#123; private static Runtime currentRuntime = new Runtime(); public static Runtime getRuntime() &#123; return currentRuntime; &#125; private Runtime() &#123;&#125; // ... çœç•¥å…¶ä»–æ–¹æ³•&#125; Spring-AbstractFactoryBean 12345678910111213141516171819202122232425262728@Overridepublic final T getObject() throws Exception &#123; if (isSingleton()) &#123; return (this.initialized ? this.singletonInstance : getEarlySingletonInstance()); &#125; else &#123; return createInstance(); &#125;&#125;/** * Determine an 'early singleton' instance, exposed in case of a * circular reference. Not called in a non-circular scenario. */@SuppressWarnings(\"unchecked\")private T getEarlySingletonInstance() throws Exception &#123; Class&lt;?&gt;[] ifcs = getEarlySingletonInterfaces(); if (ifcs == null) &#123; throw new FactoryBeanNotInitializedException( getClass().getName() + \" does not support circular references\"); &#125; if (this.earlySingletonInstance == null) &#123; this.earlySingletonInstance = (T) Proxy.newProxyInstance( this.beanClassLoader, ifcs, new EarlySingletonInvocationHandler()); &#125; return this.earlySingletonInstance;&#125; MyBatis-ErrorContext 12345678910111213141516171819202122232425262728293031323334public class ErrorContext &#123; private static final String LINE_SEPARATOR = System.getProperty(\"line.separator\",\"\\n\"); // åŸºäºThreadLocalçš„å•ä¾‹æ¨¡å¼ï¼Œå®ƒä¸æ˜¯æ•´ä¸ªåº”ç”¨å…¨å±€å”¯ä¸€è€Œæ˜¯çº¿ç¨‹çº§åˆ«å”¯ä¸€ï¼Œä¿è¯äº†æ¯ä¸ªçº¿ç¨‹å„è‡ªçš„é”™è¯¯ä¸Šä¸‹æ–‡ private static final ThreadLocal&lt;ErrorContext&gt; LOCAL = new ThreadLocal&lt;&gt;(); private ErrorContext stored; private String resource; private String activity; private String object; private String message; private String sql; private Throwable cause; /** * ç§æœ‰æ„é€ å™¨ */ private ErrorContext() &#123; &#125; /** * æ¯ä¸ªçº¿ç¨‹è·å–å„è‡ªçš„å¯¹è±¡ * @return */ public static ErrorContext instance() &#123; ErrorContext context = LOCAL.get(); if (context == null) &#123; context = new ErrorContext(); LOCAL.set(context); &#125; return context; &#125; // ... ç­‰ç­‰&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"ç­–ç•¥æ¨¡å¼","slug":"design_pattern/behaviour_type/ç­–ç•¥æ¨¡å¼","date":"2019-09-27T16:00:00.000Z","updated":"2020-08-09T09:28:54.518Z","comments":true,"path":"posts/72e3b671/","link":"","permalink":"https://gentryhuang.com/posts/72e3b671/","excerpt":"","text":"å®šä¹‰å®šä¹‰äº†ç®—æ³•å®¶æ—ï¼Œåˆ†åˆ«å°è£…èµ·æ¥ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥äº’ç›¸æ›¿æ¢ï¼Œæ­¤æ¨¡å¼è®©ç®—æ³•çš„å˜åŒ–ä¸ä¼šå½±å“åˆ°ä½¿ç”¨ç®—æ³•çš„ç”¨æˆ·ã€‚å³æŠŠä¸åŒçš„ç®—æ³•å°è£…åˆ°ä¸åŒçš„ç±»é‡Œé¢ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œ åº”ç”¨å±‚ä¸ä¼šå—åˆ°å½±å“ã€‚ ç±»å‹è¡Œä¸ºå‹ ä½¿ç”¨åœºæ™¯12341 ç³»ç»Ÿæœ‰å¾ˆå¤šç±»ï¼Œè€Œä»–ä»¬çš„åŒºåˆ«ä»…ä»…åœ¨äºå®ƒä»¬çš„è¡Œä¸ºä¸åŒ - ä½¿ç”¨ç­–ç•¥æ¨¡å¼å°±å¯ä»¥åŠ¨æ€åœ°è®©ä¸€ä¸ªå¯¹è±¡åœ¨å¤šä¸ªè¡Œä¸ºä¸­é€‰æ‹©ä¸€ç§è¡Œä¸ºï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬æŠŠè¿™ä¸ªå¯¹è±¡ä¸åŒçš„è¡Œä¸ºæ”¾åˆ°ä¸åŒçš„ç±»é‡Œé¢ï¼Œè€Œæ¯ä¸€ç§è¡Œä¸ºå¯¹åº”ç€ä¸€ç§ç­–ç•¥2 ä¸€ä¸ªç³»ç»Ÿéœ€è¦åŠ¨æ€åœ°åœ¨å‡ ç§ç®—æ³•ä¸­é€‰æ‹©ä¸€ç§ - è¿™é‡Œç®—æ³•å°±æ˜¯ç­–ç•¥ï¼Œç­–ç•¥é‡Œé¢å°è£…çš„å°±æ˜¯ä¸€ç³»åˆ—é€»è¾‘ä»¥åŠè®¡ç®—æ–¹å¼ ä¼˜ç‚¹1234561 ç¬¦åˆå¼€é—­åŸåˆ™ - ç­–ç•¥æ¨¡å¼æä¾›äº†å¯¹å¼€é—­åŸåˆ™çš„å®Œç¾æ”¯æŒï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸ä¿®æ”¹åŸæœ‰ç³»ç»Ÿçš„åŸºç¡€ä¸Šé€‰æ‹©å…·ä½“çš„è¡Œä¸º2 é¿å…ä½¿ç”¨å¤šé‡æ¡ä»¶è½¬ç§»è¯­å¥ - å¤§é‡çš„if...else, switchã€‚ æˆ‘ä»¬æŠŠå…·ä½“çš„ç­–ç•¥è¡Œä¸ºåˆ†ç¦»ä¸ºä¸€ä¸ªä¸€ä¸ªçš„å•ç‹¬çš„ç±»æ¥æ›¿æ¢if...elseé‡Œé¢çš„é€»è¾‘ï¼Œè¿™æ ·å†™ä¹Ÿå¯ä»¥é™ä½ä»£ç çš„è€¦åˆ3 æé«˜ç®—æ³•çš„ä¿å¯†æ€§å’Œå®‰å…¨æ€§ - åœ¨ä½¿ç”¨çš„æ—¶å€™æˆ‘ä»¬åªçŸ¥é“ç­–ç•¥çš„åŠŸèƒ½ï¼Œä¸éœ€è¦çŸ¥é“å…·ä½“çš„ç»†èŠ‚ã€‚åœ¨å…·ä½“çš„ç­–ç•¥ç±»ä¸­å°è£…äº†ä¸åŒçš„è¡Œä¸ºå’Œç®—æ³•ä»¥åŠç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œå¯¹äºåº”ç”¨å±‚æ¥è¯´ï¼Œæ˜¯ä¸éœ€è¦çŸ¥é“å†…éƒ¨çš„ç»†èŠ‚çš„ã€‚æ¯”å¦‚ä½¿ç”¨Dubboçš„æœåŠ¡æä¾›è€…ï¼Œä¸éœ€è¦çŸ¥é“å†…éƒ¨é€»è¾‘çš„ç»†èŠ‚ã€‚ ç¼ºç‚¹121 åº”ç”¨å±‚å¿…é¡»çŸ¥é“æ‰€æœ‰çš„ç­–ç•¥ç±»ï¼Œå¹¶è‡ªè¡Œå†³å®šä½¿ç”¨å“ªä¸€ä¸ªç­–ç•¥ç±»2 äº§ç”Ÿå¾ˆå¤šç­–ç•¥ç±» ç­–ç•¥æ¨¡å¼ç›¸å…³çš„è®¾è®¡æ¨¡å¼ç­–ç•¥æ¨¡å¼å’Œå·¥å‚æ¨¡å¼ 121 å·¥å‚æ¨¡å¼æ˜¯åˆ›å»ºå‹çš„è®¾è®¡æ¨¡å¼ï¼Œç­–ç•¥æ¨¡å¼æ˜¯è¡Œä¸ºå‹çš„è®¾è®¡æ¨¡å¼2 å·¥å‚æ¨¡å¼æ¥å—æŒ‡ä»¤ï¼Œåˆ›å»ºç¬¦åˆè¦æ±‚çš„å¯¹è±¡ã€‚ç­–ç•¥æ¨¡å¼æ¥å—åˆ›å»ºå¥½çš„å¯¹è±¡ï¼Œä»è€Œå®ç°ä¸åŒçš„è¡Œä¸º ç­–ç•¥æ¨¡å¼å’ŒçŠ¶æ€æ¨¡å¼ 121 ä½¿ç”¨ç­–ç•¥æ¨¡å¼çš„æ—¶å€™ï¼Œåº”ç”¨å±‚éœ€è¦çŸ¥é“åº”è¯¥é€‰æ‹©å“ªä¸€ç§ç­–ç•¥ã€‚åœ¨ä½¿ç”¨çŠ¶æ€æ¨¡å¼çš„æ—¶å€™ï¼Œåº”ç”¨å±‚æ˜¯ä¸éœ€è¦å…³å¿ƒå…·ä½“çš„çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€ä¼šè‡ªåŠ¨è½¬æ¢2 å¦‚æœç³»ç»Ÿä¸­æŸä¸ªç±»çš„å¯¹è±¡å­˜åœ¨å¤šç§çŠ¶æ€ï¼Œä¸åŒçŠ¶æ€ä¸‹è¡Œä¸ºåˆæœ‰å·®å¼‚ï¼Œè€Œä¸”è¿™äº›çŠ¶æ€å¯ä»¥å‘ç”Ÿè½¬æ¢æ—¶å¯ä»¥ä½¿ç”¨çŠ¶æ€æ¨¡å¼ã€‚å¦‚æœç³»ç»Ÿä¸­æŸä¸ªç±»çš„æŸç§è¡Œä¸ºå­˜åœ¨å¤šç§å®ç°æ–¹å¼ï¼Œå¦‚ä¿ƒé”€æ˜¯ä¸ªè¡Œä¸ºï¼Œè¿™ç§è¡Œä¸ºå°±æœ‰å¤šç§å®ç°æ–¹å¼ï¼Œè¿™ç§æƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨ç­–ç•¥æ¨¡å¼ã€‚ ç®€å•éœ€æ±‚å½“å½“ç½‘åœ¨åŒåä¸€æˆ–è€…618çš„æ—¶å€™ä¼šæœ‰å¾ˆå¤šçš„ä¿ƒé”€æ´»åŠ¨ï¼Œä¿ƒé”€æ˜¯ä¹¦ç±çš„ä¸€ä¸ªè¡Œä¸ºï¼Œè¿™ä¸ªä¿ƒé”€è¡Œä¸ºæœ‰å¤šç§å®ç°ã€‚ ç­–ç•¥æ¨¡å¼æ¼”ç»ƒæœ€åŸºæœ¬çš„ä½¿ç”¨ ç­–ç•¥çˆ¶ç±»å‹ï¼ˆè¿™é‡Œæ˜¯æ¥å£çš„æ–¹å¼ï¼‰ 12345678910111213package com.design.pattern.strategy.base;/** * PromotionStrategy ä¿ƒé”€ç­–ç•¥çˆ¶ç±»å‹ * @author shunhua * @date 2019-09-28 */public interface PromotionStrategy &#123; /** * è¿›è¡Œä¿ƒé”€ */ void doPromotion();&#125; å…·ä½“ç­–ç•¥å®ä¾‹ å‘ç°ç­–ç•¥ 123456789101112131415161718192021package com.design.pattern.strategy.base;import lombok.extern.slf4j.Slf4j;/** * FanXianPromotionStrategy è¿”ç°ï¼ˆæ”¯ä»˜é‡‘é¢è¾¾åˆ°ä¸€å®šæ•°é¢è¿›è¡Œè¿”ç°åˆ°è´¦å·ï¼‰ç­–ç•¥ * * @author shunhua * @date 2019-09-28 */@Slf4jpublic class FanXianPromotionStrategy implements PromotionStrategy &#123; /** * ä¿ƒé”€ */ @Override public void doPromotion() &#123; log.info(\"è¿”ç°ä¿ƒé”€ï¼Œè¿”å›çš„é‡‘é¢å­˜æ”¾åˆ°è´¦å·çš„ä½™é¢ä¸­\"); &#125;&#125; ç«‹å‡ä¼˜æƒ ç­–ç•¥ 123456789101112131415161718192021package com.design.pattern.strategy.base;import lombok.extern.slf4j.Slf4j;/** * LiJianPromotionStrategy ç«‹å‡ï¼ˆä¸‹å•ç«‹å‡ä¸€å®šçš„é‡‘é¢ï¼‰ç­–ç•¥ * * @author shunhua * @date 2019-09-28 */@Slf4jpublic class LiJianPromotionStrategy implements PromotionStrategy &#123; /** * ä¿ƒé”€ */ @Override public void doPromotion() &#123; log.info(\"ç«‹å‡ä¿ƒé”€ï¼Œä¹¦ç±çš„ä»·æ ¼ç›´æ¥å‡å»ç«‹å‡æ´»åŠ¨è®¾ç½®çš„ä»·æ ¼\"); &#125;&#125; æ»¡å‡ç­–ç•¥ 123456789101112131415161718192021package com.design.pattern.strategy.base;import lombok.extern.slf4j.Slf4j;/** * ManJianPromotionStrategy æ»¡å‡ï¼ˆå½“æ”¯ä»˜é‡‘é¢è¾¾åˆ°è§„å®šçš„æœ€ä½æ•°å°±è¿›è¡Œä¼˜æƒ ï¼‰ç­–ç•¥ * * @author shunhua * @date 2019-09-28 */@Slf4jpublic class ManJianPromotionStrategy implements PromotionStrategy &#123; /** * ä¿ƒé”€ */ @Override public void doPromotion() &#123; log.info(\"æ»¡å‡ä¿ƒé”€ï¼Œæ»¡200å‡50\"); &#125;&#125; ç­–ç•¥åŒ…è£…ç±» 1234567891011121314151617181920212223242526package com.design.pattern.strategy.base;/** * PromotionActivity ä¿ƒé”€æ´»åŠ¨ï¼ŒåŒ…è£…ï¼ˆä½¿ç”¨ï¼‰ç­–ç•¥æ¨¡å¼ * * @author shunhua * @date 2019-09-28 */public class PromotionActivity &#123; /** * ä¿ƒé”€ç­–ç•¥ */ private PromotionStrategy promotionStrategy; public PromotionActivity(PromotionStrategy promotionStrategy)&#123; this.promotionStrategy = promotionStrategy; &#125; /** * æ‰§è¡Œå…·ä½“çš„ä¿ƒé”€ç­–ç•¥ */ public void execute()&#123; promotionStrategy.doPromotion(); &#125;&#125; åº”ç”¨å±‚ 12345678910111213141516171819202122232425262728293031package com.design.pattern.strategy.base;import com.design.pattern.strategy.base.FanXianPromotionStrategy;import com.design.pattern.strategy.base.ManJianPromotionStrategy;import com.design.pattern.strategy.base.PromotionActivity;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-28 */public class Client &#123; @Test public void test()&#123; /** * 618æ»¡å‡æ´»åŠ¨ç­–ç•¥ */ PromotionActivity activity618 = new PromotionActivity(new ManJianPromotionStrategy()); /** * åŒ11 è¿”ç°æ´»åŠ¨ç­–ç•¥ */ PromotionActivity activity11 = new PromotionActivity(new FanXianPromotionStrategy()); activity618.execute(); activity11.execute(); &#125;&#125; å°ç»“ 1è¿™æ˜¯ç­–ç•¥æ¨¡å¼çš„ç®€å•ä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ‰©å±•æ€§æ¯”è¾ƒå¥½ï¼Œæƒ³å¢åŠ ç­–ç•¥å¾ˆæ–¹ä¾¿ã€‚ åŸºæœ¬ä½¿ç”¨æ¼”è¿›åº”ç”¨å±‚ 123456789101112131415161718192021222324252627282930313233343536package com.design.pattern.strategy.v1;import org.junit.Test;import org.springframework.util.ObjectUtils;/** * Client * * @author shunhua * @date 2019-09-28 */public class Client &#123; @Test public void test()&#123; PromotionActivity activity ; // åº”ç”¨å±‚å‚æ•° String promotion = \"FANXIAN\"; switch (promotion)&#123; case \"FANXIAN\" : activity = new PromotionActivity(new FanXianPromotionStrategy()); break; case \"LIJIAN\": activity = new PromotionActivity(new LiJianPromotionStrategy()); break; case \"MANJIAN\": activity = new PromotionActivity(new ManJianPromotionStrategy()); break; default: activity = null; &#125; if(!ObjectUtils.isEmpty(activity))&#123; activity.execute(); &#125; &#125;&#125; å°ç»“ 12è¿™ç§æ–¹å¼å’Œåº”ç”¨äº¤äº’å®¹æ˜“ä½¿ä»£ç è¿‡äºè‡ƒè‚¿ï¼Œå› ä¸ºæ¯æ¬¡éœ€è¦çš„æ—¶å€™éƒ½ä¼šåˆ›å»ºç­–ç•¥å¯¹è±¡å’ŒåŒ…è£…ç­–ç•¥çš„å¯¹è±¡ï¼Œå¹¶ä¸”è¿‡å¤šçš„é€‰æ‹©åˆ¤æ–­ï¼Œæ•´ä¸ªä»£ç çœ‹èµ·æ¥ä¸ä¼˜é›…ã€‚ ä¼˜åŒ–åç‰ˆæœ¬ç­–ç•¥å·¥å‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657package com.design.pattern.strategy.v2;import java.util.Map;import java.util.concurrent.ConcurrentHashMap;/** * PromotionStrategyFactory ä¿ƒé”€ç­–ç•¥å·¥å‚ * * @author shunhua * @date 2019-09-28 */public class PromotionStrategyFactory &#123; /** * ç­–ç•¥é›†åˆ */ private final static Map&lt;String,PromotionStrategy&gt; PROMOTION_STRATEGY_MAP = new ConcurrentHashMap&lt;&gt;(); /** * ç±»åŠ è½½çš„æ—¶å€™å°±å¼€å§‹åˆ›å»ºå¯¹è±¡ */ static &#123; PROMOTION_STRATEGY_MAP.put(PromotionKey.LIJIAN_STRATEGY,new LiJianPromotionStrategy()); PROMOTION_STRATEGY_MAP.put(PromotionKey.FANXIAN_STRATEGY,new FanXianPromotionStrategy()); PROMOTION_STRATEGY_MAP.put(PromotionKey.MANJIAN_STRATEGY,new ManJianPromotionStrategy()); &#125; /** * å•ä¾‹çš„ */ private PromotionStrategyFactory()&#123;&#125; /** * æ ¹æ®ç­–ç•¥æ¨¡å¼åè·å–å¯¹åº”çš„ç­–ç•¥ * @param strategy * @return */ public static PromotionStrategy getPromotionStrategy(String strategy)&#123; return PROMOTION_STRATEGY_MAP.get(strategy); &#125; private interface PromotionKey&#123; /** * ç«‹å‡ç­–ç•¥ */ String LIJIAN_STRATEGY = \"LIJIAN\"; /** * æ»¡å‡ç­–ç•¥ */ String MANJIAN_STRATEGY = \"LIJIAN\"; /** * è¿”ç°ç­–ç•¥ */ String FANXIAN_STRATEGY = \"FANXIAN\"; &#125;&#125; åº”ç”¨å±‚ 123456789101112131415161718192021222324package com.design.pattern.strategy.v2;import org.junit.Test;import org.springframework.util.ObjectUtils;/** * Client * * @author shunhua * @date 2019-09-28 */public class Client &#123; @Test public void test()&#123; // åº”ç”¨å±‚å‚æ•° String promotion = \"FANXIAN\"; // ä½¿ç”¨å·¥å‚æ¨¡å¼ PromotionActivity activity = new PromotionActivity(PromotionStrategyFactory.getPromotionStrategy(promotion)); if(!ObjectUtils.isEmpty(activity))&#123; activity.execute(); &#125; &#125;&#125; å°ç»“ 121. ä½¿ç”¨ç­–ç•¥å·¥å‚é˜²æ­¢ç­–ç•¥å¯¹è±¡é¢‘ç¹åˆ›å»º2. ç­–ç•¥æ¨¡å¼å¸¸å¸¸ç»“åˆå•ä¾‹ã€å·¥å‚ä»¥åŠäº«å…ƒæ¨¡å¼ç­‰ä½¿ç”¨ ç­–ç•¥æ¨¡å¼æºç è§£æjdkçš„Comparator 1Comparatorå°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒç­–ç•¥æ¥å£ï¼Œå®ƒæœ‰å¾ˆå¤šçš„å®ç°ï¼Œä¹Ÿæ”¯æŒè‡ªå®šä¹‰ç­–ç•¥ï¼Œè¿™äº›ç­–ç•¥å®ç°å°±æ˜¯ä¸€ä¸ªä¸ªç­–ç•¥ã€‚ 12345678910111213141516171819 /** * æ’åºä¼šæ ¹æ®å…·ä½“çš„æ’åºç­–ç•¥æ‰§è¡Œ * @since 1.8 */@SuppressWarnings(\"unchecked\")public static &lt;T&gt; void parallelSort(T[] a, Comparator&lt;? super T&gt; cmp) &#123; if (cmp == null) cmp = NaturalOrder.INSTANCE; int n = a.length, p, g; if (n &lt;= MIN_ARRAY_SORT_GRAN || (p = ForkJoinPool.getCommonPoolParallelism()) == 1) TimSort.sort(a, 0, n, cmp, null, 0, 0); else new ArraysParallelSortHelpers.FJObject.Sorter&lt;T&gt; (null, a, (T[])Array.newInstance(a.getClass().getComponentType(), n), 0, n, 0, ((g = n / (p &lt;&lt; 2)) &lt;= MIN_ARRAY_SORT_GRAN) ? MIN_ARRAY_SORT_GRAN : g, cmp).invoke(); &#125; Springçš„Resource 1Resourceæ˜¯èµ„æºè®¿é—®æ¥å£ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªèµ„æºè®¿é—®ç›¸å…³çš„ç­–ç•¥æ¥å£ï¼Œå®ƒæœ‰å¾ˆå¤šçš„å®ç°ç±»ï¼Œä¹Ÿå°±æ„å‘³ç€æœ‰å¾ˆå¤šè®¿é—®èµ„æºçš„ç­–ç•¥ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package org.springframework.core.io;import java.io.File;import java.io.IOException;import java.net.URI;import java.net.URL;import java.nio.channels.Channels;import java.nio.channels.ReadableByteChannel;import org.springframework.lang.Nullable;public interface Resource extends InputStreamSource &#123; boolean exists(); default boolean isReadable() &#123; return this.exists(); &#125; default boolean isOpen() &#123; return false; &#125; default boolean isFile() &#123; return false; &#125; URL getURL() throws IOException; URI getURI() throws IOException; File getFile() throws IOException; default ReadableByteChannel readableChannel() throws IOException &#123; return Channels.newChannel(this.getInputStream()); &#125; long contentLength() throws IOException; long lastModified() throws IOException; Resource createRelative(String var1) throws IOException; @Nullable String getFilename(); String getDescription();&#125; Springçš„InstantiationStrategy 1Springåˆå§‹åŒ–ç­–ç•¥æ¥å£ï¼Œå®ƒçš„å®ç°ç±»ï¼šSimpleInstantiationStrategyå’ŒCglibSubclassingInstantiationStrategyåˆå§‹åŒ–ç­–ç•¥","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼","slug":"design_pattern/behaviour_type/æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼","date":"2019-09-26T16:00:00.000Z","updated":"2020-08-09T09:27:55.252Z","comments":true,"path":"posts/5029c2a3/","link":"","permalink":"https://gentryhuang.com/posts/5029c2a3/","excerpt":"","text":"å®šä¹‰å®šä¹‰äº†ä¸€ä¸ªç®—æ³•çš„éª¨æ¶ï¼Œå¹¶å…è®¸å­ç±»ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªæ­¥éª¤æä¾›å®ç°ã€‚æ¨¡ç‰ˆæ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥åœ¨ä¸æ”¹å˜ç®—æ³•ç»“æ„çš„æƒ…å†µä¸‹ï¼Œé‡æ–°å®šä¹‰ç®—æ³•çš„æŸäº›æ­¥éª¤ã€‚ ç±»å‹è¡Œä¸ºå‹ ä½¿ç”¨åœºæ™¯12â—† å„å­ç±»ä¸­å…¬å…±çš„è¡Œä¸ºè¢«æå–å‡ºæ¥å¹¶é›†ä¸­åˆ°ä¸€ä¸ªå…¬å…±çˆ¶ç±»ä¸­ï¼Œä»è€Œé¿å…ä»£ç é‡å¤â—† ä¸€æ¬¡æ€§å®ç°ä¸€ä¸ªç®—æ³•çš„ä¸å˜çš„éƒ¨åˆ†ï¼Œå¹¶å°†å¯å˜çš„è¡Œä¸ºç•™ç»™å­ç±»æ¥å®ç° ä¼˜ç‚¹123â—†æé«˜å¤ç”¨æ€§ï¼ˆå°†ç›¸åŒä»£ç éƒ¨åˆ†æ”¾åˆ°æŠ½è±¡çˆ¶ç±»ä¸­ï¼‰â—†æé«˜æ‰©å±•æ€§â—†ç¬¦åˆå¼€é—­åŸåˆ™ ç¼ºç‚¹123â—†ç»§æ‰¿å…³ç³»è‡ªèº«ç¼ºç‚¹ï¼Œå¦‚æœçˆ¶ç±»æ·»åŠ æ–°çš„æŠ½è±¡æ–¹æ³•ï¼Œæ‰€æœ‰å­ç±»éƒ½è¦æ”¹ä¸€éâ—†ç±»æ•°ç›®å¢åŠ â—†å¢åŠ äº†ç³»ç»Ÿå®ç°çš„å¤æ‚åº¦ æ¨¡ç‰ˆæ–¹æ³•æ‰©å±• æ¨¡ç‰ˆæ–¹æ³•ä¸­æœ‰ä¸€ä¸ªå®šä¹‰ï¼šé’©å­æ–¹æ³•ã€‚å®ƒæä¾›äº†ç¼ºçœçš„è¡Œä¸ºï¼Œå­ç±»å¯ä»¥åœ¨å¿…è¦æ—¶è¿›è¡Œæ‰©å±•ï¼Œåˆ©ç”¨å®ƒå’Œçˆ¶ç±»äº¤äº’ã€‚å³æ„é€ æ–¹æ³•æ˜¯è¿™ä¸ªæ¨¡ç‰ˆå¯¹å­ç±»æ›´è¿›ä¸€æ­¥çš„å¼€æ”¾ä»¥åŠæ‰©å±•ã€‚ ç›¸å…³çš„è®¾è®¡æ¨¡å¼æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å’Œå·¥å‚æ–¹æ³•æ¨¡å¼ å·¥å‚æ–¹æ³•æ˜¯æ¨¡ç‰ˆæ–¹æ³•çš„ä¸€ç§ç‰¹æ®Šå®ç° æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼å’Œç­–ç•¥æ¨¡å¼ æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼ä¸æ”¹å˜ç®—æ³•æµç¨‹ï¼Œç­–ç•¥æ¨¡å¼å¯ä»¥æ”¹å˜ç®—æ³•æµç¨‹ï¼Œå¹¶ä¸”ç­–ç•¥æ–¹æ³•ä¹‹é—´æ˜¯å¯ä»¥ç›¸äº’æ›¿æ¢çš„ã€‚ç­–ç•¥æ¨¡å¼çš„ç›®çš„æ˜¯ä½¿ä¸åŒçš„ç®—æ³•å¯ä»¥ç›¸äº’æ›¿æ¢ï¼Œå¹¶ä¸”ä¸å½±å“åº”ç”¨å±‚å®¢æˆ·ç«¯çš„ä½¿ç”¨ã€‚æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯é’ˆå¯¹å®šä¹‰ä¸€ä¸ªç®—æ³•çš„æµç¨‹ï¼Œå°†ä¸€äº›ä¸å¤ªä¸€æ ·çš„å…·ä½“æ­¥éª¤äº¤ç»™å­ç±»å»å®ç°ã€‚ ç®€å•éœ€æ±‚æŸæœºæ„è¦åˆ¶ä½œä¸€é—¨è¯¾ç¨‹ï¼Œåˆ¶ä½œè¿™ä¸ªè¯¾ç¨‹éœ€è¦ä¸€å®šçš„æ­¥éª¤ï¼Œç”±äºè¯¾ç¨‹çš„ç§ç±»ä¸åŒå¯èƒ½æŸä¸ªæ­¥éª¤ä¸åŒï¼Œä½†æ˜¯æ•´ä½“æ­¥éª¤éƒ½æ˜¯ä¸€è‡´çš„ã€‚ æ¨¡ç‰ˆæ–¹æ³•æ¼”ç»ƒ æŠ½è±¡è¯¾ç¨‹ç±» 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package com.design.pattern.template;import lombok.extern.slf4j.Slf4j;/** * Course è¯¾ç¨‹æŠ½è±¡ç±» * * @author shunhua * @date 2019-09-27 */@Slf4jpublic abstract class Course &#123; /** * æ¨¡ç‰ˆæ–¹æ³• å®šä¹‰æµç¨‹çš„ * 1 è¯¥æ–¹æ³•çš„æµç¨‹æ˜¯å›ºå®šçš„ï¼Œæœ‰äº›æ­¥éª¤çš„ç»†èŠ‚å¯èƒ½å› å­ç±»ä¸åŒ * 2 è¯¥æ–¹æ³•å¿…é¡»ç”³æ˜ä¸ºfinalï¼Œå­ç±»ä¸èƒ½é‡å†™ã€‚ */ protected final void makeCourse()&#123; // åˆ¶ä½œPPT makePPT(); // åˆ¶ä½œè§†é¢‘ makeVideo(); // é€šè¿‡æ„é€ æ–¹æ³•å®ç°æ‰€éœ€é€»è¾‘ if(needMakeArticle())&#123; // ç¼–å†™æ‰‹ç¨¿ makeArticle(); &#125; // æ‰“åŒ…è¯¾ç¨‹ä¸Šçº¿ packageCourse(); &#125; /** * åˆ¶ä½œPPTæ˜¯å…±æœ‰çš„æ–¹æ³•ï¼Œå› æ­¤æ˜¯å›ºå®šçš„ï¼Œå­ç±»ä¸éœ€è¦æœ‰è‡ªå·±çš„å®ç° */ final void makePPT()&#123; log.info(\"åˆ¶ä½œppt\"); &#125; /** * åˆ¶ä½œè§†é¢‘æ˜¯å…±æœ‰çš„æ–¹æ³•ï¼Œå› æ­¤æ˜¯å›ºå®šçš„ï¼Œå­ç±»ä¸éœ€è¦æœ‰è‡ªå·±çš„å®ç° */ final void makeVideo()&#123; log.info(\"åˆ¶ä½œè§†é¢‘\"); &#125; /** * ç¼–å†™æ‰‹è®°ï¼Œè¿™ä¸ªæ˜¯å›ºå®šçš„ä¸éœ€è¦ä¹‹ç±»æœ‰è‡ªå·±çš„å®ç°ï¼Œä¸è¿‡å®ƒä¸ä¸€å®šæ˜¯å…±æœ‰çš„ï¼Œéœ€è¦çœ‹æƒ…å†µ */ final void makeArticle()&#123; log.info(\"ç¼–å†™æ‰‹è®°\"); &#125; /** * é’©å­æ–¹æ³• å­ç±»å¯ä»¥é‡å†™ç”¨æ¥è·Ÿçˆ¶ç±»äº¤äº’çš„ã€‚é»˜è®¤æ˜¯falseï¼Œä¸éœ€è¦æ‰‹è®° */ protected boolean needMakeArticle()&#123; return false; &#125; /** * æ‰“åŒ…è¯¾ç¨‹çš„æ–¹æ³•ï¼Œä¸åŒçš„è¯¾ç¨‹å¯èƒ½åŒ…è£…çš„ä¸ä¸€æ ·ï¼Œæ ¹æ®å­ç±»æƒ…å†µé‡å†™ */ abstract void packageCourse();&#125; è¯¾ç¨‹ç±»1 123456789101112131415161718192021package com.design.pattern.template;import lombok.extern.slf4j.Slf4j;/** * FECourse * * @author shunhua * @date 2019-09-27 */@Slf4jpublic class FECourse extends Course &#123; /** * é‡å†™æ‰“åŒ…è¯¾ç¨‹çš„æ–¹æ³• */ @Override void packageCourse() &#123; log.info(\"æä¾›å‰ç«¯è¯¾ç¨‹çš„æºä»£ç å’Œå›¾ç‰‡ç´ æ\"); &#125;&#125; è¯¾ç¨‹ç±»2 1234567891011121314151617181920212223242526272829303132333435363738package com.design.pattern.template;import lombok.extern.slf4j.Slf4j;/** * JvmCource * * @author shunhua * @date 2019-09-27 */@Slf4jpublic class JvmCource extends Course &#123; private boolean flag = Boolean.FALSE; /** * é€šè¿‡æ„é€ æ–¹æ³•è®¾ç½®é’©å­æ–¹æ³•çš„å‚æ•°ï¼ŒæŠŠé’©å­æ–¹æ³•å¼€æ”¾ç»™å®¢æˆ·ç«¯æ›´åŠ çµæ´» * * @param flag */ public JvmCource(boolean flag)&#123; this.flag = flag; &#125; @Override void packageCourse() &#123; log.info(\"Jvmè¯¾ç¨‹æä¾›è°ƒä¼˜å·¥å…·è½¯ä»¶åŒ…\"); &#125; /** * ä½¿ç”¨é’©å­æ–¹æ³•æ¥å’Œçˆ¶ç±»äº¤äº’ï¼Œå¢åŠ è‡ªå·±çš„é€»è¾‘ * @return */ @Override protected boolean needMakeArticle() &#123; return flag; &#125;&#125; å®¢æˆ·ç«¯ 1234567891011121314151617181920212223package com.design.pattern.template;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-27 */public class Client &#123; @Test public void test()&#123; Course jvmCourse = new JvmCource(Boolean.TRUE); jvmCourse.makeCourse(); Course feCourse = new FECourse(); feCourse.makeCourse(); &#125;&#125; æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼æºç è§£æAbstractList(çˆ¶)-ArrayList(å­)AbstractList 1234567public abstract class AbstractList&lt;E&gt; extends AbstractCollection&lt;E&gt; implements List&lt;E&gt; &#123;//getæ–¹æ³•ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå®Œå…¨äº¤ç»™å­ç±»å»å®ç°abstract public E get(int index);&#125; ArrayList 12345678910public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable&#123;//å­ç±»æ¥å®ç°getæ–¹æ³• public E get(int index) &#123; rangeCheck(index); return elementData(index); &#125;&#125; åŒç†ï¼šAbstractSetã€AbstractMapåŒæ ·é‡‡ç”¨äº†æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼ HttpServlet1æˆ‘ä»¬ä¸€èˆ¬ç»§æ‰¿HttpServletï¼Œç„¶åé‡å†™doGetæˆ–è€…doPostç­‰doXxxæ–¹æ³•ï¼ŒHttpServletä¸­å®šä¹‰äº†ä¸€å¥—æ¨¡ç‰ˆï¼Œåªè¦è¦†å†™è¿™äº›æ–¹æ³•å³å¯ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758protected void service(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException &#123; String method = req.getMethod();if (method.equals(METHOD_GET)) &#123; long lastModified = getLastModified(req); if (lastModified == -1) &#123; // servlet doesn't support if-modified-since, no reason // to go through further expensive logic doGet(req, resp); &#125; else &#123; long ifModifiedSince = req.getDateHeader(HEADER_IFMODSINCE); if (ifModifiedSince &lt; (lastModified / 1000 * 1000)) &#123; // If the servlet mod time is later, call doGet() // Round down to the nearest second for a proper compare // A ifModifiedSince of -1 will always be less maybeSetLastModified(resp, lastModified); doGet(req, resp); &#125; else &#123; resp.setStatus(HttpServletResponse.SC_NOT_MODIFIED); &#125; &#125;&#125; else if (method.equals(METHOD_HEAD)) &#123; long lastModified = getLastModified(req); maybeSetLastModified(resp, lastModified); doHead(req, resp);&#125; else if (method.equals(METHOD_POST)) &#123; doPost(req, resp); &#125; else if (method.equals(METHOD_PUT)) &#123; doPut(req, resp); &#125; else if (method.equals(METHOD_DELETE)) &#123; doDelete(req, resp); &#125; else if (method.equals(METHOD_OPTIONS)) &#123; doOptions(req,resp); &#125; else if (method.equals(METHOD_TRACE)) &#123; doTrace(req,resp); &#125; else &#123; // // Note that this means NO servlet supports whatever // method was requested, anywhere on this server. // String errMsg = lStrings.getString(\"http.method_not_implemented\"); Object[] errArgs = new Object[1]; errArgs[0] = method; errMsg = MessageFormat.format(errMsg, errArgs); resp.sendError(HttpServletResponse.SC_NOT_IMPLEMENTED, errMsg);&#125; &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è¿­ä»£å™¨æ¨¡å¼","slug":"design_pattern/behaviour_type/è¿­ä»£å™¨æ¨¡å¼","date":"2019-09-26T16:00:00.000Z","updated":"2020-08-09T09:31:35.235Z","comments":true,"path":"posts/9055d217/","link":"","permalink":"https://gentryhuang.com/posts/9055d217/","excerpt":"","text":"å®šä¹‰æä¾›ä¸€ç§æ–¹æ³•ï¼Œé¡ºåºè®¿é—®ä¸€ä¸ªé›†åˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ ï¼Œè€Œåˆä¸æš´éœ²è¯¥å¯¹è±¡çš„å†…éƒ¨ç»†èŠ‚ã€‚ ç±»å‹è¡Œä¸ºå‹ é€‚ç”¨åœºæ™¯121 è®¿é—®ä¸€ä¸ªé›†åˆå¯¹è±¡çš„å†…å®¹è€Œæ— éœ€æš´éœ²å®ƒçš„å†…éƒ¨è¡¨ç¤º2 ä¸ºéå†ä¸åŒçš„é›†åˆç»“æ„æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ ä¼˜ç‚¹1åˆ†ç¦»äº†é›†åˆå¯¹è±¡çš„éå†è¡Œä¸ºï¼Œå› ä¸ºæŠ½è±¡å‡ºäº†è¿­ä»£å™¨æ¥éå†å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡è¿­ä»£å™¨æ¥è®¿é—®é›†åˆå¯¹è±¡å†…éƒ¨å…ƒç´ äº†ã€‚ ç¼ºç‚¹1ç±»çš„ä¸ªæ•°æˆå¯¹å¢åŠ ï¼Œç”±äºè¿­ä»£å™¨æ¨¡å¼æ˜¯å°†å­˜å‚¨æ•°æ®å’Œéå†æ•°æ®è¿™ä¸ªä¸¤ä¸ªèŒè´£è¿›è¡Œåˆ†ç¦»ï¼Œæ‰€ä»¥å½“æ–°å‡ºç°ä¸€ç§é›†åˆç±»å°±éœ€è¦å¢åŠ ä¸€ç§æ–°çš„å¯¹åº”çš„è¿­ä»£å™¨ã€‚è¿™æ ·ç±»çš„ä¸ªæ•°å¢åŠ ï¼Œè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚ è¿­ä»£å™¨ç›¸å…³çš„è®¾è®¡æ¨¡å¼è¿­ä»£å™¨æ¨¡å¼å’Œè®¿é—®è€…æ¨¡å¼ 121 è¿™ä¸¤è€…éƒ½æ˜¯è¿­ä»£åœ°è®¿é—®é›†åˆå¯¹è±¡ä¸­çš„å„ä¸ªå…ƒç´ 2 è®¿é—®è€…æ¨¡å¼ä¸­æ‰©å±•å¼€æ”¾çš„éƒ¨åˆ†åœ¨ä½œç”¨äºå¯¹è±¡çš„æ“ä½œä¸Šï¼Œè€Œåœ¨è¿­ä»£å™¨æ¨¡å¼ä¸­æ‰©å±•å¼€æ”¾çš„éƒ¨åˆ†æ˜¯åœ¨é›†åˆå¯¹è±¡çš„ç§ç±»ä¸Š è¯´æ˜è¿­ä»£å™¨æ¨¡å¼åœ¨æ—¥å¸¸å¼€å‘ä¸­ä¸€èˆ¬ä¸ä¼šè‡ªå·±å†™ï¼Œé™¤éæˆ‘ä»¬å®šä¹‰è‡ªå·±çš„æ•°æ®ç»“æ„ï¼Œç„¶åä¸ºè¿™ä¸ªæ•°æ®ç»“æ„å®ç°å¯¹åº”çš„è¿­ä»£å™¨ã€‚ ç®€å•éœ€æ±‚è¯¾ç¨‹çš„å¢åŠ å’Œåˆ é™¤ä»¥åŠè¿­ä»£è¯¥è¯¾ç¨‹é›† è¿­ä»£å™¨æ¨¡å¼æ¼”ç»ƒs å®ä½“ç±» 1234567891011121314151617181920package com.design.pattern.iterator.v2;import lombok.AllArgsConstructor;import lombok.Data;/** * Course ç›¸å½“äºé›†åˆä¸­çš„å…ƒç´  * * @author shunhua * @date 2019-09-27 */@Data@AllArgsConstructorpublic class Course &#123; /** * è¯¾ç¨‹çš„åå­— */ private String name;&#125; é›†åˆç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package com.design.pattern.iterator.v2;import java.util.ArrayList;import java.util.List;/** * MyCollection * * @author shunhua * @date 2019-09-27 */public class MyCollection&lt;T&gt; &#123; /** * å…ƒç´ é›†åˆ */ private final List&lt;T&gt; list = new ArrayList&lt;&gt;(); /** * å¢åŠ å…ƒç´  * @param item */ public void add(T item)&#123; list.add(item); &#125; /** * ç§»å‡ºå…ƒç´  */ public void remove(T item)&#123; this.list.remove(item); &#125; /** * åˆ é™¤æ‰€æœ‰å…ƒç´  */ public void removeAll()&#123; this.list.removeAll(list); &#125; /** * è·å–è¿­ä»£å™¨ï¼Œæ³¨æ„éœ€è¦æŠŠå®ä½“å¯¹è±¡åˆ—è¡¨ä¼ ç»™è¿­ä»£å™¨ * @return */ public MyIterator iterator()&#123; return new MyIterator(list); &#125;&#125; è¿­ä»£å™¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package com.design.pattern.iterator.v2;import java.util.List;/** * MyIterator * * @author shunhua * @date 2019-09-27 */public class MyIterator&lt;T&gt; &#123; /** * é›†åˆ */ private List&lt;T&gt; list ; /** * æ¸¸æ ‡ */ private int position; /** * é›†åˆä¸­çš„å…ƒç´  */ private T item; public MyIterator(List&lt;T&gt; list)&#123; this.list = list; &#125; /** * æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå…ƒç´  * @return */ public boolean hasNext()&#123; if( this.position &lt; list.size())&#123; return true; &#125; return false; &#125; /** * è¿­ä»£å…ƒç´  * @return */ public T next()&#123; T item = list.get(position); position ++; return item; &#125;&#125; åº”ç”¨å±‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package com.design.pattern.iterator.v2;import com.design.pattern.iterator.v1.Course;import com.design.pattern.iterator.v1.CourseHandler;import com.design.pattern.iterator.v1.CourseHandlerImpl;import com.design.pattern.iterator.v1.CourseIterator;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-27 */@Slf4jpublic class Client &#123; @Test public void test() &#123; Course course1 = new Course(\"Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ\"); Course course2 = new Course(\"MySqlä»åˆ åº“åˆ°è·‘è·¯\"); Course course3 = new Course(\"Pythonä»å…¥é—¨åˆ°ç²¾é€š\"); MyCollection&lt;Course&gt; collection = new MyCollection(); collection.add(course1); collection.add(course2); collection.add(course3); log.info(\"----------è¯¾ç¨‹åˆ—è¡¨-------------\"); printCourses(collection); collection.remove(course1); log.info(\"----------åˆ é™¤æ“ä½œä¹‹åçš„è¯¾ç¨‹---- \"); printCourses(collection); &#125; private void printCourses(MyCollection collection) &#123; MyIterator iterator = collection.iterator(); while (iterator.hasNext()) &#123; Course course = (Course) iterator.next(); log.info(course.toString()); &#125; &#125;&#125; è¿­ä»£å™¨æ¨¡å¼æºç è§£æArrayListçš„è¿­ä»£å™¨ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667/** ArrayListçš„å†…éƒ¨ç±»å®ç°äº†Iterator * An optimized version of AbstractList.Itr */private class Itr implements Iterator&lt;E&gt; &#123; int cursor; // index of next element to return int lastRet = -1; // index of last element returned; -1 if no such int expectedModCount = modCount; public boolean hasNext() &#123; return cursor != size; &#125; @SuppressWarnings(\"unchecked\") public E next() &#123; checkForComodification(); int i = cursor; if (i &gt;= size) throw new NoSuchElementException(); Object[] elementData = ArrayList.this.elementData; if (i &gt;= elementData.length) throw new ConcurrentModificationException(); cursor = i + 1; return (E) elementData[lastRet = i]; &#125; public void remove() &#123; if (lastRet &lt; 0) throw new IllegalStateException(); checkForComodification(); try &#123; ArrayList.this.remove(lastRet); cursor = lastRet; lastRet = -1; expectedModCount = modCount; &#125; catch (IndexOutOfBoundsException ex) &#123; throw new ConcurrentModificationException(); &#125; &#125; @Override @SuppressWarnings(\"unchecked\") public void forEachRemaining(Consumer&lt;? super E&gt; consumer) &#123; Objects.requireNonNull(consumer); final int size = ArrayList.this.size; int i = cursor; if (i &gt;= size) &#123; return; &#125; final Object[] elementData = ArrayList.this.elementData; if (i &gt;= elementData.length) &#123; throw new ConcurrentModificationException(); &#125; while (i != size &amp;&amp; modCount == expectedModCount) &#123; consumer.accept((E) elementData[i++]); &#125; // update once at end of iteration to reduce heap write traffic cursor = i; lastRet = i - 1; checkForComodification(); &#125; final void checkForComodification() &#123; if (modCount != expectedModCount) throw new ConcurrentModificationException(); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"ç»„åˆæ¨¡å¼","slug":"design_pattern/structure_type/ç»„åˆæ¨¡å¼","date":"2019-09-23T16:00:00.000Z","updated":"2020-08-09T09:36:05.220Z","comments":true,"path":"posts/df879792/","link":"","permalink":"https://gentryhuang.com/posts/df879792/","excerpt":"","text":"å®šä¹‰å°†å¯¹è±¡ç»„åˆæˆæ ‘å½¢ç»“æ„ä»¥è¡¨ç¤ºâ€œéƒ¨åˆ†-æ•´ä½“â€çš„å±‚æ¬¡ç»“æ„ã€‚ä½œç”¨æ˜¯ä½¿å®¢æˆ·ç«¯å¯¹å•ä¸ªå¯¹è±¡å’Œç»„åˆå¯¹è±¡ä¿æŒä¸€è‡´çš„æ–¹å¼å¤„ç†ã€‚ç»„åˆæ¨¡å¼å°±æ˜¯å°†å¤šä¸ªå¯¹è±¡ç»„åˆæˆä¸€ä¸ªå¯¹è±¡ï¼ˆè¿™äº›å¯¹è±¡å…·æœ‰ç›¸åŒçš„ç±»å‹ï¼Œä½¿ç”¨å®ƒä»¬çš„çˆ¶ç±»å‹ä½œä¸ºç»Ÿä¸€çš„å¯¹è±¡ä¾›å®¢æˆ·ç«¯è®¿é—®ï¼‰ï¼Œç®€åŒ–äº†å¯¹å¤šä¸ªå¯¹è±¡çš„è®¿é—® ç±»å‹ç»“æ„å‹ ä½¿ç”¨åœºæ™¯121. å¸Œæœ›å®¢æˆ·ç«¯å¯ä»¥å¿½ç•¥ç»„åˆå¯¹è±¡ä¸å•ä¸ªå¯¹è±¡çš„å·®å¼‚æ—¶2. å¤„ç†ä¸€ä¸ªæ ‘å½¢ç»“æ„æ—¶ ä¼˜ç‚¹1234â—†æ¸…æ¥šåœ°å®šä¹‰äº†åˆ†å±‚æ¬¡çš„å¤æ‚å¯¹è±¡ï¼Œè¡¨ç¤ºå¯¹è±¡çš„å…¨éƒ¨æˆ–éƒ¨åˆ†å±‚æ¬¡â—†è®©å®¢æˆ·ç«¯å¿½ç•¥äº†å±‚æ¬¡çš„å·®å¼‚ï¼Œæ–¹ä¾¿å¯¹æ•´ä¸ªå±‚æ¬¡ç»“æ„è¿›è¡Œæ§åˆ¶â—†ç®€åŒ–å®¢æˆ·ç«¯ä»£ç â—†ç¬¦åˆå¼€é—­åŸåˆ™ ç¼ºç‚¹121. é™åˆ¶ç±»å‹æ—¶ä¼šè¾ƒä¸ºå¤æ‚ï¼Œå› ä¸ºå®ƒä»¬éƒ½å…·æœ‰ç›¸åŒçš„çˆ¶ç±»å‹2. ä½¿è®¾è®¡å˜å¾—æ›´åŠ æŠ½è±¡ ç›¸å…³çš„è®¾è®¡æ¨¡å¼ç»„åˆæ¨¡å¼å’Œè®¿é—®è€…æ¨¡å¼ å¯ä»¥ç”¨è®¿é—®æ¨¡å¼è®¿é—®ç»„åˆæ¨¡å¼çš„é€’å½’ç»“æ„ ç®€å•éœ€æ±‚è¯¾ç¨‹åˆ†ä¸ºä¸åŒçš„ç±»å‹ï¼Œæ¯ä¸€ç§ç±»å‹å¯¹åº”ä¸€ä¸ªè¯¾ç¨‹ç›®å½•ï¼Œè¯¾ç¨‹ç›®å½•ä¸‹åˆæœ‰å¾ˆå¤šçš„è¯¾ç¨‹ï¼Œè¦æ±‚æ‰“å°å‡ºè¯¾ç¨‹çš„ç»“æ„ ç»„åˆæ¨¡å¼çš„æ¼”ç»ƒ 1æˆ‘ä»¬å¯ä»¥é€šè¿‡è¡Œä¸ºæ–¹æ³•è¿›è¡Œè¯†åˆ«ç»„åˆæ¨¡å¼ï¼Œç»„åˆæ¨¡å¼æ˜¯å°†ç›¸åŒçš„æŠ½è±¡ç±»ç±»å‹æˆ–è€…æ¥å£ç±»å‹è½¬ä¸ºç›¸åŒçš„æ ‘çŠ¶ç»“æ„ï¼Œä½¿ç”¨æŠ½è±¡ä½œä¸ºè®¿é—®çš„å…¥å£ã€‚å¶å­å¯¹è±¡ï¼ˆå•ä¸ªå¯¹è±¡ï¼‰å’Œç»„åˆå¥½çš„å¯¹è±¡ï¼ˆåŒ…å«å¶å­å¯¹è±¡çš„é›†åˆï¼‰éƒ½è¦ç»§æ‰¿æˆ–å®ç°ç›¸åŒçš„çˆ¶ç±»ï¼Œè¿™æ ·ç»„åˆæ¨¡å¼æ‰èƒ½å°†å®ƒä»¬è¿›è¡Œç»Ÿä¸€å¤„ç†ã€‚ ç»Ÿä¸€æŠ½è±¡ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package com.design.pattern.composite;/** * 1. æ–¹æ³•ä¸­çš„æŠ›å‡ºå¼‚å¸¸å¤„ç†ï¼Œæ˜¯ä½“ç°æ–¹æ³•ä¸èƒ½è¢«ä½¿ç”¨ï¼Œå› ä¸ºè¯¾ç¨‹å’Œè¯¾ç¨‹ç›®å½•ä½¿ç”¨çš„æ–¹æ³•ä¸åŒ * 2. è¯¾ç¨‹å’Œè¯¾ç¨‹ç›®å½•ä½¿ç”¨ç»Ÿä¸€ç±»å‹ä¾›å®¢æˆ·ç«¯è®¿é—® * @author shunhua * @date 2019-09-24 */public abstract class CourseComponet &#123; /** * æ‰©å±•è¯¾ç¨‹ç›®å½• * @param courseComponet */ public void addCatalog(CourseComponet courseComponet)&#123; throw new UnsupportedOperationException(\"ä¸æ”¯æŒæ·»åŠ è¯¾ç¨‹ç›®å½•æ“ä½œ\"); &#125; /** * åˆ é™¤è¯¾ç¨‹ç›®å½• * @param courseComponet */ public void removeCatalog(CourseComponet courseComponet)&#123; throw new UnsupportedOperationException(\"ä¸æ”¯æŒåˆ é™¤è¯¾ç¨‹ç›®å½•æ“ä½œ\"); &#125; /** * è·å–è¯¾ç¨‹åç§° * @param courseComponet * @return */ public String getName(CourseComponet courseComponet)&#123; throw new UnsupportedOperationException(\"ä¸æ”¯æŒè·å–è¯¾ç¨‹åç§°æ“ä½œ\"); &#125; /** * è·å–è¯¾ç¨‹ä»·æ ¼ * @param courseComponet * @return */ public double getPrice(CourseComponet courseComponet)&#123; throw new UnsupportedOperationException(\"ä¸æ”¯æŒè·å–è¯¾ç¨‹ä»·æ ¼æ“ä½œ\"); &#125; /** * æ‰“å°ä¿¡æ¯ */ public void print()&#123; throw new UnsupportedOperationException(\"ä¸æ”¯æŒæ‰“å°æ“ä½œ\"); &#125;&#125; è¯¾ç¨‹ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041package com.design.pattern.composite;import lombok.extern.slf4j.Slf4j;&#x2F;** * Course è¯¾ç¨‹ç±» * * @author shunhua * @date 2019-09-24 *&#x2F;@Slf4jpublic class Course extends CourseComponet &#123; &#x2F;** * è¯¾ç¨‹å *&#x2F; private String courseName; &#x2F;** * è¯¾ç¨‹ä»·æ ¼ *&#x2F; private double price; public Course(String courseName, double price) &#123; this.courseName &#x3D; courseName; this.price &#x3D; price; &#125; @Override public String getName(CourseComponet courseComponet) &#123; return this.courseName; &#125; @Override public double getPrice(CourseComponet courseComponet) &#123; return this.price; &#125; @Override public void print() &#123; log.info(&quot;è¯¾ç¨‹åï¼š&quot; + courseName + &quot;, è¯¾ç¨‹ä»·æ ¼ï¼š&quot; + price); &#125;&#125; è¯¾ç¨‹ç›®å½•ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162package com.design.pattern.composite;import lombok.extern.slf4j.Slf4j;import java.util.ArrayList;import java.util.List;/** * CourseCatalog è¯¾ç¨‹ç›®å½•ç±» * * @author shunhua * @date 2019-09-24 */@Slf4jpublic class CourseCatalog extends CourseComponet &#123; /** * è¯¾ç¨‹ç›®å½•ä¸‹çš„è¯¾ç¨‹é›†åˆ ï¼Œè¿™é‡Œä½¿ç”¨ç»Ÿä¸€æŠ½è±¡ç±»å‹è¡¨ç¤ºï¼Œè¿™é‡Œå°±ç»„åˆäº†è¯¾ç¨‹å¯¹è±¡ */ private List&lt;CourseComponet&gt; items = new ArrayList&lt;&gt;(); /** * è¯¾ç¨‹ç›®å½•å */ private String catalogName; public CourseCatalog(String catalogName)&#123; this.catalogName = catalogName; &#125; /** * ä¸ºè¯¾ç¨‹ç›®å½•æ·»åŠ è¯¾ç¨‹ * @param courseComponet */ @Override public void addCatalog(CourseComponet courseComponet) &#123; this.items.add(courseComponet); &#125; /** * åˆ é™¤è¯¾ç¨‹ç›®å½•ä¸­çš„è¯¾ç¨‹ * @param courseComponet */ @Override public void removeCatalog(CourseComponet courseComponet) &#123; this.items.remove(courseComponet); &#125; @Override public String getName(CourseComponet courseComponet) &#123; return this.catalogName; &#125; /** * æ‰“å°ç›®å½•ä»¥åŠç›®å½•ä¸‹çš„è¯¾ç¨‹ */ @Override public void print() &#123; log.info(catalogName); for(CourseComponet courseComponet : items)&#123; courseComponet.print(); &#125; &#125;&#125; å®¢æˆ·ç«¯ 123456789101112131415161718192021222324252627282930313233package com.design.pattern.composite;import org.junit.Test;&#x2F;** * Client è¯¾ç¨‹ç›®å½•å’Œè¯¾ç¨‹ï¼Œå¯¹å®¢æˆ·ç«¯æ¥è¯´éƒ½æ˜¯ä¸€ä¸ªç±»å‹çš„å¯¹è±¡ * * @author shunhua * @date 2019-09-24 *&#x2F;public class Client &#123; @Test public void test()&#123; CourseComponet catalog &#x3D; new CourseCatalog(&quot;è¯¾ç¨‹é¡¶çº§ç›®å½•&quot;); CourseComponet linuxCourse &#x3D; new Course(&quot;é¸Ÿå“¥ç§æˆ¿èœ&quot;,80); CourseComponet gitCourse &#x3D; new Course(&quot;Gitæƒå¨æŒ‡å—&quot;,120); CourseComponet javaCatalog &#x3D; new CourseCatalog(&quot;Javaè¯¾ç¨‹ç›®å½•&quot;); CourseComponet spring &#x3D; new Course(&quot;Springå®æˆ˜&quot;,70); CourseComponet mybatis &#x3D; new Course(&quot;MyBatisæŠ€æœ¯å†…å¹•&quot;,60); javaCatalog.addCatalog(spring); javaCatalog.addCatalog(mybatis); catalog.addCatalog(linuxCourse); catalog.addCatalog(gitCourse); catalog.addCatalog(javaCatalog); &#x2F;&#x2F; æ‰“å°è¯¾ç¨‹ç›®å½•ä»¥åŠç›®å½•ä¸‹çš„è¯¾ç¨‹åˆ—è¡¨ catalog.print(); &#125;&#125; ç»„åˆæ¨¡å¼æºç è§£æjdkæºç ä¹‹HashMap 1234567891011121314151617181920212223242526272829303132public class HashMap&lt;K,V&gt; extends AbstractMap&lt;K,V&gt; implements Map&lt;K,V&gt;, Cloneable, Serializable&#123; /** * æ–¹æ³•çš„å…¥å‚æ˜¯Mapç±»å‹ï¼Œä½¿ç”¨Mapç±»å‹ä½œä¸ºç»Ÿä¸€çš„æ¥æ”¶å‚æ•°ï¼Œä¸éœ€è¦å…³æ³¨ä»»ä½•ä¹‹ç±»å‹çš„å¯¹è±¡ */ public void putAll(Map&lt;? extends K, ? extends V&gt; m) &#123; int numKeysToBeAdded = m.size(); if (numKeysToBeAdded == 0) return; if (table == EMPTY_TABLE) &#123; inflateTable((int) Math.max(numKeysToBeAdded * loadFactor, threshold)); &#125; if (numKeysToBeAdded &gt; threshold) &#123; int targetCapacity = (int)(numKeysToBeAdded / loadFactor + 1); if (targetCapacity &gt; MAXIMUM_CAPACITY) targetCapacity = MAXIMUM_CAPACITY; int newCapacity = table.length; while (newCapacity &lt; targetCapacity) newCapacity &lt;&lt;= 1; if (newCapacity &gt; table.length) resize(newCapacity); &#125; for (Map.Entry&lt;? extends K, ? extends V&gt; e : m.entrySet()) put(e.getKey(), e.getValue()); &#125;&#125; jdkæºç ä¹‹ArrayList 1234567891011/** * æ–¹æ³•çš„å…¥å‚ä½¿ç”¨ç»Ÿä¸€çš„çˆ¶ç±»å‹Collectionï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦å…³æ³¨å…·ä½“çš„å­ç±»å‹å¯¹è±¡ */ public boolean addAll(Collection&lt;? extends E&gt; c) &#123; Object[] a = c.toArray(); int numNew = a.length; ensureCapacityInternal(size + numNew); // Increments modCount System.arraycopy(a, 0, elementData, size, numNew); size += numNew; return numNew != 0; &#125; MyBatisæºç ä¹‹SqlNode 12MyBatisçš„sqlè¯­å¥ä¼šè¢«è§£ææˆä¸åŒçš„SqlNodeç±»å‹çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡éƒ½å®ç°äº†SqlNodeã€‚å…¶ä¸­MixedSqlNodeæ˜¯è”ç³»ä¸åŒçš„SqlNodeçš„ä¸€ä¸ªæ ¸å¿ƒå¯¹è±¡ï¼Œç»„åˆæ¨¡å¼å¯ä»¥ç»Ÿä¸€å¤„ç†çš„å®ƒä»¬ã€‚ 12345678910111213141516171819202122package org.apache.ibatis.scripting.xmltags;import java.util.List;public class MixedSqlNode implements SqlNode &#123; /** * SqlNodeä¸åŒå®ç°çš„é›†åˆ */ private final List&lt;SqlNode&gt; contents; public MixedSqlNode(List&lt;SqlNode&gt; contents) &#123; this.contents = contents; &#125; @Override public boolean apply(DynamicContext context) &#123; for (SqlNode sqlNode : contents) &#123; sqlNode.apply(context); &#125; return true; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"äº«å…ƒæ¨¡å¼","slug":"design_pattern/structure_type/äº«å…ƒæ¨¡å¼","date":"2019-09-22T16:00:00.000Z","updated":"2020-08-09T09:33:14.983Z","comments":true,"path":"posts/e19da94a/","link":"","permalink":"https://gentryhuang.com/posts/e19da94a/","excerpt":"","text":"å®šä¹‰æä¾›äº†å‡å°‘å¯¹è±¡æ•°é‡ä»è€Œæ”¹å–„åº”ç”¨çš„å¯¹è±¡ç»“æ„çš„æ–¹å¼ã€‚è¿ç”¨å…±äº«æŠ€æœ¯æœ‰æ•ˆåœ°æ”¯æŒå¤§é‡ç»†ç²’åº¦çš„å¯¹è±¡ã€‚å³å‡å°‘åˆ›å»ºå¯¹è±¡çš„æ•°é‡ï¼Œå…±äº«å¯¹è±¡ï¼Œä»è€Œå‡å°‘å†…å­˜çš„å ç”¨å¹¶ä¸”æé«˜æ€§èƒ½ ã€‚æ³¨æ„ï¼šäº«å…ƒæ¨¡å¼é‡è¦çš„å°±æ˜¯å…±äº«ã€‚ ç±»å‹ç»“æ„å‹ åº”ç”¨åœºæ™¯1234â—† å¸¸å¸¸åº”ç”¨äºç³»ç»Ÿåº•å±‚çš„å¼€å‘ï¼Œä»¥ä¾¿è§£å†³ç³»ç»Ÿçš„æ€§èƒ½é—®é¢˜ å¦‚Stringç±»å‹å°±æ˜¯ä½¿ç”¨äº†äº«å…ƒæ¨¡å¼ï¼ŒStringå¯¹è±¡å­˜åœ¨å³è¿”å›ï¼Œæ²¡æœ‰å°±åˆ›å»ºç„¶åæ”¾å…¥åˆ°å­—ç¬¦ä¸²å¸¸é‡æ± ä¸­ã€‚å†æ¯”å¦‚æ•°æ®åº“è¿æ¥æ± ï¼Œé‡Œé¢éƒ½æ˜¯åˆ›å»ºå¥½çš„æ•°æ®åº“è¿æ¥ï¼Œéœ€è¦çš„æ—¶å€™æ‹¿æ¥ç”¨ä¸éœ€è¦çš„æ—¶å€™å½’è¿˜å›å»ã€‚å³ç³»ç»Ÿä¸­å¦‚æœæœ‰å¤§é‡çš„å¯¹è±¡ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå…±åŒçš„éƒ¨åˆ†æŠ½è±¡å‡ºæ¥ï¼Œæœ‰ç›¸åŒçš„ä¸šåŠ¡è¯·æ±‚ï¼Œåˆ™è¿”å›åœ¨å†…å­˜ä¸­çš„å·²æœ‰å¯¹è±¡ï¼Œé¿å…é‡æ–°åˆ›å»ºâ—† ç³»ç»Ÿæœ‰å¤§é‡ç›¸ä¼¼å¯¹è±¡ã€éœ€è¦ç¼“å†²æ± çš„åœºæ™¯ æŸä¸ªå¯¹è±¡çš„å¤ç”¨åº¦è¶Šé«˜ï¼Œè¶Šå€¾å‘äºä½¿ç”¨äº«å…ƒæ¨¡å¼ ä¼˜ç‚¹12â—†å‡å°‘å¯¹è±¡çš„åˆ›å»ºï¼Œé™ä½å†…å­˜ä¸­å¯¹è±¡çš„æ•°é‡ï¼Œé™ä½ç³»ç»Ÿçš„å†…å­˜ï¼Œæé«˜æ•ˆç‡â—†å‡å°‘å†…å­˜ä¹‹å¤–çš„å…¶ä»–èµ„æºå ç”¨(æ—¶é—´èµ„æºã€æ–‡ä»¶å¥æŸ„ã€çª—å£å¥æŸ„ç­‰) ç¼ºç‚¹1234â—†å…³æ³¨å†…&#x2F;å¤–éƒ¨çŠ¶æ€ã€å…³æ³¨çº¿ç¨‹å®‰å…¨é—®é¢˜ æˆ‘ä»¬ä½¿ç”¨å…±äº«æ¨¡å¼çš„æ—¶å€™ï¼Œå¤§éƒ½æ˜¯ä½¿ç”¨hashMapï¼Œä¸ä¼šç”¨HashTableï¼ˆå› ä¸ºhashTableä¼šç”±äºåŒæ­¥é”é€ æˆæ•ˆç‡è¿‡ä½ï¼Œè¿™æ ·å¾—ä¸å¿å¤±ï¼‰ï¼Œè¿™æ ·å°±éœ€è¦åœ¨æœ‰äº›åœºæ™¯ä¸‹å…³æ³¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚åŒæ—¶è¿˜è¦å…³æ³¨å†…ã€å¤–éƒ¨çŠ¶æ€ã€‚â—†ä½¿ç³»ç»Ÿã€ç¨‹åºçš„é€»è¾‘å¤æ‚åŒ– ä½¿ç”¨äº†äº«å…ƒå¯¹è±¡æé«˜äº†ç³»ç»Ÿçš„å¤æ‚åº¦ï¼Œè¿˜è¦åˆ†ç¦»å†…å¤–ä¸çŠ¶æ€ï¼Œå¹¶ä¸”å¤–éƒ¨çŠ¶æ€ä¸åº”è¯¥éšç€å†…éƒ¨çŠ¶æ€çš„å˜åŒ–è€Œå˜åŒ–ï¼Œå¦åˆ™ç³»ç»Ÿå°±æ··ä¹±äº†ã€‚ æ‰©å±•å†…éƒ¨çŠ¶æ€ 1åœ¨äº«å…ƒæ¨¡å¼å†…éƒ¨å¹¶ä¸”ä¸ä¼šéšç€ç¯å¢ƒæ”¹å˜è€Œæ”¹å˜çš„å…±äº«éƒ¨åˆ†ï¼›æ— è®ºå¤–éƒ¨ç¯å¢ƒå¦‚ä½•å˜åŒ–ï¼Œæˆ‘éƒ½ä¸å˜ï¼Œå¹¶ä¸”è¯¥çŠ¶æ€åœ¨äº«å…ƒæ¨¡å¼å†…éƒ¨ã€‚å¯ç†è§£ä¸ºæ˜¯äº«å…ƒå¯¹è±¡çš„ä¸€ä¸ªå±æ€§ï¼Œè¿™ä¸ªå±æ€§ä¸ä¼šä¸å¤–éƒ¨äº¤äº’ã€‚ å¤–éƒ¨çŠ¶æ€ 1éšç€ç¯å¢ƒæ”¹å˜è€Œæ”¹å˜çš„å°±æ˜¯å¤–éƒ¨çŠ¶æ€ï¼Œè¿™ç§çŠ¶æ€æ˜¯ä¸å¯ä»¥å…±äº«çš„çŠ¶æ€ï¼Œå¹¶ä¸”è®°å½•åœ¨äº«å…ƒæ¨¡å¼çš„å¤–éƒ¨ã€‚å¯ç†è§£ä¸ºäº«å…ƒå¯¹è±¡çš„ä¸€ä¸ªå¯ä»¥å’Œå¤–ç•Œäº¤äº’çš„å±æ€§ï¼Œå®ƒä¼šéšæ—¶å‘ç”Ÿæ”¹å˜ã€‚ ç›¸å…³è®¾è®¡æ¨¡å¼äº«å…ƒæ¨¡å¼å’Œä»£ç†æ¨¡å¼ 1ä»£ç†æ¨¡å¼æ˜¯ä»£ç†ä¸€ä¸ªç±»ï¼Œå¦‚æœç”Ÿæˆè¿™ä¸ªä»£ç†ç±»èŠ±çš„èµ„æºå’Œæ—¶é—´æ¯”è¾ƒå¤šï¼Œå¯ä»¥ä½¿ç”¨äº«å…ƒæ¨¡å¼å¤„ç†è¿™ä¸ªç±»çš„é€Ÿåº¦ äº«å…ƒæ¨¡å¼å’Œå•ä¾‹æ¨¡å¼ 1å®¹å™¨å•ä¾‹æ˜¯ä¸¤ç§æ–¹å¼çš„ä¸€ç§ç»“åˆã€‚äº«å…ƒæ¨¡å¼æ˜¯ä¸€ç§å¤ç”¨å¯¹è±¡çš„æ€æƒ³ ç®€å•éœ€æ±‚å¹´ç»ˆäº†ï¼Œç ”å‘éƒ¨é—¨Leaderå¯èƒ½éœ€è¦å¤šæ¬¡åœ°å»æ±‡æŠ¥å·¥ä½œæƒ…å†µï¼Œå·²ç»æœ‰æŠ¥å‘Šç»“æœçš„å°±ä¸éœ€è¦å†æ•´ç†æŠ¥å‘Šäº†ï¼Œç›´æ¥æ‹¿åˆ°æŠ¥å‘Šå°±å¯ä»¥å»æ±‡æŠ¥äº†ã€‚æ²¡æœ‰åšè¿‡æ±‡æŠ¥çš„å°±éœ€è¦å…ˆæ•´ç†æŠ¥å‘Šã€‚ äº«å…ƒæ¨¡å¼æ¼”ç»ƒ æŠ¥å‘Š 1234567891011121314151617181920212223242526272829303132333435363738package com.design.pattern.flyweight;import lombok.Data;import lombok.extern.slf4j.Slf4j;/** * Presentation æŠ¥å‘Šç±» * * @author shunhua * @date 2019-09-23 */@Data@Slf4jpublic class Presentation &#123; /** * æŠ¥å‘Šç›¸å…³éƒ¨é—¨ */ private String department; /** * æ±‡æŠ¥å†…å®¹ */ private String content; /** * é€šè¿‡å¤–éƒ¨çŠ¶æ€å±æ€§è¿›è¡Œæ„é€  * @param department */ public Presentation(String department)&#123; this.department = department; &#125; /** * æŠ¥å‘Šå†…å®¹ */ public void report() &#123; log.info(content); &#125;&#125; æŠ¥å‘Šå·¥å‚ 1234567891011121314151617181920212223242526272829303132333435363738394041package com.design.pattern.flyweight;import lombok.extern.slf4j.Slf4j;import org.springframework.util.ObjectUtils;import java.util.HashMap;import java.util.Map;/** * PresentationFactory æŠ¥å‘Šå·¥å‚ * * @author shunhua * @date 2019-09-23 */@Slf4jpublic class PresentationFactory &#123; /** * æ­¤å¤„åº”ç”¨äº† finalä¿®é¥° å¼•ç”¨æˆå‘˜å˜é‡ï¼Œå¼•ç”¨å¯¹è±¡çš„å†…å®¹å¯ä»¥ä¿®æ”¹ï¼Œä½†æ˜¯å¼•ç”¨åœ°å€ä¸å¯ä»¥ä¿®æ”¹ã€‚è¿™é‡Œä½œä¸ºæŠ¥å‘Šæ± ã€‚ */ private static final Map&lt;String,Presentation&gt; PRESENTATION_MAP = new HashMap&lt;&gt;(16); /** * è¿™é‡Œä¸è€ƒè™‘å®‰å…¨é—®é¢˜ * @param department * @return */ public static Presentation getPresentation(String department)&#123; // å…ˆä»æŠ¥å‘Šæ± ä¸­è·å– Presentation leaderPresentation = PRESENTATION_MAP.get(department); // æŠ¥å‘Šæ± ä¸­æ²¡æœ‰å†åˆ›å»ºä¸€ä¸ªï¼Œç„¶åæ”¾åˆ°æŠ¥å‘Šæ± ä¸­ if(ObjectUtils.isEmpty(leaderPresentation))&#123; leaderPresentation = new Presentation(department); log.info(\"----------- æŠ¥å‘Šæ± ä¸­æ²¡æœ‰éœ€å…ˆåˆ›å»º----------\"); PRESENTATION_MAP.put(department,leaderPresentation); leaderPresentation.setContent(\"éƒ¨é—¨ï¼š\" + department +\" æ±‡æŠ¥...\"); leaderPresentation.report(); &#125; return leaderPresentation; &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122package com.design.pattern.flyweight;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-23 */public class Client &#123; private final String presentation[] = &#123;\"ä¸šåŠ¡éƒ¨\",\"ç ”å‘éƒ¨\",\"ç®¡ç†éƒ¨\"&#125;; @Test public void test()&#123; for(int i = 0; i &lt; 20; i++)&#123; String department = presentation[(int)(Math.random() * presentation.length)]; Presentation leaderPresentation = PresentationFactory.getPresentation(department); leaderPresentation.report(); &#125; &#125;&#125; äº«å…ƒæ¨¡å¼æºç è§£æInteger 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public final class Integer extends Number implements Comparable&lt;Integer&gt; &#123; /** * This method will always cache values in the range -128 to 127, * inclusive, and may cache other values outside of this range. * å¦‚æœä¼ å…¥çš„æ•°å€¼åœ¨ç¼“å­˜çš„-127å’Œ128ä¹‹é—´ï¼Œé‚£ä¹ˆéƒ½ä¼šåœ¨cacheä¸­ï¼Œå¦åˆ™çš„è¯ï¼Œä¼šnewå‡ºæ–°çš„å¯¹è±¡ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ100==100ä¸ºtrueï¼Œ1000==1000ä¸ºfalse * @param i an &#123;@code int&#125; value. * @return an &#123;@code Integer&#125; instance representing &#123;@code i&#125;. * @since 1.5 */ public static Integer valueOf(int i) &#123; assert IntegerCache.high &gt;= 127; if (i &gt;= IntegerCache.low &amp;&amp; i &lt;= IntegerCache.high) return IntegerCache.cache[i + (-IntegerCache.low)]; return new Integer(i); &#125;/** åªè¦åœ¨-128-127ï¼Œä½¿ç”¨ == åˆ¤æ–­æ˜¯å¯ä»¥çš„ï¼Œä¸å†è¿™ä¸ªèŒƒå›´å°±ä¸èƒ½ä½¿ç”¨==,éœ€è¦ä½¿ç”¨equqls * Cache to support the object identity semantics of autoboxing for values between * -128 and 127 (inclusive) as required by JLS. * */ private static class IntegerCache &#123; static final int low = -128; static final int high; static final Integer cache[]; static &#123; // high value may be configured by property int h = 127; String integerCacheHighPropValue = sun.misc.VM.getSavedProperty(\"java.lang.Integer.IntegerCache.high\"); if (integerCacheHighPropValue != null) &#123; int i = parseInt(integerCacheHighPropValue); i = Math.max(i, 127); // Maximum array size is Integer.MAX_VALUE h = Math.min(i, Integer.MAX_VALUE - (-low) -1); &#125; high = h; cache = new Integer[(high - low) + 1]; int j = low; for(int k = 0; k &lt; cache.length; k++) cache[k] = new Integer(j++); &#125; private IntegerCache() &#123;&#125; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"æ¡¥æ¥æ¨¡å¼","slug":"design_pattern/structure_type/æ¡¥æ¥æ¨¡å¼","date":"2019-09-20T16:00:00.000Z","updated":"2020-08-09T09:35:41.268Z","comments":true,"path":"posts/563268dc/","link":"","permalink":"https://gentryhuang.com/posts/563268dc/","excerpt":"","text":"å®šä¹‰å°†æŠ½è±¡éƒ¨åˆ†ä¸å®ƒçš„å…·ä½“å®ç°éƒ¨åˆ†åˆ†ç¦»å¼€æ¥ï¼Œä½¿å®ƒä»¬éƒ½å¯ä»¥ç‹¬ç«‹åœ°å˜åŒ–ï¼ˆè¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ç°è§£è€¦ï¼‰ã€‚æ¡¥æ¥æ¨¡å¼å°†ç»§æ‰¿å…³ç³»è½¬åŒ–æˆå…³è”å…³ç³»ï¼Œå®ƒé™ä½äº†ç±»ä¸ç±»ä¹‹é—´çš„è€¦åˆåº¦ï¼Œå‡å°‘äº†ç³»ç»Ÿä¸­ç±»çš„æ•°é‡ï¼Œé˜²æ­¢ç±»çˆ†ç‚¸ã€‚ä»å®ƒçš„å‘½åå¯ä»¥çœ‹å‡ºï¼Œbridgeæ˜¯æ¡¥æ¢çš„æ„æ€ï¼Œ å°†æ¡¥ä¸¤è¾¹è”ç³»èµ·æ¥ã€‚ç›®çš„å°±æ˜¯æŠŠä¸¤ä¸ªä¸åŒçš„ç±»ä¹‹é—´å»ºç«‹è”ç³»ï¼Œè€Œä¸¤ä¸ªç±»ä¹‹é—´å»ºç«‹è”ç³»çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œè€Œæ¡¥æ¥æ¨¡å¼æ˜¯é€šè¿‡ç»„åˆçš„æ–¹å¼å»ºç«‹ä¸¤ä¸ªä¸åŒç±»ä¹‹é—´çš„å…³ç³»ï¼Œè€Œä¸æ˜¯ç»§æ‰¿ã€‚è¿™ä¹Ÿç¬¦åˆåˆæˆå¤ç”¨åŸåˆ™ï¼šä¼˜å…ˆé€šè¿‡ç»„åˆçš„æ–¹å¼å»ºç«‹ä¸¤ä¸ªç±»ä¹‹é—´è”ç³»ï¼Œè€Œä¸æ˜¯ç»§æ‰¿ï¼Œç»§æ‰¿è¿‡å¤šä¼šå‘ç”Ÿç±»çˆ†ç‚¸çš„æƒ…å†µã€‚è¯´æ˜ä¸€ç‚¹:è¿™é‡Œè¯´çš„æŠ½è±¡éƒ¨åˆ†å’Œå…·ä½“å®ç°éƒ¨åˆ†ï¼Œå¹¶ä¸å±€é™ä¸€ä¸ªæ˜¯æŠ½è±¡çš„ï¼Œå¦ä¸€ä¸ªæ˜¯å…·ä½“çš„å®ç°ï¼Œè¿™åªæ˜¯ä»æ¦‚å¿µä¸Šå»å®šä¹‰ã€‚ 1å°†æŠ½è±¡éƒ¨åˆ†ä¸å®ƒçš„å…·ä½“å®ç°éƒ¨åˆ†åˆ†ç¦»ï¼Œå…¶å®è¿™å¹¶ä¸æ˜¯å°†æŠ½è±¡ç±»ä¸ä»–çš„æ´¾ç”Ÿç±»åˆ†ç¦»ï¼Œè€Œæ˜¯æŠ½è±¡ç±»å’Œå®ƒçš„æ´¾ç”Ÿç±»ç”¨æ¥å®ç°è‡ªå·±çš„å¯¹è±¡ã€‚æˆ–è€…è¯´åœ¨ä¸€ä¸ªç³»ç»Ÿçš„æŠ½è±¡åŒ–å’Œå®ç°åŒ–ä¹‹é—´ä½¿ç”¨å…³è”å…³ç³»ï¼ˆç»„åˆæˆ–è€…èšåˆå…³ç³»ï¼‰è€Œä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼Œä»è€Œä½¿ä¸¤è€…å¯ä»¥ç›¸å¯¹ç‹¬ç«‹åœ°å˜åŒ–ã€‚ ç±»å‹ç»“æ„å‹ é€‚ç”¨åœºæ™¯ æŠ½è±¡å’Œå…·ä½“å®ç°ä¹‹é—´å¢åŠ æ›´å¤šçš„çµæ´»æ€§ 1ä½¿ç”¨æ¡¥æ¥æ¨¡å¼å°±å¯ä»¥é¿å…åœ¨è¿™ä¸¤ä¸ªå±‚æ¬¡ä¹‹é—´å»ºç«‹é™æ€çš„ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯å»ºç«‹å…³è”å…³ç³»ã€‚æ­¤å¤–ï¼ŒæŠ½è±¡éƒ¨åˆ†å’Œå…·ä½“å®ç°éƒ¨åˆ†ï¼Œå®ƒä»¬éƒ½å¯ä»¥åˆ†åˆ«é€šè¿‡ç»§æ‰¿å…³ç³»ç‹¬ç«‹æ‰©å±•ï¼Œå¹¶ä¸”äº’ä¸å½±å“ï¼Œå°±å¯ä»¥åŠ¨æ€åœ°å°†ä¸€ä¸ªæŠ½è±¡åŒ–å­ç±»çš„å¯¹è±¡å’Œä¸€ä¸ªå…·ä½“å®ç°åŒ–å­ç±»çš„å¯¹è±¡è¿›è¡Œç»„åˆï¼Œè¿™æ ·å°±æŠŠæŠ½è±¡åŒ–è§’è‰²å’Œå…·ä½“å®ç°åŒ–è§’è‰²å®ç°äº†è§£è€¦ã€‚ ä¸€ä¸ªç±»å­˜åœ¨ä¸¤ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ï¼Œä¸”è¿™ä¸¤ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰ç»´åº¦éƒ½éœ€è¦ç‹¬ç«‹è¿›è¡Œæ‰©å±• 1æŠ½è±¡çš„éƒ¨åˆ†å¯ä»¥ç‹¬ç«‹æ‰©å±•ï¼Œå…·ä½“å®ç°ä¹Ÿå¯ä»¥ç‹¬ç«‹æ‰©å±• ä¸å¸Œæœ›ä½¿ç”¨ç»§æ‰¿ï¼Œæˆ–å› ä¸ºå¤šå±‚ç»§æ‰¿å¯¼è‡´ç³»ç»Ÿç±»çš„ä¸ªæ•°å‰§å¢ ä¼˜ç‚¹ åˆ†ç¦»æŠ½è±¡éƒ¨åˆ†åŠå…¶å…·ä½“å®ç°éƒ¨åˆ† 1å› ä¸ºæ¡¥æ¥æ¨¡å¼ä½¿ç”¨äº†ç»„åˆï¼Œä½¿ç”¨å¯¹è±¡é—´çš„å…³è”å…³ç³»ï¼Œæ¥è§£è€¦äº†æŠ½è±¡å’Œå…·ä½“å®ç°ä¹‹é—´çš„å›ºæœ‰ç»‘å®šå…³ç³»ï¼Œä½¿æŠ½è±¡å’Œå®ç°å¯ä»¥æ²¿ç€å„è‡ªçš„ç»´åº¦è¿›è¡Œæ‰©å±•ã€å˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŠ½è±¡å’Œå®ç°ä¸åœ¨åŒä¸€ä¸ªç»§æ‰¿å±‚æ¬¡ç»“æ„ä¸­ï¼Œä»è€Œé€šè¿‡ç»„åˆæ¥è·å¾—å¤šç»´åº¦çš„ç»„åˆå¯¹è±¡ã€‚ æé«˜äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ 1åœ¨ä¸¤ä¸ªå˜åŒ–ç»´åº¦ä¸­ï¼Œæ‰©å±•ä»»æ„ä¸€ä¸ªç»´åº¦éƒ½ä¸éœ€è¦ä¿®æ”¹åŸæœ‰çš„ç³»ç»Ÿ ç¬¦åˆå¼€é—­åŸåˆ™ ç¬¦åˆåˆæˆå¤ç”¨åŸåˆ™ ç¼ºç‚¹ å¢åŠ äº†ç³»ç»Ÿçš„ç†è§£ä¸è®¾è®¡éš¾åº¦ 1ç”±äºç±»ä¹‹é—´çš„å…³ç³»å»ºç«‹åœ¨æŠ½è±¡å±‚ï¼Œè¦æ±‚æˆ‘ä»¬åœ¨ç¼–ç çš„æ—¶å€™ï¼Œä¸€å¼€å§‹å°±è¦é’ˆå¯¹æŠ½è±¡å±‚è¿›è¡Œè®¾è®¡å’Œç¼–ç¨‹ éœ€è¦æ­£ç¡®åœ°è¯†åˆ«å‡ºç³»ç»Ÿä¸­ä¸¤ä¸ªç‹¬ç«‹å˜åŒ–çš„ç»´åº¦ ç›¸å…³è®¾è®¡æ¨¡å¼ ç»„åˆæ¨¡å¼ 1ç»„åˆæ¨¡å¼æ›´å¼ºè°ƒçš„æ˜¯éƒ¨åˆ†å’Œæ•´ä½“é—´çš„ç»„åˆï¼Œè€Œæ¡¥æ¥æ¨¡å¼å¼ºè°ƒçš„æ˜¯å¹³è¡Œçº§åˆ«ä¸Šä¸åŒç±»çš„ç»„åˆ é€‚é…å™¨æ¨¡å¼ 1é€‚é…å™¨æ¨¡å¼å’Œæ¡¥æ¥æ¨¡å¼éƒ½æ˜¯ä¸ºäº†è®©ä¸¤ä¸ªä¸œè¥¿é…åˆå·¥ä½œï¼Œä½†å®ƒä»¬ä¸¤ä¸ªçš„ç›®çš„ä¸ä¸€æ ·ï¼Œé€‚é…å™¨æ¨¡å¼æ˜¯æ”¹å˜å·²æœ‰çš„æ¥å£ï¼Œè®©å®ƒä»¬ä¹‹é—´å¯ä»¥ç›¸äº’é…åˆï¼Œè€Œæ¡¥æ¥æ¨¡å¼æ˜¯åˆ†ç¦»æŠ½è±¡å’Œå…·ä½“å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œé€‚é…å™¨æ¨¡å¼å¯ä»¥æŠŠåŠŸèƒ½ä¸Šç›¸ä¼¼ä½†æ˜¯æ¥å£ä¸åŒçš„ç±»é€‚é…èµ·æ¥ï¼Œè€Œæ¡¥æ¥æ¨¡å¼æ˜¯æŠŠç±»çš„æŠ½è±¡å’Œç±»çš„å…·ä½“å®ç°åˆ†ç¦»å¼€ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šä½¿è¿™äº›å±‚æ¬¡ç»“æ„ç»“åˆèµ·æ¥ã€‚ å…³é”®ä¸€ç‚¹æ¡¥æ¥æ¨¡å¼é‡è¦çš„å°±æ˜¯æŠŠæŠ½è±¡å’Œå…·ä½“å®ç°åˆ†ç¦»å¼€ï¼Œä¸­é—´é€šè¿‡ç»„åˆæ¥æ­å»ºå®ƒä»¬ä¹‹é—´çš„æ¡¥æ¢ æ¡ˆä¾‹åˆ†æ åœºæ™¯ 121ï¼‰æœ‰ä¸¤ä¸ªé“¶è¡Œï¼Œåˆ†åˆ«æ˜¯ABCå’ŒICBCé“¶è¡Œï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªè´¦å·ï¼Œåˆ†åˆ«æ˜¯å®šæœŸè´¦å·å’Œæ´»æœŸè´¦å·ã€‚2ï¼‰ä½¿ç”¨æ¡¥æ¥æ¨¡å¼å¯ä»¥ è®©å®ç°ï¼ˆè¿™é‡Œå°±æ˜¯è´¦å·å…·ä½“å®ç°ï¼‰å’ŒæŠ½è±¡ï¼ˆè¿™é‡Œå°±æ˜¯æŠ½è±¡çš„é“¶è¡Œç±»ï¼‰åˆ†ç¦»ï¼Œé“¶è¡Œå±æ€§å¢åŠ ä¿®æ”¹é“¶è¡Œç±»å³å¯ï¼Œè´¦å·ç±»å±æ€§å¢åŠ ä¿®æ”¹è´¦å·ç±»å³å¯ã€‚é€»è¾‘æ¸…æ™°ï¼ŒåŒæ—¶ä¹Ÿè§£å†³äº†ä¸Šè¿°ç±»çˆ†ç‚¸çš„æƒ…å†µã€‚ ç¼–ç  è´¦å·æ¥å£ Account 12345678910public interface Account &#123; /** * å¼€æˆ· */ Account openAccount(); /** * å¼€æˆ·ç±»å‹ */ void showAccountType();&#125; â€‹ è´¦å·çš„ä¸¤ä¸ªå®ç°ç±» SavingAccountå’Œ DepositAccount 1234567891011121314151617181920212223242526public class SavingAccount implements Account &#123; @Override public Account openAccount() &#123; System.out.println(\"SavingAccount--å¼€æ´»æœŸè´¦å·\"); return new SavingAccount(); &#125; @Override public void showAccountType() &#123; System.out.println(\"SavingAccount--è¿™æ˜¯ä¸€ä¸ªæ´»æœŸè´¦å·\"); &#125;&#125;-----public class DepositAccount implements Account &#123; @Override public Account openAccount() &#123; System.out.println(\"DepositAccount--å¼€å®šæœŸè´¦å·\"); return new DepositAccount(); &#125; @Override public void showAccountType() &#123; System.out.println(\"DepositAccouont--è¿™æ˜¯ä¸€ä¸ªå®šæœŸè´¦å·\"); &#125;&#125; â€‹ é“¶è¡ŒæŠ½è±¡ç±» Bank 123456789101112131415161718192021222324252627public abstract class Bank &#123; /** * è¿™é‡Œè¦å†™æˆä¸€ä¸ªæŠ½è±¡çš„ï¼Œå› ä¸ºè¦æŠŠAccountå¼•å…¥åˆ°Banké‡Œé¢ï¼Œé€š * è¿‡è¿™ç§ç»„åˆçš„æ–¹å¼ï¼ŒæŠŠAccountçš„è¡Œä¸ºäº¤ç»™Bankçš„å­ç±»æ¥å®ç°ï¼Œå³ * Bankè¿™ä¸ªæŠ½è±¡ç±»ä¸­çš„æŸä¸ªè¡Œä¸ºè¦å§”æ‰˜ç»™Accountè¿™ä¸ªæ¥å£çš„å®ç°ï¼Œ * æŠ½è±¡å’Œå…·ä½“çš„å®ç°åˆ†ç¦»æŒ‡å®šçš„å°±æ˜¯è¿™ç§æƒ…å†µã€‚ */ /** * è¦äº¤ç»™å­ç±»ï¼Œå£°æ˜ä¸ºprotectedï¼Œè¿™æ ·åªæœ‰å­ç±»èƒ½å¤Ÿæ‹¿åˆ° */ protected Account account; /** * é€šè¿‡æ„é€ å™¨æŠŠAccountä¼ è¿‡æ¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡setteræ³¨å…¥çš„æ–¹å¼èµ‹å€¼ */ public Bank(Account account)&#123; this.account = account; &#125; /** * è¿™ä¸ªæ–¹æ³•è¦å‚ç…§Accountæ¥å£ä¸­çš„æ–¹æ³•ï¼Œå› ä¸ºBanké‡Œé¢çš„å…·ä½“æ–¹æ³•è¦å§”æ‰˜ç»™Accounté‡Œé¢ * çš„openAccountæ–¹æ³•ï¼Œä½†è¿™é‡Œé¢æ–¹æ³•åä¸è¦æ±‚ä¸€å®šä¸€è‡´ */ abstract Account openAccount();&#125; â€‹ é“¶è¡ŒæŠ½è±¡ç±»çš„å­ç±» ABCBankå’ŒICBCBank 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class ABCBank extends Bank &#123; /** * æ„é€ çš„æ—¶å€™ä¼ å…¥çš„æ˜¯å“ªä¸ªAccountå°±è¿”å›å“ªä¸€ä¸ªAccount(openAccountæ–¹æ³•) * @param account */ public ABCBank(Account account) &#123; super(account); &#125; /** * è¿™é‡Œè¿”å›çš„å°±æ˜¯çˆ¶ç±»ä¸­çš„Account * @return */ @Override Account openAccount() &#123; System.out.println(\"ABCBank--å¼€æˆ·ä¸­å›½å†œä¸šé“¶è¡Œè´¦å·\"); // å¾ˆé‡è¦ï¼Œè¦ä½¿ç”¨çˆ¶ç±»é‡Œç»„åˆè¿›æ¥çš„Accountï¼Œä¸ç„¶æ¡¥æ¥æ¨¡å¼å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº† account.openAccount(); return account; &#125;&#125;---public class ICBCBank extends Bank &#123; /** * æ„é€ çš„æ—¶å€™ä¼ å…¥çš„æ˜¯å“ªä¸ªAccountå°±è¿”å›å“ªä¸€ä¸ªAccount(openAccountæ–¹æ³•) * @param account */ public ICBCBank(Account account) &#123; super(account); &#125; /** * è¿™é‡Œè¿”å›çš„å°±æ˜¯çˆ¶ç±»ä¸­çš„Account * @return */ @Override Account openAccount() &#123; System.out.println(\"ICBC--å¼€æˆ·ä¸­å›½å·¥å•†é“¶è¡Œè´¦å·\"); // å¾ˆé‡è¦ï¼Œè¦ä½¿ç”¨çˆ¶ç±»é‡Œç»„åˆè¿›æ¥çš„Accountï¼Œä¸ç„¶æ¡¥æ¥æ¨¡å¼å°±æ²¡ä»€ä¹ˆæ„ä¹‰äº† account.openAccount(); return account; &#125;&#125; å•å…ƒæµ‹è¯• TestDemo 1234567891011121314151617181920212223242526272829public class TestDemo &#123; public static void main(String[] args) &#123; // ICBCBank-DepositAccount Bank icbcBank = new ICBCBank(new DepositAccount()); Account icbcAccount = icbcBank.openAccount(); System.out.println(\"**************************\"); icbcAccount.showAccountType(); System.out.println(\"--------------------------\"); // ICBCBank-SavingAccount Bank icbcBank2 = new ICBCBank(new SavingAccount()); Account icbcAccount2 = icbcBank2.openAccount(); System.out.println(\"**************************\"); icbcAccount2.showAccountType(); System.out.println(\"--------------------------\"); // ABCBank-DepositAccount Bank abcBank2 = new ABCBank(new DepositAccount()); Account abcAccount2 = abcBank2.openAccount(); System.out.println(\"**************************\"); abcAccount2.showAccountType(); System.out.println(\"--------------------------\"); // ABCBank-SavingAccount Bank abcBank = new ABCBank(new SavingAccount()); Account abcAccount = abcBank.openAccount(); System.out.println(\"**************************\"); abcAccount.showAccountType(); &#125;&#125; æ€»ç»“ é€šè¿‡æ¡¥æ¥æ¨¡å¼ï¼ŒæŠŠå®ç°éƒ¨åˆ†Accountï¼ˆAccountçš„å…·ä½“å®ç°ç±»ï¼‰å’ŒæŠ½è±¡éƒ¨åˆ†Bankï¼ˆBankæŠ½è±¡ç±»ï¼‰è¿›è¡Œäº†æ¡¥æ¥ï¼Œä½¿ç”¨ç»„åˆä½œä¸ºä¸€æ ¹çº¿è¿æ¥å®ƒä»¬ã€‚å½“ç„¶ä¹Ÿæœ‰èšåˆçš„æ–¹å¼å®ç°æ¡¥æ¥ã€‚ æ¡¥æ¥æ¨¡å¼åœ¨JDKæºç ä¸­çš„åº”ç”¨å®ç°éƒ¨åˆ†1java.sql.Driveræ¥å£çš„å®ç°ï¼š å¦‚MySQLçš„Driverï¼ŒOracleçš„Driver Driveræ¥å£ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354package java.sql;import java.util.logging.Logger;/** * The interface that every driver class must implement. * &lt;P&gt;The Java SQL framework allows for multiple database drivers. * * &lt;P&gt;Each driver should supply a class that implements * the Driver interface. * * &lt;P&gt;The DriverManager will try to load as many drivers as it can * find and then for any given connection request, it will ask each * driver in turn to try to connect to the target URL. * * &lt;P&gt;It is strongly recommended that each Driver class should be * small and standalone so that the Driver class can be loaded and * queried without bringing in vast quantities of supporting code. * * &lt;P&gt;When a Driver class is loaded, it should create an instance of * itself and register it with the DriverManager. This means that a * user can load and register a driver by calling: * &lt;p&gt; * &#123;@code Class.forName(\"foo.bah.Driver\")&#125; * &lt;p&gt; * A JDBC driver may create a &#123;@linkplain DriverAction&#125; implementation in order * to receive notifications when &#123;@linkplain DriverManager#deregisterDriver&#125; has * been called. * @see DriverManager * @see Connection * @see DriverAction */public interface Driver &#123; Connection connect(String url, java.util.Properties info) throws SQLException; boolean acceptsURL(String url) throws SQLException; DriverPropertyInfo[] getPropertyInfo(String url, java.util.Properties info) throws SQLException; int getMajorVersion(); int getMinorVersion(); boolean jdbcCompliant(); public Logger getParentLogger() throws SQLFeatureNotSupportedException;&#125; Driveræ¥å£çš„MySqlé©±åŠ¨å®ç° 123456789101112131415161718192021222324252627282930313233343536373839404142package com.mysql.cj.jdbc;import java.sql.SQLException;/** * The Java SQL framework allows for multiple database drivers. Each driver should supply a class that implements the Driver interface * * &lt;p&gt; * The DriverManager will try to load as many drivers as it can find and then for any given connection request, it will ask each driver in turn to try to * connect to the target URL. * * &lt;p&gt; * It is strongly recommended that each Driver class should be small and standalone so that the Driver class can be loaded and queried without bringing in vast * quantities of supporting code. * * &lt;p&gt; * When a Driver class is loaded, it should create an instance of itself and register it with the DriverManager. This means that a user can load and register a * driver by doing Class.forName(\"foo.bah.Driver\") */public class Driver extends NonRegisteringDriver implements java.sql.Driver &#123; // // Register ourselves with the DriverManager // static &#123; try &#123; // æŠŠé©±åŠ¨æ³¨å†Œåˆ°DriverManagerä¸­ java.sql.DriverManager.registerDriver(new Driver()); &#125; catch (SQLException E) &#123; throw new RuntimeException(\"Can't register driver!\"); &#125; &#125; /** * Construct a new driver and register it with DriverManager * * @throws SQLException * if a database error occurs. */ public Driver() throws SQLException &#123; // Required for Class.forName().newInstance() &#125;&#125; æŠ½è±¡éƒ¨åˆ†1java.sql.DriverManagerè¿™ä¸ªç±»ä½œä¸ºæŠ½è±¡éƒ¨åˆ†ï¼Œå®ƒå¹¶ä¸æ˜¯æŠ½è±¡ç±»ã€‚å†æ¬¡è¯´æ˜ï¼ŒæŠ½è±¡éƒ¨åˆ†å¹¶ä¸ä¸€å®šå°±æ˜¯æŠ½è±¡ç±»æˆ–æ¥å£ï¼Œåªæ˜¯ä»æ¡¥æ¥æ¨¡å¼æ•´ä½“çœ‹ï¼ŒæŠŠå®ƒåˆ†ä¸ºä¸¤å¤§éƒ¨åˆ†ã€‚registeredDriversä½œä¸ºå®ç°éƒ¨åˆ†ç»„åˆåˆ°æŠ½è±¡éƒ¨åˆ†ã€‚ DriverInfoå®ç°éƒ¨åˆ†çš„çˆ¶ç±»å‹æ¥å£Driveråªæ˜¯ä½œä¸ºDriverInfoçš„ä¸€ä¸ªå±æ€§ 123456789101112131415161718192021222324252627282930class DriverInfo &#123; final Driver driver; DriverAction da; DriverInfo(Driver driver, DriverAction action) &#123; this.driver = driver; da = action; &#125; @Override public boolean equals(Object other) &#123; return (other instanceof DriverInfo) &amp;&amp; this.driver == ((DriverInfo) other).driver; &#125; @Override public int hashCode() &#123; return driver.hashCode(); &#125; @Override public String toString() &#123; return (\"driver[className=\" + driver + \"]\"); &#125; DriverAction action() &#123; return da; &#125;&#125; DriverManager 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209 package java.sql; import java.util.Iterator; import java.util.ServiceLoader; import java.security.AccessController; import java.security.PrivilegedAction; import java.util.concurrent.CopyOnWriteArrayList; import sun.reflect.CallerSensitive; import sun.reflect.Reflection; /** * @see Driver * @see Connection */ public class DriverManager &#123; // æ³¨å†Œ JDBC driver çš„åˆ—è¡¨ private final static CopyOnWriteArrayList&lt;DriverInfo&gt; registeredDrivers = new CopyOnWriteArrayList&lt;&gt;(); private static volatile int loginTimeout = 0; private static volatile java.io.PrintWriter logWriter = null; private static volatile java.io.PrintStream logStream = null; // Used in println() to synchronize logWriter private final static Object logSync = new Object(); /* Prevent the DriverManager class from being instantiated. */ private DriverManager()&#123;&#125; /** * Load the initial JDBC drivers by checking the System property * jdbc.properties and then use the &#123;@code ServiceLoader&#125; mechanism */ static &#123; loadInitialDrivers(); println(\"JDBC DriverManager initialized\"); &#125; /** * The &lt;code&gt;SQLPermission&lt;/code&gt; constant that allows the * setting of the logging stream. * @since 1.3 */ final static SQLPermission SET_LOG_PERMISSION = new SQLPermission(\"setLog\"); /** * The &#123;@code SQLPermission&#125; constant that allows the * un-register a registered JDBC driver. * @since 1.8 */ final static SQLPermission DEREGISTER_DRIVER_PERMISSION = new SQLPermission(\"deregisterDriver\"); //--------------------------JDBC 2.0----------------------------- /** * Retrieves the log writer. * * The &lt;code&gt;getLogWriter&lt;/code&gt; and &lt;code&gt;setLogWriter&lt;/code&gt; * methods should be used instead * of the &lt;code&gt;get/setlogStream&lt;/code&gt; methods, which are deprecated. * @return a &lt;code&gt;java.io.PrintWriter&lt;/code&gt; object * @see #setLogWriter * @since 1.2 */ public static java.io.PrintWriter getLogWriter() &#123; return logWriter; &#125; public static void setLogWriter(java.io.PrintWriter out) &#123; SecurityManager sec = System.getSecurityManager(); if (sec != null) &#123; sec.checkPermission(SET_LOG_PERMISSION); &#125; logStream = null; logWriter = out; &#125; @CallerSensitive public static Connection getConnection(String url, java.util.Properties info) throws SQLException &#123; return (getConnection(url, info, Reflection.getCallerClass())); &#125; @CallerSensitive public static Connection getConnection(String url, String user, String password) throws SQLException &#123; java.util.Properties info = new java.util.Properties(); if (user != null) &#123; info.put(\"user\", user); &#125; if (password != null) &#123; info.put(\"password\", password); &#125; return (getConnection(url, info, Reflection.getCallerClass())); &#125; @CallerSensitive public static Connection getConnection(String url) throws SQLException &#123; java.util.Properties info = new java.util.Properties(); return (getConnection(url, info, Reflection.getCallerClass())); &#125; /** * Attempts to locate a driver that understands the given URL. * The &lt;code&gt;DriverManager&lt;/code&gt; attempts to select an appropriate driver from * the set of registered JDBC drivers. * * @param url a database URL of the form * &lt;code&gt;jdbc:&lt;em&gt;subprotocol&lt;/em&gt;:&lt;em&gt;subname&lt;/em&gt;&lt;/code&gt; * @return a &lt;code&gt;Driver&lt;/code&gt; object representing a driver * that can connect to the given URL * @exception SQLException if a database access error occurs */ @CallerSensitive public static Driver getDriver(String url) throws SQLException &#123; println(\"DriverManager.getDriver(\\\"\" + url + \"\\\")\"); Class&lt;?&gt; callerClass = Reflection.getCallerClass(); for (DriverInfo aDriver : registeredDrivers) &#123; // If the caller does not have permission to load the driver then // skip it. if(isDriverAllowed(aDriver.driver, callerClass)) &#123; try &#123; if(aDriver.driver.acceptsURL(url)) &#123; // Success! println(\"getDriver returning \" + aDriver.driver.getClass().getName()); return (aDriver.driver); &#125; &#125; catch(SQLException sqe) &#123; // Drop through and try the next driver. &#125; &#125; else &#123; println(\" skipping: \" + aDriver.driver.getClass().getName()); &#125; &#125; println(\"getDriver: no suitable driver\"); throw new SQLException(\"No suitable driver\", \"08001\"); &#125; /** * Registers the given driver with the &#123;@code DriverManager&#125;. * A newly-loaded driver class should call * the method &#123;@code registerDriver&#125; to make itself * known to the &#123;@code DriverManager&#125;. If the driver is currently * registered, no action is taken. * * @param driver the new JDBC Driver that is to be registered with the * &#123;@code DriverManager&#125; * @exception SQLException if a database access error occurs * @exception NullPointerException if &#123;@code driver&#125; is null */ public static synchronized void registerDriver(java.sql.Driver driver) throws SQLException &#123; registerDriver(driver, null); &#125; /** * Registers the given driver with the &#123;@code DriverManager&#125;. * A newly-loaded driver class should call * the method &#123;@code registerDriver&#125; to make itself * known to the &#123;@code DriverManager&#125;. If the driver is currently * registered, no action is taken. * * @param driver the new JDBC Driver that is to be registered with the * &#123;@code DriverManager&#125; * @param da the &#123;@code DriverAction&#125; implementation to be used when * &#123;@code DriverManager#deregisterDriver&#125; is called * @exception SQLException if a database access error occurs * @exception NullPointerException if &#123;@code driver&#125; is null * @since 1.8 */ public static synchronized void registerDriver(java.sql.Driver driver, DriverAction da) throws SQLException &#123; /* Register the driver if it has not already been added to our list */ if(driver != null) &#123; registeredDrivers.addIfAbsent(new DriverInfo(driver, da)); &#125; else &#123; // This is for compatibility with the original DriverManager throw new NullPointerException(); &#125; println(\"registerDriver: \" + driver); &#125;&#125; â€‹ â€‹ â€‹ â€‹ â€‹","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"é€‚é…å™¨æ¨¡å¼","slug":"design_pattern/structure_type/é€‚é…å™¨æ¨¡å¼","date":"2019-09-20T16:00:00.000Z","updated":"2020-08-09T09:39:03.024Z","comments":true,"path":"posts/f5c535ea/","link":"","permalink":"https://gentryhuang.com/posts/f5c535ea/","excerpt":"","text":"å®šä¹‰å°†ä¸€ä¸ªç±»ï¼ˆè¢«é€‚é…è€…ï¼‰è½¬æ¢æˆå®¢æˆ·æœŸæœ›çš„å¦ä¸€ä¸ªæ¥å£ï¼ˆç›®æ ‡ï¼‰ï¼Œä½¿åŸæœ¬æ¥å£ä¸å…¼å®¹çš„ç±»ï¼ˆå®ƒä»¬çš„æ¥å£ä¸åŒï¼‰å¯ä»¥ä¸€èµ·å·¥ä½œï¼ˆä½¿ç”¨åŒä¸€æ¥å£äº†ï¼‰ã€‚ ç±»å‹ç»“æ„å‹ åº”ç”¨åœºæ™¯12â—†å·²ç»å­˜åœ¨çš„ç±»ï¼Œå®ƒçš„æ–¹æ³•å’Œéœ€æ±‚ä¸åŒ¹é…æ—¶â—†ä¸æ˜¯è½¯ä»¶è®¾è®¡é˜¶æ®µè€ƒè™‘çš„è®¾è®¡æ¨¡å¼ï¼Œæ˜¯éšç€è½¯ä»¶ç»´æŠ¤ï¼Œç”±äºä¸åŒäº§å“ã€ä¸åŒå‚å®¶é€ æˆåŠŸèƒ½ç±»ä¼¼è€Œæ¥å£ä¸ç›¸åŒæƒ…å†µä¸‹çš„è§£å†³æ–¹æ¡ˆï¼Œæ˜¯è½¯ä»¶ç»´æŠ¤é˜¶æ®µéœ€è¦è€ƒè™‘çš„äº‹æƒ… ä¼˜ç‚¹123â—†èƒ½æé«˜ç±»çš„é€æ˜æ€§å’Œå¤ç”¨ï¼Œç°æœ‰çš„ç±»å¤ç”¨ä½†ä¸éœ€è¦æ”¹å˜ï¼Œè§£å†³äº†ç°æœ‰ç±»å’Œç›®æ ‡ç±»ä¸åŒ¹é…çš„é—®é¢˜â—†ç›®æ ‡ç±»å’Œé€‚é…å™¨ç±»è§£è€¦ï¼Œæé«˜ç¨‹åºæ‰©å±•æ€§â—†ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå…·ä½“çš„æ“ä½œéƒ½åœ¨é€‚é…è€…ä¸­ï¼Œå®¢æˆ·ç«¯åªçŸ¥é“é€‚é…è€…ï¼Œæ‰©å±•åªéœ€å¯¹é€‚é…è€…æ‰©å±•å³å¯ ç¼ºç‚¹12â—†é€‚é…å™¨ç¼–å†™è¿‡ç¨‹éœ€è¦å…¨é¢è€ƒè™‘ï¼Œå¯èƒ½ä¼šå¢åŠ ç³»ç»Ÿçš„å¤æ‚æ€§â—†å¢åŠ ç³»ç»Ÿä»£ç å¯è¯»çš„éš¾åº¦ï¼Œå¦‚æˆ‘ä»¬è°ƒç”¨çš„æ˜¯Aæ¥å£å®ç°ï¼Œå…¶å®å†…éƒ¨å·²ç»è¢«é€‚é…æˆäº†Bæ¥å£çš„å®ç° æ‰©å±•12â—†å¯¹è±¡é€‚é…å™¨ï¼ˆç¬¦åˆç»„åˆå¤ç”¨åŸåˆ™ï¼Œå¹¶ä¸”ä½¿ç”¨å§”æ‰˜æœºåˆ¶ï¼‰â—†ç±»é€‚é…å™¨ï¼ˆé€šè¿‡ç±»ç»§æ‰¿å®ç°ï¼‰ ç›¸å…³çš„è®¾è®¡æ¨¡å¼é€‚é…å™¨æ¨¡å¼å’Œå¤–è§‚æ¨¡å¼ 123a éƒ½æ˜¯ç°æœ‰ç±»ç°å­˜ç³»ç»Ÿçš„å°è£…ï¼Œå‰è€…å¤ç”¨åŸæœ‰çš„æ¥å£ï¼Œåè€…å®šä¹‰äº†æ–°çš„æ¥å£b å‰è€…ä½¿åŸæœ‰çš„ä¸¤ä¸ªæ¥å£ååŒå·¥ä½œï¼Œåè€…åœ¨ç°æœ‰çš„ç³»ç»Ÿä¸­æä¾›ä¸€ä¸ªæ›´ä¸ºæ–¹ä¾¿çš„è®¿é—®å…¥å£c é€‚é…åŠ›åº¦ä¸åŒï¼Œåè€…é€‚é…æ•´ä¸ªå­ç³»ç»Ÿ é€‚é…å™¨æ¨¡å¼æ¼”ç»ƒ1ç±»é€‚é…å™¨é€šè¿‡ ç»§æ‰¿å…³ç³» è¾¾åˆ°é€‚é…çš„ç›®çš„ï¼Œè€Œå¯¹è±¡é€‚é…å™¨é€šè¿‡ ç»„åˆ è¾¾åˆ°é€‚é…ç›®çš„ ç±»é€‚é…å™¨æ¨¡å¼ è¢«é€‚é…è€… 12345678910111213141516171819package com.design.pattern.adapter.classadapter;import lombok.extern.slf4j.Slf4j;/** * Adaptee è¢«é€‚é…è€… * * @author shunhua * @date 2019-09-21 */@Slf4jpublic class Adaptee &#123; /** * é€‚é…æ–¹æ³•ï¼Œæƒ³è¦å’Œç›®æ ‡ç±»ä¸€èµ·å·¥ä½œ */ public void adaptee()&#123; log.info(\"è¢«é€‚é…è€…...run\"); &#125;&#125; é€‚é…å™¨ï¼ˆé€‚é…è€…ï¼‰ 1234567891011121314151617181920212223package com.design.pattern.adapter.classadapter;import lombok.extern.slf4j.Slf4j;/** * Adapter * * @author shunhua * @date 2019-09-21 */@Slf4jpublic class Adapter extends Adaptee implements Target &#123; /** * 1ã€é€‚é…è€…åªæ˜¯å®ç°ç›®æ ‡ç±»çš„æ¥å£ï¼Œå¹¶ä¸”ç»§æ‰¿è¢«é€‚é…ç±»ï¼Œè¿™æ ·ä½¿å¾—è¢«é€‚é…ç±»æ‹¥æœ‰ç›®æ ‡ç±»ç›¸å®¹çš„æ¥å£ * 2ã€åœ¨é€‚é…å™¨å®ç°ç›®æ ‡æ¥å£çš„æ–¹æ³•ä¸­è°ƒç”¨çˆ¶ç±»è¢«é€‚é…è€…çš„æ–¹æ³• */ @Override public void run() &#123; // TODO è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–çš„æ“ä½œ log.info(\"é€‚é…å™¨...run\"); super.adaptee(); &#125;&#125; ç›®æ ‡æ¥å£ 1234567891011121314package com.design.pattern.adapter.classadapter;/** * Target ç›®æ ‡ç±»æ¥å£ * * @author shunhua * @date 2019-09-21 */public interface Target &#123; /** * ç›®æ ‡æ“ä½œ */ void run();&#125; ç›®æ ‡ç±» 123456789101112131415161718package com.design.pattern.adapter.classadapter;import lombok.extern.slf4j.Slf4j;/** * CurrTarget ç›®æ ‡æ¥å£çš„å®ç°ç±»ï¼Œå¯çœå»ï¼Œåªæ˜¯ä½œæ¯”è¾ƒ * * @author shunhua * @date 2019-09-21 */@Slf4jpublic class CurrTarget implements Target &#123; @Override public void run() &#123; log.info(\"ç›®æ ‡...run\"); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425package com.design.pattern.adapter.classadapter;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-21 */public class Client &#123; @Test public void test()&#123; // ç›®æ ‡ç±»çš„æ“ä½œ Target target = new CurrTarget(); // ç›®æ ‡ç±»çš„æ–¹æ³• target.run(); // è¢«é€‚é…è€…é€šè¿‡é€‚é…å™¨è¿›è¡Œé€‚é…ï¼Œå¯ä»¥å’Œç›®æ ‡ç±»ä¸€èµ·å·¥ä½œ target = new Adapter(); // é€‚é…è€…çš„æ–¹æ³•ï¼Œå†…éƒ¨æ˜¯è¢«é€‚é…è€…çš„æ–¹æ³• target.run(); &#125;&#125; å¯¹è±¡é€‚é…æ¨¡å¼ è¢«é€‚é…è€… 12345678910111213141516171819package com.design.pattern.adapter.objectadapter;import lombok.extern.slf4j.Slf4j;/** * Adaptee è¢«é€‚é…è€… * * @author shunhua * @date 2019-09-21 */@Slf4jpublic class Adaptee &#123; /** * é€‚é…æ–¹æ³•ï¼Œæƒ³è¦å’Œç›®æ ‡ç±»ä¸€èµ·å·¥ä½œ */ public void adaptee()&#123; log.info(\"è¢«é€‚é…è€…...run\"); &#125;&#125; é€‚é…å™¨ï¼ˆé€‚é…è€…ï¼‰ 12345678910111213141516171819202122232425262728package com.design.pattern.adapter.objectadapter;import lombok.extern.slf4j.Slf4j;/** * Adapter * * @author shunhua * @date 2019-09-21 */@Slf4jpublic class Adapter implements Target &#123; /** * é€šè¿‡ç»„åˆ */ private Adaptee adaptee = new Adaptee(); /** * 1 é€‚é…å™¨æ˜¯å®ç°äº†ç›®æ ‡ç±»çš„æ¥å£ï¼Œä¸ºäº†æ˜¯è¢«é€‚é…è€…å’Œç›®æ ‡ç±»æ‹¥æœ‰åŒä¸€æ¥å£ * 2 é€šè¿‡ç»„åˆçš„æ–¹æ³•ï¼Œç›´æ¥åœ¨é€‚é…å™¨å®ç°ç›®æ ‡æ¥å£çš„æ–¹æ³•ä¸­è°ƒç”¨è¢«é€‚é…è€…å®ä¾‹çš„æ–¹æ³• */ @Override public void run() &#123; // TODO å¯ä»¥æ ¹æ®å…·ä½“ä¸šåŠ¡å¢åŠ å…¶ä»–çš„æ“ä½œ log.info(\"é€‚é…å™¨...run\"); adaptee.adaptee(); &#125;&#125; ç›®æ ‡æ¥å£ 1234567891011121314package com.design.pattern.adapter.objectadapter;/** * Target ç›®æ ‡ç±»æ¥å£ * * @author shunhua * @date 2019-09-21 */public interface Target &#123; /** * ç›®æ ‡æ“ä½œ */ void run();&#125; ç›®æ ‡ç±» 12345678910111213141516171819package com.design.pattern.adapter.objectadapter;;import lombok.extern.slf4j.Slf4j;/** * CurrTarget ç›®æ ‡æ¥å£çš„å®ç°ç±»ï¼Œå¯çœå»ï¼Œåªæ˜¯ä½œæ¯”è¾ƒ * * @author shunhua * @date 2019-09-21 */@Slf4jpublic class CurrTarget implements Target &#123; @Override public void run() &#123; log.info(\"ç›®æ ‡...run\"); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425package com.design.pattern.adapter.objectadapter;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-22 */public class Client &#123; @Test public void test()&#123; // ç›®æ ‡ç±» Target target = new CurrTarget(); target.run(); // é€šè¿‡é€‚é…å™¨æŠŠè¢«é€‚é…è€…è½¬æ¢æˆç›®æ ‡æ¥å£ç±»å‹ target = new Adapter(); // è°ƒç”¨é€‚é…å™¨å®ç°ç›®æ ‡æ¥å£çš„æ–¹æ³•ï¼Œå†…éƒ¨è°ƒç”¨çš„æ˜¯è¢«é€‚é…è€…çš„æ–¹æ³• target.run(); &#125;&#125; ç®€å•éœ€æ±‚1æ‰‹æœºç”µæºé€‚é…å™¨å¯ä»¥æŠŠ220väº¤æµç”µè½¬åŒ–ä¸º5vç›´æµç”µ ç›®æ ‡æ¥å£-5vç›´æµç”µ 123456789101112131415package com.design.pattern.adapter.demand;/** * DC5V ç›®æ ‡ç”µå‹ * * @author shunhua * @date 2019-09-22 */public interface DC5V &#123; /** * 5Vç›´æµç”µ * @return */ int outPutDC5V();&#125; éœ€è¦è¢«é€‚é…çš„ç±»-220väº¤æµç”µ 123456789101112131415161718192021package com.design.pattern.adapter.demand;import lombok.extern.slf4j.Slf4j;/** * AC220V éœ€è¦è¢«é€‚é…çš„ç”µå‹ * * @author shunhua * @date 2019-09-22 */@Slf4jpublic class AC220V &#123; /** * 220Väº¤æµç”µ * @return */ public int outputAC220V()&#123; return 220; &#125;&#125; å˜å‹å™¨-é€‚é…å™¨ 1234567891011121314151617181920212223242526package com.design.pattern.adapter.demand;import lombok.extern.slf4j.Slf4j;/** * PowerAdapter ç”µæºé€‚é…å™¨ * * @author shunhua * @date 2019-09-22 */@Slf4jpublic class PowerAdapter implements DC5V &#123; /** * é€šè¿‡ç»„åˆçš„æ–¹å¼ */ private AC220V ac220V = new AC220V(); @Override public int outPutDC5V() &#123; int ac = ac220V.outputAC220V(); int target = ac/44; // å˜å‹å¤„ç† log.info(String.format(\"é€‚é…å™¨å¤„ç†åï¼Œ%dVç”µå‹å˜ä¸º%dV\",220,target)); return 5; &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819package com.design.pattern.adapter.demand;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-22 */public class Client &#123; @Test public void test() &#123; DC5V dc5V = new PowerAdapter(); // é€šè¿‡PowerAdapteré€‚é…ï¼ŒæŠŠ220Väº¤æµè½¬ä¸º5Vç›´æµç”µ dc5V.outPutDC5V(); &#125;&#125; æºç è§£æ12åœ¨SpringMVCä¸­ï¼Œå‰ç«¯æ§åˆ¶å™¨æ¥åˆ°è¯·æ±‚åä¼šé€šè¿‡å¤„ç†å™¨æ˜ å°„å™¨æ‰¾å¤„ç†å™¨ï¼Œç„¶åè¿”å›ä¸€ä¸ªå¤„ç†å™¨æ‰§è¡Œé“¾ï¼Œæ¥ç€é€šè¿‡åŒ¹é…å¤„ç†å™¨é€‚é…å™¨æ¥ç¡®å®šå“ªä¸€ä¸ªå¤„ç†å™¨é€‚é…å™¨å¯ä»¥é€‚é…å½“å‰çš„å¤„ç†å™¨ï¼Œç¡®å®šåæ‰§è¡Œå¤„ç†æ–¹æ³•ï¼Œç„¶åè¿”å›ModelAndViewã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121protected void doDispatch(HttpServletRequest request, HttpServletResponse response) throws Exception &#123; HttpServletRequest processedRequest = request; HandlerExecutionChain mappedHandler = null; boolean multipartRequestParsed = false; WebAsyncManager asyncManager = WebAsyncUtils.getAsyncManager(request); try &#123; ModelAndView mv = null; Exception dispatchException = null; try &#123; processedRequest = checkMultipart(request); multipartRequestParsed = (processedRequest != request); // Determine handler for the current request. mappedHandler = getHandler(processedRequest); if (mappedHandler == null) &#123; noHandlerFound(processedRequest, response); return; &#125; // æ‰¾åˆ°å¤„ç†å™¨å¯¹åº”çš„å¤„ç†å™¨é€‚é…å™¨ HandlerAdapter ha = getHandlerAdapter(mappedHandler.getHandler()); // Process last-modified header, if supported by the handler. String method = request.getMethod(); boolean isGet = \"GET\".equals(method); if (isGet || \"HEAD\".equals(method)) &#123; long lastModified = ha.getLastModified(request, mappedHandler.getHandler()); if (new ServletWebRequest(request, response).checkNotModified(lastModified) &amp;&amp; isGet) &#123; return; &#125; &#125; if (!mappedHandler.applyPreHandle(processedRequest, response)) &#123; return; &#125; // å®é™…è°ƒç”¨å¤„ç†å™¨ï¼Œç„¶åè¿”å›ModelAndView mv = ha.handle(processedRequest, response, mappedHandler.getHandler()); if (asyncManager.isConcurrentHandlingStarted()) &#123; return; &#125; applyDefaultViewName(processedRequest, mv); mappedHandler.applyPostHandle(processedRequest, response, mv); &#125; catch (Exception ex) &#123; dispatchException = ex; &#125; catch (Throwable err) &#123; // As of 4.3, we're processing Errors thrown from handler methods as well, // making them available for @ExceptionHandler methods and other scenarios. dispatchException = new NestedServletException(\"Handler dispatch failed\", err); &#125; processDispatchResult(processedRequest, response, mappedHandler, mv, dispatchException); &#125; catch (Exception ex) &#123; triggerAfterCompletion(processedRequest, response, mappedHandler, ex); &#125; catch (Throwable err) &#123; triggerAfterCompletion(processedRequest, response, mappedHandler, new NestedServletException(\"Handler processing failed\", err)); &#125; finally &#123; if (asyncManager.isConcurrentHandlingStarted()) &#123; // Instead of postHandle and afterCompletion if (mappedHandler != null) &#123; mappedHandler.applyAfterConcurrentHandlingStarted(processedRequest, response); &#125; &#125; else &#123; // Clean up any resources used by a multipart request. if (multipartRequestParsed) &#123; cleanupMultipart(processedRequest); &#125; &#125; &#125; &#125; // å¤„ç†å™¨æ˜ å°„å™¨æ‰¾å¤„ç†å™¨é€»è¾‘ï¼ˆè¿”å›å¤„ç†å™¨æ‰§è¡Œé“¾ï¼ŒåŒ…å«äº†å¤„ç†å™¨ï¼‰/** * Return the HandlerExecutionChain for this request. * &lt;p&gt;Tries all handler mappings in order. * @param request current HTTP request * @return the HandlerExecutionChain, or &#123;@code null&#125; if no handler could be found */ @Nullable protected HandlerExecutionChain getHandler(HttpServletRequest request) throws Exception &#123; if (this.handlerMappings != null) &#123; for (HandlerMapping mapping : this.handlerMappings) &#123; HandlerExecutionChain handler = mapping.getHandler(request); if (handler != null) &#123; return handler; &#125; &#125; &#125; return null; &#125; // åŒ¹é…åˆé€‚çš„å¤„ç†å™¨é€‚é…å™¨é€»è¾‘ /** * Return the HandlerAdapter for this handler object. * @param handler the handler object to find an adapter for * @throws ServletException if no HandlerAdapter can be found for the handler. This is a fatal error. */ protected HandlerAdapter getHandlerAdapter(Object handler) throws ServletException &#123; if (this.handlerAdapters != null) &#123; for (HandlerAdapter adapter : this.handlerAdapters) &#123; if (adapter.supports(handler)) &#123; return adapter; &#125; &#125; &#125; throw new ServletException(\"No adapter for handler [\" + handler + \"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler\"); &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è£…é¥°è€…æ¨¡å¼","slug":"design_pattern/structure_type/è£…é¥°è€…æ¨¡å¼","date":"2019-09-18T16:00:00.000Z","updated":"2020-08-09T09:37:50.231Z","comments":true,"path":"posts/a708a60d/","link":"","permalink":"https://gentryhuang.com/posts/a708a60d/","excerpt":"","text":"å®šä¹‰åœ¨ä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œå°†åŠŸèƒ½é™„åŠ åˆ°å¯¹è±¡ä¸Šã€‚æä¾›äº†æ¯”ç»§æ‰¿æ›´æœ‰å¼¹æ€§çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆæ‰©å±•åŸæœ‰å¯¹è±¡åŠŸèƒ½ï¼‰ã€‚ ç±»å‹ç»“æ„å‹ åº”ç”¨åœºæ™¯12â—†æ‰©å±•ä¸€ä¸ªç±»çš„åŠŸèƒ½æˆ–ç»™ä¸€ä¸ªç±»æ·»åŠ é™„åŠ èŒè´£â—†åŠ¨æ€çš„ç»™ä¸€ä¸ªå¯¹è±¡æ·»åŠ åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½å¯ä»¥å†åŠ¨æ€çš„æ’¤é”€ ä¼˜ç‚¹123â—†ç»§æ‰¿çš„æœ‰åŠ›è¡¥å……ï¼Œæ¯”ç»§æ‰¿çµæ´»ï¼Œä¸æ”¹å˜åŸæœ‰å¯¹è±¡çš„æƒ…å†µä¸‹ç»™ä¸€ä¸ªå¯¹è±¡æ‰©å±•åŠŸèƒ½ã€‚ä¸€èˆ¬æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç»§æ‰¿å®ç°åŠŸèƒ½çš„æ‰©å±•ï¼Œå¦‚æœéœ€è¦æ‰©å±•çš„åŠŸèƒ½ç§ç±»ç¹å¤šï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šç”Ÿæˆå¾ˆå¤šå­ç±»ï¼Œè¿™æ— ç–‘å¢åŠ äº†ç³»ç»Ÿçš„å¤æ‚æ€§ã€‚å¹¶ä¸”ä½¿ç”¨ç»§æ‰¿éœ€è¦æå‰é¢„çŸ¥å“ªäº›åŠŸèƒ½ï¼Œå› ä¸ºç»§æ‰¿å…³ç³»åœ¨ç¼–è¯‘çš„æ—¶å€™å°±ç¡®å®šäº†ã€‚è€Œè£…é¥°è€…æ¨¡å¼å¯ä»¥åŠ¨æ€åœ°åŠ å…¥ã€‚å…¶å®è£…é¥°è€…æ¨¡å¼ä¹Ÿæ˜¯å»ºç«‹åœ¨ç»§æ‰¿çš„å…³ç³»åŸºç¡€ä¹‹ä¸Šçš„ï¼Œæ³¨æ„ï¼Œè¿™ä¸æ„å‘³ç€å°±ä¸ä½¿ç”¨ç»§æ‰¿äº†ï¼Œç»§æ‰¿ä¹Ÿæ˜¯æ‰©å±•å½¢å¼ä¹‹ä¸€ï¼Œåªæ˜¯æŸäº›æ—¶å€™ä¸ä¸€å®šèƒ½è¾¾åˆ°å¼¹æ€§è®¾è®¡çš„æœ€ä½³æ–¹å¼ã€‚â—†é€šè¿‡ä½¿ç”¨ä¸åŒè£…é¥°ç±»ä»¥åŠè¿™äº›è£…é¥°ç±»çš„æ’åˆ—ç»„åˆï¼Œå¯ä»¥å®ç°ä¸åŒæ•ˆæœâ—†ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œè£…é¥°è€…å’Œè¢«è£…é¥°è€…å¯ä»¥ç‹¬ç«‹å˜åŒ–ï¼ŒåŸæœ‰çš„ä»£ç ä¸éœ€è¦æ”¹å˜ã€‚å…¶å®è£…é¥°è€…åšçš„æ˜¯æŠŠè£…é¥°åŠŸèƒ½ä»ç±»ä¸­ç§»å‡ºå»ï¼Œè¿™æ ·ç®€åŒ–äº†åŸæ¥è¢«è£…é¥°çš„ç±»ï¼ŒåŒæ—¶æŠŠç±»çš„æ ¸å¿ƒèŒè´£å’Œè£…é¥°åŠŸèƒ½åŒºåˆ†å¼€ã€‚ ç¼ºç‚¹12â—†ä¼šå‡ºç°æ›´å¤šçš„ä»£ç ï¼Œæ›´å¤šçš„ç±»ï¼Œå¢åŠ ç¨‹åºå¤æ‚æ€§ã€‚è£…é¥°è€…æ¨¡å¼å¯èƒ½ä¼šæ¯”ç»§æ‰¿æ–¹å¼çš„ä½¿ç”¨çš„ç±»è¦å°‘ï¼Œä½†æ˜¯å¯¹è±¡å¾ˆå¤šï¼Œå¹¶ä¸”è¿™äº›å¯¹è±¡ç±»å‹æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºè£…é¥°è€…ä¼šç»§æ‰¿è¢«è£…é¥°ç±»ï¼Œè€Œè¢«è£…é¥°ç±»åˆæœ‰å…·ä½“çš„å®ä½“ï¼Œè¿™äº›å®ä½“å¯¹è±¡ç±»å‹åˆä¸€æ ·ï¼Œæ‰€æœ‰æ’æŸ¥é—®é¢˜å¢åŠ äº†éš¾åº¦ã€‚â—†åŠ¨æ€è£…é¥°æ—¶ï¼Œå¤šå±‚è£…é¥°æ—¶ä¼šæ›´å¤æ‚ å…³è”çš„è®¾è®¡æ¨¡å¼è£…é¥°è€…æ¨¡å¼å’Œä»£ç†æ¨¡å¼ 121 è£…é¥°è€…æ¨¡å¼å…³æ³¨åŠ¨æ€åœ°æ·»åŠ æ–¹æ³•ï¼Œä»£ç†æ¨¡å¼å…³æ³¨äºæ§åˆ¶å¯¹å¯¹è±¡çš„è®¿é—®2 ä»£ç†æ¨¡å¼ä¸­çš„ä»£ç†ç±»å¯ä»¥å¯¹å®ƒçš„å®¢æˆ·éšè—ä¸€ä¸ªå¯¹è±¡çš„å…·ä½“ä¿¡æ¯ï¼Œé€šå¸¸åœ¨ä½¿ç”¨ä»£ç†æ¨¡å¼çš„æ—¶å€™å¸¸å¸¸åœ¨ä»£ç†ç±»ä¸­åˆ›å»ºä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹ï¼Œè£…é¥°è€…æ¨¡å¼é€šå¸¸æŠŠåŸå§‹å¯¹è±¡ä½œä¸ºä¸€ä¸ªå‚æ•°ä¼ å…¥è£…é¥°è€…çš„æ„é€ å™¨ï¼Œè¿™æ˜¯ä½¿ç”¨ä¸Šçš„ä¸åŒã€‚ è£…é¥°è€…æ¨¡å¼å’Œé€‚é…å™¨æ¨¡å¼ 1231 ä¸¤è€…éƒ½æ˜¯åŒ…è£…è€…æ¨¡å¼2 è£…é¥°è€…å’Œè¢«è£…é¥°è€…å¯ä»¥å®ç°ç›¸åŒçš„æ¥å£æˆ–è€…è£…é¥°è€…æ˜¯è¢«è£…é¥°è€…çš„å­ç±»3 é€‚é…å™¨å’Œè¢«é€‚é…çš„ç±»æœ‰ä¸åŒçš„æ¥å£ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯éƒ¨åˆ†æ¥å£æ˜¯é‡åˆçš„ ç®€å•éœ€æ±‚ä¹°ç…é¥¼çš„æ—¶å€™å¯ä»¥æ ¹æ®è‡ªèº«æƒ…å†µè¦æ±‚åŠ é¸¡è›‹æˆ–è€…é¦™è‚ ï¼Œå–ç…é¥¼çš„æ ¹æ®éœ€æ±‚å»åšç…é¥¼ã€‚ è£…é¥°è€…æ¨¡å¼æ¼”ç»ƒéè£…é¥°è€…æ¨¡å¼12éœ€æ±‚ï¼šåŠ ä¸€ä¸ªé¸¡è›‹åŠ ä¸€å…ƒï¼Œä¸€ä¸ªç«è…¿ä¸¤å…ƒï¼Œç°åœ¨aä¹°ä¸€ä¸ªç…é¥¼ï¼Œbä¹°åŠ è›‹çš„ç…é¥¼ï¼Œcä¹°åŠ è‚ çš„ç…é¥¼æ–¹æ¡ˆï¼šé€šè¿‡å †ç§¯ç±»å®Œæˆéœ€æ±‚ï¼Œä½†æ˜¯é¢å¯¹ä¼—å¤šçš„éœ€æ±‚ä¼šç±»çˆ†ç‚¸çš„ã€‚ ç…é¥¼ç±» 12345678910111213141516171819202122232425package com.design.pattern.decorator.v1;/** * BatterCake ç…é¥¼ç±» * * @author shunhua * @date 2019-09-19 */public class BatterCake &#123; /** * è·å–é£Ÿå“æè¿° * @return */ public String getDesc()&#123; return \"ç…é¥¼\"; &#125; /** * é£Ÿå“å•ä»· * @return */ public int cost()&#123; return 5; &#125;&#125; é¸¡è›‹ç…é¥¼ç±» 1234567891011121314151617181920package com.design.pattern.decorator.v1;/** * BatterCakeWithEgg åŠ é¸¡è›‹çš„ç…é¥¼ * * @author shunhua * @date 2019-09-19 */public class BatterCakeWithEgg extends BatterCake &#123; @Override public String getDesc() &#123; return super.getDesc() + \" åŠ ä¸€ä¸ªé¸¡è›‹\"; &#125; @Override public int cost() &#123; return super.cost() + 1; &#125;&#125; é¦™è‚ ç…é¥¼ç±» 12345678910111213141516171819package com.design.pattern.decorator.v1;/** * BatterCakeWithSausage åŠ é¦™è‚ çš„ç…é¥¼ * * @author shunhua * @date 2019-09-19 */public class BatterCakeWithSausage extends BatterCake &#123; @Override public String getDesc() &#123; return super.getDesc() + \" åŠ ä¸€ä¸ªé¦™è‚ \"; &#125; @Override public int cost() &#123; return super.cost() + 2; &#125;&#125; å®¢æˆ·ç«¯ 1234567891011121314151617181920212223242526272829package com.design.pattern.decorator.v1;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-19 */@Slf4jpublic class Client &#123; @Test public void test()&#123; // ç…é¥¼ BatterCake batterCake = new BatterCake(); log.info(batterCake.getDesc() + \"é”€å”®ä»·æ ¼ä¸º \" + batterCake.cost()); // é¸¡è›‹ç…é¥¼ BatterCakeWithEgg batterCakeWithEgg = new BatterCakeWithEgg(); log.info(batterCakeWithEgg.getDesc() + \"é”€å”®ä»·æ ¼ä¸º \" + batterCakeWithEgg.cost()); // é¦™è‚ ç…é¥¼ BatterCakeWithSausage batterCakeWithSausage = new BatterCakeWithSausage(); log.info(batterCakeWithSausage.getDesc() + \"é”€å”®ä»·æ ¼ä¸º \" + batterCakeWithEgg.cost()); &#125;&#125; è£…é¥°è€…æ¨¡å¼12éœ€æ±‚ï¼šç°åœ¨è‚ å’Œè›‹éšæœºï¼Œa åŠ 2è›‹2è‚  båŠ 1è›‹2è‚ æ–¹æ¡ˆï¼šä½¿ç”¨è£…é¥°ç±»æ·»åŠ åŠŸèƒ½ï¼Œä¸ºç…é¥¼åŠ é¸¡è›‹ã€åŠ é¦™è‚  è¦æ±‚ï¼š æ‰€è°“è£…é¥°è€…æ¨¡å¼ï¼Œé€šç”¨åšæ³•è¦æœ‰æŠ½è±¡çš„å®ä½“ç±»å’Œç¡®å®šçš„å®ä½“ç±»ï¼ŒåŒæ—¶è¦æœ‰æŠ½è±¡çš„è£…é¥°è€…å’Œç¡®å®šçš„è£…é¥°è€…ã€‚ç°åœ¨å®ä½“ç±»æ˜¯ç…é¥¼ï¼Œè£…é¥°è€…æ˜¯é¸¡è›‹å’Œé¦™è‚ ã€‚ å…³è”ï¼š ç…é¥¼å®ä½“ç±»ç»§æ‰¿ç…é¥¼æŠ½è±¡ç±»ï¼Œè£…é¥°è€…æŠ½è±¡ç±»ä¹Ÿç»§æ‰¿ç…é¥¼æŠ½è±¡ç±»ï¼Œé€šè¿‡å®ƒä»¬çš„çˆ¶ç±»ç»„åˆæ¥è¾¾åˆ°ç…é¥¼å®ä½“ç±»å’Œè£…é¥°è€…æŠ½è±¡ç±»çš„å…³ç³» æŠ½è±¡ç…é¥¼ç±» 123456789101112131415161718192021package com.design.pattern.decorator.v2;/** * AbstractBatterCake æŠ½è±¡ç…é¥¼ç±»ï¼ˆä¹Ÿå¯ä»¥æ˜¯æ¥å£ï¼‰ * * @author shunhua * @date 2019-09-19 */public abstract class AbstractBatterCake &#123; /** * é£Ÿå“æè¿° * @return */ public abstract String getDesc(); /** * ä»·æ ¼ * @return */ public abstract int cost();&#125; ç…é¥¼ç±» 1234567891011121314151617181920package com.design.pattern.decorator.v2;/** * BatterCake å®ä½“ç…é¥¼ç±» * * @author shunhua * @date 2019-09-19 */public class BatterCake extends AbstractBatterCake &#123; @Override public String getDesc() &#123; return \"ç…é¥¼\"; &#125; @Override public int cost() &#123; return 5; &#125;&#125; æŠ½è±¡è£…é¥°ç±» 123456789101112131415161718192021222324252627282930313233343536package com.design.pattern.decorator.v2;/** * * è£…é¥°è€…åŒæ ·ç»§æ‰¿ æŠ½è±¡ç…é¥¼ç±»ï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿ ï¼Œå’Œç…é¥¼ç±»äº¤äº’ * * å¦‚æœä¸ç”¨æ„é€ å™¨çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨setæ–¹å¼ * * @author shunhua * @date 2019-09-19 */public abstract class AbstractDecorator extends AbstractBatterCake &#123; /** * å®šä¹‰ç…é¥¼å±æ€§ï¼Œç”¨äºæ³¨å…¥ */ private AbstractBatterCake batterCake; public AbstractDecorator(AbstractBatterCake batterCake)&#123; this.batterCake = batterCake; &#125; @Override public String getDesc() &#123; return batterCake.getDesc(); &#125; @Override public int cost() &#123; return batterCake.cost(); &#125; /** * è£…é¥°è€…å®ä½“ç±»ç‰¹æœ‰æ“ä½œ */ protected abstract void handle();&#125; é¸¡è›‹è£…é¥°ç±» 1234567891011121314151617181920212223242526272829303132package com.design.pattern.decorator.v2;import lombok.extern.slf4j.Slf4j;/** * EggDecorator * * @author shunhua * @date 2019-09-19 */@Slf4jpublic class EggDecorator extends AbstractDecorator &#123; public EggDecorator(AbstractBatterCake batterCake) &#123; super(batterCake); &#125; @Override public String getDesc() &#123; return super.getDesc() + \" åŠ ä¸€ä¸ªé¸¡è›‹\"; &#125; @Override public int cost() &#123; return super.cost() + 1; &#125; @Override protected void handle() &#123; log.info(\"é¸¡è›‹è£…é¥°è€…ç‰¹æœ‰çš„å¤„ç†\"); &#125;&#125; é¦™è‚ è£…é¥°ç±» 1234567891011121314151617181920212223242526272829303132package com.design.pattern.decorator.v2;import lombok.extern.slf4j.Slf4j;/** * SauseDecorator * * @author shunhua * @date 2019-09-19 */@Slf4jpublic class SauseDecorator extends AbstractDecorator &#123; public SauseDecorator(AbstractBatterCake batterCake) &#123; super(batterCake); &#125; @Override public String getDesc() &#123; return super.getDesc() + \" åŠ ä¸€ä¸ªé¦™è‚ \"; &#125; @Override public int cost() &#123; return super.cost() + 2; &#125; @Override protected void handle() &#123; log.info(\"é¦™è‚ è£…é¥°è€…ç‰¹æœ‰çš„å¤„ç†æ–¹å¼\"); &#125;&#125; å®¢æˆ·ç«¯ 1234567891011121314151617181920212223242526272829package com.design.pattern.decorator.v2;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-19 */@Slf4jpublic class Client &#123; @Test public void test()&#123; AbstractBatterCake batterCake; // è£…é¥°ç…é¥¼ batterCake = new BatterCake(); // é¸¡è›‹è£…é¥° batterCake = new EggDecorator(batterCake); batterCake = new EggDecorator(batterCake); ((EggDecorator) batterCake).handle(); // é¦™è‚ è£…é¥° batterCake = new SauseDecorator(batterCake); ((SauseDecorator) batterCake).handle(); log.info(batterCake.getDesc() + \" ä¸€å…±å–äº†\" + batterCake.cost() + \"å…ƒ\"); &#125;&#125; è£…é¥°è€…æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨BufferedReader 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081public class BufferedReader extends Reader &#123; private Reader in; private char cb[]; private int nChars, nextChar; // todo çœç•¥ /** * å¯¹Readerç±»å‹çš„ å®ä¾‹è¿›è¡ŒåŒ…è£… */ public BufferedReader(Reader in, int sz) &#123; super(in); if (sz &lt;= 0) throw new IllegalArgumentException(\"Buffer size &lt;= 0\"); this.in = in; cb = new char[sz]; nextChar = nChars = 0; &#125; /** * Creates a buffering character-input stream that uses a default-sized * input buffer. * * @param in A Reader */ public BufferedReader(Reader in) &#123; this(in, defaultCharBufferSize); &#125; /** * è¿™é‡Œä½¿ç”¨Reader ç±»å‹å¯¹è±¡è¿›è¡Œæ“ä½œ */ private void fill() throws IOException &#123; int dst; if (markedChar &lt;= UNMARKED) &#123; /* No mark */ dst = 0; &#125; else &#123; /* Marked */ int delta = nextChar - markedChar; if (delta &gt;= readAheadLimit) &#123; /* Gone past read-ahead limit: Invalidate mark */ markedChar = INVALIDATED; readAheadLimit = 0; dst = 0; &#125; else &#123; if (readAheadLimit &lt;= cb.length) &#123; /* Shuffle in the current buffer */ System.arraycopy(cb, markedChar, cb, 0, delta); markedChar = 0; dst = delta; &#125; else &#123; /* Reallocate buffer to accommodate read-ahead limit */ char ncb[] = new char[readAheadLimit]; System.arraycopy(cb, markedChar, ncb, 0, delta); cb = ncb; markedChar = 0; dst = delta; &#125; nextChar = nChars = delta; &#125; &#125; int n; do &#123; n = in.read(cb, dst, cb.length - dst); &#125; while (n == 0); if (n &gt; 0) &#123; nChars = dst + n; nextChar = dst; &#125; &#125;&#125;/** * æ³¨æ„Readeræ˜¯æŠ½è±¡çš„ */public abstract class Reader implements Readable, Closeable &#123; // todo çœç•¥&#125; InputStreamç±»å‹ä½œä¸ºè¢«è£…é¥°ç±»å‹ï¼Œå®ƒçš„è£…é¥°è€…æœ‰å¾ˆå¤šï¼Œå¦‚ä¸Šå›¾ä¸­åˆ—å‡ºFilerInputStreamã€BufferedInputStreamä»¥åŠLineInputStreamã€‚åœ¨è£…é¥°è€…å†…éƒ¨æœ¬è´¨ä¸Šéƒ½æ˜¯ä½¿ç”¨InputStreamçš„å®ä¾‹æ“ä½œçš„ã€‚ BufferedInputStream 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class BufferedInputStream extends FilterInputStream &#123; private static int DEFAULT_BUFFER_SIZE = 8192; private static int MAX_BUFFER_SIZE = Integer.MAX_VALUE - 8; protected volatile byte buf[]; private static final AtomicReferenceFieldUpdater&lt;BufferedInputStream, byte[]&gt; bufUpdater = AtomicReferenceFieldUpdater.newUpdater (BufferedInputStream.class, byte[].class, \"buf\"); protected int count; protected int pos; protected int markpos = -1; protected int marklimit; private InputStream getInIfOpen() throws IOException &#123; InputStream input = in; if (input == null) throw new IOException(\"Stream closed\"); return input; &#125; /** * å¯¹InputStreamç±»å‹è¿›è¡ŒåŒ…è£… */ public BufferedInputStream(InputStream in) &#123; this(in, DEFAULT_BUFFER_SIZE); &#125; /** * å¯¹InputStreamç±»å‹è¿›è¡ŒåŒ…è£… */ public BufferedInputStream(InputStream in, int size) &#123; super(in); if (size &lt;= 0) &#123; throw new IllegalArgumentException(\"Buffer size &lt;= 0\"); &#125; buf = new byte[size]; &#125;&#125; Servletçš„HttpServletRequestWrapper HttpServletRequestWrapperç»§æ‰¿äº†ServletRequestWrapperä¹Ÿå®ç°äº†HttpServletRequest,å®ƒä»¬çš„å…¬å…±çˆ¶ç±»æ˜¯ServletRequest. 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798/** * HttpServletRequestWrapperè£…é¥°ç±» */public class HttpServletRequestWrapper extends ServletRequestWrapper implements HttpServletRequest &#123; /** * å¯¹HttpServletRequestè¿›è¡Œè£…é¥°ï¼ŒServletRequestWrapperæŠ½è±¡çš„è£…é¥°è€…ä¹Ÿå¯¹HttpServletRequestçš„çˆ¶ç±»è¿›è¡Œè£…é¥° */ public HttpServletRequestWrapper(HttpServletRequest request) &#123; super(request); &#125; private HttpServletRequest _getHttpServletRequest() &#123; return (HttpServletRequest) super.getRequest(); &#125; /** * The default behavior of this method is to return getAuthType() * on the wrapped request object. */ public String getAuthType() &#123; return this._getHttpServletRequest().getAuthType(); &#125; /** * The default behavior of this method is to return getCookies() * on the wrapped request object. */ public Cookie[] getCookies() &#123; return this._getHttpServletRequest().getCookies(); &#125; /** * The default behavior of this method is to return getDateHeader(String name) * on the wrapped request object. */ public long getDateHeader(String name) &#123; return this._getHttpServletRequest().getDateHeader(name); &#125;&#125;/*** ServletRequestWrapperè£…é¥°ç±»*/public class ServletRequestWrapper implements ServletRequest &#123; private ServletRequest request; /** * Creates a ServletRequest adaptor wrapping the given request object. * @throws java.lang.IllegalArgumentException if the request is null */ public ServletRequestWrapper(ServletRequest request) &#123; if (request == null) &#123; throw new IllegalArgumentException(\"Request cannot be null\"); &#125; this.request = request; &#125; /** * Return the wrapped request object. */ public ServletRequest getRequest() &#123; return this.request; &#125; /** * Sets the request object being wrapped. * @throws java.lang.IllegalArgumentException if the request is null. */ public void setRequest(ServletRequest request) &#123; if (request == null) &#123; throw new IllegalArgumentException(\"Request cannot be null\"); &#125; this.request = request; &#125; /** * * The default behavior of this method is to call getAttribute(String name) * on the wrapped request object. */ public Object getAttribute(String name) &#123; return this.request.getAttribute(name); &#125; /** * The default behavior of this method is to return getAttributeNames() * on the wrapped request object. */ public Enumeration getAttributeNames() &#123; return this.request.getAttributeNames(); &#125; &#125; MyBatisçš„FifoCache MyBatisçš„Cacheæ¨¡å—ä¸­ä½¿ç”¨å¤§é‡çš„è£…é¥°è€…æ¨¡å¼ï¼Œåœ¨decoratorsåŒ…ä¸‹éƒ½æ˜¯çš„ï¼Œä¸‹é¢åˆ—ä¸¾æœ€è¿‘æœ€å°‘ä½¿ç”¨ç­–ç•¥çš„è£…é¥°ç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839/*** lruç®—æ³• æœ€è¿‘æœ€å°‘ä½¿ç”¨*/public class LruCache implements Cache &#123; private final Cache delegate; private Map&lt;Object, Object&gt; keyMap; private Object eldestKey; public LruCache(Cache delegate) &#123; this.delegate = delegate; setSize(1024); &#125; @Override public String getId() &#123; return delegate.getId(); &#125; @Override public int getSize() &#123; return delegate.getSize(); &#125; public void setSize(final int size) &#123; keyMap = new LinkedHashMap&lt;Object, Object&gt;(size, .75F, true) &#123; private static final long serialVersionUID = 4267176411845948333L; @Override protected boolean removeEldestEntry(Map.Entry&lt;Object, Object&gt; eldest) &#123; boolean tooBig = size() &gt; size; if (tooBig) &#123; eldestKey = eldest.getKey(); &#125; return tooBig; &#125; &#125;; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å¤–è§‚æ¨¡å¼","slug":"design_pattern/structure_type/å¤–è§‚æ¨¡å¼","date":"2019-09-16T16:00:00.000Z","updated":"2020-08-09T09:34:58.171Z","comments":true,"path":"posts/f7de8aa8/","link":"","permalink":"https://gentryhuang.com/posts/f7de8aa8/","excerpt":"","text":"å®šä¹‰åˆå«é—¨é¢æ¨¡å¼ï¼Œæä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œç”¨æ¥è®¿é—®å­ç³»ç»Ÿä¸­çš„ä¸€ç¾¤æ¥å£ã€‚å¤–è§‚æ¨¡å¼å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¥å£ï¼Œè®©å­ç³»ç»Ÿæ›´å®¹æ˜“ä½¿ç”¨ã€‚ ç±»å‹ç»“æ„å‹ ä½¿ç”¨åœºæ™¯ å­ç³»ç»Ÿè¶Šæ¥è¶Šå¤æ‚ï¼Œå¢åŠ å¤–è§‚æ¨¡å¼æä¾›ç®€å•è°ƒç”¨æ¥å£ æ„å»ºå¤šå±‚ç³»ç»Ÿç»“æ„ï¼Œåˆ©ç”¨å¤–è§‚å¯¹è±¡ä½œä¸ºæ¯å±‚çš„å…¥å£ï¼Œç®€åŒ–å±‚é—´è°ƒç”¨ ä¼˜ç‚¹1234â—†ç®€åŒ–äº†è°ƒç”¨è¿‡ç¨‹ï¼Œæ— éœ€äº†è§£æ·±å…¥å­ç³»ç»Ÿï¼Œé˜²æ­¢å¸¦æ¥é£é™©(å°†å­ç³»ç»Ÿé›†æˆåˆ°ä¸€èµ·ï¼Œä¸å»ä¿®æ”¹å­ç³»ç»Ÿ)ã€‚â—†å‡å°‘ç³»ç»Ÿä¾èµ–ã€æ¾æ•£è€¦åˆï¼ˆå®¢æˆ·ç«¯ä¸å­ç³»ç»Ÿï¼‰â—†æ›´å¥½çš„åˆ’åˆ†è®¿é—®å±‚æ¬¡â—†ç¬¦åˆè¿ªç±³ç‰¹æ³•åˆ™ï¼Œå³æœ€å°‘çŸ¥é“åŸåˆ™ ç¼ºç‚¹12â—†å¢åŠ å­ç³»ç»Ÿã€æ‰©å±•å­ç³»ç»Ÿè¡Œä¸ºå®¹æ˜“å¼•å…¥é£é™©â—†å¢åŠ å­ç³»ç»Ÿã€æ‰©å±•å­ç³»ç»Ÿè¡Œä¸ºä¸ç¬¦åˆå¼€é—­åŸåˆ™ ç›¸å…³è”è®¾è®¡æ¨¡å¼å¯¹æ¯”å¤–è§‚æ¨¡å¼å’Œä¸­ä»‹è€…æ¨¡å¼ 1å‰è€…å…³æ³¨å¤–ç•Œå’Œå­ç³»ç»Ÿçš„äº¤äº’ï¼Œåè€…å…³æ³¨å­ç³»ç»Ÿå†…éƒ¨çš„äº¤äº’ å¤–è§‚æ¨¡å¼å’Œå•ä¾‹æ¨¡å¼ 1å¤–è§‚æ¨¡å¼å’Œå•ä¾‹æ¨¡å¼å¯ä»¥ç»“åˆä½¿ç”¨,é€šå¸¸æŠŠå¤–è§‚æ¨¡å¼ä¸­çš„å¤–è§‚åšæˆå•ä¾‹çš„ å¤–è§‚æ¨¡å¼å’ŒæŠ½è±¡å·¥å‚æ¨¡å¼ 1å‰è€…å¯ä»¥é€šè¿‡åè€…è·å–å­ç³»ç»Ÿçš„å®ä¾‹ï¼Œå­ç³»ç»Ÿå¯ä»¥ç»å†…éƒ¨å¯¹å¤–è§‚ç±»è¿›è¡Œå±è”½ ç®€å•éœ€æ±‚ æŸç½‘ç«™æœ‰ç§¯åˆ†å…‘æ¢ç¤¼ç‰©çš„åŠŸèƒ½ï¼Œè®¾è®¡çš„æ—¶å€™éœ€è¦æ ¡éªŒä¸‰æ­¥ï¼š a èµ„æ ¼æ ¡éªŒç³»ç»Ÿï¼Œæ˜¯æœ¨æœ¨ç½‘ä¼šå‘˜ã€‚ b ç§¯åˆ†ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿæ”¾çš„æ˜¯å„ä¸ªç§¯åˆ†çš„è·å–æ”¯å‡ºï¼Œéœ€è¦æ‹¿å‡ºè¯¥ç”¨æˆ·ç›®å‰çš„ç§¯åˆ†å’Œè¯¥ç¤¼ç‰©æ‰€éœ€è¦çš„ç§¯åˆ†è¿›è¡Œå¯¹æ¯” c ç‰©æµç³»ç»Ÿï¼Œå¦‚æœæ»¡è¶³abï¼Œåˆ™è¿”å›æˆåŠŸï¼Œå¹¶è¿”å›ä¸€ä¸ªè®¢å•å·ã€‚ å…³æ³¨ç‚¹ï¼š åº”ç”¨å±‚æ— éœ€çŸ¥é“èµ„æ ¼æ ¡éªŒç±»ç­‰å…¶ä»–å­ç³»ç»Ÿçš„ç±» å¤–è§‚æ¨¡å¼æ¼”ç»ƒ 121. åº”ç”¨å±‚ä¸å…³å¿ƒå­ç³»ç»Ÿï¼Œåº”ç”¨å±‚åªå’Œå¤–è§‚ç±»é€šä¿¡ï¼Œå­ç³»ç»Ÿåªå’Œå¤–è§‚ç±»é€šä¿¡2. å¦‚æœæ‰©å±•å­ç³»ç»Ÿçš„ï¼Œä½¿ç”¨å®ä½“å¤–è§‚ç±»çš„è¯ï¼Œä¸ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå¦‚æœä½¿ç”¨æŠ½è±¡å¤–è§‚ç±»æˆ–è€…å¤–è§‚æ¥å£ï¼Œç„¶åç”¨å®ä½“ç»§æ‰¿æˆ–å®ç°çš„è¯ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ã€‚ä¸»è¦çœ‹å¤–è§‚å¯¹åº”çš„å­ç³»ç»Ÿç¾¤æ˜¯å¦å˜æ›´é¢‘ç¹ï¼Œä¸é¢‘ç¹å¯ä»¥ä½¿ç”¨å®ä½“å¤–è§‚ï¼Œè¿™æ ·æ›´ç®€å•ã€‚ å®ä½“ç±» 1234567891011121314151617181920package com.design.pattern.facade;import lombok.AllArgsConstructor;import lombok.Data;/** * PointsGift ç§¯åˆ†å…‘æ¢ç¤¼ç‰© * * @author shunhua * @date 2019-09-17 */@Data@AllArgsConstructorpublic class PointsGift &#123; /** * ç¤¼ç‰©åç§° */ private String name;&#125; èµ„æ ¼éªŒè¯ç³»ç»Ÿç±» 1234567891011121314151617181920212223package com.design.pattern.facade;import lombok.extern.slf4j.Slf4j;/** * QualifyService æ ¡éªŒç³»ç»Ÿ * * @author shunhua * @date 2019-09-17 */@Slf4jpublic class QualifyService &#123; /** * æ ¡éªŒé€»è¾‘ï¼Œç§¯åˆ†æ˜¯å¦å¤Ÿ * @param pointsGift * @return */ public boolean isAvailable(PointsGift pointsGift)&#123; log.info(pointsGift.getName() + \"ç§¯åˆ†é€šè¿‡\"); return true; &#125;&#125; ç§¯åˆ†ç³»ç»Ÿç±» 1234567891011121314151617181920212223package com.design.pattern.facade;import lombok.extern.slf4j.Slf4j;&#x2F;** * PointsPaymentService ç§¯åˆ†æ”¯ä»˜ * * @author shunhua * @date 2019-09-17 *&#x2F;@Slf4jpublic class PointsPaymentService &#123; &#x2F;** * ç§¯åˆ†å…‘æ¢ç¤¼ç‰© * @param pointsGift * @return *&#x2F; public boolean pay(PointsGift pointsGift)&#123; log.info(&quot;æ”¯ä»˜&quot; + pointsGift.getName() + &quot;ç§¯åˆ†æˆåŠŸ&quot;); return true; &#125;&#125; ç‰©æµç³»ç»Ÿç±» 1234567891011121314151617181920212223package com.design.pattern.facade;import lombok.extern.slf4j.Slf4j;/** * ShippingService * * @author shunhua * @date 2019-09-17 */@Slf4jpublic class ShippingService &#123; /** * ç‰©æµç³»ç»Ÿå¯¹æ¥ * @param pointsGift * @return */ public String shipGift(PointsGift pointsGift)&#123; log.info(pointsGift.getName() + \"è¿›å…¥ç‰©æµç³»ç»Ÿ\"); return \"123456\"; &#125;&#125; å®¢æˆ·ç«¯ 1234567891011121314151617181920package com.design.pattern.facade;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-17 */public class Client &#123; @Test public void test()&#123; PointsGift pointsGift = new PointsGift(\"æœºæ¢°é”®ç›˜\"); GiftExchangeService giftExchangeService = new GiftExchangeService(); giftExchangeService.giftExchange(pointsGift); &#125;&#125; å¤–è§‚æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨Spring-jdbc 1Springå¯¹åŸç”Ÿçš„JDBCè¿›è¡Œäº†å°è£…ï¼Œæˆ‘ä»¬åªéœ€è¦è®¿é—®Springæä¾›çš„æ¥å£æ–¹æ³•å°±å¯ä»¥è¾¾åˆ°ç›®çš„ã€‚ MyBatisçš„Configuration 123456/** Configuration#newMetaObjectæ–¹æ³•åº•å±‚ä¹Ÿæ˜¯å¯¹ä¸€äº›åˆ—é€»è¾‘çš„å°è£…ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨newMetaObjectå³å¯ï¼Œä¸éœ€å…³ç³»å†…éƒ¨ã€‚ * å¦‚æœéœ€è¦ä¿®æ”¹å†…éƒ¨é€»è¾‘ï¼Œè¿™å¤–è§‚æ¥å£æ˜¯ä¸éœ€è¦æ”¹å˜çš„ */public MetaObject newMetaObject(Object object) &#123; return MetaObject.forObject(object, objectFactory, objectWrapperFactory, reflectorFactory); &#125; Tomcatæºç  12341. Tomcatä¸­å¤§é‡ä½¿ç”¨äº†å¤–è§‚æ¨¡å¼ï¼Œå¦‚RequestFacadeã€ResponseFacadeç­‰ã€‚2. RequestFacade implements HttpServletRequestï¼ŒRequest implements HttpServletRequestï¼ŒRequestä½¿ç”¨äº†RequestFacadeåŒ…è£…äº† è‡ªå·±ã€‚Request#getRequeståœ¨è·å–HttpServletRequestæ—¶ï¼Œè¿”å›çš„å…¶å®æ˜¯RequestFacadeï¼Œä¹‹åç”¨è¿™ä¸ªè¿”å›çš„å¯¹è±¡å®Œæˆçš„æ“ä½œéƒ½æ˜¯RequestFacade æ¥å®Œæˆçš„ã€‚","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"åŸå‹æ¨¡å¼","slug":"design_pattern/creation_type/åŸå‹æ¨¡å¼","date":"2019-09-15T16:00:00.000Z","updated":"2020-07-04T16:28:45.962Z","comments":true,"path":"posts/91ad9ce3/","link":"","permalink":"https://gentryhuang.com/posts/91ad9ce3/","excerpt":"","text":"å®šä¹‰åŸå‹å®ä¾‹æŒ‡å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡ã€‚å¯ä»¥ç†è§£ä¸ºå…‹éš†æ–¹æ³•å…‹éš†å¯¹è±¡ã€‚ ç‰¹ç‚¹ä¸éœ€è¦çŸ¥é“ä»»ä½•åˆ›å»ºçš„ç»†èŠ‚ï¼Œä¸è°ƒç”¨æ„é€ å‡½æ•° ç±»å‹åˆ›å»ºå‹ é€‚ç”¨åœºæ™¯1234â—†ç±»åˆå§‹åŒ–æ¶ˆè€—è¾ƒå¤šèµ„æºâ—†newäº§ç”Ÿçš„ä¸€ä¸ªå¯¹è±¡éœ€è¦éå¸¸ç¹ççš„è¿‡ç¨‹ï¼ˆæ•°æ®å‡†å¤‡ã€è®¿é—®æƒé™ç­‰ï¼‰â—†æ„é€ å‡½æ•°æ¯”è¾ƒå¤æ‚â—†å¾ªç¯ä½“ä¸­ç”Ÿäº§å¤§é‡å¯¹è±¡æ—¶ ä¼˜ç‚¹ åŸå‹æ¨¡å¼æ€§èƒ½æ¯”ç›´æ¥newä¸€ä¸ªå¯¹è±¡æ€§èƒ½é«˜ ç®€åŒ–åˆ›å»ºå¯¹è±¡çš„è¿‡ç¨‹ ç¼ºç‚¹ å¿…é¡»é…å¤‡å…‹éš†æ–¹æ³•ï¼ˆé‡å†™Objectçš„cloneæ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šç”Ÿæ•ˆï¼Œå…‹éš†ä¹Ÿæ˜¯åŸå‹æ¨¡å¼çš„æ ¸å¿ƒï¼‰ å¯¹å…‹éš†å¤æ‚å¯¹è±¡æˆ–å¯¹å…‹éš†å‡ºçš„å¯¹è±¡è¿›è¡Œå¤æ‚æ”¹é€ æ—¶ï¼Œå®¹æ˜“å¼•å…¥é£é™© å¯¹å¤æ‚å¯¹è±¡çš„æ·±æ‹·è´ã€æµ…æ‹·è´è¦è¿ç”¨å¾—å½“ æ‰©å±•æ·±å…‹éš†1åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæœ¬ä½“å¯¹è±¡çš„å¼•ç”¨ç±»å‹å±æ€§éœ€è¦è¿›è¡Œæ·±å…‹éš†ï¼Œè¿™æ ·å®ƒå°±ä¸ä¼šå†æŒ‡å‘åŸæœ‰å¯¹è±¡åœ°å€ã€‚ æµ…å…‹éš†1åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œæ–°å¯¹è±¡çš„å±æ€§å’ŒåŸæ¥å¯¹è±¡å®Œå…¨ç›¸åŒï¼Œå¯¹äºéåŸºæœ¬ç±»å‹å±æ€§ï¼Œä»æŒ‡å‘åŸæœ‰å±æ€§æ‰€æŒ‡å‘çš„å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚ å°ç»“1æ·±æµ…å…‹éš†éƒ½ä¼šåœ¨å †ä¸­æ–°åˆ†é…ä¸€å—åŒºåŸŸï¼Œå®ƒç”¨æ¥æŒ‡å‘æœ¬ä½“ï¼ŒåŒºåˆ«åœ¨äºå¯¹è±¡å±æ€§å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦éœ€è¦è¿›è¡Œå…‹éš†ï¼ˆé€’å½’æ€§çš„ï¼‰ ç®€å•éœ€æ±‚æŸä¸ªå¯¹è±¡åˆ›å»ºçš„æ—¶å€™ç›¸å¯¹æ¯”è¾ƒæ¶ˆè€—èµ„æºï¼Œä½†æ˜¯è¿™ä¸ªå¯¹è±¡åˆä¸å¾—ä¸åˆ›å»ºå¤šæ¬¡ï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨åŸå‹æ¨¡å¼ã€‚åŸå‹æ¨¡å¼æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡ŒäºŒè¿›åˆ¶å­—èŠ‚æµçš„æ‹·è´ï¼Œæ¯”newä¸€ä¸ªå¯¹è±¡æ€§èƒ½å¥½å¾ˆå¤š åŸå‹æ¨¡å¼å®è·µä½¿ç”¨åŸå‹æ¨¡å¼ä¹‹å‰é‚®ä»¶ç±» 12345678910111213141516171819202122232425package com.design.pattern.prototype;import lombok.Data;/** * Mail * * @author shunhua * @date 2019-09-16 */@Datapublic class Mail &#123; /** * é‚®ä»¶å */ private String name; /** * é‚®ä»¶åœ°å€ */ private String address; /** * é‚®ä»¶å†…å®¹ */ private String content;&#125; é‚®ä»¶å·¥å…·ç±» 123456789101112131415161718192021222324252627282930package com.design.pattern.prototype;import lombok.extern.slf4j.Slf4j;import java.text.MessageFormat;/** * MailUtil * * @author shunhua * @date 2019-09-16 */@Slf4jpublic class MailUtil &#123; /** * å‘é€é‚®ä»¶ * é‡ç‚¹ï¼š å ä½ç¬¦èµ‹å€¼çš„å®ç° * @param mail */ public static void sendMail(Mail mail)&#123; String content = \"å‘&#123;0&#125;,é‚®ä»¶åœ°å€:&#123;1&#125;,é‚®ä»¶å†…å®¹ï¼š&#123;2&#125;å‘é€é‚®ä»¶\"; log.info(MessageFormat.format(content,mail.getName(),mail.getAddress(),mail.getContent())); &#125; /** * ä¿å­˜é‚®ä»¶çš„æ¨¡ç‰ˆå†…å®¹ * @param mail */ public static void mailTemplate(Mail mail)&#123; log.info(\"é‚®ä»¶çš„æ¨¡ç‰ˆå†…å®¹ï¼š\" + mail.getContent()); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425package com.design.pattern.prototype;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-16 */public class Client &#123; @Test public void test()&#123; Mail mail = new Mail(); mail.setContent(\"é‚®ä»¶æ¨¡ç‰ˆ\"); for(int i = 0; i &lt; 10; i++)&#123; mail.setName(\"å§“å\" + i); mail.setAddress(\"å§“å\" + i + \"@\" + \"gmail.com\"); mail.setContent(\"ä½ æ”¶åˆ°ä¸€å°é‚®ä»¶\"); MailUtil.sendMail(mail); &#125; MailUtil.mailTemplate(mail); &#125;&#125; ä½¿ç”¨åŸå‹æ¨¡å¼é»˜è®¤æ–¹å¼ï¼ˆæµ…æ‹·è´ï¼‰é‚®ä»¶ç±» 123456789101112131415161718192021222324252627282930313233343536package com.design.pattern.prototype;import lombok.Data;/** * Mail æƒ³è¦èƒ½è¢«å…‹éš†éœ€è¦å®ç°Cloneableæ¥å£ * * @author shunhua * @date 2019-09-16 */@Datapublic class Mail implements Cloneable &#123; /** * é‚®ä»¶å */ private String name; /** * é‚®ä»¶åœ°å€ */ private String address; /** * é‚®ä»¶å†…å®¹ */ private String content; /** * é‡å†™å…‹éš†æ–¹æ³• * @return * @throws CloneNotSupportedException */ @Override protected Object clone() throws CloneNotSupportedException &#123; System.out.println(\"å…‹éš†Mail...\"); return super.clone(); &#125;&#125; é‚®ä»¶å·¥å…·ç±» 12345678910111213141516171819202122232425262728293031package com.design.pattern.prototype;import lombok.extern.slf4j.Slf4j;import java.text.MessageFormat;/** * MailUtil * * @author shunhua * @date 2019-09-16 */@Slf4jpublic class MailUtil &#123; /** * å‘é€é‚®ä»¶ * @param mail */ public static void sendMail(Mail mail)&#123; String content = \"å‘&#123;0&#125;,é‚®ä»¶åœ°å€:&#123;1&#125;,é‚®ä»¶å†…å®¹ï¼š&#123;2&#125;å‘é€é‚®ä»¶\"; log.info(MessageFormat.format(content,mail.getName(),mail.getAddress(),mail.getContent())); &#125; /** * ä¿å­˜é‚®ä»¶çš„æ¨¡ç‰ˆå†…å®¹ * @param mail */ public static void mailTemplate(Mail mail)&#123; log.info(\"é‚®ä»¶çš„æ¨¡ç‰ˆå†…å®¹ï¼š\" + mail.getContent()); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425262728package com.design.pattern.prototype;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-16 */public class Client &#123; @Test public void test() throws CloneNotSupportedException &#123; Mail mail = new Mail(); mail.setContent(\"é‚®ä»¶æ¨¡ç‰ˆ\"); for(int i = 0; i &lt; 10; i++)&#123; /** éœ€è¦åˆ›å»ºå¤šä¸ªMailå¯¹è±¡,æ³¨æ„ä¸ä¼šè°ƒç”¨Mailçš„æ„é€ æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨äº†Mailä¸­çš„cloneæ–¹æ³• **/ Mail mailTemp = (Mail) mail.clone(); mailTemp.setName(\"å§“å\" + i); mailTemp.setAddress(\"å§“å\" + i + \"@\" + \"gmail.com\"); mailTemp.setContent(\"ä½ æ”¶åˆ°ä¸€å°é‚®ä»¶\"); MailUtil.sendMail(mailTemp); &#125; // å¾—åˆ°åŸå§‹çš„é‚®ä»¶æ¨¡ç‰ˆ MailUtil.mailTemplate(mail); &#125;&#125; ä½¿ç”¨åŸå‹æ¨¡å¼é»˜è®¤æ–¹å¼ï¼ˆæ·±æ‹·è´ï¼‰12345678å¯¹äºè¢«å…‹éš†çš„ç›®æ ‡å¯¹è±¡ä¸­æœ‰å¼•ç”¨ç±»å‹çš„å±æ€§æ—¶ï¼Œå¦‚æœä¸å¯¹è¯¥å¼•ç”¨ç±»å‹çš„å±æ€§è¿›è¡Œå…‹éš†å¤„ç†ï¼Œé‚£ä¹ˆè¯¥å±æ€§å¯¹äºç›®æ ‡å¯¹è±¡å’Œå…‹éš†å¾—åˆ°çš„æ–°å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªï¼Œè¿™å¾ˆå®¹æ˜“å¼•èµ·é—®é¢˜ï¼Œä¸€å®šè¦æ³¨æ„ã€‚è¿™æ ·æƒ…å†µï¼Œåªéœ€è¦å¯¹è¿™ä¸ªå±æ€§è¿›è¡Œæµ…æ‹·è´å¤„ç†å³å¯è§£å†³ã€‚@Override protected Object clone() throws CloneNotSupportedException &#123; Mail mail = (Mail) super.clone(); //æ·±å…‹éš† mail.date = (Date) pig.date.clone(); return mail; &#125; åŸå‹æ¨¡å¼æ‰©å±•å®ä½“ç±» 1234567891011/** * ä¸€ç§å¸¸ç”¨çš„åŸå‹æ¨¡å¼ * é€šè¿‡æŠ½è±¡ç±»æ¥å®ç°åŸå‹æ¨¡å¼ */public abstract class A implements Cloneable&#123; @Override protected Object clone() throws CloneNotSupportedException &#123; return super.clone(); &#125;&#125; ç»§æ‰¿ç±» 123456789101112131415/** * ç»§æ‰¿Aç±»ï¼Œç›´æ¥è°ƒç”¨cloneæ¥å£ */public class B extends A&#123; public static void main(String [] args)&#123; B b = new B(); try &#123; b.clone(); &#125; catch (CloneNotSupportedException e) &#123; e.printStackTrace(); System.out.println(\"å¤„ç†å¼‚å¸¸\"); &#125; &#125;&#125; å…‹éš†ç ´åå•ä¾‹123å…‹éš†ç ´åå•ä¾‹çš„æ ¹æœ¬åŸå› æ˜¯ï¼Œé€šè¿‡åå°„æš´åŠ›è°ƒç”¨å•ä¾‹ç±»ä¸­çš„cloneæ–¹æ³•ï¼Œè¿™æ ·å°±ä¼šå¾—åˆ°ä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå•ä¾‹ä¹Ÿå°±å˜æˆäº†å¤šä¾‹ã€‚é˜²æ­¢å…‹éš†ç ´åå•ä¾‹ï¼Œåªéœ€è¦è®©å•ä¾‹ç±»ä¸å®ç°å…‹éš†æ¥å£å³å¯ï¼Œæˆ–è€…å®ç°äº†å…‹éš†æ¥å£ä½†æ˜¯å…‹éš†æ–¹æ³•è¿”å›çš„ä»ç„¶æ˜¯åŒä¸€å¯¹è±¡ï¼Œè€Œä¸æ˜¯å¤„ç†å…‹éš†ã€‚ åŸå‹æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨1å¯ä»¥é€šè¿‡è§‚å¯ŸCloneableæ¥å£çš„ä½¿ç”¨ï¼Œå°±å¯ä»¥è¿½è¸ªåŸå‹æ¨¡å¼æ˜¯æ€æ ·ä½¿ç”¨çš„ æºç è§£æ1(Object) 12//native è°ƒç”¨éjavaä»£ç æ¥å£ protected native Object clone() throws CloneNotSupportedException; æºç è§£æ2(ArrayListå®ç°å…‹éš†) 1234567891011121314151617181920212223public class ArrayList&lt;E&gt; extends AbstractList&lt;E&gt; implements List&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable&#123;/** * Returns a shallow copy of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance. (The * elements themselves are not copied.) * * @return a clone of this &lt;tt&gt;ArrayList&lt;/tt&gt; instance */ public Object clone() &#123; try &#123; @SuppressWarnings(\"unchecked\") ArrayList&lt;E&gt; v = (ArrayList&lt;E&gt;) super.clone(); v.elementData = Arrays.copyOf(elementData, size); v.modCount = 0; return v; &#125; catch (CloneNotSupportedException e) &#123; // this shouldn't happen, since we are Cloneable throw new InternalError(); &#125; &#125;&#125; æºç è§£æ3(MyBatisçš„cacheKey) 12345678910111213141516171819package org.apache.ibatis.cache;import java.io.Serializable;import java.lang.reflect.Array;import java.util.ArrayList;import java.util.List;/** * @author Clinton Begin */public class CacheKey implements Cloneable, Serializable &#123; @Override public CacheKey clone() throws CloneNotSupportedException &#123; CacheKey clonedCacheKey = (CacheKey) super.clone(); clonedCacheKey.updateList = new ArrayList&lt;Object&gt;(updateList); return clonedCacheKey; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å»ºé€ è€…æ¨¡å¼","slug":"design_pattern/creation_type/å»ºé€ è€…æ¨¡å¼","date":"2019-09-11T14:33:47.000Z","updated":"2020-08-09T09:16:58.216Z","comments":true,"path":"posts/fe816c3c/","link":"","permalink":"https://gentryhuang.com/posts/fe816c3c/","excerpt":"","text":"å®šä¹‰ å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚ç”¨æˆ·åªéœ€æŒ‡å®šéœ€è¦å»ºé€ çš„ç±»å‹å°±å¯ä»¥å¾—åˆ°å®ƒä»¬ï¼Œå»ºé€ è¿‡ç¨‹åŠç»†èŠ‚ä¸éœ€è¦çŸ¥é“ã€‚ ç±»å‹ åˆ›å»ºå‹ é€‚ç”¨åœºæ™¯ å¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰éå¸¸å¤æ‚çš„å†…éƒ¨ç»“æ„ï¼ˆå¾ˆå¤šå±æ€§ï¼‰ æƒ³æŠŠå¤æ‚å¯¹è±¡çš„åˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦»ä¼˜ç‚¹ å°è£…æ€§å¥½ï¼Œåˆ›å»ºå’Œä½¿ç”¨åˆ†ç¦» æ‰©å±•æ€§å¥½ã€å»ºé€ ç±»ä¹‹é—´ç‹¬ç«‹ã€ä¸€å®šç¨‹åº¦ä¸Šè§£è€¦ ç¼ºç‚¹ äº§ç”Ÿå¤šä½™çš„Builderå¯¹è±¡ äº§å“å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œå»ºé€ è€…éƒ½éœ€è¦ä¿®æ”¹ï¼Œæˆæœ¬è¾ƒå¤§ å»ºé€ è€…æ¨¡å¼å’Œå·¥å‚æ¨¡å¼æ¯”è¾ƒ å»ºé€ è€…æ¨¡å¼æ›´æ³¨é‡æ–¹æ³•çš„è°ƒç”¨é¡ºåºï¼Œè€Œå·¥å‚æ¨¡å¼æ›´æ³¨é‡ç”Ÿäº§äº§å“ åˆ›å»ºå¯¹è±¡çš„ç²’åº¦ä¸åŒï¼Œå»ºé€ è€…æ¨¡å¼å¯ä»¥åˆ›å»ºå¤æ‚çš„äº§å“ï¼Œæœ‰å„ç§å¤æ‚çš„éƒ¨ä»¶ç»„æˆã€‚è€Œå·¥ç¨‹æ¨¡å¼åˆ›å»ºå‡ºæ¥çš„éƒ½å‡ ä¹ä¸€ä¸ªæ ·å­ å·¥å‚æ¨¡å¼æ³¨é‡æŠŠäº§å“åˆ›å»ºå‡ºæ¥ï¼Œè€Œå»ºé€ è€…ä¸ä»…è¦åˆ›å»ºå‡ºäº§å“ï¼Œè¿˜è¦çŸ¥é“äº§å“æœ‰å“ªäº›éƒ¨ä»¶ç»„æˆçš„ ç®€å•éœ€æ±‚è¯´æ˜ æœ‰ä¸€ä¸ªè¯¾ç¨‹éœ€è¦ä¸Šçº¿åœ¨ç½‘ç«™ï¼Œè¿™ä¸ªè¯¾ç¨‹éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼šè¯¾ç¨‹åã€è¯¾ç¨‹çš„è¯¾ä»¶èµ„æºä»¥åŠè§†é¢‘èµ„æºï¼Œåªæœ‰è¿™ä¸ªä¸‰ä¸ªç»„ä»¶æœ‰äº† æ‰èƒ½ç»„è£…æˆä¸Šçº¿çš„è¯¾ç¨‹ã€‚è¿™é‡Œåœ¨åˆ›å»ºè¯¾æ—¶ï¼Œéœ€è¦æœ‰é¡ºåºçš„æ‰§è¡Œï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„è¯¾ç¨‹ã€‚ v1 é€šè¿‡ä¸­é—´ç±»å®ç°umlç±»å›¾ è¯¾ç¨‹ç±» 1234567891011121314151617181920212223242526package com.design.pattern.builder;import lombok.Data;/** * Course * * @author shunhua * @date 2019-09-11 */@Datapublic class Course &#123; /** * è¯¾ç¨‹å */ private String name; /** * è¯¾ç¨‹èµ„æ–™ */ private String source; /** * è¯¾ç¨‹è§†é¢‘ */ private String video;&#125; å»ºé€ è€…æŠ½è±¡ç±» 123456789101112131415161718192021222324252627282930313233package com.design.pattern.builder;/** * CourseBuilder * * @author shunhua * @date 2019-09-11 */public abstract class CourseBuilder &#123; /** * å»ºé€ è¯¾ç¨‹å * @param name */ public abstract void buildName(String name); /** * å»ºé€ è¯¾ç¨‹èµ„æ–™ * @param source */ public abstract void buildSource(String source); /** * å»ºé€ è¯¾ç¨‹è§†é¢‘ * @param video */ public abstract void buildVideo(String video); /** * æ„å»ºè¯¾ç¨‹ * @return */ public abstract Course buildCourse();&#125; å»ºé€ è€…å®ç°ç±» 1234567891011121314151617181920212223242526272829303132package com.design.pattern.builder;/** * ActualCourseBuilder çœŸæ­£çš„è¯¾ç¨‹åˆ›å»ºè€… * * @author shunhua * @date 2019-09-11 */public class ActualCourseBuilder extends CourseBuilder&#123; private Course course = new Course(); @Override public void buildName(String name) &#123; course.setName(name); &#125; @Override public void buildSource(String source) &#123; course.setSource(source); &#125; @Override public void buildVideo(String video) &#123; course.setVideo(video); &#125; @Override public Course buildCourse() &#123; return course; &#125;&#125; åŠ©æ•™ï¼ˆå¯¹è¯¾ç¨‹è¿›è¡Œç»„è£…ï¼‰ 12345678910111213141516171819202122232425262728293031package com.design.pattern.builder;/** * Assistant è¯¾ç¨‹åŠ©æ•™ * * @author shunhua * @date 2019-09-11 */public class Assistant &#123; private CourseBuilder courseBuilder; public void setCourseBuilder(CourseBuilder courseBuilder)&#123; this.courseBuilder = courseBuilder; &#125; /** * è¯¾ç¨‹åŠ©æ•™ ç»„è£…è¯¾ç¨‹ * @param name * @param source * @param video * @return */ public Course buildCourse(String name,String source,String video)&#123; this.courseBuilder.buildName(name); this.courseBuilder.buildSource(source); this.courseBuilder.buildVideo(video); return this.courseBuilder.buildCourse(); &#125;&#125; å®¢æˆ·ç«¯ 1234567891011121314151617181920212223package com.design.pattern.builder;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-11 */@Slf4jpublic class Client &#123; @Test public void test()&#123; CourseBuilder courseBuilder = new ActualCourseBuilder(); Assistant assistant = new Assistant(); assistant.setCourseBuilder(courseBuilder); Course course = assistant.buildCourse(\"Javaè¿›é˜¶\",\"ppt\",\"Javaè¿›é˜¶è§†é¢‘\"); log.info(course.toString()); &#125;&#125; v2 é™æ€å†…éƒ¨ç±»æ¼”ç»ƒå»ºé€ è€…æ¨¡å¼ï¼ˆé“¾å¼è°ƒç”¨ï¼‰umlç±»å›¾ 1é™æ€å†…éƒ¨ç±»builderæœ‰3ä¸ªå±æ€§ï¼Œè¯¾ç¨‹ç±»æœ‰ç›¸åŒçš„3ä¸ªå±æ€§ï¼Œé“¾å¼è°ƒç”¨çš„æ—¶å€™ï¼Œç»™builderå…¨éƒ¨æˆ–è€…éƒ¨åˆ†èµ‹å€¼ï¼Œbuildçš„æ—¶å€™ï¼ŒæŠŠbuilderå¯¹è±¡ä¼ é€åˆ°courseï¼Œcourseè·å–åˆ°builderçš„å±æ€§ï¼Œç„¶åè¿”å›è¿™ä¸ªcourseï¼› Courseç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374package com.design.pattern.builder.v2;import lombok.Data;/** * Course * * @author shunhua * @date 2019-09-11 */@Datapublic class Course &#123; /** * è¯¾ç¨‹å */ private String name; /** * è¯¾ç¨‹èµ„æ–™ */ private String source; /** * è¯¾ç¨‹è§†é¢‘ */ private String video; public Course(CourseBuilder courseBuilder)&#123; this.name = courseBuilder.name; this.source = courseBuilder.source; this.video = courseBuilder.video; &#125; /** * æŠŠå®ä½“ç±»ä¸å¯¹åº”çš„åˆ›å»ºç±»å†™åœ¨ä¸€èµ·ï¼Œè¿™ç§ä½¿ç”¨æ›´å¸¸è§,ä½¿ç”¨é“¾å¼è°ƒç”¨ */ public static class CourseBuilder &#123; /** * è¯¾ç¨‹å */ private String name; /** * è¯¾ç¨‹èµ„æ–™ */ private String source; /** * è¯¾ç¨‹è§†é¢‘ */ private String video; public CourseBuilder buildName(String name) &#123; this.name = name; return this; &#125; public CourseBuilder buildSource(String source) &#123; this.source = source; return this; &#125; public CourseBuilder buildVideo(String video) &#123; this.video = video; return this; &#125; /** * * @return */ public Course build()&#123; return new Course(this); &#125; &#125;&#125; å®¢æˆ·ç«¯ 1234567891011121314151617181920212223package com.design.pattern.builder.v2;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-11 */@Slf4jpublic class Client &#123; @Test public void test()&#123; Course course = new Course.CourseBuilder() .buildName(\"javaè¿›é˜¶\") .buildSource(\"pptè¯¾ä»¶\") .buildVideo(\"javaè¿›é˜¶è§†é¢‘\") .build(); log.info(course.toString()); &#125;&#125; å»ºé€ è€…æ¨¡å¼åœ¨æºç ä¸­çš„ä½¿ç”¨jdkçš„StringBuilderå’ŒStringBuffer12345678910111213// å¦‚StringBuilderçš„appendæ–¹æ³• @Override public StringBuilder append(String str) &#123; super.append(str); return this; &#125;// å¦‚StringBufferçš„appendæ–¹æ³• @Override public synchronized StringBuffer append(String str) &#123; toStringCache = null; super.append(str); return this; &#125; MyBatisçš„SqlSessionFactoryBuilder1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253 public SqlSessionFactory build(InputStream inputStream, String environment, Properties properties) &#123; try &#123; // XMLé…ç½®çš„builder æ¥åˆ›å»º Configuration XMLConfigBuilder parser = new XMLConfigBuilder(inputStream, environment, properties); // parseæ–¹æ³•åˆ›å»ºConfiguration ï¼ŒSqlSessionFactoryBuilderçš„buildæ–¹æ³•åˆ›å»ºSqlSessionFactory return build(parser.parse()); &#125; catch (Exception e) &#123; throw ExceptionFactory.wrapException(\"Error building SqlSession.\", e); &#125; finally &#123; ErrorContext.instance().reset(); try &#123; inputStream.close(); &#125; catch (IOException e) &#123; // Intentionally ignore. Prefer previous error. &#125; &#125; &#125; // public SqlSessionFactory build(Configuration config) &#123; return new DefaultSqlSessionFactory(config); &#125; // XMLConfigBuilder#parse public Configuration parse() &#123; if (parsed) &#123; throw new BuilderException(\"Each XMLConfigBuilder can only be used once.\"); &#125; parsed = true; parseConfiguration(parser.evalNode(\"/configuration\")); return configuration; &#125; private void parseConfiguration(XNode root) &#123; try &#123; Properties settings = settingsAsPropertiess(root.evalNode(\"settings\")); //issue #117 read properties first propertiesElement(root.evalNode(\"properties\")); loadCustomVfs(settings); typeAliasesElement(root.evalNode(\"typeAliases\")); pluginElement(root.evalNode(\"plugins\")); objectFactoryElement(root.evalNode(\"objectFactory\")); objectWrapperFactoryElement(root.evalNode(\"objectWrapperFactory\")); reflectorFactoryElement(root.evalNode(\"reflectorFactory\")); settingsElement(settings); // read it after objectFactory and objectWrapperFactory issue #631 environmentsElement(root.evalNode(\"environments\")); databaseIdProviderElement(root.evalNode(\"databaseIdProvider\")); typeHandlerElement(root.evalNode(\"typeHandlers\")); mapperElement(root.evalNode(\"mappers\")); &#125; catch (Exception e) &#123; throw new BuilderException(\"Error parsing SQL Mapper Configuration. Cause: \" + e, e); &#125; &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"æŠ½è±¡å·¥å‚","slug":"design_pattern/creation_type/æŠ½è±¡å·¥å‚","date":"2019-09-09T16:00:00.000Z","updated":"2020-09-04T06:07:24.449Z","comments":true,"path":"posts/df11d265/","link":"","permalink":"https://gentryhuang.com/posts/df11d265/","excerpt":"","text":"å®šä¹‰ æŠ½è±¡å·¥å‚æ¨¡å¼æä¾›ä¸€ä¸ªåˆ›å»ºä¸€ç³»åˆ—ç›¸å…³æˆ–ç›¸äº’ä¾èµ–å¯¹è±¡çš„çš„æ¥å£ã€‚æ— é¡»æŒ‡å®šå®ƒä»¬å…·ä½“çš„ç±»ã€‚ ç±»å‹ åˆ›å»ºå‹ ä½¿ç”¨åœºæ™¯ å®¢æˆ·ç«¯ï¼ˆåº”ç”¨å±‚ï¼‰ä¸ä¾èµ–äºäº§å“å®ä¾‹å¦‚ä½•è¢«åˆ›å»ºã€å®ç°ç­‰ç»†èŠ‚ å¼ºè°ƒä¸€ç³»åˆ—ç›¸å…³çš„äº§å“å¯¹è±¡ï¼ˆå±äºåŒä¸€äº§å“æ—ï¼‰ä¸€èµ·ä½¿ç”¨åˆ›å»ºå¯¹è±¡éœ€è¦å¤§é‡é‡å¤çš„ä»£ç  æä¾›ä¸€ä¸ªäº§å“ç±»çš„åº“ï¼Œæ‰€æœ‰çš„äº§å“ä»¥åŒæ ·çš„æ¥å£å‡ºç°ï¼Œä»è€Œä½¿å®¢æˆ·ç«¯ä¸ä¾èµ–äºå…·ä½“å®ç°ã€‚ ä¼˜ç‚¹ åº”ç”¨å±‚ä»£ç ä¸å’Œå…·ä½“çš„äº§å“å‘ç”Ÿä¾èµ–ï¼Œåªå’Œå…·ä½“çš„äº§å“æ—å·¥å‚å‘ç”Ÿä¾èµ–å…³ç³»ï¼Œä½è€¦åˆï¼Œé«˜å†…èš ä»å…·ä½“çš„äº§å“å·¥å‚å–å‡ºæ¥çš„è‚¯å®šæ˜¯åŒä¸€äº§å“æ—ï¼Œå¼€å‘çš„æ—¶å€™é€»è¾‘æ¸…æ™° å¯¹äºäº§å“æ—æ¥è¯´ï¼Œç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå¢åŠ æ–°çš„äº§å“æ—çš„æ—¶å€™ï¼Œå¯¹æ‰©å±•å¼€æ”¾ ç¼ºç‚¹ è§„å®šäº†æ‰€æœ‰å¯èƒ½è¢«åˆ›å»ºçš„äº§å“é›†åˆï¼Œäº§å“æ—ä¸­æ‰©å±•æ–°çš„äº§å“å›°éš¾ï¼Œéœ€è¦ä¿®æ”¹æŠ½è±¡å·¥ç¨‹çš„æ¥å£ã€‚å¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦ã€‚ ä¸ºä½•æœ‰äº§å“æ—çš„ä¸šåŠ¡åœºæ™¯å®œç”¨æŠ½è±¡å·¥å‚è®¾è®¡æ¨¡å¼ï¼Ÿè€Œä¸æ˜¯å·¥å‚è®¾è®¡æ¨¡å¼ å¦‚æœä½¿ç”¨å·¥å‚è®¾è®¡æ¨¡å¼ï¼Œå¯èƒ½ä¼šå› ä¸ºå·¥å‚ç±»å¤ªå¤šè€Œäº§ç”Ÿç±»çˆ†ç‚¸çš„ç°è±¡ äº§å“æ—å’Œäº§å“ç­‰çº§ å·¥å‚æ–¹æ³•é’ˆå¯¹çš„å°±æ˜¯äº§å“ç­‰çº§ç»“æ„ï¼Œå®ƒå¤„ç†çš„å°±æ˜¯åŒä¸€ç±»å‹äº§å“ï¼ˆå¦‚ï¼šäº§å“ç±»å‹éƒ½æ˜¯å†°ç®±ä½†æ˜¯æœ‰ä¸åŒå“ç‰Œï¼‰ æŠ½è±¡å·¥å‚é’ˆå¯¹çš„å°±æ˜¯äº§å“æ—ï¼Œå®ƒå¤„ç†çš„å°±æ˜¯ä¸€ç³»åˆ—äº§å“ï¼ˆå¦‚ï¼šæµ·å°”æ——ä¸‹ä¸åŒçš„äº§å“ï¼‰ ç®€å•åœºæ™¯è¯´æ˜ ä¸€ä¸ªè¯¾ç¨‹ä¸ä»…è¦æœ‰è§†é¢‘èµ„æ–™ï¼Œè¿˜éœ€è¦æœ‰å¯¹åº”çš„ç¬”è®°,è¿™æ ·ä¸¤è€…éƒ½å­˜åœ¨æ‰æ˜¯ä¸€é—¨è¯¾ç¨‹ã€‚ æŠ½è±¡å·¥å‚æ¼”ç»ƒ ç¬”è®° 1234567891011121314package com.design.pattern.abstractfactory;/** * Article * * @author shunhua * @date 2019-09-10 */public abstract class Article &#123; /** * ç”Ÿäº§ç¬”è®°çš„æ–¹æ³• */ public abstract void produce();&#125; javaç¬”è®° 123456789101112131415161718package com.design.pattern.abstractfactory;import lombok.extern.slf4j.Slf4j;/** * JavaArticle * * @author shunhua * @date 2019-09-10 */@Slf4jpublic class JavaArticle extends Article &#123; @Override public void produce() &#123; log.info(\"ç”Ÿäº§Javaç¬”è®°\"); &#125;&#125; pythonç¬”è®° 123456789101112131415161718package com.design.pattern.abstractfactory;import lombok.extern.slf4j.Slf4j;/** * PythonArticle * * @author shunhua * @date 2019-09-10 */@Slf4jpublic class PythonArticle extends Article &#123; @Override public void produce() &#123; log.info(\"ç”Ÿäº§pythonç¬”è®°\"); &#125;&#125; è§†é¢‘èµ„æº 1234567891011121314package com.design.pattern.abstractfactory;/** * Video * * @author shunhua * @date 2019-09-10 */public abstract class Video &#123; /** * ç”Ÿäº§è§†é¢‘çš„æŠ½è±¡æ–¹æ³• */ public abstract void produce();&#125; Javaè§†é¢‘èµ„æº 123456789101112131415161718package com.design.pattern.abstractfactory;import lombok.extern.slf4j.Slf4j;/** * JavaVideo * * @author shunhua * @date 2019-09-10 */@Slf4jpublic class JavaVideo extends Video &#123; @Override public void produce() &#123; log.info(\"ç”ŸæˆJavaè§†é¢‘èµ„æº\"); &#125;&#125; pythonè§†é¢‘èµ„æº 123456789101112131415161718package com.design.pattern.abstractfactory;import lombok.extern.slf4j.Slf4j;/** * PythonVideo * * @author shunhua * @date 2019-09-10 */@Slf4jpublic class PythonVideo extends Video &#123; @Override public void produce() &#123; log.info(\"ç”Ÿäº§pythonè§†é¢‘\"); &#125;&#125; è¯¾ç¨‹å·¥å‚ï¼ˆäº§å“æ—å·¥å‚ï¼‰ 1234567891011121314151617181920package com.design.pattern.abstractfactory;/** * CourseFactory * * @author shunhua * @date 2019-09-10 */public interface CourseFactory &#123; /** * ç”Ÿäº§è§†é¢‘ * @return */ Video getVideo(); /** * ç”Ÿäº§ç¬”è®° * @return */ Article getArticle();&#125; Javaè¯¾ç¨‹å·¥å‚ 1234567891011121314151617181920package com.design.pattern.abstractfactory;/** * JavaCourseFactory * * @author shunhua * @date 2019-09-10 */public class JavaCourseFactory implements CourseFactory &#123; @Override public Video getVideo() &#123; return new JavaVideo(); &#125; @Override public Article getArticle() &#123; return new JavaArticle(); &#125;&#125; Pythonè¯¾ç¨‹å·¥å‚ 1234567891011121314151617181920package com.design.pattern.abstractfactory;/** * PythonCourseFactory * * @author shunhua * @date 2019-09-10 */public class PythonCourseFactory implements CourseFactory&#123; @Override public Video getVideo() &#123; return new PythonVideo(); &#125; @Override public Article getArticle() &#123; return new PythonArticle(); &#125;&#125; å®¢æˆ·ç«¯ 123456789101112131415161718192021package com.design.pattern.abstractfactory;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-10 */public class Client &#123; @Test public void test()&#123; CourseFactory courseFactory = new JavaCourseFactory(); Video video = courseFactory.getVideo(); Article article = courseFactory.getArticle(); video.produce(); article.produce(); &#125;&#125; æŠ½è±¡å·¥å‚åœ¨æºç ä¸­çš„ä½¿ç”¨æºç è§£æConnectionçš„ä¸¤ä¸ªæ–¹æ³•å±æ€§åŒä¸€ä¸ªäº§å“æ—ï¼Œè¿™æ˜¯ä¸€ä¸ªçˆ¶ç±» 1234567891011121314151617181920// mysqlå’Œoracleè·å–çš„æ˜¯åŒä¸€äº§å“æ—ä¸‹çš„statementå’ŒåŒä¸€äº§å“æ—ä¸‹çš„preparestatementpublic interface Connection extends Wrapper, AutoCloseable &#123; Statement createStatement() throws SQLException; PreparedStatement prepareStatement(String sql) throws SQLException; // ... &#125; // executeQueryæ–¹æ³•å’ŒexecureUpdateæ–¹æ³•å±äºåŒä¸€ä¸ªäº§å“æ—public interface Statement extends Wrapper, AutoCloseable &#123; ResultSet executeQuery(String sql) throws SQLException; int executeUpdate(String sql) throws SQLException; &#125; MyBatisçš„SqlSessionæºç è§£æjava.sql.Connection/java.sql.Statement/org.apache.ibatis.session.SqlSessionFactoryç­‰ æ¥å£å°±æ˜¯ä¸€ä¸ªæŠ½è±¡å·¥å‚ï¼ˆä»åŒä¸€ä¸ªæŠ½è±¡å·¥å‚ä¸­è¿”å›çš„äº§å“ä¸€å®šå±äºåŒä¸€ä¸ªäº§å“æ—ï¼‰å®ƒé‡Œé¢æœ‰å¤šä¸ªå·¥å‚æ–¹æ³•ï¼Œå®ƒçš„å®ç°ç±»é€šè¿‡å®ç°ä¸åŒçš„å·¥å‚æ–¹æ³•ï¼Œæ¥åˆ›å»ºå‡ºä¸åŒçš„äº§å“ã€‚ SqlSessionFactory 12345678910111213141516171819202122232425package org.apache.ibatis.session;import java.sql.Connection;/** * Creates an &#123;@link SqlSession&#125; out of a connection or a DataSource * * @author Clinton Begin */public interface SqlSessionFactory &#123; SqlSession openSession(); SqlSession openSession(boolean autoCommit); SqlSession openSession(Connection connection); SqlSession openSession(TransactionIsolationLevel level); SqlSession openSession(ExecutorType execType); SqlSession openSession(ExecutorType execType, boolean autoCommit); SqlSession openSession(ExecutorType execType, TransactionIsolationLevel level); SqlSession openSession(ExecutorType execType, Connection connection); Configuration getConfiguration();&#125; SqlSessionFactoryå­ç±» SqlSessionManagerSqlSessionFactoryå­ç±» DefaultSqlSessionFactory","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å·¥å‚æ–¹æ³•","slug":"design_pattern/creation_type/å·¥å‚æ–¹æ³•","date":"2019-09-08T16:00:00.000Z","updated":"2020-09-04T06:09:12.309Z","comments":true,"path":"posts/a778ad08/","link":"","permalink":"https://gentryhuang.com/posts/a778ad08/","excerpt":"","text":"å®šä¹‰ å®šä¹‰ä¸€ä¸ªåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰ï¼Œè®©å®ç°è¿™ä¸ªæ¥å£çš„ç±»ï¼ˆå®ç°æŠ½è±¡æ–¹æ³•ï¼‰æ¥å†³å®šå®ä¾‹åŒ–å“ªä¸ªç±»ï¼Œå·¥å‚æ–¹æ³•è®©ç±»çš„å®ä¾‹åŒ–æ¨è¿Ÿåˆ°å­ç±»ä¸­è¿›è¡Œï¼Œå³é€šè¿‡å­ç±»å®ç°æŠ½è±¡æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡ã€‚ å·¥å‚æ–¹æ³•å°±æ˜¯ç”¨æ¥è§£å†³åŒä¸€äº§å“ç­‰çº§çš„ä¸šåŠ¡æŠ½è±¡é—®é¢˜ã€‚å·¥å‚åˆ›å»ºå¯¹è±¡ç”¨çš„ï¼Œæ–¹æ³•é€šè¿‡å­ç±»å®ç°æ–¹æ³•æ¥åˆ›å»ºå¯¹è±¡ã€‚ ç±»å‹ åˆ›å»ºå‹ ä½¿ç”¨åœºæ™¯ åˆ›å»ºå¯¹è±¡éœ€è¦å¤§é‡çš„é‡å¤ä»£ç  å®¢æˆ·ç«¯ï¼ˆåº”ç”¨å±‚ï¼‰ä¸ä¾èµ–äºäº§å“ç±»å®ä¾‹å¦‚ä½•è¢«åˆ›å»ºã€å®ç°ç­‰ç»†èŠ‚ ä¸€ä¸ªç±»é€šè¿‡å…¶å­ç±»æ¥æŒ‡å®šåˆ›å»ºå“ªä¸ªå¯¹è±¡ä¼˜ç‚¹ç”¨æˆ·åªéœ€è¦å…³å¿ƒæ‰€éœ€äº§å“å¯¹åº”çš„å·¥å‚ï¼Œæ— é¡»å…³å¿ƒåˆ›å»ºç»†èŠ‚ã€‚åŠ å…¥æ–°çš„äº§å“ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæé«˜äº†å¯æ‰©å±•æ€§ã€‚ç¼ºç‚¹å®ç°ç±»çš„ä¸ªæ•°å®¹æ˜“è¿‡å¤šï¼ˆå¢åŠ æ–°äº§å“çš„æ—¶å€™ï¼Œä¸ä»…éœ€è¦ç¼–å†™æ–°çš„äº§å“ç±»è¿˜éœ€è¦ç¼–å†™å¯¹åº”çš„å·¥å‚ç±»ï¼Œå› æ­¤ç±»çš„ä¸ªæ•°å¢åŠ ï¼‰ã€å¢åŠ å¤æ‚åº¦ã€‚å·¥å‚æ–¹æ³•æœ¬èº«ä½¿ç”¨äº†æŠ½è±¡ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥æŠ½è±¡å±‚ï¼Œå¦‚æœæƒ³è¦åŠ¨æ€åˆ›å»ºå¯èƒ½è¿˜ä¼šä½¿ç”¨åå°„æŠ€æœ¯ï¼Œè¿™éƒ½å¢åŠ äº†ç³»ç»Ÿçš„æŠ½è±¡æ€§å’Œç†è§£éš¾åº¦äº§å“ç­‰çº§å’Œäº§å“æ— å·¥å‚æ–¹æ³•æ˜¯ä¸ºäº†å†³ç»åŒä¸€äº§å“ç­‰çº§çš„ä¸šåŠ¡æŠ½è±¡é—®é¢˜ï¼ŒæŠ½è±¡å·¥å‚æ˜¯ä¸ºäº†è§£å†³åŒä¸€äº§å“æ—çš„é—®é¢˜ äº§å“ç­‰çº§ç›¸åŒç±»å‹çš„äº§å“ä¸ºåŒä¸€äº§å“ç­‰çº§ï¼Œå¦‚ï¼šæ±½è½¦æœ‰å¤§ä¼—ã€é•¿å®‰ã€å¥¥è¿ªç­‰ï¼Œå®ƒä»¬å±äºåŒä¸€äº§å“ç­‰çº§ äº§å“æ—ä¸åŒç±»å‹çš„äº§å“ï¼Œå¦‚é•¿å®‰æ±½è½¦ã€é•¿å®‰æ‘©æ‰˜ã€é•¿å®‰è‡ªè¡Œè½¦ å·¥å‚æ–¹æ³•æ¼”ç»ƒ Foodç±» 1234567891011121314package com.design.pattern.factorymethod;/** * ç›¸åŒç±»å‹çš„äº§å“å±äºåŒä¸€äº§å“ç­‰çº§ï¼Œæ— è®ºæ˜¯é¢åŒ…è¿˜æ˜¯æ²™æ‹‰ï¼Œå®ƒä»¬éƒ½æ˜¯åŒä¸€ä¸ªç­‰çº§ï¼Œè¿™é‡Œæ˜¯Food * * @author shunhua * @date 2019-09-09 */public abstract class Food &#123; /** * ç”Ÿäº§äº§å“æ–¹æ³• */ public abstract void produce();&#125; é¢åŒ…ç±» 123456789101112131415161718192021package com.design.pattern.factorymethod;import lombok.Data;import lombok.ToString;import lombok.extern.slf4j.Slf4j;/** * Bread * * @author shunhua * @date 2019-09-09 */@Slf4j@ToStringpublic class Bread extends Food &#123; @Override public void produce() &#123; log.info(\"ç”Ÿäº§é¢åŒ…!\"); &#125;&#125; æ²™æ‹‰ç±» 1234567891011121314151617181920package com.design.pattern.factorymethod;import lombok.ToString;import lombok.extern.slf4j.Slf4j;/** * Salad * * @author shunhua * @date 2019-09-09 */@Slf4j@ToStringpublic class Salad extends Food &#123; @Override public void produce() &#123; log.info(\"ç”Ÿæˆæ²™æ‹‰!\"); &#125;&#125; æŠ½è±¡å·¥å‚ 123456789101112131415package com.design.pattern.factorymethod;/** * å·¥å‚æ–¹æ³•,å­ç±»ç»§æ‰¿å³å¯ * è¿™é‡Œä½¿ç”¨æŠ½è±¡ç±»ä¸»è¦è€ƒè™‘åˆ°åœ¨ç±»ä¸­æœ‰äº›æ˜¯å·²çŸ¥çš„ï¼Œä½¿ç”¨æŠ½è±¡ç±»åˆé€‚ã€‚å¦‚æœå…¨éƒ½æ˜¯æœªçŸ¥çš„ä½¿ç”¨æ¥å£æ¯”è¾ƒåˆé€‚ã€‚ * @author shunhua * @date 2019-09-09 */public abstract class FoodFactory &#123; /** * å·¥å‚æ–¹æ³•ï¼Œèµ·åˆ°è§„çº¦çš„ä½œç”¨ï¼Œå¹¶ä¸ç”Ÿäº§å…·ä½“çš„äº§å“ï¼Œå…·ä½“äº§å“çš„ç”Ÿæˆç”±å…¶å®ç°å®Œæˆ * @return */ public abstract Food createFood();&#125; å­å·¥å‚ç±»-é¢åŒ…å·¥å‚ 12345678910111213141516171819package com.design.pattern.factorymethod;/** * BreadFactory åªç”Ÿäº§Bread * * @author shunhua * @date 2019-09-10 */public class BreadFactory extends FoodFactory &#123; /** * ç”Ÿäº§é¢åŒ…çš„å·¥å‚æ–¹æ³• * @return */ @Override public Food createFood() &#123; return new Bread(); &#125;&#125; å­å·¥å‚ç±»-æ²™æ‹‰å·¥å‚ 123456789101112131415161718package com.design.pattern.factorymethod;/** * SaladFactory åªç”Ÿäº§Salad * * @author shunhua * @date 2019-09-10 */public class SaladFactory extends FoodFactory &#123; /** * ç”Ÿäº§é¢åŒ…çš„å·¥å‚æ–¹æ³• * @return */ @Override public Food createFood() &#123; return new Salad(); &#125;&#125; å®¢æˆ·ç«¯ 12345678910111213141516171819202122232425262728package com.design.pattern.factorymethod;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-10 */@Slf4jpublic class Client &#123; @Test public void test()&#123; // é¢åŒ…å·¥å‚æ–¹æ³• FoodFactory breadFactory = new BreadFactory(); Food bread = breadFactory.createFood(); log.info(String.valueOf(bread)); // æ²™æ‹‰å·¥å‚æ–¹æ³• FoodFactory saladFactory = new SaladFactory(); Food salad = saladFactory.createFood(); log.info(String.valueOf(salad)); &#125;&#125; å·¥å‚æ–¹æ³•åœ¨æºç ä¸­çš„ä½¿ç”¨Collectionçš„Iteratorè§£æCollectionæ¥å£ç›¸å½“äºæŠ½è±¡å·¥å‚ï¼ˆå› ä¸ºå®ƒå¤„ç†çš„æ˜¯ç­‰çº§ç»„é—®é¢˜å³å¤šä¸ªç±»å‹çš„äº§å“ï¼‰ï¼Œå…¶ä¸­å®ƒé‡Œé¢çš„Iterator iterator()æ–¹æ³•ç›¸å½“äºå·¥å‚æ–¹æ³•ã€‚ArrayListå®ç°äº†è¿™ä¸ªæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ºArrayListç”Ÿäº§Itrï¼ŒItræ˜¯Iteratorç±»å‹ã€‚è¿˜æœ‰ILoggerFactoryå’ŒLoggeräº§å“æ—å¯¹åº”çš„å·¥å‚æ–¹æ³•çš„ä½¿ç”¨ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970public Iterator&lt;E&gt; iterator() &#123; return new Itr(); &#125; /** * An optimized version of AbstractList.Itr */ private class Itr implements Iterator&lt;E&gt; &#123; int cursor; // index of next element to return int lastRet = -1; // index of last element returned; -1 if no such int expectedModCount = modCount; public boolean hasNext() &#123; return cursor != size; &#125; @SuppressWarnings(\"unchecked\") public E next() &#123; checkForComodification(); int i = cursor; if (i &gt;= size) throw new NoSuchElementException(); Object[] elementData = ArrayList.this.elementData; if (i &gt;= elementData.length) throw new ConcurrentModificationException(); cursor = i + 1; return (E) elementData[lastRet = i]; &#125; public void remove() &#123; if (lastRet &lt; 0) throw new IllegalStateException(); checkForComodification(); try &#123; ArrayList.this.remove(lastRet); cursor = lastRet; lastRet = -1; expectedModCount = modCount; &#125; catch (IndexOutOfBoundsException ex) &#123; throw new ConcurrentModificationException(); &#125; &#125; @Override @SuppressWarnings(\"unchecked\") public void forEachRemaining(Consumer&lt;? super E&gt; consumer) &#123; Objects.requireNonNull(consumer); final int size = ArrayList.this.size; int i = cursor; if (i &gt;= size) &#123; return; &#125; final Object[] elementData = ArrayList.this.elementData; if (i &gt;= elementData.length) &#123; throw new ConcurrentModificationException(); &#125; while (i != size &amp;&amp; modCount == expectedModCount) &#123; consumer.accept((E) elementData[i++]); &#125; // update once at end of iteration to reduce heap write traffic cursor = i; lastRet = i - 1; checkForComodification(); &#125; final void checkForComodification() &#123; if (modCount != expectedModCount) throw new ConcurrentModificationException(); &#125; &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"åˆæˆå¤ç”¨åŸåˆ™","slug":"design_pattern/principle/åˆæˆå¤ç”¨åŸåˆ™","date":"2019-09-04T16:00:00.000Z","updated":"2020-07-04T13:42:18.872Z","comments":true,"path":"posts/b91a199d/","link":"","permalink":"https://gentryhuang.com/posts/b91a199d/","excerpt":"","text":"ç»§æ‰¿å…³ç³»çš„é€‰æ‹© ç»§æ‰¿å…³ç³»æ˜¯is açš„å…³ç³»ï¼Œæ‰€ä»¥çœ‹æ˜¯å¦æœ‰ç»§æ‰¿å…³ç³»ï¼Œé€šå¸¸è¦çœ‹å­ç±»å’Œçˆ¶ç±»å…±ç”¨çš„æ–¹æ³•ï¼Œå­ç±»æ˜¯å¦èƒ½å¤Ÿå®ç°çˆ¶ç±»çš„æ–¹æ³• èµ·å åˆæˆå¤ç”¨åŸåˆ™ï¼Œç»„åˆå¤ç”¨åŸåˆ™ï¼Œèšåˆå¤ç”¨åŸåˆ™ å®šä¹‰ å°½é‡ä½¿ç”¨ç»„åˆï¼Œèšåˆï¼Œè€Œä¸æ˜¯ç»§æ‰¿å…³ç³»è¾¾åˆ°å¤ç”¨è½¯ä»¶çš„ç›®çš„ ç»„åˆèšåˆï¼ˆé»‘ç®±å¤ç”¨ï¼‰ ä¼˜ç‚¹é™ä½è€¦åˆï¼Œæé«˜ç³»ç»Ÿçš„çµæ´»æ€§ã€‚ä½¿ä¸€ä¸ªç±»çš„å˜åŒ–å¯¹å…¶ä»–ç±»é€ æˆçš„å½±å“è¾ƒå° ç¼ºç‚¹ä¼šç”Ÿæˆè¾ƒå¤šçš„å¯¹è±¡è¿›è¡Œç®¡ç† ç»§æ‰¿ï¼ˆç™½ç®±å¤ç”¨ï¼‰ ä¼˜ç‚¹æ–°çš„æ‰©å±•æ€§å®¹æ˜“å®ç°ï¼Œä¿®æ”¹å’Œæ‰©å±•ç›¸å¯¹å®¹æ˜“ ç¼ºç‚¹çˆ¶ç±»çš„æ–¹æ³•ä¾µå…¥æ€§çš„å¸¦ç»™å­ç±»ï¼Œçˆ¶ç±»æ–¹æ³•çš„æ”¹å˜ï¼Œå­ç±»ä¹Ÿå¿…é¡»æ”¹å˜ï¼Œç›¸æ¯”è€¦åˆè¾ƒé«˜ ç»„åˆèšåˆåŒºåˆ«å…³ç³»å¼ºå¼±ï¼Œç»„åˆå¼ºï¼Œèšåˆå¼±","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"é‡Œæ°æ›¿æ¢åŸåˆ™","slug":"design_pattern/principle/é‡Œæ°æ›¿æ¢åŸåˆ™","date":"2019-09-03T16:00:00.000Z","updated":"2020-07-04T13:42:18.873Z","comments":true,"path":"posts/3d1cbe69/","link":"","permalink":"https://gentryhuang.com/posts/3d1cbe69/","excerpt":"","text":"å®šä¹‰ å¦‚æœå¯¹æ¯ä¸€ä¸ªç±»å‹ä¸ºT1çš„å¯¹è±¡o1ï¼Œéƒ½æœ‰ç±»å‹ä¸ºT2çš„å¯¹è±¡o2ï¼Œä½¿å¾—ä»¥T1å®šä¹‰çš„æ‰€æœ‰ç¨‹åºPåœ¨æ‰€æœ‰çš„å¯¹è±¡o1éƒ½æ›¿æ¢æˆo2æ—¶ï¼Œç¨‹åºPçš„è¡Œä¸ºæ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆç±»å‹T2æ˜¯ç±»å‹T1çš„å­ç±»å‹ã€‚ å®šä¹‰æ‰©å±• ä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚æœé€‚ç”¨ä¸€ä¸ªçˆ¶ç±»çš„è¯ï¼Œé‚£ä¸€å®šé€‚ç”¨äºå…¶å­ç±»ï¼Œæ‰€æœ‰å¼•ç”¨çˆ¶ç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ï¼Œå­ç±»å¯¹è±¡èƒ½å¤Ÿæ›¿æ¢çˆ¶ç±»å¯¹è±¡ï¼Œè€Œç¨‹åºé€»è¾‘ä¸å˜ã€‚ï¼ˆåå¯¹å­ç±»é‡å†™çˆ¶ç±»ï¼‰ ç‰¹ç‚¹123456789â—†å¼•ç”³æ„ä¹‰ï¼šå­ç±»å¯ä»¥æ‰©å±•çˆ¶ç±»çš„åŠŸèƒ½ï¼Œä½†ä¸èƒ½æ”¹å˜çˆ¶ç±»åŸæœ‰çš„åŠŸèƒ½ã€‚â—†å«ä¹‰1ï¼šå­ç±»å¯ä»¥å®ç°çˆ¶ç±»çš„æŠ½è±¡æ–¹æ³•ï¼Œä½†ä¸èƒ½è¦†ç›–çˆ¶ç±»çš„éæŠ½è±¡æ–¹æ³•ã€‚â—†å«ä¹‰2ï¼šå­ç±»ä¸­å¯ä»¥å¢åŠ è‡ªå·±ç‰¹æœ‰çš„æ–¹æ³•ã€‚â—†å«ä¹‰3ï¼šå½“å­ç±»çš„æ–¹æ³•é‡è½½çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼Œæ–¹æ³•çš„å‰ç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„è¾“å…¥&#x2F;å…¥å‚ï¼‰è¦æ¯”çˆ¶ç±»æ–¹æ³•çš„è¾“å…¥å‚æ•°æ›´å®½æ¾ã€‚ï¼ˆå…¥å‚å®½æ¾ï¼‰â—†å«ä¹‰4ï¼šå½“å­ç±»çš„æ–¹æ³•å®ç°çˆ¶ç±»çš„æ–¹æ³•æ—¶ï¼ˆé‡å†™&#x2F;é‡è½½æˆ–å®ç°æŠ½è±¡æ–¹æ³•ï¼‰ï¼Œæ–¹æ³•çš„åç½®æ¡ä»¶ï¼ˆå³æ–¹æ³•çš„è¾“å‡º&#x2F;è¿”å›å€¼ï¼‰è¦æ¯”çˆ¶ç±»æ›´ä¸¥æ ¼æˆ–ç›¸ç­‰ã€‚ï¼ˆå‡ºå‚ä¸¥è°¨ï¼‰ï¼ˆå‰ä¸¤æ¡ï¼Œçº¦å®šå­ç±»æœ€å¥½ä¸è¦é‡å†™çˆ¶ç±»çš„æ–¹æ³•ï¼Œå¦‚æœä¸€å®šè¦é‡å†™çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ç»„åˆèšåˆç­‰æ–¹æ³•å®ç°ï¼‰ï¼ˆåä¸¤æ¡,çº¦å®šäº†å­å•Šé‡è½½æˆ–å®ç°çˆ¶ç±»æ–¹æ³•çš„æ¡ä»¶ï¼‰ ä¼˜ç‚¹ çº¦æŸäº†ç»§æ‰¿æ³›æ»¥ï¼Œå¾ˆå¤šéå­ç±»çˆ¶ç±»å…³ç³»çš„ç±»ï¼Œæ²¡å¿…è¦ä½¿ç”¨ç»§æ‰¿å…³ç³» åŠ å¼ºç¨‹åºçš„å¯ç»´æŠ¤æ€§ï¼Œé™ä½éœ€æ±‚å˜æ›´æ—¶å¼•èµ·çš„é£é™© codingé‡Œæ°æ›¿æ¢åŸåˆ™ç»§æ‰¿å…³ç³»åˆ¤åˆ«ï¼ˆæ˜¯å¦æ˜¯çœŸæ­£æ„ä¹‰çš„ç»§æ‰¿ï¼‰1å­ç±»è¡Œä¸ºè§„åˆ™åº”ä¸çˆ¶ç±»è¡Œä¸ºè§„åˆ™ä¸€è‡´ï¼Œå¦‚æœå­ç±»è¾¾ä¸åˆ°è¿™ä¸€ç‚¹ï¼Œåˆ™ä¼šè¿èƒŒé‡Œæ°æ›¿æ¢åŸåˆ™ï¼Œè¿èƒŒé‡Œæ°æ›¿æ¢åŸåˆ™ä¼šæ€æ ·ï¼Ÿç»§æ‰¿é€»è¾‘æ··ä¹±ï¼Œä»£ç ä¸ä¾¿äºç»´æŠ¤ å…¥å‚æ§åˆ¶1é‡è½½çš„æ—¶å€™å…¥å‚è¦æ›´åŠ å®½æ¾ï¼Œå¯ä»¥ä¸å¼•èµ·é€»è¾‘æ··ä¹± çˆ¶ç±» 1234567import java.util.HashMap;public class Base &#123; public void method(HashMap hashMap)&#123; System.out.println(\"æ‰§è¡Œçˆ¶ç±»HashMapæ–¹æ³•\"); &#125;&#125; å­ç±» 12345678910111213141516171819import java.util.HashMap;import java.util.Map;public class Child extends Base&#123; // @Override // public void method(HashMap hashMap) &#123; // System.out.println(\"æ‰§è¡Œå­ç±»çš„HashMapæ–¹æ³•\"); // &#125; /** * å­ç±»é‡è½½ * é‡è½½çš„æ—¶å€™å…¥å‚ Mapæ¯” Hashmapå®½æ¾ï¼Œæ­¤æ—¶æ‰§è¡Œçš„æ—¶å€™ä¼šæ‰§è¡Œçˆ¶ç±»ï¼Œä¸æ‰§è¡Œé‡è½½çš„ç±» * @param Map */ public void method(Map Map) &#123; System.out.println(\"æ‰§è¡Œå­ç±»Mapæ–¹æ³•\"); &#125;&#125; å‡ºå‚æ§åˆ¶1å­ç±»çš„å‡ºå‚å¦‚æœåŒ…å«çˆ¶ç±»ï¼Œä¼šç›´æ¥æŠ¥é”™ çˆ¶ç±» 12345678910111213package com.design.pattern.principle.liskovSubstitutation.outputmethod;import java.util.Map;/** * Base * * @author shunhua * @date 2019-09-15 */public abstract class Base &#123; public abstract Map method();&#125; å­ç±» 12345678910111213141516171819202122232425262728293031package com.design.pattern.principle.liskovSubstitutation.outputmethod;import java.util.HashMap;import java.util.Map;/** * Child * * @author shunhua * @date 2019-09-15 */public class Child extends Base &#123; /** * å­ç±»çš„å‡ºå‚å¦‚æœåŒ…å«çˆ¶ç±»ï¼Œä¼šç›´æ¥æŠ¥é”™ã€‚ * @return */ /* @Override public Object method() &#123; return null; &#125;*/ /** * çˆ¶ç±»çš„å‡ºå‚åŒ…å«å­ç±»çš„å‡ºå‚æ˜¯å¯ä»¥çš„ * @return */ @Override public HashMap method()&#123; return new HashMap(2); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"æ¥å£éš”ç¦»åŸåˆ™","slug":"design_pattern/principle/æ¥å£éš”ç¦»åŸåˆ™","date":"2019-09-02T16:00:00.000Z","updated":"2020-07-04T13:42:18.871Z","comments":true,"path":"posts/e0ec8882/","link":"","permalink":"https://gentryhuang.com/posts/e0ec8882/","excerpt":"","text":"å®šä¹‰ ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£ï¼Œè€Œä¸ä½¿ç”¨å•ä¸€çš„æ€»æ¥å£ï¼Œå®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£ã€‚ æ³¨æ„ç‚¹ ä¸€ä¸ªç±»å¯¹ä¸€ä¸ªç±»çš„ä¾èµ–åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šï¼ˆè¿™é‡Œçš„ç±»æ˜¯æ³›æŒ‡ï¼Œä¹Ÿä»£è¡¨æ¥å£ï¼‰ã€‚ å»ºç«‹å•ä¸€æ¥å£ï¼Œä¸è¦å»ºç«‹åºå¤§è‡ƒè‚¿çš„æ¥å£ å°½é‡ç»†åŒ–æ¥å£ï¼Œæ¥å£ä¸­çš„æ–¹æ³•å°½é‡å°‘ æ³¨æ„é€‚åº¦åŸåˆ™ï¼Œä¸€å®šè¦é€‚åº¦ï¼Œè™½ç„¶æ¥å£ä¸­çš„æ–¹æ³•å°½é‡å°‘ï¼Œä½†æ˜¯ä¹Ÿè¦æœ‰é™åº¦ã€‚ä¼˜ç‚¹ç¬¦åˆæˆ‘ä»¬å¸¸è¯´çš„é«˜å†…èšä½è€¦åˆçš„è®¾è®¡æ€æƒ³ï¼Œä»è€Œä½¿å¾—ç±»å…·æœ‰å¾ˆå¥½çš„å¯è¯»æ€§ã€å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å’Œå•ä¸€èŒè´£åŸåˆ™æ¯”è¾ƒå•ä¸€èŒè´£åŸåˆ™æŒ‡çš„æ˜¯ç±»ã€æ¥å£å’Œæ–¹æ³•çš„èŒè´£æ˜¯å•ä¸€çš„ï¼Œå¼ºè°ƒçš„æ˜¯èŒè´£ï¼Œå¦‚æœèŒè´£æ˜¯å•ä¸€çš„é‚£ä¹ˆåœ¨ç±»æˆ–è€…æ¥å£ä¸­å…·æœ‰å¤šä¸ªæ–¹æ³•éƒ½æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æ˜¯ä¸€ç±»çš„ï¼Œæ¯”å¦‚å«å£°ï¼Œä¸åŒçš„åŠ¨ç‰©æœ‰ä¸åŒçš„å«ã€‚æ¥å£éš”ç¦»åŸåˆ™æ³¨é‡åœ°æ˜¯å¯¹æ¥å£ä¾èµ–çš„éš”ç¦»ã€‚ç®€å•éœ€æ±‚è¯´æ˜ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£å®šä¹‰å¤šä¸ªåŠŸèƒ½çš„æ–¹æ³•ï¼Œä½†æ˜¯æœ‰çš„å®ç°ä¸ä¸€å®šä¼šå…¨éƒ¨ç”¨åˆ°ï¼Œæœ€å¥½æ˜¯å°†è¿™ä¸ªç»Ÿä¸€çš„æ¥å£æ ¹æ®ä¸åŒçš„ç»´åº¦è¿›è¡Œæ‹†åˆ†æˆå¤šä¸ªæ¥å£ï¼Œå®ç°æ ¹æ®éœ€è¦è¿›è¡Œæ¥å£çš„å®ç°ã€‚ codingæ¥å£éš”ç¦»åŸåˆ™åä¾‹æ¥å£ 12345public interface IAnimalAction &#123; void eat(); void fly(); void swim();&#125; ç‹—å®ç°ç±» 1234567891011121314151617181920public class DogCaseOne implements IAnimalAction&#123; @Override public void eat() &#123; &#125; /** * æ³¨ï¼šè¿™é‡Œæ˜¯ç©ºæ–¹æ³•ï¼Œç‹—ä¸ä¼šé£ï¼Œæ‰€ä»¥æ˜æ˜¾è®¾è®¡çš„ä¸åˆç†ï¼Œæœ€å¥½ä¸è¦æœ‰å¤ªå¤šçš„ç©ºæ–¹æ³• */ @Override public void fly() &#123; &#125; @Override public void swim() &#123; &#125;&#125; é¸Ÿå®ç°ç±» 12345678910111213141516171819public class LarkCaseOne implements IAnimalAction&#123; @Override public void eat() &#123; &#125; @Override public void fly() &#123; &#125; /** * å¾ˆæ˜æ˜¾ï¼Œç™¾çµé¸Ÿä¸ä¼šæ¸¸æ³³ï¼Œæ­¤å¤„ä¸ºç©ºæ–¹æ³•ï¼Œè®¾è®¡ä¸åˆç† */ @Override public void swim() &#123; &#125;&#125; æ¥å£éš”ç¦»åŸåˆ™æ­£ä¾‹åƒä¸œè¥¿æ¥å£ 123456public interface IEat&#123; /** * åƒä¸œè¥¿ */ void eat();&#125; é£ç¿”æ¥å£ 123456public interface IFly&#123; /** * é£ç¿” */ void fly();&#125; æ¸¸æ³³æ¥å£ 123456public interface ISwim&#123; /** * æ¸¸æ³³ */ void swim();&#125; ç‹—å®ç°ç±» 123456789101112131415/** * ç‹—åªç”¨å®ç° åƒå’Œæ¸¸æ³³æ–¹æ³•å³å¯ */@Slf4jpublic class DogCaseTwo implements IEat,ISwim&#123; @Override public void eat() &#123; log.info(\"ç‹—åƒä¸œè¥¿!\"); &#125; @Override public void swim() &#123; log.info(\"ç‹—æ¸¸æ³³\"); &#125;&#125; é¸Ÿå®ç°ç±» 123456789101112131415/** * é¸Ÿå®ç° åƒå’Œé£æ–¹æ³•å³å¯ */@Slf4jpublic class LarkCaseTwo implements IEat,IFly&#123; @Override public void eat() &#123; log.info(\"é¸Ÿåƒä¸œè¥¿\"); &#125; @Override public void fly() &#123; log.info(\"é¸Ÿé£ç¿”\"); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"è¿ªç±³ç‰¹æ³•åˆ™","slug":"design_pattern/principle/è¿ªç±³ç‰¹æ³•åˆ™","date":"2019-09-02T16:00:00.000Z","updated":"2020-07-04T13:42:18.870Z","comments":true,"path":"posts/ebdadec7/","link":"","permalink":"https://gentryhuang.com/posts/ebdadec7/","excerpt":"","text":"å®šä¹‰ è¿ªç±³ç‰¹æ³•åˆ™ä¹Ÿå«æœ€å°‘çŸ¥é“åŸåˆ™,ä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡ä¿æŒæœ€å°‘çš„äº†è§£ï¼ˆæ¯”å¦‚åŒ…çš„æƒé™ï¼Œä¿®é¥°çš„å…³é”®å­—ï¼‰ã€‚å°½é‡é™ä½ç±»ä¸ç±»ä¹‹é—´çš„è€¦åˆã€‚ ä¼˜ç‚¹ é™ä½ç±»ä¹‹é—´çš„è€¦åˆã€‚ å¼ºè°ƒ åªå…³å¿ƒå‡ºç°åœ¨æˆå‘˜å˜é‡ã€æ–¹æ³•çš„å…¥å‚å’Œå‡ºå‚ä¸­çš„ç±»ï¼Œä¸å…³å¿ƒæ–¹æ³•ä½“å†…éƒ¨çš„ç±»ã€‚ ç®€å•éœ€æ±‚è¯´æ˜ å…¬å¸è€æ¿æƒ³äº†è§£æŸä¸ªä¸šåŠ¡ç»„çš„é¡¹ç›®æƒ…å†µï¼Œè€æ¿ç›´æ¥æ‰¾åˆ°TeamLeaderï¼Œä¸éœ€è¦å…³å¿ƒé¡¹ç›®ç»„å…¶ä»–æˆå‘˜ã€‚è€ŒTeamLeaderéœ€è¦è®©ç»„å†… æŸä¸ªæˆå‘˜è¿›è¡Œæ•´ç†èµ„æ–™ï¼Œç„¶äº¤ç»™è‡ªå·±ï¼Œè‡ªå·±å†äº¤ç»™è€æ¿ã€‚ codingè¿ªç±³ç‰¹æ³•åˆ™åä¾‹è€æ¿ç±» 123456789101112131415161718import java.util.ArrayList;import java.util.List;/** * æ­¤å¤„è®¾è®¡ä¸åˆç†ï¼Œåªè®¿é—®æœ‹å‹ç±»ï¼ˆæˆå‘˜å˜é‡ä¸­çš„ç±»ï¼Œè¾“å…¥ä¸­å‡ºç°çš„ç±»ï¼Œè¾“å‡ºä¸­å‡ºç°çš„ç±»ï¼‰ * æˆå‘˜æ–¹æ³•ä¸­çš„ç±»ä¸éœ€è¦å¼•å…¥(Member) */public class Boss &#123; public void findMembers()&#123; TeamLeader leader = new TeamLeader(); List&lt;Member&gt; list = new ArrayList&lt;Member&gt;(); for(int i= 0;i&lt;10;i++)&#123; list.add(new Member()); &#125; leader.countMember(list); &#125;&#125; ä¸»ç®¡ç±» 12345678import java.util.List;@Slf4jpublic class TeamLeader &#123; public void countMember(List list)&#123; log.info(\"å½“å‰é¡¹ç›®ç»„çš„æˆå‘˜æ•°ï¼š\"+list.size()); &#125;&#125; é¡¹ç›®ç»„æˆå‘˜ç±» 12345678910111213public class Member &#123; // ..&#125;``` **åº”ç”¨ç±»**```javapublic class Client&#123; public static void main(String[] args)&#123; Boss boss = new Boss(); boss.findMembers(); &#125;&#125; è¿ªç±³ç‰¹æ³•åˆ™æ­£ä¾‹è€æ¿ç±» 1234567891011121314151617package com.design.pattern.principle.demeter;/** * Boss * * @author shunhua * @date 2019-09-03 */public class Boss &#123; /** * å¯¹Memberä¸éœ€è¦è§ï¼Œåªå…³å¿ƒTeamLeader * @param teamLeader */ public void findProject(TeamLeader teamLeader)&#123; teamLeader.findProject(); &#125;&#125; ä¸»ç®¡ç±» 1234567891011121314151617181920package com.design.pattern.principle.demeter;import lombok.extern.slf4j.Slf4j;/** * TeamLeader * * @author shunhua * @date 2019-09-03 */@Slf4jpublic class TeamLeader &#123; /** * å…³æ³¨Member */ public void findProject()&#123; Member member = new Member(); log.info(String.valueOf(member)); &#125;&#125; æˆå‘˜ç±» 1234567891011package com.design.pattern.principle.demeter;/** * Member * * @author shunhua * @date 2019-09-03 */public class Member &#123; // ..&#125; åº”ç”¨ 12345678910111213141516171819202122package com.design.pattern.principle;import com.design.pattern.principle.demeter.Boss;import com.design.pattern.principle.demeter.TeamLeader;import org.junit.Test;/** * DemeterTest * * @author shunhua * @date 2019-09-03 */public class DemeterTest &#123; @Test public void test()&#123; Boss boss = new Boss(); TeamLeader teamLeader = new TeamLeader(); boss.findProject(teamLeader); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"ä¾èµ–å€’ç½®åŸåˆ™","slug":"design_pattern/principle/ä¾èµ–å€’ç½®åŸåˆ™","date":"2019-09-01T16:00:00.000Z","updated":"2020-07-04T13:42:18.866Z","comments":true,"path":"posts/91021fa8/","link":"","permalink":"https://gentryhuang.com/posts/91021fa8/","excerpt":"","text":"å®šä¹‰ é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–å…¶æŠ½è±¡ã€‚ ä¼˜ç‚¹ å¯ä»¥å‡å°‘ç±»é—´çš„è€¦åˆæ€§ã€æé«˜ç³»ç»Ÿç¨³å®šæ€§ï¼Œå¢å¼ºä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œå¯é™ä½ä¿®æ”¹ç¨‹åºé€ æˆçš„é£é™©ã€‚ ç»†èŠ‚æè¿° æŠ½è±¡ä¸åº”è¯¥ä¾èµ–ç»†èŠ‚ï¼Œç»†èŠ‚åº”è¯¥ä¾èµ–æŠ½è±¡ã€‚é’ˆå¯¹æ¥å£ç¼–ç¨‹è€Œä¸è¦é’ˆå¯¹å®ç°ç¼–ç¨‹ã€‚ ç®€å•éœ€æ±‚è¯´æ˜ æŸåŒå­¦æƒ³è¦å­¦ä¹ æŸä¸€è¯¾ç¨‹ï¼Œæœ€ç®€å•çš„æ–¹å¼ç›´æ¥åœ¨Personä¸­ç¼–å†™ä¸€ä¸ªæ–¹æ³•å³å¯ï¼Œä½†æ˜¯å¦‚æœä»¥åæƒ³è¦å­¦ä¹ å…¶ä»–è¯¾ç¨‹å°± éœ€è¦ä¿®æ”¹Personç±»ã€‚ä¸ºäº†è§£è€¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¯¾ç¨‹æŠ½è±¡å‡ºå»ï¼Œé«˜å±‚å¯¹åº•å±‚çš„ä¾èµ–ï¼Œè¿™æ ·Personä¾èµ–çš„å°±æ˜¯æŠ½è±¡ï¼Œæˆ‘ ä»¬é’ˆå¯¹æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹å®ç°ç¼–ç¨‹ã€‚ codingéé¢å‘æŠ½è±¡ç¼–ç¨‹12345678910111213141516171819202122232425ç¼ºç‚¹ï¼šåº”ç”¨ä¾èµ–å…·ä½“çš„å®ç°ï¼Œå¯¹äºåç»­éœ€æ±‚å˜æ›´æ›´åŠ ä¸é€‚ç”¨&#96;&#96;&#96; **å®ä½“ç±»**&#96;&#96;&#96;javapackage com.design.pattern.principle.dependenceinversion;import lombok.extern.slf4j.Slf4j;&#x2F;** * Person * * @author shunhua * @date 2019-09-02 *&#x2F;@Slf4jpublic class Person &#123; public void learnJavaCourse()&#123; log.info(&quot;å­¦ä¹ Javaè¯¾ç¨‹&quot;); &#125; public void learnPythonCourse()&#123; log.info(&quot;å­¦ä¹ Pythonè¯¾ç¨‹&quot;); &#125;&#125; åº”ç”¨ 12345678910111213141516171819202122package com.design.pattern.principle;import com.design.pattern.principle.dependenceinversion.PythonCourse;import com.design.pattern.principle.dependenceinversion.JavaCourse;import com.design.pattern.principle.dependenceinversion.Person;import org.junit.Test;/** * DependeceinversionTest * * @author shunhua * @date 2019-09-02 */public class DependeceinversionTest &#123; @Test public void test()&#123; Person person = new Person(); person.studyJava(); person.studyPython(); &#125;&#125; é¢å‘æ¥å£ç¼–ç¨‹1è¿™é‡Œä½¿ç”¨æ¥å£æ–¹æ³•ä¼ å‚çš„æ–¹å¼ è¯¾ç¨‹æ¥å£ 1234567891011121314package com.design.pattern.principle.dependenceinversion;/** * ICourse * * @author shunhua * @date 2019-09-02 */public interface ICourse &#123; /** * å­¦ä¹ è¯¾ç¨‹ */ void learnCourse();&#125; Javaè¯¾ç¨‹ 123456789101112131415161718package com.design.pattern.principle.dependenceinversion;import lombok.extern.slf4j.Slf4j;/** * JavaCourse * * @author shunhua * @date 2019-09-02 */@Slf4jpublic class JavaCourse implements ICourse &#123; @Override public void learnCourse() &#123; log.info(\"gentryhuang is learning java\"); &#125;&#125; Pythonè¯¾ç¨‹ 123456789101112131415161718package com.design.pattern.principle.dependenceinversion;import lombok.extern.slf4j.Slf4j;/** * PythonCourse * * @author shunhua * @date 2019-09-02 */@Slf4jpublic class PythonCourse implements ICourse &#123; @Override public void learnCourse() &#123; log.info(\"gentryhuang is learning python\"); &#125;&#125; å®ä½“ 1234567891011121314151617package com.design.pattern.principle.dependenceinversion;import lombok.extern.slf4j.Slf4j;/** * Person * * @author shunhua * @date 2019-09-02 */@Slf4jpublic class Person &#123; public void learnCource(ICourse course)&#123; course.learnCourse(); &#125;&#125; åº”ç”¨ 123456789101112131415161718192021package com.design.pattern.principle;import com.design.pattern.principle.dependenceinversion.PythonCourse;import com.design.pattern.principle.dependenceinversion.JavaCourse;import com.design.pattern.principle.dependenceinversion.Person;import org.junit.Test;/** * DependeceinversionTest * * @author shunhua * @date 2019-09-02 */public class DependeceinversionTest &#123; @Test public void test()&#123; Person person = new Person(); person.learnCource(new JavaCourse()); person.learnCource(new PythonCourse()); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å•ä¸€èŒè´£åŸåˆ™","slug":"design_pattern/principle/å•ä¸€èŒè´£åŸåˆ™","date":"2019-09-01T16:00:00.000Z","updated":"2020-07-04T13:42:18.868Z","comments":true,"path":"posts/46a1bcf2/","link":"","permalink":"https://gentryhuang.com/posts/46a1bcf2/","excerpt":"","text":"å®šä¹‰ ä¸è¦å­˜åœ¨å¤šäºä¸€ä¸ªå¯¼è‡´ç±»å˜æ›´çš„åŸå› ã€‚ä½“ç°åœ¨ä¸€ä¸ªç±»/æ¥å£/æ–¹æ³•åªè´Ÿè´£ä¸€é¡¹èŒè´£ã€‚ ä¼˜ç‚¹ é™ä½ç±»çš„å¤æ‚åº¦ã€æé«˜ç±»çš„å¯è¯»æ€§ï¼Œæé«˜ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§ï¼Œé™ä½å˜æ›´å¼•èµ·çš„é£é™©ã€‚ è¯¦è§£ åœ¨ç±»çš„çº§åˆ«ä¸Šï¼Œå¯ä»¥å®šä¹‰ä¸åŒçš„ç±»å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œåœ¨æ¥å£çº§åˆ«ä¸Šï¼Œå¯ä»¥æ ¹æ®åŠŸèƒ½æŠ½è±¡å‡ºä¸åŒçš„æ¥å£ï¼Œç„¶åæŒ‰éœ€è¦å®ç°ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ã€‚æ–¹æ³•çº§åˆ«ä¸Šï¼Œå¯ä»¥åšåˆ°ä¸åŒçš„æ–¹æ³•å®ç°ä¸åŒçš„æ“ä½œã€‚ è¦ç‚¹è®²è§£12341. å®é™…åº”ç”¨ä¸­ï¼Œç±»ä¸é‡‡ç”¨å•ä¸€èŒè´£ï¼Œæ¥å£å’Œæ–¹æ³•é‡‡ç”¨å•ä¸€èŒè´£ã€‚2. å®šä¹‰ï¼šå•ä¸€èŒè´£è§„å®š ä¸€ä¸ªç±»ï¼Œæ¥å£æˆ–è€…æ–¹æ³•ï¼Œåªæœ‰ä¸€ä¸ªå˜åŒ–çš„åŸå› 3. ä¼˜ç‚¹ï¼šé™ä½ç±»çš„å¤æ‚æ€§ï¼Œæé«˜å¯è¯»æ€§ï¼Œç»´æŠ¤æ—¶é£é™©é™ä½4. å®é™…åº”ç”¨ï¼Œå—ä¾èµ–ï¼Œç»„åˆï¼Œèšåˆè¿™äº›å…³ç³»å½±å“ï¼ŒåŒæ—¶å—æ§äºé¡¹ç›®è§„æ¨¡ï¼Œé¡¹ç›®å‘¨æœŸï¼ŒæŠ€æœ¯äººå‘˜æ°´å¹³ï¼Œå¯¹è¿›åº¦æŠŠæ§ç­‰å½±å“ã€‚åº”é€‚å½“çš„åº”ç”¨å•ä¸€èŒè´£åŸåˆ™ ç®€å•éœ€æ±‚è¯´æ˜ å®Œæˆä¸åŒåŠŸèƒ½ï¼Œå¹¶ä¸”ä½¿è®¾è®¡æ¨¡å—å…·æœ‰å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç±»æˆ–æ¥å£æˆ–æ–¹æ³•å»å®ŒæˆæŸä¸€ç±»åŠŸèƒ½ï¼Œè¿™æ ·å°±æ˜¾å¾—å•ä¸€ï¼Œå…·æœ‰é’ˆå¯¹æ€§ã€‚ ç±»çš„å•ä¸€èŒè´£åŸåˆ™å®ä½“ç±»1 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263package com.design.pattern.principle.singleresponsibility;import lombok.extern.slf4j.Slf4j;/** * WalkBird * * @author shunhua * @date 2019-09-02 */@Slf4jpublic class WalkBird &#123; public void moveMode(String birdName)&#123; log.info(birdName + \"é™†åœ°å¥”è·‘\"); &#125;&#125;``` **å®ä½“ç±»2**```javapackage com.design.pattern.principle.singleresponsibility;import lombok.extern.slf4j.Slf4j;/** * FlyBird * * @author shunhua * @date 2019-09-02 */@Slf4jpublic class FlyBird &#123; public void moveMode(String birdName)&#123; log.info(birdName + \"ç”¨ç¿…è†€é£\"); &#125;&#125;``` **åº”ç”¨**```javapublic class Client &#123; public static void main(String[] args) &#123; WalkBird walkBird = new WalkBird(); walkBird.birdMove(\"é¸µé¸Ÿ\"); FlyBird flyBird = new FlyBird(); flyBird.birdMove(\"å¤§é›\"); &#125;&#125;``` ### æ¥å£çš„å•ä¸€èŒè´£**æ¥å£1**```java/** * è¿™ä¸ªæ¥å£å’Œè·å–å†…å®¹çš„æ¥å£æœ‰å…ˆåé¡ºåºï¼Œåªæœ‰å¼€å§‹å­¦ä¹ ï¼Œæ‰èƒ½è·å–å†…å®¹ï¼Œå¦‚æœé€€å‡ºå­¦ä¹ ï¼Œå°±ä¸èƒ½åœ¨è·å–å†…å®¹äº†ï¼Œ * ç”±äºèŒè´£ä¸åŒï¼Œæ‰€ä»¥è®¾è®¡ä¸¤ä¸ªæ¥å£ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ */public interface IcourseAction &#123; void beginStudy(); void quitStudy();&#125; æ¥å£2 1234567/** * æ³¨ï¼Œæœ¬æ¥å£ä¸»è¦æ˜¯è·å–è¯¾ç¨‹çš„å†…å®¹ */public interface IcourseContent &#123; String getCourseText();//è·å–è¯¾ç¨‹æ–‡æœ¬å†…å®¹ byte[] getCourseVideo();//è·å–è¯¾ç¨‹çš„è§†é¢‘&#125; å®ä½“ç±» 12345678910111213141516171819202122@Slf4jpublic class Course implements IcourseAction,IcourseContent&#123; @Override public void beginStudy() &#123; log.info(\"å¼€å§‹å­¦ä¹ !\"); &#125; @Override public void quitStudy() &#123; log.info(\"å­¦ä¹ å®Œæˆï¼\"); &#125; @Override public String getCourseText() &#123; return \"Java èµ„æ–™\"; &#125; @Override public byte[] getCourseVideo() &#123; return new byte[0]; &#125;&#125; æ–¹æ³•çš„å•ä¸€èŒè´£12345678910111213141516171819202122232425public class Method &#123; /** * å•ä¸€èŒè´£åŸåˆ™ï¼Œä¿®æ”¹ç”¨æˆ·çš„åç§° * @return */ public String updateUserName()&#123; return \"\"; &#125; /** * å•ä¸€èŒè´£åŸåˆ™,ä¿®æ”¹ç”¨æˆ·çš„å¯†ç  * @return */ public String updateUserPassWord()&#123; return \"\"; &#125; /** * ä¸ç¬¦åˆå•ä¸€èŒè´£ * @return */ public String updateUserInfo(String userId,String gender)&#123; return \" \"; &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"å¼€é—­åŸåˆ™","slug":"design_pattern/principle/å¼€é—­åŸåˆ™","date":"2019-08-31T16:00:00.000Z","updated":"2020-07-04T13:42:18.869Z","comments":true,"path":"posts/f50731fc/","link":"","permalink":"https://gentryhuang.com/posts/f50731fc/","excerpt":"","text":"å®šä¹‰ ä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚ç±»ã€æ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚ å¼ºè°ƒçš„æ˜¯ç”¨æŠ½è±¡æ„å»ºæ¡†æ¶ï¼Œç”¨å®ç°æ‰©å±•ç»†èŠ‚ã€‚ æ ¸å¿ƒæ€æƒ³ é¢å‘æŠ½è±¡ç¼–ç¨‹ï¼Œå› ä¸ºæŠ½è±¡æ˜¯ç¨³å®šçš„ã€‚ ç†è§£ ä¸æ”¹å˜åŸå…ˆçš„ä¸šåŠ¡é€»è¾‘ï¼Œæ–°å¢çš„åŠŸèƒ½ç‚¹é€šè¿‡é‡å†™å¤ç”¨çš„æ–¹æ³•è¿›è¡Œç¼–ç¨‹ã€‚ ä¼˜ç‚¹ æé«˜è½¯ä»¶ç³»ç»Ÿçš„å¯å¤ç”¨æ€§ä»¥åŠå¯ç»´æŠ¤æ€§ ç®€å•éœ€æ±‚è¯´æ˜ è½¯ä»¶å®ä½“ICourseï¼Œä»¥åŠå®ƒçš„å®ç°JavaCourceå®ç°äº†åŸºæœ¬åŠŸèƒ½ï¼Œå¦‚éœ€è¦é¢å¤–çš„åŠŸèƒ½å¯ä»¥å¯¹JavaCourseè¿›è¡Œæ‰©å±•å³ç»§æ‰¿æ¥æ·»åŠ ï¼Œ è¿™æ ·åœ¨ä¸ä¿®æ”¹åº•å±‚çš„ICourseå’ŒJavaCourseçš„å‰æä¸‹ï¼Œåšåˆ°åŠŸèƒ½çš„æ·»åŠ ã€‚å³ï¼Œè¶ŠåŸºå±‚çš„æ¨¡å—å½±å“èŒƒå›´è¶Šå¤§ï¼Œè¶Šé«˜å±‚çš„æ¨¡å—å½±å“ èŒƒå›´è¾ƒå°ï¼Œæ€»ä½“å®ç°äº†å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆè§£å†³å½±å“èŒƒå›´ã€‚ codingv1 åŸºç±»1éœ€æ±‚ï¼šæ‰“å°å‡ºåŸä»·ä»¥åŠè¯¾ç¨‹å…¶ä»–ä¿¡æ¯ æ¥å£ 12345678910111213141516171819202122232425package com.design.pattern.principle.openclose;/** * ICourse * * @author shunhua * @date 2019-09-01 */public interface ICourse &#123; /** * è·å–è¯¾ç¨‹id * @return */ Integer getId(); /** * è·å–è¯¾ç¨‹åç§° * @return */ String getName(); /** * è·å–è¯¾ç¨‹ä»·æ ¼ * @return */ Double getPrice();&#125; å®ä½“ç±» 1234567891011121314151617181920212223242526272829303132333435363738394041424344package com.design.pattern.principle.openclose;import lombok.AllArgsConstructor;import lombok.Data;import lombok.NoArgsConstructor;/** * JavaCourse * * @author shunhua * @date 2019-09-01 */@AllArgsConstructor@NoArgsConstructor@Datapublic class JavaCourse implements ICourse &#123; /** * è¯¾ç¨‹id */ private Integer id; /** * è¯¾ç¨‹åç§° */ private String name; /** * è¯¾ç¨‹ä»·æ ¼ */ private Double price; @Override public Integer getId() &#123; return this.id; &#125; @Override public String getName() &#123; return this.name; &#125; @Override public Double getPrice() &#123; return this.price; &#125;&#125; åº”ç”¨ 123456789101112131415161718192021222324252627package com.design.pattern.principle;import com.design.pattern.principle.openclose.ICourse;import com.design.pattern.principle.openclose.JavaCourse;import com.design.pattern.principle.openclose.JavaDiscountCourse;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * OpencloseTest * * @author shunhua * @date 2019-09-01 */@Slf4jpublic class OpencloseTest &#123; @Test public void testBase()&#123; ICourse javaCourse = new JavaCourse(100,\"Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ\",200d); log.info(String.format(\"è¯¾ç¨‹id: %d,è¯¾ç¨‹å: %s, è¯¾ç¨‹ä»·æ ¼ï¼š%f\", javaCourse.getId(), javaCourse.getName(), javaCourse.getPrice()) ); &#125;&#125; v21éœ€æ±‚ï¼šæ‰“å°å‡ºåŸä»·å’ŒæŠ˜æ‰£åçš„ä»·æ ¼ä»¥åŠè¯¾ç¨‹å…¶ä»–ä¿¡æ¯ï¼ˆæ¥å£ä¸åº”è¯¥éšæ„å‘ç”Ÿå˜åŒ–ï¼Œé¢å‘æ¥å£ç¼–ç¨‹ï¼‰ æ¥å£ 12345678910111213141516171819202122232425package com.design.pattern.principle.openclose;/** * ICourse * * @author shunhua * @date 2019-09-01 */public interface ICourse &#123; /** * è·å–è¯¾ç¨‹id * @return */ Integer getId(); /** * è·å–è¯¾ç¨‹åç§° * @return */ String getName(); /** * è·å–è¯¾ç¨‹ä»·æ ¼ * @return */ Double getPrice();&#125; å®ä½“ç±» 1234567891011121314151617181920212223242526272829303132package com.design.pattern.principle.openclose;/** * JavaDiscountCourse * * @author shunhua * @date 2019-09-01 */public class JavaDiscountCourse extends JavaCourse &#123; public JavaDiscountCourse(Integer id, String name, Double price) &#123; super(id, name, price); &#125; /** * è·å–æŠ˜æ‰£ä»· * @return */ @Override public Double getPrice() &#123; return super.getPrice() * 0.8; &#125; /** * è·å–åŸä»· * @return */ public Double getOriginPrice()&#123; return super.getPrice(); &#125;&#125; åº”ç”¨ 123456789101112131415161718192021222324252627282930313233343536373839package com.design.pattern.principle;import com.design.pattern.principle.openclose.ICourse;import com.design.pattern.principle.openclose.JavaCourse;import com.design.pattern.principle.openclose.JavaDiscountCourse;import lombok.extern.slf4j.Slf4j;import org.junit.Test;/** * OpencloseTest * * @author shunhua * @date 2019-09-01 */@Slf4jpublic class OpencloseTest &#123; @Test public void testBase()&#123; ICourse javaCourse = new JavaCourse(100,\"Javaä»å…¥é—¨åˆ°æ”¾å¼ƒ\",200d); log.info(String.format(\"è¯¾ç¨‹id: %d,è¯¾ç¨‹å: %s, è¯¾ç¨‹ä»·æ ¼ï¼š%f\", javaCourse.getId(), javaCourse.getName(), javaCourse.getPrice()) ); &#125; @Test public void testEx()&#123; ICourse javaCource = new JavaDiscountCourse(100,\"javaä»å…¥é—¨åˆ°æ”¾å¼ƒ\",200d); log.info(String.format(\"è¯¾ç¨‹id: %d,è¯¾ç¨‹å: %s, è¯¾ç¨‹åŸä»·ï¼š%fï¼Œè¯¾ç¨‹æŠ˜æ‰£ä»·æ ¼ï¼š%f\", javaCource.getId(), javaCource.getName(), ((JavaDiscountCourse) javaCource).getOriginPrice(), javaCource.getPrice()) ); &#125;&#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"ç®€å•å·¥å‚","slug":"design_pattern/other_type/ç®€å•å·¥å‚","date":"2019-08-28T16:00:00.000Z","updated":"2020-08-09T09:24:21.833Z","comments":true,"path":"posts/90fd4bf3/","link":"","permalink":"https://gentryhuang.com/posts/90fd4bf3/","excerpt":"","text":"å®šä¹‰ ç”±ä¸€ä¸ªå·¥å‚å¯¹è±¡å†³å®šåˆ›å»ºå‡ºå“ªä¸€ç§äº§å“ç±»çš„å®ä¾‹ ç±»å‹ åˆ›å»ºå‹ï¼Œä½†ä¸å±äºGOF23ç§è®¾è®¡æ¨¡å¼ã€‚ç®€å•å·¥å‚æ¨¡å¼ä¸¥æ ¼æ„ä¹‰ä¸Šè¯´å¹¶ä¸æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå®ƒæ˜¯ä¸€ç§ç¼–ç ä¸Šçš„é£æ ¼å’Œä¹ æƒ¯ ä½¿ç”¨åœºæ™¯ å·¥å‚ç±»è´Ÿè´£åˆ›å»ºçš„å¯¹è±¡æ¯”è¾ƒå°‘ å®¢æˆ·ç«¯ï¼ˆåº”ç”¨å±‚ï¼‰åªçŸ¥é“ä¼ å…¥å·¥å‚ç±»çš„å‚æ•°ï¼Œå¯¹äºå¦‚ä½•åˆ›å»ºå¯¹è±¡ï¼ˆé€»è¾‘ï¼‰ä¸å…³å¿ƒä¼˜ç‚¹åªéœ€è¦ä¼ å…¥ä¸€ä¸ªæ­£ç¡®çš„å‚æ•°ï¼Œå°±å¯ä»¥è·å–æ‰€éœ€è¦çš„å¯¹è±¡è€Œæ— é¡»çŸ¥é“å…¶åˆ›å»ºç»†èŠ‚ç¼ºç‚¹ç®€å•å·¥å‚ç±»çš„èŒè´£ç›¸å¯¹è¿‡é‡ï¼Œå¢åŠ æ–°çš„äº§å“éœ€è¦ä¿®æ”¹å·¥å‚ç±»çš„åˆ¤æ–­é€»è¾‘ï¼Œè¿èƒŒäº†å¼€é—­åŸåˆ™ã€‚ codingæœªä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼çš„ä»£ç çˆ¶ç±» 12345678910111213public abstract class Video&#123; public abstract void printVideo();&#125;``` **å­ç±»JavaVideo**```java@Slf4jpublic class JavaVideo extends Video&#123; @Override public void printVideo() &#123; log.info(\"å½•åˆ¶javaè§†é¢‘\"); &#125;&#125; å­ç±»PythonVideo 1234567@Slf4jpublic class PythonVideo extends Video&#123; @Override public void printVideo() &#123; log.info(\"å½•åˆ¶pythonè§†é¢‘\"); &#125;&#125; åº”ç”¨ 1234567public class client&#123; @Test public void test()&#123; Video video = new JavaVideo(); video.printVideo(); &#125;&#125; ä½¿ç”¨ç®€å•å·¥å‚æ¨¡å¼ å·¥å‚ç±» 12345678910111213141516171819202122232425262728293031323334353637383940414243package com.design.pattern.simplefactory;/** * ç®€å•å·¥å‚ * * @author shunhua * @date 2019-09-09 */public class FoodFactory &#123; /** * éšç€è¦äº§å“å¢å¤šï¼Œä»¥ä¸‹é€»è¾‘å¿…é¡»è¦ä¿®æ”¹ * @param type è¿™é‡Œä½¿ç”¨å­—ç¬¦ä¸²æ ¹æ®ç±»å‹è¿›è¡Œåˆ›å»ºä¸åŒçš„å®ä¾‹ * @return */ public Food createFood(String type)&#123; if(\"salad\".equalsIgnoreCase(type))&#123; return new Salad(); &#125;else if(\"bread\".equalsIgnoreCase(type))&#123; return new Bread(); &#125; return null; &#125; /** * * @param c è¿™é‡Œä½¿ç”¨åå°„åˆ›å»ºä¸åŒçš„å®ä¾‹ * @return */ public Food createFood(Class c)&#123; Food food = null; try &#123; food = (Food) Class.forName(c.getName()).newInstance(); &#125; catch (InstantiationException e) &#123; e.printStackTrace(); &#125; catch (IllegalAccessException e) &#123; e.printStackTrace(); &#125; catch (ClassNotFoundException e) &#123; e.printStackTrace(); &#125; return food; &#125;&#125; çˆ¶ç±» 1234567891011121314package com.design.pattern.simplefactory;/** * Food * * @author shunhua * @date 2019-09-09 */public abstract class Food &#123; /** * ç”Ÿäº§äº§å“æ–¹æ³• */ public abstract void produce();&#125; å­ç±»é¢åŒ… 123456789101112131415161718package com.design.pattern.simplefactory;import lombok.extern.slf4j.Slf4j;/** * Bread * * @author shunhua * @date 2019-09-09 */@Slf4jpublic class Bread extends Food &#123; @Override public void produce() &#123; log.info(\"ç”Ÿäº§é¢åŒ…!\"); &#125;&#125; å­ç±»æ²™æ‹‰ 123456789101112131415161718package com.design.pattern.simplefactory;import lombok.extern.slf4j.Slf4j;/** * Salad * * @author shunhua * @date 2019-09-09 */@Slf4jpublic class Salad extends Food &#123; @Override public void produce() &#123; log.info(\"ç”Ÿæˆæ²™æ‹‰!\"); &#125;&#125; å®¢æˆ·ç«¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748package com.design.pattern.simplefactory;import com.common.base.ObjectUtils;import com.design.pattern.simplefactory.Bread;import com.design.pattern.simplefactory.Food;import com.design.pattern.simplefactory.FoodFactory;import com.design.pattern.simplefactory.Salad;import org.junit.Test;/** * Client * * @author shunhua * @date 2019-09-09 */public class Client &#123; /* éç®€å•å·¥å‚æ¨¡å¼ @Test public void simpleFactoryBefore()&#123; // è¿™é‡Œéœ€è¦ä¾èµ–å…·ä½“çš„ç”Ÿäº§ç±» Food food = new Bread(); Food food1 = new Salad(); food.produce(); food1.produce(); &#125;*/ /* @Test public void simpleFactoryByType()&#123; // åˆ›å»ºä¸€ä¸ªç®€å•å·¥å‚ FoodFactory factory = new FoodFactory(); // ç”±å·¥å‚åˆ›å»ºå®ä¾‹å¯¹è±¡ Food food = factory.createFood(\"salad\"); food.produce(); &#125; */ @Test public void simpleFactoryByClass()&#123; FoodFactory factory = new FoodFactory(); Food food = factory.createFood(Bread.class); if(ObjectUtils.isNotNull(food))&#123; food.produce(); &#125; &#125;&#125; ç®€å•å·¥å‚åœ¨æºç ä¸­çš„ä½¿ç”¨jdkçš„Calendaræºç è§£æ123456789101112131415161718192021222324252627282930313233343536373839404142434445// è¿™é‡Œä½¿ç”¨çš„æ˜¯é™æ€æ–¹æ³•ï¼Œå› ä¸ºä¸éœ€è¦å†é€šè¿‡ç»§æ‰¿è¿›è¡Œæ‰©å±•ã€‚å¦‚éœ€æ‰©å±•å°±ä¸ä½¿ç”¨staticå…³é”®å­—public static Calendar getInstance(TimeZone zone, Locale aLocale)&#123; return createCalendar(zone, aLocale); &#125; private static Calendar createCalendar(TimeZone zone, Locale aLocale) &#123; CalendarProvider provider = LocaleProviderAdapter.getAdapter(CalendarProvider.class, aLocale).getCalendarProvider(); if (provider != null) &#123; try &#123; return provider.getInstance(zone, aLocale); &#125; catch (IllegalArgumentException iae) &#123; // fall back to the default instantiation &#125; &#125; Calendar cal = null; if (aLocale.hasExtensions()) &#123; String caltype = aLocale.getUnicodeLocaleType(\"ca\"); if (caltype != null) &#123; // æ ¹æ®ä¸åŒçš„ç±»å‹åˆ›å»ºæ—¥æœŸå¯¹è±¡ switch (caltype) &#123; case \"buddhist\": cal = new BuddhistCalendar(zone, aLocale); break; case \"japanese\": cal = new JapaneseImperialCalendar(zone, aLocale); break; case \"gregory\": cal = new GregorianCalendar(zone, aLocale); break; &#125; &#125; &#125; if (cal == null) &#123; if (aLocale.getLanguage() == \"th\" &amp;&amp; aLocale.getCountry() == \"TH\") &#123; cal = new BuddhistCalendar(zone, aLocale); &#125; else if (aLocale.getVariant() == \"JP\" &amp;&amp; aLocale.getLanguage() == \"ja\" &amp;&amp; aLocale.getCountry() == \"JP\") &#123; cal = new JapaneseImperialCalendar(zone, aLocale); &#125; else &#123; cal = new GregorianCalendar(zone, aLocale); &#125; &#125; return cal; &#125; DriverManageræºç è§£æï¼ˆé€šè¿‡classForNameè·å–ï¼‰123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778public static Connection getConnection(String url, java.util.Properties info) throws SQLException &#123; // Gets the classloader of the code that called this method, may // be null. ClassLoader callerCL = DriverManager.getCallerClassLoader(); return (getConnection(url, info, callerCL)); &#125;// Worker method called by the public getConnection() methods. private static Connection getConnection( String url, java.util.Properties info, ClassLoader callerCL) throws SQLException &#123; java.util.Vector drivers = null; /* * When callerCl is null, we should check the application's * (which is invoking this class indirectly) * classloader, so that the JDBC driver class outside rt.jar * can be loaded from here. */ synchronized(DriverManager.class) &#123; // synchronize loading of the correct classloader. if(callerCL == null) &#123; callerCL = Thread.currentThread().getContextClassLoader(); &#125; &#125; if(url == null) &#123; throw new SQLException(\"The url cannot be null\", \"08001\"); &#125; println(\"DriverManager.getConnection(\\\"\" + url + \"\\\")\"); if (!initialized) &#123; initialize(); &#125; synchronized (DriverManager.class)&#123; // use the readcopy of drivers drivers = readDrivers; &#125; // Walk through the loaded drivers attempting to make a connection. // Remember the first exception that gets raised so we can reraise it. SQLException reason = null; for (int i = 0; i &lt; drivers.size(); i++) &#123; DriverInfo di = (DriverInfo)drivers.elementAt(i); // If the caller does not have permission to load the driver then // skip it. if ( getCallerClass(callerCL, di.driverClassName ) != di.driverClass ) &#123; println(\" skipping: \" + di); continue; &#125; try &#123; println(\" trying \" + di); Connection result = di.driver.connect(url, info); if (result != null) &#123; // Success! println(\"getConnection returning \" + di); return (result); &#125; &#125; catch (SQLException ex) &#123; if (reason == null) &#123; reason = ex; &#125; &#125; &#125; // if we got here nobody could connect. if (reason != null) &#123; println(\"getConnection failed: \" + reason); throw reason; &#125; println(\"getConnection: no suitable driver found for \"+ url); throw new SQLException(\"No suitable driver found for \"+ url, \"08001\"); &#125;","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]},{"title":"umlåŸºç¡€","slug":"design_pattern/uml","date":"2019-08-27T16:00:00.000Z","updated":"2020-08-09T09:14:31.577Z","comments":true,"path":"posts/cadc5d6c/","link":"","permalink":"https://gentryhuang.com/posts/cadc5d6c/","excerpt":"","text":"å®šä¹‰ç»Ÿä¸€å»ºæ¨¡è¯­è¨€ï¼ˆç¼©å†™UMLï¼‰ï¼Œéä¸“åˆ©çš„ç¬¬ä¸‰ä»£å»ºæ¨¡å’Œè§„çº¦è¯­è¨€ ç‰¹ç‚¹ UMLæ˜¯ä¸€ç§å¼€æ”¾çš„æ–¹æ³• UMLç”¨äºè¯´æ˜ã€å¯è§†åŒ–ã€æ„å»ºå’Œç¼–å†™ä¸€ä¸ªæ­£åœ¨å¼€å‘çš„é¢å‘å¯¹è±¡çš„ã€è½¯ä»¶å¯†é›†ç³»ç»Ÿçš„åˆ¶å“çš„å¼€æ”¾æ–¹æ³• UMLå±•ç°äº†ä¸€ç³»åˆ—æœ€ä½³å·¥ç¨‹çš„å®è·µï¼Œè¿™äº›æœ€ä½³å®è·µåœ¨å¯¹å¤§è§„æ¨¡ï¼Œå¤æ‚ç³»ç»Ÿè¿›è¡Œå»ºæ¨¡æ–¹é¢ï¼Œç‰¹åˆ«æ˜¯åœ¨è½¯ä»¶æ¶æ„å±‚é¢å·²ç»è¢«éªŒè¯æœ‰æ•ˆ UMLåˆ†ç±» ç»“æ„å¼å›¾å½¢ å¼ºè°ƒçš„æ˜¯ç³»ç»Ÿå¼çš„å»ºæ¨¡ï¼Œå…·ä½“åŒ…å«é™æ€å›¾ï¼ˆç±»å›¾ã€å¯¹è±¡å›¾ã€åŒ…å›¾ï¼‰ã€å®ç°å›¾ï¼ˆç»„ä»¶å›¾ã€éƒ¨ç½²å›¾ï¼‰ã€å‰–é¢å›¾ä»¥åŠå¤åˆç»“æ„å›¾ è¡Œä¸ºå¼å›¾å½¢ å¼ºè°ƒç³»ç»Ÿæ¨¡å‹ä¸­è§¦å‘çš„äº‹ä»¶ï¼Œå…·ä½“åŒ…å«æ´»åŠ¨å›¾ã€çŠ¶æ€å›¾ä»¥åŠç”¨ä¾‹å›¾ äº¤äº’å¼å›¾å½¢ å±äºè¡Œä¸ºå¼å›¾å½¢å­é›†åˆï¼Œå¼ºè°ƒç³»ç»Ÿæ¨¡å‹ä¸­èµ„æºæµç¨‹ã€‚å…·ä½“åŒ…å«é€šä¿¡å›¾ã€äº¤äº’æ¦‚å¿µå›¾ã€æ—¶åºå›¾ ä»¥åŠæ—¶é—´å›¾ â€‹ UMLç±»å›¾ç”¨äºè¡¨ç¤ºç±»ã€æ¥å£ã€å®ä¾‹ç­‰ä¹‹é—´ç›¸äº’çš„é™æ€å…³ç³»ã€‚è™½ç„¶åå­—å«ç±»å›¾ï¼Œä½†ç±»å›¾ä¸­å¹¶ä¸åªæœ‰ç±»ï¼Œè¿˜å¯èƒ½åŒ…æ‹¬æƒé™ã€å±æ€§ã€æ–¹æ³•ç­‰ UMLè®°å¿†æ–¹å¼12341. umlç®­å¤´ï¼šä»å­ç±»æŒ‡å‘çˆ¶ç±»ï¼Œåªæœ‰çŸ¥é“å¯¹æ–¹ä¿¡æ¯æ—¶æ‰èƒ½æŒ‡å‘å¯¹æ–¹æ–¹å‘2. ç©ºå¿ƒä¸‰è§’ç®­å¤´ï¼šç»§æ‰¿æˆ–å®ç°ï¼Œå®çº¿-ç»§æ‰¿ï¼šç§¯æçš„ï¼Œå¼ºå…³è”ï¼Œå…³è”ï¼Œé€šå¸¸ä¸€ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªç±»çš„å¯¹è±¡åšå±æ€§ï¼›è™šçº¿-å®ç°ï¼šæ¶ˆæçš„ï¼Œå¼±å…³è”ï¼Œä¾èµ–3. ç©ºå¿ƒè±å½¢ï¼šèšåˆï¼Œï¼ˆæ³¨ï¼šå¯ä»¥çœ‹ä½œä¸€ä¸ªç›˜å­ï¼Œå¯ä»¥æ”¾å¾ˆå¤šç›¸åŒçš„ä¸œè¥¿ï¼ˆç®­å¤´æ–¹å‘æ‰€æŒ‡çš„ç±»ï¼‰ï¼Œèšåœ¨ä¸€èµ·ã€‚æ˜¯has açš„å…³ç³»ï¼‰å¼±å…³è”4. å®å¿ƒè±å½¢ï¼šç»„åˆï¼Œï¼ˆæ³¨ï¼šä»£è¡¨å™¨çš¿é‡Œæœ‰å®ä½“ç»“æ„å­˜åœ¨ï¼Œç»„åˆèµ·æ¥æˆä¸ºä¸€ä¸ªã€‚æ˜¯contains-açš„å…³ç³»ï¼‰å¼ºå…³è” umlç®­å¤´ï¼šä»å­ç±»æŒ‡å‘çˆ¶ç±»ï¼Œå®šä¹‰å­ç±»æ—¶éœ€è¦é€šè¿‡extendså…³é”®å­—æŒ‡å®šçˆ¶ç±»ï¼Œåªæœ‰çŸ¥é“å¯¹æ–¹ä¿¡æ¯æ—¶æ‰èƒ½æŒ‡å‘å¯¹æ–¹æ–¹å‘ å®çº¿-ç»§æ‰¿ | è™šçº¿-å®ç° â€‹ ç©ºå¿ƒè±å½¢-èšåˆ å®å¿ƒè±å½¢-ç»„åˆ ç»„åˆå…³ç³»ä¸­å¸¸è§çš„æ•°å­—è¡¨è¾¾ 123456â—†å¸¸è§æ•°å­—è¡¨è¾¾åŠå«ä¹‰ï¼Œå‡è®¾æœ‰Aç±»å’ŒBç±»ï¼Œæ•°å­—æ ‡è®°åœ¨Aç±»ä¾§â—†0..1ï¼š0æˆ–1ä¸ªå®ä¾‹ åœ¨ç³»ç»ŸæŸä¸€æ—¶åˆ»ï¼Œbçš„å®ä¾‹å¯ä»¥ä¸0ä¸ªæˆ–1ä¸ªAå®ä¾‹ç›¸å…³â—†0..*ï¼š0æˆ–å¤šä¸ªå®ä¾‹ åœ¨ç³»ç»ŸæŸä¸€æ—¶åˆ»ï¼Œbçš„å®ä¾‹å¯ä»¥ä¸0ä¸ªæˆ–å¤šä¸ªAå®ä¾‹ç›¸å…³â—†1..1ï¼š1ä¸ªå®ä¾‹. bçš„å®ä¾‹å¯ä»¥å’Œ1ä¸ªAå®ä¾‹ç›¸å…³â—†1åªèƒ½æœ‰ä¸€ä¸ªå®ä¾‹. bçš„å®ä¾‹å¯ä»¥å’Œ1ä¸ªAå®ä¾‹ç›¸å…³â—†1..*ï¼šè‡³å°‘æœ‰ä¸€ä¸ªå®ä¾‹. bå®ä¾‹å¯ä»¥ä¸ä¸€ä¸ªæˆ–å¤šä¸ªAå®ä¾‹ç›¸å…³ UMLæ—¶åºå›¾ æ˜¯æ˜¾ç¤ºå¯¹è±¡ä¹‹é—´äº¤äº’çš„å›¾ï¼Œè¿™äº›å¯¹è±¡æ˜¯æŒ‰ç…§æ—¶é—´é¡ºåºæ’åˆ—çš„ æ—¶åºå›¾ä¸­ åŒ…å«çš„å»ºæ¨¡å…ƒç´  å¯¹è±¡ï¼ˆActorï¼‰ã€ç”Ÿå‘½çº¿ï¼ˆlifelineï¼‰ã€æ§åˆ¶ç„¦ç‚¹ï¼ˆFocus of controlï¼‰ã€æ¶ˆæ¯ï¼ˆMessageï¼‰ç­‰ æ—¶åºå›¾ç¤ºä¾‹ 12345678910111213ç«–çº¿ä»£è¡¨ç”Ÿå‘½çº¿å¯¹è±¡ï¼šcï¼šclient ï¼Œsï¼šserverï¼Œdï¼šdevice ä»£è¡¨å®ä¾‹æ¶ˆæ¯ï¼šç®­å¤´ä»£è¡¨çš„å…ƒç´ (open,workç­‰)ç«–çŸ©å½¢ä»£è¡¨å®ä¾‹å¤„äºæŸç§æ´»åŠ¨ä¸­ï¼Œå®çº¿å®å¿ƒç®­å¤´ï¼šä»£è¡¨æ–¹æ³•è°ƒç”¨ï¼ŒåŒæ­¥è°ƒç”¨å®çº¿éå®å¿ƒç®­å¤´ï¼šä»£è¡¨å¼‚æ­¥è°ƒç”¨è™šçº¿ï¼šä»£è¡¨è¿”å› UMLç±»å›¾è®²è§£123456789101112131415+ å…¬å…±æ–¹æ³•- privateæƒé™# protectedæƒé™ åŒ…å†…å’ŒåŒ…å¤–ç»§æ‰¿çš„å­ç±»éƒ½èƒ½å¼•ç”¨~ defaultæƒé™ï¼ˆåŒ…æƒé™ï¼‰åªæœ‰åŒ…å†…èƒ½å¼•ç”¨ä¸‹åˆ’çº¿ é™æ€ Staticæ–œä½“ æŠ½è±¡ç±»ï¼ˆæˆ–æŠ½è±¡æ–¹æ³•ï¼‰ï¼ˆåŒ…å«æŠ½è±¡æ–¹æ³•çš„å¿…æ˜¯æŠ½è±¡ç±»ï¼‰ï¼ˆç±»å’Œè‡³å°‘ä¸€ä¸ªæ–¹æ³•éƒ½æ˜¯æ–œä½“ï¼‰æ–¹æ³• å¯ä»¥å¸¦å‚ï¼Œå¯ä»¥ä¸å¸¦å‚ è¿”å›å€¼å†™åˆ°å†’å·åè¾¹ï¼Œvoidä¸ç”¨åŠ  UMLæ•´ä½“è®²è§£12345678910è®¾è®¡æ¨¡å¼ä¸­çš„å¯¹è±¡å…³ç³»: ä¾èµ–å…³ç³» è™šçº¿ç®­å¤´ï¼Œç®­å¤´æ–¹å‘æŒ‡å‘è¢«ä¾èµ–çš„éƒ¨åˆ† ç»„åˆå…³ç³» å®å¿ƒè±å½¢ èšåˆå…³ç³» ç©ºå¿ƒè±å½¢ï¼ˆæƒ³è±¡æˆç›˜å­ï¼Œç››ä¸œè¥¿ï¼Œç›˜å­çš„å¤šï¼Œå¦ä¸€æ–¹å°‘ï¼‰ å…³è”å…³ç³» å®çº¿ç®­å¤´ï¼Œç®­å¤´æŒ‡å‘è¢«å…³è”çš„éƒ¨åˆ† ç±»ä¸ç±»çš„è¿æ¥ï¼Œï¼ˆå®ƒä½¿ä¸€ä¸ªç±»çŸ¥é“å¦ä¸€ä¸ªç±»çš„å±æ€§å’Œæ–¹æ³•ï¼Œå…³è”å…³ ç³»ä¸€èˆ¬ç”¨æˆå‘˜å˜é‡å®ç°ï¼‰ ç»§æ‰¿ ç©ºå¿ƒä¸‰è§’å½¢å®çº¿ å®ç° ç©ºå¿ƒä¸‰è§’å½¢è™šçº¿æ³¨æ„ï¼š å®ç°æ¥å£æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯æ£’æ£’ç³–çš„å½¢å¼ï¼Œå¦ä¸€ç§æ˜¯è™šçº¿ç©ºå¿ƒä¸‰è§’å½¢çš„æ–¹å¼ UMLä¸­éƒ¨åˆ†å¯¹æ¯”1234567891.1 å…³è”å’Œä¾èµ–çš„å¯¹æ¯”å…³è”æ˜¯aç±»ä¸­å­˜åœ¨bç±»å¯¹è±¡ï¼Œä¼é¹…ç±»ä¸­æœ‰æ°”å€™ç±»çš„å±æ€§ä¾èµ–æ˜¯aç±»æˆå‘˜æ–¹æ³•ä¸­æœ‰bç±»çš„å±æ€§ï¼ŒåŠ¨ç‰©æ–°é™ˆä»£è°¢æ–¹æ³•ä¸­æœ‰æ°´å’Œç©ºæ°”çš„å±æ€§ï¼Œåªæœ‰è°ƒè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œæ‰å¯èƒ½ä¸´æ—¶ç”¨ä¸€ä¸‹1.2 ç»„åˆå’Œèšåˆçš„å¯¹æ¯”ç»„åˆæœ‰ç›¸åŒçš„ç”Ÿå‘½å‘¨æœŸï¼Œé¸Ÿæœ‰ç¿…è†€ï¼Œé¸Ÿæ­»äº†ï¼Œç¿…è†€ä¸å¤å­˜åœ¨å¤§é›ç¾¤æœ‰å¤§é›ï¼Œä¸€åªå¤§é›æŒ‚äº†ï¼Œå¤§é›ç¾¤ä¸ä¼šæ¶ˆå¤±1.3 ç»§æ‰¿å’Œå®ç°çš„å¯¹å®çº¿ï¼šç»§æ‰¿è™šçº¿ï¼šå®ç°","categories":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]}],"categories":[{"name":"Redis","slug":"Redis","permalink":"https://gentryhuang.com/categories/Redis/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/categories/RPC/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}],"tags":[{"name":"Redisæ•°æ®ç»“æ„","slug":"Redisæ•°æ®ç»“æ„","permalink":"https://gentryhuang.com/tags/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"},{"name":"JDK","slug":"JDK","permalink":"https://gentryhuang.com/tags/JDK/"},{"name":"Dubbo","slug":"Dubbo","permalink":"https://gentryhuang.com/tags/Dubbo/"},{"name":"Spring","slug":"Spring","permalink":"https://gentryhuang.com/tags/Spring/"},{"name":"Zookeeper","slug":"Zookeeper","permalink":"https://gentryhuang.com/tags/Zookeeper/"},{"name":"RPC","slug":"RPC","permalink":"https://gentryhuang.com/tags/RPC/"},{"name":"Javassist","slug":"Javassist","permalink":"https://gentryhuang.com/tags/Javassist/"},{"name":"SPI","slug":"SPI","permalink":"https://gentryhuang.com/tags/SPI/"},{"name":"è®¾è®¡æ¨¡å¼","slug":"è®¾è®¡æ¨¡å¼","permalink":"https://gentryhuang.com/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"}]}