<!DOCTYPE html>
<html lang=zh>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
  <meta name="renderer" content="webkit">
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no,email=no,adress=no">
  <!-- Color theme for statusbar -->
  <meta name="theme-color" content="#000000" />
  <!-- 强制页面在当前窗口以独立页面显示,防止别人在框架里调用页面 -->
  <meta http-equiv="window-target" content="_top" />
  
  
  <title>Dubbo源码分析 - API和属性配置 | gentryhuang的博客</title>
  <meta name="description" content="前言我们通过 Dubbo URL统一模型 已经了解了Dubbo URL是Duboo的配置总线，贯穿整个Dubbo的生命周期。虽然Dubbo URL直接决定了Dubbo组件的角色并控制Dubbo的行为，但是Dubbo URL中的信息需要Dubbo的配置承对象来提供，而配置承载对象中的数据来源于多种配置和设置。 目前Dubbo框架同时支持4种配置方式：API硬编码配置、XML配置、注解配置、属性配置。">
<meta property="og:type" content="article">
<meta property="og:title" content="Dubbo源码分析 - API和属性配置">
<meta property="og:url" content="https://gentryhuang.com/posts/1d3295e6/index.html">
<meta property="og:site_name" content="gentryhuang‘s blog">
<meta property="og:description" content="前言我们通过 Dubbo URL统一模型 已经了解了Dubbo URL是Duboo的配置总线，贯穿整个Dubbo的生命周期。虽然Dubbo URL直接决定了Dubbo组件的角色并控制Dubbo的行为，但是Dubbo URL中的信息需要Dubbo的配置承对象来提供，而配置承载对象中的数据来源于多种配置和设置。 目前Dubbo框架同时支持4种配置方式：API硬编码配置、XML配置、注解配置、属性配置。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config.jpg">
<meta property="og:image" content="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config-detail.jpg">
<meta property="og:image" content="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config-uml.jpg">
<meta property="og:image" content="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config-uml-relation.png">
<meta property="article:published_time" content="2020-03-24T16:00:00.000Z">
<meta property="article:modified_time" content="2021-11-19T06:32:41.549Z">
<meta property="article:author" content="gentryhuang">
<meta property="article:tag" content="Dubbo">
<meta property="article:tag" content="RPC">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config.jpg">
  <!-- Canonical links -->
  <link rel="canonical" href="https://gentryhuang.com/posts/1d3295e6/index.html">
  
    <link rel="alternate" href="/atom.xml" title="gentryhuang‘s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png" type="image/x-icon">
  
  
<link rel="stylesheet" href="/css/style.css">

  
  
  
    <link href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.css" rel="stylesheet">
  
  
<meta name="generator" content="Hexo 4.2.1"></head>


<body class="main-center" itemscope itemtype="http://schema.org/WebPage">
  <header class="header" itemscope itemtype="http://schema.org/WPHeader">
  <div class="slimContent">
    <div class="navbar-header">
      
      
      <div class="profile-block text-center">
        <a id="avatar" href="https://gentryhuang.com" target="_blank">
          <img class="img-circle img-rotate" src="/images/avatar.jpeg" width="200" height="200">
        </a>
        <h2 id="name" class="hidden-xs hidden-sm">Gentryhuang&#39;s Blog</h2>
        <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
        <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Hangzhou, China</small>
      </div>
      
      <div class="search" id="search-form-wrap">

    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i class="icon icon-search"></i></button>
            </span>
        </div>
    </form>
    <div class="ins-search">
  <div class="ins-search-mask"></div>
  <div class="ins-search-container">
    <div class="ins-input-wrapper">
      <input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech />
      <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
    </div>
    <div class="ins-section-wrapper">
      <div class="ins-section-container"></div>
    </div>
  </div>
</div>


</div>
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
      <ul class="nav navbar-nav main-nav menu-highlight">
        
        
        <li class="menu-item menu-item-home">
          <a href="/.">
            
            <i class="icon icon-home-fill"></i>
            
            <span class="menu-title">首页</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives">
            
            <i class="icon icon-archives-fill"></i>
            
            <span class="menu-title">归档</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories">
            
            <i class="icon icon-folder"></i>
            
            <span class="menu-title">分类</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags">
            
            <i class="icon icon-tags"></i>
            
            <span class="menu-title">标签</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-repository">
          <a href="/repository">
            
            <i class="icon icon-project"></i>
            
            <span class="menu-title">项目</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-links">
          <a href="/links">
            
            <i class="icon icon-friendship"></i>
            
            <span class="menu-title">友链</span>
          </a>
        </li>
        
        
        <li class="menu-item menu-item-about">
          <a href="/about">
            
            <i class="icon icon-cup-fill"></i>
            
            <span class="menu-title">关于</span>
          </a>
        </li>
        
      </ul>
      
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/gentryhuang" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    </nav>
  </div>
</header>

  
    <aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      

<script defer="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">

            

            <div class="content">
                <p>欢迎交流与分享经验!</p>
            </div>
        </div>
    </div>
</div>

    
      
  <div class="widget">
    <h3 class="widget-title">分类</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/JDK/">JDK</a><span class="category-list-count">15</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/RPC/">RPC</a><span class="category-list-count">66</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6/">任务调度</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/">网络通信</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">32</span></li></ul>
    </div>
  </div>


    
      
<!-- 这里使用 false 关闭右侧标签  -->






    
      
  <div class="widget">
    <h3 class="widget-title">标签云</h3>
    <div class="widget-body tagcloud">
      <a href="/tags/AQS/" style="font-size: 13.38px;">AQS</a> <a href="/tags/ConcurrentHashMap/" style="font-size: 13px;">ConcurrentHashMap</a> <a href="/tags/CopyOnWrite/" style="font-size: 13px;">CopyOnWrite</a> <a href="/tags/Dubbo/" style="font-size: 14px;">Dubbo</a> <a href="/tags/Filter/" style="font-size: 13.75px;">Filter</a> <a href="/tags/Gossip/" style="font-size: 13px;">Gossip</a> <a href="/tags/HashMap/" style="font-size: 13px;">HashMap</a> <a href="/tags/HashedWheelTimer/" style="font-size: 13px;">HashedWheelTimer</a> <a href="/tags/I-O/" style="font-size: 13.13px;">I/O</a> <a href="/tags/JMM/" style="font-size: 13px;">JMM</a> <a href="/tags/JUC/" style="font-size: 13.5px;">JUC</a> <a href="/tags/Javassist/" style="font-size: 13.25px;">Javassist</a> <a href="/tags/Lock/" style="font-size: 13.13px;">Lock</a> <a href="/tags/Mina/" style="font-size: 13px;">Mina</a> <a href="/tags/Netty/" style="font-size: 13px;">Netty</a> <a href="/tags/Protocol/" style="font-size: 13.25px;">Protocol</a> <a href="/tags/RPC/" style="font-size: 13.63px;">RPC</a> <a href="/tags/Raft/" style="font-size: 13px;">Raft</a> <a href="/tags/Redis/" style="font-size: 13px;">Redis</a> <a href="/tags/Redis%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 13.13px;">Redis数据结构</a> <a href="/tags/SPI/" style="font-size: 13.25px;">SPI</a> <a href="/tags/Spring/" style="font-size: 13.25px;">Spring</a> <a href="/tags/Thread/" style="font-size: 13.13px;">Thread</a> <a href="/tags/Zookeeper/" style="font-size: 13.13px;">Zookeeper</a> <a href="/tags/%E4%BB%A3%E7%90%86/" style="font-size: 13px;">代理</a> <a href="/tags/%E5%85%B1%E8%AF%86%E7%AE%97%E6%B3%95/" style="font-size: 13px;">共识算法</a> <a href="/tags/%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97/" style="font-size: 13px;">慢查询日志</a> <a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 13px;">缓存</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 13.88px;">设计模式</a>
    </div>
  </div>

    
      <!-- 这里使用 false 关闭右侧归档  -->




    
      
  <div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
      <ul class="recent-post-list list-unstyled ">
        
          <li>
            
            <div class="item-thumb">
              <a href="/posts/11b0627b/" class="thumb">
    
    
        <span class="thumb-image thumb-none"></span>
    
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/JDK/">JDK</a>
              </p>
              <p class="item-title">
                <a href="/posts/11b0627b/" class="title">并发 - JMM</a>
              </p>
              <p class="item-date">
                <time datetime="2021-09-20T01:14:12.000Z" itemprop="datePublished">2021-09-20</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-thumb">
              <a href="/posts/ae5dbc38/" class="thumb">
    
    
        <span class="thumb-image thumb-none"></span>
    
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1/">网络通信</a>
              </p>
              <p class="item-title">
                <a href="/posts/ae5dbc38/" class="title">网络通信 - Reactor模型</a>
              </p>
              <p class="item-date">
                <time datetime="2021-09-12T13:10:23.000Z" itemprop="datePublished">2021-09-12</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-thumb">
              <a href="/posts/151f44ae/" class="thumb">
    
    
        <span class="thumb-image thumb-none"></span>
    
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/JDK/">JDK</a>
              </p>
              <p class="item-title">
                <a href="/posts/151f44ae/" class="title">并发 - ThreadLocal</a>
              </p>
              <p class="item-date">
                <time datetime="2021-09-03T04:30:12.000Z" itemprop="datePublished">2021-09-03</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-thumb">
              <a href="/posts/55ae5a2b/" class="thumb">
    
    
        <span class="thumb-image thumb-none"></span>
    
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/JDK/">JDK</a>
              </p>
              <p class="item-title">
                <a href="/posts/55ae5a2b/" class="title">Java基础 - Reference</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-21T02:30:12.000Z" itemprop="datePublished">2021-08-21</time>
              </p>
            </div>
          </li>
          
          <li>
            
            <div class="item-thumb">
              <a href="/posts/dbdf391f/" class="thumb">
    
    
        <span class="thumb-image thumb-none"></span>
    
</a>

            </div>
            
            <div class="item-inner">
              <p class="item-category">
                <a class="category-link" href="/categories/JDK/">JDK</a>
              </p>
              <p class="item-title">
                <a href="/posts/dbdf391f/" class="title">并发 - Thread</a>
              </p>
              <p class="item-date">
                <time datetime="2021-08-14T13:50:21.000Z" itemprop="datePublished">2021-08-14</time>
              </p>
            </div>
          </li>
          
      </ul>
    </div>
  </div>
  

    
  </div>
</aside>

  
  
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <nav id="toc" class="article-toc">
      <h3 class="toc-title">文章目录</h3>
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置承载对象"><span class="toc-number">2.</span> <span class="toc-text">配置承载对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractConfig-抽象配置类"><span class="toc-number">2.1.</span> <span class="toc-text">AbstractConfig 抽象配置类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#格式校验"><span class="toc-number">2.1.1.</span> <span class="toc-text">格式校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加属性（属性和系统参数配置）"><span class="toc-number">2.1.2.</span> <span class="toc-text">添加属性（属性和系统参数配置）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#配置对象的属性到参数集合"><span class="toc-number">2.1.3.</span> <span class="toc-text">配置对象的属性到参数集合</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加事件通知属性"><span class="toc-number">2.1.4.</span> <span class="toc-text">添加事件通知属性</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AbstractInterfaceConfig-抽象配置类"><span class="toc-number">2.2.</span> <span class="toc-text">AbstractInterfaceConfig 抽象配置类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#校验注册中心配置"><span class="toc-number">2.2.1.</span> <span class="toc-text">校验注册中心配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#校验应用配置"><span class="toc-number">2.2.2.</span> <span class="toc-text">校验应用配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#加载注册中心URL数组"><span class="toc-number">2.2.3.</span> <span class="toc-text">加载注册中心URL数组</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#加载监控中心URL"><span class="toc-number">2.2.4.</span> <span class="toc-text">加载监控中心URL</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#校验接口和方法列表"><span class="toc-number">2.2.5.</span> <span class="toc-text">校验接口和方法列表</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#校验Stub和Mock相关的配置"><span class="toc-number">2.2.6.</span> <span class="toc-text">校验Stub和Mock相关的配置</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ServiceConfig-配置类"><span class="toc-number">2.3.</span> <span class="toc-text">ServiceConfig 配置类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ServiceConfig-属性"><span class="toc-number">2.3.1.</span> <span class="toc-text">ServiceConfig 属性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#进一步初始化配置承载对象"><span class="toc-number">2.3.2.</span> <span class="toc-text">进一步初始化配置承载对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#多协议多注册中心"><span class="toc-number">2.3.3.</span> <span class="toc-text">多协议多注册中心</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReferenceConfig-配置类"><span class="toc-number">2.4.</span> <span class="toc-text">ReferenceConfig 配置类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#ReferenceConfig-属性"><span class="toc-number">2.4.1.</span> <span class="toc-text">ReferenceConfig 属性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#进一步初始化配置承载对象-1"><span class="toc-number">2.4.2.</span> <span class="toc-text">进一步初始化配置承载对象</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其它配置类"><span class="toc-number">2.5.</span> <span class="toc-text">其它配置类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li></ol>
    </nav>
  </div>
</aside>

<main class="main" role="main">
  <div class="content">
  <article id="post-rpc/API配置" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      
        
  
    <h1 class="article-title" itemprop="name">
      Dubbo源码分析 - API和属性配置
    </h1>
  

      
      <div class="article-meta">
        <span class="article-date">
    <i class="icon icon-calendar-check"></i>
	<a href="/posts/1d3295e6/" class="article-date">
	  <time datetime="2020-03-24T16:00:00.000Z" itemprop="datePublished">2020-03-25</time>
	</a>
</span>
        
  <span class="article-category">
    <i class="icon icon-folder"></i>
    <a class="article-category-link" href="/categories/RPC/">RPC</a>
  </span>

        
  <span class="article-tag">
    <i class="icon icon-tags"></i>
	<a class="article-tag-link" href="/tags/Dubbo/" rel="tag">Dubbo</a>, <a class="article-tag-link" href="/tags/RPC/" rel="tag">RPC</a>
  </span>


        

        <span class="post-comment"><i class="icon icon-comment"></i> <a href="/posts/1d3295e6/#comments" class="article-comment-link">评论</a></span>
        
	
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 11k(字)</span>
	
	
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 51(分)</span>
	

      </div>
    </div>
    <div class="article-entry marked-body" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>我们通过 <a href="https://gentryhuang.com/posts/46f95e97/">Dubbo URL统一模型</a> 已经了解了Dubbo URL是Duboo的配置总线，贯穿整个Dubbo的生命周期。虽然Dubbo URL直接决定了Dubbo组件的角色并控制Dubbo的行为，但是Dubbo URL中的信息需要Dubbo的配置承对象来提供，而配置承载对象中的数据来源于多种配置和设置。<br><img src="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config.jpg" alt></p>
<p>目前Dubbo框架同时支持4种配置方式：API硬编码配置、XML配置、注解配置、属性配置。而所有的配置项分为三大类:</p>
<ul>
<li>服务注册和发现：表示该配置项用于服务的注册和发现。</li>
<li>服务治理：表示该配置项用于治理服务间的关系，或为开发测试提供便利条件。</li>
<li>性能调优：表示该配置项用于调优性能，不同的选项对性能会产生影响。</li>
</ul>
<p>注意：所有配置最终都会转换为Dubbo URL</p>
<h3 id="配置承载对象"><a href="#配置承载对象" class="headerlink" title="配置承载对象"></a>配置承载对象</h3><p>不管是注解还是XML配置都需要配置对象来承载，XML配置、注解配置、属性配置都是和配置对象或其属性相映射的，为什么这里没有说API配置和配置对象的映射关系呢？其实API配置就是直接操作配置对象，而XML配置和注解配置都是由Spring来创建配置对象并设置属性的，而我们的属性配置是在配置对象已经存在的基础上，为其设置指定的属性值。下面是Dubbo的属性配置类的结构：<br><br></p>
<p><img src="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config-detail.jpg" alt></p>
<p>上图中我使用了黄色框和红色框分别对抽象配置类和配置实现类进行了标注，其中DubboShutdownHook先忽略。红色框中的配置类是直接的配置承载类，黄色框中的抽象配置类是配置承载类的父类。下面是配置承载类的UML图：</p>
<ul>
<li>直观图</li>
</ul>
<p><img src="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config-uml.jpg" alt></p>
<ul>
<li>依赖关系图</li>
</ul>
<p><img src="https://blog-picture-oss.oss-cn-hangzhou.aliyuncs.com/rpc/dubbo-config-uml-relation.png" alt></p>
<p>通过上面的关系图我们可以很清楚地了解到每个配置之间的关系，我们接下来就顺着关系图分别介绍核心的配置类。</p>
<h4 id="AbstractConfig-抽象配置类"><a href="#AbstractConfig-抽象配置类" class="headerlink" title="AbstractConfig 抽象配置类"></a>AbstractConfig 抽象配置类</h4><p>除了ArgumentConfig配置类，几乎其他的所有配置类都直接或间接继承该类，该类主要提供配置解析与校验相关的工具方法。</p>
<h5 id="格式校验"><a href="#格式校验" class="headerlink" title="格式校验"></a>格式校验</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConfig</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//-------------------------- 格式检验 -----------------------------/</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_LENGTH = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_PATH_LENGTH = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_NAME = Pattern.compile(<span class="string">"[\\-._0-9a-zA-Z]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_MULTI_NAME = Pattern.compile(<span class="string">"[,\\-._0-9a-zA-Z]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_METHOD_NAME = Pattern.compile(<span class="string">"[a-zA-Z][0-9a-zA-Z]*"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_PATH = Pattern.compile(<span class="string">"[/\\-$._0-9a-zA-Z]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_NAME_HAS_SYMBOL = Pattern.compile(<span class="string">"[:*,/\\-._0-9a-zA-Z]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PATTERN_KEY = Pattern.compile(<span class="string">"[*,\\-._0-9a-zA-Z]+"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkExtension</span><span class="params">(Class&lt;?&gt; type, String property, String value)</span> </span>&#123;</span><br><span class="line">            checkName(property, value);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span></span><br><span class="line">                    &amp;&amp; !ExtensionLoader.getExtensionLoader(type).hasExtension(value)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such extension "</span> + value + <span class="string">" for "</span> + property + <span class="string">"/"</span> + type.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkMultiExtension</span><span class="params">(Class&lt;?&gt; type, String property, String value)</span> </span>&#123;</span><br><span class="line">            checkMultiName(property, value);</span><br><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                String[] values = value.split(<span class="string">"\\s*[,]+\\s*"</span>);</span><br><span class="line">                <span class="keyword">for</span> (String v : values) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (v.startsWith(Constants.REMOVE_VALUE_PREFIX)) &#123;</span><br><span class="line">                        v = v.substring(<span class="number">1</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (Constants.DEFAULT_KEY.equals(v)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (!ExtensionLoader.getExtensionLoader(type).hasExtension(v)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such extension "</span> + v + <span class="string">" for "</span> + property + <span class="string">"/"</span> + type.getName());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkLength</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_LENGTH, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPathLength</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_PATH_LENGTH, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkName</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_LENGTH, PATTERN_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkNameHasSymbol</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_LENGTH, PATTERN_NAME_HAS_SYMBOL);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkKey</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_LENGTH, PATTERN_KEY);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkMultiName</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_LENGTH, PATTERN_MULTI_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPathName</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_PATH_LENGTH, PATTERN_PATH);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkMethodName</span><span class="params">(String property, String value)</span> </span>&#123;</span><br><span class="line">            checkProperty(property, value, MAX_LENGTH, PATTERN_METHOD_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkParameterName</span><span class="params">(Map&lt;String, String&gt; parameters)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (parameters == <span class="keyword">null</span> || parameters.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : parameters.entrySet()) &#123;</span><br><span class="line">                checkNameHasSymbol(entry.getKey(), entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkProperty</span><span class="params">(String property, String value, <span class="keyword">int</span> maxlength, Pattern pattern)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (value.length() &gt; maxlength) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid "</span> + property + <span class="string">"=\""</span> + value + <span class="string">"\" is longer than "</span> + maxlength);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (pattern != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Matcher matcher = pattern.matcher(value);</span><br><span class="line">                <span class="keyword">if</span> (!matcher.matches()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid "</span> + property + <span class="string">"=\""</span> + value + <span class="string">"\" contains illegal "</span> +</span><br><span class="line">                            <span class="string">"character, only digit, letter, '-', '_' or '.' is legal."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AbstractConfig的子类会调用这里的方法进行相关的参数校验。</p>
<h5 id="添加属性（属性和系统参数配置）"><a href="#添加属性（属性和系统参数配置）" class="headerlink" title="添加属性（属性和系统参数配置）"></a>添加属性（属性和系统参数配置）</h5><p>读取启动参数变量和Properties配置文件中属性到配置承载对象中，该方法其实就是<code>属性配置</code> 和 <code>系统参数配置</code>的逻辑。这个逻辑非常重要，无论是API配置还是XML配置，以及注解配置，都会使用该逻辑为配置承载对象设置系统参数值以及配置属性值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConfig</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1 id 属性，Bean定义的名称，适用于除了API配置之外的三种配置（属性配置，xml配置,注解配置）方式，可用于对象之间的引用</span></span><br><span class="line"><span class="comment">     * 2 不适用API配置，是因为API配置直接setter(xxx)对象即可</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> String id;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取带有配置项名前缀的启动参数变量和properties配置到 配置承载对象中。</span></span><br><span class="line"><span class="comment">     * 说明：在此之前配置承载对象中只可能有xml配置的属性值，或者注解配置的属性值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> config 配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendProperties</span><span class="params">(AbstractConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获得配置项前缀（使用配置类的类名，获得对应的属性标签）-&gt; dubbo.tag.</span></span><br><span class="line">        String prefix = <span class="string">"dubbo."</span> + getTagName(config.getClass()) + <span class="string">"."</span>;</span><br><span class="line">        <span class="comment">// 获得配置类的所有方法，用于下面通过反射获得配置项的属性名，再用属性名去读取启动参数变量和.properties配置到配置对象</span></span><br><span class="line">        Method[] methods = config.getClass().getMethods();</span><br><span class="line">        <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 拿到方法名</span></span><br><span class="line">                String name = method.getName();</span><br><span class="line">                <span class="comment">// 选择方法是 【public &amp;&amp; setter &amp;&amp; 唯一参数为基本类型】 的方法</span></span><br><span class="line">                <span class="keyword">if</span> (name.length() &gt; <span class="number">3</span> &amp;&amp; name.startsWith(<span class="string">"set"</span>) &amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">                        &amp;&amp; method.getParameterTypes().length == <span class="number">1</span> &amp;&amp; isPrimitive(method.getParameterTypes()[<span class="number">0</span>])) &#123;</span><br><span class="line">                    <span class="comment">// 获得属性名 如： ApplicationConfig#setName(...) 方法，对应的属性名为 name</span></span><br><span class="line">                    String property = StringUtils.camelToSplitName(name.substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + name.substring(<span class="number">4</span>), <span class="string">"."</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//----------- 读取的覆盖策略： JVM -D &gt; XML &gt; .properties   ----------/</span></span><br><span class="line"></span><br><span class="line">                    String value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//【启动参数变量】优先从带有 id属性的XxxConfig的配置中获取，例如 dubbo.application.demo-provider.name</span></span><br><span class="line">                    <span class="keyword">if</span> (config.getId() != <span class="keyword">null</span> &amp;&amp; config.getId().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// id字段</span></span><br><span class="line">                        String pn = prefix + config.getId() + <span class="string">"."</span> + property;</span><br><span class="line">                        value = System.getProperty(pn);</span><br><span class="line">                        <span class="keyword">if</span> (!StringUtils.isBlank(value)) &#123;</span><br><span class="line">                            logger.info(<span class="string">"Use System Property "</span> + pn + <span class="string">" to config dubbo"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">//【启动参数变量】获取不到，再从不带 id属性 的XxxConfig的配置中获取，例如：dubbo.application.name</span></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// 没有id字段</span></span><br><span class="line">                        String pn = prefix + property;</span><br><span class="line">                        value = System.getProperty(pn);</span><br><span class="line">                        <span class="keyword">if</span> (!StringUtils.isBlank(value)) &#123;</span><br><span class="line">                            logger.info(<span class="string">"Use System Property "</span> + pn + <span class="string">" to config dubbo"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 配置优先级以及覆盖： 启动参数变量 &gt; XML配置[注解/java配置] &gt; properties配置 。因此需要使用getter判断XML是否已经配置</span></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                        Method getter;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            getter = config.getClass().getMethod(<span class="string">"get"</span> + name.substring(<span class="number">3</span>));</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                getter = config.getClass().getMethod(<span class="string">"is"</span> + name.substring(<span class="number">3</span>));</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (NoSuchMethodException e2) &#123;</span><br><span class="line">                                getter = <span class="keyword">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (getter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 使用getter 判断XML是否已经设置过，如果没有设置的话就从.properties文件中读取</span></span><br><span class="line">                            <span class="keyword">if</span> (getter.invoke(config) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// [properties配置] 优先从带有 id 属性的配置中获取，例如：dubbo.application.demo-provider.name</span></span><br><span class="line">                                <span class="keyword">if</span> (config.getId() != <span class="keyword">null</span> &amp;&amp; config.getId().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                    value = ConfigUtils.getProperty(prefix + config.getId() + <span class="string">"."</span> + property);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// [properties配置]获取不到，再从不带 id 属性的配置中获取，例如：dubbo.application.name</span></span><br><span class="line">                                <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                                    value = ConfigUtils.getProperty(prefix + property);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="comment">// [properties配置]获取不到，这里进行老版本兼容，从不带id属性的配置中获取</span></span><br><span class="line">                                <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                                    String legacyKey = legacyProperties.get(prefix + property);</span><br><span class="line">                                    <span class="keyword">if</span> (legacyKey != <span class="keyword">null</span> &amp;&amp; legacyKey.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                        value = convertLegacyValue(legacyKey, ConfigUtils.getProperty(legacyKey));</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 获取到值（系统参数配置或者.properties文件中的，不包含xml配置，xml配置有单独的设置方法）</span></span><br><span class="line">                    <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        method.invoke(config, convertPrimitive(method.getParameterTypes()[<span class="number">0</span>], value));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码主要就是为已经实例化好的配置承载对象设置属性值，主要逻辑如下：</p>
<ol>
<li>根据配置对象获取属性配置的前缀，如 dubbo.application.</li>
<li>遍历配置承载对象中的所有方法找到符合条件的setter方法</li>
<li>根据配置覆盖策略的优先级，设置配置承载对象的属性值</li>
</ol>
<h5 id="配置对象的属性到参数集合"><a href="#配置对象的属性到参数集合" class="headerlink" title="配置对象的属性到参数集合"></a>配置对象的属性到参数集合</h5><p>将配置承载对象的属性添加到参数集合中，用于构建Dubbo URL，如在服务暴露和引用是构建相关的URL。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConfig</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 将配置对象的属性添加到参数集合</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> parameters</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> config</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendParameters</span><span class="params">(Map&lt;String, String&gt; parameters, Object config)</span> </span>&#123;</span><br><span class="line">           appendParameters(parameters, config, <span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 将配置对象的属性添加到参数集合，主要逻辑：</span></span><br><span class="line"><span class="comment">        * &lt;p&gt;</span></span><br><span class="line"><span class="comment">        * 1 通过反射获取目标对象的getter方法，并调用该方法获取属性值，然后再通过getter方法名解析出属性名，如：从方法名getName中可解析出属性name，如果用户传入了属性名前缀，此时需要将属性名加入前缀内容。</span></span><br><span class="line"><span class="comment">        * 2 将 属性名-属性值 键值对存入到map中就可以了</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> parameters 参数集合，该集合会用于URL</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> config     配置对象</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> prefix     属性前缀。用于配置项添加到参数集合中时的前缀</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendParameters</span><span class="params">(Map&lt;String, String&gt; parameters, Object config, String prefix)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="comment">// 获得所有方法的数组，为下面通过反射获得配置项的值做准备</span></span><br><span class="line">           Method[] methods = config.getClass().getMethods();</span><br><span class="line">           <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   String name = method.getName();</span><br><span class="line">                   <span class="comment">// 选择方法为 返回值为基本类型 + public的getter/is方法 （和解析到配置类的过滤添加呼应）</span></span><br><span class="line">                   <span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"is"</span>))</span><br><span class="line">                           &amp;&amp; !<span class="string">"getClass"</span>.equals(name)</span><br><span class="line">                           &amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">                           &amp;&amp; method.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">                           &amp;&amp; isPrimitive(method.getReturnType())) &#123;</span><br><span class="line">                       <span class="comment">// 尝试获取方法上的@Parameter注解</span></span><br><span class="line">                       Parameter parameter = method.getAnnotation(Parameter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                       <span class="comment">// 方法返回类型是Object的或者方法的@Parameter(excluded = true)的， 不统计对应的值到参数集合</span></span><br><span class="line">                       <span class="keyword">if</span> (method.getReturnType() == Object<span class="class">.<span class="keyword">class</span> || <span class="title">parameter</span> !</span>= <span class="keyword">null</span> &amp;&amp; parameter.excluded()) &#123;</span><br><span class="line">                           <span class="keyword">continue</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">// 获得属性名</span></span><br><span class="line">                       <span class="keyword">int</span> i = name.startsWith(<span class="string">"get"</span>) ? <span class="number">3</span> : <span class="number">2</span>;</span><br><span class="line">                       String prop = StringUtils.camelToSplitName(name.substring(i, i + <span class="number">1</span>).toLowerCase() + name.substring(i + <span class="number">1</span>), <span class="string">"."</span>);</span><br><span class="line">                       String key;</span><br><span class="line">                       <span class="comment">// @Parameter注解有配置key属性就取出该值</span></span><br><span class="line">                       <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.key().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                           key = parameter.key();</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           key = prop;</span><br><span class="line">                       &#125;</span><br><span class="line">   </span><br><span class="line">                       <span class="comment">// 利用反射获得属性的值</span></span><br><span class="line">                       Object value = method.invoke(config);</span><br><span class="line">                       String str = String.valueOf(value).trim();</span><br><span class="line">                       <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 是否转移，默认不转译</span></span><br><span class="line">                           <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.escaped()) &#123;</span><br><span class="line">                               str = URL.encode(str);</span><br><span class="line">                           &#125;</span><br><span class="line">   </span><br><span class="line">                           <span class="comment">// @Parameter注解有配置append属性，就进行拼接</span></span><br><span class="line">                           <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.append()) &#123;</span><br><span class="line">                               <span class="comment">// 1. 看参数集合中是否有key为： default.key的值(默认属性值),有就拼接到属性值前面</span></span><br><span class="line">                               String pre = parameters.get(Constants.DEFAULT_KEY + <span class="string">"."</span> + key);</span><br><span class="line">                               <span class="keyword">if</span> (pre != <span class="keyword">null</span> &amp;&amp; pre.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                   str = pre + <span class="string">","</span> + str;</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="comment">// 2. 看参数集合中是否有key对应的值，有就拼接到属性值前面</span></span><br><span class="line">                               pre = parameters.get(key);</span><br><span class="line">                               <span class="keyword">if</span> (pre != <span class="keyword">null</span> &amp;&amp; pre.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                   str = pre + <span class="string">","</span> + str;</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                           <span class="comment">// 如果指定了属性前缀就拼接上去，就在属性名前面加上前缀</span></span><br><span class="line">                           <span class="keyword">if</span> (prefix != <span class="keyword">null</span> &amp;&amp; prefix.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                               key = prefix + <span class="string">"."</span> + key;</span><br><span class="line">                           &#125;</span><br><span class="line">                           <span class="comment">// 把最后处理的属性值加入参数集合中</span></span><br><span class="line">                           parameters.put(key, str);</span><br><span class="line">                           <span class="comment">// 当配置对象的属性getter方法加了@Parameter(required=true)时，校验配置项非空</span></span><br><span class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.required()) &#123;</span><br><span class="line">                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(config.getClass().getSimpleName() + <span class="string">"."</span> + key + <span class="string">" == null"</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">// 当方法为public Map getParameters()&#123;...&#125;时，就以此将Map中的key-value加入到参数集合</span></span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"getParameters"</span>.equals(name)</span><br><span class="line">                           &amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">                           &amp;&amp; method.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">                           &amp;&amp; method.getReturnType() == Map<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                       <span class="comment">// 通过 getParameters()方法，获取动态设置的配置项</span></span><br><span class="line">                       Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) method.invoke(config, <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">                       <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                           String pre = (prefix != <span class="keyword">null</span> &amp;&amp; prefix.length() &gt; <span class="number">0</span> ? prefix + <span class="string">"."</span> : <span class="string">""</span>);</span><br><span class="line">                           <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">                               parameters.put(pre + entry.getKey().replace(<span class="string">'-'</span>, <span class="string">'.'</span>), entry.getValue());</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码主要就是将配置承载对象中的属性设置到属性集合Map中，用于构建Dubbo URL。整个逻辑需要注意，配置承载对象的getter方法上标注的 <code>@Parameter</code> 注解，以及配置承载对象的getParameters方法。</p>
<h5 id="添加事件通知属性"><a href="#添加事件通知属性" class="headerlink" title="添加事件通知属性"></a>添加事件通知属性</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractConfig</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendAttributes</span><span class="params">(Map&lt;Object, Object&gt; parameters, Object config)</span> </span>&#123;</span><br><span class="line">           appendAttributes(parameters, config, <span class="keyword">null</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> parameters 参数集合</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> config     配置对象</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> prefix     属性前缀。用于配置项添加到参数集合中时的前缀</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendAttributes</span><span class="params">(Map&lt;Object, Object&gt; parameters, Object config, String prefix)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">if</span> (config == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           Method[] methods = config.getClass().getMethods();</span><br><span class="line">           <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   String name = method.getName();</span><br><span class="line">                   <span class="comment">// 选择方法为 返回值为基本类型 + public的getter/is方法 （和解析到配置类的过滤添加呼应）</span></span><br><span class="line">                   <span class="keyword">if</span> ((name.startsWith(<span class="string">"get"</span>) || name.startsWith(<span class="string">"is"</span>))</span><br><span class="line">                           &amp;&amp; !<span class="string">"getClass"</span>.equals(name)</span><br><span class="line">                           &amp;&amp; Modifier.isPublic(method.getModifiers())</span><br><span class="line">                           &amp;&amp; method.getParameterTypes().length == <span class="number">0</span></span><br><span class="line">                           &amp;&amp; isPrimitive(method.getReturnType())) &#123;</span><br><span class="line"></span><br><span class="line">                       <span class="comment">// 选择带有@Parameter(attribute=true)的方法</span></span><br><span class="line">                       Parameter parameter = method.getAnnotation(Parameter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                       <span class="keyword">if</span> (parameter == <span class="keyword">null</span> || !parameter.attribute()) &#123;</span><br><span class="line">                           <span class="keyword">continue</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       String key;</span><br><span class="line">                       parameter.key();</span><br><span class="line">                       <span class="keyword">if</span> (parameter.key().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                           key = parameter.key();</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           <span class="keyword">int</span> i = name.startsWith(<span class="string">"get"</span>) ? <span class="number">3</span> : <span class="number">2</span>;</span><br><span class="line">                           key = name.substring(i, i + <span class="number">1</span>).toLowerCase() + name.substring(i + <span class="number">1</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="comment">// 获得属性值，存在则添加到参数集合中</span></span><br><span class="line">                       Object value = method.invoke(config);</span><br><span class="line">                       <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (prefix != <span class="keyword">null</span> &amp;&amp; prefix.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                               key = prefix + <span class="string">"."</span> + key;</span><br><span class="line">                           &#125;</span><br><span class="line">                           parameters.put(key, value);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码主要用于Dubbo的事件通知的，具体是标注在MethodConfig配置承载对象的 getOnreturn(),getOnreturnMethod(),getOnthrow()…方法上。</p>
<h4 id="AbstractInterfaceConfig-抽象配置类"><a href="#AbstractInterfaceConfig-抽象配置类" class="headerlink" title="AbstractInterfaceConfig 抽象配置类"></a>AbstractInterfaceConfig 抽象配置类</h4><p>继承关系如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AbstractConfig</span><br><span class="line">  - AbstractMethodConfig</span><br><span class="line">    - AbstractInterfaceConfig</span><br></pre></td></tr></table></figure>
<p>AbstractConfig抽象类的核心逻辑已经分析过，AbstractMethodConfig抽象类中没有比较重要的逻辑，基本都是 <code>配置属性的设置/获取方法</code>，就不再分析，接下来我们一起看下AbstractInterfaceConfig抽象类的逻辑。</p>
<h5 id="校验注册中心配置"><a href="#校验注册中心配置" class="headerlink" title="校验注册中心配置"></a>校验注册中心配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInterfaceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMethodConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// for backward compatibility</span></span><br><span class="line">        <span class="keyword">if</span> (registries == <span class="keyword">null</span> || registries.isEmpty()) &#123;</span><br><span class="line">            String address = ConfigUtils.getProperty(<span class="string">"dubbo.registry.address"</span>);</span><br><span class="line">            <span class="keyword">if</span> (address != <span class="keyword">null</span> &amp;&amp; address.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                registries = <span class="keyword">new</span> ArrayList&lt;RegistryConfig&gt;();</span><br><span class="line">                String[] as = address.split(<span class="string">"\\s*[|]+\\s*"</span>);</span><br><span class="line">                <span class="keyword">for</span> (String a : as) &#123;</span><br><span class="line">                    RegistryConfig registryConfig = <span class="keyword">new</span> RegistryConfig();</span><br><span class="line">                    registryConfig.setAddress(a);</span><br><span class="line">                    registries.add(registryConfig);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((registries == <span class="keyword">null</span> || registries.isEmpty())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException((getClass().getSimpleName().startsWith(<span class="string">"Reference"</span>)</span><br><span class="line">                    ? <span class="string">"No such any registry to refer service in consumer "</span></span><br><span class="line">                    : <span class="string">"No such any registry to export service in provider "</span>)</span><br><span class="line">                    + NetUtils.getLocalHost()</span><br><span class="line">                    + <span class="string">" use dubbo version "</span></span><br><span class="line">                    + Version.getVersion()</span><br><span class="line">                    + <span class="string">", Please add &lt;dubbo:registry address=\"...\" /&gt; to your spring config. If you want unregister, please set &lt;dubbo:service registry=\"N/A\" /&gt;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (RegistryConfig registryConfig : registries) &#123;</span><br><span class="line">            <span class="comment">// 调用AbstractConfig中的方法</span></span><br><span class="line">            appendProperties(registryConfig);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="校验应用配置"><a href="#校验应用配置" class="headerlink" title="校验应用配置"></a>校验应用配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInterfaceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMethodConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// for backward compatibility</span></span><br><span class="line">        <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">            String applicationName = ConfigUtils.getProperty(<span class="string">"dubbo.application.name"</span>);</span><br><span class="line">            <span class="keyword">if</span> (applicationName != <span class="keyword">null</span> &amp;&amp; applicationName.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                application = <span class="keyword">new</span> ApplicationConfig();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">                    <span class="string">"No such application config! Please add &lt;dubbo:application name=\"...\" /&gt; to your spring config."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 调用AbstractConfig中的方法</span></span><br><span class="line">        appendProperties(application);</span><br><span class="line"></span><br><span class="line">        String wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_KEY);</span><br><span class="line">        <span class="keyword">if</span> (wait != <span class="keyword">null</span> &amp;&amp; wait.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            System.setProperty(Constants.SHUTDOWN_WAIT_KEY, wait.trim());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wait = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY);</span><br><span class="line">            <span class="keyword">if</span> (wait != <span class="keyword">null</span> &amp;&amp; wait.trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                System.setProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY, wait.trim());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加载注册中心URL数组"><a href="#加载注册中心URL数组" class="headerlink" title="加载注册中心URL数组"></a>加载注册中心URL数组</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInterfaceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMethodConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 加载注册中心URL数组</span></span><br><span class="line"><span class="comment">      *</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> provider 是否是服务提供者</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span> URL数组</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">protected</span> List&lt;URL&gt; <span class="title">loadRegistries</span><span class="params">(<span class="keyword">boolean</span> provider)</span> </span>&#123;</span><br><span class="line">         <span class="comment">// 校验RegistryConfig 配置数组，不存在会抛出异常，并且该方法会初始化RegistryConfig的配置属性</span></span><br><span class="line">         checkRegistry();</span><br><span class="line">         <span class="comment">// 创建注册中心URL数组</span></span><br><span class="line">         List&lt;URL&gt; registryList = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">         <span class="keyword">if</span> (registries != <span class="keyword">null</span> &amp;&amp; !registries.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">             <span class="comment">// 遍历RegistryConfig 数组，因为 Dubbo 支持多注册中心</span></span><br><span class="line">             <span class="keyword">for</span> (RegistryConfig config : registries) &#123;</span><br><span class="line">                 <span class="comment">// 获取注册中心的地址</span></span><br><span class="line">                 String address = config.getAddress();</span><br><span class="line">                 <span class="comment">// 地址为空就使用 0.0.0.0 任意地址</span></span><br><span class="line">                 <span class="keyword">if</span> (address == <span class="keyword">null</span> || address.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                     address = Constants.ANYHOST_VALUE;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">// 如果配置了启动参数的注册中心地址，它的优先级最高，就进行覆盖</span></span><br><span class="line">                 String sysaddress = System.getProperty(<span class="string">"dubbo.registry.address"</span>);</span><br><span class="line">                 <span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                     address = sysaddress;</span><br><span class="line">                 &#125;</span><br><span class="line"> </span><br><span class="line">                 <span class="comment">// 选择有效的注册中心地址</span></span><br><span class="line">                 <span class="keyword">if</span> (address.length() &gt; <span class="number">0</span> &amp;&amp; !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) &#123;</span><br><span class="line"> </span><br><span class="line">                     <span class="comment">// 创建参数集合map,用于Dubbo URL的构建</span></span><br><span class="line">                     Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line"> </span><br><span class="line">                     <span class="comment">// 将应用配置对象和注册中心配置对象的属性添加到参数集合map中</span></span><br><span class="line">                     appendParameters(map, application);</span><br><span class="line">                     <span class="comment">/**</span></span><br><span class="line"><span class="comment">                      * 需要注意的是：RegistryConfig 的 getAddress方法上使用了 <span class="doctag">@Parameter</span>(excluded = true)注解，因此它的address属性不会加入到参数集合map中</span></span><br><span class="line"><span class="comment">                      *  <span class="doctag">@Parameter</span>(excluded = true)</span></span><br><span class="line"><span class="comment">                      *  public String getAddress() &#123;return address;&#125;</span></span><br><span class="line"><span class="comment">                      */</span></span><br><span class="line">                     appendParameters(map, config);</span><br><span class="line"> </span><br><span class="line">                     <span class="comment">// 添加 path,dubbo,timestamp,pid 到参数集合map中</span></span><br><span class="line">                     map.put(<span class="string">"path"</span>, RegistryService<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>; <span class="comment">// 这里的path要和服务暴露逻辑中的path区分，注册中心的URL中的path为RegistryService的全路径名</span></span><br><span class="line">                     map.put(<span class="string">"dubbo"</span>, Version.getProtocolVersion());</span><br><span class="line">                     map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">                     <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                         map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">                     &#125;</span><br><span class="line"> </span><br><span class="line">                     <span class="comment">// 参数集合map中不存在 protocol 参数【以上配置对象的属性中没有有效的协议protocol参数】，就默认 使用 dubbo 作为 协议protocol的值</span></span><br><span class="line">                     <span class="keyword">if</span> (!map.containsKey(<span class="string">"protocol"</span>)) &#123;</span><br><span class="line">                         <span class="comment">// 不需考虑remote扩展实现的情况</span></span><br><span class="line">                         if (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension("remote")) &#123;</span><br><span class="line">                             map.put(<span class="string">"protocol"</span>, <span class="string">"remote"</span>);</span><br><span class="line">                         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                             map.put(<span class="string">"protocol"</span>, <span class="string">"dubbo"</span>);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line"> </span><br><span class="line">                     <span class="comment">// 解析地址，创建Dubbo URL数组，注意address可能包含多个注册中心ip, 【数组大小可以为一】</span></span><br><span class="line">                     List&lt;URL&gt; urls = UrlUtils.parseURLs(address, map);</span><br><span class="line"> </span><br><span class="line">                     <span class="comment">// 循环 dubbo Register url</span></span><br><span class="line">                     <span class="keyword">for</span> (URL url : urls) &#123;</span><br><span class="line">                         <span class="comment">// 设置 registry=$&#123;protocol&#125;参数,设置到注册中心的 URL的参数部分的位置上，并且是追加式的添加</span></span><br><span class="line">                         url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());</span><br><span class="line">                         <span class="comment">// 重置 URL中的 protocol属性为 'registry',即将URL的协议头设置为'registry'</span></span><br><span class="line">                         url = url.setProtocol(Constants.REGISTRY_PROTOCOL);</span><br><span class="line">                         <span class="comment">/**</span></span><br><span class="line"><span class="comment">                          * 通过判断条件，决定是否添加url到registryList中，条件如下：</span></span><br><span class="line"><span class="comment">                          * 1 如果是服务提供者,是否只订阅不注册，如果是就不添加到注册中心URL数组中</span></span><br><span class="line"><span class="comment">                          * 2 如果是服务消费者，是否是只注册不订阅，如果是就不添加到注册中心URL数组中</span></span><br><span class="line"><span class="comment">                          *</span></span><br><span class="line"><span class="comment">                          */</span></span><br><span class="line">                         <span class="keyword">if</span> ((provider &amp;&amp; url.getParameter(Constants.REGISTER_KEY, <span class="keyword">true</span>)) || (!provider &amp;&amp; url.getParameter(Constants.SUBSCRIBE_KEY, <span class="keyword">true</span>))) &#123;</span><br><span class="line">                             registryList.add(url);</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> registryList;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加载监控中心URL"><a href="#加载监控中心URL" class="headerlink" title="加载监控中心URL"></a>加载监控中心URL</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInterfaceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMethodConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载监控中心URL</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> registryURL 注册中心URL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 监控中心URL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> URL <span class="title">loadMonitor</span><span class="params">(URL registryURL)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果监控配置为空，就从属性配置中加载配置到MonitorConfig</span></span><br><span class="line">        <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取监控地址</span></span><br><span class="line">            String monitorAddress = ConfigUtils.getProperty(<span class="string">"dubbo.monitor.address"</span>);</span><br><span class="line">            <span class="comment">// 获取监控协议</span></span><br><span class="line">            String monitorProtocol = ConfigUtils.getProperty(<span class="string">"dubbo.monitor.protocol"</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 没有配置就直接返回</span></span><br><span class="line">            <span class="keyword">if</span> ((monitorAddress == <span class="keyword">null</span> || monitorAddress.length() == <span class="number">0</span>) &amp;&amp; (monitorProtocol == <span class="keyword">null</span> || monitorProtocol.length() == <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建MonitorConfig</span></span><br><span class="line">            monitor = <span class="keyword">new</span> MonitorConfig();</span><br><span class="line">            <span class="keyword">if</span> (monitorAddress != <span class="keyword">null</span> &amp;&amp; monitorAddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                monitor.setAddress(monitorAddress);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (monitorProtocol != <span class="keyword">null</span> &amp;&amp; monitorProtocol.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                monitor.setProtocol(monitorProtocol);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 为MonitorConfig加载配置【启动参数变量和properties配置到配置对象】</span></span><br><span class="line">        appendProperties(monitor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 添加 interface,dubbo,timestamp,pid 到 map 集合中</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        map.put(Constants.INTERFACE_KEY, MonitorService<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">        map.put(<span class="string">"dubbo"</span>, Version.getProtocolVersion());</span><br><span class="line">        map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">        <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//set ip</span></span><br><span class="line">        String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY);</span><br><span class="line">        <span class="keyword">if</span> (hostToRegistry == <span class="keyword">null</span> || hostToRegistry.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            hostToRegistry = NetUtils.getLocalHost();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isInvalidLocalHost(hostToRegistry)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Specified invalid registry ip from property:"</span> + Constants.DUBBO_IP_TO_REGISTRY + <span class="string">", value:"</span> + hostToRegistry);</span><br><span class="line">        &#125;</span><br><span class="line">        map.put(Constants.REGISTER_IP_KEY, hostToRegistry);</span><br><span class="line"></span><br><span class="line">        appendParameters(map, monitor);</span><br><span class="line">        appendParameters(map, application);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得监控地址</span></span><br><span class="line">        String address = monitor.getAddress();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果启动参数配置了监控中心地址，就进行覆盖，启动参数优先级最高</span></span><br><span class="line">        String sysaddress = System.getProperty(<span class="string">"dubbo.monitor.address"</span>);</span><br><span class="line">        <span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            address = sysaddress;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 直连监控中心服务器地址</span></span><br><span class="line">        <span class="keyword">if</span> (ConfigUtils.isNotEmpty(address)) &#123;</span><br><span class="line">            <span class="comment">// 若监控地址不存在 protocol 参数，默认 dubbo 添加到 map 集合中</span></span><br><span class="line">            <span class="keyword">if</span> (!map.containsKey(Constants.PROTOCOL_KEY)) &#123;</span><br><span class="line">                <span class="comment">// logstat这个拓展实现已经不存在了,可以忽略</span></span><br><span class="line">                if (ExtensionLoader.getExtensionLoader(MonitorFactory.class).hasExtension("logstat")) &#123;</span><br><span class="line">                    map.put(Constants.PROTOCOL_KEY, <span class="string">"logstat"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    map.put(Constants.PROTOCOL_KEY, <span class="string">"dubbo"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 解析地址，创建Dubbo URL 对象</span></span><br><span class="line">            <span class="keyword">return</span> UrlUtils.parseURL(address, map);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 1  当 protocol=registry时，并且注册中心URL非空时，从注册中心发现监控中心地址，以注册中心URL为基础，创建监控中心URL</span></span><br><span class="line"><span class="comment">             * 2  基于注册中心创建的监控中心URL： protocol = dubbo,parameters.protocol=registry,parameter.refer=map</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(monitor.getProtocol()) &amp;&amp; registryURL != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> registryURL.setProtocol(<span class="string">"dubbo"</span>).addParameter(Constants.PROTOCOL_KEY, <span class="string">"registry"</span>).addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="校验接口和方法列表"><a href="#校验接口和方法列表" class="headerlink" title="校验接口和方法列表"></a>校验接口和方法列表</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInterfaceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMethodConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验接口和方法：</span></span><br><span class="line"><span class="comment">     * 1 接口类必须非空并且必须是接口</span></span><br><span class="line"><span class="comment">     * 2 方法在接口中已经定义</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> methods</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkInterfaceAndMethods</span><span class="params">(Class&lt;?&gt; interfaceClass, List&lt;MethodConfig&gt; methods)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// interface cannot be null</span></span><br><span class="line">        <span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"interface not allow null!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// to verify interfaceClass is an interface</span></span><br><span class="line">        <span class="keyword">if</span> (!interfaceClass.isInterface()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The interface class "</span> + interfaceClass + <span class="string">" is not a interface!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// check if methods exist in the interface</span></span><br><span class="line">        <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (MethodConfig methodBean : methods) &#123;</span><br><span class="line">                String methodName = methodBean.getName();</span><br><span class="line">                <span class="keyword">if</span> (methodName == <span class="keyword">null</span> || methodName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:method&gt; name attribute is required! Please check: &lt;dubbo:service interface=\""</span> + interfaceClass.getName() + <span class="string">"\" ... &gt;&lt;dubbo:method name=\"\" ... /&gt;&lt;/&lt;dubbo:reference&gt;"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">boolean</span> hasMethod = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">for</span> (java.lang.reflect.Method method : interfaceClass.getMethods()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (method.getName().equals(methodName)) &#123;</span><br><span class="line">                        hasMethod = <span class="keyword">true</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!hasMethod) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The interface "</span> + interfaceClass.getName()</span><br><span class="line">                            + <span class="string">" not found method "</span> + methodName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="校验Stub和Mock相关的配置"><a href="#校验Stub和Mock相关的配置" class="headerlink" title="校验Stub和Mock相关的配置"></a>校验Stub和Mock相关的配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractInterfaceConfig</span> <span class="keyword">extends</span> <span class="title">AbstractMethodConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 校验Stub和Mock相关的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkStubAndMock</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ConfigUtils.isNotEmpty(local)) &#123;</span><br><span class="line">            Class&lt;?&gt; localClass = ConfigUtils.isDefault(local) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Local"</span>) : ReflectUtils.forName(local);</span><br><span class="line">            <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ReflectUtils.findConstructor(localClass, interfaceClass);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + localClass.getSimpleName() + <span class="string">"("</span> + interfaceClass.getName() + <span class="string">")\" in local implementation class "</span> + localClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ConfigUtils.isNotEmpty(stub)) &#123;</span><br><span class="line">            Class&lt;?&gt; localClass = ConfigUtils.isDefault(stub) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Stub"</span>) : ReflectUtils.forName(stub);</span><br><span class="line">            <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ReflectUtils.findConstructor(localClass, interfaceClass);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + localClass.getSimpleName() + <span class="string">"("</span> + interfaceClass.getName() + <span class="string">")\" in local implementation class "</span> + localClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mock 配置校验</span></span><br><span class="line">        <span class="keyword">if</span> (ConfigUtils.isNotEmpty(mock)) &#123;</span><br><span class="line">            <span class="comment">// 如果mock以 'return' 开头，则去掉该前缀</span></span><br><span class="line">            <span class="keyword">if</span> (mock.startsWith(Constants.RETURN_PREFIX)) &#123;</span><br><span class="line">                <span class="comment">// 获取return 指定的内容</span></span><br><span class="line">                String value = mock.substring(Constants.RETURN_PREFIX.length());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 解析return指定的内容，并转换成对应的返回类型</span></span><br><span class="line">                    MockInvoker.parseMockValue(value);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Illegal mock json value in &lt;dubbo:service ... mock=\""</span> + mock + <span class="string">"\" /&gt;"</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 不是以 'return' 开头</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 获得Mock类</span></span><br><span class="line">                Class&lt;?&gt; mockClass = ConfigUtils.isDefault(mock) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Mock"</span>) : ReflectUtils.forName(mock);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 校验是否实现接口</span></span><br><span class="line">                <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(mockClass)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The mock implementation class "</span> + mockClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 校验是否有默认的构造方法</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mockClass.getConstructor(<span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>]);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such empty constructor \"public "</span> + mockClass.getSimpleName() + <span class="string">"()\" in mock implementation class "</span> + mockClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ServiceConfig-配置类"><a href="#ServiceConfig-配置类" class="headerlink" title="ServiceConfig 配置类"></a>ServiceConfig 配置类</h4><p>该类是 <code>服务暴露</code> 的核心类，我们在 <a href="http://localhost:4000/posts/f0ae64a/" target="_blank" rel="noopener">Dubbo示例 - API配置</a> 中已经使用API的方式创建一个Dubbo应用，最后通过调用 <code>ServiceConfig#export()方法</code>进行服务的导出，ServiceConfig 继承关系如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AbstractConfig</span><br><span class="line"> - AbstractMethodConfig</span><br><span class="line">   - AbstractInterfaceConfig</span><br><span class="line">     - AbstractServiceConfig</span><br><span class="line">       - ServiceConfig</span><br></pre></td></tr></table></figure>
<p>AbstractServiceConfig 抽象类中也没有核心的逻辑，主要就是配置属性的设置和获取方法，因此也不再分析。</p>
<p><code>ServiceConfig#export()</code>方法主要做以下几件事：</p>
<ol>
<li>进一步初始化Dubbo的配置承载对象，因为有的配置对象我们可能并没有显示创建或配置。</li>
<li>对配置对象们进行校验是否为空，为空则新建，或者抛出异常。</li>
<li>ServiceConfig聚集了Dubbo服务的的所有配置属性，使用它的属性构建Dubbo URL对象</li>
<li>进行服务暴露</li>
</ol>
<h5 id="ServiceConfig-属性"><a href="#ServiceConfig-属性" class="headerlink" title="ServiceConfig 属性"></a>ServiceConfig 属性</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractServiceConfig</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自适应 Protocol实现对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol<span class="class">.<span class="keyword">class</span>).<span class="title">getAdaptiveExtension</span>()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自适应 ProxyFactory 实现对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory<span class="class">.<span class="keyword">class</span>).<span class="title">getAdaptiveExtension</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机端口集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; RANDOM_PORT_MAP = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 延迟暴露线程池</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledExecutorService delayExportExecutor = Executors.newSingleThreadScheduledExecutor(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"DubboServiceDelayExporter"</span>, <span class="keyword">true</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务配置暴露的Exporter 集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Exporter&lt;?&gt;&gt; exporters = <span class="keyword">new</span> ArrayList&lt;Exporter&lt;?&gt;&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务接口全路径名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String interfaceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 非配置，通过interfaceName 通过反射获得</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务接口的实现对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> T ref;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务方法配置对象集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MethodConfig&gt; methods;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务提供者默认配置的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ProviderConfig provider;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> exported;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> unexported;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 泛化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> String generic;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="进一步初始化配置承载对象"><a href="#进一步初始化配置承载对象" class="headerlink" title="进一步初始化配置承载对象"></a>进一步初始化配置承载对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractServiceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * 暴露服务入口，加jvm锁</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">export</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// 当export 或者 delay 未配置时，从ProviderConfig对象读取</span></span><br><span class="line">          <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (export == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  export = provider.getExport();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (delay == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  delay = provider.getDelay();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 不暴露服务(export = false),则不进行暴露服务逻辑</span></span><br><span class="line">          <span class="keyword">if</span> (export != <span class="keyword">null</span> &amp;&amp; !export) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 延迟暴露的话，就是使用任务线程池ScheduledExecutorService处理</span></span><br><span class="line">          <span class="keyword">if</span> (delay != <span class="keyword">null</span> &amp;&amp; delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              delayExportExecutor.schedule(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                  <span class="meta">@Override</span></span><br><span class="line">                  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                      doExport();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              doExport();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 服务暴露，jvm锁</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doExport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// 检查是否可以暴露，若可以，标记已经暴露然后执行服务暴露逻辑</span></span><br><span class="line">            <span class="keyword">if</span> (unexported) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already unexported!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 如果已经暴露了直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (exported) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 标记已经暴露过了</span></span><br><span class="line">            exported = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// 校验interfaceName 是否合法，即接口名非空</span></span><br><span class="line">            <span class="keyword">if</span> (interfaceName == <span class="keyword">null</span> || interfaceName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:service interface=\"\" /&gt; interface not allow null!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 校验provider是否为空，为空则新建一个，并拼接属性配置（环境变量 + .properties文件中的 属性）到ProviderConfig对象</span></span><br><span class="line">            checkDefault();</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 检测application，module等核心配置类对象是否为空，若为空则尝试从其他配置类对象中获取对应的实例。即： 从ProviderConfig 对象中，读取application,module,registries,monitor,protocols配置对象</span></span><br><span class="line">            <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    application = provider.getApplication();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">module</span> = provider.getModule();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    registries = provider.getRegistries();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    monitor = provider.getMonitor();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (protocols == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    protocols = provider.getProtocols();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从ModuleConfig 对象中，读取registries,monitor配置对象</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">module</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    registries = <span class="keyword">module</span>.getRegistries();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    monitor = <span class="keyword">module</span>.getMonitor();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 从ApplicationConfig 对象中，读取registries,monitor配置对象</span></span><br><span class="line">            <span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    registries = application.getRegistries();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    monitor = application.getMonitor();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 检测ref是否泛化接口的实现</span></span><br><span class="line">            <span class="keyword">if</span> (ref <span class="keyword">instanceof</span> GenericService) &#123;</span><br><span class="line">                <span class="comment">// 设置 interfaceClass 为 GenericService.class</span></span><br><span class="line">                interfaceClass = GenericService<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isEmpty(generic)) &#123;</span><br><span class="line">                    <span class="comment">// 设置 generic = "true"</span></span><br><span class="line">                    generic = Boolean.TRUE.toString();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 普通接口的实现</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 通过反射获取对应的接口的Class</span></span><br><span class="line">                    interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread()</span><br><span class="line">                            .getContextClassLoader());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 检验接口和方法 （接口非空，方法都在接口中定义）</span></span><br><span class="line">                checkInterfaceAndMethods(interfaceClass, methods);</span><br><span class="line">                <span class="comment">// 校验引用ref是否实现了当前接口</span></span><br><span class="line">                checkRef();</span><br><span class="line">                <span class="comment">// 标记为非泛化实现</span></span><br><span class="line">                generic = Boolean.FALSE.toString();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/** 处理服务接口客户端本地代理,即本地存根（local 属性 -&gt; AbstractInterfaceConfig#setLocal）。目前已经废弃，此处主要用于兼容，使用stub属性. todo 服务端没有意义 &#123;<span class="doctag">@link</span> StubProxyFactoryWrapper#getInvoker(java.lang.Object, java.lang.Class, com.alibaba.dubbo.common.URL)&#125; */</span></span><br><span class="line">            <span class="keyword">if</span> (local != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果local属性设置为ture，表示使用缺省代理类名，即：接口名 + Local 后缀</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(local)) &#123;</span><br><span class="line">                    local = interfaceName + <span class="string">"Local"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Class&lt;?&gt; localClass;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 获取本地存根类</span></span><br><span class="line">                    localClass = ClassHelper.forNameWithThreadContextClassLoader(local);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 检测本地存根类是否可赋值给接口类，若不可赋值则会抛出异常，提醒使用者本地存根类类型不合法</span></span><br><span class="line">                <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/** 处理服务接口客户端本地代理(stub 属性)相关，即本地存根。目的：想在客户端【服务消费方】执行需要的逻辑，不局限服务提供的逻辑。本地存根类编写方式是固定。todo 服务端没有意义 &#123;<span class="doctag">@link</span> StubProxyFactoryWrapper#getInvoker(java.lang.Object, java.lang.Class, com.alibaba.dubbo.common.URL)&#125;*/</span></span><br><span class="line">            <span class="keyword">if</span> (stub != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 如果stub属性设置为ture，表示使用缺省代理类名，即：接口名 + Stub 后缀</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="string">"true"</span>.equals(stub)) &#123;</span><br><span class="line">                    stub = interfaceName + <span class="string">"Stub"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                Class&lt;?&gt; stubClass;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 获取本地存根类</span></span><br><span class="line">                    stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 判断interfaceClass 是否是 stubClass 的接口，即 检测本地存根类是否可赋值给接口类，若不可赋值则会抛出异常，提醒使用者本地存根类类型不合法</span></span><br><span class="line">                <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(stubClass)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The stub implementation class "</span> + stubClass.getName() + <span class="string">" not implement interface "</span> + interfaceName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    </span><br><span class="line">            <span class="comment">/* 检测各种对象是否为空，为空则新建，或者抛出异常*/</span></span><br><span class="line">    </span><br><span class="line">            <span class="comment">// 校验ApplicationConfig配置</span></span><br><span class="line">            checkApplication();</span><br><span class="line">            <span class="comment">// 校验RegistryConfig配置</span></span><br><span class="line">            checkRegistry();</span><br><span class="line">            <span class="comment">// 校验ProtocolConfig配置数组</span></span><br><span class="line">            checkProtocol();</span><br><span class="line">            <span class="comment">// 读取环境变量和properties配置到ServiceConfig对象（自己）</span></span><br><span class="line">            appendProperties(<span class="keyword">this</span>);</span><br><span class="line">            <span class="comment">// 校验Stub和Mock相关的配置</span></span><br><span class="line">            checkStubAndMock(interfaceClass);</span><br><span class="line">            <span class="comment">// 服务路径，缺省是接口名</span></span><br><span class="line">            <span class="keyword">if</span> (path == <span class="keyword">null</span> || path.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                path = interfaceName;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 暴露服务</span></span><br><span class="line">            doExportUrls();</span><br><span class="line">          </span><br><span class="line">            ProviderModel providerModel = <span class="keyword">new</span> ProviderModel(getUniqueServiceName(), <span class="keyword">this</span>, ref);</span><br><span class="line">            ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="多协议多注册中心"><a href="#多协议多注册中心" class="headerlink" title="多协议多注册中心"></a>多协议多注册中心</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractServiceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * Dubbo 允许我们使用不同的协议导出服务，也允许我们向多个注册中心注册服务。Dubbo 在 doExportUrls 方法中对多协议，多注册中心进行了支持</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>&#125;)</span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrls</span><span class="params">()</span> </span>&#123;</span><br><span class="line">           <span class="comment">// 加载注册中心URL 数组 【协议已经处理过，不再是配置的注册中心协议 如：zookeeper ,而是统一替换成了registry】</span></span><br><span class="line">           List&lt;URL&gt; registryURLs = loadRegistries(<span class="keyword">true</span>);</span><br><span class="line">           <span class="comment">// 遍历协议集合，支持多协议暴露。</span></span><br><span class="line">           <span class="keyword">for</span> (ProtocolConfig protocolConfig : protocols) &#123;</span><br><span class="line">               doExportUrlsFor1Protocol(protocolConfig, registryURLs);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * 使用不同的协议，逐个向注册中心分组暴露服务。该方法中包含了本地和远程两种暴露方式</span></span><br><span class="line"><span class="comment">        *</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> protocolConfig 协议配置对象</span></span><br><span class="line"><span class="comment">        * <span class="doctag">@param</span> registryURLs   处理过的注册中心分组集合【已经添加了ApplicationConfig和RegistryConfig的参数】</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doExportUrlsFor1Protocol</span><span class="params">(ProtocolConfig protocolConfig, List&lt;URL&gt; registryURLs)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 协议名</span></span><br><span class="line">           String name = protocolConfig.getName();</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 协议名为空时，缺省设置为 dubbo</span></span><br><span class="line">           <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) &#123;</span><br><span class="line">               name = <span class="string">"dubbo"</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 创建参数集合map，用于Dubbo URL 的构建（服务提供者URL）</span></span><br><span class="line">           Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">   </span><br><span class="line">           <span class="comment">// 将side,dubbo,timestamp,pid参数，添加到map集合中</span></span><br><span class="line">           map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);</span><br><span class="line">           map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());</span><br><span class="line">           map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">           <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 通过反射将各种配置对象中的属性添加到map集合中，map用于URL的构建【注意属性覆盖问题】</span></span><br><span class="line">           appendParameters(map, application);</span><br><span class="line">           appendParameters(map, <span class="keyword">module</span>);</span><br><span class="line">           appendParameters(map, provider, Constants.DEFAULT_KEY);</span><br><span class="line">           appendParameters(map, protocolConfig);</span><br><span class="line">           appendParameters(map, <span class="keyword">this</span>);</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">           <span class="comment">// 将MethodConfig 对象数组添加到 map 集合中。就是将每个MethodConfig和其对应的ArgumentConfig对象数组添加到map中【处理方法相关的属性到map】</span></span><br><span class="line">           <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">               <span class="comment">// methods 为 MethodConfig 集合，MethodConfig 中存储了 &lt;dubbo:method&gt; 标签的配置信息</span></span><br><span class="line">               <span class="keyword">for</span> (MethodConfig method : methods) &#123;</span><br><span class="line">                   <span class="comment">/**</span></span><br><span class="line"><span class="comment">                    * 将MethodConfig对象的属性添加到map集合中，其中属性键 = 方法名.属性名。如：</span></span><br><span class="line"><span class="comment">                    * &lt;dubbo:method name="sleep" retries="2"&gt;&lt;/dubbo:method&gt;对应的MethodConfig，属性到map的格式 map=&#123;"sleep.retries":2,...&#125;</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                   appendParameters(map, method, method.getName());</span><br><span class="line">   </span><br><span class="line">                   <span class="comment">// 当配置了 MehodConfig.retry = false 时，强制禁用重试</span></span><br><span class="line">                   String retryKey = method.getName() + <span class="string">".retry"</span>;</span><br><span class="line">                   <span class="keyword">if</span> (map.containsKey(retryKey)) &#123;</span><br><span class="line">                       String retryValue = map.remove(retryKey);</span><br><span class="line">                       <span class="comment">// 检测 MethodConfig retry 是否为 false，若是，则设置重试次数为0</span></span><br><span class="line">                       <span class="keyword">if</span> (<span class="string">"false"</span>.equals(retryValue)) &#123;</span><br><span class="line">                           map.put(method.getName() + <span class="string">".retries"</span>, <span class="string">"0"</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="comment">// 将MethodConfig下的ArgumentConfig 对象数组，添加到 map 集合中</span></span><br><span class="line">                   List&lt;ArgumentConfig&gt; arguments = method.getArguments();</span><br><span class="line">                   <span class="keyword">if</span> (arguments != <span class="keyword">null</span> &amp;&amp; !arguments.isEmpty()) &#123;</span><br><span class="line">                       <span class="keyword">for</span> (ArgumentConfig argument : arguments) &#123;</span><br><span class="line">                           <span class="comment">// 检测type 属性是否为空，</span></span><br><span class="line">                           <span class="keyword">if</span> (argument.getType() != <span class="keyword">null</span> &amp;&amp; argument.getType().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                               <span class="comment">// 通过反射取出接口的方法列表</span></span><br><span class="line">                               Method[] methods = interfaceClass.getMethods();</span><br><span class="line">                               <span class="comment">// 遍历接口中的方法列表</span></span><br><span class="line">                               <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methods.length; i++) &#123;</span><br><span class="line">                                       String methodName = methods[i].getName();</span><br><span class="line">                                       <span class="comment">// 比对方法名，查找目标方法</span></span><br><span class="line">                                       <span class="keyword">if</span> (methodName.equals(method.getName())) &#123;</span><br><span class="line">                                           <span class="comment">// 通过反射取出目标方法的参数类型列表</span></span><br><span class="line">                                           Class&lt;?&gt;[] argtypes = methods[i].getParameterTypes();</span><br><span class="line">                                           <span class="comment">// 若果配置index配置项，且值不为-1</span></span><br><span class="line">                                           <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) &#123;</span><br><span class="line">                                               <span class="comment">// 从argtypes数组中获取下标index处的元素argType，并检测ArgumentConfig中的type属性与argType名称是否一致，不一致则抛出异常</span></span><br><span class="line">                                               <span class="keyword">if</span> (argtypes[argument.getIndex()].getName().equals(argument.getType())) &#123;</span><br><span class="line">                                                   <span class="comment">// 将ArgumentConfig对象的属性添加到map集合中，键前缀=方法名.index，如：map = &#123;"sleep.2":true&#125;</span></span><br><span class="line">                                                   appendParameters(map, argument, method.getName() + <span class="string">"."</span> + argument.getIndex());</span><br><span class="line">                                               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                                   <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config error : the index attribute and type attribute not match :index :"</span> + argument.getIndex() + <span class="string">", type:"</span> + argument.getType());</span><br><span class="line">                                               &#125;</span><br><span class="line">                                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                               <span class="comment">// 遍历参数类型数组argtypes，查找argument.type类型的参数</span></span><br><span class="line">                                               <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; argtypes.length; j++) &#123;</span><br><span class="line">                                                   Class&lt;?&gt; argclazz = argtypes[j];</span><br><span class="line">                                                   <span class="comment">// 从参数类型列表中查找类型名称为argument.type的参数</span></span><br><span class="line">                                                   <span class="keyword">if</span> (argclazz.getName().equals(argument.getType())) &#123;</span><br><span class="line">                                                       <span class="comment">// 将ArgumentConfig对象的属性添加到map集合中</span></span><br><span class="line">                                                       appendParameters(map, argument, method.getName() + <span class="string">"."</span> + j);</span><br><span class="line">                                                       <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span> &amp;&amp; argument.getIndex() != j) &#123;</span><br><span class="line">                                                           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config error : the index attribute and type attribute not match :index :"</span> + argument.getIndex() + <span class="string">", type:"</span> + argument.getType());</span><br><span class="line">                                                       &#125;</span><br><span class="line">                                                   &#125;</span><br><span class="line">                                               &#125;</span><br><span class="line">                                           &#125;</span><br><span class="line">                                       &#125;</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125;</span><br><span class="line">                               <span class="comment">// 用户未配置 type 属性，但配置了index属性，且index != -1</span></span><br><span class="line">                           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (argument.getIndex() != -<span class="number">1</span>) &#123; <span class="comment">// 指定单个参数的位置</span></span><br><span class="line">                               <span class="comment">// 将ArgumentConfig对象的属性添加到map集合中</span></span><br><span class="line">                               appendParameters(map, argument, method.getName() + <span class="string">"."</span> + argument.getIndex());</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"argument config must set index or type attribute.eg: &lt;dubbo:argument index='0' .../&gt; or &lt;dubbo:argument type=xxx .../&gt;"</span>);</span><br><span class="line">                           &#125;</span><br><span class="line">   </span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="comment">// end of methods for</span></span><br><span class="line">           &#125;</span><br><span class="line">   </span><br><span class="line">           <span class="comment">//------------------- 检测 generic 是否 为 true ,并根据检测结果向map中添加不同的信息 ---/</span></span><br><span class="line">           <span class="comment">// 将 generic,methods,revision 加入到数组</span></span><br><span class="line">           <span class="keyword">if</span> (ProtocolUtils.isGeneric(generic)) &#123;</span><br><span class="line">               map.put(Constants.GENERIC_KEY, generic);</span><br><span class="line">               map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 先从MAINFEST.MF 中获取版本号，若获取不到，再从jar包命名中可能带的版本号作为结果，如 2.6.5.RELEASE。若都不存在，返回默认版本号【源码运行可能会没有】</span></span><br><span class="line">               String revision = Version.getVersion(interfaceClass, version);</span><br><span class="line">               <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   map.put(<span class="string">"revision"</span>, revision); <span class="comment">// 修订号</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="comment">// 为接口生成包裹类 Wrapper，Wrapper 中包含了接口的详细信息，比如接口方法名数组，字段信息等【Dubbo 自定义功能类】</span></span><br><span class="line">               String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();</span><br><span class="line">   </span><br><span class="line">               <span class="comment">// 添加方法名到 map 中，如果包含多个方法名，则用逗号隔开，比如：method=a,b</span></span><br><span class="line">               <span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">                   logger.warn(<span class="string">"NO method found in service interface "</span> + interfaceClass.getName());</span><br><span class="line">                   <span class="comment">// 没有方法名就添加 method=*</span></span><br><span class="line">                   map.put(Constants.METHODS_KEY, Constants.ANY_VALUE);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="comment">// 将逗号作为分隔符连接方法名，并将连接后的字符串放入 map 中</span></span><br><span class="line">                   map.put(Constants.METHODS_KEY, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), <span class="string">","</span>));</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">   </span><br><span class="line">           <span class="comment">// token 【使暴露出去的服务更安全，使用token做安全校验】</span></span><br><span class="line">           <span class="keyword">if</span> (!ConfigUtils.isEmpty(token)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (ConfigUtils.isDefault(token)) &#123;</span><br><span class="line">                   map.put(Constants.TOKEN_KEY, UUID.randomUUID().toString());</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   map.put(Constants.TOKEN_KEY, token);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 协议为injvm时，不注册，不通知</span></span><br><span class="line">           <span class="keyword">if</span> (Constants.LOCAL_PROTOCOL.equals(protocolConfig.getName())) &#123;</span><br><span class="line">               protocolConfig.setRegister(<span class="keyword">false</span>);</span><br><span class="line">               map.put(<span class="string">"notify"</span>, <span class="string">"false"</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 获得基础路径</span></span><br><span class="line">           String contextPath = protocolConfig.getContextpath();</span><br><span class="line">           <span class="keyword">if</span> ((contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span>) &amp;&amp; provider != <span class="keyword">null</span>) &#123;</span><br><span class="line">               contextPath = provider.getContextpath();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// --------------------------- 主机绑定----------------------------/</span></span><br><span class="line">           <span class="comment">// 获得注册到注册中心的服务提供者host，并为map设置bind.ip , anyhost 两个key</span></span><br><span class="line">           String host = <span class="keyword">this</span>.findConfigedHosts(protocolConfig, registryURLs, map);</span><br><span class="line">           <span class="comment">// 获取端口，并为map设置bing.port key</span></span><br><span class="line">           Integer port = <span class="keyword">this</span>.findConfigedPorts(protocolConfig, name, map);</span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * 创建Dubbo URL对象 【注意这里的 path 的值】</span></span><br><span class="line"><span class="comment">            * 1 name: 协议名</span></span><br><span class="line"><span class="comment">            * 2 host: 主机名</span></span><br><span class="line"><span class="comment">            * 3 port: 端口</span></span><br><span class="line"><span class="comment">            * 4 path: 【基础路径】/path</span></span><br><span class="line"><span class="comment">            * 5 parameters: 属性集合map</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           URL url = <span class="keyword">new</span> URL(name, host, port, (contextPath == <span class="keyword">null</span> || contextPath.length() == <span class="number">0</span> ? <span class="string">""</span> : contextPath + <span class="string">"/"</span>) + path, map);</span><br><span class="line">   </span><br><span class="line">           <span class="comment">// 省略服务暴露代码</span></span><br><span class="line">         </span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ReferenceConfig-配置类"><a href="#ReferenceConfig-配置类" class="headerlink" title="ReferenceConfig 配置类"></a>ReferenceConfig 配置类</h4><p>该类是 <code>服务引用</code> 的核心类，我们在 <a href="http://localhost:4000/posts/f0ae64a/" target="_blank" rel="noopener">Dubbo示例 - API配置</a> 中已经使用API的方式创建一个Dubbo应用，最后通过调用 <code>ReferenceConfig#get()方法</code>引用服务，ReferenceConfig 继承关系如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AbstractConfig</span><br><span class="line"> - AbstractMethodConfig</span><br><span class="line">   - AbstractInterfaceConfig</span><br><span class="line">     - AbstractReferenceConfig</span><br><span class="line">       - ReferenceConfig</span><br></pre></td></tr></table></figure>
<p>AbstractReferenceConfig 抽象类中也没有核心的逻辑，主要就是配置属性的设置和获取方法，因此也不再分析。</p>
<p><code>ReferenceConfig#get()</code>方法主要做以下几件事：</p>
<ol>
<li>进一步初始化Dubbo的配置承载对象，因为有的配置对象我们可能并没有显示创建或配置。</li>
<li>对配置对象们进行校验是否为空，为空则新建，或者抛出异常。</li>
<li>ReferenceConfig聚集了Dubbo服务消费者的的所有配置属性，使用它的属性构建Dubbo URL对象</li>
<li>进行服务引用</li>
</ol>
<h5 id="ReferenceConfig-属性"><a href="#ReferenceConfig-属性" class="headerlink" title="ReferenceConfig 属性"></a>ReferenceConfig 属性</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractReferenceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自适应 Protocol 拓展实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Protocol refprotocol = ExtensionLoader.getExtensionLoader(Protocol<span class="class">.<span class="keyword">class</span>).<span class="title">getAdaptiveExtension</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自适应 Cluster 拓展实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cluster cluster = ExtensionLoader.getExtensionLoader(Cluster<span class="class">.<span class="keyword">class</span>).<span class="title">getAdaptiveExtension</span>()</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自适应 ProxyFactory 拓展实现</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory<span class="class">.<span class="keyword">class</span>).<span class="title">getAdaptiveExtension</span>()</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务引用URL数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务接口名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String interfaceName;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; interfaceClass;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接类型</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String client;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 直连服务提供者地址</span></span><br><span class="line"><span class="comment">     * 1 可以是注册中心，也可以是服务提供者</span></span><br><span class="line"><span class="comment">     * 2 可以配置多个，使用 ";" 分割</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法配置对象集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;MethodConfig&gt; methods;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消费者默认配置的配置对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ConsumerConfig consumer;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 协议</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String protocol;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务接口代理对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> T ref;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoker</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Invoker&lt;?&gt; invoker;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> destroyed;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="进一步初始化配置承载对象-1"><a href="#进一步初始化配置承载对象-1" class="headerlink" title="进一步初始化配置承载对象"></a>进一步初始化配置承载对象</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceConfig</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractReferenceConfig</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// 已销毁，不可获得</span></span><br><span class="line">          <span class="keyword">if</span> (destroyed) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Already destroyed!"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 若未初始化，调用init()方法进行初始化</span></span><br><span class="line">          <span class="keyword">if</span> (ref == <span class="keyword">null</span>) &#123;</span><br><span class="line">              init();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 返回引用服务</span></span><br><span class="line">          <span class="keyword">return</span> ref;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// 已经初始化过，直接返回</span></span><br><span class="line">          <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          initialized = <span class="keyword">true</span>;</span><br><span class="line">          <span class="comment">// 校验接口名非空</span></span><br><span class="line">          <span class="keyword">if</span> (interfaceName == <span class="keyword">null</span> || interfaceName.length() == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"&lt;dubbo:reference interface=\"\" /&gt; interface not allow null!"</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 拼接属性配置（环境变量 + .properties 中的属性）到 ConsumerConfig对象</span></span><br><span class="line">          checkDefault();</span><br><span class="line">          <span class="comment">// 拼接属性配置（环境变量 + .properties 中的属性）到ReferenceConfig（自己）</span></span><br><span class="line">          appendProperties(<span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 若未设置 generic 属性，就使用ConsumerConfig的generic属性</span></span><br><span class="line">          <span class="keyword">if</span> (getGeneric() == <span class="keyword">null</span> &amp;&amp; getConsumer() != <span class="keyword">null</span>) &#123;</span><br><span class="line">              setGeneric(getConsumer().getGeneric());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 是否是泛化接口的实现，如果是泛化接口实现的话，就直接设置当前接口为 GenericService.class</span></span><br><span class="line">          <span class="keyword">if</span> (ProtocolUtils.isGeneric(getGeneric())) &#123;</span><br><span class="line">              interfaceClass = GenericService<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">  </span><br><span class="line">              <span class="comment">// 普通接口的实现</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">try</span> &#123;</span><br><span class="line">                  <span class="comment">// 根据接口名，获得对应的接口类</span></span><br><span class="line">                  interfaceClass = Class.forName(interfaceName, <span class="keyword">true</span>, Thread.currentThread().getContextClassLoader());</span><br><span class="line">              &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br><span class="line">              &#125;</span><br><span class="line">  </span><br><span class="line">              <span class="comment">// 校验接口和方法</span></span><br><span class="line">              checkInterfaceAndMethods(interfaceClass, methods);</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 直连提供者，第一优先级，通过 -D 参数（系统变量）指定 ，例如 java -Dcom.alibaba.xxx.XxxService=dubbo://localhost:20890</span></span><br><span class="line">          String resolve = System.getProperty(interfaceName);</span><br><span class="line">          String resolveFile = <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 直连提供者第二优先级，通过文件映射，例如 com.alibaba.xxx.XxxService=dubbo://localhost:20890</span></span><br><span class="line">          <span class="keyword">if</span> (resolve == <span class="keyword">null</span> || resolve.length() == <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="comment">// 从系统属性中获取解析文件路径</span></span><br><span class="line">              resolveFile = System.getProperty(<span class="string">"dubbo.resolve.file"</span>);</span><br><span class="line">              <span class="keyword">if</span> (resolveFile == <span class="keyword">null</span> || resolveFile.length() == <span class="number">0</span>) &#123;</span><br><span class="line">                  <span class="comment">// 默认先加载 $&#123;user.home&#125;/dubbo-resolve.properties 文件，无需配置，自动加载</span></span><br><span class="line">                  File userResolveFile = <span class="keyword">new</span> File(<span class="keyword">new</span> File(System.getProperty(<span class="string">"user.home"</span>)), <span class="string">"dubbo-resolve.properties"</span>);</span><br><span class="line">                  <span class="keyword">if</span> (userResolveFile.exists()) &#123;</span><br><span class="line">                      <span class="comment">// 获取文件绝对路径</span></span><br><span class="line">                      resolveFile = userResolveFile.getAbsolutePath();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// 存在resolveFile,则进行文件读取加载</span></span><br><span class="line">              <span class="keyword">if</span> (resolveFile != <span class="keyword">null</span> &amp;&amp; resolveFile.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                  Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">                  FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      fis = <span class="keyword">new</span> FileInputStream(<span class="keyword">new</span> File(resolveFile));</span><br><span class="line">                      <span class="comment">// 从文件中加载配置</span></span><br><span class="line">                      properties.load(fis);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unload "</span> + resolveFile + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br><span class="line">                  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                      <span class="keyword">try</span> &#123;</span><br><span class="line">                          <span class="keyword">if</span> (<span class="keyword">null</span> != fis) &#123;</span><br><span class="line">                              fis.close();</span><br><span class="line">                          &#125;</span><br><span class="line">                      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                          logger.warn(e.getMessage(), e);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">// 根据服务全路径名获取对应的 直连提供者的url</span></span><br><span class="line">                  resolve = properties.getProperty(interfaceName);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 设置直连提供者的 url</span></span><br><span class="line">          <span class="keyword">if</span> (resolve != <span class="keyword">null</span> &amp;&amp; resolve.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              url = resolve;</span><br><span class="line">              <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (resolveFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                      logger.warn(<span class="string">"Using default dubbo resolve file "</span> + resolveFile + <span class="string">" replace "</span> + interfaceName + <span class="string">""</span> + resolve + <span class="string">" to p2p invoke remote service."</span>);</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      logger.warn(<span class="string">"Using -D"</span> + interfaceName + <span class="string">"="</span> + resolve + <span class="string">" to p2p invoke remote service."</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 不通过系统属性指定，就使用配置的直连（在配置的前提下），如：&lt;dubbo:reference id="xxxService" interface="com.alibaba.xxx.XxxService" url="dubbo://localhost:20890" /&gt;</span></span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 尝试从ConsumerConfig 对象中，读取 application,module,registries,monitor 配置对象</span></span><br><span class="line">          <span class="keyword">if</span> (consumer != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (application == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  application = consumer.getApplication();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">module</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">module</span> = consumer.getModule();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  registries = consumer.getRegistries();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  monitor = consumer.getMonitor();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 从ModuleConfig 对象中，读取registries,monitor配置对象</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">module</span> != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  registries = <span class="keyword">module</span>.getRegistries();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  monitor = <span class="keyword">module</span>.getMonitor();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// 从ApplicationConfig对象中，读取registries,monitor配置对象</span></span><br><span class="line">          <span class="keyword">if</span> (application != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (registries == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  registries = application.getRegistries();</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  monitor = application.getMonitor();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 校验ApplicationConfig配置</span></span><br><span class="line">          checkApplication();</span><br><span class="line">          <span class="comment">// 校验 Stub和 Mock 相关的配置</span></span><br><span class="line">          checkStubAndMock(interfaceClass);</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 创建参数集合map，用于下面创建Dubbo URL</span></span><br><span class="line">          Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">          <span class="comment">// 符合条件的方法对象的属性，主要用来Dubbo事件通知</span></span><br><span class="line">          Map&lt;Object, Object&gt; attributes = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 将 side，dubbo,timestamp,pid参数，添加到map集合中</span></span><br><span class="line">          map.put(Constants.SIDE_KEY, Constants.CONSUMER_SIDE);</span><br><span class="line">          map.put(Constants.DUBBO_VERSION_KEY, Version.getProtocolVersion());</span><br><span class="line">          map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br><span class="line">          <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 非泛化服务，设置revision,methods,interface加入到map集合中</span></span><br><span class="line">          <span class="keyword">if</span> (!isGeneric()) &#123;</span><br><span class="line">              String revision = Version.getVersion(interfaceClass, version);</span><br><span class="line">              <span class="keyword">if</span> (revision != <span class="keyword">null</span> &amp;&amp; revision.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                  map.put(<span class="string">"revision"</span>, revision);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="comment">// 获取接口方法列表，并添加到map中</span></span><br><span class="line">              String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames();</span><br><span class="line">              <span class="keyword">if</span> (methods.length == <span class="number">0</span>) &#123;</span><br><span class="line">                  logger.warn(<span class="string">"NO method found in service interface "</span> + interfaceClass.getName());</span><br><span class="line">                  map.put(<span class="string">"methods"</span>, Constants.ANY_VALUE);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  map.put(<span class="string">"methods"</span>, StringUtils.join(<span class="keyword">new</span> HashSet&lt;String&gt;(Arrays.asList(methods)), <span class="string">","</span>));</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          map.put(Constants.INTERFACE_KEY, interfaceName);</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 将各种配置对象中的属性，添加到 map 集合中</span></span><br><span class="line">          appendParameters(map, application);</span><br><span class="line">          appendParameters(map, <span class="keyword">module</span>);</span><br><span class="line">          appendParameters(map, consumer, Constants.DEFAULT_KEY);</span><br><span class="line">          appendParameters(map, <span class="keyword">this</span>);</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 获得服务键，作为前缀 格式：group/interface:version</span></span><br><span class="line">          String prefix = StringUtils.getServiceKey(map);</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 将MethodConfig 对象数组中每个MethodConfig中的属性添加到map中</span></span><br><span class="line">          <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; !methods.isEmpty()) &#123;</span><br><span class="line">              <span class="comment">// 遍历 MethodConfig 列表</span></span><br><span class="line">              <span class="keyword">for</span> (MethodConfig method : methods) &#123;</span><br><span class="line">                  appendParameters(map, method, method.getName());</span><br><span class="line">                  <span class="comment">// 当配置了 MethodConfig.retry=false 时，强制禁用重试</span></span><br><span class="line">                  String retryKey = method.getName() + <span class="string">".retry"</span>;</span><br><span class="line">                  <span class="keyword">if</span> (map.containsKey(retryKey)) &#123;</span><br><span class="line">                      String retryValue = map.remove(retryKey);</span><br><span class="line">                      <span class="keyword">if</span> (<span class="string">"false"</span>.equals(retryValue)) &#123;</span><br><span class="line">                          <span class="comment">// 添加重试次数配置 methodName.retries</span></span><br><span class="line">                          map.put(method.getName() + <span class="string">".retries"</span>, <span class="string">"0"</span>);</span><br><span class="line">                      &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="comment">// 将带有@Parameter(attribute=true)配置对象的属性，添加到参数集合中</span></span><br><span class="line">                  appendAttributes(attributes, method, prefix + <span class="string">"."</span> + method.getName());</span><br><span class="line">                  <span class="comment">// 检查属性集合中的事件通知方法是否正确，若正确，进行转换</span></span><br><span class="line">                  checkAndConvertImplicitConfig(method, map, attributes);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 以系统环境变量（DUBBO_IP_TO_REGISTRY）的值作为服务消费者ip地址,没有设置再取主机地址</span></span><br><span class="line">          String hostToRegistry = ConfigUtils.getSystemProperty(Constants.DUBBO_IP_TO_REGISTRY);</span><br><span class="line">          <span class="keyword">if</span> (hostToRegistry == <span class="keyword">null</span> || hostToRegistry.length() == <span class="number">0</span>) &#123;</span><br><span class="line">              hostToRegistry = NetUtils.getLocalHost();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isInvalidLocalHost(hostToRegistry)) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Specified invalid registry ip from property:"</span> + Constants.DUBBO_IP_TO_REGISTRY + <span class="string">", value:"</span> + hostToRegistry);</span><br><span class="line">          &#125;</span><br><span class="line">          map.put(Constants.REGISTER_IP_KEY, hostToRegistry);</span><br><span class="line">  </span><br><span class="line">          <span class="comment">// 把attributes集合添加到StaticContext进行缓存，为了以后的事件通知</span></span><br><span class="line">          StaticContext.getSystemContext().putAll(attributes);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">         <span class="comment">// 省略服务引用代码</span></span><br><span class="line"> </span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">// 省略其它代码 $&#123;&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其它配置类"><a href="#其它配置类" class="headerlink" title="其它配置类"></a>其它配置类</h4><p>前面只是针对Dubbo的核心配置类进行了分析，还很多其它的配置类并没有分析到(ServiceBean和ReferenceBean属于整合Spring的配置类，我们在XML配置中分析)，不过没有分析到的配置类中几乎都没有复杂的逻辑，大多是封装了配置属性的设置和获取操作。每个配置类中封装的配置属性都有所不同，那些抽象的配置类封装的都是可供不同子类复用的属性和方法，每个配置类可以设置那些属性我们可以参考<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html" target="_blank" rel="noopener">官方文档</a>，需要说明的是，官网给出的是XML配置形式，不过按照对应的规则转换就可以相通了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>Dubbo的配置相对比较枯燥，刚开始看的时候可能有点蒙圈，笔者也是硬着头皮看了好久，看完后也不是很理解，但是把整个流程看完后再回来看体会就更深了。XML配置和注解配置也是基于API配置和属性配置的，区别是XML配置和注解配置要解决和Spring融合问题，我们在接下来的文章中再详细分析。嘿咻，整篇文章都在贴代码！</p>

      
    </div>
    <div class="article-footer">
      <blockquote class="mt-2x">
  <ul class="post-copyright list-unstyled">
    
    <li class="post-copyright-link hidden-xs">
      <strong>本文链接：</strong>
      <a href="https://gentryhuang.com/posts/1d3295e6/" title="Dubbo源码分析 - API和属性配置" target="_blank" rel="external">https://gentryhuang.com/posts/1d3295e6/</a>
    </li>
    
    <li class="post-copyright-license">
      <strong>版权声明： </strong> 本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！
    </li>
  </ul>
</blockquote>



<div class="panel panel-default panel-badger">
  <div class="panel-body">
    <figure class="media">
      <div class="media-left">
        <a href="https://gentryhuang.com" target="_blank" class="img-burn thumb-sm visible-lg">
          <img src="/images/avatar.jpeg" class="img-rounded w-full" alt="">
        </a>
      </div>
      <div class="media-body">
        <h2 id="name" style="margin: -2px 0 5px 0">
        <a href="https://gentryhuang.com" target="_blank">
           <span class="text-dark">gentryhuang</span>
           <small class="ml-1x">xw</small>
        </a>
      </h2>
        <div>万丈高楼平地起</div>
      </div>
    </figure>
  </div>
</div>


    </div>
  </article>
  
    

  
</div>

  <nav class="bar bar-footer clearfix" data-stick-bottom>
  <div class="bar-inner">
  
  <ul class="pager pull-left">
    
    <li class="prev">
      <a href="/posts/a8d76a91/" title="Dubbo源码分析 - XML配置"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a>
    </li>
    
    
    <li class="next">
      <a href="/posts/68ac5094/" title="Dubbo源码分析 - 动态编译"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a>
    </li>
    
    
    <li class="toggle-toc">
      <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button">
        <span>[&nbsp;</span><span>文章目录</span>
        <i class="text-collapsed icon icon-anchor"></i>
        <i class="text-in icon icon-close"></i>
        <span>]</span>
      </a>
    </li>
    
  </ul>
  
  
  
  <div class="bar-right">
    
  </div>
  </div>
</nav>
  


</main>

  
<script type="text/javascript">
    var sc_project=12352980; 
    var sc_invisible=0; 
    var sc_security="3d83ff9f"; 
    var scJsHost = "https://";
    document.write("<sc"+"ript type='text/javascript' src='" +
    scJsHost+
    "statcounter.com/counter/counter.js'></"+"script>");
</script>

<footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
	
	
    <ul class="social-links">
    	
        <li><a href="https://github.com/gentryhuang" target="_blank" title="Github" data-toggle=tooltip data-placement=top><i class="icon icon-github"></i></a></li>
        
        <li><a href="/atom.xml" target="_blank" title="Rss" data-toggle=tooltip data-placement=top><i class="icon icon-rss"></i></a></li>
        
    </ul>

    <div class="copyright">
    	
        &copy; 2019 - 2021 gentryhuang
        
       
        <!-- 统计代码 -->
        <div class="publishby">
            <div class="statcounter">
                <a title="Web Analytics" href="http://statcounter.com/p12352980/summary/?guest=1" target="_blank">
                    <img class="statcounter" src="https://c.statcounter.com/12352980/0/3d83ff9f/0/" alt="Web Analytics">
               </a>
        </div>
    </div>
    </div>
</footer>
  <script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
<script>
window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>

<script src="/js/plugin.min.js"></script>


<script src="/js/application.js"></script>


    <script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>

<script src="/js/insight.js"></script>






   





  <script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.3.5/dist/jquery.fancybox.min.js"></script>
  <script>
  //利用 FancyBox 实现点击图片放大
  $(document).ready(function() {
    $('article img').not('[hidden]').not('.panel-body img').each(function() {
      var $image = $(this);
      var imageCaption = $image.attr('alt');
      var $imageWrapLink = $image.parent('a');
      if ($imageWrapLink.length < 1) {
        var src = this.getAttribute('src');
        var idx = src.lastIndexOf('?');
        if (idx != -1) {
          src = src.substring(0, idx);
        }
        $imageWrapLink = $image.wrap('<a href="' + src + '"></a>').parent('a');
      }
      $imageWrapLink.attr('data-fancybox', 'images');
      if (imageCaption) {
        $imageWrapLink.attr('data-caption', imageCaption);
      }
    });
    $().fancybox({
      selector: '[data-fancybox="images"]',
      hash: false,
      loop: false,
    });
  });
  </script>





</body>
</html>